var cc_modular=function(Kt){"use strict";function ye(e){return(ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function s(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}function S(e){return(S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function T(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?d(e):t}function o(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}function _(e,t,i){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=o(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function a(e,t,i,n){return(a="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,a=o(e,t);if(a){if((r=Object.getOwnPropertyDescriptor(a,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else s(n,t,i);return!0})(e,t,i,n)}function b(e,t,i,n,r){if(!a(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function E(e){return function(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function v(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function c(i,n,e,t,r){var a={};return Object.keys(t).forEach(function(e){a[e]=t[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=e.slice().reverse().reduce(function(e,t){return t(i,n,e)||e},a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(i,n,a),a=null),a}var r="undefined"==typeof window?global:window,e=r.cc=r.cc||{};function t(e,t){void 0===r[e]&&(r[e]=t)}e.internal=e.internal||{},t("CC_BUILD",!1),r.CC_BUILD=!0,r.CC_TEST=!1,r.CC_EDITOR=!1,r.CC_PREVIEW=!1,r.CC_DEV=!1,r.CC_DEBUG=!1,r.CC_JSB=!1,r.CC_WECHATGAME_SUB=!1,r.CC_WECHATGAME=!1,r.CC_QQPLAY=!1,r.CC_RUNTIME=!1,r.CC_SUPPORT_JIT=!0,r.CC_PHYSICS_BUILT_IN=!1,r.CC_PHYSICS_CANNON=!0,r.CC_PHYSICS_AMMO=!1;r.CocosEngine=e.ENGINE_VERSION="2.0.0 alpha";var u=null,h=console.log,f=console.log,m=console.log,g=console.log;function x(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return cc.js.formatStr.apply(null,[e].concat(i))}function A(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return h.apply(void 0,[e].concat(i))}function C(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return f.apply(void 0,[e].concat(i))}function w(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return m.apply(void 0,[e].concat(i))}function R(e,t){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return g.apply(void 0,[e,t].concat(n))}function k(e){if(h=f=m=g=function(){},e!==D.NONE){if(e>D.ERROR){var a=function(e){if(cc.game.canvas){if(!u){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",cc.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(u=document.createElement("textarea")).setAttribute("rows","20"),u.setAttribute("cols","30"),u.setAttribute("disabled","true");var n=u.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(u),cc.game.canvas.parentNode.appendChild(t)}u.value=u.value+e+"\r\n",u.scrollTop=u.scrollHeight}};m=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("ERROR :  "+x.apply(void 0,[e].concat(i)))},g=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];a("ASSERT: "+x.apply(void 0,[t].concat(n)))}},e!==D.ERROR_FOR_WEB_PAGE&&(f=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a("WARN :  "+x.apply(void 0,[e].concat(i)))}),e===D.INFO_FOR_WEB_PAGE&&(h=function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];a(x.apply(void 0,[e].concat(i)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),m=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},g=function(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=x.apply(void 0,[t].concat(n));throw new Error(a)}});e!==D.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===D.INFO&&(h=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function O(e){var t=e.stack;w(t||e)}function F(a){return function(e){for(var t="".concat(a," ").concat(e,", please go to ").concat("https://github.com/cocos-creator/engine/blob/master/EngineErrorMap.md","#").concat(e," to see details."),i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return 0===n.length?t:t+" Arguments: "+n.join(", ")}}var L=F("Log");function B(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];A(L.apply(void 0,[e].concat(i)))}var M=F("Warning");function I(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];C(M.apply(void 0,[e].concat(i)))}var P=F("Error");function j(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];w(P.apply(void 0,[e].concat(i)))}var D,N,z=F("Assert");function U(e,t){if(!e){for(var i=arguments.length,n=new Array(2<i?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];R(!1,z.apply(void 0,[t].concat(n)))}}function G(e,t){return P(e,t)}function V(e){cc.profiler&&(e?cc.profiler.showStats():cc.profiler.hideStats(),cc.game.config.showFPS=!!e)}(N=D||(D={}))[N.NONE=0]="NONE",N[N.INFO=1]="INFO",N[N.WARN=2]="WARN",N[N.ERROR=3]="ERROR",N[N.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",N[N.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",N[N.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE";var H=Object.freeze({log:A,warn:C,error:w,assert:R,_resetDebugSetting:k,_throw:O,logID:B,warnID:I,errorID:j,assertID:U,get DebugMode(){return D},getError:G,isDisplayStats:function(){return!!cc.profiler&&cc.profiler.isShowingStats()},setDisplayStats:V}),W=/(\.[^\.\/\?\\]*)(\?.*)?$/,X=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,q=/[^\.\/]+\/\.\.\//;function Y(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){e=(e+(""===e?"":"/")+a[r]).replace(/(\/|\\\\)$/,"")}return e}function K(e){var t=W.exec(e);return t?t[1]:""}function Q(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Z(e,t){var i=e.indexOf("?");0<i&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function J(e){var t=X.exec(e);return t?t[2]:""}function $(e,t){t=t||"";var i=e.indexOf("?"),n="";return 0<i&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function ee(e,t,i){if(0===t.indexOf("."))return $(e,t);var n=e.indexOf("?"),r="",a=i?K(e):"";return 0<n&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function te(e){for(var t=e=String(e);e=(t=e).replace(q,""),t.length!==e.length;);return e}function ie(e){return e.replace(/[\/\\]$/,"")}function ne(){return cc.sys.os===cc.sys.OS_WINDOWS?"\\":"/"}var re=Object.freeze({join:Y,extname:K,mainFileName:Q,basename:Z,dirname:J,changeExtname:$,changeBasename:ee,_normalize:te,stripSep:ie,getSeperator:ne});cc.log=A,cc.warn=C,cc.error=w,cc.assert=R,cc._throw=O,cc.logID=B,cc.warnID=I,cc.errorID=j,cc.assertID=U,cc.debug=H,cc.path={join:Y,extname:K,mainFileName:Q,basename:Z,dirname:J,changeExtname:$,changeBasename:ee,_normalize:te,stripSep:ie,get sep(){return ne()}};var ae=Math.PI/180,se=180/Math.PI,oe=1e-6;function le(e,t,i){if(i<t){var n=t;t=i,i=n}return e<t?t:i<e?i:e}function ce(e){return e<0?0:1<e?1:e}function ue(e,t,i){return e+(t-e)*i}function he(e){return e*ae}function de(e){return e*se}var fe=Math.random;function pe(e,t){return Math.random()*(t-e)+e}function _e(e,t){return Math.floor(pe(e,t))}function ve(e){return(e=(9301*e+49297)%233280)/233280}function me(e,t,i){return ve(e)*(i-t)+t}function ge(e,t){return e-Math.floor(e/t)*t}function be(e,t){return e=ge(e,2*t),e=t-Math.abs(e-t)}function Se(e,t,i){return(i-e)/(t-e)}var Te=2147483647;function Ee(e){return(0<e)-(e<0)}function xe(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}var Ae=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(Ae);var Ce=Object.freeze({INT_BITS:32,INT_MAX:Te,INT_MIN:-1<<31,sign:Ee,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:function(e){var t,i;return t=(65535<e)<<4,t|=i=(255<(e>>>=t))<<3,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1},log10:function(e){return 1e9<=e?9:1e8<=e?8:1e7<=e?7:1e6<=e?6:1e5<=e?5:1e4<=e?4:1e3<=e?3:100<=e?2:10<=e?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:xe,nextPow2:function(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)},prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return Ae[255&e]<<24|Ae[e>>>8&255]<<16|Ae[e>>>16&255]<<8|Ae[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>xe(e)+1}}),we=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;y(this,n),this.x=void 0,this.y=void 0,this.x=e,this.y=t}return l(n,null,[{key:"create",value:function(){return new n(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0)}},{key:"zero",value:function(e){return e.x=0,e.y=0,e}},{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"sub",value:function(e,t,i){return n.subtract(e,t,i)}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"mul",value:function(e,t,i){return n.multiply(e,t,i)}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"div",value:function(e,t,i){return n.divide(e,t,i)}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"scale",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}},{key:"dist",value:function(e,t){return n.distance(e,t)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n}},{key:"sqrDist",value:function(e,t){return n.squaredDistance(e,t)}},{key:"magnitude",value:function(e){var t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}},{key:"mag",value:function(e){return n.magnitude(e)}},{key:"squaredMagnitude",value:function(e){var t=e.x,i=e.y;return t*t+i*i}},{key:"sqrMag",value:function(e){return n.squaredMagnitude(e)}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y;return Math.abs(i)<oe?e.x=0:e.x=1/i,Math.abs(n)<oe?e.y=0:e.y=1/t.y,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=i*i+n*n;return 0<r&&(r=1/Math.sqrt(r),e.x=t.x*r,e.y=t.y*r),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e}},{key:"random",value:function(e,t){t=t||1;var i=2*fe()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m03*r+i.m06,e.y=i.m01*n+i.m04*r+i.m07,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m04*r+i.m12,e.y=i.m01*n+i.m05*r+i.m13,e}},{key:"str",value:function(e){return"vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"exactEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=e.x,n=e.y,r=t.x,a=t.y;return Math.abs(i-r)<=oe*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(n-a)<=oe*Math.max(1,Math.abs(n),Math.abs(a))}},{key:"angle",value:function(e,t){n.normalize(Re,e),n.normalize(ke,t);var i=n.dot(Re,ke);return 1<i?0:i<-1?Math.PI:Math.acos(i)}}]),n}();we.ZERO=Object.freeze(new we(0,0)),we.ONE=Object.freeze(new we(1,1)),we.NEG_ONE=Object.freeze(new we(-1,-1));var Re=we.create(),ke=we.create(),Oe=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;y(this,r),this.x=void 0,this.y=void 0,this.z=void 0,this.x=e,this.y=t,this.z=i}return l(r,null,[{key:"create",value:function(){return new r(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0)}},{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"sub",value:function(e,t,i){return r.subtract(e,t,i)}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"mul",value:function(e,t,i){return r.multiply(e,t,i)}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"div",value:function(e,t,i){return r.divide(e,t,i)}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"scale",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+n*n+r*r)}},{key:"dist",value:function(e,t){return r.distance(e,t)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return i*i+n*n+r*r}},{key:"sqrDist",value:function(e,t){return r.squaredDistance(e,t)}},{key:"magnitude",value:function(e){var t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}},{key:"mag",value:function(e){return r.magnitude(e)}},{key:"squaredMagnitude",value:function(e){var t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}},{key:"sqrMag",value:function(e){return r.squaredMagnitude(e)}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z;return Math.abs(i)<oe?e.x=0:e.x=1/i,Math.abs(n)<oe?e.y=0:e.y=1/n,Math.abs(r)<oe?e.z=0:e.z=1/r,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=i*i+n*n+r*r;return 0<a&&(a=1/Math.sqrt(a),e.x=i*a,e.y=n*a,e.z=r*a),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z;return e.x=r*l-a*o,e.y=a*s-n*l,e.z=n*o-r*s,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e.z=s+n*(i.z-s),e}},{key:"random",value:function(e,t){t=t||1;var i=2*fe()*Math.PI,n=2*fe()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.m03*n+i.m07*r+i.m11*a+i.m15;return s=s?1/s:1,e.x=(i.m00*n+i.m04*r+i.m08*a+i.m12)*s,e.y=(i.m01*n+i.m05*r+i.m09*a+i.m13)*s,e.z=(i.m02*n+i.m06*r+i.m10*a+i.m14)*s,e}},{key:"transformMat4Normal",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.m03*n+i.m07*r+i.m11*a;return s=s?1/s:1,e.x=(i.m00*n+i.m04*r+i.m08*a)*s,e.y=(i.m01*n+i.m05*r+i.m09*a)*s,e.z=(i.m02*n+i.m06*r+i.m10*a)*s,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;return e.x=n*i.m00+r*i.m03+a*i.m06,e.y=n*i.m01+r*i.m04+a*i.m07,e.z=n*i.m02+r*i.m05+a*i.m08,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z,c=i.w,u=c*n+o*a-l*r,h=c*r+l*n-s*a,d=c*a+s*r-o*n,f=-s*n-o*r-l*a;return e.x=u*c+f*-s+h*-l-d*-o,e.y=h*c+f*-o+d*-s-u*-l,e.z=d*c+f*-l+u*-o-h*-s,e}},{key:"rotateX",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,s=t.z-i.z,o=Math.cos(n),l=Math.sin(n),c=r,u=a*o-s*l,h=a*l+s*o;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"rotateY",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,s=t.z-i.z,o=Math.cos(n),l=Math.sin(n),c=s*l+r*o,u=a,h=s*o-r*l;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,s=t.z-i.z,o=Math.cos(n),l=Math.sin(n),c=r*o-a*l,u=r*l+a*o,h=s;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"str",value:function(e){return"vec3(".concat(e.x,", ").concat(e.y,", ").concat(e.z,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"exactEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:oe,n=e.x,r=e.y,a=e.z,s=t.x,o=t.y,l=t.z;return Math.abs(n-s)<=i*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-o)<=i*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-l)<=i*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,t){r.normalize(Fe,e),r.normalize(Le,t);var i=r.dot(Fe,Le);return 1<i?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return r.subtract(e,t,r.project(e,t,i))}},{key:"project",value:function(e,t,i){var n=r.squaredMagnitude(i);return n<1e-6?r.set(e,0,0,0):r.scale(e,i,r.dot(t,i)/n)}}]),r}();Oe.UNIT_X=Object.freeze(new Oe(1,0,0)),Oe.UNIT_Y=Object.freeze(new Oe(0,1,0)),Oe.UNIT_Z=Object.freeze(new Oe(0,0,1)),Oe.ZERO=Object.freeze(new Oe(0,0,0)),Oe.ONE=Object.freeze(new Oe(1,1,1)),Oe.NEG_ONE=Object.freeze(new Oe(-1,-1,-1));var Fe=Oe.create(),Le=Oe.create(),Be=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=i,this.w=n}return l(r,null,[{key:"create",value:function(){return new r(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}},{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=0,e}},{key:"clone",value:function(e){return new r(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"sub",value:function(e,t,i){return r.subtract(e,t,i)}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"mul",value:function(e,t,i){return r.multiply(e,t,i)}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"div",value:function(e,t,i){return r.divide(e,t,i)}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"scale",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"dist",value:function(e,t){return r.distance(e,t)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"sqrDist",value:function(e,t){return r.squaredDistance(e,t)}},{key:"magnitude",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return Math.sqrt(t*t+i*i+n*n+r*r)}},{key:"mag",value:function(e){return r.magnitude(e)}},{key:"squaredMagnitude",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return t*t+i*i+n*n+r*r}},{key:"sqrMag",value:function(e){return r.squaredMagnitude(e)}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w;return Math.abs(i)<oe?e.x=0:e.x=1/i,Math.abs(n)<oe?e.y=0:e.y=1/n,Math.abs(r)<oe?e.z=0:e.z=1/r,Math.abs(a)<oe?e.w=0:e.w=1/a,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i*i+n*n+r*r+a*a;return 0<s&&(s=1/Math.sqrt(s),e.x=i*s,e.y=n*s,e.z=r*s,e.w=a*s),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e.z=s+n*(i.z-s),e.w=o+n*(i.w-o),e}},{key:"random",value:function(e,t){t=t||1;var i=2*fe()*Math.PI,n=2*fe()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w;return e.x=i.m00*n+i.m04*r+i.m08*a+i.m12*s,e.y=i.m01*n+i.m05*r+i.m09*a+i.m13*s,e.z=i.m02*n+i.m06*r+i.m10*a+i.m14*s,e.w=i.m03*n+i.m07*r+i.m11*a+i.m15*s,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=i.x,o=i.y,l=i.z,c=i.w,u=c*n+o*a-l*r,h=c*r+l*n-s*a,d=c*a+s*r-o*n,f=-s*n-o*r-l*a;return e.x=u*c+f*-s+h*-l-d*-o,e.y=h*c+f*-o+d*-s-u*-l,e.z=d*c+f*-l+u*-o-h*-s,e.w=t.w,e}},{key:"str",value:function(e){return"vec4(".concat(e.x,", ").concat(e.y,", ").concat(e.z,", ").concat(e.w,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"exactEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=e.x,n=e.y,r=e.z,a=e.w,s=t.x,o=t.y,l=t.z,c=t.w;return Math.abs(i-s)<=oe*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=oe*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-l)<=oe*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(a-c)<=oe*Math.max(1,Math.abs(a),Math.abs(c))}}]),r}();Be.ZERO=Object.freeze(new Be(0,0,0,0)),Be.ONE=Object.freeze(new Be(1,1,1,1)),Be.NEG_ONE=Object.freeze(new Be(-1,-1,-1,-1));var Me=function(){function c(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:1;y(this,c),this.m00=void 0,this.m01=void 0,this.m02=void 0,this.m03=void 0,this.m04=void 0,this.m05=void 0,this.m06=void 0,this.m07=void 0,this.m08=void 0,this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=s,this.m07=o,this.m08=l}return l(c,null,[{key:"create",value:function(){return new c(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,8<arguments.length&&void 0!==arguments[8]?arguments[8]:1)}},{key:"clone",value:function(e){return new c(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=u*s-o*c,d=-u*a+o*l,f=c*a-s*l,p=i*h+n*d+r*f;return p?(p=1/p,e.m00=h*p,e.m01=(-u*n+r*c)*p,e.m02=(o*n-r*s)*p,e.m03=d*p,e.m04=(u*i-r*l)*p,e.m05=(-o*i+r*a)*p,e.m06=f*p,e.m07=(-c*i+n*l)*p,e.m08=(s*i-n*a)*p,e):null}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,s=e.m05,o=e.m06,l=e.m07,c=e.m08;return t*(c*a-s*l)+i*(-c*r+s*o)+n*(l*r-a*o)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,d=i.m00,f=i.m01,p=i.m02,_=i.m03,v=i.m04,m=i.m05,y=i.m06,g=i.m07,b=i.m08;return e.m00=d*n+f*s+p*c,e.m01=d*r+f*o+p*u,e.m02=d*a+f*l+p*h,e.m03=_*n+v*s+m*c,e.m04=_*r+v*o+m*u,e.m05=_*a+v*l+m*h,e.m06=y*n+g*s+b*c,e.m07=y*r+g*o+b*u,e.m08=y*a+g*l+b*h,e}},{key:"mul",value:function(e,t,i){return c.multiply(e,t,i)}},{key:"translate",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,d=i.x,f=i.y;return e.m00=n,e.m01=r,e.m02=a,e.m03=s,e.m04=o,e.m05=l,e.m06=d*n+f*s+c,e.m07=d*r+f*o+u,e.m08=d*a+f*l+h,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,d=Math.sin(i),f=Math.cos(i);return e.m00=f*n+d*s,e.m01=f*r+d*o,e.m02=f*a+d*l,e.m03=f*s-d*n,e.m04=f*o-d*r,e.m05=f*l-d*a,e.m06=c,e.m07=u,e.m08=h,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return Oe.sqrMag(t)<1e-12?(c.identity(e),e):(i=i||Oe.UNIT_Y,Oe.normalize(Ie,Oe.cross(Ie,i,t)),Oe.sqrMag(Ie)<1e-12?c.identity(e):(Oe.cross(Pe,t,Ie),c.set(e,Ie.x,Ie.y,Ie.z,Pe.x,Pe.y,Pe.z,t.x,t.y,t.z)),e)}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,d=r*s,f=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m03=u-m,e.m06=d+v,e.m01=u+m,e.m04=1-c-p,e.m07=f-_,e.m02=d-v,e.m05=f+_,e.m08=1-c-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,d=t.m10,f=t.m11,p=t.m12,_=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*c-a*s,S=n*l-r*o,T=n*c-a*o,E=r*c-a*l,x=u*_-h*p,A=u*v-d*p,C=u*m-f*p,w=h*v-d*_,R=h*m-f*_,k=d*m-f*v,O=y*k-g*R+b*w+S*C-T*A+E*x;return O?(O=1/O,e.m00=(o*k-l*R+c*w)*O,e.m01=(l*C-s*k-c*A)*O,e.m02=(s*R-o*C+c*x)*O,e.m03=(r*R-n*k-a*w)*O,e.m04=(i*k-r*C+a*A)*O,e.m05=(n*C-i*R-a*x)*O,e.m06=(_*E-v*T+m*S)*O,e.m07=(v*b-p*E-m*g)*O,e.m08=(p*T-_*b+m*y)*O,e):null}},{key:"str",value:function(e){return"mat3(".concat(e.m00,", ").concat(e.m01,", ").concat(e.m02,", ").concat(e.m03,", ").concat(e.m04,", ").concat(e.m05,", ").concat(e.m06,", ").concat(e.m07,", ").concat(e.m08,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"sub",value:function(e,t,i){return c.subtract(e,t,i)}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e}},{key:"exactEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=e.m00,n=e.m01,r=e.m02,a=e.m03,s=e.m04,o=e.m05,l=e.m06,c=e.m07,u=e.m08,h=t.m00,d=t.m01,f=t.m02,p=t.m03,_=t.m04,v=t.m05,m=t.m06,y=t.m07,g=t.m08;return Math.abs(i-h)<=oe*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(n-d)<=oe*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(r-f)<=oe*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(a-p)<=oe*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-_)<=oe*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(o-v)<=oe*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(l-m)<=oe*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(c-y)<=oe*Math.max(1,Math.abs(c),Math.abs(y))&&Math.abs(u-g)<=oe*Math.max(1,Math.abs(u),Math.abs(g))}}]),c}(),Ie=Oe.create(0,0,0),Pe=Oe.create(0,0,0),De=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,s),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=e,this.y=t,this.z=i,this.w=n}return l(s,null,[{key:"create",value:function(){return new s(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}},{key:"clone",value:function(e){return new s(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return Be.copy(e,t)}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var n=Oe.dot(t,i);return n<-.999999?(Oe.cross(Ue,Oe.UNIT_X,t),Oe.magnitude(Ue)<1e-6&&Oe.cross(Ue,Oe.UNIT_Y,t),Oe.normalize(Ue,Ue),s.fromAxisAngle(e,Ue,Math.PI),e):.999999<n?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Oe.cross(Ue,t,i),e.x=Ue.x,e.y=Ue.y,e.z=Ue.z,e.w=1+n,s.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return e.z=0!==n?(e.x=t.x/n,e.y=t.y/n,t.z/n):(e.x=1,e.y=0),i}},{key:"multiply",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=i.x,l=i.y,c=i.z,u=i.w;return e.x=n*u+s*o+r*c-a*l,e.y=r*u+s*l+a*o-n*c,e.z=a*u+s*c+n*l-r*o,e.w=s*u-n*o-r*l-a*c,e}},{key:"mul",value:function(e,t,i){return s.multiply(e,t,i)}},{key:"scale",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=t.x,r=t.y,a=t.z,s=t.w,o=Math.sin(i),l=Math.cos(i);return e.x=n*l+s*o,e.y=r*l+a*o,e.z=a*l-r*o,e.w=s*l-n*o,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=t.x,r=t.y,a=t.z,s=t.w,o=Math.sin(i),l=Math.cos(i);return e.x=n*l-a*o,e.y=r*l+s*o,e.z=a*l+n*o,e.w=s*l-r*o,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=t.x,r=t.y,a=t.z,s=t.w,o=Math.sin(i),l=Math.cos(i);return e.x=n*l+r*o,e.y=r*l-n*o,e.z=a*l+s*o,e.w=s*l-a*o,e}},{key:"rotateAround",value:function(e,t,i,n){return s.invert(Ne,t),Oe.transformQuat(Ue,i,Ne),s.fromAxisAngle(Ne,Ue,n),s.multiply(e,t,Ne),e}},{key:"rotateAroundLocal",value:function(e,t,i,n){return s.fromAxisAngle(Ne,i,n),s.multiply(e,t,Ne),e}},{key:"calculateW",value:function(e,t){var i=t.x,n=t.y,r=t.z;return e.x=i,e.y=n,e.z=r,e.w=Math.sqrt(Math.abs(1-i*i-n*n-r*r)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e.z=s+n*(i.z-s),e.w=o+n*(i.w-o),e}},{key:"slerp",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=i.x,c=i.y,u=i.z,h=i.w,d=0,f=0,p=r*l+a*c+s*u+o*h;if(p<0&&(p=-p,l=-l,c=-c,u=-u,h=-h),1e-6<1-p){var _=Math.acos(p),v=Math.sin(_);d=Math.sin((1-n)*_)/v,f=Math.sin(n*_)/v}else d=1-n,f=n;return e.x=d*r+f*l,e.y=d*a+f*c,e.z=d*s+f*u,e.w=d*o+f*h,e}},{key:"sqlerp",value:function(e,t,i,n,r,a){return s.slerp(Ne,t,r,a),s.slerp(ze,i,n,a),s.slerp(e,Ne,ze,2*a*(1-a)),e}},{key:"invert",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i*i+n*n+r*r+a*a,o=s?1/s:0;return e.x=-i*o,e.y=-n*o,e.z=-r*o,e.w=a*o,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"magnitude",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return Math.sqrt(t*t+i*i+n*n+r*r)}},{key:"mag",value:function(e){return s.magnitude(e)}},{key:"squaredMagnitude",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return t*t+i*i+n*n+r*r}},{key:"sqrMag",value:function(e){return s.squaredMagnitude(e)}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i*i+n*n+r*r+a*a;return 0<s&&(s=1/Math.sqrt(s),e.x=i*s,e.y=n*s,e.z=r*s,e.w=a*s),e}},{key:"fromAxes",value:function(e,t,i,n){return Me.set(Ge,t.x,t.y,t.z,i.x,i.y,i.z,n.x,n.y,n.z),s.normalize(e,s.fromMat3(e,Ge))}},{key:"fromViewUp",value:function(e,t,i){return Me.fromViewUp(Ge,t,i),s.normalize(e,s.fromMat3(e,Ge))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,s=t.m04,o=t.m07,l=t.m02,c=t.m05,u=t.m08,h=i+s+u;if(0<h){var d=.5/Math.sqrt(h+1);e.w=.25/d,e.x=(c-o)*d,e.y=(r-l)*d,e.z=(a-n)*d}else if(s<i&&u<i){var f=2*Math.sqrt(1+i-s-u);e.w=(c-o)/f,e.x=.25*f,e.y=(n+a)/f,e.z=(r+l)/f}else if(u<s){var p=2*Math.sqrt(1+s-i-u);e.w=(r-l)/p,e.x=(n+a)/p,e.y=.25*p,e.z=(o+c)/p}else{var _=2*Math.sqrt(1+u-i-s);e.w=(a-n)/_,e.x=(r+l)/_,e.y=(o+c)/_,e.z=.25*_}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=Ve,i*=Ve,n*=Ve;var r=Math.sin(t),a=Math.cos(t),s=Math.sin(i),o=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return e.x=r*o*c+a*s*l,e.y=a*s*c+r*o*l,e.z=a*o*l-r*s*c,e.w=a*o*c-r*s*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y}},{key:"toEuler",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=NaN,o=NaN,l=NaN,c=i*n+r*a;if(.499999<c&&(s=2*Math.atan2(i,a),o=Math.PI/2,l=0),c<-.499999&&(s=-2*Math.atan2(i,a),o=-Math.PI/2,l=0),isNaN(s)){var u=i*i,h=n*n,d=r*r;s=Math.atan2(2*n*a-2*i*r,1-2*h-2*d),o=Math.asin(2*c),l=Math.atan2(2*i*a-2*n*r,1-2*u-2*d)}return e.y=de(s),e.z=de(o),e.x=de(l),e}},{key:"str",value:function(e){return"quat(".concat(e.x,", ").concat(e.y,", ").concat(e.z,", ").concat(e.w,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"exactEquals",value:function(e,t){return Be.exactEquals(e,t)}},{key:"equals",value:function(e,t){return Be.equals(e,t)}}]),s}();De.IDENTITY=Object.freeze(new De);var Ne=De.create(),ze=De.create(),Ue=Oe.create(),Ge=Me.create(),Ve=.5*Math.PI/180,He=function(){function v(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,_=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;y(this,v),this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this.m00=e,this.m01=t,this.m02=i,this.m03=n,this.m04=r,this.m05=a,this.m06=s,this.m07=o,this.m08=l,this.m09=c,this.m10=u,this.m11=h,this.m12=d,this.m13=f,this.m14=p,this.m15=_}return l(v,null,[{key:"create",value:function(){return new v(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,15<arguments.length&&void 0!==arguments[15]?arguments[15]:1)}},{key:"clone",value:function(e){return new v(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,d,f,p,_,v){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=d,e.m12=f,e.m13=p,e.m14=_,e.m15=v,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,s=t.m07,o=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=s,e.m14=o}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,d=t.m10,f=t.m11,p=t.m12,_=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*c-a*s,S=n*l-r*o,T=n*c-a*o,E=r*c-a*l,x=u*_-h*p,A=u*v-d*p,C=u*m-f*p,w=h*v-d*_,R=h*m-f*_,k=d*m-f*v,O=y*k-g*R+b*w+S*C-T*A+E*x;return 0===O?null:(O=1/O,e.m00=(o*k-l*R+c*w)*O,e.m01=(r*R-n*k-a*w)*O,e.m02=(_*E-v*T+m*S)*O,e.m03=(d*T-h*E-f*S)*O,e.m04=(l*C-s*k-c*A)*O,e.m05=(i*k-r*C+a*A)*O,e.m06=(v*b-p*E-m*g)*O,e.m07=(u*E-d*b+f*g)*O,e.m08=(s*R-o*C+c*x)*O,e.m09=(n*C-i*R-a*x)*O,e.m10=(p*T-_*b+m*y)*O,e.m11=(h*b-u*T-f*y)*O,e.m12=(o*A-s*w-l*x)*O,e.m13=(i*w-n*A+r*x)*O,e.m14=(_*g-p*S-v*y)*O,e.m15=(u*S-h*g+d*y)*O,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,s=e.m05,o=e.m06,l=e.m07,c=e.m08,u=e.m09,h=e.m10,d=e.m11,f=e.m12,p=e.m13,_=e.m14,v=e.m15;return(t*s-i*a)*(h*v-d*_)-(t*o-n*a)*(u*v-d*p)+(t*l-r*a)*(u*_-h*p)+(i*o-n*s)*(c*v-d*f)-(i*l-r*s)*(c*_-h*f)+(n*l-r*o)*(c*p-u*f)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,s=t.m03,o=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,d=t.m09,f=t.m10,p=t.m11,_=t.m12,v=t.m13,m=t.m14,y=t.m15,g=i.m00,b=i.m01,S=i.m02,T=i.m03;return e.m00=g*n+b*o+S*h+T*_,e.m01=g*r+b*l+S*d+T*v,e.m02=g*a+b*c+S*f+T*m,e.m03=g*s+b*u+S*p+T*y,g=i.m04,b=i.m05,S=i.m06,T=i.m07,e.m04=g*n+b*o+S*h+T*_,e.m05=g*r+b*l+S*d+T*v,e.m06=g*a+b*c+S*f+T*m,e.m07=g*s+b*u+S*p+T*y,g=i.m08,b=i.m09,S=i.m10,T=i.m11,e.m08=g*n+b*o+S*h+T*_,e.m09=g*r+b*l+S*d+T*v,e.m10=g*a+b*c+S*f+T*m,e.m11=g*s+b*u+S*p+T*y,g=i.m12,b=i.m13,S=i.m14,T=i.m15,e.m12=g*n+b*o+S*h+T*_,e.m13=g*r+b*l+S*d+T*v,e.m14=g*a+b*c+S*f+T*m,e.m15=g*s+b*u+S*p+T*y,e}},{key:"mul",value:function(e,t,i){return v.multiply(e,t,i)}},{key:"translate",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;if(t===e)e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15;else{var s=t.m00,o=t.m01,l=t.m02,c=t.m03,u=t.m04,h=t.m05,d=t.m06,f=t.m07,p=t.m08,_=t.m09,v=t.m10,m=t.m11;e.m00=s,e.m01=o,e.m02=l,e.m03=c,e.m04=u,e.m05=h,e.m06=d,e.m07=f,e.m08=p,e.m09=_,e.m10=v,e.m11=m,e.m12=s*n+u*r+p*a+t.m12,e.m13=o*n+h*r+_*a+t.m13,e.m14=l*n+d*r+v*a+t.m14,e.m15=c*n+f*r+m*a+t.m15}return e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,s=n.z,o=Math.sqrt(r*r+a*a+s*s);if(Math.abs(o)<oe)return null;r*=o=1/o,a*=o,s*=o;var l=Math.sin(i),c=Math.cos(i),u=1-c,h=t.m00,d=t.m01,f=t.m02,p=t.m03,_=t.m04,v=t.m05,m=t.m06,y=t.m07,g=t.m08,b=t.m09,S=t.m10,T=t.m11,E=r*r*u+c,x=a*r*u+s*l,A=s*r*u-a*l,C=r*a*u-s*l,w=a*a*u+c,R=s*a*u+r*l,k=r*s*u+a*l,O=a*s*u-r*l,F=s*s*u+c;return e.m00=h*E+_*x+g*A,e.m01=d*E+v*x+b*A,e.m02=f*E+m*x+S*A,e.m03=p*E+y*x+T*A,e.m04=h*C+_*w+g*R,e.m05=d*C+v*w+b*R,e.m06=f*C+m*w+S*R,e.m07=p*C+y*w+T*R,e.m08=h*k+_*O+g*F,e.m09=d*k+v*O+b*F,e.m10=f*k+m*O+S*F,e.m11=p*k+y*O+T*F,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,s=t.m05,o=t.m06,l=t.m07,c=t.m08,u=t.m09,h=t.m10,d=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+c*n,e.m05=s*r+u*n,e.m06=o*r+h*n,e.m07=l*r+d*n,e.m08=c*r-a*n,e.m09=u*r-s*n,e.m10=h*r-o*n,e.m11=d*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m08,u=t.m09,h=t.m10,d=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-c*n,e.m01=s*r-u*n,e.m02=o*r-h*n,e.m03=l*r-d*n,e.m08=a*n+c*r,e.m09=s*n+u*r,e.m10=o*n+h*r,e.m11=l*n+d*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,s=t.m01,o=t.m02,l=t.m03,c=t.m04,u=t.m05,h=t.m06,d=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+c*n,e.m01=s*r+u*n,e.m02=o*r+h*n,e.m03=l*r+d*n,e.m04=c*r-a*n,e.m05=u*r-s*n,e.m06=h*r-o*n,e.m07=d*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,s=Math.sqrt(n*n+r*r+a*a);if(Math.abs(s)<oe)return null;n*=s=1/s,r*=s,a*=s;var o=Math.sin(t),l=Math.cos(t),c=1-l;return e.m00=n*n*c+l,e.m01=r*n*c+a*o,e.m02=a*n*c-r*o,e.m03=0,e.m04=n*r*c-a*o,e.m05=r*r*c+l,e.m06=a*r*c+n*o,e.m07=0,e.m08=n*a*c+r*o,e.m09=r*a*c-n*o,e.m10=a*a*c+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,s=t.w,o=n+n,l=r+r,c=a+a,u=n*o,h=n*l,d=n*c,f=r*l,p=r*c,_=a*c,v=s*o,m=s*l,y=s*c;return e.m00=1-(f+_),e.m01=h+y,e.m02=d-m,e.m03=0,e.m04=h-y,e.m05=1-(u+_),e.m06=p+v,e.m07=0,e.m08=d+m,e.m09=p-v,e.m10=1-(u+f),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=Xe.m00=t.m00,n=Xe.m01=t.m01,r=Xe.m02=t.m02,a=Xe.m03=t.m04,s=Xe.m04=t.m05,o=Xe.m05=t.m06,l=Xe.m06=t.m08,c=Xe.m07=t.m09,u=Xe.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+s*s+o*o),e.z=Math.sqrt(l*l+c*c+u*u),Me.determinant(Xe)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return 0<i?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=Oe.mag(Oe.set(We,e.m00,e.m01,e.m02)),Xe.m00=e.m00/n.x,Xe.m01=e.m01/n.x,Xe.m02=e.m02/n.x,n.y=Oe.mag(Oe.set(We,e.m04,e.m05,e.m06)),Xe.m03=e.m04/n.y,Xe.m04=e.m05/n.y,Xe.m05=e.m06/n.y,n.z=Oe.mag(Oe.set(We,e.m08,e.m09,e.m10)),Xe.m06=e.m08/n.z,Xe.m07=e.m09/n.z,Xe.m08=e.m10/n.z,Me.determinant(Xe)<0&&(n.x*=-1,Xe.m00*=-1,Xe.m01*=-1,Xe.m02*=-1),De.fromMat3(t,Xe),Oe.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=t.w,l=r+r,c=a+a,u=s+s,h=r*l,d=r*c,f=r*u,p=a*c,_=a*u,v=s*u,m=o*l,y=o*c,g=o*u,b=n.x,S=n.y,T=n.z;return e.m00=(1-(p+v))*b,e.m01=(d+g)*b,e.m02=(f-y)*b,e.m03=0,e.m04=(d-g)*S,e.m05=(1-(h+v))*S,e.m06=(_+m)*S,e.m07=0,e.m08=(f+y)*T,e.m09=(_-m)*T,e.m10=(1-(h+p))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,s=t.y,o=t.z,l=t.w,c=a+a,u=s+s,h=o+o,d=a*c,f=a*u,p=a*h,_=s*u,v=s*h,m=o*h,y=l*c,g=l*u,b=l*h,S=n.x,T=n.y,E=n.z,x=r.x,A=r.y,C=r.z;return e.m00=(1-(_+m))*S,e.m01=(f+b)*S,e.m02=(p-g)*S,e.m03=0,e.m04=(f-b)*T,e.m05=(1-(d+m))*T,e.m06=(v+y)*T,e.m07=0,e.m08=(p+g)*E,e.m09=(v-y)*E,e.m10=(1-(d+_))*E,e.m11=0,e.m12=i.x+x-(e.m00*x+e.m04*A+e.m08*C),e.m13=i.y+A-(e.m01*x+e.m05*A+e.m09*C),e.m14=i.z+C-(e.m02*x+e.m06*A+e.m10*C),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,s=i+i,o=n+n,l=r+r,c=i*s,u=n*s,h=n*o,d=r*s,f=r*o,p=r*l,_=a*s,v=a*o,m=a*l;return e.m00=1-h-p,e.m01=u+m,e.m02=d-v,e.m03=0,e.m04=u-m,e.m05=1-c-p,e.m06=f+_,e.m07=0,e.m08=d+v,e.m09=f-_,e.m10=1-c-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,s){var o=1/(i-t),l=1/(r-n),c=1/(a-s);return e.m00=2*a*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*o,e.m09=(r+n)*l,e.m10=(s+a)*c,e.m11=-1,e.m12=0,e.m13=0,e.m14=s*a*2*c,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=1/Math.tan(t/2),s=1/(n-r);return e.m00=a/i,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=a,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r+n)*s,e.m11=-1,e.m12=0,e.m13=0,e.m14=2*r*n*s,e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,s){var o=1/(t-i),l=1/(n-r),c=1/(a-s);return e.m00=-2*o,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=2*c,e.m11=0,e.m12=(t+i)*o,e.m13=(r+n)*l,e.m14=(s+a)*c,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,s=t.z,o=n.x,l=n.y,c=n.z,u=r-i.x,h=a-i.y,d=s-i.z,f=1/Math.sqrt(u*u+h*h+d*d),p=l*(d*=f)-c*(h*=f),_=c*(u*=f)-o*d,v=o*h-l*u,m=h*(v*=f=1/Math.sqrt(p*p+_*_+v*v))-d*(_*=f),y=d*(p*=f)-u*v,g=u*_-h*p;return e.m00=p,e.m01=m,e.m02=u,e.m03=0,e.m04=_,e.m05=y,e.m06=h,e.m07=0,e.m08=v,e.m09=g,e.m10=d,e.m11=0,e.m12=-(p*r+_*a+v*s),e.m13=-(m*r+y*a+g*s),e.m14=-(u*r+h*a+d*s),e.m15=1,e}},{key:"str",value:function(e){return"mat4(".concat(e.m00,", ").concat(e.m01,", ").concat(e.m02,", ").concat(e.m03,", ").concat(e.m04,", ").concat(e.m05,", ").concat(e.m06,", ").concat(e.m07,", ")+"".concat(e.m08,", ").concat(e.m09,", ").concat(e.m10,", ").concat(e.m11,", ").concat(e.m12,", ").concat(e.m13,", ").concat(e.m14,", ").concat(e.m15,")")}},{key:"inverseTranspose",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,o=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,d=t.m10,f=t.m11,p=t.m12,_=t.m13,v=t.m14,m=t.m15,y=i*o-n*s,g=i*l-r*s,b=i*c-a*s,S=n*l-r*o,T=n*c-a*o,E=r*c-a*l,x=u*_-h*p,A=u*v-d*p,C=u*m-f*p,w=h*v-d*_,R=h*m-f*_,k=d*m-f*v,O=y*k-g*R+b*w+S*C-T*A+E*x;return O?(O=1/O,e.m00=(o*k-l*R+c*w)*O,e.m01=(l*C-s*k-c*A)*O,e.m02=(s*R-o*C+c*x)*O,e.m03=0,e.m04=(r*R-n*k-a*w)*O,e.m05=(i*k-r*C+a*A)*O,e.m06=(n*C-i*R-a*x)*O,e.m07=0,e.m08=(_*E-v*T+m*S)*O,e.m09=(v*b-p*E-m*g)*O,e.m10=(p*T-_*b+m*y)*O,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"sub",value:function(e,t,i){return v.subtract(e,t,i)}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"exactEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:oe,n=e.m00,r=e.m01,a=e.m02,s=e.m03,o=e.m04,l=e.m05,c=e.m06,u=e.m07,h=e.m08,d=e.m09,f=e.m10,p=e.m11,_=e.m12,v=e.m13,m=e.m14,y=e.m15,g=t.m00,b=t.m01,S=t.m02,T=t.m03,E=t.m04,x=t.m05,A=t.m06,C=t.m07,w=t.m08,R=t.m09,k=t.m10,O=t.m11,F=t.m12,L=t.m13,B=t.m14,M=t.m15;return Math.abs(n-g)<=i*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(r-b)<=i*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(a-S)<=i*Math.max(1,Math.abs(a),Math.abs(S))&&Math.abs(s-T)<=i*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(o-E)<=i*Math.max(1,Math.abs(o),Math.abs(E))&&Math.abs(l-x)<=i*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-A)<=i*Math.max(1,Math.abs(c),Math.abs(A))&&Math.abs(u-C)<=i*Math.max(1,Math.abs(u),Math.abs(C))&&Math.abs(h-w)<=i*Math.max(1,Math.abs(h),Math.abs(w))&&Math.abs(d-R)<=i*Math.max(1,Math.abs(d),Math.abs(R))&&Math.abs(f-k)<=i*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(p-O)<=i*Math.max(1,Math.abs(p),Math.abs(O))&&Math.abs(_-F)<=i*Math.max(1,Math.abs(_),Math.abs(F))&&Math.abs(v-L)<=i*Math.max(1,Math.abs(v),Math.abs(L))&&Math.abs(m-B)<=i*Math.max(1,Math.abs(m),Math.abs(B))&&Math.abs(y-M)<=i*Math.max(1,Math.abs(y),Math.abs(M))}}]),v}(),We=new Oe,Xe=new Me,je=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=i,this.a=n}return l(r,null,[{key:"create",value:function(){return new r(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,3<arguments.length&&void 0!==arguments[3]?arguments[3]:1)}},{key:"clone",value:function(e){return new r(e.r,e.g,e.b,e.a)}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHex",value:function(e,t){var i=(t>>24)/255,n=(t>>16&255)/255,r=(t>>8&255)/255,a=(255&t)/255;return e.r=i,e.g=n,e.b=r,e.a=a,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"sub",value:function(e,t,i){return r.subtract(e,t,i)}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"mul",value:function(e,t,i){return r.multiply(e,t,i)}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"div",value:function(e,t,i){return r.divide(e,t,i)}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){var r=t.r,a=t.g,s=t.b,o=t.a;return e.r=r+n*(i.r-r),e.g=a+n*(i.g-a),e.b=s+n*(i.b-s),e.a=o+n*(i.a-o),e}},{key:"str",value:function(e){return"color4(".concat(e.r,", ").concat(e.g,", ").concat(e.b,", ").concat(e.a,")")}},{key:"array",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=t instanceof cc.Color||1<t.a?1/255:1;return e[i+0]=t.r*n,e[i+1]=t.g*n,e[i+2]=t.b*n,e[i+3]=t.a*n,e}},{key:"exactEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=e.r,n=e.g,r=e.b,a=e.a,s=t.r,o=t.g,l=t.b,c=t.a;return Math.abs(i-s)<=oe*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=oe*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-l)<=oe*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(a-c)<=oe*Math.max(1,Math.abs(a),Math.abs(c))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),r}(),qe=Object.freeze({bits:Ce,vec2:we,vec3:Oe,vec4:Be,quat:De,mat3:Me,mat4:He,color4:je,EPSILON:oe,equals:function(e,t){return Math.abs(e-t)<=oe*Math.max(1,Math.abs(e),Math.abs(t))},approx:function(e,t,i){return i=i||oe,Math.abs(e-t)<=i},clamp:le,clamp01:ce,lerp:ue,toRadian:he,toDegree:de,random:fe,randomRange:pe,randomRangeInt:_e,pseudoRandom:ve,pseudoRandomRange:me,pseudoRandomRangeInt:function(e,t,i){return Math.floor(me(e,t,i))},nextPow2:function(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},repeat:ge,pingPong:be,inverseLerp:Se}),Ye=function(){function t(e){y(this,t),this.array=e,this.i=0}return l(t,[{key:"remove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);0<=t&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),t}();function Ke(e,t){e.splice(t,1)}function Qe(e,t){var i=e.indexOf(t);return 0<=i&&(Ke(e,i),!0)}function Ze(e,t){var i=e.findIndex(t);if(0<=i){var n=e[i];return Ke(e,i),n}}function Je(e,t){return 0<=e.indexOf(t)}var $e=Object.freeze({removeAt:Ke,fastRemoveAt:function(e,t){var i=e.length;t<0||i<=t||(e[t]=e[i-1],e.length=i-1)},remove:Qe,fastRemove:function(e,t){var i=e.indexOf(t);0<=i&&(e[i]=e[e.length-1],--e.length)},removeIf:Ze,verifyType:function(e,t){if(e&&0<e.length){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(!(a instanceof t))return cc.logID(1300),!1}}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)Qe(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(E(t))),e},indexOf:function(e,t,i){return Array.prototype.indexOf.call(e,[t,i])},contains:Je,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:Ye}),et=function(){function t(e){y(this,t),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return l(t,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),t}();et.global=new et("global");var tt=new et("TmpCId.");function it(e){return"number"==typeof e||e instanceof Number}function nt(e){return"string"==typeof e||e instanceof String}var rt,at,st,ot,lt=(rt={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){rt.value=i,rt.writable=n,rt.enumerable=r,Object.defineProperty(e,t,rt),rt.value=void 0}),ct=(at={get:void 0,set:void 0,enumerable:!1},function(e,t,i,n,r,a){"function"!=typeof n&&(r=n,n=void 0),at.get=i,at.set=n,at.enumerable=r,at.configurable=a,Object.defineProperty(e,t,at),at.get=void 0,at.set=void 0}),ut=(st={get:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){st.get=i,st.enumerable=n,st.configurable=r,Object.defineProperty(e,t,st),st.get=void 0}),ht=(ot={set:void 0,enumerable:!1,configurable:!1},function(e,t,i,n,r){ot.set=i,ot.enumerable=n,ot.configurable=r,Object.defineProperty(e,t,ot),ot.set=void 0});function dt(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function ft(e){if("function"!=typeof e)return e&&e.constructor?ft(e.constructor):"";var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}function pt(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],s=r.exec(i)[0];function o(){return this[s]}n?ct(e,a,o,function(e){this[s]=e}):ut(e,a,o)}function _t(e,t,i,n){for(var r in i){pt(e,t+"."+r,i[r],n)}}var vt=/(%d)|(%s)/,mt=/%s/;function yt(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;if("string"==typeof e&&vt.test(e))for(var r=0,a=i;r<a.length;r++){var s=a[r],o="number"==typeof s?vt:mt;o.test(e)?e=e.replace(o,s):e+=" "+s}else for(var l=0,c=i;l<c.length;l++){e+=" "+c[l]}return e}function gt(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function bt(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function St(e,t,i){var n=bt(t,e);n&&Object.defineProperty(i,e,n)}function Tt(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==ye(s)){cc.errorID(5402,s);continue}for(var o in s)o in e||St(o,s,e)}}return e}function Et(e){e=e||{};for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=i;r<a.length;r++){var s=a[r];if(s){if("object"!==ye(s)){cc.errorID(5403,s);continue}for(var o in s)St(o,s,e)}}return e}function xt(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function At(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ct(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=At(e)))return!1;if(e===t)return!0}}return!1}function wt(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var Rt={},kt={};function Ot(e,t){var i="__cid__",n=Rt;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],lt(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a='A Class already exists with the same __cid__ : "'+e+'".';0,cc.error(a)}else n[e]=t}}function Ft(e,t){if(function(e,t){var i="__classname__",n=kt;if(t.prototype.hasOwnProperty(i)&&delete n[t.prototype[i]],lt(t.prototype,i,e),e){var r=n[e];if(r&&r!==t){var a="A Class already exists with the same "+i+' : "'+e+'".';cc.error(a)}else n[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||tt.getNewId();i&&Ot(i,t)}}function Lt(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n].prototype,s=a.__cid__;s&&delete Rt[s];var o=a.__classname__;o&&delete kt[o]}}function Bt(e){return Rt[e]}function Mt(e){return kt[e]}function It(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Pt=function(){function r(e,t){y(this,r),this.count=void 0,this._pool=void 0;var i=(this._cleanup=void 0)===t?e:t,n=void 0===t?null:e;this.count=0,this._pool=new Array(i),this._cleanup=n}return l(r,[{key:"get",value:function(){return this._get()}}]),l(r,[{key:"_get",value:function(){if(0<this.count){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){0<=e&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),r}(),Dt=$e;cc.js={IDGenerator:et,Pool:Pt,array:$e,isNumber:it,isString:nt,getPropertyDescriptor:bt,addon:Tt,mixin:Et,extend:xt,getSuper:At,isChildClassOf:Ct,clear:wt,value:lt,getset:ct,get:ut,set:ht,unregisterClass:Lt,getClassName:ft,setClassName:Ft,getClassByName:Mt,_getClassId:It,_setClassId:Ot,_getClassById:Bt,obsolete:pt,obsoletes:_t,formatStr:yt,shiftArguments:gt,createMap:dt};for(var Nt=Object.freeze({array:Dt,IDGenerator:et,Pool:Pt,isNumber:it,isString:nt,value:lt,getset:ct,get:ut,set:ht,createMap:dt,getClassName:ft,obsolete:pt,obsoletes:_t,formatStr:yt,shiftArguments:gt,getPropertyDescriptor:bt,addon:Tt,mixin:Et,extend:xt,getSuper:At,isChildClassOf:Ct,clear:wt,_idToClass:Rt,_nameToClass:kt,_setClassId:Ot,setClassName:Ft,unregisterClass:Lt,_getClassById:Bt,getClassByName:Mt,_getClassId:It}),zt=/^(?:cc|dragonBones|sp|ccsg)\..+/,Ut=new Array(123),Gt=0;Gt<123;++Gt)Ut[Gt]=64;for(var Vt=0;Vt<64;++Vt)Ut["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Vt)]=Vt;var Ht=Ut;function Wt(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];ct(e,t,a,e[n])}}for(var r,a=e.prototype,s=0;s<t.length;s++){var o=(r=t[s])[0].toUpperCase()+r.slice(1);n(a,r,"get"+o,"set"+o)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function Xt(e){return e-=1,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)+1}function jt(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function qt(e,t,i){return le(e,t,i)}function Yt(e){return ce(e)}function Qt(e,t,i){return ue(e,t,i)}function Zt(e){return he(e)}function Jt(e){return de(e)}function $t(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function ei(e){return"object"===("undefined"==typeof window?"undefined":ye(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===ye(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ti(e,t,i){e&&setTimeout(function(){e(t,i)},0)}function ii(e,t,i,n){return Function("arg","return "+function(e){try{target._FUNC_(_U_ARGS_)}catch(e){cc._throw(e)}}.toString().replace(/_FUNC_/g,e).replace("_R_ARGS_","target"+(t?", "+t:"")).replace("_U_ARGS_",t||"").replace("_AFTER_CALL_",i||""))(n)}function ni(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function ri(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function ai(e){if("__enums__"in e)return e;lt(e,"__enums__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var s=""+a;r!==s&&lt(e,s,r)}return e}function si(e){"__enums__"in e||lt(e,"__enums__",null,!0)}cc.misc={BUILTIN_CLASSID_RE:zt,BASE64_VALUES:Ht,propertyDefine:Wt,nextPOT:Xt,pushToMap:jt,clampf:qt,clamp01:Yt,lerp:Qt,degreesToRadians:Zt,radiansToDegrees:Jt,contains:$t,isDomNode:ei,callInNextTick:ti,tryCatchFunctor_EDITOR:ii,isPlainEmptyObj_DEV:ni,cloneable_DEV:ri},ai.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},ai.getList=function(e){if(e.__enums__)return e.__enums__;var t=e.__enums__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort(function(e,t){return e.value-t.value}),t},cc.Enum=ai;var oi="$_$";function li(e,t,i){var n;n=function(){},i&&xt(n,i.constructor);var r=new n;return lt(e,"__attrs__",r),r}function ci(e){for(var t,i=cc.Class.getInheritanceChain(e),n=i.length-1;0<=n;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||li(r,0,(t=i[n+1])&&t.__attrs__)}return li(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function ui(e,t,i){var n,r;if("function"==typeof e)r=(n=hi(e)).constructor.prototype;else{var a=e;if(!(n=a.__attrs__))n=li(a,0,hi(e=a.constructor));r=n}if(void 0===i){var s=t+oi,o={};for(var l in n)l.startsWith(s)&&(o[l.slice(s.length)]=n[l]);return o}if("object"===ye(i))for(var c in i)95!==c.charCodeAt(0)&&(r[t+oi+c]=i[c]);else 0}function hi(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||ci(e)}function di(e){return hi(e).constructor.prototype}function fi(e,t,i,n){di(e)[t+oi+i]=n}var pi=function(){function i(e,t){y(this,i),this.name=void 0,this.default=void 0,this.name=e,this.default=t}return l(i,[{key:"toString",value:function(){return this.name}}]),i}(),_i=new pi("Integer",0);cc.Integer=_i,cc.CCInteger=_i;var vi=new pi("Float",0);cc.Float=vi,cc.CCFloat=vi;var mi=new pi("Boolean",!1);cc.Boolean=mi,cc.CCBoolean=mi;var yi=new pi("String","");function gi(l,c){return function(e,t){var i='"'+ft(e)+"."+t+'"',n=ui(e,t);if(!n.saveUrlAsAsset){var r=n.type;if(r===_i||r===vi?r="Number":r!==yi&&r!==mi||(r=r.toString()),r!==l)return void I(3604,i)}if(n.hasOwnProperty("default")){var a=n.default;if(void 0!==a)if(!(Array.isArray(a)||ni(a))){var s=ye(a),o=l.toLowerCase();if(s===o){if(!n.saveUrlAsAsset)if("object"===o){if(!a||a instanceof n.ctor)return;I(3605,i,ft(n.ctor))}else"Number"!==l&&I(3606,c,i,l)}else{if("function"===s)return;l===yi&&null==a?Ct(n.ctor,cc.RawAsset)||I(3607,i):I(3611,c,i,s)}delete n.type}}}}function bi(s){return function(e,t){gi("Object","type")(e,t);var i=hi(e)[t+oi+"default"],n=cc.Class.getDefault(i);if(!Array.isArray(n)&&Ct(s,cc.ValueType)){var r=ft(s),a=yt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',ft(e),t,r);i?A(a):I(3612,a,r,ft(e),t,r)}}}cc.String=yi,cc.CCString=yi;var Si=Object.freeze({DELIMETER:oi,createAttrsSingle:li,createAttrs:ci,attr:ui,getClassAttrs:hi,getClassAttrsProto:di,setClassAttr:fi,PrimitiveType:pi,CCInteger:_i,CCFloat:vi,CCBoolean:mi,CCString:yi,getTypeChecker:gi,getObjTypeChecker:bi}),Ti={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Ei(e,t,i,n){if(!e.get&&!e.set)if(e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var s in n[r]=a,Ti){var o=Ti[s];e.hasOwnProperty(s)&&(a[s]=e[s],o.canUsedInGet||delete e[s])}}else 0}function xi(e,t,i,n){if(Array.isArray(t)){if(!(0<t.length))return j(5508,i,n);if(cc.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Ai(e,t,i){if(e&&e.constructor===Object)return null;if(Array.isArray(e)&&0<e.length){e[0];return{default:[],type:e,_short:!0}}if("function"!=typeof e)return e instanceof pi?{default:e.default,_short:!0}:{default:e,_short:!0};var n=e;return cc.RawAsset.isRawAssetType(n)?{default:"",url:n,_short:!0}:{default:Ct(n,cc.ValueType)?new n:null,type:n,_short:!0}}var Ci=[];function wi(){return Ci[Ci.length-1]}cc._RF={push:function(e,t,i){void 0===i&&(i=t,t=""),Ci.push({uuid:t,script:i,module:e,exports:e.exports,beh:null})},pop:function(){var e=Ci.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:wi};var Ri=oi,ki=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function Oi(e,t){e.indexOf(t)<0&&e.push(t)}var Fi={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout(function(){t.init()},0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=ft(n);r?qi(n,a,r,n.$super,i.mixins):j(3633,a)}this.datas=null}}};function Li(e,t){Oi(e.__props__,t)}var Bi=[];function Mi(e,t,i,n,r){var a=n.default;fi(e,i,"default",a),Li(e,i);var s=Zi(e,n,t,i,!1);if(s){for(var o=Bi,l=0;l<s.length;l++){var c=s[l];ui(e,i,c),!1===c.serializable&&Oi(e.__values__,i),c._onAfterProp&&o.push(c._onAfterProp)}for(var u=0;u<o.length;u++)o[u](e,i);Bi.length=0,s.length=0}}function Ii(e,t,i,n,r){var a=n.get,s=n.set,o=e.prototype,l=Object.getOwnPropertyDescriptor(o,i),c=!l;if(a){0;for(var u=Zi(e,n,t,i,!0),h=0;h<u.length;h++)ui(e,i,u[h]);u.length=0,fi(e,i,"serializable",!1),r||ut(o,i,a,c,c)}s&&(r||ht(o,i,s,c,c))}function Pi(e){return"function"==typeof e?e():e}function Di(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,bt(t,n))}function Ni(e,t,i,n){var r,a,s=n.__ctor__,o=n.ctor,l=n.__ES6__;l?(r=[o],a=o):(r=s?[s]:function(e,t,i){function n(e){return Yi._isCCClass(e)?e.__ctors__||[]:[e]}for(var r=[],a=[e].concat(t),s=0;s<a.length;s++){var o=a[s];if(o)for(var l=n(o),c=0;c<l.length;c++)Oi(r,l[c])}var u=i.ctor;u&&r.push(u);return r}(t,i,n),a=Hi(r,t,e,n),lt(a,"extend",function(e){return e.extends=this,Yi(e)},!0)),lt(a,"__ctors__",0<r.length?r:null,!0);var c=a.prototype;if(t&&(l||(xt(a,t),c=a.prototype),a.$super=t),i){for(var u=function(e){var t=i[e];Di(c,t.prototype),Di(a,t,function(e){return t.hasOwnProperty(e)&&!0}),Yi._isCCClass(t)&&Di(hi(a).constructor.prototype,hi(t).constructor.prototype)},h=i.length-1;0<=h;h--)u(h);c.constructor=a}return l||(c.__initProps__=Vi),Ft(e,a),a}function zi(e){for(var t=ft(e),i=e.constructor,n="new "+t+"(",r=0;r<i.__props__.length;r++){var a=e[i.__props__[r]];0,n+=a,r<i.__props__.length-1&&(n+=",")}return n+")"}function Ui(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var Gi=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function Vi(e){var t=hi(e),i=e.__props__;null===i&&(Fi.init(),i=e.__props__);var n=function(e,t){for(var i=[],n="",r=0;r<t.length;r++){var a=t[r],s=a+Ri+"default";if(s in e){var o=void 0;o=Gi.test(a)?"this."+a+"=":"this["+Ui(a)+"]=";var l=void 0,c=e[s];if("object"===ye(c)&&c)l=c instanceof cc.ValueType?zi(c):Array.isArray(c)?"[]":"{}";else if("function"==typeof c){var u=i.length;i.push(c),l="F["+u+"]()"}else l="string"==typeof c?Ui(c):c;n+=o=o+l+";\n"}}return 0===i.length?Function(n):Function("F","return (function(){\n"+n+"})")(i)}(t,i);(e.prototype.__initProps__=n).call(this)}var Hi=function(e,t,i,n){var r="CCClass",a="return function CCClass(){\n";t&&ji(t,n,i)&&(a+="this._super=null;\n"),a+="this.__initProps__(CCClass);\n";var s=e.length;if(0<s){0;var o="].apply(this,arguments);\n";if(1===s)a+=r+".__ctors__[0"+o;else{a+="var cs=CCClass.__ctors__;\n";for(var l=0;l<s;l++)a+="cs["+l+o}0}return a+="}",Function(a)()};var Wi=/xyz/.test(function(){}.toString()),Xi=Wi?/\b\._super\b/:/.*/;function ji(e,t,i){var n=!1;for(var r in t)if(!(0<=ki.indexOf(r))){var a=t[r];if("function"==typeof a){var s=bt(e.prototype,r);if(s){var o=s.value;if("function"==typeof o){Xi.test(a)&&(n=!0,t[r]=function(i,n){return function(){var e=this._super;this._super=i;var t=n.apply(this,arguments);return this._super=e,t}}(o,a));continue}}0}}return n}function qi(t,e,i,n,r,a){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),r)for(var s=0;s<r.length;++s){var o=r[s];o.__props__&&(t.__props__=t.__props__.concat(o.__props__.filter(function(e){return t.__props__.indexOf(e)<0})))}if(i)for(var l in function(e,t,i,n){for(var r in e){var a=e[r],s=Ai(a);if(s&&(a=e[r]=s),a){var o=a.notify;o&&Ei(a,r,o,e),"type"in a&&xi(a,a.type,t,r),"url"in a&&(c=(l=a).url,Array.isArray(c)&&0<c.length&&(c=c[0]),l.type=c),"type"in a&&a.type}}var l,c}(i,e),i){var c=i[l];"default"in c?Mi(t,e,l,c):Ii(t,e,l,c,a)}var u=hi(t);t.__values__=t.__props__.filter(function(e){return!1!==u[e+Ri+"serializable"]})}function Yi(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=cc.Component,a=wi();if(a&&Ct(t,r)){if(Ct(a.cls,r))return j(3615),null;e=e||a.script}var s=Ni(e,t,i,n);if(a)if(Ct(t,r)){var o=a.uuid;o&&Ot(o,s),a.cls=s}else Ct(a.cls,r)||(a.cls=s);return s}(t,i,n,e);t||(t=cc.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some(function(e){return null===e.__props__})?(Fi.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):qi(r,t,a,i,e.mixins,e.__ES6__);var s,o,l=e.statics;if(l)for(s in l)r[s]=l[s];for(var c in e)if(!(0<=ki.indexOf(c))){var u=e[c];("function"==typeof(o=u)||null===o)&&lt(r.prototype,c,u,!0,!0)}var h=e.editor;return h&&Ct(i,cc.Component)&&cc.Component._registerEditorProps(r,h),r}Yi._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},Yi.fastDefine=function(e,t,i){Ft(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=di(t),a=0;a<n.length;a++){var s=n[a];r[s+Ri+"visible"]=!1,r[s+Ri+"default"]=i[s]}},Yi.Attr=Si,Yi.attr=ui,Yi.getInheritanceChain=function(e){for(var t=[];e=At(e);)e!==Object&&t.push(e);return t};var Ki={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},Qi=[];function Zi(e,n,t,i,r){var a=null,s="";function o(){return s=i+Ri,a=di(e)}Qi.length=0;var l=Qi,c=n.type;if(c){var u=Ki[c];if(u)l.push({type:c,_onAfterProp:void 0});else if("Object"===c)0;else if("object"===ye(c))ai.isEnum(c)&&l.push({type:"Enum",enumList:ai.getList(c)});else if("function"==typeof c){var h;0,l.push({type:"Object",ctor:c,_onAfterProp:h})}else 0}var d=function(e,t){if(e in n){var i=n[e];ye(i)===t&&((a||o())[s+e]=i)}};n.editorOnly&&((a||o())[s+"editorOnly"]=!0),n.url&&((a||o())[s+"saveUrlAsAsset"]=!0),!1===n.serializable&&((a||o())[s+"serializable"]=!1),d("formerlySerializedAs","string");var f=n.range;return f&&Array.isArray(f)&&2<=f.length&&((a||o())[s+"min"]=f[0],(a||o())[s+"max"]=f[1],2<f.length&&((a||o())[s+"step"]=f[2])),d("min","number"),d("max","number"),d("step","number"),l}Yi.isArray=function(e){return e=Pi(e),Array.isArray(e)},Yi.getDefault=Pi,Yi.escapeForJS=Ui,Yi.IDENTIFIER_RE=Gi,Yi.getNewValueTypeCode=zi,cc.Class=Yi;var Ji="__ccclassCache__";function $i(e){return e}function en(e,t){return e[t]||(e[t]={})}function tn(i){return function(t){return"function"==typeof t?i(t):function(e){return i(e,t)}}}function nn(e,i,t){return function(t){return function(e){return i(e,t)}}}var rn=nn.bind(null,!1);function an(e){return nn.bind(null,!1)}var sn=an(),on=an();function ln(e,t){return en(e,Ji)}function cn(e,t,i,n,r,a){var s;n&&(s=(s=Ai(n))||n);var o=Et(t[i]||{},s||{});if(r&&(r.get||r.set)){r.get&&(o.get=r.get),r.set&&(o.set=r.set)}else{var l;0;if(r)r.initializer&&(l=function(t){var e;try{e=t()}catch(e){return t}return"object"!==ye(e)||null===e?e:t}(r.initializer),!0);else{var c=a.default||(a.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));c.hasOwnProperty(i)&&(l=c[i],!0)}0,o.default=l}t[i]=o}var un=tn(function(e,t){var i=At(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e[Ji];if(r){var a=r.proto;a&&Et(n,a),e[Ji]=void 0}return cc.Class(n)});function hn(e,t,i){var a=null;function n(e,t,i){var n=ln(e.constructor);if(n){var r=en(en(n,"proto"),"properties");cn(e.constructor,r,t,a,i,n)}}if(void 0===t)return a=e,n;n(e,t,i)}function dn(e,r,a){return e(function(e,t){var i=ln(e);if(i){var n=void 0!==a?a:t;en(en(i,"proto"),"editor")[r]=n}},r)}function fn(e){return e($i)}var pn=fn(tn),_n=dn(rn,"requireComponent"),vn=fn(sn),mn=dn(on,"executionOrder"),yn=fn(tn),gn=fn(tn),bn=fn(sn),Sn=fn(sn),Tn=fn(sn);var En=Object.freeze({ccclass:un,property:hn,executeInEditMode:pn,requireComponent:_n,menu:vn,executionOrder:mn,disallowMultiple:yn,playOnFocus:gn,inspector:bn,icon:Sn,help:Tn,mixins:function(){for(var i=[],e=0;e<arguments.length;e++)i[e]=e<0||arguments.length<=e?void 0:arguments[e];return function(e){var t=ln(e);t&&(en(t,"proto").mixins=i)}}}),xn=[];var An,Cn=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";y(this,t),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}return l(t,null,[{key:"_deferredDestroy",value:function(){for(var e=xn.length,t=0;t<e;++t){var i=xn[t];1&i._objFlags||i._destroyImmediate()}e===xn.length?xn.length=0:xn.splice(0,e)}}]),l(t,[{key:"destroy",value:function(){return 1&this._objFlags?(cc.warnID(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,xn.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var i,n=e instanceof cc._BaseNode||e instanceof cc.Component,r=n?"_id":null,a={};for(i in e)if(e.hasOwnProperty(i)){if(i===r)continue;switch(ye(e[i])){case"string":a[i]="";break;case"object":case"function":a[i]=null}}if(Yi._isCCClass(t))for(var s=cc.Class.Attr.getClassAttrs(t),o=t.__props__,l=0;l<o.length;l++){var c=(i=o[l])+cc.Class.Attr.DELIMETER+"default";if(c in s){if(n&&"_id"===i)continue;switch(ye(s[c])){case"string":a[i]="";break;case"object":case"function":a[i]=null;break;case"undefined":a[i]=void 0}}}var u="";for(i in a){var h=void 0;h=Yi.IDENTIFIER_RE.test(i)?"o."+i+"=":"o["+Yi.escapeForJS(i)+"]=";var d=a[i];""===d&&(d='""'),u+=h+d+";\n"}return Function("o",u)}(this,e),lt(e,"__destruct__",t,!0)),t(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?cc.errorID(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}(),wn=Cn.prototype;wn._deserialize=null,wn._onPreDestroy=null,Yi.fastDefine("cc.Object",Cn,{_name:"",_objFlags:0}),lt(Cn,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),cc.isValid=function(e,t){return"object"===ye(e)?!(!e||e._objFlags&(t?5:1)):void 0!==e},cc.Object=Cn;var Rn=un("cc.RawAsset")(An=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._uuid=void 0,Object.defineProperty(d(d(t)),"_uuid",{value:"",writable:!0}),t}return p(a,Cn),l(a,null,[{key:"isRawAssetType",value:function(e){return Ct(e,cc.RawAsset)&&!Ct(e,cc.Asset)}}]),a}())||An;cc.RawAsset=Rn;var kn=function(){function n(e,t){y(this,n),this._fn=void 0,this._idx=void 0,this._frees=void 0,this._fn=e,this._idx=t-1,this._frees=new Array(t);for(var i=0;i<t;++i)this._frees[i]=e()}return l(n,[{key:"alloc",value:function(){this._idx<0&&this._expand(Math.round(1.2*this._frees.length)+1);var e=this._frees[this._idx];return this._frees.splice(this._idx),--this._idx,e}},{key:"free",value:function(e){++this._idx,this._frees[this._idx]=e}},{key:"clear",value:function(e){for(var t=0;t<=this._idx;t++)e&&e(this._frees[t]);this._frees.splice(0),this._idx=-1}},{key:"_expand",value:function(e){var t=this._frees;this._frees=new Array(e);for(var i=e-t.length,n=0;n<i;++n)this._frees[n]=this._fn();for(var r=i,a=0;r<e;++r,++a)this._frees[r]=t[a];this._idx+=i}}]),n}(),On=Dt.fastRemoveAt;function Fn(){}var Ln=function(){function e(){y(this,e),this.callback=Fn,this.target=void 0,this.once=!1}return l(e,[{key:"set",value:function(e,t,i){this.callback=e,this.target=t,this.once=!!i}}]),e}(),Bn=new kn(function(){return new Ln},32),Mn=function(){function e(){y(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return l(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(Bn.free(i),On(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(Bn.free(i),On(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(Bn.free(t),this.callbackInfos[e]=null),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(Bn.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;0<=e;--e){this.callbackInfos[e]||On(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),In=new kn(function(){return new Mn},16),Pn=function(){function e(){y(this,e),this._callbackTable=dt(!0)}return l(e,[{key:"on",value:function(e,t,i,n){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=In.alloc());var a=Bn.alloc();a.set(t,i,n),r.callbackInfos.push(a)}},{key:"hasEventListener",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){var a=r,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}if(l)return!0}return!1}return 0<r.length}var c=r,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;if(f&&f.callback===t&&f.target===i)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),In.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var s=r[a];s&&s.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.callback===t&&s.target===i){n.isInvoking?n.cancel(a):(On(r,a),Bn.free(s));break}}else this.removeAll(e)}}},{key:"emit",value:function(e){var t=this._callbackTable[e];if(t){var i=!t.isInvoking;t.isInvoking=!0;for(var n=t.callbackInfos,r=arguments.length,a=new Array(1<r?r-1:0),s=1;s<r;s++)a[s-1]=arguments[s];for(var o=0,l=n.length;o<l;++o){var c=n[o];if(c){var u=c.callback,h=c.target;c.once&&this.off(e,u,h),h?u.call.apply(u,[h].concat(a)):u.apply(void 0,a)}}i&&(t.isInvoking=!1,t.containCanceled&&t.purgeCanceled())}}}]),e}();var Dn,Nn,zn,Un,Gn,Vn,Hn,Wn=Dt.fastRemove,Xn=function(e){function r(){return y(this,r),T(this,S(r).apply(this,arguments))}return p(r,Pn),l(r,[{key:"on",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(S(r.prototype),"on",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"off",value:function(e,t,i){if(t){_(S(r.prototype),"off",this).call(this,e,t,i);var n=i;i&&(n.__eventTargets?Wn(n.__eventTargets,this):n.node&&n.node.__eventTargets&&Wn(n.node.__eventTargets,this))}else this.removeAll(e)}},{key:"targetOff",value:function(e){this.removeAll(e)}},{key:"once",value:function(e,t,i){if(t){if(!this.hasEventListener(e,t,i)){_(S(r.prototype),"on",this).call(this,e,t,i,!0);var n=i;i&&(n.__eventTargets?n.__eventTargets.push(this):n.node&&n.node.__eventTargets&&n.node.__eventTargets.push(this))}return t}cc.errorID(6800)}}]),r}();function jn(i,e){e.forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){"constructor"!==e&&Object.defineProperty(i.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e))})})}cc.EventTarget=Xn;var qn=(Dn=un("cc.Asset"),Nn=hn({visible:!1}),Dn((Hn=Vn=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).loaded=!0,v(t,"_native",Gn,d(d(t))),t._callbackTable=dt(!0),t}return p(a,Rn),l(a,null,[{key:"deserialize",value:function(e){return cc.deserialize(e)}}]),l(a,[{key:"on",value:function(e,t,i){}},{key:"off",value:function(e,t,i){}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"toString",value:function(){return this.nativeUrl}},{key:"_setRawAsset",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||void 0:"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(cc.AssetLibrary){var t=cc.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}cc.errorID(6400)}return""}},{key:"_nativeAsset",get:function(){return null},set:function(e){}}]),a}(),Vn.preventDeferredLoadDependents=!1,Vn.preventPreloadNativeObject=!1,Gn=c((Un=Hn).prototype,"_native",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),c(Un.prototype,"nativeUrl",[Nn],Object.getOwnPropertyDescriptor(Un.prototype,"nativeUrl"),Un.prototype),c(Un.prototype,"_nativeAsset",[hn],Object.getOwnPropertyDescriptor(Un.prototype,"_nativeAsset"),Un.prototype),zn=Un))||zn);function Yn(e){var t=[];return function e(t,i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;Array.isArray(o)?e(t,o):t.push(o)}}(t,e),t.join("")}jn(qn,[Pn,Xn]),qn.prototype.createNode=null,cc.Asset=qn;var Kn=Cn.Flags.Destroyed,Qn=Cn.Flags.PersistentMask,Zn=oi+"default",Jn=Yi.IDENTIFIER_RE,$n="var ",er="o",tr={"cc.Node":"cc.Node","cc.Sprite":"cc.Sprite","cc.Label":"cc.Label","cc.Button":"cc.Button","cc.Widget":"cc.Widget","cc.Animation":"cc.Animation","cc.ClickEvent":!1,"cc.PrefabInfo":!1},ir=Yi.escapeForJS,nr=function(){function i(e,t){y(this,i),this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return l(i,[{key:"toString",value:function(){return $n+this.varName+"="+this.expression+";"}}]),i}();function rr(e,t){return t instanceof nr?new nr(t.varName,e+t.expression):e+t}function ar(e,t,i){Array.isArray(i)?(i[0]=rr(t,i[0]),e.push(i)):e.push(rr(t,i)+";")}var sr=function(){function t(e){y(this,t),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}return l(t,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(1<this._exps.length)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];ar(e,t+or(n[0])+"=",n[1])}}}]),t}();function or(e){return Jn.test(e)?"."+e:"["+ir(e)+"]"}sr.pool=void 0,sr.pool=new Pt(function(e){e._exps.length=0,e._targetExp=null},1),sr.pool.get=function(e){var t=this._get()||new sr;return t._targetExp=e,t};var lr,cr,ur,hr,dr,fr,pr,_r=function(){function s(e,t){var i;y(this,s),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=dt(),Et(this.funcModuleCache,tr),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),0<this.globalVariables.length&&(i=$n+this.globalVariables.join(",")+";");var n=Yn(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,a=this.objsToClear_iN$t.length;r<a;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}return l(s,[{key:"getFuncModule",value:function(e,t){var i=ft(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=sr.pool.get(n),a=t.constructor.__props__;a||(a=Object.keys(t));for(var s=0;s<a.length;s++){var o=a[s],l=i[o];if(t[o]!==l){var c=this.enumerateField(i,o,l);r.append(o,c)}}r.writeCode(e),sr.pool.put(r)}},{key:"enumerateCCClass",value:function(e,t,i){for(var n=i.__values__,r=hi(i),a=0;a<n.length;a++){var s=n[a],o=t[s],l=r[s+Zn];if(!vr(l,o))if("object"===ye(o)&&o instanceof cc.ValueType&&(l=Yi.getDefault(l))&&l.constructor===o.constructor){var c=er+or(s);this.setValueType(e,l,o,c)}else this.setObjProp(e,t,s,o)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new nr(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){ar(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,t,i){if("object"===ye(i)&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var a=n.source[0];n.source[0]=rr(r+"=",a)}return r}return Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?ir(i):("_objFlags"===t&&e instanceof Cn&&(i&=Qn),i)}},{key:"setObjProp",value:function(e,t,i,n){ar(e,er+or(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,t){var i=t.constructor;if(cc.Class._isCCClass(i))this.enumerateCCClass(e,t,i);else for(var n in t)if(t.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=t[n];"object"===ye(r)&&r&&r===t._iN$t||this.setObjProp(e,t,n,r)}}},{key:"instantiateObj",value:function(e){if(e instanceof cc.ValueType)return Yi.getNewValueTypeCode(e);if(e instanceof cc.Asset)return this.getObjRef(e);if(e._objFlags&Kn)return null;var t,i=e.constructor;if(cc.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return this.getObjRef(e)}else if(this.parent instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof cc.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new nr(er,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new nr(er,"{}");else{if(i)return this.getObjRef(e);t=new nr(er,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),s}();function vr(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof cc.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}function mr(e){var t=e instanceof cc._BaseNode&&e;return new _r(e,t).result}var yr,gr,br,Sr=ai({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Tr=un("cc.Prefab")((pr=fr=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"data",ur,d(d(e))),v(e,"optimizationPolicy",hr,d(d(e))),v(e,"asyncLoadAssets",dr,d(d(e))),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return p(t,qn),l(t,[{key:"createNode",value:function(e){var t=cc.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){this._createFunction=mr(this.data)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:cc.warnID(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==Sr.SINGLE_INSTANCE&&(this.optimizationPolicy===Sr.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(),fr.OptimizationPolicy=Sr,fr.OptimizationPolicyThreshold=3,ur=c((cr=pr).prototype,"data",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hr=c(cr.prototype,"optimizationPolicy",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sr.AUTO}}),dr=c(cr.prototype,"asyncLoadAssets",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lr=cr))||lr;cc.Prefab=Tr,pt(cc,"cc._Prefab","Prefab");var Er=un("cc.Script")(yr=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,qn),t}())||yr;cc._Script=Er;var xr=un("cc.JavaScript")(gr=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Er),t}())||gr;cc._JavaScript=xr;var Ar,Cr,wr,Rr,kr=un("cc.TypeScript")(br=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Er),t}())||br;cc._TypeScript=kr;var Or=un("cc.SceneAsset")((wr=c((Cr=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"scene",wr,d(d(t))),v(t,"asyncLoadAssets",Rr,d(d(t))),t}return p(a,qn),a}()).prototype,"scene",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rr=c(Cr.prototype,"asyncLoadAssets",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ar=Cr))||Ar;cc.SceneAsset=Or;var Fr=function(){function e(){y(this,e)}return l(e,[{key:"clone",value:function(){return j(100,ft(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){j(100,ft(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}();Ft("cc.ValueType",Fr),cc.ValueType=Fr;var Lr=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).x=void 0,i.y=void 0,e&&"object"===ye(e)?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=t||0),i}return p(n,Fr),l(n,null,[{key:"lerp",value:function(e,t,i,n){var r=e.x,a=e.y;return n.x=r+(t.x-r)*i,n.y=a+(t.y-a)*i,n}},{key:"ONE",get:function(){return new n(1,1)}},{key:"ZERO",get:function(){return new n(0,0)}},{key:"UP",get:function(){return new n(0,1)}},{key:"RIGHT",get:function(){return new n(1,0)}}]),l(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e){return this.x=e.x,this.y=e.y,this}},{key:"equals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"fuzzyEquals",value:function(e,t){return this.x-t<=e.x&&e.x<=this.x+t&&this.y-t<=e.y&&e.y<=this.y+t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerpSelf",value:function(e,t){return n.lerp(this,e,t,this)}},{key:"clampf",value:function(e,t){return this.x=le(this.x,e.x,t.x),this.y=le(this.y,e.y,t.y),this}},{key:"addSelf",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"add",value:function(e,t){return(t=t||new n).x=this.x+e.x,t.y=this.y+e.y,t}},{key:"subSelf",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"sub",value:function(e,t){return(t=t||new n).x=this.x-e.x,t.y=this.y-e.y,t}},{key:"mulSelf",value:function(e){return this.x*=e,this.y*=e,this}},{key:"mul",value:function(e,t){return(t=t||new n).x=this.x*e,t.y=this.y*e,t}},{key:"scaleSelf",value:function(e){return this.x*=e.x,this.y*=e.y,this}},{key:"scale",value:function(e,t){return(t=t||new n).x=this.x*e.x,t.y=this.y*e.y,t}},{key:"divSelf",value:function(e){return this.x/=e,this.y/=e,this}},{key:"div",value:function(e,t){return(t=t||new n).x=this.x/e,t.y=this.y/e,t}},{key:"negSelf",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"neg",value:function(e){return(e=e||new n).x=-this.x,e.y=-this.y,e}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"mag",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"magSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalizeSelf",value:function(){var e=this.x*this.x+this.y*this.y;if(1===e)return this;if(0===e)return this;var t=1/Math.sqrt(e);return this.x*=t,this.y*=t,this}},{key:"normalize",value:function(e){return(e=e||new n).x=this.x,e.y=this.y,e.normalizeSelf(),e}},{key:"angle",value:function(e){var t=this.magSqr(),i=e.magSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=le(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotateSelf",value:function(e){var t=Math.sin(e),i=Math.cos(e),n=this.x;return this.x=i*n-t*this.y,this.y=t*n+i*this.y,this}},{key:"rotate",value:function(e,t){return(t=t||new n).x=this.x,t.y=this.y,t.rotateSelf(e)}},{key:"project",value:function(e){return e.mul(this.dot(e)/e.dot(e))}},{key:"transformMat4",value:function(e,t){t=t||new n,we.transformMat4(t,this,e)}}]),n}();Yi.fastDefine("cc.Vec2",Lr,{x:0,y:0}),cc.Vec2=Lr,cc.v2=function(e,t){return new Lr(e,t)};var Br=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this))).x=void 0,n.y=void 0,n.z=void 0,e&&"object"===ye(e)?(n.x=e.x,n.y=e.y,n.z=e.z):(n.x=e||0,n.y=t||0,n.z=i||0),n}return p(r,Fr),l(r,null,[{key:"lerp",value:function(e,t,i,n){return Oe.lerp(n,e,t,i),n}}]),l(r,[{key:"clone",value:function(){return new r(this.x,this.y,this.z)}},{key:"set",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"fuzzyEquals",value:function(e,t){return this.x-t<=e.x&&e.x<=this.x+t&&this.y-t<=e.y&&e.y<=this.y+t&&this.z-t<=e.z&&e.z<=this.z+t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerpSelf",value:function(e,t){return Oe.lerp(this,this,e,t)}},{key:"clampf",value:function(e,t){return this.x=le(this.x,e.x,t.x),this.y=le(this.y,e.y,t.y),this.z=le(this.z,e.z,t.z),this}},{key:"addSelf",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}},{key:"add",value:function(e,t){return(t=t||new r).x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}},{key:"subSelf",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}},{key:"sub",value:function(e,t){return(t=t||new r).x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}},{key:"mulSelf",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this}},{key:"mul",value:function(e,t){return(t=t||new r).x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}},{key:"scaleSelf",value:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}},{key:"scale",value:function(e,t){return(t=t||new r).x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t}},{key:"divSelf",value:function(e){return this.x/=e,this.y/=e,this.z/=e,this}},{key:"div",value:function(e,t){return(t=t||new r).x=this.x/e,t.y=this.y/e,t.z=this.z/e,t}},{key:"negSelf",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"neg",value:function(e){return(e=e||new r).x=-this.x,e.y=-this.y,e.z=-this.z,e}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e,t){return t=t||new r,Oe.cross(t,this,e),t}},{key:"mag",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"magSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalizeSelf",value:function(){return Oe.normalize(this,this),this}},{key:"normalize",value:function(e){return e=e||new r,Oe.normalize(e,this),e}},{key:"transformMat4",value:function(e,t){return t=t||new r,Oe.transformMat4(t,this,e),t}}]),r}();function Mr(e,t,i){return new Br(e,t,i)}Yi.fastDefine("cc.Vec3",Br,{x:0,y:0,z:0}),cc.Vec3=Br,cc.v3=Mr;var Ir=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===ye(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||0),r}return p(a,Fr),l(a,null,[{key:"lerp",value:function(e,t,i,n){return Be.lerp(n,e,t,i),n}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"fuzzyEquals",value:function(e,t){return this.x-t<=e.x&&e.x<=this.x+t&&this.y-t<=e.y&&e.y<=this.y+t&&this.z-t<=e.z&&e.z<=this.z+t&&this.w-t<=e.w&&e.w<=this.w+t}},{key:"lerpSelf",value:function(e,t){return Be.lerp(this,this,e,t)}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=le(this.x,e.x,t.x),this.y=le(this.y,e.y,t.y),this.z=le(this.z,e.z,t.z),this.w=le(this.w,e.w,t.w),this}},{key:"addSelf",value:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}},{key:"add",value:function(e,t){return(t=t||new a).x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}},{key:"subSelf",value:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}},{key:"sub",value:function(e,t){return(t=t||new a).x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}},{key:"mulSelf",value:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}},{key:"mul",value:function(e,t){return(t=t||new a).x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}},{key:"scaleSelf",value:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}},{key:"scale",value:function(e,t){return(t=t||new a).x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}},{key:"divSelf",value:function(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}},{key:"div",value:function(e,t){return(t=t||new a).x=this.x/e,t.y=this.y/e,t.z=this.z/e,t.w=this.w/e,t}},{key:"negSelf",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"neg",value:function(e){return(e=e||new a).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e,t){return t=t||new a,Oe.cross(t,this,e),t}},{key:"mag",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}},{key:"magSqr",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}},{key:"normalizeSelf",value:function(){return Be.normalize(this,this),this}},{key:"normalize",value:function(e){return e=e||new a,Be.normalize(e,this),e}},{key:"transformMat4",value:function(e,t){return t=t||new a,Be.transformMat4(t,this,e),t}}]),a}();Yi.fastDefine("cc.Vec4",Ir,{x:0,y:0,z:0,w:0}),cc.Vec4=Ir,cc.v4=function(e,t,i,n){return new Ir(e,t,i,n)};var Pr=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this))).x=void 0,r.y=void 0,r.z=void 0,r.w=void 0,e&&"object"===ye(e)?(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w):(r.x=e||0,r.y=t||0,r.z=i||0,r.w=n||1),r}return p(a,Fr),l(a,null,[{key:"lerp",value:function(e,t,i,n){return De.slerp(n,e,t,i),n}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}},{key:"equals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return e=e||new Br,De.toEuler(e,this)}},{key:"lerpSelf",value:function(e,t){var i=new a;return De.slerp(i,this,e,t),i}}]),a}();Yi.fastDefine("cc.Quat",Pr,{x:0,y:0,z:0,w:1}),cc.quat=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;return new Pr(e,t,i,n)},cc.Quat=Pr;var Dr=function(e){function m(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,o=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,l=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,u=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,h=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,d=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,f=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,p=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,_=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,v=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return y(this,m),(e=T(this,S(m).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===ye(t)?(e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e.m00=t.m00):(e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=s,e.m06=o,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=d,e.m12=f,e.m13=p,e.m14=_,e.m15=v,e.m00=t),e}return p(m,Fr),l(m,[{key:"clone",value:function(){var e=this;return new m(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(e){var t=this;return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,this}},{key:"equals",value:function(e){return He.exactEquals(this,e)}},{key:"fuzzyEquals",value:function(e){return He.equals(this,e)}},{key:"toString",value:function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+", "+e.m03+",\n"+e.m04+", "+e.m05+", "+e.m06+", "+e.m07+",\n"+e.m08+", "+e.m09+", "+e.m10+", "+e.m11+",\n"+e.m12+", "+e.m13+", "+e.m14+", "+e.m15+"\n]"}},{key:"identity",value:function(){return He.identity(this)}},{key:"transpose",value:function(e){return e=e||new cc.Mat4,He.transpose(e,this)}},{key:"invert",value:function(e){return e=e||new cc.Mat4,He.invert(e,this)}},{key:"adjoint",value:function(e){return e=e||new cc.Mat4,He.adjoint(e,this)}},{key:"determinant",value:function(){return He.determinant(this)}},{key:"add",value:function(e,t){return t=t||new cc.Mat4,He.add(t,this,e)}},{key:"sub",value:function(e,t){return t=t||new cc.Mat4,He.subtract(t,this,e)}},{key:"mul",value:function(e,t){return t=t||new cc.Mat4,He.multiply(t,this,e)}},{key:"mulScalar",value:function(e,t){return t=t||new cc.Mat4,He.scale(t,this,e)}},{key:"translate",value:function(e,t){return t=t||new cc.Mat4,He.translate(t,this,e)}},{key:"scale",value:function(e,t){return t=t||new cc.Mat4,He.scale(t,this,e)}},{key:"rotate",value:function(e,t,i){return i=i||new cc.Mat4,He.rotate(i,this,e,t)}},{key:"getTranslation",value:function(e){return e=e||new cc.Vec3,He.getTranslation(e,this)}},{key:"getScale",value:function(e){return e=e||new cc.Vec3,He.getScaling(e,this)}},{key:"getRotation",value:function(e){return e=e||new Pr,He.getRotation(e,this)}},{key:"fromRTS",value:function(e,t,i){return He.fromRTS(this,e,t,i)}},{key:"fromQuat",value:function(e){return He.fromQuat(this,e)}}]),m}();Yi.fastDefine("cc.Mat4",Dr,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),cc.Mat4=Dr,cc.mat4=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:0,_=15<arguments.length&&void 0!==arguments[15]?arguments[15]:1;return new Dr(e,t,i,n,r,a,s,o,l,c,u,h,d,f,p,_)};var Nr=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;y(this,s),this.a=void 0,this.b=void 0,this.c=void 0,this.d=void 0,this.tx=void 0,this.ty=void 0,this.a=e,this.b=t,this.c=i,this.d=n,this.tx=r,this.ty=a}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"identity",value:function(){return new s}},{key:"clone",value:function(e){return new s(e.a,e.b,e.c,e.d,e.tx,e.ty)}},{key:"concat",value:function(e,t,i){var n=t.a,r=t.b,a=t.c,s=t.d,o=t.tx,l=t.ty;return e.a=n*i.a+r*i.c,e.b=n*i.b+r*i.d,e.c=a*i.a+s*i.c,e.d=a*i.b+s*i.d,e.tx=o*i.a+l*i.c+i.tx,e.ty=o*i.b+l*i.d+i.ty,e}},{key:"invert",value:function(e,t){var i=t.a,n=t.b,r=t.c,a=t.d,s=1/(i*a-n*r),o=t.tx,l=t.ty;return e.a=s*a,e.b=-s*n,e.c=-s*r,e.d=s*i,e.tx=s*(r*l-a*o),e.ty=s*(n*o-i*l),e}},{key:"fromMat4",value:function(e,t){return e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13,e}},{key:"transformVec2",value:function(e,t,i,n){var r,a;return a=void 0===n?(n=i,r=t.x,t.y):(r=t,i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty,e}},{key:"transformSize",value:function(e,t,i){return e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height,e}},{key:"transformRect",value:function(e,t,i){var n=t.x,r=t.y,a=n+t.width,s=r+t.height,o=i.a*n+i.c*r+i.tx,l=i.b*n+i.d*r+i.ty,c=i.a*a+i.c*r+i.tx,u=i.b*a+i.d*r+i.ty,h=i.a*n+i.c*s+i.tx,d=i.b*n+i.d*s+i.ty,f=i.a*a+i.c*s+i.tx,p=i.b*a+i.d*s+i.ty,_=Math.min(o,c,h,f),v=Math.max(o,c,h,f),m=Math.min(l,u,d,p),y=Math.max(l,u,d,p);return e.x=_,e.y=m,e.width=v-_,e.height=y-m,e}},{key:"transformObb",value:function(e,t,i,n,r,a){var s=r.x,o=r.y,l=r.width,c=r.height,u=a.a*s+a.c*o+a.tx,h=a.b*s+a.d*o+a.ty,d=a.a*l,f=a.b*l,p=a.c*c,_=a.d*c;t.x=u,t.y=h,i.x=d+u,i.y=f+h,e.x=p+u,e.y=_+h,n.x=d+p+u,n.y=f+_+h}}]),s}();cc.AffineTransform=Nr;var zr=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).width=void 0,i.height=void 0,e&&"object"===ye(e)?(i.height=e.height,i.width=e.width):(i.width=e||0,i.height=t||0),i}return p(n,Fr),l(n,null,[{key:"lerp",value:function(e,t,i,n){var r=e.width,a=e.height;return n.width=r+(t.width-r)*i,n.height=a+(t.height-a)*i,n}},{key:"ZERO",get:function(){return new n(0,0)}}]),l(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e){this.width=e.width,this.height=e.height}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerpSelf",value:function(e,t){return n.lerp(this,e,t,this)}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}();Yi.fastDefine("cc.Size",zr,{width:0,height:0}),cc.size=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return new zr(e,t)},cc.Size=zr;var Ur=function(e){function a(e,t,i,n){var r;return y(this,a),(r=T(this,S(a).call(this))).x=void 0,r.y=void 0,r.width=void 0,r.height=void 0,e&&"object"===ye(e)?(r.y=e.y,r.width=e.width,r.height=e.height,r.x=e.x):(r.x=e||0,r.y=t||0,r.width=i||0,r.height=n||0),r}return p(a,Fr),l(a,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Lr(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new cc.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new zr(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}}],[{key:"fromMinMax",value:function(e,t){var i=Math.min(e.x,t.x),n=Math.min(e.y,t.y);return new a(i,n,Math.max(e.x,t.x)-i,Math.max(e.y,t.y)-n)}},{key:"lerp",value:function(e,t,i,n){var r=e.x,a=e.y,s=e.width,o=e.height;return n.x=r+(t.x-r)*i,n.y=a+(t.y-a)*i,n.width=s+(t.width-s)*i,n.height=o+(t.height-o)*i,n}}]),l(a,[{key:"clone",value:function(){return new a(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerpSelf",value:function(e,t){return a.lerp(this,e,t,this)}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"intersection",value:function(e,t){var i=this.x,n=this.y,r=this.x+this.width,a=this.y+this.height,s=t.x,o=t.y,l=t.x+t.width,c=t.y+t.height;return e.x=Math.max(i,s),e.y=Math.max(n,o),e.width=Math.min(r,l)-e.x,e.height=Math.min(a,c)-e.y,e}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"union",value:function(e,t){var i=this.x,n=this.y,r=this.width,a=this.height,s=t.x,o=t.y,l=t.width,c=t.height;return e.x=Math.min(i,s),e.y=Math.min(n,o),e.width=Math.max(i+r,s+l)-e.x,e.height=Math.max(n+a,o+c)-e.y,e}},{key:"transformMat4",value:function(e,t){var i=this.x,n=this.y,r=i+this.width,a=n+this.height,s=t.m00*i+t.m04*n+t.m12,o=t.m01*i+t.m05*n+t.m13,l=t.m00*r+t.m04*n+t.m12,c=t.m01*r+t.m05*n+t.m13,u=t.m00*i+t.m04*a+t.m12,h=t.m01*i+t.m05*a+t.m13,d=t.m00*r+t.m04*a+t.m12,f=t.m01*r+t.m05*a+t.m13,p=Math.min(s,l,u,d),_=Math.max(s,l,u,d),v=Math.min(o,c,h,f),m=Math.max(o,c,h,f);return e.x=p,e.y=v,e.width=_-p,e.height=m-v,e}}]),a}();function Gr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;return new Ur(e,t,i,n)}Yi.fastDefine("cc.Rect",Ur,{x:0,y:0,width:0,height:0}),cc.Rect=Ur,cc.rect=Gr;var Vr=1/255,Hr=function(e){function s(e,t,i,n){var r;return y(this,s),(r=T(this,S(s).call(this)))._val=void 0,"object"===ye(e)&&(t=e.g,i=e.b,n=e.a,e=e.r),e=e||0,t=t||0,i=i||0,n="number"==typeof n?n:255,r._val=(n<<24>>>0)+(i<<16)+(t<<8)+e,r}return p(s,Fr),l(s,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~cc.misc.clampf(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~cc.misc.clampf(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~cc.misc.clampf(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~cc.misc.clampf(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*Vr},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*Vr},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*Vr},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*Vr},set:function(e){this.a=255*e}}],[{key:"lerp",value:function(e,t,i,n){var r=e.r,a=e.g,s=e.b,o=e.a;return r+=(t.r-r)*i,a+=(t.g-a)*i,s+=(t.b-s)*i,o+=(t.a-o)*i,n._val=Math.floor((o<<24>>>0)+(s<<16)+(a<<8)+r),n}},{key:"WHITE",get:function(){return new s(255,255,255,255)}},{key:"BLACK",get:function(){return new s(0,0,0,255)}},{key:"TRANSPARENT",get:function(){return new s(0,0,0,0)}},{key:"GRAY",get:function(){return new s(127.5,127.5,127.5,255)}},{key:"RED",get:function(){return new s(255,0,0,255)}},{key:"GREEN",get:function(){return new s(0,255,0,255)}},{key:"BLUE",get:function(){return new s(0,0,255,255)}},{key:"YELLOW",get:function(){return new s(255,235,4,255)}},{key:"ORANGE",get:function(){return new s(255,127,0,255)}},{key:"CYAN",get:function(){return new s(0,255,255,255)}},{key:"MAGENTA",get:function(){return new s(255,0,255,255)}}]),l(s,[{key:"clone",value:function(){var e=new s;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerpSelf",value:function(e,t){return s.lerp(this,e,t,this)}},{key:"lerp",value:function(e,t,i){var n=this.r,r=this.g,a=this.b,s=this.a;return n+=(e.r-n)*t,r+=(e.g-r)*t,a+=(e.b-a)*t,s+=(e.a-s)*t,i._val=Math.floor((s<<24>>>0)+(a<<16)+(r<<8)+n),i}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*Vr).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16)||255;return this._val=(r<<24>>>0)+(n<<16)+(i<<8)+t,this}},{key:"toHEX",value:function(e){var t=[(0|this.r).toString(16),(0|this.g).toString(16),(0|this.b).toString(16)],i=-1;if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else if("#rrggbbaa"===e)for(t.push((0|this.a).toString(16)),i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){var n=0,r=0,a=0;if(0===t)n=r=a=i;else if(0===i)n=r=a=0;else{1===e&&(e=0),e*=6,t=t,i=i;var s=Math.floor(e),o=e-s,l=i*(1-t),c=i*(1-t*o),u=i*(1-t*(1-o));switch(s){case 0:n=i,r=u,a=l;break;case 1:n=c,r=i,a=l;break;case 2:n=l,r=i,a=u;break;case 3:n=l,r=c,a=i;break;case 4:n=u,r=l,a=i;break;case 5:n=i,r=l,a=c}}return n*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+n,this}},{key:"toHSV",value:function(){var e=this.r*Vr,t=this.g*Vr,i=this.b*Vr,n={h:0,s:0,v:0},r=Math.max(e,t,i),a=Math.min(e,t,i),s=0;return n.v=r,n.s=r?(r-a)/r:0,n.s?(s=r-a,n.h=e===r?(t-i)/s:t===r?2+(i-e)/s:4+(e-t)/s,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}},{key:"set",value:function(e){e._val?this._val=e._val:this._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r}},{key:"mulSelf",value:function(e){var t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&n|65280&i|255&t,this}},{key:"mul",value:function(e,t){t=t||new s;var i=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,r=(16711680&this._val)*e.b>>8,a=((4278190080&this._val)>>>8)*e.a;return t._val=4278190080&a|16711680&r|65280&n|255&i,t}},{key:"_set_r_unsafe",value:function(e){this._val=(4294967040&this._val|e)>>>0}},{key:"_set_g_unsafe",value:function(e){this._val=(4294902015&this._val|e<<8)>>>0}},{key:"_set_b_unsafe",value:function(e){this._val=(4278255615&this._val|e<<16)>>>0}},{key:"_set_a_unsafe",value:function(e){this._val=(16777215&this._val|e<<24>>>0)>>>0}}]),s}();Yi.fastDefine("cc.Color",Hr,{r:0,g:0,b:0,a:255}),cc.color=function(e,t,i,n){return"string"!=typeof e?"object"===ye(e)?new Hr(e.r,e.g,e.b,e.a):new Hr(e,t,i,n):(new Hr).fromHEX(e)},cc.Color=Hr;var Wr,Xr,jr,qr;(Xr=Wr||(Wr={}))[Xr.UNKNOWN=0]="UNKNOWN",Xr[Xr.BUFFER=1]="BUFFER",Xr[Xr.TEXTURE=2]="TEXTURE",Xr[Xr.TEXTURE_VIEW=3]="TEXTURE_VIEW",Xr[Xr.RENDER_PASS=4]="RENDER_PASS",Xr[Xr.FRAMEBUFFER=5]="FRAMEBUFFER",Xr[Xr.SAMPLER=6]="SAMPLER",Xr[Xr.SHADER=7]="SHADER",Xr[Xr.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",Xr[Xr.PIPELINE_STATE=9]="PIPELINE_STATE",Xr[Xr.BINDING_LAYOUT=10]="BINDING_LAYOUT",Xr[Xr.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",Xr[Xr.COMMAND_ALLOCATOR=12]="COMMAND_ALLOCATOR",Xr[Xr.COMMAND_BUFFER=13]="COMMAND_BUFFER",Xr[Xr.QUEUE=14]="QUEUE",Xr[Xr.WINDOW=15]="WINDOW",(qr=jr||(jr={}))[qr.UNREADY=0]="UNREADY",qr[qr.FAILED=1]="FAILED",qr[qr.SUCCESS=2]="SUCCESS";var Yr,Kr,Qr,Zr,Jr,$r,ea,ta,ia,na,ra,aa,sa,oa,la,ca,ua,ha,da,fa,pa,_a,va,ma,ya,ga,ba,Sa,Ta,Ea,xa,Aa,Ca,wa,Ra,ka,Oa,Fa,La,Ba,Ma,Ia,Pa,Da,Na,za,Ua,Ga,Va,Ha,Wa,Xa,ja,qa,Ya,Ka,Qa,Za,Ja,$a,es,ts,is,ns=function(){function t(e){y(this,t),this._gfxType=Wr.UNKNOWN,this._status=jr.UNREADY,this._gfxType=e}return l(t,[{key:"gfxType",get:function(){return this._gfxType}},{key:"status",get:function(){return this._status}}]),t}();(Yr=Kt.GFXAttributeName||(Kt.GFXAttributeName={})).ATTR_POSITION="a_position",Yr.ATTR_NORMAL="a_normal",Yr.ATTR_TANGENT="a_tangent",Yr.ATTR_BITANGENT="a_bitangent",Yr.ATTR_WEIGHTS="a_weights",Yr.ATTR_JOINTS="a_joints",Yr.ATTR_COLOR="a_color",Yr.ATTR_COLOR1="a_color1",Yr.ATTR_COLOR2="a_color2",Yr.ATTR_TEX_COORD="a_texCoord",Yr.ATTR_TEX_COORD1="a_texCoord1",Yr.ATTR_TEX_COORD2="a_texCoord2",Yr.ATTR_TEX_COORD3="a_texCoord3",Yr.ATTR_TEX_COORD4="a_texCoord4",Yr.ATTR_TEX_COORD5="a_texCoord5",Yr.ATTR_TEX_COORD6="a_texCoord6",Yr.ATTR_TEX_COORD7="a_texCoord7",Yr.ATTR_TEX_COORD8="a_texCoord8",Yr.ATTR_BATCH_ID="a_batch_id",Yr.ATTR_BATCH_UV="a_batch_uv",(Qr=Kr||(Kr={}))[Qr.UNKNOWN=0]="UNKNOWN",Qr[Qr.BOOL=1]="BOOL",Qr[Qr.BOOL2=2]="BOOL2",Qr[Qr.BOOL3=3]="BOOL3",Qr[Qr.BOOL4=4]="BOOL4",Qr[Qr.INT=5]="INT",Qr[Qr.INT2=6]="INT2",Qr[Qr.INT3=7]="INT3",Qr[Qr.INT4=8]="INT4",Qr[Qr.UINT=9]="UINT",Qr[Qr.UINT2=10]="UINT2",Qr[Qr.UINT3=11]="UINT3",Qr[Qr.UINT4=12]="UINT4",Qr[Qr.FLOAT=13]="FLOAT",Qr[Qr.FLOAT2=14]="FLOAT2",Qr[Qr.FLOAT3=15]="FLOAT3",Qr[Qr.FLOAT4=16]="FLOAT4",Qr[Qr.MAT2=17]="MAT2",Qr[Qr.MAT2X3=18]="MAT2X3",Qr[Qr.MAT2X4=19]="MAT2X4",Qr[Qr.MAT3X2=20]="MAT3X2",Qr[Qr.MAT3=21]="MAT3",Qr[Qr.MAT3X4=22]="MAT3X4",Qr[Qr.MAT4X2=23]="MAT4X2",Qr[Qr.MAT4X3=24]="MAT4X3",Qr[Qr.MAT4=25]="MAT4",Qr[Qr.SAMPLER1D=26]="SAMPLER1D",Qr[Qr.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",Qr[Qr.SAMPLER2D=28]="SAMPLER2D",Qr[Qr.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",Qr[Qr.SAMPLER3D=30]="SAMPLER3D",Qr[Qr.SAMPLER_CUBE=31]="SAMPLER_CUBE",Qr[Qr.COUNT=32]="COUNT",(Zr=Kt.GFXFormat||(Kt.GFXFormat={}))[Zr.UNKNOWN=0]="UNKNOWN",Zr[Zr.A8=1]="A8",Zr[Zr.L8=2]="L8",Zr[Zr.LA8=3]="LA8",Zr[Zr.R8=4]="R8",Zr[Zr.R8SN=5]="R8SN",Zr[Zr.R8UI=6]="R8UI",Zr[Zr.R8I=7]="R8I",Zr[Zr.R16F=8]="R16F",Zr[Zr.R16UI=9]="R16UI",Zr[Zr.R16I=10]="R16I",Zr[Zr.R32F=11]="R32F",Zr[Zr.R32UI=12]="R32UI",Zr[Zr.R32I=13]="R32I",Zr[Zr.RG8=14]="RG8",Zr[Zr.RG8SN=15]="RG8SN",Zr[Zr.RG8UI=16]="RG8UI",Zr[Zr.RG8I=17]="RG8I",Zr[Zr.RG16F=18]="RG16F",Zr[Zr.RG16UI=19]="RG16UI",Zr[Zr.RG16I=20]="RG16I",Zr[Zr.RG32F=21]="RG32F",Zr[Zr.RG32UI=22]="RG32UI",Zr[Zr.RG32I=23]="RG32I",Zr[Zr.RGB8=24]="RGB8",Zr[Zr.SRGB8=25]="SRGB8",Zr[Zr.RGB8SN=26]="RGB8SN",Zr[Zr.RGB8UI=27]="RGB8UI",Zr[Zr.RGB8I=28]="RGB8I",Zr[Zr.RGB16F=29]="RGB16F",Zr[Zr.RGB16UI=30]="RGB16UI",Zr[Zr.RGB16I=31]="RGB16I",Zr[Zr.RGB32F=32]="RGB32F",Zr[Zr.RGB32UI=33]="RGB32UI",Zr[Zr.RGB32I=34]="RGB32I",Zr[Zr.RGBA8=35]="RGBA8",Zr[Zr.SRGB8_A8=36]="SRGB8_A8",Zr[Zr.RGBA8SN=37]="RGBA8SN",Zr[Zr.RGBA8UI=38]="RGBA8UI",Zr[Zr.RGBA8I=39]="RGBA8I",Zr[Zr.RGBA16F=40]="RGBA16F",Zr[Zr.RGBA16UI=41]="RGBA16UI",Zr[Zr.RGBA16I=42]="RGBA16I",Zr[Zr.RGBA32F=43]="RGBA32F",Zr[Zr.RGBA32UI=44]="RGBA32UI",Zr[Zr.RGBA32I=45]="RGBA32I",Zr[Zr.R5G6B5=46]="R5G6B5",Zr[Zr.R11G11B10F=47]="R11G11B10F",Zr[Zr.RGB5A1=48]="RGB5A1",Zr[Zr.RGBA4=49]="RGBA4",Zr[Zr.RGB10A2=50]="RGB10A2",Zr[Zr.RGB10A2UI=51]="RGB10A2UI",Zr[Zr.RGB9E5=52]="RGB9E5",Zr[Zr.D16=53]="D16",Zr[Zr.D16S8=54]="D16S8",Zr[Zr.D24=55]="D24",Zr[Zr.D24S8=56]="D24S8",Zr[Zr.D32F=57]="D32F",Zr[Zr.D32F_S8=58]="D32F_S8",Zr[Zr.BC1=59]="BC1",Zr[Zr.BC1_ALPHA=60]="BC1_ALPHA",Zr[Zr.BC1_SRGB=61]="BC1_SRGB",Zr[Zr.BC1_SRGB_ALPHA=62]="BC1_SRGB_ALPHA",Zr[Zr.BC2=63]="BC2",Zr[Zr.BC2_SRGB=64]="BC2_SRGB",Zr[Zr.BC3=65]="BC3",Zr[Zr.BC3_SRGB=66]="BC3_SRGB",Zr[Zr.BC4=67]="BC4",Zr[Zr.BC4_SNORM=68]="BC4_SNORM",Zr[Zr.BC5=69]="BC5",Zr[Zr.BC5_SNORM=70]="BC5_SNORM",Zr[Zr.BC6H_UF16=71]="BC6H_UF16",Zr[Zr.BC6H_SF16=72]="BC6H_SF16",Zr[Zr.BC7=73]="BC7",Zr[Zr.BC7_SRGB=74]="BC7_SRGB",Zr[Zr.ETC_RGB8=75]="ETC_RGB8",Zr[Zr.ETC2_RGB8=76]="ETC2_RGB8",Zr[Zr.ETC2_SRGB8=77]="ETC2_SRGB8",Zr[Zr.ETC2_RGB8_A1=78]="ETC2_RGB8_A1",Zr[Zr.ETC2_SRGB8_A1=79]="ETC2_SRGB8_A1",Zr[Zr.ETC2_RGBA8=80]="ETC2_RGBA8",Zr[Zr.ETC2_SRGB8_A8=81]="ETC2_SRGB8_A8",Zr[Zr.EAC_R11=82]="EAC_R11",Zr[Zr.EAC_R11SN=83]="EAC_R11SN",Zr[Zr.EAC_RG11=84]="EAC_RG11",Zr[Zr.EAC_RG11SN=85]="EAC_RG11SN",Zr[Zr.PVRTC_RGB2=86]="PVRTC_RGB2",Zr[Zr.PVRTC_RGBA2=87]="PVRTC_RGBA2",Zr[Zr.PVRTC_RGB4=88]="PVRTC_RGB4",Zr[Zr.PVRTC_RGBA4=89]="PVRTC_RGBA4",Zr[Zr.PVRTC2_2BPP=90]="PVRTC2_2BPP",Zr[Zr.PVRTC2_4BPP=91]="PVRTC2_4BPP",($r=Jr||(Jr={}))[$r.NONE=0]="NONE",$r[$r.TRANSFER_SRC=1]="TRANSFER_SRC",$r[$r.TRANSFER_DST=2]="TRANSFER_DST",$r[$r.INDEX=4]="INDEX",$r[$r.VERTEX=8]="VERTEX",$r[$r.UNIFORM=16]="UNIFORM",$r[$r.STORAGE=32]="STORAGE",$r[$r.INDIRECT=64]="INDIRECT",(ta=ea||(ea={}))[ta.NONE=0]="NONE",ta[ta.DEVICE=1]="DEVICE",ta[ta.HOST=2]="HOST",(na=ia||(ia={}))[na.NONE=0]="NONE",na[na.READ=1]="READ",na[na.WRITE=2]="WRITE",(ra=Kt.GFXPrimitiveMode||(Kt.GFXPrimitiveMode={}))[ra.POINT_LIST=0]="POINT_LIST",ra[ra.LINE_LIST=1]="LINE_LIST",ra[ra.LINE_STRIP=2]="LINE_STRIP",ra[ra.LINE_LOOP=3]="LINE_LOOP",ra[ra.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",ra[ra.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",ra[ra.ISO_LINE_LIST=6]="ISO_LINE_LIST",ra[ra.TRIANGLE_LIST=7]="TRIANGLE_LIST",ra[ra.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",ra[ra.TRIANGLE_FAN=9]="TRIANGLE_FAN",ra[ra.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",ra[ra.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",ra[ra.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",ra[ra.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST",(sa=aa||(aa={}))[sa.FILL=0]="FILL",sa[sa.POINT=1]="POINT",sa[sa.LINE=2]="LINE",(la=oa||(oa={}))[la.GOURAND=0]="GOURAND",la[la.FLAT=1]="FLAT",(ua=ca||(ca={}))[ua.NONE=0]="NONE",ua[ua.FRONT=1]="FRONT",ua[ua.BACK=2]="BACK",(da=ha||(ha={}))[da.NEVER=0]="NEVER",da[da.LESS=1]="LESS",da[da.EQUAL=2]="EQUAL",da[da.LESS_EQUAL=3]="LESS_EQUAL",da[da.GREATER=4]="GREATER",da[da.NOT_EQUAL=5]="NOT_EQUAL",da[da.GREATER_EQUAL=6]="GREATER_EQUAL",da[da.ALWAYS=7]="ALWAYS",(pa=fa||(fa={}))[pa.ZERO=0]="ZERO",pa[pa.KEEP=1]="KEEP",pa[pa.REPLACE=2]="REPLACE",pa[pa.INCR=3]="INCR",pa[pa.DECR=4]="DECR",pa[pa.INVERT=5]="INVERT",pa[pa.INCR_WRAP=6]="INCR_WRAP",pa[pa.DECR_WRAP=7]="DECR_WRAP",(va=_a||(_a={}))[va.ADD=0]="ADD",va[va.SUB=1]="SUB",va[va.REV_SUB=2]="REV_SUB",va[va.MIN=3]="MIN",va[va.MAX=4]="MAX",(ya=ma||(ma={}))[ya.ZERO=0]="ZERO",ya[ya.ONE=1]="ONE",ya[ya.SRC_ALPHA=2]="SRC_ALPHA",ya[ya.DST_ALPHA=3]="DST_ALPHA",ya[ya.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",ya[ya.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",ya[ya.SRC_COLOR=6]="SRC_COLOR",ya[ya.DST_COLOR=7]="DST_COLOR",ya[ya.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",ya[ya.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",ya[ya.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",ya[ya.CONSTANT_COLOR=11]="CONSTANT_COLOR",ya[ya.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",ya[ya.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",ya[ya.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA",(ba=ga||(ga={}))[ba.NONE=0]="NONE",ba[ba.R=1]="R",ba[ba.G=2]="G",ba[ba.B=4]="B",ba[ba.A=8]="A",ba[ba.ALL=15]="ALL",(Ta=Sa||(Sa={}))[Ta.NONE=0]="NONE",Ta[Ta.POINT=1]="POINT",Ta[Ta.LINEAR=2]="LINEAR",Ta[Ta.ANISOTROPIC=3]="ANISOTROPIC",(xa=Ea||(Ea={}))[xa.WRAP=0]="WRAP",xa[xa.MIRROR=1]="MIRROR",xa[xa.CLAMP=2]="CLAMP",xa[xa.BORDER=3]="BORDER",(Ca=Aa||(Aa={}))[Ca.TEX1D=0]="TEX1D",Ca[Ca.TEX2D=1]="TEX2D",Ca[Ca.TEX3D=2]="TEX3D",(Ra=wa||(wa={}))[Ra.NONE=0]="NONE",Ra[Ra.TRANSFER_SRC=1]="TRANSFER_SRC",Ra[Ra.TRANSFER_DST=2]="TRANSFER_DST",Ra[Ra.SAMPLED=4]="SAMPLED",Ra[Ra.STORAGE=8]="STORAGE",Ra[Ra.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",Ra[Ra.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",Ra[Ra.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",Ra[Ra.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT",(Oa=ka||(ka={}))[Oa.X1=0]="X1",Oa[Oa.X2=1]="X2",Oa[Oa.X4=2]="X4",Oa[Oa.X8=3]="X8",Oa[Oa.X16=4]="X16",Oa[Oa.X32=5]="X32",Oa[Oa.X64=6]="X64",(La=Fa||(Fa={}))[La.NONE=0]="NONE",La[La.GEN_MIPMAP=1]="GEN_MIPMAP",La[La.CUBEMAP=2]="CUBEMAP",La[La.BAKUP_BUFFER=4]="BAKUP_BUFFER",(Ma=Ba||(Ba={}))[Ma.TV1D=0]="TV1D",Ma[Ma.TV2D=1]="TV2D",Ma[Ma.TV3D=2]="TV3D",Ma[Ma.CUBE=3]="CUBE",Ma[Ma.TV1D_ARRAY=4]="TV1D_ARRAY",Ma[Ma.TV2D_ARRAY=5]="TV2D_ARRAY",(Pa=Ia||(Ia={}))[Pa.VERTEX=0]="VERTEX",Pa[Pa.HULL=1]="HULL",Pa[Pa.DOMAIN=2]="DOMAIN",Pa[Pa.GEOMETRY=3]="GEOMETRY",Pa[Pa.FRAGMENT=4]="FRAGMENT",Pa[Pa.COMPUTE=5]="COMPUTE",Pa[Pa.COUNT=6]="COUNT",(Na=Da||(Da={}))[Na.UNKNOWN=0]="UNKNOWN",Na[Na.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",Na[Na.SAMPLER=2]="SAMPLER",Na[Na.STORAGE_BUFFER=3]="STORAGE_BUFFER",(Ua=za||(za={}))[Ua.PRIMARY=0]="PRIMARY",Ua[Ua.SECONDARY=1]="SECONDARY",(Va=Ga||(Ga={}))[Va.LOAD=0]="LOAD",Va[Va.CLEAR=1]="CLEAR",Va[Va.DISCARD=2]="DISCARD",(Wa=Ha||(Ha={}))[Wa.STORE=0]="STORE",Wa[Wa.DISCARD=1]="DISCARD",(ja=Xa||(Xa={}))[ja.UNDEFINED=0]="UNDEFINED",ja[ja.GENERAL=1]="GENERAL",ja[ja.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",ja[ja.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",ja[ja.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",ja[ja.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",ja[ja.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",ja[ja.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",ja[ja.PREINITIALIZED=8]="PREINITIALIZED",ja[ja.PRESENT_SRC=9]="PRESENT_SRC",(Ya=qa||(qa={}))[Ya.GRAPHICS=0]="GRAPHICS",Ya[Ya.COMPUTE=1]="COMPUTE",Ya[Ya.RAY_TRACING=2]="RAY_TRACING",(Qa=Ka||(Ka={}))[Qa.VIEWPORT=0]="VIEWPORT",Qa[Qa.SCISSOR=1]="SCISSOR",Qa[Qa.LINE_WIDTH=2]="LINE_WIDTH",Qa[Qa.DEPTH_BIAS=3]="DEPTH_BIAS",Qa[Qa.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",Qa[Qa.DEPTH_BOUNDS=5]="DEPTH_BOUNDS",Qa[Qa.STENCIL_WRITE_MASK=6]="STENCIL_WRITE_MASK",Qa[Qa.STENCIL_COMPARE_MASK=7]="STENCIL_COMPARE_MASK",(Ja=Za||(Za={}))[Ja.FRONT=0]="FRONT",Ja[Ja.BACK=1]="BACK",Ja[Ja.ALL=2]="ALL",(es=$a||($a={}))[es.GRAPHICS=0]="GRAPHICS",es[es.COMPUTE=1]="COMPUTE",es[es.TRANSFER=2]="TRANSFER",(is=ts||(ts={}))[is.NONE=0]="NONE",is[is.COLOR=1]="COLOR",is[is.DEPTH=2]="DEPTH",is[is.STENCIL=4]="STENCIL",is[is.DEPTH_STENCIL=6]="DEPTH_STENCIL",is[is.ALL=7]="ALL";var rs,as,ss=function e(){y(this,e),this.baseMipLevel=0,this.levelCount=1,this.baseArrayLayer=0,this.layerCount=1},os=function e(){y(this,e),this.buffOffset=0,this.buffStride=0,this.buffTexHeight=0,this.texOffset={x:0,y:0,z:0},this.texExtent={width:0,height:0,depth:0},this.texSubres=new ss};(as=rs||(rs={}))[as.NONE=0]="NONE",as[as.UNORM=1]="UNORM",as[as.SNORM=2]="SNORM",as[as.UINT=3]="UINT",as[as.INT=4]="INT",as[as.UFLOAT=5]="UFLOAT",as[as.FLOAT=6]="FLOAT";var ls=[{name:"UNKNOWN",size:0,count:0,type:rs.NONE,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"A8",size:1,count:1,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"L8",size:1,count:1,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"LA8",size:1,count:2,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8",size:1,count:1,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8SN",size:1,count:1,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8UI",size:1,count:1,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R8I",size:1,count:1,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16F",size:2,count:1,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16UI",size:2,count:1,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R16I",size:2,count:1,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32F",size:4,count:1,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32UI",size:4,count:1,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R32I",size:4,count:1,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8",size:2,count:2,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8SN",size:2,count:2,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8UI",size:2,count:2,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG8I",size:2,count:2,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16F",size:4,count:2,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16UI",size:4,count:2,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG16I",size:4,count:2,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32F",size:8,count:2,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32UI",size:8,count:2,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RG32I",size:8,count:2,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8",size:3,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8",size:3,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8SN",size:3,count:3,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8UI",size:3,count:3,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB8I",size:3,count:3,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16F",size:6,count:3,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16UI",size:6,count:3,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB16I",size:6,count:3,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32F",size:12,count:3,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32UI",size:12,count:3,type:rs.UINT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB32I",size:12,count:3,type:rs.INT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8",size:4,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"SRGB8_A8",size:4,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8SN",size:4,count:4,type:rs.SNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8UI",size:4,count:4,type:rs.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA8I",size:4,count:4,type:rs.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16F",size:8,count:4,type:rs.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16UI",size:8,count:4,type:rs.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA16I",size:8,count:4,type:rs.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32F",size:16,count:4,type:rs.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32UI",size:16,count:4,type:rs.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA32I",size:16,count:4,type:rs.INT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R5G6B5",size:2,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"R11G11B10F",size:4,count:3,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB5A1",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGBA4",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB10A2UI",size:2,count:4,type:rs.UINT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"RGB9E5",size:2,count:4,type:rs.FLOAT,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!1},{name:"D16",size:2,count:1,type:rs.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D16S8",size:3,count:2,type:rs.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D24",size:3,count:1,type:rs.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D24S8",size:4,count:2,type:rs.UINT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"D32F",size:4,count:1,type:rs.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!1,isCompressed:!1},{name:"D32FS8",size:5,count:2,type:rs.FLOAT,hasAlpha:!1,hasDepth:!0,hasStencil:!0,isCompressed:!1},{name:"BC1",size:1,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_ALPHA",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB",size:1,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC1_SRGB_ALPHA",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC2_SRGB",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC3_SRGB",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4",size:1,count:1,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC4_SNORM",size:1,count:1,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5",size:1,count:2,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC5_SNORM",size:1,count:2,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_UF16",size:1,count:3,type:rs.UFLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC6H_SF16",size:1,count:3,type:rs.FLOAT,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"BC7_SRGB",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC_RGB8",size:1,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8",size:1,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8",size:1,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGB8_A1",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A1",size:1,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_RGBA8",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"ETC2_SRGB8_A8",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11",size:1,count:1,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_R11SN",size:1,count:1,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11",size:2,count:2,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"EAC_RG11SN",size:2,count:2,type:rs.SNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB2",size:2,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA2",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGB4",size:2,count:3,type:rs.UNORM,hasAlpha:!1,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC_RGBA4",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_2BPP",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0},{name:"PVRTC2_4BPP",size:2,count:4,type:rs.UNORM,hasAlpha:!0,hasDepth:!1,hasStencil:!1,isCompressed:!0}];function cs(e,t,i,n){if(!ls[e].isCompressed)return t*i*n*ls[e].size;switch(e){case Kt.GFXFormat.BC1:case Kt.GFXFormat.BC1_ALPHA:case Kt.GFXFormat.BC1_SRGB:case Kt.GFXFormat.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Kt.GFXFormat.BC2:case Kt.GFXFormat.BC2_SRGB:case Kt.GFXFormat.BC3:case Kt.GFXFormat.BC3_SRGB:case Kt.GFXFormat.BC4:case Kt.GFXFormat.BC4_SNORM:case Kt.GFXFormat.BC6H_SF16:case Kt.GFXFormat.BC6H_UF16:case Kt.GFXFormat.BC7:case Kt.GFXFormat.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Kt.GFXFormat.BC5:case Kt.GFXFormat.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case Kt.GFXFormat.ETC_RGB8:case Kt.GFXFormat.ETC2_RGB8:case Kt.GFXFormat.ETC2_SRGB8:case Kt.GFXFormat.ETC2_RGB8_A1:case Kt.GFXFormat.ETC2_SRGB8_A1:case Kt.GFXFormat.EAC_R11:case Kt.GFXFormat.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case Kt.GFXFormat.EAC_RG11:case Kt.GFXFormat.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case Kt.GFXFormat.PVRTC_RGB2:case Kt.GFXFormat.PVRTC_RGBA2:case Kt.GFXFormat.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case Kt.GFXFormat.PVRTC_RGB4:case Kt.GFXFormat.PVRTC_RGBA4:case Kt.GFXFormat.PVRTC2_4BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/2)*n;default:return 0}}function us(e,t,i,n,r){for(var a=0,s=0;s<r;++s)a+=cs(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1),n=Math.max(n>>1,1);return a}function hs(e){switch(e){case Kr.BOOL:case Kr.INT:case Kr.UINT:case Kr.FLOAT:return 4;case Kr.BOOL2:case Kr.INT2:case Kr.UINT2:case Kr.FLOAT2:return 8;case Kr.BOOL3:case Kr.INT3:case Kr.UINT3:case Kr.FLOAT3:return 12;case Kr.BOOL4:case Kr.INT4:case Kr.UINT4:case Kr.FLOAT4:case Kr.MAT2:return 16;case Kr.MAT2X3:return 24;case Kr.MAT2X4:return 32;case Kr.MAT3X2:return 24;case Kr.MAT3:return 36;case Kr.MAT3X4:return 48;case Kr.MAT4X2:case Kr.MAT4X2:return 32;case Kr.MAT4:return 64;case Kr.SAMPLER1D:case Kr.SAMPLER1D_ARRAY:case Kr.SAMPLER2D:case Kr.SAMPLER2D_ARRAY:case Kr.SAMPLER3D:case Kr.SAMPLER_CUBE:return 4;default:return 0}}var ds,fs,ps,_s,vs=Object.freeze({GFX_MAX_VERTEX_ATTRIBUTES:16,GFX_MAX_TEXTURE_UNITS:16,GFX_MAX_ATTACHMENTS:4,GFX_MAX_BUFFER_BINDINGS:24,get GFXObjectType(){return Wr},get GFXStatus(){return jr},GFXObject:ns,get GFXAttributeName(){return Kt.GFXAttributeName},get GFXType(){return Kr},get GFXFormat(){return Kt.GFXFormat},get GFXBufferUsageBit(){return Jr},get GFXMemoryUsageBit(){return ea},get GFXBufferAccessBit(){return ia},get GFXPrimitiveMode(){return Kt.GFXPrimitiveMode},get GFXPolygonMode(){return aa},get GFXShadeModel(){return oa},get GFXCullMode(){return ca},get GFXComparisonFunc(){return ha},get GFXStencilOp(){return fa},get GFXBlendOp(){return _a},get GFXBlendFactor(){return ma},get GFXColorMask(){return ga},get GFXFilter(){return Sa},get GFXAddress(){return Ea},get GFXTextureType(){return Aa},get GFXTextureUsageBit(){return wa},get GFXSampleCount(){return ka},get GFXTextureFlagBit(){return Fa},get GFXTextureViewType(){return Ba},get GFXShaderType(){return Ia},get GFXBindingType(){return Da},get GFXCommandBufferType(){return za},get GFXLoadOp(){return Ga},get GFXStoreOp(){return Ha},get GFXTextureLayout(){return Xa},get GFXPipelineBindPoint(){return qa},get GFXDynamicState(){return Ka},get GFXStencilFace(){return Za},get GFXQueueType(){return $a},get GFXClearFlag(){return ts},GFXTextureSubres:ss,GFXTextureCopy:function e(){y(this,e),this.srcSubres=new ss,this.srcOffset={x:0,y:0,z:0},this.dstSubres=new ss,this.dstOffset={x:0,y:0,z:0},this.extent={width:0,height:0,depth:0}},GFXBufferTextureCopy:os,get GFXFormatType(){return rs},GFXFormatInfos:ls,GFXFormatSize:cs,GFXFormatSurfaceSize:us,GFXGetTypeSize:hs});si(Kt.GFXFormat),(fs=ds||(ds={}))[fs.UNKNOWN=0]="UNKNOWN",fs[fs.WEBGL=1]="WEBGL",fs[fs.WEBGL2=2]="WEBGL2",(_s=ps||(ps={}))[_s.COLOR_FLOAT=0]="COLOR_FLOAT",_s[_s.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",_s[_s.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",_s[_s.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",_s[_s.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",_s[_s.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",_s[_s.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",_s[_s.FORMAT_D24S8=7]="FORMAT_D24S8",_s[_s.FORMAT_ETC1=8]="FORMAT_ETC1",_s[_s.FORMAT_ETC2=9]="FORMAT_ETC2",_s[_s.FORMAT_DXT=10]="FORMAT_DXT",_s[_s.FORMAT_PVRTC=11]="FORMAT_PVRTC",_s[_s.MSAA=12]="MSAA",_s[_s.COUNT=13]="COUNT";var ms,ys,gs,bs,Ss,Ts,Es,xs,As,Cs,ws,Rs,ks=function(){function e(){y(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=ds.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(ps.COUNT),this._queue=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._mainWindow=null,this._cmdAllocator=null,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=24,this._maxUniformBlockSize=0,this._depthBits=0,this._stencilBits=0,this._colorFmt=Kt.GFXFormat.UNKNOWN,this._depthStencilFmt=Kt.GFXFormat.UNKNOWN,this._shaderIdGen=0,this._macros=new Map,this._numDrawCalls=0,this._numTris=0}return l(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"genShaderId",value:function(){return this._shaderIdGen++}},{key:"defineMacro",value:function(e,t){var i=void 0!==t?t:"";this._macros.set(e,i)}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"commandAllocator",get:function(){return this._cmdAllocator}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),e}();(ys=ms||(ms={}))[ys.RGB565=Kt.GFXFormat.R5G6B5]="RGB565",ys[ys.RGB5A1=Kt.GFXFormat.RGB5A1]="RGB5A1",ys[ys.RGBA4444=Kt.GFXFormat.RGBA4]="RGBA4444",ys[ys.RGB888=Kt.GFXFormat.RGB8]="RGB888",ys[ys.RGBA8888=Kt.GFXFormat.RGBA8]="RGBA8888",ys[ys.RGBA32F=Kt.GFXFormat.RGBA32F]="RGBA32F",ys[ys.A8=Kt.GFXFormat.A8]="A8",ys[ys.I8=Kt.GFXFormat.L8]="I8",ys[ys.AI8=Kt.GFXFormat.LA8]="AI8",ys[ys.RGB_PVRTC_2BPPV1=Kt.GFXFormat.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",ys[ys.RGBA_PVRTC_2BPPV1=Kt.GFXFormat.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",ys[ys.RGB_PVRTC_4BPPV1=Kt.GFXFormat.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",ys[ys.RGBA_PVRTC_4BPPV1=Kt.GFXFormat.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",ys[ys.RGB_ETC1=Kt.GFXFormat.ETC_RGB8]="RGB_ETC1",ys[ys.RGB_ETC2=Kt.GFXFormat.ETC2_RGB8]="RGB_ETC2",ys[ys.RGBA_ETC2=Kt.GFXFormat.ETC2_RGBA8]="RGBA_ETC2",(bs=gs||(gs={}))[bs.REPEAT=Ea.WRAP]="REPEAT",bs[bs.CLAMP_TO_EDGE=Ea.CLAMP]="CLAMP_TO_EDGE",bs[bs.MIRRORED_REPEAT=Ea.MIRROR]="MIRRORED_REPEAT",bs[bs.CLAMP_TO_BORDER=Ea.BORDER]="CLAMP_TO_BORDER",(Ts=Ss||(Ss={}))[Ts.NONE=Sa.NONE]="NONE",Ts[Ts.LINEAR=Sa.LINEAR]="LINEAR",Ts[Ts.NEAREST=Sa.POINT]="NEAREST";var Os,Fs,Ls=(Es=un("cc.ImageAsset"),xs=hn({override:!0}),Es((Rs=ws=function(e){function b(e){var t;return y(this,b),(t=T(this,S(b).call(this)))._nativeData=void 0,t._url=void 0,t._exportedExts=void 0,t._format=ms.RGBA8888,t._width=0,t._height=0,t._url="",t.loaded=!1,t._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&(t._nativeAsset=e),t}return p(b,qn),l(b,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){this.reset(e)}},{key:"data",get:function(){return"_data"in this._nativeData?this._nativeData._data:this._nativeData}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=ms.RGB_ETC1&&this._format<=ms.RGBA_PVRTC_4BPPV1}},{key:"url",get:function(){return this._url}}]),l(b,[{key:"reset",value:function(e){var t=this;e instanceof HTMLElement?(this._nativeData=e).complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",function(){t._onDataComplete()}),e.addEventListener("error",function(e){cc.warnID(3119,e.message)})):(this._nativeData=e,this._nativeData.format=this._format,this._onDataComplete())}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";var t=[],i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.split("@"),l=b.extnames.indexOf(o[0]),c=l<0?s:"".concat(l);o[1]&&(c+="@"+o[1]),t.push(c)}return{fmt:t.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,t){var i="";i="string"==typeof e?e:(this._width=e.w,this._height=e.h,e.fmt);var n=cc.director&&cc.director.root?cc.director.root.device:null,r=i.split("_"),a=Number.MAX_VALUE,s=this._format,o="",l=cc.macro.SUPPORT_TEXTURE_FORMATS,c=r,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d.split("@"),p=parseInt(f[0],void 0),_=b.extnames[p]||f.join(),v=l.indexOf(_);if(-1!==v&&v<a){var m=f[1]?parseInt(f[1]):this._format;if(!(".pvr"!==_||n&&n.hasFeature(ps.FORMAT_PVRTC)))continue;if(!(m!==ms.RGB_ETC1||n&&n.hasFeature(ps.FORMAT_ETC1)))continue;if(!(m!==ms.RGB_ETC2&&m!==ms.RGBA_ETC2||n&&n.hasFeature(ps.FORMAT_ETC2)))continue;if(".webp"===_&&!cc.sys.capabilities.webp)continue;a=v,o=_,s=m}}o&&(this._setRawAsset(o),this._format=s);var y=t.customEnv,g=y&&y.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),b}(),ws.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm"],c((Cs=Rs).prototype,"_nativeAsset",[xs],Object.getOwnPropertyDescriptor(Cs.prototype,"_nativeAsset"),Cs.prototype),As=Cs))||As);cc.ImageAsset=Ls,(Fs=Os||(Os={}))[Fs.minFilter=0]="minFilter",Fs[Fs.magFilter=1]="magFilter",Fs[Fs.mipFilter=2]="mipFilter",Fs[Fs.addressU=3]="addressU",Fs[Fs.addressV=4]="addressV",Fs[Fs.addressW=5]="addressW",Fs[Fs.maxAnisotropy=6]="maxAnisotropy",Fs[Fs.cmpFunc=7]="cmpFunc",Fs[Fs.minLOD=8]="minLOD",Fs[Fs.maxLOD=9]="maxLOD",Fs[Fs.mipLODBias=10]="mipLODBias",Fs[Fs.borderColor=11]="borderColor",Fs[Fs.total=15]="total";var Bs=[Sa.LINEAR,Sa.LINEAR,Sa.NONE,Ea.WRAP,Ea.WRAP,Ea.WRAP,16,ha.NEVER,0,0,0,0,0,0,0],Ms={},Is=new(function(){function e(){y(this,e),this._cache={}}return l(e,[{key:"getSampler",value:function(e,t){for(var i="",n=0;n<Bs.length;n++)i+=(t[n]||Bs[n])+",";var r=this._cache[i];if(r)return r;if(Ms.minFilter=t[Os.minFilter],Ms.magFilter=t[Os.magFilter],Ms.mipFilter=t[Os.mipFilter],Ms.addressU=t[Os.addressU],Ms.addressV=t[Os.addressV],Ms.addressW=t[Os.addressW],Ms.maxAnisotropy=t[Os.maxAnisotropy],t.length>Os.cmpFunc&&(Ms.cmpFunc=t[Os.cmpFunc],Ms.minLOD=t[Os.minLOD],Ms.maxLOD=t[Os.maxLOD],Ms.mipLODBias=t[Os.mipLODBias],t.length>=Os.total)){var a=Os.borderColor;Ms.borderColor={r:t[a],g:t[a+1],b:t[a+2],a:t[a+3]}}return this._cache[i]=e.createSampler(Ms)}}]),e}()),Ps={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=cc.loader._getResUuid(e.slice(10),cc.Asset,null,!0);if(t)return cc.AssetLibrary.getLibUrlNoExt(t,!0)+cc.path.extname(e)}else cc.errorID(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=cc.path.stripSep(e)+"/"}};cc.url=Ps;var Ds=0|998*Math.random(),Ns=dt(!0),zs=[],Us={WORKING:1,COMPLETE:2,ERROR:3},Gs=dt(!0);function Vs(e,t){var i="object"===ye(e)?e.url:e,n={queueId:t,id:i,url:i,rawUrl:void 0,urlParam:function(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach(function(e){var t=e.split("=");i[t[0]]=t[1]}),i}}}(i),type:"",error:null,content:null,complete:!1,states:{},deps:null};if("object"===ye(e)&&(Et(n,e),e.skips))for(var r=0;r<e.skips.length;r++){var a=e.skips[r];n.states[a]=Us.COMPLETE}return n.rawUrl=n.url,i&&!n.type&&(n.type=K(i).toLowerCase().substr(1)),n}var Hs=[];function Ws(e,t,i){if(!e||!t)return!1;var n=!1;if(Hs.push(t.id),t.deps){var r,a,s=t.deps;for(r=0;r<s.length;r++){if((a=s[r]).id===e.id){n=!0;break}if(!(0<=Hs.indexOf(a.id))&&(a.deps&&Ws(e,a,!0))){n=!0;break}}}return i||(Hs.length=0),n}var Xs=function(e){function u(e,t,i,n){var r;return y(this,u),(r=T(this,S(u).call(this)))._id=++Ds,Ns[r._id]=d(d(r)),r._pipeline=e,r._errorUrls=[],r._appending=!1,r._ownerQueue=null,r.onProgress=i,r.onComplete=n,r.map=dt(!0),r.completed={},r.totalCount=0,r.completedCount=0,r._pipeline?r.active=!0:r.active=!1,t&&(0<t.length?r.append(t):r.allComplete()),r}return p(u,Pn),l(u,[{key:"append",value:function(e,t){if(!this.active)return[];t&&!t.deps&&(t.deps=[]),this._appending=!0;var i,n,r,a,s=[];for(i=0;i<e.length;++i)if(!(n=e[i]).queueId||this.map[n.id]){if("string"==typeof((a=n).url||a)){var o=(r=Vs(n,this._id)).id;this.map[o]||(this.map[o]=r,this.totalCount++,t&&t.deps.push(r),u.registerQueueDep(t||this._id,o),s.push(r))}}else{if(this.map[n.id]=n,t&&t.deps.push(n),n.complete||Ws(t,n)){this.totalCount++,this.itemComplete(n.id);continue}var l=this,c=Ns[n.queueId];c&&(this.totalCount++,u.registerQueueDep(t||this._id,n.id),c.addListener(n.id,function(e){l.itemComplete(e.id)}))}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(s),s}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=Gs[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var t=this.map[e];if(t){var i=this._errorUrls.indexOf(e);if(t.error&&-1===i?this._errorUrls.push(e):t.error||-1===i||this._errorUrls.splice(i,1),this.completed[e]=t,this.completedCount++,u.finishDep(t.id),this.onProgress){var n=Gs[this._id];this.onProgress(n?n.completed.length:this.completedCount,n?n.deps.length:this.totalCount,t)}this.emit(e,t),this.removeAll(e),!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=null,this.onComplete=null,this.map=dt(!0),this.completed={},this.totalCount=0,this.completedCount=0,Pn.call(this),Ns[this._id]=null,Gs[this._id]&&(Gs[this._id].completed.length=0,Gs[this._id].deps.length=0),-1===zs.indexOf(this)&&zs.length<10&&zs.push(this)}}],[{key:"create",value:function(e,t,i,n){void 0===i?"function"==typeof t&&(n=t,t=i=null):void 0===n&&("function"==typeof t?(n=i,i=t,t=null):(n=i,i=null));var r=zs.pop();return r?(r._pipeline=e,r.onProgress=i,r.onComplete=n,(Ns[r._id]=r)._pipeline&&(r.active=!0),t&&r.append(t)):r=new u(e,t,i,n),r}},{key:"getQueue",value:function(e){return e.queueId?Ns[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=Ns[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=Gs[e._id];t?(t.completed.length=0,t.deps.length=0):t=Gs[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=Gs[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in Gs){var a=Gs[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in Gs){var i=Gs[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),u}();Xs.ItemState=new cc.Enum(Us);var js=Xs.prototype;js.addListener=Pn.prototype.on,js.hasListener=Pn.prototype.hasEventListener,js.removeListener=Pn.prototype.off,js.removeAllListeners=Pn.prototype.removeAll;var qs=(cc.LoadingItems=Xs).ItemState;function Ys(e,i){var n=e.id,t=i.states[n],r=e.next,a=e.pipeline;if(!i.error&&t!==qs.WORKING&&t!==qs.ERROR)if(t===qs.COMPLETE)r?Ys(r,i):a.flowOut(i);else{i.states[n]=qs.WORKING;var s=e.handle(i,function(e,t){e?(i.error=e,i.states[n]=qs.ERROR,a.flowOut(i)):(t&&(i.content=t),i.states[n]=qs.COMPLETE,r?Ys(r,i):a.flowOut(i))});s instanceof Error?(i.error=s,i.states[n]=qs.ERROR,a.flowOut(i)):void 0!==s&&(null!==s&&(i.content=s),i.states[n]=qs.COMPLETE,r?Ys(r,i):a.flowOut(i))}}var Ks=function(){function n(e){y(this,n),this._pipes=e,this._cache=dt(!0);for(var t=0;t<e.length;++t){var i=e[t];i.handle&&i.id&&(i.pipeline=this,i.next=t<e.length-1?e[t+1]:null)}}return l(n,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)cc.warnID(4921);else if(0<this._pipes.indexOf(e))cc.warnID(4922);else{var i=null;t<(e.pipeline=this)._pipes.length&&(i=this._pipes[t]);var n=null;0<t&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,0<this._pipes.length&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)i=e[t],this._cache[i.id]=i;for(t=0;t<e.length;t++)Ys(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return Xs.create(this,function(e,t){i(e,t),t.destroy()}).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||(this._cache[e.id]=e),e.complete=!0,Xs.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t&&t.alias&&(t=t.alias),t}},{key:"removeItem",value:function(e){var t=this._cache[e];t&&t.complete&&delete this._cache[e];return t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),n}();Ks.ItemState=qs,cc.Pipeline=Ks;var Qs=function(){function e(){y(this,e),this.jsons={}}return l(e,[{key:"load",value:function(e,t){t.length!==e.length&&cc.errorID(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),Zs=function(){function e(){y(this,e),this.contents={}}return l(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&cc.errorID(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:cc.js._getClassId(cc.Texture2D),content:t}:null}}]),e}();var Js={Invalid:0,Removed:1,Downloading:2,Loaded:3};function $s(){this.unpacker=null,this.state=Js.Invalid}var eo={},to={},io={};function no(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function ro(e){for(var t in to=e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;jt(eo,r,t,a)}}function ao(n,r,a){var e=cc.AssetLibrary.getLibUrlNoExt(r)+".json";cc.loader.load({url:e,ignoreMaxConcurrency:!0},function(e,t){if(e)return cc.errorID(4916,n),a(e);var i=oo(n,r,t);i?a(null,i):a(no(n,r))})}function so(e,t){var i=io[e];i||((i=io[e]=new $s).state=Js.Downloading),i.state!==Js.Loaded&&(i.unpacker=new Qs,i.unpacker.load(to[e],t),i.state=Js.Loaded)}function oo(e,t,i){var n=io[t];return n.state!==Js.Loaded&&("string"==typeof i&&(i=JSON.parse(i)),Array.isArray(i)?n.unpacker=new Qs:i.type===cc.js._getClassId(cc.Texture2D)&&(n.unpacker=new Zs),n.unpacker.load(to[t],i),n.state=Js.Loaded),n.unpacker.retrieve(e)}function lo(e){for(var t=Js.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=io[r];if(a){var s=a.state;if(s===Js.Loaded)return r;t<s&&(t=s,i=r)}}return t!==Js.Invalid?i:e[0]}function co(e,t){var i=e.uuid,n=eo[i];if(n){Array.isArray(n)&&(n=lo(n));var r=io[n];if(r&&r.state===Js.Loaded){var a=r.unpacker.retrieve(i);return a||no(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=io[n]=new $s).state=Js.Downloading),ao(i,n,t),null}}var uo=Object.freeze({initPacks:ro,_loadNewPack:ao,_doPreload:so,_doLoadNewPack:oo,_selectLoadedPack:lo,load:co});function ho(e,t){var i=e.url,n=cc.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}var fo=/\?/;function po(e){return cc.game.config.noCache&&"string"==typeof e&&(fo.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function _o(e,t){var i=e.url;i=po(i);var n=cc.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}var vo,mo={};mo.LANGUAGE_ENGLISH="en",mo.LANGUAGE_CHINESE="zh",mo.LANGUAGE_FRENCH="fr",mo.LANGUAGE_ITALIAN="it",mo.LANGUAGE_GERMAN="de",mo.LANGUAGE_SPANISH="es",mo.LANGUAGE_DUTCH="du",mo.LANGUAGE_RUSSIAN="ru",mo.LANGUAGE_KOREAN="ko",mo.LANGUAGE_JAPANESE="ja",mo.LANGUAGE_HUNGARIAN="hu",mo.LANGUAGE_PORTUGUESE="pt",mo.LANGUAGE_ARABIC="ar",mo.LANGUAGE_NORWEGIAN="no",mo.LANGUAGE_POLISH="pl",mo.LANGUAGE_TURKISH="tr",mo.LANGUAGE_UKRAINIAN="uk",mo.LANGUAGE_ROMANIAN="ro",mo.LANGUAGE_BULGARIAN="bg",mo.LANGUAGE_UNKNOWN="unknown",mo.OS_IOS="iOS",mo.OS_ANDROID="Android",mo.OS_WINDOWS="Windows",mo.OS_MARMALADE="Marmalade",mo.OS_LINUX="Linux",mo.OS_BADA="Bada",mo.OS_BLACKBERRY="Blackberry",mo.OS_OSX="OS X",mo.OS_WP8="WP8",mo.OS_WINRT="WINRT",mo.OS_UNKNOWN="Unknown",mo.UNKNOWN=-1,mo.WIN32=0,mo.LINUX=1,mo.MACOS=2,mo.ANDROID=3,mo.IPHONE=4,mo.IPAD=5,mo.BLACKBERRY=6,mo.NACL=7,mo.EMSCRIPTEN=8,mo.TIZEN=9,mo.WINRT=10,mo.WP8=11,mo.MOBILE_BROWSER=100,mo.DESKTOP_BROWSER=101,mo.EDITOR_PAGE=102,mo.EDITOR_CORE=103,mo.WECHAT_GAME=104,mo.QQ_PLAY=105,mo.BROWSER_TYPE_WECHAT="wechat",mo.BROWSER_TYPE_WECHAT_GAME="wechatgame",mo.BROWSER_TYPE_WECHAT_GAME_SUB="wechatgamesub",mo.BROWSER_TYPE_QQ_PLAY="qqplay",mo.BROWSER_TYPE_ANDROID="androidbrowser",mo.BROWSER_TYPE_IE="ie",mo.BROWSER_TYPE_QQ="qqbrowser",mo.BROWSER_TYPE_MOBILE_QQ="mqqbrowser",mo.BROWSER_TYPE_UC="ucbrowser",mo.BROWSER_TYPE_UCBS="ucbs",mo.BROWSER_TYPE_360="360browser",mo.BROWSER_TYPE_BAIDU_APP="baiduboxapp",mo.BROWSER_TYPE_BAIDU="baidubrowser",mo.BROWSER_TYPE_MAXTHON="maxthon",mo.BROWSER_TYPE_OPERA="opera",mo.BROWSER_TYPE_OUPENG="oupeng",mo.BROWSER_TYPE_MIUI="miuibrowser",mo.BROWSER_TYPE_FIREFOX="firefox",mo.BROWSER_TYPE_SAFARI="safari",mo.BROWSER_TYPE_CHROME="chrome",mo.BROWSER_TYPE_LIEBAO="liebao",mo.BROWSER_TYPE_QZONE="qzone",mo.BROWSER_TYPE_SOUGOU="sogou",mo.BROWSER_TYPE_UNKNOWN="unknown",mo.isNative=!1,mo.isBrowser="object"===("undefined"==typeof window?"undefined":ye(window))&&"object"===("undefined"==typeof document?"undefined":ye(document))&&!0,mo.isLittleEndian=(vo=new ArrayBuffer(2),new DataView(vo).setInt16(0,256,!0),256===new Int16Array(vo)[0]);var yo=window,go=yo.navigator,bo=document,So=bo.documentElement,To=go.userAgent.toLowerCase();mo.isMobile=/mobile|android|iphone|ipad/.test(To),mo.platform=mo.isMobile?mo.MOBILE_BROWSER:mo.DESKTOP_BROWSER;var Eo=go.language;Eo=(Eo=Eo||go.browserLanguage)?Eo.split("-")[0]:mo.LANGUAGE_ENGLISH,mo.language=Eo;var xo=!1,Ao=!1,Co="",wo=0,Ro=/android (\d+(?:\.\d+)+)/i.exec(To)||/android (\d+(?:\.\d+)+)/i.exec(go.platform);Ro&&(xo=!0,Co=Ro[1]||"",wo=parseInt(Co)||0),(Ro=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(To))?(Ao=!0,Co=Ro[2]||"",wo=parseInt(Co)||0):/(iPhone|iPad|iPod)/.exec(go.platform)&&(Ao=!0,Co="",wo=0);var ko=mo.OS_UNKNOWN;-1!==go.appVersion.indexOf("Win")?ko=mo.OS_WINDOWS:Ao?ko=mo.OS_IOS:-1!==go.appVersion.indexOf("Mac")?ko=mo.OS_OSX:-1!==go.appVersion.indexOf("X11")&&-1===go.appVersion.indexOf("Linux")?ko=mo.OS_UNIX:xo?ko=mo.OS_ANDROID:-1===go.appVersion.indexOf("Linux")&&-1===To.indexOf("ubuntu")||(ko=mo.OS_LINUX),mo.os=ko,mo.osVersion=Co,mo.osMainVersion=wo,mo.browserType=mo.BROWSER_TYPE_UNKNOWN,function(){var e=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(To);e||(e=/qqbrowser|ucbrowser/i.exec(To)),e||(e=/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(To));var t=e?e[0].toLowerCase():mo.BROWSER_TYPE_UNKNOWN;"micromessenger"===t?t=mo.BROWSER_TYPE_WECHAT:"safari"===t&&xo?t=mo.BROWSER_TYPE_ANDROID:"qq"===t&&To.match(/android.*applewebkit/i)?t=mo.BROWSER_TYPE_ANDROID:"trident"===t?t=mo.BROWSER_TYPE_IE:"360 aphone"===t?t=mo.BROWSER_TYPE_360:"mxbrowser"===t?t=mo.BROWSER_TYPE_MAXTHON:"opr/"===t&&(t=mo.BROWSER_TYPE_OPERA),mo.browserType=t}(),mo.browserVersion="",(Wo=To.match(/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i))||(Wo=To.match(/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i)),mo.browserVersion=Wo?Wo[4]:"";var Oo=window.innerWidth||document.documentElement.clientWidth,Fo=window.innerHeight||document.documentElement.clientHeight,Lo=window.devicePixelRatio||1;mo.windowPixelResolution={width:Lo*Oo,height:Lo*Fo},mo._checkWebGLRenderMode=function(){if(cc.game.renderType!==cc.game.RENDER_TYPE_WEBGL)throw new Error("This feature supports WebGL render mode only.")};var Bo=document.createElement("canvas");try{var Mo=mo.localStorage=yo.localStorage;Mo.setItem("storage",""),Mo.removeItem("storage"),Mo=null}catch(tp){var Io=function(){cc.warnID(5200)};mo.localStorage={getItem:Io,setItem:Io,removeItem:Io,clear:Io}}var Po=Bo.toDataURL("image/webp").startsWith("data:image/webp"),Do=!!Bo.getContext("2d"),No=!1;if(mo.browserType===mo.BROWSER_TYPE_WECHAT_GAME)No=!0;else if(yo.WebGLRenderingContext&&(function e(t,i,n){if(!n)return e(t,i,"webgl")||e(t,i,"experimental-webgl")||e(t,i,"webkit-3d")||e(t,i,"moz-webgl")||null;try{return t.getContext(n,i)}catch(e){return null}}(document.createElement("CANVAS"))&&(No=!0),No&&mo.os===mo.OS_ANDROID)){var zo=parseFloat(mo.browserVersion);switch(mo.browserType){case mo.BROWSER_TYPE_MOBILE_QQ:case mo.BROWSER_TYPE_BAIDU:case mo.BROWSER_TYPE_BAIDU_APP:No=6.2<=zo;break;case mo.BROWSER_TYPE_ANDROID:mo.osMainVersion&&5<=mo.osMainVersion&&(No=!0);break;case mo.BROWSER_TYPE_CHROME:No=30<=zo;break;case mo.BROWSER_TYPE_UC:No=11<zo;break;case mo.BROWSER_TYPE_360:No=!1}}var Uo,Go=mo.capabilities={canvas:Do,opengl:No,webp:Po};(void 0!==So.ontouchstart||void 0!==bo.ontouchstart||go.msPointerEnabled)&&(Go.touches=!0),void 0!==So.onmouseup&&(Go.mouse=!0),void 0!==So.onkeyup&&(Go.keyboard=!0),(yo.DeviceMotionEvent||yo.DeviceOrientationEvent)&&(Go.accelerometer=!0),Ho=mo.browserType!==mo.BROWSER_TYPE_WECHAT_GAME&&!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),Uo={ONLY_ONE:!1,WEB_AUDIO:Ho,DELAY_CREATE_CTX:!1},mo.os===mo.OS_IOS&&(Uo.USE_LOADER_EVENT="loadedmetadata"),mo.browserType===mo.BROWSER_TYPE_FIREFOX&&(Uo.DELAY_CREATE_CTX=!0,Uo.USE_LOADER_EVENT="canplay"),mo.os===mo.OS_ANDROID&&mo.browserType===mo.BROWSER_TYPE_UC&&(Uo.ONE_SOURCE=!0);try{Uo.WEB_AUDIO&&(Uo._context=null,Object.defineProperty(Uo,"context",{get:function(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(w){Uo.WEB_AUDIO=!1,cc.logID(5201)}var Vo,Ho,Wo,Xo=[];(Vo=document.createElement("audio")).canPlayType&&(Vo.canPlayType('audio/ogg; codecs="vorbis"')&&Xo.push(".ogg"),Vo.canPlayType("audio/mpeg")&&Xo.push(".mp3"),Vo.canPlayType('audio/wav; codecs="1"')&&Xo.push(".wav"),Vo.canPlayType("audio/mp4")&&Xo.push(".mp4"),Vo.canPlayType("audio/x-m4a")&&Xo.push(".m4a")),Uo.format=Xo,mo.__audioSupport=Uo,mo.NetworkType={NONE:0,LAN:1,WWAN:2},mo.getNetworkType=function(){return mo.NetworkType.LAN},mo.getBatteryLevel=function(){return 1},mo.garbageCollect=function(){},mo.dumpRoot=function(){},mo.restartVM=function(){},mo.cleanScript=function(e){},mo.isObjectValid=function(e){return!!e},mo.dump=function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",e+="Using "+(cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n",cc.log(e)},mo.openURL=function(e){window.open(e)},mo.now=function(){return Date.now?Date.now():+new Date},cc.sys=mo;var jo={INITIALIZING:0,PLAYING:1,STOPPED:2},qo=function(){function t(e){y(this,t),this._state=jo.STOPPED,this._duration=0,this._eventTarget=void 0,this._duration=e.duration,this._eventTarget=e.eventTarget}return l(t,[{key:"getState",value:function(){return this._state}},{key:"destroy",value:function(){}}]),t}(),Yo=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._post_play=void 0,t._on_gesture=void 0,t._alreadyDelayed=!1,t._audio=e.clip,t._post_play=function(){t._state=jo.PLAYING,t._eventTarget.emit("started")},t._on_gesture=function(){if(t._audio){var e=t._audio.play();e?e.then(function(){t._alreadyDelayed?t._post_play():(t._audio.pause(),t._audio.currentTime=0),window.removeEventListener("touchend",t._on_gesture),document.removeEventListener("mouseup",t._on_gesture)}):console.warn("no promise returned from HTMLMediaElement.play()")}},t._audio.volume=t._volume,t._audio.loop=t._loop,t._audio.addEventListener("ended",function(){t._oneShoting||(t._state=jo.STOPPED,t._audio.currentTime=0,t._eventTarget.emit("ended"))}),window.addEventListener("touchend",t._on_gesture),document.addEventListener("mouseup",t._on_gesture),t}return p(i,qo),l(i,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==jo.PLAYING){var t=this._audio.play();t?t.then(this._post_play).catch(function(){e._alreadyDelayed=!0}):console.warn("no promise returned from HTMLMediaElement.play()")}}},{key:"pause",value:function(){this._audio&&this._state===jo.PLAYING&&(this._audio.pause(),this._state=jo.STOPPED,this._oneShoting=!1)}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._state===jo.PLAYING&&(this._audio.pause(),this._state=jo.STOPPED,this._oneShoting=!1))}},{key:"playOneShot",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,i=this._audio;i&&(i.currentTime=0,i.volume=t,this._oneShoting||(i.loop=!1,this._oneShoting=!0,i.play().then(function(){i.addEventListener("ended",function(){i.currentTime=0,i.volume=e._volume,i.loop=e._loop,e._oneShoting=!1},{once:!0})}).catch(function(){e._oneShoting=!1})))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=e)}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"getDuration",value:function(){return this._audio?isNaN(this._audio.duration)?this._duration:this._audio.duration:this._duration}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}}]),i}(),Ko=mo.__audioSupport,Qo=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._startTime=0,t._offset=0,t._volume=1,t._loop=!1,t._currentTimer=0,t._audio=void 0,t._context=void 0,t._sourceNode=void 0,t._gainNode=void 0,t._on_ended=void 0,t._do_play=void 0,t._on_gesture=void 0,t._alreadyDelayed=!1,t._audio=e.clip,t._context=Ko.context,t._sourceNode=t._context.createBufferSource(),t._gainNode=t._context.createGain(),t._gainNode.connect(t._context.destination),t._on_ended=function(){t._offset=0,t._startTime=t._context.currentTime,t._sourceNode.loop||(t._eventTarget.emit("ended"),t._state=jo.STOPPED)},t._do_play=function(){t._sourceNode=t._context.createBufferSource(),t._sourceNode.buffer=t._audio,t._sourceNode.loop=t._loop,t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._offset),t._state=jo.PLAYING,t._startTime=t._context.currentTime,cc.director.once(cc.Director.EVENT_AFTER_UPDATE,function(){t._eventTarget.emit("started")}),clearInterval(t._currentTimer),t._currentTimer=window.setInterval(function(){t._on_ended(),clearInterval(t._currentTimer),t._sourceNode.loop&&(t._currentTimer=window.setInterval(t._on_ended,1e3*t._audio.duration))},1e3*(t._audio.duration-t._offset))},t._on_gesture=function(){t._context.resume().then(function(){t._alreadyDelayed&&t._do_play(),window.removeEventListener("touchend",t._on_gesture),document.removeEventListener("mouseup",t._on_gesture)})},"running"===t._context.state?T(t):(window.addEventListener("touchend",t._on_gesture),document.addEventListener("mouseup",t._on_gesture),t)}return p(i,qo),l(i,[{key:"play",value:function(){this._audio&&this._state!==jo.PLAYING&&("running"===this._context.state?this._do_play():this._alreadyDelayed=!0)}},{key:"pause",value:function(){this._state===jo.PLAYING&&(this._sourceNode.stop(),this._offset+=this._context.currentTime-this._startTime,this._state=jo.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._state===jo.PLAYING&&(this._sourceNode.stop(),this._state=jo.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;if(this._audio){var t=this._context.createGain();t.connect(this._context.destination),t.gain.value=e;var i=this._context.createBufferSource();i.buffer=this._audio,i.loop=!1,i.connect(t),i.start()}}},{key:"setCurrentTime",value:function(e){this._offset=e,this._state===jo.PLAYING&&(this._sourceNode.stop(),this._do_play())}},{key:"getCurrentTime",value:function(){return this._state!==jo.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"getDuration",value:function(){return this._audio?this._audio.duration:0}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}}]),i}(),Zo=function(){function e(){y(this,e),this.assignAssetsBy=void 0,this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=dt(!0)}return l(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,wt(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function Jo(e,t,i,n,r,a){if(t instanceof cc.ValueType){r||e.push("if(prop){");var s=ft(t);e.push("s._deserializeTypedObject(o".concat(i,",prop,").concat(s,");")),r||e.push("}else o"+i+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+n+",null,"+!!a+");"),e.push("}else o"+i+"=null;")}Zo.pool=void 0,Zo.pool=new Pt(function(e){e.reset()},10),Zo.pool.get=function(){return this._get()||new Zo};var $o=function(e,t){for(var i=oi+"type",n=oi+"default",r=oi+"saveUrlAsAsset",a=oi+"formerlySerializedAs",s=hi(t),o=t.__values__,l=["var prop;"],c=zt.test(It(t)),u=0;u<o.length;u++){var h=o[u];0;var d=void 0,f=void 0,p=d=Yi.IDENTIFIER_RE.test(h)?(f='"'+h+'"',"."+h):"["+(f=Yi.escapeForJS(h))+"]";if(s[h+a]){var _=s[h+a];p=Yi.IDENTIFIER_RE.test(_)?"."+_:"["+Yi.escapeForJS(_)+"]"}l.push("prop=d"+p+";"),l.push("if(typeof ".concat("prop",'!=="undefined"){'));var v=s[h+r],m=Yi.getDefault(s[h+n]);if(c){var y=void 0,g=s[h+i];if(void 0===m&&g)y=g===cc.String||g===cc.Integer||g===cc.Float||g===cc.Boolean;else{var b=ye(m);y="string"===b&&!v||"number"===b||"boolean"===b}y?l.push("o".concat(d,"=prop;")):Jo(l,m,d,f,!0,v)}else l.push("if(typeof ".concat("prop",'!=="object"){')+"o"+d+"=prop;}else{"),Jo(l,m,d,f,!1,v),l.push("}");l.push("}")}(cc.js.isChildClassOf(t,cc._BaseNode)||cc.js.isChildClassOf(t,cc.Component))&&l.push("d._id&&(o._id=d._id);");return"_$erialized"===o[o.length-1]&&(l.push("o._$erialized=JSON.parse(JSON.stringify(d));"),l.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",l.join(""))};function el(e,t,i,n,r){var a;n.hasOwnProperty("__deserialize__")?a=n.__deserialize__:(a=$o(e,n),lt(n,"__deserialize__",a,!0)),a(e,t,i,n,r)}var tl=function(){function a(e,t,i,n,r){y(this,a),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=e,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=i,this._idList=[],this._idObjList=[],this._idPropList=[]}return l(a,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++){if(t[n])this.deserializedList[n]=this._deserializeObject(t[n],!1)}this.deserializedData=0<i?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,s=e._idList,o=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<s.length;t++)i=a[t],n=s[t],o[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,t,i,n,r){var a,s=null,o=null,l=e.__type__;if(l){var c=function(){(s=new o)._deserialize?s._deserialize(e.content,u):cc.Class._isCCClass(o)?el(u,s,e,o,i):u._deserializeTypedObject(s,e,o)};if(!(o=this._classFinder(l,e,n,r)))return this._classFinder===Bt&&cc.deserialize.reportMissingClass(l),null;var u=this;c()}else if(Array.isArray(e)){s=new Array(e.length);for(var h=0;h<e.length;h++)"object"===ye(a=e[h])&&a?this._deserializeObjField(s,a,""+h,null,t):s[h]=a}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var s=t.__uuid__;s?this.result.push(e,i,s,r):e[i]=this._deserializeObject(t,r)}else{var o=this.deserializedList[a];o?e[i]=o:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"object"!==ye(n)?"__type__"!==i&&(e[i]=n):n?this._deserializeObjField(e,n,i):e[i]=null}}},{key:"_deserializeTypedObject",value:function(e,t,i){if(i===cc.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(i===cc.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(i!==cc.Color){if(i===cc.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var n=oi+"default",r=hi(i),a=i.__props__||Object.keys(e),s=0;s<a.length;s++){var o=a[s],l=t[o];void 0!==l&&t.hasOwnProperty(o)||(l=Yi.getDefault(r[o+n])),"object"!==ye(l)?e[o]=l:l?this._deserializeObjField(e,l,o):e[o]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}}}]),a}();function il(e,t,i){var n=(i=i||{}).classFinder||Bt,r=i.createAssetRefs||cc.sys.platform===cc.sys.EDITOR_CORE,a=i.customEnv,s=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var o=!t;t=t||Zo.pool.get();var l=tl.pool.get(t,!1,n,a,s);cc.game._isCloning=!0;var c=l.deserialize(e);return cc.game._isCloning=!1,tl.pool.put(l),r&&t.assignAssetsBy(Editor.serialize.asAsset),o&&Zo.pool.put(t),c}tl.pool=void 0,tl.pool=new Pt(function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0},1),tl.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new tl(e,t,i,n,r)},il.Details=Zo,il.reportMissingClass=function(e){cc.warnID(5302,e)},cc.deserialize=il;var nl,rl=Cn.Flags.Destroyed,al=Cn.Flags.PersistentMask,sl=[];function ol(e,t){if(!t){if("object"!==ye(e)||Array.isArray(e))return null;if(!e)return null;if(!cc.isValid(e))return null;0}var i;if(e instanceof Cn){if(e._instantiate)return cc.game._isCloning=!0,i=e._instantiate(),cc.game._isCloning=!1,i;if(e instanceof cc.Asset)return null}return cc.game._isCloning=!0,i=ll(e),cc.game._isCloning=!1,i}function ll(e,t){if(Array.isArray(e))return null;if(ei(e))return null;var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new e.constructor}else i=Object.create(null);cl(e,i,t);for(var n=0,r=sl.length;n<r;++n)sl[n]._iN$t=null;return sl.length=0,i}function cl(e,t,i){e._iN$t=t,sl.push(e);var n=e.constructor;if(cc.Class._isCCClass(n))!function(e,t,i,n){for(var r=e.__values__,a=0;a<r.length;a++){var s=r[a],o=t[s];if("object"===ye(o)&&o){var l=i[s];l instanceof Fr&&l.constructor===o.constructor?l.set(o):i[s]=o._iN$t||ul(o,n)}else i[s]=o}}(n,e,t,i);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=e[r];if("object"===ye(a)&&a){if(a===t)continue;t[r]=a._iN$t||ul(a,i)}else t[r]=a}e instanceof Cn&&(t._objFlags&=al)}function ul(e,t){if(e instanceof Fr)return e.clone();if(e instanceof cc.Asset)return e;var i;if(Array.isArray(e)){var n=e.length;i=new Array(n),e._iN$t=i;for(var r=0;r<n;++r){var a=e[r];"object"===ye(a)&&a?i[r]=a._iN$t||ul(a,t):i[r]=a}return sl.push(e),i}if(e._objFlags&rl)return null;var s=e.constructor;if(cc.Class._isCCClass(s)){if(t)if(t instanceof cc.Component){if(e instanceof cc._BaseNode||e instanceof cc.Component)return e}else if(t instanceof cc._BaseNode)if(e instanceof cc._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof cc.Component&&!e.node.isChildOf(t))return e;i=new s}else if(s===Object)i={};else{if(s)return e;i=Object.create(null)}return cl(e,i,t),i}ol._clone=ll,cc.instantiate=ol,cc._decorator=En;var hl,dl,fl,pl,_l,vl,ml,yl,gl=un("cc.AudioPlayerWX")(nl=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._volume=1,t._loop=!1,t._oneShoting=!1,t._audio=void 0,t._audio=e.clip,t._audio.obeyMuteSwitch=!1,t._audio.onPlay(function(){t._state=jo.PLAYING,t._eventTarget.emit("started")}),t._audio.onPause(function(){t._state=jo.STOPPED,t._oneShoting=!1}),t._audio.onStop(function(){t._state=jo.STOPPED,t._oneShoting=!1}),t._audio.onEnded(function(){t._state=jo.STOPPED,t._eventTarget.emit("ended"),t._oneShoting&&(t._audio.volume=t._volume,t._audio.loop=t._loop,t._oneShoting=!1)}),wx.onShow(function(){return t._audio.play()}),wx.onAudioInterruptionEnd(function(){return t._audio.play()}),t}return p(i,qo),l(i,[{key:"play",value:function(){this._audio&&this._state!==jo.PLAYING&&this._audio.play()}},{key:"pause",value:function(){this._audio&&this._state===jo.PLAYING&&this._audio.pause()}},{key:"stop",value:function(){this._audio&&this._audio.stop()}},{key:"playOneShot",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1;this._audio&&(this._audio.volume=e,this._oneShoting||(this._audio.loop=!1,this._oneShoting=!0,this._audio.play()))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setCurrentTime",value:function(e){this._audio&&this._audio.seek(e)}},{key:"getDuration",value:function(){return this._audio?this._audio.duration:0}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&void 0!==this._audio.volume&&(this._audio.volume=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"destroy",value:function(){return!!this._audio&&(this._audio.destroy(),!0)}}]),i}())||nl;cc.AudioPlayerWX=gl;var bl=ai({WEB_AUDIO:0,DOM_AUDIO:1,WX_GAME_AUDIO:2,UNKNOWN_AUDIO:3}),Sl=(hl=un("cc.AudioClip"),dl=hn({type:bl}),hl((yl=ml=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_duration",_l,d(d(e))),v(e,"_loadMode",vl,d(d(e))),e._audio=null,e._player=null,e.loaded=!1,e}return p(t,qn),l(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),_(S(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_nativeAsset",set:function(e){var t;(this._audio=e)?(e instanceof AudioBuffer?(t=Qo,this._loadMode=bl.WEB_AUDIO):(t=Yo,this._loadMode=bl.DOM_AUDIO),this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")):(this._player=null,this._loadMode=bl.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1)},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():jo.INITIALIZING}}]),t}(),ml.PlayingState=jo,ml.AudioType=bl,ml.preventDeferredLoadDependents=!0,_l=c((pl=yl).prototype,"_duration",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vl=c(pl.prototype,"_loadMode",[dl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bl.UNKNOWN_AUDIO}}),fl=pl))||fl);cc.AudioClip=Sl;var Tl=mo.__audioSupport,El=Tl.format;function xl(t,i){var e=document.createElement("audio");e.src=t.url;var n=function(){clearTimeout(r),e.removeEventListener("canplaythrough",a,!1),e.removeEventListener("error",s,!1),Tl.USE_LOADER_EVENT&&e.removeEventListener(Tl.USE_LOADER_EVENT,a,!1)},r=setTimeout(function(){0===e.readyState?s():a()},8e3),a=function(){n(),i(null,e)},s=function(){n();var e="load audio failure - "+t.url;cc.log(e),i(e)};e.addEventListener("canplaythrough",a,!1),e.addEventListener("error",s,!1),Tl.USE_LOADER_EVENT&&e.addEventListener(Tl.USE_LOADER_EVENT,a,!1)}function Al(e,t){var i=Tl.context;i||t(new Error(G(4926)));var n=cc.loader.getXMLHttpRequest();n.open("GET",e.url,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,function(e){t(null,e)},function(){t("decode error - "+e.id,null)})},n.onerror=function(){t("request error - "+e.id,null)},n.send()}function Cl(e,t){if(0===El.length)return new Error(G(4927));var i;Tl.WEB_AUDIO?i=e._owner instanceof Sl?e._owner.loadMode===bl.WEB_AUDIO?Al:xl:e.urlParam&&e.urlParam.useDom?xl:Al:i=xl;i(e,t)}function wl(){return null}function Rl(e,t,i){var n=e.url,r=document,a=document.createElement("script");function s(){a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(null,n)}function o(){a.parentNode.removeChild(a),a.removeEventListener("load",s,!1),a.removeEventListener("error",o,!1),t(new Error(G(4928,n)))}a.async=i,a.src=po(n),a.addEventListener("load",s,!1),a.addEventListener("error",o,!1),r.body.appendChild(a)}function kl(t,i,e,n){void 0===e&&(e=!0);var r=po(t.url);if(n=n||new Image,e&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&0<n.naturalWidth&&n.src===r)return n;var a=function e(){n.removeEventListener("load",e),n.removeEventListener("error",s),n.id=t.id,i(null,n)},s=function e(){n.removeEventListener("load",a),n.removeEventListener("error",e),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?kl(t,i,!1,n):i(new Error(G(4930,r)))};n.addEventListener("load",a),n.addEventListener("error",s),n.src=r}var Ol={js:Rl,png:kl,jpg:kl,bmp:kl,jpeg:kl,gif:kl,ico:kl,tiff:kl,webp:function(e,t,i,n){return cc.sys.capabilities.webp?kl(e,t,i,n):new Error(G(4929,e.url))},image:kl,pvr:ho,pkm:ho,mp3:Cl,ogg:Cl,wav:Cl,m4a:Cl,txt:_o,xml:_o,vsh:_o,fsh:_o,atlas:_o,tmx:_o,tsx:_o,json:_o,ExportJson:_o,plist:_o,fnt:_o,font:wl,eot:wl,ttf:wl,woff:wl,svg:wl,ttc:wl,uuid:function(e,t){var i=co(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:ho,bin:ho,default:_o},Fl="Downloader",Ll=function(){function t(e){y(this,t),this.id=Fl,this.async=!0,this.pipeline=null,this._curConcurrent=0,this._loadQueue=[],this._subpackages={},this.extMap=Et(e,Ol)}return l(t,[{key:"addHandlers",value:function(e){Et(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,i){var n=this,t=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<cc.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=t.call(this,e,function(e,t){n._curConcurrent=Math.max(0,n._curConcurrent-1),n._handleLoadQueue(),i&&i(e,t)})))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=t.call(this,e,i)))return r}else this._loadQueue.push({item:e,callback:i})}},{key:"loadSubpackage",value:function(e,t){var i=this._subpackages[e];i?i.loaded?t&&t():Rl({url:i.path},function(e){e||(i.loaded=!0),t&&t(e)}):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),t}();Ll.ID=Fl,Ll.PackDownloader=uo,Ks.Downloader=Ll;var Bl=function(){function e(){y(this,e),window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return l(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}(),Ml=new(function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Bl),l(t,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return cc.warnID(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),t}());function Il(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function Pl(t,i){var e,n;if("string"==typeof t.content)try{e=JSON.parse(t.content)}catch(e){return new Error(G(4923,t.id,e.stack))}else{if("object"!==ye(t.content))return new Error(G(4924));e=t.content}if(null==e)return new Error(G(4923,t.id));var r=Il(e);n=r?cc._MissingScript.safeFindClass:function(e){var t=Bt(e);return t||(cc.warnID(4903,e),Object)};var a,s=cc.deserialize.Details.pool.get();try{a=cc.deserialize(e,s,{classFinder:n,target:t.existingAsset,customEnv:t})}catch(e){return cc.deserialize.Details.pool.put(s),console.error(e),new Error("Failed to load asset ".concat(t.id,", exception occurs during deserialization: ").concat(e.stack,"."))}a._uuid=t.uuid;var o,l,c,u=(o=a,l=r,(c=t.deferredLoadRaw)?o instanceof cc.Asset&&o.constructor.preventDeferredLoadDependents&&(c=!1):l&&(o instanceof cc.SceneAsset||o instanceof cc.Prefab)&&(c=o.asyncLoadAssets),c),h=function(e,t,i,n){var r,a,s,o=i.uuidList,l=i.uuidObjList,c=i.uuidPropList,u=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<o.length;a++){s=o[a];var d=l[a],f=c[a],p=cc.AssetLibrary._getAssetInfoInRuntime(s);if(p.raw){var _=p.url;d[f]=_,h.push(_)}else r.push({type:"uuid",uuid:s,deferredLoadRaw:!0,_owner:d,_ownerProp:f,_stillUseUrl:u[a]})}else{for(r=new Array(o.length),a=0;a<o.length;a++)s=o[a],r[a]={type:"uuid",uuid:s,_owner:l[a],_ownerProp:c[a],_stillUseUrl:u[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(t,a,s,u);cc.deserialize.Details.pool.put(s);var d=function(t,e){if(!t&&e.onLoaded)try{e.onLoaded()}catch(e){t=e}i(t,e)};if(0===h.length)return d(null,a);!function(e,t,f,p,_){t.content=f;var v=t.dependKeys;e.flowInDeps(t,p,function(e,t){var i,n=t.map;for(var r in n)(i=n[r]).uuid&&i.content&&(i.content._uuid=i.uuid);for(var a=0;a<p.length;a++){var s=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==f._uuid&&v.indexOf(e.id)<0&&v.push(e.id)},o=p[a],l=o.uuid,c=o.url;if(o._owner,o._ownerProp,i=n[c]){var u=o;if(i.complete||i.content)i.error?cc._throw(i.error):s.call(u,i);else{var h=Xs.getQueue(i),d=h._callbackTable[l];d?d.unshift(s,u):h.addListener(l,s,u)}}}_(e,f)})}(this.pipeline,t,a,h,d)}Pl.isSceneObj=Il;var Dl=/([a-zA-Z0-9--]+|\S)/,Nl=/^[!,.:;'}\]%\?>]/,zl=/([a-zA-Z0-9--]+|\S)$/,Ul=/[a-zA-Z0-9--]+$/,Gl=/^[a-zA-Z0-9--]/;function Vl(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Hl(e){var t=e.charCodeAt(0);return 9<=t&&t<=13||32===t||133===t||160===t||5760===t||8192<=t&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Wl(e,t){var i=e.measureText(t);return i&&i.width||0}function Xl(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;i<t&&1<a.length;){for(var s=a.length*(i/t)|0,o=a.substr(s),l=t-n(o),c=o,u=0,h=0;i<l&&h++<10;)s*=i/l,s|=0,l=t-n(o=a.substr(s));for(h=0;l<=i&&h++<10;){if(o){var d=Dl.exec(o);u=d?d[0].length:1,c=o}s+=u,l=t-n(o=a.substr(s))}0===(s-=u)&&(s=1,c=c.substr(1));var f=a.substr(0,s),p=void 0;Nl.test(c||o)&&(0===(s-=(p=zl.exec(f))?p[0].length:0)&&(s=1),c=a.substr(s),f=a.substr(0,s)),Gl.test(c)&&(p=Ul.exec(f))&&f!==p[0]&&(s-=p[0].length,c=a.substr(s),f=a.substr(0,s)),0===r.length?r.push(f):0<(f=f.trim()).length&&r.push(f),t=n(a=c||o)}return 0===r.length?r.push(a):0<(a=a.trim()).length&&r.push(a),r}var jl=null,ql="BES bswy:->@",Yl={},Kl=-1,Ql=[],Zl=6e4;function Jl(){for(var e=!0,t=Date.now(),i=Ql.length-1;0<=i;i--){var n=Ql[i],r=n.fontFamilyName;if(t-n.startTime>Zl)cc.warnID(4933,r),n.callback(null,r),Ql.splice(i,1);else{var a=n.refWidth;jl.font="40px "+r,a!==Wl(jl,ql)?(Ql.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(Kl),Kl=-1)}function $l(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(Yl[n])return n;if(!jl){var r=document.createElement("canvas");r.width=100,r.height=100,jl=r.getContext("2d")}var a="40px "+n;jl.font=a;var s=Wl(jl,ql),o=document.createElement("style");o.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",o.textContent=l+"}",document.body.appendChild(o);var c=document.createElement("div"),u=c.style;u.fontFamily=n,c.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(c);var h={fontFamilyName:n,refWidth:s,callback:t,startTime:Date.now()};Ql.push(h),Yl[n]=o,-1===Kl&&(Kl=setInterval(Jl,100))}function ec(t){if("string"!=typeof t.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(t.content)}catch(e){return new Error("JSON Loader: Parse json ["+t.id+"] failed : "+e)}}function tc(e){if(e._owner instanceof cc.Asset)return null;var t=e.content;if(!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var i=e.rawUrl,n=e.imageAsset||new Ls;return n._uuid=e.uuid,n.url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function ic(e,t){if(e._owner instanceof cc.Asset)return null;var i=new cc.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function nc(e){return e.load?e.load(e.content):e.content}function rc(e,t){return e[t]<<8|e[t+1]}var ac={png:tc,jpg:tc,bmp:tc,jpeg:tc,gif:tc,ico:tc,tiff:tc,webp:tc,image:tc,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176!==i[11])return new Error("Invalid magic number in PVR header");var s=i[0],o=i[1],l=i[2];return t=t.slice(s,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:o}},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=rc(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=rc(i,12),a=rc(i,14);return rc(i,8),rc(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},mp3:ic,ogg:ic,wav:ic,m4a:ic,json:ec,ExportJson:ec,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=Ml.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:Pl,prefab:Pl,fire:Pl,scene:Pl,binary:nc,bin:nc,font:$l,eot:$l,ttf:$l,woff:$l,svg:$l,ttc:$l,default:function(){return null}},sc=function(){function t(e){y(this,t),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=Et(e,ac)}return l(t,[{key:"addHandlers",value:function(e){this.extMap=Et(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),t}();sc.ID="Loader",Ks.Loader=sc;var oc="AssetLoader",lc=[],uc=function(){function t(e){y(this,t),this.id=oc,this.async=!0,this.pipeline=null}return l(t,[{key:"handle",value:function(a,s){var o=a.uuid;if(!o)return a.content||null;cc.AssetLibrary.queryAssetInfo(o,function(e,t,i){if(e)s(e);else if(a.url=a.rawUrl=t,a.isRawAsset=i){var n=K(t).toLowerCase();if(!n)return void s(new Error(G(4931,o)));n=n.substr(1);var r=Xs.getQueue(a);lc[0]={queueId:a.queueId,id:t,url:t,type:n,error:null,alias:a,complete:!0},r.append(lc),a.type=n,s(null,a.content)}else a.type="uuid",s(null,a.content)})}}]),t}();function hc(e,t){this.uuid=e,this.type=t}uc.ID=oc,Ks.AssetLoader=uc;var dc=function(){function e(){y(this,e),this._pathToUuid=dt(!0)}return l(e,[{key:"getUuid",value:function(e,t){e=cc.url.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ct(r.type,t))return r.uuid}}else{if(!t||Ct(i.type,t))return i.uuid}return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=cc.url.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n,r,a=this._pathToUuid,s=[];for(var o in a)if(o.startsWith(e)&&(r=e,!((n=o).length>r.length)||47===n.charCodeAt(r.length))||!e){var l=a[o];if(Array.isArray(l))for(var c=0;c<l.length;c++){var u=l[c];(!t||Ct(u.type,t))&&(s.push(u.uuid),i&&i.push(o))}else(!t||Ct(l.type,t))&&(s.push(l.uuid),i&&i.push(o))}return s}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-cc.path.extname(e).length));var r=new hc(t,i);jt(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],s=i[a];if(Array.isArray(s))for(var o=0;o<s.length;o++){var l=s[o];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(s.uuid===e)return t.path=a,t.type=s.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=dt(!0)}}]),e}();function fc(e,t){var i=cc.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,fc(a,t))}}}function pc(e,t){if(e._uuid){var i=cc.loader._getReferenceKey(e);t[i]||(t[i]=!0,fc(i,t))}}function _c(e,t){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var r=e[i[n]];if("object"===ye(r)&&r)if(Array.isArray(r))for(var a=0;a<r.length;a++){var s=r[a];s instanceof cc.RawAsset&&pc(s,t)}else if(r.constructor&&r.constructor!==Object)r instanceof cc.RawAsset&&pc(r,t);else for(var o=Object.getOwnPropertyNames(r),l=0;l<o.length;l++){var c=r[o[l]];c instanceof cc.RawAsset&&pc(c,t)}}}function vc(e,t){for(var i=0;i<e._components.length;i++)_c(e._components[i],t);for(var n=0;n<e._children.length;n++)vc(e._children[n],t)}function mc(e){var t={};return fc(e,t),Object.keys(t)}var yc=Object.create(null);function gc(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}yc.assets=new dc,yc.internal=new dc;var bc={url:null,raw:!1};function Sc(e){var t,i,n;if("object"===ye(e)){if((i=e).url)return i;t=e.uuid}else i={},t=e;return n=i.type?"uuid"===i.type:cc.AssetLibrary._uuidInSettings(t),cc.AssetLibrary._getAssetInfoInRuntime(t,bc),i.url=n?bc.url:t,bc.url&&"uuid"===i.type&&bc.raw?(i.type=null,i.isRawAsset=!0):n||(i.isRawAsset=!0),i}var Tc=[],Ec=[],xc=function(e){function r(){var e;y(this,r);var t=new uc,i=new Ll,n=new sc;return(e=T(this,S(r).call(this,[t,i,n]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=gc,e.assetLoader=t,e.md5Pipe=null,e.downloader=i,e.loader=n,e.onProgress=null,e._assetTables=yc,e._autoReleaseSetting=dt(!0),e}return p(r,Ks),l(r,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,n){void 0===n&&(n=t,t=this.onProgress||null);var r,a=this,s=!1;e instanceof Array||(e=e?(s=!0,[e]):[]);for(var i=Tc.length=0;i<e.length;++i){var o=e[i];if(o&&o.id&&(cc.warnID(4920,o.id),o.uuid||o.url||(o.url=o.id)),(r=Sc(o)).url||r.uuid){var l=this._cache[r.url];Tc.push(l||r)}}var c=Xs.create(this,t,function(t,i){ti(function(){if(n){if(s){var e=r.url;n.call(a,i.getError(e),i.getContent(e))}else n.call(a,t,i);n=null}i.destroy()})});Xs.initQueueDeps(c),c.append(Tc),Tc.length=0}},{key:"flowInDeps",value:function(i,e,n){for(var t=Ec.length=0;t<e.length;++t){var r=Sc(e[t]);if(r.url||r.uuid){var a=this._cache[r.url];a?Ec.push(a):Ec.push(r)}}var s=Xs.create(this,i?function(e,t,i){s._ownerQueue&&s._ownerQueue.onProgress&&s._ownerQueue._childOnProgress(i)}:null,function(e,t){n(e,t),i&&i.deps&&(i.deps.length=0),t.destroy()});if(i){var o=Xs.getQueue(i);s._ownerQueue=o._ownerQueue||o}var l=s.append(Ec,i);return Ec.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var s=this,o=s._getResUuid(e,t,i,!0);o?this.load({type:"uuid",uuid:o},n,function(e,t){t&&s.setAutoReleaseRecursively(o,!1),r&&r(e,t)}):s._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,l){if(5!==arguments.length&&(l=n,n=i,i="assets"),yc[i]){var r=this._parseLoadResArgs(t,n,l);t=r.type,n=r.onProgress,l=r.onComplete;var a=[],s=yc[i].getUuidArray(e,t,a);this._loadResUuids(s,n,function(e,t,i){for(var n=t.length,r=0;r<n;++r)if(t[r]instanceof cc.SpriteAtlas){var a=t[r].getSpriteFrames();for(var s in a){var o=a[s];t.push(o),i&&i.push("".concat(i[r],"/").concat(o.name))}}l&&l(e,t,i)},a)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var s=[],o=0;o<e.length;o++){var l=e[o],c=this._getResUuid(l,t,i,!0);if(!c)return void this._urlNotFound(l,t,r);s.push(c)}this._loadResUuids(s,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=mc(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cc.Asset){var a=e.nativeUrl;a&&this.release(a),e.destroy()}0}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):cc.errorID(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(yc[i=i||"assets"])for(var n=yc[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=Ks.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=mc(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}else 0}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r=yc[i=i||"assets"];if(!e||!r)return null;var a=e.indexOf("?");-1!==a&&(e=e.substr(0,a));var s=r.getUuid(e,t);if(!s){var o=cc.path.extname(e);o&&(e=e.slice(0,-o.length),(s=r.getUuid(e,t))&&!n&&cc.warnID(4901,e,o))}return s}},{key:"_getReferenceKey",value:function(e){var t;return"object"===ye(e)?t=e._uuid||null:"string"==typeof e&&(t=this._getResUuid(e,null,null,!0)||e),t?(cc.AssetLibrary._getAssetInfoInRuntime(t,bc),this._cache[bc.url]?bc.url:t):(cc.warnID(4800,e),t)}},{key:"_urlNotFound",value:function(t,i,n){ti(function(){t=cc.url.normalize(t);var e="".concat(i?ft(i):"Asset",' in "resources/').concat(t,'" does not exist.');n&&n(new Error(e),[])})}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ct(e,cc.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,l,c){if(0<e.length){var u=this,h=e.map(function(e){return{type:"uuid",uuid:e}});this.load(h,t,function(e,t){if(l){for(var i=[],n=c&&[],r=0;r<h.length;++r){var a=h[r].uuid,s=u._getReferenceKey(a),o=t.getContent(s);o&&(u.setAutoReleaseRecursively(a,!1),i.push(o),n&&n.push(c[r]))}c?l(e,i,n):l(e,i)}})}else l&&ti(function(){c?l(null,[],[]):l(null,[])})}}]),r}(),Ac=cc.loader=new xc;function Cc(i,n){i.loaded?n&&n():i.nativeUrl?Ac.load({url:i.nativeUrl,skips:i.isCompressed?void 0:["Loader"]},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n()}var wc,Rc,kc,Oc,Fc,Lc,Bc,Mc,Ic,Pc,Dc,Nc,zc,Uc,Gc,Vc,Hc,Wc,Xc,jc=Object.freeze({loadImage:function(e,i,n){U(!!e,3103);var r=Ac.getRes(e);return r?r.loaded?i&&i.call(n,null,r):r.once("load",function(){i&&i.call(n,null,r)},n):(r=new Ls,Ac.load({url:e,imageAsset:r},function(e,t){if(e)return i&&i.call(n,e||new Error("Unknown error")),r;i&&i.call(n,null,t)})),r},cacheImage:function(e,t){if(e&&t){var i=new Ls(t),n={id:e,url:e,error:null,content:i,complete:!1};return Ac.flowOut(n),i}},postLoadImage:Cc}),qc=new et("Tex"),Yc=[{buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:1,height:1,depth:1},texSubres:{baseMipLevel:1,levelCount:1,baseArrayLayer:0,layerCount:1}}],Kc=un("cc.TextureBase")((Uc=zc=function(e){function i(){var e,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return y(this,i),v(e=T(this,S(i).call(this)),"_format",kc,d(d(e))),v(e,"_premultiplyAlpha",Oc,d(d(e))),v(e,"_flipY",Fc,d(d(e))),v(e,"_minFilter",Lc,d(d(e))),v(e,"_magFilter",Bc,d(d(e))),v(e,"_mipFilter",Mc,d(d(e))),v(e,"_wrapS",Ic,d(d(e))),v(e,"_wrapT",Pc,d(d(e))),v(e,"_wrapR",Dc,d(d(e))),v(e,"_anisotropy",Nc,d(d(e))),e._texture=null,e._textureView=null,e._potientialWidth=0,e._potientialHeight=0,e._mipmapLevel=1,e._id=void 0,e._samplerInfo=[],e._flipY=t,e._id=qc.getNewId(),e.loaded=!1,e}return p(i,qn),l(i,[{key:"width",get:function(){return this._texture?this._texture.width:0}},{key:"height",get:function(){return this._texture?this._texture.height:0}},{key:"isCompressed",get:function(){return this._format>=ms.RGB_ETC1&&this._format<=ms.RGBA_PVRTC_4BPPV1}}]),l(i,[{key:"reset",value:function(e){void 0===e.format&&(e.format=ms.RGBA8888),void 0===e.mipmapLevel&&(e.mipmapLevel=1),this._potientialWidth=e.width,this._potientialHeight=e.height,this._format=e.format,this._mipmapLevel=e.mipmapLevel,this._recreateTexture()}},{key:"create",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:ms.RGBA8888,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:i,mipmapLevel:n})}},{key:"getImpl",value:function(){return this._texture}},{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"hasPremultipliedAlpha",value:function(){return this._premultiplyAlpha||!1}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Os.addressU]=e,this._wrapT=t,this._samplerInfo[Os.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Os.addressW]=i)}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Os.minFilter]=e,this._magFilter=t,this._samplerInfo[Os.magFilter]=t}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Os.mipFilter]=e,this._samplerInfo[Os.maxLOD]=e===Ss.NONE?0:1e3}},{key:"setFlipY",value:function(e){this._flipY=e}},{key:"setPremultiplyAlpha",value:function(e){this._premultiplyAlpha=e}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Os.maxAnisotropy]=e}},{key:"destroy",value:function(){return this._destroyTexture(),_(S(i.prototype),"destroy",this).call(this)}},{key:"getGFXTexture",value:function(){return this._texture}},{key:"getGFXTextureView",value:function(){return this._textureView}},{key:"getGFXSamplerInfo",value:function(){return this._samplerInfo}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+(this._premultiplyAlpha?1:0)+","+this._mipFilter+","+this._anisotropy+","+(this._flipY?1:0)}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),6<=i.length&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4])),this._premultiplyAlpha=49===i[5].charCodeAt(0)),8<=i.length&&(this.setMipFilter(parseInt(i[6])),this.setAnisotropy(parseInt(i[7]))),9<=i.length&&(this._flipY=49===i[8].charCodeAt(0))}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if(this._texture&&!(this._texture.mipLevel<=t)){var n=this._getGlobalDevice();if(n){var r=Yc[0];r.texExtent.width=this._texture.width>>t,r.texExtent.height=this._texture.height>>t,r.texSubres.baseMipLevel=t,r.texSubres.baseArrayLayer=i,e instanceof ArrayBuffer?n.copyBuffersToTexture([e],this._texture,Yc):n.copyTexImagesToTexture([e],this._texture,Yc)}}}},{key:"_getGlobalDevice",value:function(){return cc.director.root&&cc.director.root.device}},{key:"_assignImage",value:function(i,n,r){var a=this,e=function(){var e,t=i.data;t&&(e=ArrayBuffer.isView(t)?t.buffer:t,a.uploadData(e,n,r))};if(i.loaded)e();else{if(i.once("load",function(){e()}),!this.isCompressed){var t=cc.builtinResMgr.get("black-texture").image;this.uploadData(t.data,n,r)}Cc(i)}}},{key:"_getTextureCreateInfo",value:function(){return{type:Aa.TEX2D,usage:wa.SAMPLED|wa.TRANSFER_DST,format:this._format,width:this._potientialWidth,height:this._potientialHeight,mipLevel:this._mipmapLevel,flags:this._mipFilter!==Ss.NONE?Fa.GEN_MIPMAP:Fa.NONE}}},{key:"_getTextureViewCreateInfo",value:function(){return{texture:this._texture,type:Ba.TV2D,format:this._format}}},{key:"_recreateTexture",value:function(){this._destroyTexture();var e=this._getGlobalDevice();e&&(this._texture=e.createTexture(this._getTextureCreateInfo()),this._textureView=e.createTextureView(this._getTextureViewCreateInfo()))}},{key:"_destroyTexture",value:function(){this._textureView&&(this._textureView.destroy(),this._textureView=null),this._texture&&(this._texture.destroy(),this._texture=null)}}]),i}(),zc.PixelFormat=ms,zc.WrapMode=gs,zc.Filter=Ss,kc=c((Rc=Uc).prototype,"_format",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ms.RGBA8888}}),Oc=c(Rc.prototype,"_premultiplyAlpha",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fc=c(Rc.prototype,"_flipY",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lc=c(Rc.prototype,"_minFilter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ss.LINEAR}}),Bc=c(Rc.prototype,"_magFilter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ss.LINEAR}}),Mc=c(Rc.prototype,"_mipFilter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ss.NONE}}),Ic=c(Rc.prototype,"_wrapS",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gs.REPEAT}}),Pc=c(Rc.prototype,"_wrapT",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gs.REPEAT}}),Dc=c(Rc.prototype,"_wrapR",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gs.REPEAT}}),Nc=c(Rc.prototype,"_anisotropy",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 16}}),wc=Rc))||wc;cc.TextureBase=Kc;var Qc,Zc=(Gc=un("cc.Texture2D"),Vc=hn([Ls]),Gc((Xc=c((Wc=function(e){function a(){var e;return y(this,a),v(e=T(this,S(a).call(this,!0)),"_mipmaps",Xc,d(d(e))),e}return p(a,Kc),l(a,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var i=this;if(this._mipmaps=e,0<this._mipmaps.length){var t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,t){i._assignImage(e,t)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),l(a,[{key:"onLoaded",value:function(){this.initialize(),this.loaded=!0,this.emit("load")}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],_(S(a.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:_(S(a.prototype),"_serialize",this).call(this,t),mipmaps:this._mipmaps.map(function(e){return t?Editor.Utils.UuidUtils.compressUuid(e._uuid,!0):e._uuid})}}},{key:"_deserialize",value:function(e,t){var i=e;_(S(a.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]=new Ls;var r=i.mipmaps[n];t.result.push(this._mipmaps,"".concat(n),r)}}},{key:"initialize",value:function(){this.mipmaps=this._mipmaps}}]),a}()).prototype,"_mipmaps",[Vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hc=Wc))||Hc);cc.Texture2D=Zc;var Jc,$c,eu,tu=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],iu=un("cc.SpriteFrame")(Qc=function(e){function s(){var e;return y(this,s),(e=T(this,S(s).call(this))).vertices=null,e.uv=[],e.uvSliced=[],e._rect=new Ur,e._offset=new Lr,e._originalSize=new zr,e._rotated=!1,e._capInsets=[0,0,0,0],e._original=null,e._atlasUuid="",e}return p(s,Zc),l(s,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]=e,this.image&&this._calculateSlicedUV()}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]=e,this.image&&this._calculateSlicedUV()}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]=e,this.image&&this._calculateSlicedUV()}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]=e,this.image&&this._calculateSlicedUV()}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"original",get:function(){return this._original}}]),l(s,[{key:"textureLoaded",value:function(){return this.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this._rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this._rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this._originalSize.set(e)}},{key:"_setBorder",value:function(e,t,i,n){this._capInsets[0]=e,this._capInsets[3]=t,this._capInsets[2]=i,this._capInsets[1]=n}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){we.set(this._offset,e.x,e.y)}},{key:"clone",value:function(){var e=new s;e.name=this.name,e.atlasUuid=this.atlasUuid,e.setOriginalSize(this._originalSize),e.setRect(this._rect);var t=this._capInsets;return e._setBorder(t[0],t[3],t[2],t[1]),e.setOffset(this._offset),e._mipmaps=this._mipmaps,e.onLoaded(),e}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width&&cc.errorID(3300,e.url+"/"+this.name,i,e.width),n>e.height&&cc.errorID(3400,e.url+"/"+this.name,n,e.height)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.image.width,i=this.image.height,n=this._capInsets[0],r=this._capInsets[2],a=e.width-n-r,s=this._capInsets[1],o=this._capInsets[3],l=e.height-s-o,c=this.uvSliced;if(c.length=0,this._rotated){tu[0].u=e.x/t,tu[1].u=(e.x+o)/t,tu[2].u=(e.x+o+l)/t,tu[3].u=(e.x+e.height)/t,tu[3].v=e.y/i,tu[2].v=(e.y+n)/i,tu[1].v=(e.y+n+a)/i,tu[0].v=(e.y+e.width)/i;for(var u=0;u<4;++u)for(var h=tu[u],d=0;d<4;++d){var f=tu[3-d];c.push({u:h.u,v:f.v})}}else{tu[0].u=e.x/t,tu[1].u=(e.x+n)/t,tu[2].u=(e.x+n+a)/t,tu[3].u=(e.x+e.width)/t,tu[3].v=e.y/i,tu[2].v=(e.y+s)/i,tu[1].v=(e.y+s+l)/i,tu[0].v=(e.y+e.height)/i;for(var p=0;p<4;++p)for(var _=tu[p],v=0;v<4;++v){var m=tu[v];c.push({u:m.u,v:_.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.image,i=this.uv,n=t.width,r=t.height;if(this._rotated){var a=0===n?0:e.x/n,s=0===n?0:(e.x+e.height)/n,o=0===r?0:(e.y+e.width)/r,l=0===r?0:e.y/r;i[0]=a,i[1]=l,i[2]=a,i[3]=o,i[4]=s,i[5]=l,i[6]=s,i[7]=o}else{var c=0===n?0:e.x/n,u=0===n?0:(e.x+e.width)/n,h=0===r?0:(e.y+e.height)/r,d=0===r?0:e.y/r;i[0]=c,i[1]=h,i[2]=u,i[3]=h,i[4]=c,i[5]=d,i[6]=u,i[7]=d}var f=this.vertices;if(f){f.nu.length=0;for(var p=f.nv.length=0;p<f.u.length;p++)f.nu[p]=f.u[p]/n,f.nv[p]=f.v[p]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i=this._rect,n=this._offset,r=this._originalSize,a=this._uuid;return a&&e&&(a=Editor.Utils.UuidUtils.compressUuid(a,!0)),this.vertices&&(t={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{base:_(S(s.prototype),"_serialize",this).call(this,e),name:this._name,texture:a||void 0,atlas:e?void 0:this._atlasUuid,rect:i?[i.x,i.y,i.width,i.height]:void 0,offset:n?[n.x,n.y]:void 0,originalSize:r?[r.width,r.height]:void 0,rotated:this._rotated?this._rotated:void 0,capInsets:this._capInsets,vertices:t}}},{key:"_deserialize",value:function(e,t){var i=e;_(S(s.prototype),"_deserialize",this).call(this,i.base,t);var n=i.rect;n&&this.setRect(new Ur(n[0],n[1],n[2],n[3])),i.offset&&this.setOffset(new Lr(i.offset[0],i.offset[1])),i.originalSize&&this.setOriginalSize(new cc.Size(i.originalSize[0],i.originalSize[1])),this._rotated=!!i.rotated,this._name=i.name;var r=i.capInsets;r&&(this._capInsets[0]=r[0],this._capInsets[1]=r[1],this._capInsets[2]=r[2],this._capInsets[3]=r[3]),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"initialize",value:function(){_(S(s.prototype),"initialize",this).call(this);var e=this,t=e.width,i=e.height;e._rect?e.checkRect(this.image):e.setRect(new Ur(0,0,t,i)),e._originalSize||e.setOriginalSize(new zr(t,i)),e._offset||e.setOffset(new Lr(0,0)),e._calculateUV()}}]),s}())||Qc;cc.SpriteFrame=iu;var nu,ru,au,su=un("cc.SpriteAtlas")((eu=c(($c=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"spriteFrames",eu,d(d(t))),t}return p(a,qn),l(a,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(0<e.length){var t=this.spriteFrames[e[0]];return t?t.image:null}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],s=a?a._uuid:"",o=s.split("@"),l=o[0],c=o[1];s&&e&&(s=Editor.Utils.UuidUtils.compressUuid(l,!0),c&&(s+="@".concat(c))),t.push(c),t.push(s)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=dt();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),a}()).prototype,"spriteFrames",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dt()}}),Jc=$c))||Jc;cc.SpriteAtlas=su;var ou,lu,cu,uu=un("cc.TextAsset")((au=c((ru=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"text",au,d(d(t))),t}return p(a,qn),l(a,[{key:"toString",value:function(){return this.text}}]),a}()).prototype,"text",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nu=ru))||nu;cc.TextAsset=uu;var hu=un("cc.JsonAsset")((cu=c((lu=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"json",cu,d(d(t))),t}return p(a,qn),a}()).prototype,"json",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ou=lu))||ou;cc.JsonAsset=hu;var du="0123456789abcdef".split(""),fu=["","","",""],pu=fu.concat(fu,"-",fu,"-",fu,"-",fu,"-",fu,fu,fu),_u=pu.map(function(e,t){return"-"===e?NaN:t}).filter(isFinite);function vu(e){var t=e.split("@")[0];if(22!==t.length)return e;pu[0]=e[0],pu[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=Ht[e.charCodeAt(i)],a=Ht[e.charCodeAt(i+1)];pu[_u[n++]]=du[r>>2],pu[_u[n++]]=du[(3&r)<<2|a>>4],pu[_u[n++]]=du[15&a]}return e.replace(t,pu.join(""))}var mu="MD5Pipe",yu=/(\.[^.\n\\/]*)$/,gu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-]{8,})/;var bu=function(){function n(e,t,i){y(this,n),this.id=mu,this.async=!1,this.pipeline=null,this.md5AssetsMap=e,this.md5NativeAssetsMap=t,this.libraryBase=i}return l(n,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i,n=(i=e.match(gu))?i[1]:"";if(n){var r=(!e.startsWith(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[n];if(r)if(t){var a=cc.path.dirname(e),s=cc.path.basename(e);e="".concat(a,".").concat(r,"/").concat(s)}else{var o=!1;e=e.replace(yu,function(e,t){return o=!0,"."+r+t}),o||(e=e+"."+r)}}return e}}]),n}();bu.ID=mu,Ks.MD5Pipe=bu;var Su="",Tu="",Eu=dt(!0);function xu(e,t){this.url=e,this.type=t}var Au,Cu={_uuidToAsset:{},loadAsset:function(n,r,e){if("string"!=typeof n)return ti(r,new Error("[AssetLibrary] uuid must be string"),null);var t={uuid:n,type:"uuid"};e&&e.existingAsset&&(t.existingAsset=e.existingAsset),cc.loader.load(t,function(e,t){if(e||!t)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error"));else if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(n);t.scene.dependAssets=mc(i)}r&&r(e,t)})},getLibUrlNoExt:function(e,t){return e=vu(e),(t?Tu+"assets/":Su)+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){0},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=Eu[e];return i&&!Ct(i.type,cc.Asset)?(t.url=Tu+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in Eu},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,a){var s=""+((new Date).getTime()+Math.random()),t={uuid:s,type:"uuid",content:e,skips:[cc.loader.assetLoader.id,cc.loader.downloader.id]};cc.loader.load(t,function(e,t){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else{if(t.constructor===cc.SceneAsset){var i=cc.loader._getReferenceKey(s);t.scene.dependAssets=mc(i)}if((r=t)&&(r.constructor===cc.SceneAsset||r instanceof cc.Scene)){var n=cc.loader._getReferenceKey(s);cc.loader.removeItem(n)}}var r;t._uuid="",a&&a(e,t)})},getAssetByUuid:function(e){return Cu._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),Su=cc.path.stripSep(t)+"/",Tu=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=dt(!0),a=i.import;for(n=0;n<a.length;n+=2)r[vu(a[n])]=a[n+1];var s=dt(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2)s[vu(a[n])]=a[n+1];var o=new bu(r,s,Su);cc.loader.insertPipeAfter(cc.loader.assetLoader,o),cc.loader.md5Pipe=o}var l=Ac._assetTables;for(var c in l)l[c].reset();var u=e.rawAssets;if(u)for(var h in u){var d=u[h];for(var f in d){var p=d[f],_=p[0],v=p[1],m=Bt(v);if(m){Eu[f]=new xu(h+"/"+_,m);var y=1===p[2];l[h]||(l[h]=new dc),l[h].add(_,f,m,!y)}else cc.error("Cannot get",v)}}e.packedAssets&&ro(e.packedAssets),cc.url._init(e.mountPaths&&e.mountPaths.assets||Tu+"assets")}};cc.AssetLibrary=Cu;var wu,Ru,ku,Ou,Fu,Lu=un("cc.Font")(Au=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,qn),t}())||Au;cc.Font=Lu;var Bu,Mu,Iu,Pu,Du,Nu,zu,Uu,Gu=(wu=un("cc.TTFFont"),Ru=hn({type:cc.String,override:!0}),wu((Fu=c((Ou=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_fontFamily",Fu,d(d(t))),t}return p(a,Lu),l(a,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),a}()).prototype,"_fontFamily",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(Ou.prototype,"_nativeAsset",[Ru],Object.getOwnPropertyDescriptor(Ou.prototype,"_nativeAsset"),Ou.prototype),ku=Ou))||ku);cc.TTFFont=Gu;var Vu,Hu=(Bu=un("cc.BitmapFont"),Mu=hn({type:iu}),Bu((Du=c((Pu=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"fntDataStr",Du,d(d(t))),v(t,"spriteFrame",Nu,d(d(t))),v(t,"fontSize",zu,d(d(t))),v(t,"fntConfig",Uu,d(d(t))),t}return p(a,Lu),a}()).prototype,"fntDataStr",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nu=c(Pu.prototype,"spriteFrame",[Mu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=c(Pu.prototype,"fontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Uu=c(Pu.prototype,"fntConfig",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iu=Pu))||Iu);cc.BitmapFont=Hu;var Wu=un("cc.LabelAtlas")(Vu=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Hu),t}())||Vu;function Xu(e,t){}cc.LabelAtlas=Wu;var ju=function(){function i(e,t){y(this,i),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}return l(i,[{key:"unuse",value:function(){this.type=i.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=i.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),i}();ju.NO_TYPE="no_type",ju.TOUCH="touch",ju.MOUSE="mouse",ju.KEYBOARD="keyboard",ju.ACCELERATION="acceleration",ju.NONE=0,ju.CAPTURING_PHASE=1,ju.AT_TARGET=2,ju.BUBBLING_PHASE=3,cc.Event=ju;var qu=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ju.MOUSE,t))).movementX=0,i.movementY=0,i._eventType=void 0,i._button=0,i._x=0,i._y=0,i._prevX=0,i._prevY=0,i._scrollX=0,i._scrollY=0,i._eventType=e,i}return p(n,ju),l(n,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new Lr),we.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new Lr),we.set(e,this._x,cc.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new Lr),we.set(e,this._x,this._y),cc.view._convertPointWithScale(e),e}},{key:"_setPrevCursor",value:function(e,t){this._prevX=e,this._prevY=t}},{key:"getPreviousLocation",value:function(e){return e||(e=new Lr),we.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Lr),we.set(e,this._prevX,this._prevY),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Lr),we.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new Lr),we.set(e,(this._x-this._prevX)/cc.view.getScaleX(),(this._y-this._prevY)/cc.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/cc.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/cc.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._y-e.y)/cc.view.getScaleY()}}]),n}();qu.NONE=0,qu.DOWN=1,qu.UP=2,qu.MOVE=3,qu.SCROLL=4,qu.BUTTON_LEFT=0,qu.BUTTON_RIGHT=2,qu.BUTTON_MIDDLE=1,qu.BUTTON_4=3,qu.BUTTON_5=4,qu.BUTTON_6=5,qu.BUTTON_7=6,qu.BUTTON_8=7;var Yu=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ju.TOUCH,t))).touch=null,i.currentTouch=null,i._eventCode=0,i.simulate=!1,i._touches=void 0,i._eventCode=0,i._touches=e||[],i}return p(n,ju),l(n,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"_setEventCode",value:function(e){this._eventCode=e}},{key:"_setTouches",value:function(e){this._touches=e}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new Lr}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new Lr}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new Lr}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new Lr}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new Lr}},{key:"getDeltaX",value:function(e){return this.touch?this.touch.getDelta(e).x:0}},{key:"getDeltaY",value:function(e){return this.touch?this.touch.getDelta(e).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),n}();Yu.MAX_TOUCHES=5,Yu.BEGAN=0,Yu.MOVED=1,Yu.ENDED=2,Yu.CANCELLED=3;var Ku=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,ju.ACCELERATION,t))).acc=void 0,i.acc=e,i}return p(n,ju),n}(),Qu=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,ju.KEYBOARD,i))).keyCode=void 0,n.rawEvent=void 0,n.isPressed=void 0,"number"==typeof e?n.keyCode=e:(n.keyCode=e.keyCode,n.rawEvent=e),n.isPressed=t,n}return p(r,ju),r}();ju.EventMouse=qu,ju.EventTouch=Yu,ju.EventAcceleration=Ku,ju.EventKeyboard=Qu;var Zu=function(){function n(e,t,i){y(this,n),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}return l(n,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){cc.assertID(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===cc.EventListener.TOUCH_ONE_BY_ONE?i=new eh:t===cc.EventListener.TOUCH_ALL_AT_ONCE?i=new th:t===cc.EventListener.MOUSE?i=new $u:t===cc.EventListener.KEYBOARD?i=new nh:t===cc.EventListener.ACCELERATION&&(i=new ih(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),l(n,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),n}();Zu.UNKNOWN=0,Zu.TOUCH_ONE_BY_ONE=1,Zu.TOUCH_ALL_AT_ONCE=2,Zu.KEYBOARD=3,Zu.MOUSE=4,Zu.ACCELERATION=6,Zu.CUSTOM=8,Zu.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var Ju=Zu.ListenerID,$u=function(e){function i(){var t;return y(this,i),(t=T(this,S(i).call(this,Zu.MOUSE,Ju.MOUSE,null))).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,Zu),l(i,[{key:"_callback",value:function(e){var t=cc.Event.EventMouse;switch(e._eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new i;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),i}(),eh=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Zu.TOUCH_ONE_BY_ONE,Ju.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return p(t,Zu),l(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(cc.logID(1801),!1)}}]),t}(),th=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Zu.TOUCH_ALL_AT_ONCE,Ju.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return p(t,Zu),l(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(cc.logID(1802),!1)}}]),t}(),ih=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Zu.ACCELERATION,Ju.ACCELERATION,null)))._onAccelerationEvent=null,t._onEvent=function(e){return t._callback(e)},t._onAccelerationEvent=e,t}return p(i,Zu),l(i,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return cc.assertID(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new i(this._onAccelerationEvent)}}]),i}(),nh=function(e){function i(){var t;return y(this,i),(t=T(this,S(i).call(this,Zu.KEYBOARD,Ju.KEYBOARD,null))).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}return p(i,Zu),l(i,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new i;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(cc.logID(1800),!1)}}]),i}(),rh=(cc.EventListener=Zu).ListenerID,ah=function(){function e(){y(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return l(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var sh=new(function(){function e(){y(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._nodePriorityMap=dt(!0),this._globalZOrderNodeMap=[],this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyNodes=[],this._inDispatch=0,this._isEnabled=!1,this._nodePriorityIndex=0,this._internalCustomListenerIDs=[]}return l(e,[{key:"pauseTarget",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s._setPaused(!0)}}if(!0===t){var o=e.children;if(o){var l=o,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;this.pauseTarget(d,!0)}}}}else cc.warnID(3506)}},{key:"resumeTarget",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(e instanceof cc._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i){var n=i,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s._setPaused(!1)}}if(this._setDirtyForNode(e),!0===t&&0<e.children.length){var o=e.children;if(o){var l=o,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;this.resumeTarget(d,!0)}}}}else cc.warnID(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(cc.assertID(e&&t,3503),cc.js.isNumber(t)||t instanceof cc._BaseNode){if(e instanceof cc.EventListener){if(e._isRegistered())return void cc.logID(3505)}else cc.assertID(!cc.js.isNumber(t),3504),e=cc.EventListener.create(e);if(e.checkAvailable()){if(cc.js.isNumber(t)){if(0===t)return void cc.logID(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e);return e}}else cc.warnID(3506)}},{key:"addCustomListener",value:function(e,t){var i=Zu.create({event:cc.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){for(var t=!1,i=this._listenersMap,n=0,r=Object.keys(i);n<r.length;n++){var a=r[n],s=i[a],o=s.getFixedPriorityListeners(),l=s.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(l,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(o,e))&&this._setDirty(e._getListenerID(),1),s.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[a]),t)break}if(!t)for(var c=this._toAddedListeners,u=0,h=c.length;u<h;u++){var d=c[u];if(d===e){cc.js.array.remove(c,d),d._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(cc.js.isNumber(e)||e instanceof cc._BaseNode)if(void 0!==e._id){delete this._nodePriorityMap[e._id],cc.js.array.remove(this._dirtyNodes,e);var i=this._nodeListenersMap[e._id];if(i){var n=cc.js.array.copy(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;this.removeListener(o)}delete this._nodeListenersMap[e._id]}for(var l=this._toAddedListeners,c=0;c<l.length;){var u=l[c];u._getSceneGraphPriority()===e?(u._setSceneGraphPriority(null),u._setRegistered(!1),l.splice(c,1)):++c}if(!0===t){var h=e.getChildren(),d=Array.isArray(h),f=0;for(h=d?h:h[Symbol.iterator]();;){var p;if(d){if(f>=h.length)break;p=h[f++]}else{if((f=h.next()).done)break;p=f.value}var _=p;this.removeListeners(_,!0)}}}else e===cc.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(rh.TOUCH_ONE_BY_ONE):e===cc.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(rh.TOUCH_ALL_AT_ONCE):e===cc.EventListener.MOUSE?this._removeListenersForListenerID(rh.MOUSE):e===cc.EventListener.ACCELERATION?this._removeListenersForListenerID(rh.ACCELERATION):e===cc.EventListener.KEYBOARD?this._removeListenersForListenerID(rh.KEYBOARD):cc.logID(3501);else cc.warnID(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e)for(var i=this._listenersMap,n=0,r=Object.keys(i);n<r.length;n++){var a=i[r[n]].getFixedPriorityListeners();if(a)if(-1!==a.indexOf(e))return null!=e._getSceneGraphPriority()&&cc.logID(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(cc.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t,i,n=(t=ju,(i=e.type)===t.ACCELERATION?rh.ACCELERATION:i===t.KEYBOARD?rh.KEYBOARD:i.startsWith(t.MOUSE)?rh.MOUSE:(i.startsWith(t.TOUCH)&&cc.logID(2e3),""));this._sortEventListeners(n);var r=this._listenersMap[n];null!=r&&(this._dispatchEventToListeners(r,this._onListenerCallback,e),this._onUpdateListeners(r)),this._inDispatch--}else cc.errorID(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new cc.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){if(void 0!==this._nodeListenersMap[e.uuid]&&this._dirtyNodes.push(e),0<e.children.length)for(var t=e.children,i=0,n=t?t.length:0;i<n;i++)this._setDirtyForNode(t[i])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new ah,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&cc.logID(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){if(0!==this._dirtyNodes.length){for(var e=this._dirtyNodes,t=this._nodeListenersMap,i=0,n=e.length;i<n;i++){var r=t[e[i]._id];if(r)for(var a=0,s=r.length;a<s;a++){var o=r[a];o&&this._setDirty(o._getListenerID(),2)}}this._dirtyNodes.length=0}}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=0;i<e.length;)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.remove(e,t):++i}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=0;a<r.length;){var s=r[a];s&&s._getListenerID()===e?cc.js.array.remove(r,s):++a}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;if(i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t)){var n=cc.director.getScene();n&&this._sortListenersOfSceneGraphPriority(e,n)}}},{key:"_sortListenersOfSceneGraphPriority",value:function(e,t){var i=this._getListeners(e);if(i){var n=i.getSceneGraphPriorityListeners();n&&0!==n.length&&(this._nodePriorityIndex=0,this._nodePriorityMap=dt(!0),this._visitTarget(t,!0),i.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes))}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=sh._nodePriorityMap,n=e._getSceneGraphPriority(),r=t._getSceneGraphPriority();return t&&r&&i[r._id]?e&&n&&i[n._id]?i[r._id]-i[n._id]:1:-1}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(0<=i[n]._getFixedPriority());)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=0;r<i.length;){var a=i[r];if(a._isRegistered())++r;else{cc.js.array.remove(i,a);var s=n.indexOf(a);-1!==s&&n.splice(s,1)}}if(t)for(var o=0;o<t.length;){var l=t[o];if(l._isRegistered())++o;else{cc.js.array.remove(t,l);var c=n.indexOf(l);-1!==c&&n.splice(c,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(cc.assertID(0<t,3508),!(1<t)){var i;(i=this._listenersMap[rh.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[rh.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),cc.assertID(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){var e=this._toRemovedListeners,t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=this._listenersMap[a._getListenerID()];if(s){var o=s.getFixedPriorityListeners(),l=s.getSceneGraphPriorityListeners();if(l){var c=l.indexOf(a);-1!==c&&l.splice(c,1)}if(o){var u=o.indexOf(a);-1!==u&&o.splice(u,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.currentTouch;i.currentTarget=e._getSceneGraphPriority();var r,a=!1,s=i.getEventCode();return s===Yu.BEGAN?e.onTouchBegan&&(a=e.onTouchBegan(n,i))&&e._isRegistered()&&e._claimedTouches.push(n):0<e._claimedTouches.length&&-1!==(r=e._claimedTouches.indexOf(n))&&(a=!0,s===Yu.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):s===Yu.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1)):s===Yu.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1))),i.isStopped()?(sh._updateTouchListeners(i),!0):!!(a&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(rh.TOUCH_ONE_BY_ONE),this._sortEventListeners(rh.TOUCH_ALL_AT_ONCE);var t=this._getListeners(rh.TOUCH_ONE_BY_ONE),i=this._getListeners(rh.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=cc.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t){var s=n,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;e.currentTouch=u,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}}i&&0<r.length&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===Yu.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===Yu.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===Yu.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===Yu.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(sh._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(cc.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),s=0;if(r&&0!==r.length)for(;s<e.gt0Index;++s){var o=r[s];if(o.isEnabled()&&!o._isPaused()&&o._isRegistered()&&t(o,i)){n=!0;break}}if(a&&!n){var l=a,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;if(d.isEnabled()&&!d._isPaused()&&d._isRegistered()&&t(d,i)){n=!0;break}}}if(r&&!n)for(;s<r.length;++s){var f=r[s];if(f.isEnabled()&&!f._isPaused()&&f._isRegistered()&&t(f,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_visitTarget",value:function(e,t){e._reorderChildDirty&&e.sortAllChildren();var i,n=e.children,r=0,a=n.length,s=this._globalZOrderNodeMap,o=this._nodeListenersMap;if(0<a)for(void 0!==o[e._id]&&(s||(s=[]),s.push(e._id));r<a;r++)(i=n[r])&&this._visitTarget(i,!1);else void 0!==o[e._id]&&(s||(s=[]),s.push(e._id));if(t){var l=this._nodePriorityMap,c=s,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}l[d]=++this._nodePriorityIndex}this._globalZOrderNodeMap.length=0}}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r._onCustomEvent===t||r.onEvent===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.remove(e,r):this._toRemovedListeners.push(r),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r===t)return r._setRegistered(!1),null!=r._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(r._getSceneGraphPriority(),r),r._setSceneGraphPriority(null)),0===this._inDispatch?cc.js.array.remove(e,r):this._toRemovedListeners.push(r),!0}return!1}}]),e}());cc.eventManager=sh;var oh={SUPPORT_TEXTURE_FORMATS:[".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},ImageFormat:cc.Enum({JPG:0,PNG:1,TIFF:2,WEBP:3,PVR:4,ETC:5,S3TC:6,ATITC:7,TGA:8,RAWDATA:9,UNKNOWN:10}),RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,MIN_ZINDEX:-Math.pow(2,15),MAX_ZINDEX:Math.pow(2,15)-1,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,DENSITYDPI_DEVICE:"device-dpi",DENSITYDPI_HIGH:"high-dpi",DENSITYDPI_MEDIUM:"medium-dpi",DENSITYDPI_LOW:"low-dpi",FIX_ARTIFACTS_BY_STRECHING_TEXEL_TMX:!0,DIRECTOR_STATS_POSITION:new Lr(0,0),ENABLE_STACKABLE_ACTIONS:!0,TOUCH_TIMEOUT:5e3,BATCH_VERTEX_COUNT:2e4,ENABLE_TILEDMAP_CULLING:!0,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,ENABLE_CULLING:!1,CLEANUP_IMAGE_CACHE:!1,SHOW_MESH_WIREFRAME:!1};cc.macro=oh;var lh=new Lr,ch=function(){function n(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;y(this,n),this._point=new Lr,this._prevPoint=new Lr,this._lastModified=0,this._id=null,this._startPoint=new Lr,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}return l(n,[{key:"getLocation",value:function(e){return e||(e=new Lr),we.set(e,this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new Lr),we.set(e,this._point.x,this._point.y),cc.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=cc.view.getViewportRect();return(this._point.x-e.x)/cc.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=cc.view.getViewportRect();return(this._point.y-e.y)/cc.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new Lr),we.set(e,this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new Lr),we.set(e,this._prevPoint.x,this._prevPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new Lr),we.set(e,this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new Lr),we.set(e,this._startPoint.x,this._startPoint.y),cc.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new Lr),this._point.sub(this._prevPoint,e),e}},{key:"getUIDelta",value:function(e){return e||(e=new Lr),this._point.sub(this._prevPoint,lh),we.set(e,cc.view.getScaleX(),cc.view.getScaleY()),we.divide(e,lh,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new Lr),we.set(e,this._point.x,cc.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new Lr),we.set(e,this._prevPoint.x,cc.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new Lr),we.set(e,this._startPoint.x,cc.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length?arguments[1]:void 0,i=2<arguments.length?arguments[2]:void 0;this._prevPoint=this._point,this._point=new Lr(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new Lr(this._point),this._startPointCaptured=!0)}},{key:"_setPoint",value:function(e,t){"object"===ye(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0)}},{key:"_setPrevPoint",value:function(e,t){"object"===ye(e)?this._prevPoint=new Lr(e.x,e.y):this._prevPoint=new Lr(e||0,t||0)}}]),n}();cc.Touch=ch;var uh,hh,dh=oh.TOUCH_TIMEOUT,fh=new Lr,ph=new Lr,_h=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=i,this.z=n,this.timestamp=r},vh=new(function(){function e(){y(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Lr,this._prevMousePoint=new Lr,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._minus=0,this._pointLocked=!1}return l(e,[{key:"handleTouchesBegin",value:function(e){var t=[],i=this._touchesIntegerDict,n=mo.now(),r=e,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.getID();if(null!==c)if(void 0===i[c]){var u=this._getUnUsedIndex();if(-1===u){cc.logID(2300,u);continue}var h=new ch(l._point.x,l._point.y,l.getID());(this._touches[u]=h)._lastModified=n,h._setPrevPoint(l._prevPoint),i[c]=u,t.push(h)}}if(0<t.length){var d=new Yu(t);d._eventCode=Yu.BEGAN,sh.dispatchEvent(d)}}},{key:"handleTouchesMove",value:function(e){var t=[],i=this._touches,n=mo.now(),r=e,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.getID();if(null!==c){var u=this._touchesIntegerDict[c];void 0!==u&&i[u]&&(i[u]._setPoint(l._point),i[u]._setPrevPoint(l._prevPoint),i[u]._lastModified=n,t.push(i[u]))}}if(0<t.length){var h=new Yu(t);h._eventCode=Yu.MOVED,sh.dispatchEvent(h)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Yu(t);i._eventCode=Yu.ENDED,sh.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(0<t.length){var i=new Yu(t);i._eventCode=Yu.CANCELLED,sh.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){var t=[],i=this._touches,n=this._touchesIntegerDict,r=e,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.getID();if(null!==c){var u=n[c];void 0!==u&&i[u]&&(i[u]._setPoint(l._point),i[u]._setPrevPoint(l._prevPoint),t.push(i[u]),this._removeUsedIndexBit(u),delete n[c])}}return t}},{key:"getHTMLElementPosition",value:function(e){if(mo.platform===mo.WECHAT_GAME)return{left:0,top:0,width:window.innerWidth,height:window.innerHeight};var t=document.documentElement,i=window.pageXOffset-t.clientLeft,n=window.pageYOffset-t.clientTop;if(e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;0<=r;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var s=new ch(a.x,a.y,0);return s._setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,s}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new qu(i);return r._setPrevCursor(n.x,n.y),n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(mo.platform===mo.WECHAT_GAME?(t.left=0,t.top=0):(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop),{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,s=0;s<a;s++){var o=e.changedTouches[s];if(o){var l=void 0;l=mo.BROWSER_TYPE_FIREFOX===mo.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,fh):n.convertToLocationInView(o.clientX,o.clientY,t,fh);var c=void 0;null!=o.identifier?(c=new ch(l.x,l.y,o.identifier),this.getPreTouch(c).getLocation(ph),c._setPrevPoint(ph.x,ph.y),this.setPreTouch(c)):(c=new ch(l.x,l.y))._setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(c)}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent){this._glView=cc.view;var t=mo.isMobile,i="mouse"in mo.capabilities,n="touches"in mo.capabilities;mo.platform===mo.WECHAT_GAME&&(i=!(n=!(t=!1))),i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB&&this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=cc.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var s=e;i=(s.gamma||0)/90*.981,n=-(s.beta||0)/90*.981,r=(s.alpha||0)/90*.981}if(cc.view._isRotated){var o=i;i=-n,n=o}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),cc.sys.os===cc.sys.OS_ANDROID&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,sh.dispatchEvent(new Ku(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=cc.sys.now(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n._lastModified>dh){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var t=this,e=function(){var e=cc.game.canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)}},{key:"_registerWindowMouseEvents",value:function(r){var a=this;window.addEventListener("mousedown",function(){a._mousePressed=!0},!1),window.addEventListener("mouseup",function(e){if(a._mousePressed){a._mousePressed=!1;var t=a.getHTMLElementPosition(r),i=a.getPointByEvent(e,t);if(!Gr(t.left,t.top,t.width,t.height).contains(new Lr(i.x,i.y))){a.handleTouchesEnd([a.getTouchByXY(e,i.x,i.y,t)]);var n=a.getMouseEvent(i,t,qu.UP);n.setButton(e.button),sh.dispatchEvent(n)}}},!1)}},{key:"_registerElementMouseEvents",value:function(s,e){var o=this,t=function(e,r,a){s.addEventListener(e,function(e){var t=o.getHTMLElementPosition(s),i=o.getPointByEvent(e,t),n=o.getMouseEvent(i,t,r);n.setButton(e.button),a(e,n,i,t),sh.dispatchEvent(n),e.stopPropagation(),e.preventDefault()})};e||(t("mousedown",qu.DOWN,function(e,t,i,n){o._mousePressed=!0,o.handleTouchesBegin([o.getTouchByXY(e,i.x,i.y,n)]),s.focus()}),t("mouseup",qu.UP,function(e,t,i,n){o._mousePressed=!1,o.handleTouchesEnd([o.getTouchByXY(e,i.x,i.y,n)])}),t("mousemove",qu.MOVE,function(e,t,i,n){o.handleTouchesMove([o.getTouchByXY(e,i.x,i.y,n)]),o._mousePressed||t.setButton(null),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)})),t("mousewheel",qu.SCROLL,function(e,t,i,n){t.setScrollData(0,e.wheelDelta)}),t("DOMMouseScroll",qu.SCROLL,function(e,t,i,n){t.setScrollData(0,-120*e.detail)})}},{key:"_registerMousePointerEvents",value:function(n){for(var r=this,t={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},e=function(){var e=s[a],i=t[e];n.addEventListener(e,function(e){var t=r.getHTMLElementPosition(n);t.left-=document.documentElement.scrollLeft,t.top-=document.documentElement.scrollTop,i.call(r,[r.getTouchByXY(e,e.clientX,e.clientY,t)]),e.stopPropagation()},!1)},a=0,s=Object.keys(t);a<s.length;a++)e()}},{key:"_registerTouchEvents",value:function(e){cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?this._registerWXGameTouchEvents(e):this._registerHTMLTouchEvents(e)}},{key:"_registerWXGameTouchEvents",value:function(r){var a=this,e=function(n){return function(e){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t))}};wx.onTouchStart(e(function(e){a.handleTouchesBegin(e)})),wx.onTouchEnd(e(function(e){a.handleTouchesEnd(e)})),wx.onTouchMove(e(function(e){a.handleTouchesMove(e)})),wx.onTouchCancel(e(function(e){a.handleTouchesCancel(e)}))}},{key:"_registerHTMLTouchEvents",value:function(r){var a=this,e=function(n){return function(e){if(e.changedTouches){var t=a.getHTMLElementPosition(r),i=document.body;t.left-=i.scrollLeft||0,t.top-=i.scrollTop||0,n(a.getTouchesByEvent(e,t)),e.stopPropagation(),e.preventDefault()}}};r.addEventListener("touchstart",e(function(e){a.handleTouchesBegin(e),mo.platform!==mo.WECHAT_GAME&&r.focus()}),!1),r.addEventListener("touchmove",e(function(e){a.handleTouchesMove(e)}),!1),r.addEventListener("touchend",e(function(e){a.handleTouchesEnd(e)}),!1),r.addEventListener("touchcancel",e(function(e){a.handleTouchesCancel(e)}),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=cc.game.canvas;e.addEventListener("keydown",function(e){sh.dispatchEvent(new Qu(e,!0)),e.stopPropagation(),e.preventDefault()},!1),e.addEventListener("keyup",function(e){sh.dispatchEvent(new Qu(e,!1)),e.stopPropagation(),e.preventDefault()},!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new _h,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,cc.sys.browserType===cc.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation",i=navigator.userAgent;(/Android/.test(i)||/Adr/.test(i)&&cc.sys.browserType===cc.BROWSER_TYPE_UC)&&(this._minus=-1),uh=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,uh,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";uh&&window.removeEventListener(e,uh,!1)}}]),e}());cc.internal.inputManager=vh,(hh=Kt.SystemEventType||(Kt.SystemEventType={})).TOUCH_START="touch-start",hh.TOUCH_MOVE="touch-move",hh.TOUCH_END="touch-end",hh.TOUCH_CANCEL="touch-cancel",hh.MOUSE_DOWN="mouse-down",hh.MOUSE_MOVE="mouse-move",hh.MOUSE_UP="mouse-up",hh.MOUSE_WHEEL="mouse-wheel",hh.MOUSE_ENTER="mouse-enter",hh.MOUSE_LEAVE="mouse-leave",hh.KEY_DOWN="keydown",hh.KEY_UP="keyup",hh.DEVICEMOTION="devicemotion",hh.TRANSFORM_CHANGED="transform-changed",hh.POSITION_PART="position-part",hh.ROTATION_PART="rotation-part",hh.SCALE_PART="scale-part",hh.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",hh.SIZE_CHANGED="size-changed",hh.ANCHOR_CHANGED="anchor-changed",hh.CHILD_ADDED="child-added",hh.CHILD_REMOVED="child-removed",si(Kt.SystemEventType),cc.SystemEventType=Kt.SystemEventType;var mh=null,yh=null,gh=null,bh=null,Sh=function(e){function a(){return y(this,a),T(this,S(a).call(this))}return p(a,Xn),l(a,[{key:"setAccelerometerEnabled",value:function(e){vh.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){vh.setAccelerometerInterval(e)}},{key:"on",value:function(e,t,i){return _(S(a.prototype),"on",this).call(this,e,t,i),e!==Kt.SystemEventType.KEY_DOWN&&e!==Kt.SystemEventType.KEY_UP||(mh||(mh=Zu.create({event:Zu.KEYBOARD,onKeyPressed:function(e,t){t.type=Kt.SystemEventType.KEY_DOWN,Ih.emit(t.type,t)},onKeyReleased:function(e,t){t.type=Kt.SystemEventType.KEY_UP,Ih.emit(t.type,t)}})),sh.hasEventListener(Zu.ListenerID.KEYBOARD)||sh.addListener(mh,256)),e===Kt.SystemEventType.DEVICEMOTION&&(yh||(yh=Zu.create({event:Zu.ACCELERATION,callback:function(e,t){t.type=Kt.SystemEventType.DEVICEMOTION,cc.systemEvent.emit(t.type,t)}})),sh.hasEventListener(Zu.ListenerID.ACCELERATION)||sh.addListener(yh,256)),e!==Kt.SystemEventType.TOUCH_START&&e!==Kt.SystemEventType.TOUCH_MOVE&&e!==Kt.SystemEventType.TOUCH_END&&e!==Kt.SystemEventType.TOUCH_CANCEL||gh||(gh=Zu.create({event:Zu.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=Kt.SystemEventType.TOUCH_START,cc.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=Kt.SystemEventType.TOUCH_MOVE,cc.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=Kt.SystemEventType.TOUCH_END,cc.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=Kt.SystemEventType.TOUCH_CANCEL,cc.systemEvent.emit(t.type,e,t)}}),sh.addListener(gh,256)),e!==Kt.SystemEventType.MOUSE_DOWN&&e!==Kt.SystemEventType.MOUSE_MOVE&&e!==Kt.SystemEventType.MOUSE_UP&&e!==Kt.SystemEventType.MOUSE_WHEEL||bh||(bh=Zu.create({event:Zu.MOUSE,onMouseDown:function(e){e.type=Kt.SystemEventType.MOUSE_DOWN,cc.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=Kt.SystemEventType.MOUSE_MOVE,cc.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=Kt.SystemEventType.MOUSE_UP,cc.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=Kt.SystemEventType.MOUSE_WHEEL,cc.systemEvent.emit(e.type,e)}}),sh.addListener(bh,256)),t}},{key:"off",value:function(e,t,i){if(_(S(a.prototype),"off",this).call(this,e,t,i),mh&&(e===Kt.SystemEventType.KEY_DOWN||e===Kt.SystemEventType.KEY_UP)){var n=this.hasEventListener(Kt.SystemEventType.KEY_DOWN),r=this.hasEventListener(Kt.SystemEventType.KEY_UP);n||r||sh.removeListener(mh)}yh&&e===Kt.SystemEventType.DEVICEMOTION&&sh.removeListener(yh)}}]),a}();Sh.EventType=Kt.SystemEventType;var Th,Eh,xh,Ah,Ch,wh,Rh,kh,Oh,Fh,Lh,Bh,Mh,Ih=new(cc.SystemEvent=Sh);cc.systemEvent=Ih;var Ph=new et("Comp"),Dh=(Cn.Flags.IsOnEnableCalled,Cn.Flags.IsOnLoadCalled),Nh=(Th=un("cc.Component"),Eh=hn({visible:!1}),xh=hn({visible:!1}),Ah=hn({displayName:"Script",type:Er,tooltip:void 0}),Ch=hn({visible:!1}),wh=hn({visible:!1}),Rh=hn({visible:!1}),Th((Mh=Bh=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"node",Fh,d(d(t))),v(t,"_enabled",Lh,d(d(t))),t._sceneGetter=null,t._id=Ph.getNewId(),t._eventTargets=[],t}return p(a,Cn),l(a,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){_(S(a.prototype),"destroy",this).call(this)&&this._enabled&&this.node.activeInHierarchy&&cc.director._compScheduler.disableComp(this)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks();for(var e=this._eventTargets,t=0,i=e.length;t<i;++t){var n=e[t];n&&n.targetOff(this)}e.length=0,cc.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=cc.instantiate._clone(this,this)),e.node=null,e}},{key:"schedule",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:cc.macro.REPEAT_FOREVER,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;cc.assertID(e,1619),cc.assertID(0<=t,1620),t=t||0,i=isNaN(i)?cc.macro.REPEAT_FOREVER:i,n=n||0;var r=cc.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,i,n,a)}},{key:"scheduleOnce",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&cc.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){cc.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=ft(this),t=e.lastIndexOf(".");return 0<=t&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=cc.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Dh}}]),a}(),Bh.system=null,c((Oh=Mh).prototype,"name",[Eh],Object.getOwnPropertyDescriptor(Oh.prototype,"name"),Oh.prototype),c(Oh.prototype,"uuid",[xh],Object.getOwnPropertyDescriptor(Oh.prototype,"uuid"),Oh.prototype),c(Oh.prototype,"__scriptAsset",[Ah],Object.getOwnPropertyDescriptor(Oh.prototype,"__scriptAsset"),Oh.prototype),c(Oh.prototype,"enabled",[Ch],Object.getOwnPropertyDescriptor(Oh.prototype,"enabled"),Oh.prototype),c(Oh.prototype,"enabledInHierarchy",[wh],Object.getOwnPropertyDescriptor(Oh.prototype,"enabledInHierarchy"),Oh.prototype),Fh=c(Oh.prototype,"node",[Rh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lh=c(Oh.prototype,"_enabled",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kh=Oh))||kh),zh=Nh.prototype;zh.update=null,zh.lateUpdate=null,zh.__preload=null,zh.onLoad=null,zh.start=null,zh.onEnable=null,zh.onDisable=null,zh.onDestroy=null,zh.onFocusInEditor=null,zh.onLostFocusInEditor=null,zh.resetInEditor=null,zh._getLocalBounds=null,zh.onRestore=null,Nh._requireComponent=null,Nh._executionOrder=0,lt(Nh,"_registerEditorProps",function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)}),cc.Component=Nh;var Uh,Gh,Vh,Hh,Wh,Xh,jh,qh,Yh,Kh;Cn.Flags.Destroying;var Qh=Cn.Flags.Destroying,Zh=Cn.Flags.DontDestroy,Jh=Cn.Flags.Deactivating,$h=new et("Node");function ed(e){return e?"string"==typeof e?Mt(e):e:(cc.errorID(3804),null)}var td=un("cc._BaseNode")((Kh=Yh=function(e){function c(e){var t;return y(this,c),v(t=T(this,S(c).call(this,e)),"_parent",Vh,d(d(t))),v(t,"_children",Hh,d(d(t))),v(t,"_active",Wh,d(d(t))),v(t,"_level",Xh,d(d(t))),v(t,"_components",jh,d(d(t))),v(t,"_prefab",qh,d(d(t))),t._scene=null,t._activeInHierarchy=!1,t._id=$h.getNewId(),t.__eventTargets=[],t._name=void 0!==e?e:"New Node",cc.director._scheduler&&cc.director._scheduler.enableForTarget(d(d(t))),t}return p(c,Cn),l(c,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return 0<(this._objFlags&Zh)},set:function(e){e?this._objFlags|=Zh:this._objFlags&=~Zh}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"childrenCount",get:function(){return this._children.length}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&cc.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}}],[{key:"_setScene",value:function(e){e instanceof cc.Scene?e._scene=e:null==e._parent?cc.error("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){if(t._sealed){var i=e._components,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.constructor===t)return s}}else{var o=e._components,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}if(u instanceof t)return u}}return null}},{key:"_findComponents",value:function(e,t,i){if(t._sealed){var n=e._components,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.constructor===t&&i.push(o)}}else{var l=e._components,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;d instanceof t&&i.push(d)}}}},{key:"_findChildComponent",value:function(e,t){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=c._findComponent(s,t);if(o)return o;if(0<s._children.length&&(o=c._findChildComponent(s._children,t)))return o}return null}},{key:"_findChildComponents",value:function(e,t,i){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;c._findComponents(o,t,i),0<o._children.length&&c._findChildComponents(o._children,t,i)}}}]),l(c,[{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var i=this._parent;if(this._parent=e,this._onSetParent(i,t),e&&(this._level=e._level+1,e._children.push(this),e.emit&&e.emit(Kt.SystemEventType.CHILD_ADDED,this)),i&&!(i._objFlags&Qh)){var n=i._children.indexOf(this);0,i._children.splice(n,1),i.emit&&i.emit(Kt.SystemEventType.CHILD_REMOVED,this)}this._onHierarchyChanged(i)}}},{key:"attr",value:function(e){Et(this,e)}},{key:"getChildByUuid",value:function(e){if(!e)return cc.log("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return cc.log("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){var t=e.split("/"),i=this,n=function(){if(a){if(s>=r.length)return"break";o=r[s++]}else{if((s=r.next()).done)return"break";o=s.value}var t=o;if(0===t.length)return"continue";var e=i.children.find(function(e){return e.name===t});if(!e)return{v:null};i=e};var r=t,a=Array.isArray(r),s=0;e:for(r=a?r:r[Symbol.iterator]();;){var o,l=n();switch(l){case"break":break e;case"continue":continue;default:if("object"===ye(l))return l.v}}return i}},{key:"addChild",value:function(e){cc.assertID(e,1606),cc.assertID(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._parent?this._parent._children.indexOf(this):0}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&Jh)cc.errorID(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,n=null,r=null,a=0,s=c._stacks[c._stackId];s||(s=[],c._stacks.push(s)),c._stackId++,s.length=0,s[0]=this;for(var o=null,l=!1;i;)if(r=s[--i])if(!l&&e?e(r):l&&t&&t(r),s[i]=null,l){if(l=!1,n)if(n[++a])s[i]=n[a],i++;else if(o&&(s[i]=o,i++,l=!0,o._parent?(a=(n=o._parent._children).indexOf(o),o=o._parent):n=o=null,a<0))break}else 0<r._children.length?(n=(o=r)._children,a=0,s[i]=n[a],i++):(s[i]=r,i++,l=!0);s.length=0,c._stackId--}},{key:"removeFromParent",value:function(e){this._parent&&(void 0===e&&(e=!0),this._parent.removeChild(this,e))}},{key:"removeChild",value:function(e,t){-1<this._children.indexOf(e)&&((t||void 0===t)&&e.cleanup(),e.parent=null)}},{key:"removeAllChildren",value:function(e){var t=this._children;void 0===e&&(e=!0);for(var i=t.length-1;0<=i;i--){var n=t[i];n&&(e&&n.cleanup(),n.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=ed(e);return t?c._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=ed(e),i=[];return t&&c._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=ed(e);return t?c._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=ed(e),i=[];return t&&(c._findComponents(this,t,i),c._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Mt(e)))return cc.errorID(3807,e),cc._RF.peek()&&cc.errorID(3808,e),null}else{if(!e)return cc.errorID(3804),null;t=e}if("function"!=typeof t)return cc.errorID(3809),null;if(!Ct(t,cc.Component))return cc.errorID(3810),null;var i=t._requireComponent;if(i&&!this.getComponent(i)&&!this.addComponent(i))return null;var n=new t;return(n.node=this)._components.push(n),this._activeInHierarchy&&cc.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Nh?e:this.getComponent(e))&&t.destroy()}else cc.errorID(3813)}},{key:"destroy",value:function(){return!!_(S(c.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){var e=this._children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}},{key:"cleanup",value:function(){}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Qh)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&cc.errorID(3815)}}else cc.errorID(3814)}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(function(e){c._setScene(e)}))}},{key:"_onPostActivated",value:function(){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=cc.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof cc.Scene||cc.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&cc.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Qh;var e=this._parent,t=null!==e&&0!=(e._objFlags&Qh);var i=this._children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a._destroyImmediate()}var s=this._components,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}c._destroyImmediate()}var u=this.__eventTargets,h=Array.isArray(u),d=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(d>=u.length)break;f=u[d++]}else{if((d=u.next()).done)break;f=d.value}f&&f.targetOff(this)}if(this.__eventTargets.length=0,this._persistNode&&cc.game.removePersistRootNode(this),!t&&e){var p=e._children.indexOf(this);e._children.splice(p,1),e.emit&&e.emit("child-removed",this)}return t}},{key:"_disableChildComps",value:function(){var e=this._components,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r._enabled&&cc.director._compScheduler.disableComp(r)}var a=this._children,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;c._active&&c._disableChildComps()}}}]),c}(),Yh.idGenerator=$h,Yh._stacks=[[]],Yh._stackId=0,c((Gh=Kh).prototype,"_persistNode",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"_persistNode"),Gh.prototype),c(Gh.prototype,"name",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"name"),Gh.prototype),c(Gh.prototype,"uuid",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"uuid"),Gh.prototype),c(Gh.prototype,"children",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"children"),Gh.prototype),c(Gh.prototype,"childrenCount",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"childrenCount"),Gh.prototype),c(Gh.prototype,"active",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"active"),Gh.prototype),c(Gh.prototype,"activeInHierarchy",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"activeInHierarchy"),Gh.prototype),c(Gh.prototype,"parent",[hn],Object.getOwnPropertyDescriptor(Gh.prototype,"parent"),Gh.prototype),Vh=c(Gh.prototype,"_parent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hh=c(Gh.prototype,"_children",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wh=c(Gh.prototype,"_active",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xh=c(Gh.prototype,"_level",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jh=c(Gh.prototype,"_components",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qh=c(Gh.prototype,"_prefab",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uh=Gh))||Uh;cc._BaseNode=td;var id,nd,rd,ad,sd,od,ld,cd,ud,hd,dd,fd=function(){function t(){y(this,t)}return l(t,null,[{key:"addLayer",value:function(e){if(!(31<t._nextAvailable))return t[e]=1<<t._nextAvailable++;console.warn("maximum layers reached.")}},{key:"makeInclusiveMask",value:function(e){var t=0,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}t|=a}return t}},{key:"makeExclusiveMask",value:function(e){return~t.makeInclusiveMask(e)}},{key:"check",value:function(e,t){return(e&t)===e}}]),t}();fd.Default=1,fd.IgnoreRaycast=2,fd.Gizmos=4,fd.Editor=8,fd.UI=16,fd.All=fd.makeExclusiveMask([fd.Gizmos,fd.Editor]),fd.RaycastMask=fd.makeExclusiveMask([fd.Gizmos,fd.Editor,fd.IgnoreRaycast]),fd._nextAvailable=8,cc.Layers=fd;var pd,_d,vd=new Br,md=new Pr,yd=new Array(10);(_d=pd||(pd={}))[_d.LOCAL=0]="LOCAL",_d[_d.WORLD=1]="WORLD";var gd,bd=(id=un("cc.Node"),nd=hn({type:Br}),id((dd=hd=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._pos=new Br,t._rot=new Pr,t._scale=new Br(1,1,1),t._mat=new Dr,v(t,"_lpos",sd,d(d(t))),v(t,"_lrot",od,d(d(t))),v(t,"_lscale",ld,d(d(t))),v(t,"_layer",cd,d(d(t))),v(t,"_euler",ud,d(d(t))),t._dirty=!1,t._hasChanged=!1,t._matDirty=!1,t._eulerDirty=!1,t._eventProcessor=new cc.NodeEventProcessor(d(d(t))),t._eventMask=0,t._uiTransfromComp=null,t}return p(a,td),l(a,[{key:"setParent",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];t&&this.updateWorldTransform(),_(S(a.prototype),"setParent",this).call(this,e,t)}},{key:"_onSetParent",value:function(e,t){if(_(S(a.prototype),"_onSetParent",this).call(this,e,t),t){var i=this._parent,n=this._lpos;i?(i.updateWorldTransform(),Oe.subtract(n,this._pos,i._pos),Oe.transformQuat(n,n,De.conjugate(md,i._rot)),Oe.divide(n,n,i._scale),De.multiply(this._lrot,De.conjugate(md,i._rot),this._rot),Oe.divide(this._lscale,this._scale,i._scale)):(Oe.copy(this._lpos,this._pos),De.copy(this._lrot,this._rot),Oe.copy(this._lscale,this._scale)),this._eulerDirty=!0}else Oe.copy(this._pos,this._lpos),De.copy(this._rot,this._lrot),Oe.copy(this._scale,this._lscale);this.invalidateChildren()}},{key:"_onBatchCreated",value:function(){Oe.copy(this._pos,this._lpos),De.copy(this._rot,this._lrot),Oe.copy(this._scale,this._lscale),this._dirty=this._hasChanged=!0,this._eventMask=0;var e=this._children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n._onBatchCreated()}}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"translate",value:function(e,t){var i=t||pd.LOCAL;Oe.copy(vd,this._lpos),i===pd.LOCAL?(Oe.transformQuat(vd,e,this.worldRotation),this.setPosition(Oe.add(vd,this._lpos,vd))):i===pd.WORLD&&this.setPosition(Oe.add(vd,this._lpos,e))}},{key:"rotate",value:function(e,t){var i=t||pd.LOCAL;i===pd.LOCAL?(this.getRotation(md),this.setRotation(De.multiply(md,md,e))):i===pd.WORLD&&(this.getWorldRotation(md),this.setWorldRotation(De.multiply(md,e,md)))}},{key:"lookAt",value:function(e,t){this.getWorldPosition(vd),Oe.subtract(vd,vd,e),Oe.normalize(vd,vd),De.fromViewUp(md,vd,t),this.setWorldRotation(md)}},{key:"resetHasChanged",value:function(){this._hasChanged=!1;for(var e=this._children.length,t=0;t<e;++t)this._children[t].resetHasChanged()}},{key:"invalidateChildren",value:function(){if(!this._dirty||!this._hasChanged){this._dirty=this._hasChanged=!0;var e=this._children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.invalidateChildren()}}}},{key:"updateWorldTransform",value:function(){if(this._dirty){for(var e,t=this,i=0;t._dirty;)if(!(t=(yd[i++]=t)._parent)||!t._parent){t=null;break}for(;i;)e=yd[--i],t&&(Oe.multiply(e._pos,e._lpos,t._scale),Oe.transformQuat(e._pos,e._pos,t._rot),Oe.add(e._pos,e._pos,t._pos),De.multiply(e._rot,t._rot,e._lrot),Oe.multiply(e._scale,t._scale,e._lscale)),e._matDirty=!0,e._dirty=!1,t=e}}},{key:"updateWorldTransformFull",value:function(){this.updateWorldTransform(),this._matDirty&&(He.fromRTS(this._mat,this._rot,this._pos,this._scale),this._matDirty=!1)}},{key:"setPosition",value:function(e,t,i){vd.set(this._lpos),void 0===t||void 0===i?Oe.copy(this._lpos,e):3===arguments.length&&Oe.set(this._lpos,e,t,i),Oe.copy(this._pos,this._lpos),this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.POSITION_PART)}},{key:"getPosition",value:function(e){return e?Oe.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Oe.copy(new Br,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?De.copy(this._lrot,e):4===arguments.length&&De.set(this._lrot,e,t,i,n),De.copy(this._rot,this._lrot),this._eulerDirty=!0,this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.ROTATION_PART)}},{key:"setRotationFromEuler",value:function(e,t,i){Oe.set(this._euler,e,t,i),this._eulerDirty=!1,De.fromEuler(this._lrot,e,t,i),De.copy(this._rot,this._lrot),this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.ROTATION_PART)}},{key:"getRotation",value:function(e){return e?De.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):De.copy(new Pr,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?Oe.copy(this._lscale,e):3===arguments.length&&Oe.set(this._lscale,e,t,i),Oe.copy(this._scale,this._lscale),this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.SCALE_PART)}},{key:"getScale",value:function(e){return e?Oe.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Oe.copy(new Br,this._lscale)}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?Oe.copy(this._pos,e):3===arguments.length&&Oe.set(this._pos,e,t,i);var n=this._parent,r=this._lpos;vd.set(this._lpos),n?(n.updateWorldTransform(),Oe.subtract(r,this._pos,n._pos),Oe.transformQuat(r,r,De.conjugate(md,n._rot)),Oe.divide(r,r,n._scale)):Oe.copy(r,this._pos),this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.POSITION_PART)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?Oe.copy(e,this._pos):Oe.copy(new Br,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?De.copy(this._rot,e):4===arguments.length&&De.set(this._rot,e,t,i,n),this._parent?(this._parent.getWorldRotation(md),De.multiply(this._lrot,De.conjugate(md,md),this._rot)):De.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.ROTATION_PART)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){De.fromEuler(this._rot,e,t,i),this._parent?(this._parent.getWorldRotation(md),De.multiply(this._lrot,this._rot,De.conjugate(md,md))):De.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.ROTATION_PART)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?De.copy(e,this._rot):De.copy(new Pr,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?Oe.copy(this._scale,e):3===arguments.length&&Oe.set(this._scale,e,t,i),this._parent?(this._parent.getWorldScale(vd),Oe.divide(this._lscale,this._scale,vd)):Oe.copy(this._lscale,this._scale),this.invalidateChildren(),1&this._eventMask&&this.emit(Kt.SystemEventType.TRANSFORM_CHANGED,Kt.SystemEventType.SCALE_PART)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?Oe.copy(e,this._scale):Oe.copy(new Br,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransformFull(),e||(e=new Dr),He.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransformFull(),e||(e=new Dr),He.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new Dr),He.fromRT(e,this._rot,this._pos)}},{key:"getAnchorPoint",value:function(e){return e||(e=new Lr),e.set(this.uiTransfromComp.anchorPoint),e}},{key:"setAnchorPoint",value:function(e,t){this.uiTransfromComp.setAnchorPoint(e,t)}},{key:"getContentSize",value:function(e){return e||(e=new zr),e.set(this.uiTransfromComp.contentSize),e}},{key:"setContentSize",value:function(e,t){this.uiTransfromComp.setContentSize(e,t)}},{key:"on",value:function(e,t,i,n){switch(e){case Kt.SystemEventType.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i,n){if(this._eventProcessor.off(e,t,i,n),!this._eventProcessor.hasEventListener(e))switch(e){case Kt.SystemEventType.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this._eventProcessor).emit.apply(t,[e].concat(n))}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e){return this._eventProcessor.hasEventListener(e)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Kt.SystemEventType.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"pauseSystemEvents",value:function(e){sh.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){sh.resumeTarget(this,e)}},{key:"_onPreDestroy",value:function(){this._eventProcessor.destroy(),_(S(a.prototype),"_onPreDestroy",this).call(this)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(De.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"layer",set:function(e){this._layer=e},get:function(){return this._layer}},{key:"hasChanged",get:function(){return this._hasChanged}},{key:"forward",get:function(){return this.getWorldRotation(md),Oe.transformQuat(new Br,Oe.UNIT_Z,md)},set:function(e){var t=Oe.magnitude(e);Oe.scale(vd,e,-1/t),De.fromViewUp(md,vd),this.setWorldRotation(md)}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"worldMatrix",get:function(){return this.updateWorldTransformFull(),this._mat}},{key:"uiTransfromComp",get:function(){return this._uiTransfromComp||(this._uiTransfromComp=this.getComponent("cc.UITransformComponent")),this._uiTransfromComp},set:function(e){this._uiTransfromComp=e}},{key:"width",get:function(){return this.uiTransfromComp.width},set:function(e){this.uiTransfromComp.width=e}},{key:"height",get:function(){return this.uiTransfromComp.height},set:function(e){this.uiTransfromComp.height=e}},{key:"anchorX",get:function(){return this.uiTransfromComp.anchorX},set:function(e){this.uiTransfromComp.anchorX=e}},{key:"anchorY",get:function(){return this.uiTransfromComp.anchorY},set:function(e){this.uiTransfromComp.anchorY=e}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"isNode",value:function(e){return e instanceof a&&(e.constructor===a||!(e instanceof cc.Scene))}}]),a}(),hd.EventType=Kt.SystemEventType,hd.NodeSpace=pd,sd=c((ad=dd).prototype,"_lpos",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br}}),od=c(ad.prototype,"_lrot",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pr}}),ld=c(ad.prototype,"_lscale",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(1,1,1)}}),cd=c(ad.prototype,"_layer",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fd.Default}}),ud=c(ad.prototype,"_euler",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br}}),c(ad.prototype,"eulerAngles",[nd],Object.getOwnPropertyDescriptor(ad.prototype,"eulerAngles"),ad.prototype),c(ad.prototype,"layer",[hn],Object.getOwnPropertyDescriptor(ad.prototype,"layer"),ad.prototype),c(ad.prototype,"position",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"position"),ad.prototype),c(ad.prototype,"rotation",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"rotation"),ad.prototype),c(ad.prototype,"scale",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"scale"),ad.prototype),c(ad.prototype,"worldPosition",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"worldPosition"),ad.prototype),c(ad.prototype,"worldRotation",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"worldRotation"),ad.prototype),c(ad.prototype,"worldScale",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"worldScale"),ad.prototype),c(ad.prototype,"worldMatrix",[Xu],Object.getOwnPropertyDescriptor(ad.prototype,"worldMatrix"),ad.prototype),rd=ad))||rd);cc.Node=bd;var Sd,Td=un("cc.Counter")(gd=function(){function n(e,t,i){y(this,n),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=i}return l(n,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),l(n,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts.average?this._averageValue:this._value;return Math.round(100*e)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),n}())||gd,Ed=un("cc.PerfCounter")(Sd=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._time=void 0,n._time=i,n}return p(r,Td),l(r,[{key:"start",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,(this._opts.average||1e3)<i&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),r}())||Sd,xd=!1,Ad=15,Cd="left",wd="right",Rd=null,kd=null,Od=null,Fd=new Map,Ld=null;function Bd(){if(kd){!function(){if(!Od||!Od.isValid){(Od=new bd("PROFILER-NODE")).addComponent("cc.UITransformComponent"),Od.addComponent("cc.DebugCanvasComponent"),cc.game.addPersistRootNode(Od);var e=new bd("ROOT");e.addComponent("cc.UITransformComponent"),e.parent=Od,e.anchorX=e.anchorY=0;var t=e.addComponent("cc.WidgetComponent");t&&(t.isAlignBottom=!0,t.isAlignLeft=!0,t.left=10,t.bottom=10);var i=new bd("LEFT-PANEL");i.parent=e;var n=i.addComponent("cc.LabelComponent");i.anchorX=i.anchorY=0,n&&(n.font=Rd,n.fontSize=Ad,n.lineHeight=Ad+1);var r=new bd("RIGHT-PANEL");r.parent=e;var a=r.addComponent("cc.LabelComponent");r.anchorX=1,r.anchorY=0;var s=r.getPosition();r.setPosition(200,s.y,s.z),a&&(a.horizontalAlign=cc.LabelComponent.HorizontalAlign.RIGHT,a.font=Rd,a.fontSize=Ad,a.lineHeight=Ad+1),Fd[Cd]=n,Fd[wd]=a}}();var e=cc.director._lastUpdate;Nd("frame").start(e),Nd("logic").start(e)}}function Md(){if(kd){var e=performance.now();cc.director.isPaused()?Nd("frame").start(e):Nd("logic").end(e),Nd("deferredDestory").start(e)}}function Id(){if(kd){var e=performance.now();Nd("deferredDestory").end(e),Nd("physics").start(e)}}function Pd(){if(kd){var e=performance.now();Nd("physics").end(e),Nd("render").start(e)}}function Dd(){if(kd){var e=performance.now();Nd("frame").end(e),Nd("fps").frame(e),Nd("draws").value=Ld.numDrawCalls,Nd("tricount").value=Ld.numTris,Nd("render").end(e),Nd("mode").value=Ld.gfxAPI;for(var t="",i="",n=0,r=Object.keys(kd);n<r.length;n++){var a=r[n],s=kd[a];s.counter.sample(e),t+=s.desc+"\n",i+=s.counter.human()+"\n"}Fd[Cd].string=t,Fd[wd].string=i}}function Nd(e){return kd[e].counter}var zd={isShowingStats:function(){return xd},hideStats:function(){xd&&(Od&&(Od.active=!1),cc.director.off(cc.Director.EVENT_BEFORE_UPDATE,Bd),cc.director.off(cc.Director.EVENT_AFTER_UPDATE,Md),cc.director.off(cc.Director.EVENT_BEFORE_PHYSICS,Id),cc.director.off(cc.Director.EVENT_BEFORE_DRAW,Pd),cc.director.off(cc.Director.EVENT_AFTER_DRAW,Dd),xd=!1)},showStats:function(){xd||(Ld||(Ld=cc.director.root.device),function(){if(!Rd){var e=document.createElement("canvas");e.width=256,e.height=256,e.style.width="".concat(e.width),e.style.height="".concat(e.height);var t=e.getContext("2d");if(t){t.font="".concat(Ad,"px Arial"),t.textBaseline="top",t.textAlign="left",t.fillStyle="#fff";var i=2,n=2,r=Ad;(Rd=new Wu).fntConfig={atlasName:"profiler-arial",commonHeight:r,fontSize:Ad,kerningDict:{},fontDefDictionary:{}},Rd.name="profiler-arial",Rd.fontSize=Ad;for(var a=Rd.fntConfig.fontDefDictionary,s=32;s<=126;s++){var o=String.fromCharCode(s),l=t.measureText(o).width;256<=i+l&&(n+=r+(i=2)),t.fillText(o,i,n),a[s]={xAdvance:l,xOffset:0,yOffset:0,rect:{x:i,y:n,width:l,height:r}},i+=l+2}var c=new Ls(e),u=new iu;u.mipmaps=[c],u.onLoaded(),Rd.spriteFrame=u}}}(),function(){kd=null;for(var e=performance.now(),t={frame:{desc:"Frame time (s)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500},draws:{desc:"Draw call"},tricount:{desc:"Triangle"},logic:{desc:"Game Logic (s)",min:0,max:50,average:500,color:"#080"},deferredDestory:{desc:"Deferred Destory (s)",min:0,max:50,average:500},physics:{desc:"Physics (s)",min:0,max:50,average:500},render:{desc:"Renderer (s)",min:0,max:50,average:500,color:"#f90"},mode:{desc:cc.game.renderType===cc.game.RENDER_TYPE_WEBGL?"WebGL":"Canvas",min:1}},i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];t[r].counter=new Ed(r,t[r],e)}kd=t}(),Od&&(Od.active=!0),cc.director.on(cc.Director.EVENT_BEFORE_UPDATE,Bd),cc.director.on(cc.Director.EVENT_AFTER_UPDATE,Md),cc.director.on(cc.Director.EVENT_BEFORE_PHYSICS,Id),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,Pd),cc.director.on(cc.Director.EVENT_AFTER_DRAW,Dd),xd=!0)}};cc.profiler=zd;var Ud,Gd,Vd,Hd,Wd,Xd,jd,qd=/^(click)(\s)*=|(param)(\s)*=/,Yd=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,Kd=function(){function e(){y(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return l(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0;for(var t=this._stack.length=0,i=e.length;t<i;){var n=e.indexOf("<",t);if(n<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{this._processResult(e.substring(t,n));var r=e.indexOf(">",t);-1===r?r=n:"/"===e.charAt(n+1)?this._stack.pop():this._addToStack(e.substring(n+1,r)),t=r+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=-1<r?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return-1<r&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{newline:!0}}),t;var s="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&0<i[0].length&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var o;i=e.match(Yd);for(var l=!1;i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),o=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"src"===n?(t.isImage=!0,o.endsWith("/")&&(o=o.substring(0,o.length-1)),0===o.indexOf("'")?(l=!0,o=o.substring(1,o.length-1)):0===o.indexOf('"')&&(l=!0,o=o.substring(1,o.length-1)),t.src=o):"height"===n?t.imageHeight=parseInt(o):"width"===n?t.imageWidth=parseInt(o):"click"===n&&(t.event=this._processEventHandler(n+"="+o)),t.event&&"param"===n&&(t.event[n]=o.replace(/^\"|\"$/g,"")),i=e.match(Yd);return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var c={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),u=-1<(r=(s=e.substring(n.length).trim()).indexOf(" "))?s.substr(0,r):s,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=s.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+u):"color"===n?c.color=u:"width"===n&&(c.width=parseInt(u)),t.event&&"param"===n&&(t.event[n]=u.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=c}if((i=e.match(/^(on|u|b|i)(\s)*/))&&0<i[0].length){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=0,i=new Map,n=e.match(qd),r=!1;n;){var a=n[0],s="";if(r=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))-1<(t=e.indexOf('"',1))&&(s=e.substring(1,t).trim(),r=!0),t++;else if("'"===e.charAt(0))-1<(t=e.indexOf("'",1))&&(s=e.substring(1,t).trim(),r=!0),t++;else{var o=e.match(/(\S)+/);t=(s=o?o[0]:"").length}r&&(i[a=a.substring(0,a.length-1).trim()]=s),n=(e=e.substring(t).trim()).match(qd)}return i}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),0<this._stack.length?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){var t=this._specialSymbolArray,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a[0],o=a[1];e=e.replace(s,o)}return e}}]),e}();var Qd=hn,Zd=un("cc.PrefabInfo")((Vd=c((Gd=function e(){y(this,e),v(this,"root",Vd,this),v(this,"asset",Hd,this),v(this,"fileId",Wd,this),v(this,"sync",Xd,this),v(this,"_synced",jd,this)}).prototype,"root",[Qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hd=c(Gd.prototype,"asset",[Qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wd=c(Gd.prototype,"fileId",[Qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xd=c(Gd.prototype,"sync",[Qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jd=c(Gd.prototype,"_synced",[Qd],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),Ud=Gd))||Ud;cc._PrefabInfo=Zd;var Jd={topLeft:cc.v2(0,0),topRight:cc.v2(0,0),top:cc.v2(0,0),bottomLeft:cc.v2(0,0),bottomRight:cc.v2(0,0),bottom:cc.v2(0,0),center:cc.v2(0,0),left:cc.v2(0,0),right:cc.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,s=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=s,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=s,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=s,this.right.y=r+i/2}};cc.visibleRect=Jd;var $d=function(e){function f(){var e,t;y(this,f);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(f)).call.apply(e,[this].concat(n)))).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=_(S(f.prototype),"on",d(t)),t.eventTargetOnce=_(S(f.prototype),"once",d(t)),t.config={},t.onStart=null,t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._prepared=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t._lastTime=null,t._frameTime=null,t._sceneInfos=[],t.collisionMatrix=[],t.groupList=[],t}return p(f,Xn),l(f,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate}},{key:"step",value:function(){cc.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&window.cancelAnimationFrame(this._intervalId),this._intervalId=0)}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){cc.director.once(cc.Director.EVENT_AFTER_DRAW,function(){for(var e in cc.game._persistRootNodes)cc.game.removePersistRootNode(cc.game._persistRootNodes[e]);cc.director.getScene().destroy(),cc.Object._deferredDestroy(),cc.director.purgeDirector(),cc.director.reset(),cc.game.onStart()})}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOn(e,t,i)}},{key:"once",value:function(e,t,i){this._prepared&&e===f.EVENT_ENGINE_INITED?t.call(i):this.eventTargetOnce(e,t,i)}},{key:"run",value:function(e,t){this._initConfig(e),this.onStart=t,this.prepare(cc.game.onStart&&cc.game.onStart.bind(cc.game))}},{key:"addPersistRootNode",value:function(e){if(cc.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=cc.director._scene;if(cc.isValid(i))if(e.parent){if(!(e.parent instanceof cc.Scene))return void cc.warnID(3801);if(e.parent!==i)return void cc.warnID(3802)}else e.parent=i;(this._persistRootNodes[t]=e)._persistNode=!0}}else cc.warnID(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"prepare",value:function(t){if(this._prepared)t&&t();else{var e=this.config.jsList;if(e&&0<e.length){var i=this;cc.loader.load(e,function(e){if(e)throw new Error(JSON.stringify(e));i._prepareFinished(t)})}else this._prepareFinished(t)}}},{key:"_initEngine",value:function(){this._rendererInitialized||(this._initRenderer(),this._initEvents(),this.emit(f.EVENT_ENGINE_INITED))}},{key:"_prepareFinished",value:function(e){this._prepared=!0,this._initEngine(),console.log("Cocos3D v"+cc.ENGINE_VERSION),this._setAnimFrame(),this._runMainLoop(),this.emit(f.EVENT_GAME_INITED),e&&e()}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=cc.game.config.frameRate;this._frameTime=1e3/e,window.cancelAnimationFrame=60!==e&&30!==e?(window.requestAnimationFrame=this._stTime,this._ctTime):(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,cc.game._frameTime-(t-cc.game._lastTime)),n=window.setTimeout(function(){e()},i);return cc.game._lastTime=t+i,n}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,i=t.config,n=cc.director,r=!0,a=i.frameRate;V(i.showFPS),e=function(){if(!t._paused){if(t._intervalId=window.requestAnimationFrame(e),30===a&&(r=!r))return;n.mainLoop()}},t._intervalId=window.requestAnimationFrame(e),t._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||2<t||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],k(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,t=parseInt(e.renderMode)||0;this.renderType=f.RENDER_TYPE_CANVAS;var i=!1;if(0===t?cc.sys.capabilities.opengl?(this.renderType=f.RENDER_TYPE_WEBGL,i=!0):cc.sys.capabilities.canvas&&(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):1===t&&cc.sys.capabilities.canvas?(this.renderType=f.RENDER_TYPE_CANVAS,i=!0):2===t&&cc.sys.capabilities.opengl&&(this.renderType=f.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(G(3820,t))}},{key:"_initRenderer",value:function(){if(!this._rendererInitialized){var e,t,i,n,r,a,s=this.config.id,o=cc.sys.platform===cc.sys.WECHAT_GAME,l=cc.sys.platform===cc.sys.QQ_PLAY;if(o)this.container=n=document.createElement("div"),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,i=cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?window.sharedCanvas||wx.getSharedCanvas():window.canvas,this.canvas=i;else if(l)this.container=cc.container=document.createElement("div"),this.frame=document.documentElement,this.canvas=i=window.canvas;else{var c=s instanceof HTMLElement?s:document.querySelector(s)||document.querySelector("#"+s);"CANVAS"===c.tagName?(e=c.width,t=c.height,this.canvas=i=c,this.container=n=document.createElement("div"),i.parentNode&&i.parentNode.insertBefore(n,i)):("DIV"!==c.tagName&&cc.warnID(3819),e=c.clientWidth,t=c.clientHeight,this.canvas=i=document.createElement("CANVAS"),this.container=n=document.createElement("div"),c.appendChild(n)),n.setAttribute("id","Cocos3dGameContainer"),n.appendChild(i),this.frame=n.parentNode===document.body?document.documentElement:n.parentNode,a="gameCanvas",-1<(" "+(r=i).className+" ").indexOf(" "+a+" ")||(r.className&&(r.className+=" "),r.className+=a),i.setAttribute("width",e||"480"),i.setAttribute("height",t||"320"),i.setAttribute("tabindex","99")}if(this._determineRenderType(),this.renderType===f.RENDER_TYPE_WEBGL){var u=!!window.WebGL2RenderingContext,h=navigator.userAgent.toLowerCase();-1!==h.indexOf("safari")&&-1===h.indexOf("chrome")&&(u=!1),this._gfxDevice=u?new cc.WebGL2GFXDevice:new cc.WebGLGFXDevice;var d={canvasElm:i,debug:!0,devicePixelRatio:window.devicePixelRatio,nativeWidth:Math.floor(screen.width*cc.view._devicePixelRatio),nativeHeight:Math.floor(screen.height*cc.view._devicePixelRatio)};!this._gfxDevice.initialize(d)&&u&&(this._gfxDevice=new cc.WebGLGFXDevice,this._gfxDevice.initialize(d))}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=f.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!cc._isContextMenuEnable)return!1},this._rendererInitialized=!0}}},{key:"_initEvents",value:function(){var i,e=window;this.config.registerSystemEvent&&vh.registerSystemEvent(this.canvas),void 0!==document.hidden?i="hidden":void 0!==document.mozHidden?i="mozHidden":void 0!==document.msHidden?i="msHidden":void 0!==document.webkitHidden&&(i="webkitHidden");var t=!1;function n(){t||(t=!0,cc.game.emit(f.EVENT_HIDE))}function r(){t&&(t=!1,cc.game.emit(f.EVENT_SHOW))}if(i)for(var a=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<a.length;s++)document.addEventListener(a[s],function(e){var t=document[i];(t=t||e.hidden)?n():r()});else e.addEventListener("blur",n),e.addEventListener("focus",r);-1<navigator.userAgent.indexOf("MicroMessenger")&&(e.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(e.addEventListener("pagehide",n),e.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r)),this.on(f.EVENT_HIDE,function(){cc.game.pause()}),this.on(f.EVENT_SHOW,function(){cc.game.resume()})}}]),f}();$d.EVENT_HIDE="game_on_hide",$d.EVENT_SHOW="game_on_show",$d.EVENT_GAME_INITED="game_inited",$d.EVENT_ENGINE_INITED="engine_inited",$d.EVENT_RENDERER_INITED="engine_inited",$d.RENDER_TYPE_CANVAS=0,$d.RENDER_TYPE_WEBGL=1,$d.RENDER_TYPE_OPENGL=2,cc.Game=$d,cc.game=new $d;var ef=0,tf=new(function(){function e(){y(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=cc.sys.browserType}return l(e,[{key:"init",value:function(){this.html=document.getElementsByTagName("html")[0]}},{key:"availWidth",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return cc.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(cc.sys.os===cc.sys.OS_IOS&&(tf.adaptationType=cc.sys.BROWSER_TYPE_SAFARI),tf.adaptationType){case cc.sys.BROWSER_TYPE_SAFARI:tf.meta["minimal-ui"]="true";case cc.sys.BROWSER_TYPE_SOUGOU:case cc.sys.BROWSER_TYPE_WECHAT_GAME:tf.availWidth=function(){return window.innerWidth},tf.availHeight=function(){return window.innerHeight};break;case cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB:var nf=window.sharedCanvas||wx.getSharedCanvas();tf.availWidth=function(){return nf.width},tf.availHeight=function(){return nf.height}}var rf=null,af=function(e){function n(){var e;y(this,n),(e=T(this,S(n).call(this)))._frameSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._resizeWithBrowserSize=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;d(d(e));var t=sf,i=of;return e._frameSize=new zr(0,0),e._designResolutionSize=new zr(0,0),e._originalDesignResolutionSize=new zr(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Ur(0,0,0,0),e._visibleRect=new Ur(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=cc.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._resolutionPolicy=null,e._rpExactFit=new lf(t.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new lf(t.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new lf(t.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new lf(t.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new lf(t.EQUAL_TO_FRAME,i.FIXED_WIDTH),cc.game.once($d.EVENT_ENGINE_INITED,e.init,d(d(e))),e}return p(n,Xn),l(n,[{key:"init",value:function(){tf.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=cc.game.canvas.width,t=cc.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=cc.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,cc.game.renderType===$d.RENDER_TYPE_WEBGL){var t=cc.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof cc.Texture2D?n.content:null;if(r){var a=cc.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(cc.game.renderType===$d.RENDER_TYPE_CANVAS){var s=cc.game.canvas.getContext("2d");s.imageSmoothingEnabled=e,s.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&cc.sys.isMobile&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,cc.screen.autoFullScreen(cc.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=cc.game.canvas,n=cc.game.container;i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return cc.size(cc.game.canvas.width,cc.game.canvas.height)}},{key:"getFrameSize",value:function(){return cc.size(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,cc.frame.style.width=e+"px",cc.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return cc.size(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return cc.size(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return cc.v2(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return cc.v2(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof lf)t._resolutionPolicy=e;else{var i=lf;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(0<e||0<t){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),cc.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,s=this._visibleRect,o=r.viewport;a.x=o.x,a.y=o.y,a.width=o.width,a.height=o.height,s.x=0,s.y=0,s.width=o.width/this._scaleX,s.height=o.height/this._scaleY}n.postApply(this),cc.winSize.width=this._visibleRect.width,cc.winSize.height=this._visibleRect.height,cc.visibleRect&&cc.visibleRect.init(this._visibleRect),this.emit("design-resolution-changed")}else cc.logID(2201)}else cc.logID(2200)}},{key:"getDesignResolutionSize",value:function(){return cc.size(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this._setViewportMeta({width:e},!0),document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)}},{key:"setViewportInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY;cc.game._renderContext.viewport(e*r+this._viewportRect.x,t*a+this._viewportRect.y,i*r,n*a)}},{key:"setScissorInPoints",value:function(e,t,i,n){var r=this._scaleX,a=this._scaleY,s=Math.ceil(e*r+this._viewportRect.x),o=Math.ceil(t*a+this._viewportRect.y),l=Math.ceil(i*r),c=Math.ceil(n*a),u=cc.game._renderContext;if(!rf){var h=u.getParameter(u.SCISSOR_BOX);rf=new Ur(h[0],h[1],h[2],h[3])}rf.x===s&&rf.y===o&&rf.width===l&&rf.height===c||(rf.x=s,rf.y=o,rf.width=l,rf.height=c,u.scissor(s,o,l,c))}},{key:"isScissorEnabled",value:function(){var e=cc.game._renderContext;return e.isEnabled(e.SCISSOR_TEST)}},{key:"getScissorRect",value:function(){var e=cc.game._renderContext;if(!rf){var t=e.getParameter(e.SCISSOR_BOX);rf=new Ur(t[0],t[1],t[2],t[3])}var i=1/this._scaleX,n=1/this._scaleY;return new Ur((rf.x-this._viewportRect.x)*i,(rf.y-this._viewportRect.y)*n,rf.width*i,rf.height*n)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||cc.v2(),a=this._devicePixelRatio*(e-i.left),s=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=cc.game.canvas.width-s,r.y=a):(r.x=a,r.y=s),r}},{key:"_resizeEvent",value:function(){var e=cc.director.getTotalFrames();if(ef!==e){var t;ef=e;var i=(t=this.setDesignResolutionSize?this:cc.view)._frameSize.width,n=t._frameSize.height,r=t._isRotated;if(cc.sys.isMobile){var a=cc.game.container.style,s=a.margin;a.margin="0",a.display="none",t._initFrameSize(),a.margin=s,a.display="block"}else t._initFrameSize();if(t._orientationChanging||t._isRotated!==r||t._frameSize.width!==i||t._frameSize.height!==n){var o=t._originalDesignResolutionSize.width,l=t._originalDesignResolutionSize.height;t._resizing=!0,0<o&&t.setDesignResolutionSize(o,l,t._resolutionPolicy),t._resizing=!1,t._resizeCallback&&t._resizeCallback.call()}}}},{key:"_orientationChange",value:function(){cc.view._orientationChanging=!0,cc.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=tf.availWidth(cc.game.frame),i=tf.availHeight(cc.game.frame),n=i<=t;!cc.sys.isMobile||n&&this._orientation&cc.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&cc.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,cc.game.container.style["-webkit-transform"]="rotate(0deg)",cc.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)",cc.game.container.style["-webkit-transform-origin"]="0px 0px 0px",cc.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,cc.game.canvas.style["-webkit-transform"]="translateZ(0px)",cc.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(function(){cc.view._orientationChanging=!1},1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;0<e&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,s=document.getElementsByName("viewport"),o=s?s[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport&&(this._setViewportMeta(tf.meta,!1),this._isAdjustViewport=!1)}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,s=0;s<e.length;s++){var o=e[s];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),n}(),sf=function(){function e(){y(this,e),this.name="ContainerStrategy"}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=cc.game.canvas,r=cc.game.container;cc.sys.platform!==cc.sys.WECHAT_GAME&&(cc.sys.os===cc.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px");var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(2,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(cc.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=cc.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();sf.EQUAL_TO_FRAME=void 0,sf.PROPORTION_TO_FRAME=void 0;var of=function(){function e(){y(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return l(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var s=new Ur(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return cc.game.renderType,$d.RENDER_TYPE_CANVAS,this._result.scale=[r,a],this._result.viewport=s,this._result}}]),e}();of.EXACT_FIT=void 0,of.SHOW_ALL=void 0,of.NO_BORDER=void 0,of.FIXED_HEIGHT=void 0,of.FIXED_WIDTH=void 0,function(){var e=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="EqualToFrame",t}return p(a,sf),l(a,[{key:"apply",value:function(e){var t=e._frameSize.height,i=cc.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),a}(),t=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ProportionalToFrame",t}return p(a,sf),l(a,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,s=cc.game.container.style,o=t.width,l=t.height,c=r/o,u=a/l;n=c<u?(i=r,l*c):(i=o*u,a);var h=Math.round((r-i)/2),d=Math.round((a-n)/2);i=r-2*h,n=a-2*d,this._setupContainer(e,i,n),e._isRotated?s.margin="0 0 0 "+a+"px":s.margin="0px",s.paddingLeft=h+"px",s.paddingRight=h+"px",s.paddingTop=d+"px",s.paddingBottom=d+"px"}}]),a}();sf.EQUAL_TO_FRAME=new e,sf.PROPORTION_TO_FRAME=new t;var i=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ExactFit",t}return p(a,of),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),a}(),n=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="ShowAll",t}return p(a,of),l(a,[{key:"apply",value:function(e,t){var i,n,r=cc.game.canvas.width,a=cc.game.canvas.height,s=t.width,o=t.height,l=r/s,c=a/o,u=0;return n=l<c?(i=r,o*(u=l)):(i=s*(u=c),a),this._buildResult(r,a,i,n,u,u)}}]),a}(),r=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="NoBorder",t}return p(a,of),l(a,[{key:"apply",value:function(e,t){var i,n,r,a=cc.game.canvas.width,s=cc.game.canvas.height,o=t.width,l=t.height,c=a/o,u=s/l;return r=c<u?(n=o*(i=u),s):(n=a,l*(i=c)),this._buildResult(a,s,n,r,i,i)}}]),a}(),a=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="FixedHeight",t}return p(a,of),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=n/t.height,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}(),s=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).name="FixedWidth",t}return p(a,of),l(a,[{key:"apply",value:function(e,t){var i=cc.game.canvas.width,n=cc.game.canvas.height,r=i/t.width,a=i,s=n;return this._buildResult(i,n,a,s,r,r)}}]),a}();of.EXACT_FIT=new i,of.SHOW_ALL=new n,of.NO_BORDER=new r,of.FIXED_HEIGHT=new a,of.FIXED_WIDTH=new s}();var lf=function(){function i(e,t){y(this,i),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}return l(i,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof sf&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof of&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return cc.v2(cc.game.canvas.width,cc.game.canvas.height)}}]),i}();lf.EXACT_FIT=void 0,lf.SHOW_ALL=void 0,lf.NO_BORDER=void 0,lf.FIXED_HEIGHT=void 0,lf.FIXED_WIDTH=void 0,lf.UNKNOWN=void 0,lf.ContainerStrategy=void 0,lf.ContentStrategy=void 0,lf.EXACT_FIT=0,lf.NO_BORDER=1,lf.SHOW_ALL=2,lf.FIXED_HEIGHT=3,lf.FIXED_WIDTH=4,lf.UNKNOWN=5,lf.ContainerStrategy=sf,lf.ContentStrategy=of,cc.ResolutionPolicy=lf;cc.view=new af;cc.winSize=cc.v2();var cf={_supportsFullScreen:!1,_preOnFullScreenChange:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var i=this._fn.fullscreenchange;this._preOnFullScreenChange&&document.removeEventListener(i,this._preOnFullScreenChange),this._preOnFullScreenChange=t,document.addEventListener(i,t,!1)}return e[this._fn.requestFullscreen]()}},exitFullScreen:function(){return!this._supportsFullScreen||document[this._fn.exitFullscreen]()},autoFullScreen:function(t,i){t=t||document.body;var n=cc.game.canvas||t,r=this;this.requestFullScreen(t,i),n.addEventListener(this._touchEvent,function e(){n.removeEventListener(r._touchEvent,e),r.requestFullScreen(t,i)})}};cf.init(),cc.screen=cf;var uf=new et("Scheduler"),hf=function e(t,i,n,r){y(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=i,this.paused=n,this.markedForDeletion=r};hf.get=function(e,t,i,n){var r=hf._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new hf(e,t,i,n),r},hf.put=function(e){hf._listEntries.length<20&&(e.target=null,hf._listEntries.push(e))},hf._listEntries=[];var df=function e(t,i,n,r){y(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=i,this.target=n,this.callback=r};df.get=function(e,t,i,n){var r=df._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new df(e,t,i,n),r},df.put=function(e){df._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,df._hashUpdateEntries.push(e))},df._hashUpdateEntries=[];var ff=function e(t,i,n,r,a,s){y(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=i,this.timerIndex=n,this.currentTimer=r,this.currentTimerSalvaged=a,this.paused=s};ff.get=function(e,t,i,n,r,a){var s=ff._hashTimerEntries.pop();return s?(s.timers=e,s.target=t,s.timerIndex=i,s.currentTimer=n,s.currentTimerSalvaged=r,s.paused=a):s=new ff(e,t,i,n,r,a),s},ff.put=function(e){ff._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,ff._hashTimerEntries.push(e))},ff._hashTimerEntries=[];var pf=function(){function e(){y(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return l(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=0<this._delay,this._repeat=r,this._runForever=this._repeat===cc.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();pf._timers=[],pf.get=function(){return pf._timers.pop()||new pf},pf.put=function(e){pf._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,pf._timers.push(e))};var _f=function(){function e(){y(this,e),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=dt(!0),this._hashForTimers=dt(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}return l(e,[{key:"enableForTarget",value:function(e){e._id||(e.__instanceId?cc.warnID(1513):e._id=uf.getNewId())}},{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var s=this._arrayForTimers;for(t=0;t<s.length;t++){if(a=s[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var s=e;e=t,t=s}4!==arguments.length&&5!==arguments.length||(a=!!n,n=cc.macro.REPEAT_FOREVER,r=0),cc.assertID(t,1502);var o=t._id;o||(t.__instanceId?(cc.warnID(1513),o=t._id=t.__instanceId):cc.errorID(1510));var l,c,u=this._hashForTimers[o];if(u?u.paused!==a&&cc.warnID(1511):(u=ff.get(null,t,0,null,null,a),this._arrayForTimers.push(u),this._hashForTimers[o]=u),null==u.timers)u.timers=[];else for(c=0;c<u.timers.length;++c)if((l=u.timers[c])&&e===l._callback)return cc.logID(1507,l.getInterval(),i),void(l._interval=i);(l=pf.get()).initWithCallback(this,e,t,i,n,r),u.timers.push(l),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e._id;n||(e.__instanceId?(cc.warnID(1513),n=e._id=e.__instanceId):cc.errorID(1510));var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return cc.logID(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,s=hf.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,s)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,s,t)),this._hashForUpdates[n]=df.get(a,s,e,null)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t._id;i||(t.__instanceId?(cc.warnID(1513),i=t._id=t.__instanceId):cc.errorID(1510));var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,s=r.length;a<s;a++){var o=r[a];if(e===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),pf.put(o),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];if(i){var n=i.timers;-1<n.indexOf(i.currentTimer)&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)pf.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;0<=t;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){cc.assertID(e,1508),cc.assertID(t,1509);var i=t._id;i||(t.__instanceId?(cc.warnID(1513),i=t._id=t.__instanceId):cc.errorID(1510));var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(cc.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],s=this._arrayForTimers;for(i=0,n=s.length;i<n;i++)(t=s[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){cc.assertID(e,1503);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}},{key:"resumeTarget",value:function(e){cc.assertID(e,1504);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}},{key:"isTargetPaused",value:function(e){cc.assertID(e,1505);var t=e._id;t||(e.__instanceId?(cc.warnID(1513),t=e._id=e.__instanceId):cc.errorID(1510));var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){delete this._hashForTimers[e.target._id];for(var t=this._arrayForTimers,i=0,n=t.length;i<n;i++)if(t[i]===e){t.splice(i,1);break}ff.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target._id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,s=n.length;a<s;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],hf.put(r),df.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),e}();_f.PRIORITY_SYSTEM=1<<31,_f.PRIORITY_NON_SYSTEM=_f.PRIORITY_SYSTEM+1,cc.Scheduler=_f;var vf,mf,yf,gf;(mf=vf||(vf={}))[mf.DEFAULT=100]="DEFAULT",(gf=yf||(yf={}))[gf.MIN=0]="MIN",gf[gf.MAX=255]="MAX",gf[gf.DEFAULT=128]="DEFAULT";var bf,Sf;(Sf=bf||(bf={}))[Sf.UBO_GLOBAL=23]="UBO_GLOBAL",Sf[Sf.UBO_SHADOW=22]="UBO_SHADOW",Sf[Sf.UBO_LOCAL=21]="UBO_LOCAL",Sf[Sf.UBO_FORWARD_LIGHTS=20]="UBO_FORWARD_LIGHTS",Sf[Sf.UBO_SKINNING=19]="UBO_SKINNING",Sf[Sf.UBO_SKINNING_TEXTURE=18]="UBO_SKINNING_TEXTURE",Sf[Sf.UBO_UI=17]="UBO_UI",Sf[Sf.SAMPLER_JOINTS=25]="SAMPLER_JOINTS",Sf[Sf.SAMPLER_ENVIRONMENT=26]="SAMPLER_ENVIRONMENT",Sf[Sf.CUSTUM_UBO_BINDING_END_POINT=17]="CUSTUM_UBO_BINDING_END_POINT",Sf[Sf.CUSTOM_SAMPLER_BINDING_START_POINT=30]="CUSTOM_SAMPLER_BINDING_START_POINT";var Tf=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};Tf.SIZE=4*(Tf.COUNT=(Tf.AMBIENT_GROUND_OFFSET=(Tf.AMBIENT_SKY_OFFSET=(Tf.MAIN_LIT_COLOR_OFFSET=(Tf.MAIN_LIT_DIR_OFFSET=(Tf.EXPOSURE_OFFSET=(Tf.CAMERA_POS_OFFSET=(Tf.MAT_VIEW_PROJ_INV_OFFSET=(Tf.MAT_VIEW_PROJ_OFFSET=(Tf.MAT_PROJ_INV_OFFSET=(Tf.MAT_PROJ_OFFSET=(Tf.MAT_VIEW_INV_OFFSET=(Tf.MAT_VIEW_OFFSET=(Tf.NATIVE_SIZE_OFFSET=(Tf.SCREEN_SCALE_OFFSET=(Tf.SCREEN_SIZE_OFFSET=(Tf.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4),Tf.BLOCK={binding:bf.UBO_GLOBAL,name:"CCGlobal",members:[{name:"cc_time",type:Kr.FLOAT4,count:1},{name:"cc_screenSize",type:Kr.FLOAT4,count:1},{name:"cc_screenScale",type:Kr.FLOAT4,count:1},{name:"cc_nativeSize",type:Kr.FLOAT4,count:1},{name:"cc_matView",type:Kr.MAT4,count:1},{name:"cc_matViewInv",type:Kr.MAT4,count:1},{name:"cc_matProj",type:Kr.MAT4,count:1},{name:"cc_matProjInv",type:Kr.MAT4,count:1},{name:"cc_matViewProj",type:Kr.MAT4,count:1},{name:"cc_matViewProjInv",type:Kr.MAT4,count:1},{name:"cc_cameraPos",type:Kr.FLOAT4,count:1},{name:"cc_exposure",type:Kr.FLOAT4,count:1},{name:"cc_mainLitDir",type:Kr.FLOAT4,count:1},{name:"cc_mainLitColor",type:Kr.FLOAT4,count:1},{name:"cc_ambientSky",type:Kr.FLOAT4,count:1},{name:"cc_ambientGround",type:Kr.FLOAT4,count:1}]};var Ef=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};Ef.SIZE=4*(Ef.COUNT=(Ef.SHADOW_COLOR_OFFSET=(Ef.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+4),Ef.BLOCK={binding:bf.UBO_SHADOW,name:"CCShadow",members:[{name:"cc_matLightPlaneProj",type:Kr.MAT4,count:1},{name:"cc_shadowColor",type:Kr.FLOAT4,count:1}]};var xf={binding:bf.SAMPLER_ENVIRONMENT,name:"cc_environment",type:Kr.SAMPLER_CUBE,count:1},Af=new Map,Cf=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};Cf.SIZE=4*(Cf.COUNT=(Cf.MAT_WORLD_IT_OFFSET=(Cf.MAT_WORLD_OFFSET=0)+16)+16),Cf.BLOCK={binding:bf.UBO_LOCAL,name:"CCLocal",members:[{name:"cc_matWorld",type:Kr.MAT4,count:1},{name:"cc_matWorldIT",type:Kr.MAT4,count:1}]},Af.set(Cf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:Cf.BLOCK});var wf=function e(){y(this,e),this.view=new Float32Array(e.COUNT)};wf.MAX_SPHERE_LIGHTS=2,wf.MAX_SPOT_LIGHTS=2,wf.SIZE=4*(wf.COUNT=(wf.SPOT_LIGHT_COLOR_OFFSET=(wf.SPOT_LIGHT_DIR_OFFSET=(wf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET=(wf.SPOT_LIGHT_POS_OFFSET=(wf.SPHERE_LIGHT_COLOR_OFFSET=(wf.SPHERE_LIGHT_SIZE_RANGE_OFFSET=(wf.SPHERE_LIGHT_POS_OFFSET=0)+4*wf.MAX_SPHERE_LIGHTS)+4*wf.MAX_SPHERE_LIGHTS)+4*wf.MAX_SPOT_LIGHTS)+4*wf.MAX_SPOT_LIGHTS)+4*wf.MAX_SPOT_LIGHTS)+4*wf.MAX_SPOT_LIGHTS)+4*wf.MAX_SPOT_LIGHTS),wf.BLOCK={binding:bf.UBO_FORWARD_LIGHTS,name:"CCForwardLight",members:[{name:"cc_sphereLitPos",type:Kr.FLOAT4,count:wf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitSizeRange",type:Kr.FLOAT4,count:wf.MAX_SPHERE_LIGHTS},{name:"cc_sphereLitColor",type:Kr.FLOAT4,count:wf.MAX_SPHERE_LIGHTS},{name:"cc_spotLitPos",type:Kr.FLOAT4,count:wf.MAX_SPOT_LIGHTS},{name:"cc_spotLitSizeRangeAngle",type:Kr.FLOAT4,count:wf.MAX_SPOT_LIGHTS},{name:"cc_spotLitDir",type:Kr.FLOAT4,count:wf.MAX_SPOT_LIGHTS},{name:"cc_spotLitColor",type:Kr.FLOAT4,count:wf.MAX_SPOT_LIGHTS}]},Af.set(wf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:wf.BLOCK});var Rf=function e(){y(this,e)};Rf.MAT_JOINT_OFFSET=0,Rf.SIZE=4*(Rf.COUNT=360),Rf.BLOCK={binding:bf.UBO_SKINNING,name:"CCSkinning",members:[{name:"cc_jointsData",type:Kr.FLOAT4,count:90}]},Af.set(Rf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:Rf.BLOCK});var kf=function e(){y(this,e)};kf.JOINTS_TEXTURE_SIZE_INV_OFFSET=0,kf.SIZE=4*(kf.COUNT=4),kf.BLOCK={binding:bf.UBO_SKINNING_TEXTURE,name:"CCSkinningTexture",members:[{name:"cc_jointsTextureSizeInv",type:Kr.FLOAT4,count:1}]},Af.set(kf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:kf.BLOCK});var Of={binding:bf.SAMPLER_JOINTS,name:"cc_jointsTexture",type:Kr.SAMPLER2D,count:1};Af.set(Of.name,{type:Da.SAMPLER,samplerInfo:Of});var Ff,Lf,Bf,Mf,If,Pf,Df=0,Nf=function(e){return Math.ceil(Math.log2(Math.max(e,2)))},zf=function(e,t){switch(e.type){case"boolean":return t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"0"},Uf=function(e,t,i){var n=e.builtins[i],r=n.blocks,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=t.get(l);if(c&&c.type===Da.UNIFORM_BUFFER)e.blocks.push(c.blockInfo);else console.warn("builtin UBO '".concat(l,"' not available!"))}var u=n.samplers,h=Array.isArray(u),d=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(d>=u.length)break;f=u[d++]}else{if((d=u.next()).done)break;f=d.value}var p=f,_=t.get(p);if(_&&_.type===Da.SAMPLER)e.samplers.push(_.samplerInfo);else console.warn("builtin sampler '".concat(p,"' not available!"))}},Gf=new(function(){function e(){y(this,e),this._templates=void 0,this._cache=void 0,this._templates={},this._cache={}}return l(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){var i=Object.assign({id:++Df},e);i.localsInited||(Uf(i,Af,"locals"),i.localsInited=!0);var r=0,n=function(){if(s){if(o>=a.length)return"break";l=a[o++]}else{if((o=a.next()).done)return"break";l=o.value}var i=l,e=1;if("number"===i.type){var t=i.range;e=Nf(t[1]-t[0]),i._map=function(e){return e-t[0]<<i._offset}}else if("string"===i.type){var n=[0,i.options.length-1];e=Nf(n[1]-n[0]),i._map=function(t){return Math.max(0,i.options.findIndex(function(e){return e===t}))<<i._offset}}else"boolean"===i.type&&(i._map=function(e){return e?1<<i._offset:0});i._offset=r,r+=e},a=i.defines,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if("break"===n())break}this._templates[e.name]=i}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=0,r=i.defines,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=t[l.name];void 0!==c&&l._map&&(n|=l._map(c))}return n<<8|255&i.id}},{key:"destroyShaderByDefines",value:function(e){var i=this,n=Object.keys(e);if(n.length){var r=n.map(function(e){var t=n[e];return"boolean"==typeof t&&(t=t?"1":"0"),new RegExp(e+t)}),t=Object.keys(this._cache).filter(function(t){return r.every(function(e){return e.test(i._cache[t].name)})}),a=Array.isArray(t),s=0;for(t=a?t:t[Symbol.iterator]();;){var o;if(a){if(s>=t.length)break;o=t[s++]}else{if((s=t.next()).done)break;o=s.value}var l=o;console.log("destroyed shader ".concat(this._cache[l].name)),this._cache[l].destroy(),delete this._cache[l]}}}},{key:"getGFXShader",value:function(e,t,i,n){Object.assign(i,n.macros);var r=this.getKey(t,i),a=this._cache[r];if(void 0!==a)return a;var s=this._templates[t];s.globalsInited||(Uf(s,n.globalBindings,"globals"),s.globalsInited=!0);var o=function(e,t){var i=[],n=t,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name,c=zf(o,e[l]);i.push({name:l,result:c})}return i}(i,s.defines);!function(e,t,i){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.name;o.result&&i[l]&&!t[i[l]]&&(console.warn("".concat(i[l]," not supported on this platform, disabled ").concat(l)),o.result="0")}}(o,e,s.dependencies);var l,c,u=o.reduce(function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.result,"\n")},""),h="",d="";return d=e.gfxAPI===ds.WEBGL2?(h="#version 300 es\n".concat(u,"\n").concat(s.glsl3.vert),"#version 300 es\n".concat(u,"\n").concat(s.glsl3.frag)):(h="#version 100\n".concat(u,"\n").concat(s.glsl1.vert),"#version 100\n".concat(u,"\n").concat(s.glsl1.frag)),a=e.createShader({name:(l=t,c=o,l+c.reduce(function(e,t){return t.result?"".concat(e,"|").concat(t.name).concat(t.result):e},"")),blocks:s.blocks,samplers:s.samplers,stages:[{type:Ia.VERTEX,source:h},{type:Ia.FRAGMENT,source:d}]}),this._cache[r]=a}}]),e}());cc.programLib=Gf;var Vf={},Hf=un("cc.EffectAsset")((Pf=If=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"techniques",Bf,d(d(t))),v(t,"shaders",Mf,d(d(t))),t}return p(a,qn),l(a,[{key:"onLoaded",value:function(){this.shaders.forEach(function(e){return Gf.define(e)}),a.register(this),this.techniques.forEach(function(e){return e.passes.forEach(function(e){if(e.properties)for(var t=0,i=Object.values(e.properties);t<i.length;t++){var n=i[t];n.sampler&&(n.sampler=n.sampler.map(function(e){return null===e?void 0:e}))}})})}}],[{key:"register",value:function(e){Vf[e.name]=e}},{key:"remove",value:function(e){if(Vf[e])delete Vf[e];else for(var t in Vf)if(Vf[t]._uuid===e)return void delete Vf[t]}},{key:"get",value:function(e){if(Vf[e])return Vf[e];for(var t in Vf)if(Vf[t]._uuid===e)return Vf[t];return null}},{key:"getAll",value:function(){return Vf}}]),a}(),If._effects={},Bf=c((Lf=Pf).prototype,"techniques",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mf=c(Lf.prototype,"shaders",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ff=Lf))||Ff;cc.EffectAsset=Hf;var Wf=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.TEXTURE_VIEW)))._device=void 0,t._texture=null,t._type=Ba.TV2D,t._format=Kt.GFXFormat.UNKNOWN,t._baseLevel=0,t._levelCount=1,t._baseLayer=0,t._layerCount=1,t._device=e,t}return p(i,ns),l(i,[{key:"texture",get:function(){return this._texture}},{key:"type",get:function(){return this._type}},{key:"format",get:function(){return this._format}},{key:"baseLevel",get:function(){return this._baseLevel}},{key:"levelCount",get:function(){return this._levelCount}},{key:"baseLayer",get:function(){return this._baseLayer}},{key:"layerCount",get:function(){return this._layerCount}}]),i}(),Xf=function(){function t(e){y(this,t),this._onAttach=void 0,this._onDetach=void 0,this._models={},this._onAttach=e.onAttach,this._onDetach=e.onDetach}return l(t,[{key:"attach",value:function(e){var t=this._models,i=e.id;t[i]?t[i]++:(this._onAttach&&this._onAttach(e),t[i]=1)}},{key:"detach",value:function(e){var t=this._models,i=e.id;!t[i]||0<--t[i]||this._onDetach&&this._onDetach(e)}}]),t}(),jf=new(function(){function e(){y(this,e),this._customs={}}return l(e,[{key:"register",value:function(e,t){this._customs[e]=new Xf(t)}},{key:"attach",value:function(e,t){var i=this._customs[e];i?i.attach(t):console.warn("no customization named '".concat(e,"'"))}},{key:"detach",value:function(e,t){var i=this._customs[e];i?i.detach(t):console.warn("no customization named '".concat(e,"'"))}}]),e}());cc.customizationManager=jf;var qf={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256},Yf=Oe.create(),Kf=Oe.create(),Qf=Oe.create(),Zf=Oe.create(),Jf=Oe.create(),$f=Oe.create(),ep=new Array(3),tp=new Array(3);function ip(e,t){return Oe.dot(t.n,e)-t.d}function np(e,t,i){return Oe.copy(e,t),Oe.subtract(Jf,i.center,i.halfExtents),Oe.add($f,i.center,i.halfExtents),e.x=e.x<Jf.x?Jf.x:e.x,e.y=e.y<Jf.x?Jf.y:e.y,e.z=e.z<Jf.x?Jf.z:e.z,e.x=e.x>$f.x?$f.x:e.x,e.y=e.y>$f.x?$f.y:e.y,e.z=e.z>$f.x?$f.z:e.z,e}function rp(e,t,i){Oe.set(Yf,i.orientation.m00,i.orientation.m01,i.orientation.m02),Oe.set(Kf,i.orientation.m03,i.orientation.m04,i.orientation.m05),Oe.set(Qf,i.orientation.m06,i.orientation.m07,i.orientation.m08),ep[0]=Yf,ep[1]=Kf,ep[2]=Qf,tp[0]=i.halfExtents.x,tp[1]=i.halfExtents.y,tp[2]=i.halfExtents.z,Oe.sub(Zf,t,i.center),Oe.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=Oe.dot(Zf,ep[n]);r>tp[n]&&(r=tp[n]),r<-tp[n]&&(r=-tp[n]),e.x+=r*ep[n].x,e.y+=r*ep[n].y,e.z+=r*ep[n].z}return e}var ap,sp,op,lp,cp,up,hp,dp,fp,pp,_p,vp,mp,yp,gp,bp,Sp,Tp,Ep,xp,Ap,Cp,wp,Rp,kp,Op,Fp,Lp,Bp,Mp,Ip,Pp,Dp,Np,zp,Up,Gp,Vp,Hp=Object.freeze({point_plane:ip,pt_point_plane:function(e,t,i){var n=ip(t,i);return Oe.subtract(e,t,Oe.scale(e,i.n,n))},pt_point_aabb:np,pt_point_obb:rp}),Wp=(ap=Oe.create(0,0,0),function(e,t){var i=Oe.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;Oe.scale(ap,t.n,t.d);var n=Oe.dot(Oe.subtract(ap,ap,e.o),t.n)/i;return n<0?0:n}),Xp=(sp=Oe.create(0,0,0),function(e,t){Oe.subtract(sp,e.e,e.s);var i=(t.d-Oe.dot(e.s,t.n))/Oe.dot(sp,t.n);return i<0||1<i?0:i}),jp=(op=Oe.create(0,0,0),lp=Oe.create(0,0,0),cp=Oe.create(0,0,0),up=Oe.create(0,0,0),hp=Oe.create(0,0,0),function(e,t,i){Oe.subtract(op,t.b,t.a),Oe.subtract(lp,t.c,t.a),Oe.cross(cp,e.d,lp);var n=Oe.dot(op,cp);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;Oe.subtract(up,e.o,t.a);var a=Oe.dot(up,cp)*r;if(a<0||1<a)return 0;Oe.cross(hp,up,op);var s=Oe.dot(e.d,hp)*r;if(s<0||1<a+s)return 0;var o=Oe.dot(lp,hp)*r;return o<0?0:o}),qp=(dp=Oe.create(0,0,0),fp=Oe.create(0,0,0),pp=Oe.create(0,0,0),_p=Oe.create(0,0,0),vp=Oe.create(0,0,0),mp=Oe.create(0,0,0),function(e,t,i){Oe.subtract(dp,t.b,t.a),Oe.subtract(fp,t.c,t.a),Oe.subtract(pp,e.s,e.e),Oe.cross(vp,dp,fp);var n=Oe.dot(pp,vp);if(n<=0)return 0;Oe.subtract(_p,e.s,t.a);var r=Oe.dot(_p,vp);if(r<0||n<r)return 0;Oe.cross(mp,pp,_p);var a=Oe.dot(fp,mp);if(a<0||n<a)return 0;var s=-Oe.dot(dp,mp);if(s<0||n<a+s)return 0;if(i){var o=1/n,l=1-(a*=o)-(s*=o);Oe.set(i,t.a.x*l+t.b.x*a+t.c.x*s,t.a.y*l+t.b.y*a+t.c.y*s,t.a.z*l+t.b.z*a+t.c.z*s)}return 1}),Yp=(yp=Oe.create(0,0,0),gp=Oe.create(0,0,0),bp=Oe.create(0,0,0),Sp=Oe.create(0,0,0),Tp=Oe.create(0,0,0),Ep=Oe.create(0,0,0),xp=Oe.create(0,0,0),function(e,t,i,n,r,a,s){Oe.subtract(yp,t,e),Oe.subtract(gp,i,e),Oe.subtract(bp,n,e),Oe.subtract(Sp,r,e),Oe.cross(Ep,Sp,yp);var o=Oe.dot(gp,Ep);if(0<=o){var l=-Oe.dot(bp,Ep);if(l<0)return 0;var c=Oe.dot(Oe.cross(xp,yp,bp),gp);if(c<0)return 0;if(s){var u=1/(l+o+c);l*=u,o*=u,c*=u,Oe.set(s,i.x*l+n.x*o+r.x*c,i.y*l+n.y*o+r.y*c,i.z*l+n.z*o+r.z*c)}}else{Oe.subtract(Tp,a,e);var h=Oe.dot(Tp,Ep);if(h<0)return 0;var d=Oe.dot(Oe.cross(xp,yp,gp),Tp);if(d<0)return 0;if(s){var f=1/(h+(o=-o)+d);h*=f,o*=f,d*=f,Oe.set(s,i.x*h+a.x*o+r.x*d,i.y*h+a.y*o+r.y*d,i.z*h+a.z*o+r.z*d)}}return 1}),Kp=(Ap=Oe.create(0,0,0),function(e,t){var i=t.radius,n=t.center,r=e.o,a=e.d,s=i*i;Oe.subtract(Ap,n,r);var o=Oe.sqrMag(Ap),l=Oe.dot(Ap,a),c=s-(o-l*l);if(c<0)return 0;var u=Math.sqrt(c),h=o<s?l+u:l-u;return h<0?0:h}),Qp=(Cp=Oe.create(),wp=Oe.create(),function(e,t){var i=e.o,n=e.d,r=1/n.x,a=1/n.y,s=1/n.z;Oe.subtract(Cp,t.center,t.halfExtents),Oe.add(wp,t.center,t.halfExtents);var o=(Cp.x-i.x)*r,l=(wp.x-i.x)*r,c=(Cp.y-i.y)*a,u=(wp.y-i.y)*a,h=(Cp.z-i.z)*s,d=(wp.z-i.z)*s,f=Math.max(Math.max(Math.min(o,l),Math.min(c,u)),Math.min(h,d)),p=Math.min(Math.min(Math.max(o,l),Math.max(c,u)),Math.max(h,d));return p<0||p<f?0:f}),Zp=(Rp=Oe.create(),kp=Oe.create(),Op=Oe.create(),Fp=Oe.create(),Lp=Oe.create(),Bp=Oe.create(),Mp=Oe.create(),Ip=new Array(3),Pp=new Array(3),Dp=new Array(3),Np=new Array(6),function(e,t){Ip[0]=t.halfExtents.x,Ip[1]=t.halfExtents.y,Ip[2]=t.halfExtents.z,Rp=t.center,kp=e.o,Op=e.d,Oe.set(Fp,t.orientation.m00,t.orientation.m01,t.orientation.m02),Oe.set(Lp,t.orientation.m03,t.orientation.m04,t.orientation.m05),Oe.set(Bp,t.orientation.m06,t.orientation.m07,t.orientation.m08),Oe.subtract(Mp,Rp,kp),Pp[0]=Oe.dot(Fp,Op),Pp[1]=Oe.dot(Lp,Op),Pp[2]=Oe.dot(Bp,Op),Dp[0]=Oe.dot(Fp,Mp),Dp[1]=Oe.dot(Lp,Mp),Dp[2]=Oe.dot(Bp,Mp);for(var i=0;i<3;++i){if(0===Pp[i]){if(0<-Dp[i]-Ip[i]||-Dp[i]+Ip[i]<0)return 0;Pp[i]=1e-7}Np[2*i+0]=(Dp[i]+Ip[i])/Pp[i],Np[2*i+1]=(Dp[i]-Ip[i])/Pp[i]}var n=Math.max(Math.max(Math.min(Np[0],Np[1]),Math.min(Np[2],Np[3])),Math.min(Np[4],Np[5])),r=Math.min(Math.min(Math.max(Np[0],Np[1]),Math.max(Np[2],Np[3])),Math.max(Np[4],Np[5]));return r<0||r<n||n<0?0:n}),Jp=(zp=Oe.create(),Up=Oe.create(),Gp=Oe.create(),Vp=Oe.create(),function(e,t){return Oe.subtract(zp,e.center,e.halfExtents),Oe.add(Up,e.center,e.halfExtents),Oe.subtract(Gp,t.center,t.halfExtents),Oe.add(Vp,t.center,t.halfExtents),zp.x<=Vp.x&&Up.x>=Gp.x&&zp.y<=Vp.y&&Up.y>=Gp.y&&zp.z<=Vp.z&&Up.z>=Gp.z});function $p(e,t,i,n,r,a){Oe.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),Oe.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),Oe.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),Oe.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),Oe.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),Oe.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),Oe.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),Oe.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function e_(e,t){for(var i=Oe.dot(t,e[0]),n=i,r=1;r<8;++r){var a=Oe.dot(t,e[r]);i=a<i?a:i,n=n<a?a:n}return[i,n]}var t_,i_,n_,r_,a_,s_,o_,l_=function(){for(var c=new Array(15),e=0;e<15;e++)c[e]=Oe.create(0,0,0);for(var u=new Array(8),h=new Array(8),t=0;t<8;t++)u[t]=Oe.create(0,0,0),h[t]=Oe.create(0,0,0);var d=Oe.create(),f=Oe.create();return function(e,t){Oe.set(c[0],1,0,0),Oe.set(c[1],0,1,0),Oe.set(c[2],0,0,1),Oe.set(c[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Oe.set(c[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Oe.set(c[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Oe.cross(c[6+3*i+0],c[i],c[0]),Oe.cross(c[6+3*i+1],c[i],c[1]),Oe.cross(c[6+3*i+1],c[i],c[2]);var n,r,a;Oe.subtract(d,e.center,e.halfExtents),Oe.add(f,e.center,e.halfExtents),n=d,r=f,a=u,Oe.set(a[0],n.x,r.y,r.z),Oe.set(a[1],n.x,r.y,n.z),Oe.set(a[2],n.x,n.y,r.z),Oe.set(a[3],n.x,n.y,n.z),Oe.set(a[4],r.x,r.y,r.z),Oe.set(a[5],r.x,r.y,n.z),Oe.set(a[6],r.x,n.y,r.z),Oe.set(a[7],r.x,n.y,n.z),$p(t.center,t.halfExtents,c[3],c[4],c[5],h);for(var s=0;s<15;++s){var o=e_(u,c[s]),l=e_(h,c[s]);if(l[0]>o[1]||o[0]>l[1])return 0}return 1}}(),c_=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=Oe.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},u_=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===c_(e,t.planes[i]))return 0;return 1},h_=function(){for(var c=new Array(8),u=0,h=0,e=0;e<c.length;e++)c[e]=Oe.create(0,0,0);return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=c_(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Oe.subtract(c[a],t.vertices[a],e.center);for(var s=h=u=0;s<t.vertices.length;s++)c[s].x>e.halfExtents.x?u++:c[s].x<-e.halfExtents.x&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var o=h=u=0;o<t.vertices.length;o++)c[o].y>e.halfExtents.y?u++:c[o].y<-e.halfExtents.y&&h++;if(u===t.vertices.length||h===t.vertices.length)return 0;for(var l=h=u=0;l<t.vertices.length;l++)c[l].z>e.halfExtents.z?u++:c[l].z<-e.halfExtents.z&&h++;return u===t.vertices.length||h===t.vertices.length?0:1}}(),d_=(t_=Oe.create(0,0,0),i_=Me.create(),function(e,t){return Oe.subtract(t_,t,e.center),Oe.transformMat3(t_,t_,Me.transpose(i_,e.orientation)),i=t_,n=e.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),f_=(n_=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*n_(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*n_(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*n_(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=Oe.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),p_=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===f_(e,t.planes[i]))return 0;return 1},__=function(){for(var c=new Array(8),u=0,h=0,d=0,e=0;e<c.length;e++)c[e]=Oe.create(0,0,0);var f=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(e,t){for(var i=0,n=!1,r=0;r<t.planes.length;r++){if(-1===(i=f_(e,t.planes[r])))return 0;1===i&&(n=!0)}if(!n)return 1;for(var a=0;a<t.vertices.length;a++)Oe.subtract(c[a],t.vertices[a],e.center);for(var s=d=h=0;s<t.vertices.length;s++)(u=f(c[s],e.orientation.m00,e.orientation.m01,e.orientation.m02))>e.halfExtents.x?h++:u<-e.halfExtents.x&&d++;if(h===t.vertices.length||d===t.vertices.length)return 0;for(var o=d=h=0;o<t.vertices.length;o++)(u=f(c[o],e.orientation.m03,e.orientation.m04,e.orientation.m05))>e.halfExtents.y?h++:u<-e.halfExtents.y&&d++;if(h===t.vertices.length||d===t.vertices.length)return 0;for(var l=d=h=0;l<t.vertices.length;l++)(u=f(c[l],e.orientation.m06,e.orientation.m07,e.orientation.m08))>e.halfExtents.z?h++:u<-e.halfExtents.z&&d++;return h===t.vertices.length||d===t.vertices.length?0:1}}(),v_=function(){for(var s=new Array(15),e=0;e<15;e++)s[e]=Oe.create(0,0,0);for(var o=new Array(8),l=new Array(8),t=0;t<8;t++)o[t]=Oe.create(0,0,0),l[t]=Oe.create(0,0,0);return function(e,t){Oe.set(s[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),Oe.set(s[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),Oe.set(s[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),Oe.set(s[3],t.orientation.m00,t.orientation.m01,t.orientation.m02),Oe.set(s[4],t.orientation.m03,t.orientation.m04,t.orientation.m05),Oe.set(s[5],t.orientation.m06,t.orientation.m07,t.orientation.m08);for(var i=0;i<3;++i)Oe.cross(s[6+3*i+0],s[i],s[0]),Oe.cross(s[6+3*i+1],s[i],s[1]),Oe.cross(s[6+3*i+1],s[i],s[2]);$p(e.center,e.halfExtents,s[0],s[1],s[2],o),$p(t.center,t.halfExtents,s[3],s[4],s[5],l);for(var n=0;n<15;++n){var r=e_(o,s[n]),a=e_(l,s[n]);if(a[0]>r[1]||r[0]>a[1])return 0}return 1}}(),m_=function(e,t){var i=Oe.dot(t.n,e.center),n=e.radius*Oe.magnitude(t.n);return i+n<t.d?-1:i-n>t.d?0:1},y_=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===m_(e,t.planes[i]))return 0;return 1},g_=(r_=Oe.create(0,0,0),a_=[1,-1,1,-1,1,-1],function(e,t){for(var i=0;i<6;i++){var n=t.planes[i],r=e.radius,a=e.center,s=n.n,o=n.d,l=Oe.dot(s,a);if(l+r<o)return 0;if(!(o<l-r)){Oe.add(r_,a,Oe.scale(r_,s,r));for(var c=0;c<6;c++)if(c!==i&&c!==i+a_[i]){var u=t.planes[c];if(Oe.dot(u.n,r_)<u.d)return 0}}}return 1}),b_=function(e,t){var i=e.radius+t.radius;return Oe.sqrDist(e.center,t.center)<i*i},S_=(s_=Oe.create(),function(e,t){return np(s_,e.center,t),Oe.sqrDist(e.center,s_)<e.radius*e.radius}),T_=(o_=Oe.create(),function(e,t){return rp(o_,e.center,t),Oe.sqrDist(e.center,o_)<e.radius*e.radius}),E_={ray_sphere:Kp,ray_aabb:Qp,ray_obb:Zp,ray_plane:Wp,ray_triangle:jp,line_plane:Xp,line_triangle:qp,line_quad:Yp,sphere_sphere:b_,sphere_aabb:S_,sphere_obb:T_,sphere_plane:m_,sphere_frustum:y_,sphere_frustum_accurate:g_,aabb_aabb:Jp,aabb_obb:l_,aabb_plane:c_,aabb_frustum:u_,aabb_frustum_accurate:h_,obb_obb:v_,obb_plane:f_,obb_frustum:p_,obb_frustum_accurate:__,obb_point:d_,resolve:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,a=this[n|r];return n<r?a(e,t,i):a(t,e,i)}};E_[qf.SHAPE_RAY|qf.SHAPE_SPHERE]=Kp,E_[qf.SHAPE_RAY|qf.SHAPE_AABB]=Qp,E_[qf.SHAPE_RAY|qf.SHAPE_OBB]=Zp,E_[qf.SHAPE_RAY|qf.SHAPE_PLANE]=Wp,E_[qf.SHAPE_RAY|qf.SHAPE_TRIANGLE]=jp,E_[qf.SHAPE_LINE|qf.SHAPE_PLANE]=Xp,E_[qf.SHAPE_LINE|qf.SHAPE_TRIANGLE]=qp,E_[qf.SHAPE_SPHERE]=b_,E_[qf.SHAPE_SPHERE|qf.SHAPE_AABB]=S_,E_[qf.SHAPE_SPHERE|qf.SHAPE_OBB]=T_,E_[qf.SHAPE_SPHERE|qf.SHAPE_PLANE]=m_,E_[qf.SHAPE_SPHERE|qf.SHAPE_FRUSTUM]=y_,E_[qf.SHAPE_SPHERE|qf.SHAPE_FRUSTUM_ACCURATE]=g_,E_[qf.SHAPE_AABB]=Jp,E_[qf.SHAPE_AABB|qf.SHAPE_OBB]=l_,E_[qf.SHAPE_AABB|qf.SHAPE_PLANE]=c_,E_[qf.SHAPE_AABB|qf.SHAPE_FRUSTUM]=u_,E_[qf.SHAPE_AABB|qf.SHAPE_FRUSTUM_ACCURATE]=h_,E_[qf.SHAPE_OBB]=v_,E_[qf.SHAPE_OBB|qf.SHAPE_PLANE]=f_,E_[qf.SHAPE_OBB|qf.SHAPE_FRUSTUM]=p_,E_[qf.SHAPE_OBB|qf.SHAPE_FRUSTUM_ACCURATE]=__;var x_=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.s=void 0,this.e=void 0,this._type=void 0,this._type=qf.SHAPE_LINE,this.s=Oe.create(e,t,i),this.e=Oe.create(n,r,a)}return l(s,null,[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)}},{key:"copy",value:function(e,t){return Oe.copy(e.s,t.s),Oe.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return Oe.copy(e.s,t),Oe.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=s,e}},{key:"magnitude",value:function(e){return Oe.distance(e.s,e.e)}},{key:"mag",value:function(e){return s.magnitude(e)}}]),s}(),A_=Oe.create(0,0,0),C_=Oe.create(0,0,0),w_=cc.mat4(),R_=cc.v4(),k_=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;y(this,r),this.n=void 0,this.d=void 0,this._type=void 0,this._type=qf.SHAPE_PLANE,this.n=Oe.create(e,t,i),this.d=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.n.x,e.n.y,e.n.z,e.d)}},{key:"copy",value:function(e,t){return Oe.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return Oe.subtract(A_,i,t),Oe.subtract(C_,n,t),Oe.normalize(e.n,Oe.cross(e.n,A_,C_)),e.d=Oe.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return Oe.copy(e.n,t),e.d=Oe.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=Oe.magnitude(t.n);return Oe.normalize(e.n,t.n),0<i&&(e.d=t.d/i),e}}]),l(r,[{key:"transform",value:function(e){He.invert(w_,e),He.transpose(w_,w_),Be.set(R_,this.n.x,this.n.y,this.n.z,this.d),Be.transformMat4(R_,R_,w_),Oe.set(this.n,R_.x,R_.y,R_.z),this.d=R_.w}}]),r}(),O_=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:-1;y(this,s),this.o=void 0,this.d=void 0,this._type=void 0,this._type=qf.SHAPE_RAY,this.o=Oe.create(e,t,i),this.d=Oe.create(n,r,a)}return l(s,null,[{key:"create",value:function(){return new s(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,5<arguments.length&&void 0!==arguments[5]?arguments[5]:1)}},{key:"clone",value:function(e){return new s(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)}},{key:"copy",value:function(e,t){return Oe.copy(e.o,t.o),Oe.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return Oe.copy(e.o,t),Oe.normalize(e.d,Oe.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,s){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=s,e}}]),s}(),F_=function(){function c(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:1,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0;y(this,c),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=qf.SHAPE_TRIANGLE,this.a=Oe.create(e,t,i),this.b=Oe.create(n,r,a),this.c=Oe.create(s,o,l)}return l(c,null,[{key:"create",value:function(){return new c(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,6<arguments.length&&void 0!==arguments[6]?arguments[6]:0,7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,8<arguments.length&&void 0!==arguments[8]?arguments[8]:1)}},{key:"clone",value:function(e){return new c(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)}},{key:"copy",value:function(e,t){return Oe.copy(e.a,t.a),Oe.copy(e.b,t.b),Oe.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return Oe.copy(e.a,t),Oe.copy(e.b,i),Oe.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=s,e.c.x=o,e.c.y=l,e.c.z=c,e}}]),c}(),L_=Oe.create();function B_(e){return Math.max(Math.max(e.x,e.y),e.z)}var M_=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1;y(this,r),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=qf.SHAPE_SPHERE,this.center=Oe.create(e,t,i),this.radius=n}return l(r,null,[{key:"create",value:function(e,t,i,n){return new r(e,t,i,n)}},{key:"clone",value:function(e){return new r(e.center.x,e.center.y,e.center.z,e.radius)}},{key:"copy",value:function(e,t){return Oe.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return Oe.scale(e.center,Oe.add(L_,t,i),.5),e.radius=.5*Oe.mag(Oe.subtract(L_,i,t)),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}}]),l(r,[{key:"clone",value:function(){return r.clone(this)}},{key:"copy",value:function(e){return r.copy(this,e)}},{key:"getBoundary",value:function(e,t){Oe.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Oe.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){Oe.transformMat4(r.center,this.center,e),r.radius=this.radius*B_(n)}},{key:"translateAndRotate",value:function(e,t,i){Oe.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*B_(e)}}]),r}(),I_=Oe.create(),P_=Oe.create(),D_=Oe.create(),N_=Oe.create(),z_=Me.create(),U_=function(e,t,i){z_.m00=Math.abs(i.m00),z_.m01=Math.abs(i.m01),z_.m02=Math.abs(i.m02),z_.m03=Math.abs(i.m04),z_.m04=Math.abs(i.m05),z_.m05=Math.abs(i.m06),z_.m06=Math.abs(i.m08),z_.m07=Math.abs(i.m09),z_.m08=Math.abs(i.m10),Oe.transformMat3(e,t,z_)},G_=function(){function s(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1;y(this,s),this.center=void 0,this.halfExtents=void 0,this._type=qf.SHAPE_AABB,this.center=Oe.create(e,t,i),this.halfExtents=Oe.create(n,r,a)}return l(s,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a){return new s(e,t,i,n,r,a)}},{key:"clone",value:function(e){return new s(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)}},{key:"copy",value:function(e,t){return Oe.copy(e.center,t.center),Oe.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return Oe.scale(e.center,Oe.add(I_,t,i),.5),Oe.scale(e.halfExtents,Oe.subtract(P_,i,t),.5),e}},{key:"set",value:function(e,t,i,n,r,a,s){return Oe.set(e.center,t,i,n),Oe.set(e.halfExtents,r,a,s),e}},{key:"merge",value:function(e,t,i){return Oe.subtract(I_,t.center,t.halfExtents),Oe.subtract(P_,i.center,i.halfExtents),Oe.add(D_,t.center,t.halfExtents),Oe.add(N_,i.center,i.halfExtents),Oe.max(N_,D_,N_),Oe.min(D_,I_,P_),s.fromPoints(e,D_,N_)}},{key:"transform",value:function(e,t,i){return Oe.transformMat4(e.center,t.center,i),U_(e.halfExtents,t.halfExtents,i),e}}]),l(s,[{key:"getBoundary",value:function(e,t){Oe.subtract(e,this.center,this.halfExtents),Oe.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){Oe.transformMat4(r.center,this.center,e),U_(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return s.clone(this)}},{key:"copy",value:function(e){return s.copy(this,e)}}]),s}(),V_=Oe.create(),H_=Oe.create(),W_=Me.create(),X_=function(){function _(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:1,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:1,s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:1,o=7<arguments.length&&void 0!==arguments[7]?arguments[7]:0,l=8<arguments.length&&void 0!==arguments[8]?arguments[8]:0,c=9<arguments.length&&void 0!==arguments[9]?arguments[9]:0,u=10<arguments.length&&void 0!==arguments[10]?arguments[10]:1,h=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,d=12<arguments.length&&void 0!==arguments[12]?arguments[12]:0,f=13<arguments.length&&void 0!==arguments[13]?arguments[13]:0,p=14<arguments.length&&void 0!==arguments[14]?arguments[14]:1;y(this,_),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=qf.SHAPE_OBB,this.center=Oe.create(e,t,i),this.halfExtents=Oe.create(n,r,a),this.orientation=Me.create(s,o,l,c,u,h,d,f,p)}return l(_,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(e,t,i,n,r,a,s,o,l,c,u,h,d,f,p){return new _(e,t,i,n,r,a,s,o,l,c,u,h,d,f,p)}},{key:"clone",value:function(e){return new _(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)}},{key:"copy",value:function(e,t){return Oe.copy(e.center,t.center),Oe.copy(e.halfExtents,t.halfExtents),Me.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return Oe.scale(e.center,Oe.add(V_,t,i),.5),Oe.scale(e.halfExtents,Oe.subtract(H_,i,t),.5),Me.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,s,o,l,c,u,h,d,f,p,_){return Oe.set(e.center,t,i,n),Oe.set(e.halfExtents,r,a,s),Me.set(e.orientation,o,l,c,u,h,d,f,p,_),e}}]),l(_,[{key:"getBoundary",value:function(e,t){var i,n,r;i=V_,n=this.halfExtents,r=this.orientation,W_.m00=Math.abs(r.m00),W_.m01=Math.abs(r.m01),W_.m02=Math.abs(r.m02),W_.m03=Math.abs(r.m03),W_.m04=Math.abs(r.m04),W_.m05=Math.abs(r.m05),W_.m06=Math.abs(r.m06),W_.m07=Math.abs(r.m07),W_.m08=Math.abs(r.m08),Oe.transformMat3(i,n,W_),Oe.subtract(e,this.center,V_),Oe.add(t,this.center,V_)}},{key:"transform",value:function(e,t,i,n,r){Oe.transformMat4(r.center,this.center,e),Me.fromQuat(r.orientation,i),Oe.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){Oe.transformMat4(i.center,this.center,e),Me.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){Oe.multiply(t.halfExtents,this.halfExtents,e)}}]),_}(),j_=new Array(8);j_[0]=Oe.create(1,1,1),j_[1]=Oe.create(-1,1,1),j_[2]=Oe.create(-1,-1,1),j_[3]=Oe.create(1,-1,1),j_[4]=Oe.create(1,1,-1),j_[5]=Oe.create(-1,1,-1),j_[6]=Oe.create(-1,-1,-1),j_[7]=Oe.create(1,-1,-1);var q_,Y_=function(){function i(){y(this,i),this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=qf.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=k_.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=Oe.create()}return l(i,[{key:"accurate",set:function(e){this._type=e?qf.SHAPE_FRUSTUM_ACCURATE:qf.SHAPE_FRUSTUM}}],[{key:"create",value:function(){return new i}},{key:"clone",value:function(e){return i.copy(new i,e)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)k_.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)Oe.copy(e.vertices[n],t.vertices[n]);return e}}]),l(i,[{key:"update",value:function(e,t){if(Oe.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Oe.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Oe.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Oe.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Oe.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Oe.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===qf.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/Oe.magnitude(n.n);Oe.scale(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)Oe.transformMat4(this.vertices[a],j_[a],t)}}},{key:"transform",value:function(e){if(this._type===qf.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Oe.transformMat4(this.vertices[t],this.vertices[t],e);k_.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),k_.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),k_.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),k_.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),k_.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),k_.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),i}();Y_.createOrtho=(q_=new Br,function(e,t,i,n,r,a){var s=t/2,o=i/2;Oe.set(q_,s,o,n),Oe.transformMat4(e.vertices[0],q_,a),Oe.set(q_,-s,o,n),Oe.transformMat4(e.vertices[1],q_,a),Oe.set(q_,-s,-o,n),Oe.transformMat4(e.vertices[2],q_,a),Oe.set(q_,s,-o,n),Oe.transformMat4(e.vertices[3],q_,a),Oe.set(q_,s,o,r),Oe.transformMat4(e.vertices[4],q_,a),Oe.set(q_,-s,o,r),Oe.transformMat4(e.vertices[5],q_,a),Oe.set(q_,-s,-o,r),Oe.transformMat4(e.vertices[6],q_,a),Oe.set(q_,s,-o,r),Oe.transformMat4(e.vertices[7],q_,a),k_.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),k_.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),k_.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),k_.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),k_.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),k_.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])});var K_=function(){function n(e,t){y(this,n),this._cursor=void 0,this._data=void 0,this._cursor=0,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"request",value:function(){var e=this._data[this._cursor];return this._cursor=(this._cursor+1)%this._data.length,e}}]),n}(),Q_=32,Z_=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function J_(e){return e<1e5?e<100?e<10?0:1:e<1e4?e<1e3?2:3:4:e<1e7?e<1e6?5:6:e<1e9?e<1e8?7:8:9}function $_(e,t){if(e===t)return 0;if(~~e===e&&~~t===t){if(0===e||0===t)return e<t?-1:1;if(e<0||t<0){if(0<=t)return-1;if(0<=e)return 1;e=-e,t=-t}var i=J_(e),n=J_(t),r=0;return i<n?(e*=Z_[n-i-1],t/=10,r=-1):n<i&&(t*=Z_[i-n-1],e/=10,r=1),e===t?r:e<t?-1:1}var a=String(e),s=String(t);return a===s?0:a<s?-1:1}function ev(e,t,i,n){var r=t+1;if(r===i)return 1;if(n(e[r++],e[t])<0){for(;r<i&&n(e[r],e[r-1])<0;)r++;!function(e,t,i){i--;for(;t<i;){var n=e[t];e[t++]=e[i],e[i--]=n}}(e,t,r)}else for(;r<i&&0<=n(e[r],e[r-1]);)r++;return r-t}function tv(e,t,i,n,r){for(n===t&&n++;n<i;n++){for(var a=e[n],s=t,o=n;s<o;){var l=s+o>>>1;r(a,e[l])<0?o=l:s=l+1}var c=n-s;switch(c){case 3:e[s+3]=e[s+2];case 2:e[s+2]=e[s+1];case 1:e[s+1]=e[s];break;default:for(;0<c;)e[s+c]=e[s+c-1],c--}e[s]=a}}function iv(e,t,i,n,r,a){var s=0,o=0,l=1;if(0<a(e,t[i+r])){for(o=n-r;l<o&&0<a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}else{for(o=r+1;l<o&&a(e,t[i+r-l])<=0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}for(s++;s<l;){var u=s+(l-s>>>1);0<a(e,t[i+u])?s=u+1:l=u}return l}function nv(e,t,i,n,r,a){var s=0,o=0,l=1;if(a(e,t[i+r])<0){for(o=r+1;l<o&&a(e,t[i+r-l])<0;)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o);var c=s;s=r-l,l=r-c}else{for(o=n-r;l<o&&0<=a(e,t[i+r+l]);)(l=1+((s=l)<<1))<=0&&(l=o);o<l&&(l=o),s+=r,l+=r}for(s++;s<l;){var u=s+(l-s>>>1);a(e,t[i+u])<0?l=u:s=u+1}return l}var rv=function(){function i(e,t){y(this,i),this.array=void 0,this.compare=void 0,this.minGallop=void 0,this.length=void 0,this.tmpStorageLength=void 0,this.tmp=void 0,this.stackLength=void 0,this.runStart=void 0,this.runLength=void 0,this.stackSize=void 0,this.array=e,this.compare=t,this.minGallop=7,this.length=e.length,this.tmpStorageLength=256,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength),this.stackSize=0}return l(i,[{key:"pushRun",value:function(e,t){this.runStart[this.stackSize]=e,this.runLength[this.stackSize]=t,this.stackSize+=1}},{key:"mergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;if(1<=e&&this.runLength[e-1]<=this.runLength[e]+this.runLength[e+1]||2<=e&&this.runLength[e-2]<=this.runLength[e]+this.runLength[e-1])this.runLength[e-1]<this.runLength[e+1]&&e--;else if(this.runLength[e]>this.runLength[e+1])break;this.mergeAt(e)}}},{key:"forceMergeRuns",value:function(){for(;1<this.stackSize;){var e=this.stackSize-2;0<e&&this.runLength[e-1]<this.runLength[e+1]&&e--,this.mergeAt(e)}}},{key:"mergeAt",value:function(e){var t=this.compare,i=this.array,n=this.runStart[e],r=this.runLength[e],a=this.runStart[e+1],s=this.runLength[e+1];this.runLength[e]=r+s,e===this.stackSize-3&&(this.runStart[e+1]=this.runStart[e+2],this.runLength[e+1]=this.runLength[e+2]),this.stackSize--;var o=nv(i[a],i,n,r,0,t);n+=o,0!==(r-=o)&&0!==(s=iv(i[n+r-1],i,a,s,s-1,t))&&(r<=s?this.mergeLow(n,r,a,s):this.mergeHigh(n,r,a,s))}},{key:"mergeLow",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<t;o++)s[o]=a[e+o];var l=0,c=i,u=e;if(a[u++]=a[c++],0!=--n)if(1!==t){for(var h=this.minGallop;;){var d=0,f=0,p=!1;do{if(r(a[c],s[l])<0){if(a[u++]=a[c++],f++,(d=0)==--n){p=!0;break}}else if(a[u++]=s[l++],d++,f=0,1==--t){p=!0;break}}while((d|f)<h);if(p)break;do{if(0!==(d=nv(a[c],s,l,t,0,r))){for(o=0;o<d;o++)a[u+o]=s[l+o];if(u+=d,l+=d,(t-=d)<=1){p=!0;break}}if(a[u++]=a[c++],0==--n){p=!0;break}if(0!==(f=iv(s[l],a,c,n,0,r))){for(o=0;o<f;o++)a[u+o]=a[c+o];if(u+=f,c+=f,0===(n-=f)){p=!0;break}}if(a[u++]=s[l++],1==--t){p=!0;break}h--}while(7<=d||7<=f);if(p)break;h<0&&(h=0),h+=2}if((this.minGallop=h)<1&&(this.minGallop=1),1===t){for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else{if(0===t)throw new Error("mergeLow preconditions were not respected");for(o=0;o<t;o++)a[u+o]=s[l+o]}}else{for(o=0;o<n;o++)a[u+o]=a[c+o];a[u+n]=s[l]}else for(o=0;o<t;o++)a[u+o]=s[l+o]}},{key:"mergeHigh",value:function(e,t,i,n){var r=this.compare,a=this.array,s=this.tmp,o=0;for(o=0;o<n;o++)s[o]=a[i+o];var l=e+t-1,c=n-1,u=i+n-1,h=0,d=0;if(a[u--]=a[l--],0!=--t)if(1!==n){for(var f=this.minGallop;;){var p=0,_=0,v=!1;do{if(r(s[c],a[l])<0){if(a[u--]=a[l--],p++,(_=0)==--t){v=!0;break}}else if(a[u--]=s[c--],_++,p=0,1==--n){v=!0;break}}while((p|_)<f);if(v)break;do{if(0!==(p=t-nv(s[c],a,e,t,t-1,r))){for(t-=p,d=(u-=p)+1,h=(l-=p)+1,o=p-1;0<=o;o--)a[d+o]=a[h+o];if(0===t){v=!0;break}}if(a[u--]=s[c--],1==--n){v=!0;break}if(0!==(_=n-iv(a[l],s,0,n,n-1,r))){for(n-=_,d=(u-=_)+1,h=(c-=_)+1,o=0;o<_;o++)a[d+o]=s[h+o];if(n<=1){v=!0;break}}if(a[u--]=a[l--],0==--t){v=!0;break}f--}while(7<=p||7<=_);if(v)break;f<0&&(f=0),f+=2}if((this.minGallop=f)<1&&(this.minGallop=1),1===n){for(d=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[d+o]=a[h+o];a[u]=s[c]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}else{for(d=(u-=t)+1,h=(l-=t)+1,o=t-1;0<=o;o--)a[d+o]=a[h+o];a[u]=s[c]}else for(h=u-(n-1),o=0;o<n;o++)a[h+o]=s[o]}}]),i}();function av(e,t,i,n){if(!Array.isArray(e))throw new TypeError("Can only sort arrays");void 0===t&&(t=0),void 0===i&&(i=e.length),void 0===n&&(n=$_);var r=i-t;if(!(r<2)){var a=0;if(r<Q_)tv(e,t,i,t+(a=ev(e,t,i,n)),n);else{var s=new rv(e,n),o=function(e){for(var t=0;Q_<=e;)t|=1&e,e>>=1;return e+t}(r);do{if((a=ev(e,t,i,n))<o){var l=r;o<l&&(l=o),tv(e,t,t+l,t+a,n),a=l}s.pushRun(t,a),s.mergeRuns(),r-=a,t+=a}while(0!==r);s.forceMergeRuns()}}}for(var sv=function(){function t(e){y(this,t),this._count=void 0,this._data=void 0,this._count=0,this._data=new Array(e)}return l(t,[{key:"_resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=void 0}},{key:"reset",value:function(){for(var e=0;e<this._count;++e)this._data[e]=void 0;this._count=0}},{key:"push",value:function(e){this._count>=this._data.length&&this._resize(2*this._data.length),this._data[this._count]=e,++this._count}},{key:"pop",value:function(){--this._count,this._count<0&&(this._count=0);var e=this._data[this._count];return this._data[this._count]=void 0,e}},{key:"fastRemove",value:function(e){if(!(e>=this._count||e<0)){var t=this._count-1;this._data[e]=this._data[t],this._data[t]=void 0,this._count-=1}}},{key:"indexOf",value:function(e){return this._data.indexOf(e)}},{key:"sort",value:function(e){return av(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(),ov=function(){function i(e,t){y(this,i),this._fn=void 0,this._count=void 0,this._head=void 0,this._tail=void 0,this._pool=void 0,this._fn=e,this._count=0,this._head=null,this._tail=null,this._pool=new kn(e,t)}return l(i,[{key:"add",value:function(){var e=this._pool.alloc();return this._tail?(this._tail._next=e)._prev=this._tail:this._head=e,this._tail=e,this._count+=1,e}},{key:"remove",value:function(e){e._prev?e._prev._next=e._next:this._head=e._next,e._next?e._next._prev=e._prev:this._tail=e._prev,e._next=null,e._prev=null,this._pool.free(e),this._count-=1}},{key:"forEach",value:function(e,t){var i=this._head;if(i){t&&(e=e.bind(t));for(var n=0,r=i;i;)r=i._next,e(i,n,this),i=r,++n}}},{key:"head",get:function(){return this._head}},{key:"tail",get:function(){return this._tail}},{key:"length",get:function(){return this._count}}]),i}(),lv=function(){function n(e,t){y(this,n),this._fn=void 0,this._count=0,this._data=void 0,this._fn=e,this._data=new Array(t);for(var i=0;i<t;++i)this._data[i]=e()}return l(n,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"sort",value:function(e){return av(this._data,0,this._count,e)}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),n}(),cv=Array(8),uv=0;uv<8;++uv)cv[uv]=[];function hv(e){var t=(65535<e)<<4,i=(255<(e>>>=t))<<3;return t|=i,t|=i=(15<(e>>>=i))<<2,(t|=i=(3<(e>>>=i))<<1)|(e>>>=i)>>1}function dv(e){var t=function(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}(e),i=cv[hv(t)>>2];return 0<i.length?i.pop():new ArrayBuffer(t)}var fv={alloc_int8:function(e){var t=new Int8Array(dv(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint8:function(e){var t=new Uint8Array(dv(e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int16:function(e){var t=new Int16Array(dv(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint16:function(e){var t=new Uint16Array(dv(2*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_int32:function(e){var t=new Int32Array(dv(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_uint32:function(e){var t=new Uint32Array(dv(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float32:function(e){var t=new Float32Array(dv(4*e),0,e);return t.length!==e?t.subarray(0,e):t},alloc_float64:function(e){var t=new Float64Array(dv(8*e),0,e);return t.length!==e?t.subarray(0,e):t},free:function(e){var t;t=e.buffer,cv[hv(t.byteLength)>>2].push(t)},reset:function(){cv=Array(8);for(var e=0;e<8;++e)cv[e]=[]}},pv=function(e,t,i,n,r){return Oe.set(e,t.x*i,t.y*n,t.z*r)},_v=function(){function s(e,t,i,n,r,a){y(this,s),this.minPos=void 0,this.maxPos=void 0,this.boundingBox=void 0,this.capacity=void 0,this.depth=void 0,this.maxDepth=void 0,this.blocks=void 0,this.entries=void 0,this._getBoundingShape=void 0,this.minPos=e,this.maxPos=t,this.boundingBox=G_.fromPoints(G_.create(),e,t),this.capacity=i,this.depth=n,this.maxDepth=r,this._getBoundingShape=a,this.blocks=null,this.entries=new sv(this.capacity)}return l(s,[{key:"addEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else{var a=this._getBoundingShape(e);if(!E_.resolve(this.boundingBox,a))return;this.entries.push(e),this.entries.length>=this.capacity&&this.depth<this.maxDepth&&(this.blocks=vv.createBlocks(this.minPos,this.maxPos,this.entries,this.capacity,this.depth,this.maxDepth,this._getBoundingShape),this.entries.reset())}}},{key:"removeEntry",value:function(e){if(this.blocks){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.entries.fastRemove(this.entries.indexOf(e))}},{key:"select",value:function(e,t){if(E_.resolve(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.select(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}},{key:"frustumSelect",value:function(e,t){if(E_.aabb_frustum(this.boundingBox,t))if(this.blocks){var i=this.blocks,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.frustumSelect(e,t)}}else for(var s=0;s<this.entries.length;s++)e.add(this.entries.data[s])}}]),s}(),vv=function(){function u(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:32,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:5;y(this,u),this.blockCapacity=void 0,this.maxDepth=void 0,this.blocks=void 0,this.dynamics=void 0,this._selection=void 0,this._getBoundingShape=void 0,this.blockCapacity=t,this.maxDepth=i,this.blocks=[],this.dynamics=[],this._selection=new Set,this._getBoundingShape=function(){return e._getBoundingShape}}return l(u,null,[{key:"createBlocks",value:function(e,t,i,n,r,a,s){var o=[],l=Oe.create();Oe.scale(l,Oe.subtract(l,t,e),.5);for(var c=0;c<2;c++)for(var u=0;u<2;u++)for(var h=0;h<2;h++){var d=Oe.create(),f=Oe.create();Oe.add(d,e,pv(d,l,c,u,h)),Oe.add(f,e,pv(f,l,c+1,u+1,h+1));for(var p=new _v(d,f,n,r+1,a,s),_=0;_<i.length;_++){var v=(i.data||i)[_];p.addEntry(v)}o.push(p)}return o}}]),l(u,[{key:"build",value:function(e,t){var i=Oe.create(1/0,1/0,1/0),n=Oe.create(-1/0,-1/0,-1/0),r=Oe.create(),a=Oe.create(),s=[];this.dynamics=[];for(var o=0;o<e.length;o++){var l=(e.data||e)[o],c=t(l);c?(c.getBoundary(r,a),Oe.min(i,i,r),Oe.max(n,n,a),s.push(l)):this.dynamics.push(l)}this.blocks=u.createBlocks(i,n,s,this.blockCapacity,0,this.maxDepth,t),this._getBoundingShape=t}},{key:"addEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.addEntry(e)}}else this.dynamics.push(e)}},{key:"removeEntry",value:function(e){if(this._getBoundingShape(e).shape){var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.removeEntry(e)}}else this.dynamics.splice(this.dynamics.indexOf(e),1)}},{key:"select",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.select(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}},{key:"frustumSelect",value:function(e){this._selection.clear();var t=this.blocks,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.frustumSelect(this._selection,e)}var a=this.dynamics,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;this._selection.add(c)}return this._selection}}]),u}(),mv=ai({Default:0,Once:1,Loop:2,PingPong:3,ClampForever:4}),yv=function e(){y(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Yi.fastDefine("cc.Keyframe",yv,{time:0,value:0,inTangent:0,outTangent:0});var gv=function(){function e(){y(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return l(e,[{key:"evaluate",value:function(e){var t,i,n=e-this.time;return t=n,i=this.coefficient,t*(t*(t*i[0]+i[1])+i[2])+i[3]}}]),e}();var bv=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;y(this,t),this.keyFrames=void 0,this.preWrapMode=mv.Loop,this.postWrapMode=mv.Loop,this.cachedKey=void 0,this.keyFrames=e||[].concat(t.defaultKF),this.cachedKey=new gv}return l(t,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case mv.Loop:t=ge(e-n,r-n)+n;break;case mv.PingPong:t=be(e-n,r-n)+n;break;case mv.ClampForever:t=le(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var s=0;s<this.keyFrames.length-1;s++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[s+1].time){a=s;break}var o=this.keyFrames[a],l=this.keyFrames[a+1],c=Se(o.time,l.time,t),u=l.time-o.time,h=o.outTangent*u,d=l.inTangent*u,f=c*c,p=f*c,_=p-2*f+c,v=p-f,m=-2*p+3*f;return(2*p-3*f+1)*o.value+_*h+v*d+m*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case mv.Loop:t=ge(e-n,r-n)+n;break;case mv.PingPong:t=be(e-n,r-n)+n;break;case mv.ClampForever:t=le(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),s=a+1;return s===this.keyFrames.length&&(s-=1),this.calcOptimizedKey(this.cachedKey,a,s),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,s=r.value-n.value,o=1/(a*a),l=n.outTangent*a,c=r.inTangent*a;e.coefficient[0]=(l+c-s-s)*o/a,e.coefficient[1]=(s+s+s-l-l-c)*o,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(this.keyFrames[i].time<t)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var s=i-a;if(0<=s&&this.keyFrames[s-1].time<=t)return s-1}for(var o=0,l=this.keyFrames.length,c=Math.floor((o+l)/2);1<l-o;)this.keyFrames[c].time>=t?l=c:o=c+1,c=Math.floor((o+l)/2);return o}}]),t}();bv.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Yi.fastDefine("cc.AnimationCurve",bv,{preWrapMode:mv.Default,postWrapMode:mv.Default,keyFrames:[]});var Sv=Object.freeze({distance:Hp,enums:qf,intersect:E_,line:x_,plane:k_,ray:O_,triangle:F_,sphere:M_,aabb:G_,obb:X_,frustum:Y_,Octree:vv,Keyframe:yv,AnimationCurve:bv}),Tv=function(){function e(){y(this,e),this._subMeshObject=void 0,this._inputAssembler=void 0,this._material=void 0,this._cmdBuffers=void 0,this._psos=void 0,this._priority=void 0,this._subMeshObject=null,this._material=null,this._cmdBuffers=new Array,this._psos=null,this._inputAssembler=null,this._priority=yf.DEFAULT}return l(e,[{key:"initialize",value:function(e,t,i){this._psos=i,this.subMeshData=e,this.material=t}},{key:"destroy",value:function(){this._inputAssembler&&this._inputAssembler.destroy();for(var e=0;e<this.passes.length;e++)this.passes[e].destroyPipelineState(this._psos[e]);var t=this._cmdBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}this._cmdBuffers.splice(0),this._material=null}},{key:"updateCommandBuffer",value:function(){if(this._material){for(var e=0;e<this._material.passes.length;e++)this._subMeshObject&&this._material.passes[e].primitive!==this._subMeshObject.primitiveMode&&console.warn("mesh primitive type doesn't match with pass settings"),this.recordCommandBuffer(e);for(var t=this._cmdBuffers.length-1;t>=this._material.passes.length;t--){var i=this._cmdBuffers.pop();i&&i.destroy()}}}},{key:"recordCommandBuffer",value:function(e){var t=cc.director.root.device,i=this._psos[e];if(null==this._cmdBuffers[e]){var n={allocator:t.commandAllocator,type:za.SECONDARY};this._cmdBuffers[e]=t.createCommandBuffer(n)}else this._cmdBuffers[e].status===jr.UNREADY&&this._cmdBuffers[e].initialize({allocator:t.commandAllocator,type:za.SECONDARY});var r=this._inputAssembler,a=this._cmdBuffers[e];a.begin(),a.bindPipelineState(i),a.bindBindingLayout(i.pipelineLayout.layouts[0]),a.bindInputAssembler(r),a.draw(r),a.end()}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"subMeshData",set:function(e){this._inputAssembler&&this._inputAssembler.destroy(),this._subMeshObject=e;var t={};t.attributes=this._subMeshObject.attributes,t.vertexBuffers=this._subMeshObject.vertexBuffers,this._subMeshObject.indexBuffer&&(t.indexBuffer=this._subMeshObject.indexBuffer),this._subMeshObject.indirectBuffer&&(t.indirectBuffer=this._subMeshObject.indirectBuffer),this._inputAssembler?this._inputAssembler.initialize(t):this._inputAssembler=cc.director.root.device.createInputAssembler(t)},get:function(){return this._subMeshObject}},{key:"psos",get:function(){return this._psos},set:function(e){this._psos=e}},{key:"material",set:function(e){null!=(this._material=e)&&this.updateCommandBuffer()},get:function(){return this._material}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"passes",get:function(){return this._material.passes}},{key:"commandBuffers",get:function(){return this._cmdBuffers}}]),e}(),Ev=He.create(),xv=new kn(function(){return new Tv},32);function Av(e){var t=0,i=e.members,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=hs(s.type)*s.count}return t}var Cv,wv,Rv,kv,Ov,Fv,Lv,Bv=function(){function i(e,t){y(this,i),this._type="default",this._device=void 0,this._scene=void 0,this._node=void 0,this._transform=void 0,this._id=void 0,this._enabled=!1,this._viewID=1,this._cameraID=-1,this._userKey=-1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._matPSORecord=void 0,this._matRefCount=void 0,this._uboLocal=void 0,this._localUBO=null,this._localBindings=new Map,this._inited=!1,this._uboUpdated=!1,this._castShadow=!1,this._device=cc.director.root.device,this._scene=e,this._id=this._scene.generateModelId(),this._transform=this._node=t,this._matPSORecord=new Map,this._matRefCount=new Map,this._uboLocal=new Cf}return l(i,[{key:"scene",set:function(e){this._scene=e,this._id=this._scene.generateModelId()},get:function(){return this._scene}},{key:"id",get:function(){return this._id}},{key:"subModelNum",get:function(){return this._subModels.length}},{key:"inited",get:function(){return this._inited}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"viewID",get:function(){return this._viewID},set:function(e){this._viewID=e}},{key:"userKey",set:function(e){this._userKey=e}},{key:"uboLocal",get:function(){return this._uboLocal}},{key:"localUBO",get:function(){return this._localUBO}},{key:"localBindings",get:function(){return this._localBindings}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"UBOUpdated",get:function(){return this._uboUpdated}}]),l(i,[{key:"destroy",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.destroy(),xv.free(r)}for(var a=this._localBindings.values(),s=a.next();!s.done;){var o=s.value;o.buffer&&(o.buffer.destroy(),o.buffer=void 0),s=a.next()}this._localBindings.has(wf.BLOCK.name)&&this._localBindings.delete(wf.BLOCK.name),this._worldBounds=null,this._modelBounds=null,this._subModels.splice(0),this._matPSORecord.clear(),this._matRefCount.clear(),this._inited=!1}},{key:"getSubModel",value:function(e){return this._subModels[e]}},{key:"updateTransform",value:function(){var e=this._transform;e.hasChanged&&(e.updateWorldTransformFull(),this._modelBounds&&this._worldBounds&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))}},{key:"_resetUBOUpdateFlag",value:function(){this._uboUpdated=!1}},{key:"updateUBOs",value:function(){if(this._uboUpdated)return!1;this._uboUpdated=!0;var e=this._transform._mat;He.array(this._uboLocal.view,e,Cf.MAT_WORLD_OFFSET),He.inverseTranspose(Ev,e),He.array(this._uboLocal.view,Ev,Cf.MAT_WORLD_IT_OFFSET);var t=this._localBindings.get(Cf.BLOCK.name);t&&t.buffer&&t.buffer.update(this._uboLocal.view);var i=this._matPSORecord.keys(),n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.passes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}u.update()}var h=this._matPSORecord.get(s),d=Array.isArray(h),f=0;for(h=d?h:h[Symbol.iterator]();;){var p;if(d){if(f>=h.length)break;p=h[f++]}else{if((f=h.next()).done)break;p=f.value}p.pipelineLayout.layouts[0].update()}}return!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=G_.fromPoints(G_.create(),e,t),this._worldBounds=G_.clone(this._modelBounds),this._transform.updateWorldTransformFull(),this._modelBounds.transform(this._transform._mat,this._transform._pos,this._transform._rot,this._transform._scale,this._worldBounds))}},{key:"initSubModel",value:function(e,t,i){if(this.initLocalBindings(i),null==this._subModels[e])this._subModels[e]=xv.alloc();else{var n=this._subModels[e].material;this._subModels[e].destroy(),this.releasePSO(n)}this.allocatePSO(i),this._subModels[e].initialize(t,i,this._matPSORecord.get(i)),this._inited=!0}},{key:"setSubModelMesh",value:function(e,t){null==this._subModels[e]&&(this._subModels[e]=xv.alloc()),this._subModels[e].subMeshData=t}},{key:"setSubModelMaterial",value:function(e,t){null!=this._subModels[e]&&(this.initLocalBindings(t),this._subModels[e].material===t?t&&(this.destroyPipelineState(t,this._matPSORecord.get(t)),this._matPSORecord.set(t,this.createPipelineState(t))):(this._subModels[e].material&&this.releasePSO(this._subModels[e].material),t&&this.allocatePSO(t)),this._subModels[e].psos=t&&this._matPSORecord.get(t)||null,this._subModels[e].material=t)}},{key:"onPipelineChange",value:function(){var e=this._subModels,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}for(var r=n,a=r.material,s=this._matPSORecord.get(a),o=0;o<a.passes.length;o++){var l=a.passes[o];l.tryCompile(),l.destroyPipelineState(s[o]),s[o]=this._doCreatePSO(l)}r.updateCommandBuffer()}}},{key:"createPipelineState",value:function(e){for(var t=new Array(e.passes.length),i=0;i<t.length;i++){var n=e.passes[i],r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;jf.attach(l,this)}t[i]=this._doCreatePSO(n)}return t}},{key:"destroyPipelineState",value:function(e,t){for(var i=0;i<e.passes.length;i++){var n=e.passes[i];n.destroyPipelineState(t[i]);var r=n.customizations,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;jf.detach(l,this)}}}},{key:"_doCreatePSO",value:function(e){var t=e.createPipelineState();return t.pipelineLayout.layouts[0].bindBuffer(Cf.BLOCK.binding,this._localBindings.get(Cf.BLOCK.name).buffer),this._localBindings.has(wf.BLOCK.name)&&t.pipelineLayout.layouts[0].bindBuffer(wf.BLOCK.binding,this._localBindings.get(wf.BLOCK.name).buffer),t}},{key:"onSetLocalBindings",value:function(e){this._localBindings.has(Cf.BLOCK.name)||this._localBindings.set(Cf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:Cf.BLOCK});var t=!1,i=e.passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}if(a.bindings.find(function(e){return e.name===wf.BLOCK.name})){t=!0;break}}t&&"ForwardPipeline"===cc.director.root.pipeline.name&&(this._localBindings.has(wf.BLOCK.name)||this._localBindings.set(wf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:wf.BLOCK}))}},{key:"initLocalBindings",value:function(e){if(e){this.onSetLocalBindings(e);for(var t=this._localBindings.values(),i=t.next();!i.done;){var n=i.value;n.buffer||(n.buffer=this._device.createBuffer({usage:Jr.UNIFORM|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:Av(n.blockInfo)})),i=t.next()}}}},{key:"allocatePSO",value:function(e){null==this._matRefCount.get(e)?(this._matRefCount.set(e,1),this._matPSORecord.set(e,this.createPipelineState(e))):this._matRefCount.set(e,this._matRefCount.get(e)+1)}},{key:"releasePSO",value:function(e){this._matRefCount.set(e,this._matRefCount.get(e)-1),0===this._matRefCount.get(e)&&(this.destroyPipelineState(e,this._matPSORecord.get(e)),this._matPSORecord.delete(e),this._matRefCount.delete(e))}}]),i}();(Lv=Fv||(Fv={}))[Lv.right=0]="right",Lv[Lv.left=1]="left",Lv[Lv.top=2]="top",Lv[Lv.bottom=3]="bottom",Lv[Lv.front=4]="front",Lv[Lv.back=5]="back";var Mv=un("cc.TextureCube")((Ov=kv=function(e){function s(){var e;return y(this,s),v(e=T(this,S(s).call(this)),"_mipmaps",Rv,d(d(e))),e}return p(s,Kc),l(s,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var n=this;if(this._mipmaps=e,0<this._mipmaps.length){var t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(function(e,i){Iv(e,function(e,t){n._assignImage(e,i,t)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,t){for(var i=[],n=e.length/6,r=0;r<n;r++){var a=6*r;i.push({front:e[a+Fv.front].image,back:e[a+Fv.back].image,left:e[a+Fv.left].image,right:e[a+Fv.right].image,top:e[a+Fv.top].image,bottom:e[a+Fv.bottom].image})}return(t=t||new s).mipmaps=i,t}}]),l(s,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"updateMipmaps",value:function(){var n=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;Iv(n._mipmaps[i],function(e,t){n._assignImage(e,i,t)})},a=0;a<i;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],_(S(s.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(t){return{base:_(S(s.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map(function(e){return t?{front:Editor.Utils.UuidUtils.compressUuid(e.front._uuid,!0),back:Editor.Utils.UuidUtils.compressUuid(e.back._uuid,!0),left:Editor.Utils.UuidUtils.compressUuid(e.left._uuid,!0),right:Editor.Utils.UuidUtils.compressUuid(e.right._uuid,!0),top:Editor.Utils.UuidUtils.compressUuid(e.top._uuid,!0),bottom:Editor.Utils.UuidUtils.compressUuid(e.bottom._uuid,!0)}:{front:e.front._uuid,back:e.back._uuid,left:e.left._uuid,right:e.right._uuid,top:e.top._uuid,bottom:e.bottom._uuid}})}}},{key:"_deserialize",value:function(e,t){var i=e;_(S(s.prototype),"_deserialize",this).call(this,i.base,t),this._mipmaps=new Array(i.mipmaps.length);for(var n=0;n<i.mipmaps.length;++n){this._mipmaps[n]={front:new Ls,back:new Ls,left:new Ls,right:new Ls,top:new Ls,bottom:new Ls};var r=i.mipmaps[n];t.result.push(this._mipmaps[n],"front",r.front),t.result.push(this._mipmaps[n],"back",r.back),t.result.push(this._mipmaps[n],"left",r.left),t.result.push(this._mipmaps[n],"right",r.right),t.result.push(this._mipmaps[n],"top",r.top),t.result.push(this._mipmaps[n],"bottom",r.bottom)}}},{key:"_getTextureCreateInfo",value:function(){var e=_(S(s.prototype),"_getTextureCreateInfo",this).call(this);return e.arrayLayer=6,e.flags=(e.flags||0)|Fa.CUBEMAP,e}},{key:"_getTextureViewCreateInfo",value:function(){var e=_(S(s.prototype),"_getTextureViewCreateInfo",this).call(this);return e.type=Ba.CUBE,e.layerCount=6,e}}]),s}(),kv.FaceIndex=Fv,Rv=c((wv=Ov).prototype,"_mipmaps",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cv=wv))||Cv;function Iv(e,t){t(e.front,Fv.front),t(e.back,Fv.back),t(e.left,Fv.left),t(e.right,Fv.right),t(e.top,Fv.top),t(e.bottom,Fv.bottom)}cc.TextureCube=Mv;var Pv,Dv,Nv,zv,Uv=[{name:"builtin-billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:354037504,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if 1\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nuniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = (a_texCoord.xy - 0.5) * cc_size_rotation.xy;\n  rotateCorner(vertOffset, cc_size_rotation.z);\n  computeVertPos(pos, vertOffset, cc_matView);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if 1 || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if 1\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = (a_texCoord.xy - 0.5) * cc_size_rotation.xy;\n  rotateCorner(vertOffset, cc_size_rotation.z);\n  computeVertPos(pos, vertOffset, cc_matView);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:["CCLocal"],samplers:[]}},defines:[{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",size:48,defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1,size:16},{name:"frameTile_velLenScale",type:16,count:1,size:16},{name:"scale",type:16,count:1,size:16}]},{name:"builtin",size:16,defines:[],binding:1,members:[{name:"cc_size_rotation",type:16,count:1,size:16}]},{name:"FragConstants",size:16,defines:[],binding:2,members:[{name:"tintColor",type:16,count:1,size:16}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:159087728,glsl3:{vert:"\nprecision mediump float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec4 a_color;\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform vec4 scale;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec4 a_color;\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:["CCLocal"],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",size:48,defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1,size:16},{name:"frameTile_velLenScale",type:16,count:1,size:16},{name:"scale",type:16,count:1,size:16}]},{name:"FragConstants",size:16,defines:[],binding:1,members:[{name:"tintColor",type:16,count:1,size:16}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],inspector:{type:"color"},type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2610855179,glsl3:{vert:"\nprecision highp float;\nuniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nout vec2 uv;\nout vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n  angle /= 2.;\n  float s = sin(angle);\n  vec4 res;\n  res.xyz = s * axis;\n  res.w = cos(angle);\n  return res;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nvoid scaleMatrix(inout mat4 m, float s){\n  m[0].xyz *= s;\n  m[1].xyz *= s;\n  m[2].xyz *= s;\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec2 a_texCoord1;\nin vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n  in vec3 a_color1;\n#endif\n#if CC_USE_MESH\n  in vec3 a_texCoord2;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n  #if CC_USE_MESH\n    vec4 pos = vec4(a_texCoord2, 1);\n    mat4 xformNoScale = matrixFromRT(quaternionFromAxisAngle(a_texCoord1.y, vec3(0, 0, -1)), a_position);\n    mat4 xform = mat4(xformNoScale);\n    scaleMatrix(xform, a_texCoord1.x);\n    pos = xform * pos;\n    vec4 normal = xformNoScale * vec4(a_normal,0);\n  #else\n    vec4 pos = vec4(a_position, 1);\n    #if CC_USE_STRETCHED_BILLBOARD\n      vec4 velocity = vec4(a_color1.xyz, 0);\n    #endif\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n    velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5) * a_texCoord1.x);\n    #if !CC_USE_STRETCHED_BILLBOARD\n      rotateCorner(cornerOffset, a_texCoord1.y);\n    #endif\n    computeVertPos(pos, cornerOffset, vec3(scale)\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n      , cc_matView\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord1.x\n      , a_texCoord.x\n    #endif\n    );\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    color = a_color;\n  #else\n    uv = a_texCoord.xy;\n    color = a_color * a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nuniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform mat4 cc_matView;\nuniform mat4 cc_matViewProj;\nuniform vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying vec2 uv;\nvarying vec4 color;\nvoid computeVertPos(inout vec4 pos, vec2 vertOffset, vec3 scale\n#if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n  , mat4 view\n#endif\n#if CC_USE_STRETCHED_BILLBOARD\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float size\n  , float xIndex\n#endif\n) {\n#if CC_USE_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = normalize(vec3(view[0][1], view[1][1], view[2][1]));\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_STRETCHED_BILLBOARD\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz));\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * size;\n  pos.xyz += ((camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex) * scale;\n#elif CC_USE_HORIZONTAL_BILLBOARD\n  vec3 camRight = vec3(1, 0, 0);\n  vec3 camUp = vec3(0, 0, -1);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#elif CC_USE_VERTICAL_BILLBOARD\n  vec3 camRight = normalize(vec3(view[0][0], view[1][0], view[2][0]));\n  vec3 camUp = vec3(0, 1, 0);\n  pos.xyz += ((camRight * vertOffset.x) + (camUp * vertOffset.y)) * scale;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV(float frameIndex, vec2 vertIndex, vec2 frameTile) {\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n  vertIndex.x = 1. - vertIndex.x;\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nvoid rotateCorner(inout vec2 corner, float angle) {\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvec4 quaternionFromAxisAngle(float angle, vec3 axis){\n  angle /= 2.;\n  float s = sin(angle);\n  vec4 res;\n  res.xyz = s * axis;\n  res.w = cos(angle);\n  return res;\n}\nmat4 matrixFromRT(vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nvoid scaleMatrix(inout mat4 m, float s){\n  m[0].xyz *= s;\n  m[1].xyz *= s;\n  m[2].xyz *= s;\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec2 a_texCoord1;\nattribute vec4 a_color;\n#if CC_USE_STRETCHED_BILLBOARD\n  attribute vec3 a_color1;\n#endif\n#if CC_USE_MESH\n  attribute vec3 a_texCoord2;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main() {\n  #if CC_USE_MESH\n    vec4 pos = vec4(a_texCoord2, 1);\n    mat4 xformNoScale = matrixFromRT(quaternionFromAxisAngle(a_texCoord1.y, vec3(0, 0, -1)), a_position);\n    mat4 xform = mat4(xformNoScale);\n    scaleMatrix(xform, a_texCoord1.x);\n    pos = xform * pos;\n    vec4 normal = xformNoScale * vec4(a_normal,0);\n  #else\n    vec4 pos = vec4(a_position, 1);\n    #if CC_USE_STRETCHED_BILLBOARD\n      vec4 velocity = vec4(a_color1.xyz, 0);\n    #endif\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_USE_STRETCHED_BILLBOARD\n    velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if !CC_USE_MESH\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5) * a_texCoord1.x);\n    #if !CC_USE_STRETCHED_BILLBOARD\n      rotateCorner(cornerOffset, a_texCoord1.y);\n    #endif\n    computeVertPos(pos, cornerOffset, vec3(scale)\n    #if CC_USE_BILLBOARD || CC_USE_VERTICAL_BILLBOARD\n      , cc_matView\n    #endif\n    #if CC_USE_STRETCHED_BILLBOARD\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord1.x\n      , a_texCoord.x\n    #endif\n    );\n    uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n    color = a_color;\n  #else\n    uv = a_texCoord.xy;\n    color = a_color * a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvec4 multiply () {\n  vec4 col;\n  vec4 texColor = texture2D(mainTexture, uv);\n  col.rgb = tintColor.rgb * texColor.rgb * color.rgb * vec3(2.0);\n  col.a = (1.0 - texColor.a) * (tintColor.a * color.a * 2.0);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:["CCLocal"],samplers:[]}},defines:[{name:"CC_USE_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_STRETCHED_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_HORIZONTAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_VERTICAL_BILLBOARD",type:"boolean",defines:[]},{name:"CC_USE_MESH",type:"boolean",defines:[]},{name:"CC_USE_WORLD_SPACE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[{name:"Constants",size:48,defines:[],binding:0,members:[{name:"mainTiling_Offset",type:16,count:1,size:16},{name:"frameTile_velLenScale",type:16,count:1,size:16},{name:"scale",type:16,count:1,size:16}]},{name:"FragConstants",size:16,defines:[],binding:1,members:[{name:"tintColor",type:16,count:1,size:16}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],binding:30}],dependencies:{}}]},{name:"builtin-skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"builtin-skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"builtin-skybox|sky-vs:vert|sky-fs:frag",hash:1349172928,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform CCSkinning {\n    vec4 cc_jointsData[30 * 3];\n  };\n#else\n  uniform CCSkinningTexture {\n    vec4 cc_jointsTextureSizeInv;\n  };\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nout vec3 viewDir;\nvec4 vert () {\n  CCVertInput(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = cc_matProj * matViewRotOnly * vec4(viewDir, 1.0);\n  pos.z = pos.w * 0.99999;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nin vec3 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = texture(cc_environment, viewDir);\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matView;\nuniform mat4 cc_matProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform vec4 cc_jointsData[90];\n#else\n  uniform vec4 cc_jointsTextureSizeInv;\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture2D(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture2D(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture2D(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nvarying vec3 viewDir;\nvec4 vert () {\n  CCVertInput(viewDir);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  highp vec4 pos = cc_matProj * matViewRotOnly * vec4(viewDir, 1.0);\n  pos.z = pos.w * 0.99999;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform samplerCube cc_environment;\nvec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}\nvec3 unpackRGBE(vec4 rgbe) {\n    return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nuniform vec4 cc_exposure;\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvarying vec3 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir));\n    c = LinearToSRGB(c / (1.0 + c));\n    vec4 o = vec4(c, 1.0);\n  #else\n    vec4 o = textureCube(cc_environment, viewDir);\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:["cc_environment"]},locals:{blocks:["CCSkinning","CCSkinningTexture"],samplers:["cc_jointsTexture"]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,3]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_RGBE_CUBEMAP",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"builtin-sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",priority:244,depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"white",type:28}}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:1287302882,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#if USE_LOCAL\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\n#endif\nin vec3 a_position;\nin vec4 a_color;\nout vec4 color;\nin vec2 a_texCoord;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 color;\nattribute vec2 a_texCoord;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matViewProj * cc_matWorld * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:["CCLocal"],samplers:[]}},defines:[{name:"USE_LOCAL",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"builtin-standard",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},albedo:{value:[1,1,1,1],inspector:{type:"color"},type:16},albedoScale:{value:[1,1,1,0],type:16},pbrParams:{value:[.8,.6,1,1],type:16},pbrScale:{value:[1,1,1,1],type:16},emissive:{value:[0,0,0,1],inspector:{type:"color"},type:16},emissiveScale:{value:[1,1,1,1],type:16},albedoMap:{value:"grey",type:28},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:2722729507,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec3 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = a_position;\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nin vec4 a_weights;\nin vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform CCSkinning {\n    vec4 cc_jointsData[30 * 3];\n  };\n#else\n  uniform CCSkinningTexture {\n    vec4 cc_jointsTextureSizeInv;\n  };\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nout vec3 v_position;\nout vec3 v_normal;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 a_texCoord;\n  out vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * vec4(In.position, 1.0);\n  v_position = pos.xyz;\n  v_normal = (cc_matWorldIT * vec4(In.normal, 0.0)).xyz;\n  #if USE_NORMAL_MAP\n    v_tangent = (cc_matWorldIT * vec4(In.tangent, 0.0)).xyz;\n    v_bitangent = cross(v_tangent, v_normal);\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCForwardLight {\n  highp vec4 cc_sphereLitPos[2];\n  vec4 cc_sphereLitSizeRange[2];\n  vec4 cc_sphereLitColor[2];\n  highp vec4 cc_spotLitPos[2];\n  vec4 cc_spotLitSizeRangeAngle[2];\n  vec4 cc_spotLitDir[2];\n  vec4 cc_spotLitColor[2];\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL+V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL+V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec3 albedo;\n  float alpha;\n  vec3 position;\n  vec3 normal;\n  float roughness;\n  float metallic;\n  float occlusion;\n  vec3 emissive;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo, s.metallic);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(s.normal, V)), 0.001);\n  float NL = max(dot(s.normal, L), 0.001);\n  float NH = max(dot(s.normal, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, s.normal);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, s.normal, V, diffuse, specular, s.roughness);\n  float fAmb = dot(s.normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, s.normal));\n    vec3 env = SRGBToLinear(texture(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.alpha);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScale;\n  vec4 pbrParams;\n  vec4 pbrScale;\n  vec4 emissive;\n  vec4 emissiveScale;\n};\nin vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  in vec2 v_uv;\n#endif\nin vec3 v_normal;\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor.rgb * albedoScale.xyz;\n  s.alpha = baseColor.a;\n  #if USE_ALPHA_TEST\n    if(s.alpha < albedoScale.w)\n      discard;\n  #endif\n  s.normal = normalize(v_normal);\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal = normalize(\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform mat4 cc_matWorldIT;\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec3 a_tangent;\nvoid CCDecode (out StandardAttributes attr) {\n  attr.position = a_position;\n  attr.normal = a_normal;\n  attr.tangent = a_tangent;\n}\n#if CC_USE_SKINNING\nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform vec4 cc_jointsData[90];\n#else\n  uniform vec4 cc_jointsTextureSizeInv;\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture2D(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture2D(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture2D(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nstruct StandardVertInput {\n  highp vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nvoid CCAttrToInput (in StandardAttributes attr, out StandardVertInput In) {\n  In.position = attr.position;\n  In.normal = attr.normal;\n  In.tangent = attr.tangent;\n}\nvoid CCVertInput (out StandardVertInput In) {\n  StandardAttributes attr;\n  CCDecode(attr);\n  #if CC_USE_SKINNING\n    CCSkin(attr);\n  #endif\n  CCAttrToInput(attr, In);\n}\nuniform vec4 tilingOffset;\nvarying vec3 v_position;\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  attribute vec2 a_texCoord;\n  varying vec2 v_uv;\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  CCVertInput(In);\n  vec4 pos = cc_matWorld * vec4(In.position, 1.0);\n  v_position = pos.xyz;\n  v_normal = (cc_matWorldIT * vec4(In.normal, 0.0)).xyz;\n  #if USE_NORMAL_MAP\n    v_tangent = (cc_matWorldIT * vec4(In.tangent, 0.0)).xyz;\n    v_bitangent = cross(v_tangent, v_normal);\n  #endif\n  #if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  return cc_matViewProj * pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_cameraPos;\nuniform vec4 cc_exposure;\nuniform vec4 cc_mainLitDir;\nuniform vec4 cc_mainLitColor;\nuniform vec4 cc_ambientSky;\nuniform vec4 cc_ambientGround;\nuniform highp vec4 cc_sphereLitPos[2];\nuniform vec4 cc_sphereLitSizeRange[2];\nuniform vec4 cc_sphereLitColor[2];\nuniform highp vec4 cc_spotLitPos[2];\nuniform vec4 cc_spotLitSizeRangeAngle[2];\nuniform vec4 cc_spotLitDir[2];\nuniform vec4 cc_spotLitColor[2];\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\n#endif\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nfloat SmoothDistAtt2(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float factor2 = factor * factor;\n  float factor3 = factor2 * factor2;\n  float smoothFactor = clamp(1.0 - factor3 * factor3, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat SmoothDistAtt(float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt(float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt(vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\nfloat GGXMobile(float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular(float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox(vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nvec3 CalcDynamicLighting(vec3 worldPos, vec3 N, vec3 V, vec3 diffuse, vec3 specular, float roughness) {\n  vec3 lighting = vec3(0.0);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  for (int i = 0; i < 2; i++) {\n    vec3 PLU = cc_sphereLitPos[i].xyz - worldPos;\n    vec3 PL = normalize(PLU);\n    vec3 PH = normalize(PL+V);\n    float PNL = max(dot(N, PL), 0.001);\n    float PNH = max(dot(N, PH), 0.0);\n    float distSqr = dot(PLU, PLU);\n    float litRadius = cc_sphereLitSizeRange[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_sphereLitSizeRange[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    vec3 lspec = specular * CalcSpecular(roughness, PNH, PH, N);\n    lighting += PNL * cc_sphereLitColor[i].rgb * cc_sphereLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  for (int i = 0; i < 2; i++) {\n    vec3 SLU = cc_spotLitPos[i].xyz - worldPos;\n    vec3 SL = normalize(SLU);\n    vec3 SH = normalize(SL+V);\n    float SNL = max(dot(N, SL), 0.001);\n    float SNH = max(dot(N, SH), 0.0);\n    float distSqr = dot(SLU, SLU);\n    float litRadius = cc_spotLitSizeRangeAngle[i].x;\n    float litRadiusSqr = litRadius * litRadius;\n    float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n    float attRadiusSqrInv = 1.0 / max(cc_spotLitSizeRangeAngle[i].y, 0.01);\n    attRadiusSqrInv *= attRadiusSqrInv;\n    float cosInner = max(dot(-cc_spotLitDir[i].xyz, SL), 0.01);\n    float cosOuter = cc_spotLitSizeRangeAngle[i].z;\n    float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n    float litAngleOffset = -cosOuter * litAngleScale;\n    float att = GetDistAtt(distSqr, attRadiusSqrInv);\n    att *= GetAngleAtt(SL, -cc_spotLitDir[i].xyz, litAngleScale, litAngleOffset);\n    vec3 lspec = specular * CalcSpecular(roughness, SNH, SH, N);\n    lighting += SNL * cc_spotLitColor[i].rgb * cc_spotLitColor[i].w * illum * att * (diffuseContrib + lspec);\n  }\n  return lighting;\n}\nstruct StandardSurface {\n  vec3 albedo;\n  float alpha;\n  vec3 position;\n  vec3 normal;\n  float roughness;\n  float metallic;\n  float occlusion;\n  vec3 emissive;\n};\nvec4 CCStandardShading (StandardSurface s) {\n  vec3 diffuse = s.albedo * (1.0 - s.metallic);\n  vec3 specular = mix(vec3(0.04), s.albedo, s.metallic);\n  vec3 V = normalize(cc_cameraPos.xyz - s.position);\n  vec3 L = normalize(-cc_mainLitDir.xyz);\n  vec3 H = normalize(L+V);\n  float NV = max(abs(dot(s.normal, V)), 0.001);\n  float NL = max(dot(s.normal, L), 0.001);\n  float NH = max(dot(s.normal, H), 0.0);\n  specular = BRDFApprox(specular, s.roughness, NV);\n  vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, s.normal);\n  vec3 diffuseContrib = diffuse / 3.14159265359;\n  vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w * (diffuseContrib + specularContrib);\n  finalColor += CalcDynamicLighting(s.position, s.normal, V, diffuse, specular, s.roughness);\n  float fAmb = dot(s.normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n  vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n  finalColor += (ambDiff.rgb * diffuse);\n  #if CC_USE_IBL\n    vec3 R = normalize(reflect(-V, s.normal));\n    vec3 env = SRGBToLinear(textureCube(cc_environment, R).rgb) * cc_ambientSky.w;\n    finalColor += env * specular;\n  #endif\n  finalColor = finalColor * s.occlusion;\n  #if CC_USE_HDR\n    s.emissive *= cc_exposure.w;\n  #endif\n  finalColor += s.emissive;\n  return vec4(finalColor, s.alpha);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = LinearToSRGB(color.rgb);\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScale;\nuniform vec4 pbrParams;\nuniform vec4 pbrScale;\nuniform vec4 emissive;\nuniform vec4 emissiveScale;\nvarying vec3 v_position;\n#if USE_ALBEDO_MAP || USE_NORMAL_MAP || USE_PBR_MAP || USE_EMISSIVE_MAP || USE_METALLIC_ROUGHNESS_MAP || USE_OCCLUSION_MAP\n  varying vec2 v_uv;\n#endif\nvarying vec3 v_normal;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, v_uv);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor.rgb * albedoScale.xyz;\n  s.alpha = baseColor.a;\n  #if USE_ALPHA_TEST\n    if(s.alpha < albedoScale.w)\n      discard;\n  #endif\n  s.normal = normalize(v_normal);\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, v_uv).xyz - vec3(0.5);\n    s.normal = normalize(\n      (nmmp.x * pbrScale.w) * normalize(v_tangent) +\n      (nmmp.y * pbrScale.w) * normalize(v_bitangent) +\n      nmmp.z * s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    pbr = texture2D(pbrMap, v_uv);\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, v_uv);\n    pbr.METALLIC_CHANNEL = metallicRoughness.METALLIC_CHANNEL;\n    pbr.ROUGHNESS_CHANNEL = metallicRoughness.ROUGHNESS_CHANNEL;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.OCCLUSION_CHANNEL = texture2D(occlusionMap, v_uv).OCCLUSION_CHANNEL;\n  #endif\n  pbr *= pbrScale;\n  s.roughness = clamp(pbr.ROUGHNESS_CHANNEL, 0.04, 1.0);\n  s.metallic = clamp(pbr.METALLIC_CHANNEL, 0.0, 0.96);\n  s.occlusion = pbr.OCCLUSION_CHANNEL;\n  s.emissive = emissive.rgb * emissiveScale.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, v_uv).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:["cc_environment"]},locals:{blocks:["CCLocal","CCSkinning","CCSkinningTexture","CCForwardLight"],samplers:["cc_jointsTexture"]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,3]},{name:"USE_NORMAL_MAP",type:"boolean",defines:[]},{name:"USE_ALBEDO_MAP",type:"boolean",defines:[]},{name:"CC_USE_IBL",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_PBR_MAP",type:"boolean",defines:[]},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean",defines:[]},{name:"USE_OCCLUSION_MAP",type:"boolean",defines:[]},{name:"USE_EMISSIVE_MAP",type:"boolean",defines:[]},{name:"ROUGHNESS_CHANNEL",type:"string",defines:[],options:["r","g","b","a"]},{name:"METALLIC_CHANNEL",type:"string",defines:[],options:["g","r","b","a"]},{name:"OCCLUSION_CHANNEL",type:"string",defines:[],options:["b","r","g","a"]},{name:"USE_ALPHA_TEST",type:"boolean",defines:[]}],blocks:[{name:"Constants",size:112,defines:[],binding:0,members:[{name:"tilingOffset",type:16,count:1,size:16},{name:"albedo",type:16,count:1,size:16},{name:"albedoScale",type:16,count:1,size:16},{name:"pbrParams",type:16,count:1,size:16},{name:"pbrScale",type:16,count:1,size:16},{name:"emissive",type:16,count:1,size:16},{name:"emissiveScale",type:16,count:1,size:16}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],binding:30},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],binding:31},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],binding:32},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],binding:33},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],binding:34},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],binding:35}],dependencies:{}}]},{name:"builtin-unlit",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{color:{value:[1,1,1,1],inspector:{type:"color"},type:16},tilingOffset:{value:[1,1,0,0],type:16},mainTexture:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:3003933283,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nin vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform CCSkinning {\n    vec4 cc_jointsData[30 * 3];\n  };\n#else\n  uniform CCSkinningTexture {\n    vec4 cc_jointsTextureSizeInv;\n  };\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\n#if USE_TEXTURE\n  in vec2 a_texCoord;\n  out vec2 uv0;\n  uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nvec4 vert () {\n  vec3 position;\n  CCVertInput(position);\n  vec4 pos = cc_matViewProj * cc_matWorld * vec4(position, 1.0);\n  #if USE_TEXTURE\n    uv0 = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform Constant {\n    vec4 color;\n  };\n#endif\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture(mainTexture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform vec4 cc_jointsData[90];\n#else\n  uniform vec4 cc_jointsTextureSizeInv;\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture2D(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture2D(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture2D(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\n#if USE_TEXTURE\n  attribute vec2 a_texCoord;\n  varying vec2 uv0;\n  uniform vec4 tilingOffset;\n#endif\nvec4 vert () {\n  vec3 position;\n  CCVertInput(position);\n  vec4 pos = cc_matViewProj * cc_matWorld * vec4(position, 1.0);\n  #if USE_TEXTURE\n    uv0 = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D mainTexture;\n#endif\n#if USE_COLOR\n  uniform vec4 color;\n#endif\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, uv0);\n  #endif\n  #if USE_COLOR\n    o *= color;\n  #endif\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:["CCLocal","CCSkinning","CCSkinningTexture"],samplers:["cc_jointsTexture"]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,3]},{name:"USE_VERTEX_COLOR",type:"boolean",defines:[]},{name:"USE_TEXTURE",type:"boolean",defines:[]},{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"USE_COLOR",type:"boolean",defines:[]}],blocks:[{name:"TexCoords",size:16,defines:["USE_TEXTURE"],binding:0,members:[{name:"tilingOffset",type:16,count:1,size:16}]},{name:"Constant",size:16,defines:["USE_COLOR"],binding:1,members:[{name:"color",type:16,count:1,size:16}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],binding:30}],dependencies:{}}]},{name:"pipeline/planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilWriteMaskBack:128,stencilWriteMaskFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilRefBack:128,stencilRefFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:1119648208,glsl3:{vert:"\nprecision mediump float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nuniform CCLocal {\n  highp mat4 cc_matWorld;\n  mat4 cc_matWorldIT;\n};\nuniform CCShadow {\n  mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nin vec4 a_weights;\nin vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform CCSkinning {\n    vec4 cc_jointsData[30 * 3];\n  };\n#else\n  uniform CCSkinningTexture {\n    vec4 cc_jointsTextureSizeInv;\n  };\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nvec4 vert () {\n  vec3 position;\n  CCVertInput(position);\n  vec4 pos = cc_matWorld * vec4(position, 1.0);\n  pos = cc_matViewProj * cc_matLightPlaneProj * pos;\n  pos.z -= 0.0001;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform CCShadow {\n  mat4 cc_matLightPlaneProj;\n  vec4 cc_shadowColor;\n};\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision mediump float;\nuniform mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nuniform mat4 cc_matLightPlaneProj;\nattribute vec3 a_position;\nvoid CCDecode (out vec3 position) {\n  position = a_position;\n}\n#if CC_USE_SKINNING\nstruct StandardAttributes {\n  vec3 position;\n  vec3 normal;\n  vec3 tangent;\n};\nattribute vec4 a_weights;\nattribute vec4 a_joints;\n#if CC_USE_SKINNING == 1\n  uniform vec4 cc_jointsData[90];\n#else\n  uniform vec4 cc_jointsTextureSizeInv;\n  uniform sampler2D cc_jointsTexture;\n#endif\n#if CC_USE_SKINNING == 2\n  float decode32(highp vec4 rgba) {\n    rgba = rgba * 255.0;\n    float Sign = 1.0 - step(128.0, rgba[3]) * 2.0;\n    float Exponent = 2.0 * mod(rgba[3], 128.0) + step(128.0, rgba[2]) - 127.0;\n    float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n    return Sign * exp2(Exponent - 23.0) * Mantissa;\n  }\n#endif\n#if CC_USE_SKINNING == 1\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    int idx = 3 * int(i);\n    Qr = cc_jointsData[idx];\n    Qt = cc_jointsData[idx + 1];\n    return cc_jointsData[idx + 2].xyz;\n  }\n#elif CC_USE_SKINNING == 2\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((0.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((1.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((2.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((3.5 / 12.0), y)))\n    );\n    Qt = vec4(\n      decode32(texture2D(cc_jointsTexture, vec2((4.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((5.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((6.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((7.5 / 12.0), y)))\n    );\n    return vec3(\n      decode32(texture2D(cc_jointsTexture, vec2((8.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((9.5 / 12.0), y))),\n      decode32(texture2D(cc_jointsTexture, vec2((10.5 / 12.0), y)))\n    );\n  }\n#elif CC_USE_SKINNING == 3\n  vec3 getJointDQ(float i, out vec4 Qr, out vec4 Qt) {\n    float y = (i + 0.5) * cc_jointsTextureSizeInv.y;\n    Qr = texture2D(cc_jointsTexture, vec2((0.5 / 3.0), y));\n    Qt = texture2D(cc_jointsTexture, vec2((1.5 / 3.0), y));\n    return texture2D(cc_jointsTexture, vec2((2.5 / 3.0), y)).xyz;\n  }\n#endif\nvoid skinRTS(out vec4 R, out vec3 T, out vec3 S) {\n  vec4 r, t, Qt = vec4(0.0);\n  R = vec4(0.0); S = vec3(0.0);\n  for (int i = 0; i < 4; i++) {\n    float w = a_weights[i];\n    S += getJointDQ(a_joints[i], r, t) * w;\n    R += r * w; Qt += t * w;\n  }\n  float invNorm = 1.0 / length(R); R *= invNorm; Qt *= invNorm;\n  T = 2.0 * (R.w * Qt.xyz - Qt.w * R.xyz + cross(R.xyz, Qt.xyz));\n}\nvec3 VectorTransformQuat(vec3 v, vec4 Q) {\n\treturn v + 2.0 * cross(Q.xyz, cross(Q.xyz, v) + Q.w * v);\n}\nvoid CCSkin(inout vec3 position) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  position = VectorTransformQuat(position * S, R) + T;\n}\nvoid CCSkin(inout StandardAttributes attr) {\n  vec4 R; vec3 T, S;\n  skinRTS(R, T, S);\n  attr.position = VectorTransformQuat(attr.position * S, R) + T;\n  attr.normal = VectorTransformQuat(attr.normal, R);\n  attr.tangent = VectorTransformQuat(attr.tangent, R);\n}\n#endif\nvoid CCVertInput (out highp vec3 position) {\n  CCDecode(position);\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n}\nvec4 vert () {\n  vec3 position;\n  CCVertInput(position);\n  vec4 pos = cc_matWorld * vec4(position, 1.0);\n  pos = cc_matViewProj * cc_matLightPlaneProj * pos;\n  pos.z -= 0.0001;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision mediump float;\nuniform vec4 cc_shadowColor;\nuniform vec4 cc_exposure;\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec4 CCFragOutput(vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n\t#endif\n\treturn color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal","CCShadow"],samplers:[]},locals:{blocks:["CCLocal","CCSkinning","CCSkinningTexture"],samplers:["cc_jointsTexture"]}},defines:[{name:"CC_USE_SKINNING",type:"number",defines:[],range:[0,3]},{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[],dependencies:{}}]},{name:"pipeline/smaa",techniques:[{name:"smaa",passes:[{program:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{sampler:[2,2,null,2,2],type:28}}},{program:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_edgeTexSampler:{sampler:[2,2,null,2,2],type:28},u_areaTexSampler:{sampler:[2,2,null,2,2],type:28},u_searchTexSampler:{sampler:[1,1,null,2,2],type:28}}}]}],shaders:[{name:"pipeline/smaa|smaa-edge-vs:vert|smaa-edge-fs:frag",hash:467513197,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-1.0, 0.0, 0.0, 1.0);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4( 1.0, 0.0, 0.0, -1.0);\n  v_offsets[2] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-2.0, 0.0, 0.0, 2.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nuniform sampler2D u_texSampler;\nvec3 ToLDR(vec3 color) {\n#if CC_USE_HDR\n  color *= cc_exposure.x * 1024.0;\n  color = ACESToneMap(color);\n  color = LinearToSRGB(color);\n#endif\n  return color;\n}\nvec4 frag () {\n  vec2 threshold = vec2(0.1, 0.1);\n  vec4 delta;\n  vec3 C = ToLDR(texture2D(u_texSampler, v_uv).rgb);\n  vec3 Cleft = ToLDR(texture2D(u_texSampler, v_offsets[0].xy).rgb);\n  vec3 t = abs(C - Cleft);\n  delta.x = max(max(t.r, t.g), t.b);\n  vec3 Ctop = ToLDR(texture2D(u_texSampler, v_offsets[0].zw).rgb);\n  t = abs(C - Ctop);\n  delta.y = max(max(t.r, t.g), t.b);\n  vec2 edges = step(threshold, delta.xy);\n  if (dot(edges, vec2(1.0, 1.0)) == 0.0)\n    discard;\n  vec3 Cright = ToLDR(texture2D(u_texSampler, v_offsets[1].xy).rgb);\n  t = abs(C - Cright);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Cbottom = ToLDR(texture2D(u_texSampler, v_offsets[1].zw).rgb);\n  t = abs(C - Cbottom);\n  delta.w = max(max(t.r, t.g), t.b);\n  float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);\n  vec3 Cleftleft = ToLDR(texture2D(u_texSampler, v_offsets[2].xy).rgb);\n  t = abs(C - Cleftleft);\n  delta.z = max(max(t.r, t.g), t.b);\n  vec3 Ctoptop = ToLDR(texture2D(u_texSampler, v_offsets[2].zw).rgb);\n  t = abs(C - Ctoptop);\n  delta.w = max(max(t.r, t.g), t.b);\n  maxDelta = max(max(maxDelta, delta.z), delta.w);\n  edges.xy *= step(0.5 * maxDelta, delta.xy);\n  vec4 o = vec4(edges, 0.0, 0.0);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30}],dependencies:{}},{name:"pipeline/smaa|smaa-blend-vs:vert|smaa-blend-fs:frag",hash:2322562369,glsl3:{vert:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offsets[3];\nout vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 v_uv;\nin vec4 v_offsets[3];\nin vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0.0, 1.0);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_pixCoord = v_uv * cc_nativeSize.xy;\n  v_offsets[0] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.25, 0.125, 1.25, 0.125);\n  v_offsets[1] = v_uv.xyxy + cc_nativeSize.zwzw * vec4(-0.125, 0.25, -0.125, -1.25);\n  v_offsets[2] = vec4(v_offsets[0].xz, v_offsets[1].yw) + vec4(-2.0, 2.0, -2.0, 2.0) * cc_nativeSize.zzww * float(8);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nvarying vec2 v_uv;\nvarying vec4 v_offsets[3];\nvarying vec2 v_pixCoord;\nuniform sampler2D u_edgeTexSampler;\nuniform sampler2D u_areaTexSampler;\nuniform sampler2D u_searchTexSampler;\nfloat SMAASearchLength(vec2 e, float bias, float scale) {\n  e.r = bias + e.r * scale;\n  return 255.0 * texture2D(u_searchTexSampler, e).r;\n}\nfloat SMAASearchXLeft(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord -= vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x > end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x += 0.25 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z;\n  texcoord.x += 2.0 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z * SMAASearchLength(e, 0.0, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchXRight(vec2 texcoord, float end) {\n  vec2 e = vec2(0.0, 1.0);\n  for (int i = 0; i < 8; ++i) {\n      e = texture2D(u_edgeTexSampler, texcoord).rg;\n      texcoord += vec2( 2.0, 0.0 ) * cc_nativeSize.zw;\n      if (!(texcoord.x < end && e.g > 0.8281 && e.r == 0.0))\n        break;\n  }\n  texcoord.x -= 0.25 * cc_nativeSize.z;\n  texcoord.x -= cc_nativeSize.z;\n  texcoord.x -= 2.0 * cc_nativeSize.z;\n  texcoord.x += cc_nativeSize.z * SMAASearchLength(e, 0.5, 0.5);\n  return texcoord.x;\n}\nfloat SMAASearchYUp(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord += vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y > end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y -= 0.25 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w;\n    texcoord.y -= 2.0 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w * SMAASearchLength(e.gr, 0.0, 0.5);\n    return texcoord.y;\n}\nfloat SMAASearchYDown(vec2 texcoord, float end) {\n    vec2 e = vec2(1.0, 0.0);\n    for (int i = 0; i < 8; ++i) {\n        e = texture2D(u_edgeTexSampler, texcoord).rg;\n        texcoord -= vec2( 0.0, 2.0 ) * cc_nativeSize.zw;\n        if (!(texcoord.y < end && e.r > 0.8281 && e.g == 0.0))\n          break;\n    }\n    texcoord.y += 0.25 * cc_nativeSize.w;\n    texcoord.y += cc_nativeSize.w;\n    texcoord.y += 2.0 * cc_nativeSize.w;\n    texcoord.y -= cc_nativeSize.w * SMAASearchLength(e.gr, 0.5, 0.5);\n    return texcoord.y;\n}\nvec2 Round(vec2 x) {\n  return sign(x) * floor(abs(x) + 0.5);\n}\nvec2 SMAAArea(vec2 dist, float e1, float e2) {\n    vec2 texcoord = float(16) * Round(4.0 * vec2(e1, e2)) + dist;\n    texcoord = (1.0 / vec2(160.0, 560.0)) * texcoord + 0.5 * (1.0 / vec2(160.0, 560.0));\n    return texture2D(u_areaTexSampler, texcoord).rg;\n}\nvec4 frag () {\n  vec4 weights = vec4(0.0);\n  vec2 e = texture2D(u_edgeTexSampler, v_uv).rg;\n  vec2 d;\n  vec2 coords;\n  if ( e.g > 0.0 ) {\n      coords.x = SMAASearchXLeft(v_offsets[0].xy, v_offsets[2].x);\n      coords.y = v_offsets[1].y;\n      d.x = coords.x;\n      float e1 = texture2D(u_edgeTexSampler, coords).r;\n      coords.x = SMAASearchXRight(v_offsets[0].zw, v_offsets[2].y);\n      d.y = coords.x;\n      d = d / cc_nativeSize.z - v_pixCoord.x;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(cc_nativeSize.z, 0.0)).r;\n      weights.rg = SMAAArea(sqrt_d, e1, e2);\n  }\n  if ( e.r > 0.0 ) {\n      coords.y = SMAASearchYUp(v_offsets[1].xy, v_offsets[2].z);\n      coords.x = v_offsets[0].x;\n      d.x = coords.y;\n      float e1 = texture2D(u_edgeTexSampler, coords).g;\n      coords.y = SMAASearchYDown(v_offsets[1].zw, v_offsets[2].w);\n      d.y = coords.y;\n      d = d / cc_nativeSize.w - v_pixCoord.y;\n      vec2 sqrt_d = sqrt(abs(d));\n      coords.y -= 1.0 * cc_nativeSize.w;\n      float e2 = texture2D(u_edgeTexSampler, coords + vec2(0.0, cc_nativeSize.w)).g;\n      weights.ba = SMAAArea(sqrt_d, e1, e2);\n  }\n  return weights;\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[{name:"u_edgeTexSampler",type:28,count:1,defines:[],binding:30},{name:"u_areaTexSampler",type:28,count:1,defines:[],binding:31},{name:"u_searchTexSampler",type:28,count:1,defines:[],binding:32}],dependencies:{}}]},{name:"pipeline/tonemap",techniques:[{name:"tonemap",passes:[{program:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{u_texSampler:{sampler:[2,2,null,2,2],type:28},u_blendTexSampler:{sampler:[2,2,null,2,2],type:28}}}]}],shaders:[{name:"pipeline/tonemap|tonemap-vs:vert|tonemap-fs:frag",hash:3483372138,glsl3:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform CCGlobal {\n  vec4 cc_time;\n  vec4 cc_screenSize;\n  vec4 cc_screenScale;\n  vec4 cc_nativeSize;\n  mat4 cc_matView;\n  mat4 cc_matViewInv;\n  mat4 cc_matProj;\n  mat4 cc_matProjInv;\n  mat4 cc_matViewProj;\n  mat4 cc_matViewProjInv;\n  vec4 cc_cameraPos;\n  vec4 cc_exposure;\n  vec4 cc_mainLitDir;\n  vec4 cc_mainLitColor;\n  vec4 cc_ambientSky;\n  vec4 cc_ambientGround;\n};\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nin vec2 v_uv;\nin vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture(u_blendTexSampler, v_uv).rb;\n    a.g = texture(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }\n"},glsl1:{vert:"\nprecision highp float;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform vec4 cc_screenScale;\nuniform vec4 cc_nativeSize;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord * cc_screenScale.xy;\n  v_offset = v_uv.xyxy + cc_nativeSize.zwzw * vec4(1.0, 0.0, 0.0, -1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }\n",frag:"\nprecision highp float;\nuniform vec4 cc_nativeSize;\nuniform vec4 cc_exposure;\n#define saturate(a) clamp( a, 0.0, 1.0 )\nvec3 SRGBToLinear(vec3 gamma)\n{\n\treturn pow(gamma, vec3(2.2));\n}\nvec3 LinearToSRGB(vec3 linear)\n{\n\treturn pow(linear, vec3(0.454545));\n}\nvec3 ACESToneMap(vec3 color) {\n    const float A = 2.51;\n    const float B = 0.03;\n    const float C = 2.43;\n    const float D = 0.59;\n    const float E = 0.14;\n    return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvarying vec2 v_uv;\nvarying vec4 v_offset;\nuniform sampler2D u_texSampler;\nuniform sampler2D u_blendTexSampler;\nvec3 ToLDR(vec3 color) {\n  #if CC_USE_HDR\n    color *= cc_exposure.x * 1024.0;\n    color = ACESToneMap(color);\n    color = LinearToSRGB(color);\n  #endif\n  return color;\n}\nvec4 frag () {\n  #if CC_USE_SMAA\n    vec4 a;\n    a.rb = texture2D(u_blendTexSampler, v_uv).rb;\n    a.g = texture2D(u_blendTexSampler, v_offset.zw).g;\n    a.a = texture2D(u_blendTexSampler, v_offset.xy).a;\n    if (dot(a, vec4(1.0)) < 1e-5) {\n      vec4 o = texture2D(u_texSampler, v_uv);\n      o.rgb = ToLDR(o.rgb);\n      return o;\n    } else {\n      vec2 offset;\n      offset.x = a.a > a.b ? a.a : -a.b;\n      offset.y = a.g > a.r ? -a.g : a.r;\n      if (abs(offset.x) > abs(offset.y)) {\n        offset.y = 0.0;\n      } else {\n        offset.x = 0.0;\n      }\n      vec4 C = texture2D(u_texSampler, v_uv);\n      C.rgb = ToLDR(C.rgb);\n      vec2 uv = v_uv + sign(offset) * cc_nativeSize.zw;\n      vec4 Cop = texture2D(u_texSampler, uv);\n      Cop.rgb = ToLDR(Cop.rgb);\n      float s = abs(offset.x) > abs(offset.y) ? abs(offset.x) : abs(offset.y);\n      C.rgb = pow(C.rgb, vec3(2.2));\n      Cop.rgb = pow(Cop.rgb, vec3(2.2));\n      vec4 mixed = mix(C, Cop, s);\n      mixed.rgb = pow(mixed.rgb, vec3(1.0 / 2.2));\n      return mixed;\n    }\n  #else\n    vec4 o = texture2D(u_texSampler, v_uv);\n    o.rgb = ToLDR(o.rgb);\n    return o;\n  #endif\n}\nvoid main() { gl_FragColor = frag(); }\n"},builtins:{globals:{blocks:["CCGlobal"],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean",defines:[]},{name:"CC_USE_SMAA",type:"boolean",defines:[]}],blocks:[],samplers:[{name:"u_texSampler",type:28,count:1,defines:[],binding:30},{name:"u_blendTexSampler",type:28,count:1,defines:[],binding:31}],dependencies:{}}]}],Gv=function(){function e(){y(this,e),this._device=null,this._resources={}}return l(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new Ls(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var s=new Zc;s._uuid="black-texture",s.image=r,t[s._uuid]=s;var o=new Mv;o._uuid="black-cube-texture",o.setMipFilter(Mv.Filter.LINEAR),o.image={front:new Ls(i),back:new Ls(i),left:new Ls(i),right:new Ls(i),top:new Ls(i),bottom:new Ls(i)},o.onLoaded(),t[o._uuid]=o,n.fillStyle="#777",n.fillRect(0,0,a,a);var l=new Zc;l._uuid="grey-texture",l.image=r,l.onLoaded(),t[l._uuid]=l,n.fillStyle="#fff",n.fillRect(0,0,a,a);var c=new Zc;c._uuid="white-texture",c.image=r,c.onLoaded(),t[c._uuid]=c;var u=new Mv;u._uuid="white-cube-texture",u.setMipFilter(Mv.Filter.LINEAR),u.image={front:new Ls(i),back:new Ls(i),left:new Ls(i),right:new Ls(i),top:new Ls(i),bottom:new Ls(i)},u.onLoaded(),t[u._uuid]=u,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var h=new Zc;h._uuid="normal-texture",h.image=r,t[h._uuid]=h,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var d=new Zc;d._uuid="default-texture",d.image=r,d.onLoaded(),t[d._uuid]=d;var f=new Mv;f.setMipFilter(Mv.Filter.LINEAR),f._uuid="default-cube-texture",f.image={front:new Ls(i),back:new Ls(i),left:new Ls(i),right:new Ls(i),top:new Ls(i),bottom:new Ls(i)},f.onLoaded(),t[f._uuid]=f;var p=new iu;p._uuid="default-spriteframe",p.setOriginalSize(cc.size(r.width,r.height)),p.setRect(new Ur(0,0,r.width,r.height)),p.image=r,p.onLoaded(),t[p._uuid]=p,Uv.forEach(function(e){Object.assign(new cc.EffectAsset,e).onLoaded()});var _=new cc.Material;_._uuid="standard-material",_.initialize({effectName:"builtin-standard"}),_.onLoaded(),t[_._uuid]=_;var v=new cc.Material;v._uuid="missing-material",v.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),v.setProperty("color",cc.color("#ff00ff")),v.onLoaded(),t[v._uuid]=v;var m=new cc.Material;m._uuid="missing-skinning-material",m.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0,CC_USE_SKINNING:1}}),m.setProperty("color",cc.color("#ff00ff")),m.onLoaded(),t[m._uuid]=m;var y=new cc.Material;y._uuid="missing-effect-material",y.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),y.setProperty("color",cc.color("#ffff00")),y.onLoaded(),t[y._uuid]=y;var g=new cc.Material;g._uuid="ui-base-material",g.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),g.onLoaded(),t[g._uuid]=g;var b=new cc.Material;b._uuid="ui-sprite-material",b.initialize({defines:{USE_TEXTURE:!0},effectName:"builtin-sprite"}),b.onLoaded(),t[b._uuid]=b;var S=new cc.Material;S._uuid="default-particle-material",S.initialize({effectName:"builtin-particle"}),S.onLoaded(),t[S._uuid]=S;var T=new cc.Material;T._uuid="default-trail-material",T.initialize({effectName:"builtin-particle-trail"}),T.onLoaded(),t[T._uuid]=T;var E=new cc.Material;E._uuid="default-billboard-material",E.initialize({effectName:"builtin-billboard"}),E.onLoaded(),t[E._uuid]=E;var x=G_.create();jf.register("bounds-merge-shadow",{onAttach:function(t){var i=t.scene.mainLight,n=t.scene.planarShadows;t.updateTransform=function(){var e=t.worldBounds;(t.transform.hasChanged||i.node.hasChanged)&&(e?(t.modelBounds.transform(t.transform.worldMatrix,null,null,null,e),e.transform(n.matLight,null,null,null,x),G_.merge(e,e,x)):t.transform.updateWorldTransformFull())}},onDetach:function(e){e.updateTransform=Bv.prototype.updateTransform.bind(e)}})}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),Vv=cc.builtinResMgr=new Gv,Hv=function(){function e(){y(this,e),this.isDiscard=!1,this.polygonMode=aa.FILL,this.shadeModel=oa.GOURAND,this.cullMode=ca.BACK,this.isFrontFaceCCW=!0,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}return l(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}(),Wv=function(){function e(){y(this,e),this.depthTest=!0,this.depthWrite=!0,this.depthFunc=ha.LESS,this.stencilTestFront=!1,this.stencilFuncFront=ha.ALWAYS,this.stencilReadMaskFront=4294967295,this.stencilWriteMaskFront=4294967295,this.stencilFailOpFront=fa.KEEP,this.stencilZFailOpFront=fa.KEEP,this.stencilPassOpFront=fa.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=ha.ALWAYS,this.stencilReadMaskBack=4294967295,this.stencilWriteMaskBack=4294967295,this.stencilFailOpBack=fa.KEEP,this.stencilZFailOpBack=fa.KEEP,this.stencilPassOpBack=fa.KEEP,this.stencilRefBack=1}return l(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}(),Xv=function(){function e(){y(this,e),this.blend=!1,this.blendSrc=ma.ONE,this.blendDst=ma.ZERO,this.blendEq=_a.ADD,this.blendSrcAlpha=ma.ONE,this.blendDstAlpha=ma.ZERO,this.blendAlphaEq=_a.ADD,this.blendColorMask=ga.ALL}return l(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}(),jv=function e(){y(this,e),this.isA2C=!1,this.isIndepend=!1,this.blendColor=[0,0,0,0],this.targets=[new Xv]},qv=function e(){y(this,e),this.attributes=[]},Yv=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.PIPELINE_STATE)))._device=void 0,t._shader=null,t._primitive=Kt.GFXPrimitiveMode.TRIANGLE_LIST,t._is=null,t._rs=null,t._dss=null,t._bs=null,t._dynamicStates=[],t._layout=null,t._renderPass=null,t._device=e,t}return p(i,ns),l(i,[{key:"shader",get:function(){return this._shader}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"pipelineLayout",get:function(){return this._layout}},{key:"renderPass",get:function(){return this._renderPass}}]),i}(),Kv=(Pv=new Map,Dv=0,function(e){return Pv.has(e)||(Pv.set(e,1<<Dv),Dv++),Pv.get(e)}),Qv=(s(Nv={},Kr.INT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Nv,Kr.INT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return we.array(e,t,2*i)}),s(Nv,Kr.INT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Oe.array(e,t,3*i)}),s(Nv,Kr.INT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Be.array(e,t,4*i)}),s(Nv,Kr.FLOAT,function(e,t){return e[2<arguments.length&&void 0!==arguments[2]?arguments[2]:0]=t}),s(Nv,Kr.FLOAT2,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return we.array(e,t,2*i)}),s(Nv,Kr.FLOAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Oe.array(e,t,3*i)}),s(Nv,Kr.FLOAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Be.array(e,t,4*i)}),s(Nv,Kr.MAT3,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Me.array(e,t,9*i)}),s(Nv,Kr.MAT4,function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return He.array(e,t,16*i)}),Nv),Zv=(s(zv={},Kr.INT,[0]),s(zv,Kr.INT2,[0,0]),s(zv,Kr.INT3,[0,0,0]),s(zv,Kr.INT4,[0,0,0,0]),s(zv,Kr.FLOAT,[0]),s(zv,Kr.FLOAT2,[0,0]),s(zv,Kr.FLOAT3,[0,0,0]),s(zv,Kr.FLOAT4,[0,0,0,0]),s(zv,Kr.MAT3,[1,0,0,0,1,0,0,0,1]),s(zv,Kr.MAT4,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),s(zv,Kr.SAMPLER2D,"default-texture"),s(zv,Kr.SAMPLER_CUBE,"default-cube-texture"),zv),Jv=4026531840,$v=264241152,em=function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;return e<<28&Jv|t<<22&$v|i<<11&4192256|2047&n},tm=function(e){return e>=bf.CUSTUM_UBO_BINDING_END_POINT},im=function(){function o(e){y(this,o),this._buffers={},this._samplers={},this._textureViews={},this._resources=[],this._phase=0,this._idxInTech=0,this._programName="",this._priority=yf.DEFAULT,this._primitive=Kt.GFXPrimitiveMode.TRIANGLE_LIST,this._stage=vf.DEFAULT,this._bindings=[],this._bs=new jv,this._dss=new Wv,this._rs=new Hv,this._dynamicStates=[],this._dynamics={},this._customizations=[],this._handleMap={},this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._device=void 0,this._renderPass=null,this._shader=null,this._device=e}return l(o,[{key:"initialize",value:function(e){var s=this;this._idxInTech=e.idxInTech,this._programName=e.program,this._defines=e.curDefs,this._shaderInfo=Gf.getTemplate(e.program),this._properties=e.properties||this._properties;var t=this._device;this._fillinPipelineInfo(e),this._fillinPipelineInfo(e.states);var i=function(){if(o){if(l>=n.length)return"break";c=n[l++]}else{if((l=n.next()).done)return"break";c=l.value}var r=c;if(tm(r.binding))return"continue";s._buffers[r.binding]=t.createBuffer({memUsage:ea.HOST|ea.DEVICE,size:r.size,usage:Jr.UNIFORM|Jr.TRANSFER_DST});var a=s._blocks[r.binding]={buffer:new ArrayBuffer(r.size),dirty:!1,views:[]};r.members.reduce(function(e,t,i){var n=new Float32Array(a.buffer,e,t.size/Float32Array.BYTES_PER_ELEMENT);return a.views.push(n),s._handleMap[t.name]=em(Da.UNIFORM_BUFFER,t.type,r.binding,i),e+t.size},0)};var n=this._shaderInfo.blocks,o=Array.isArray(n),l=0;e:for(n=o?n:n[Symbol.iterator]();;){var c;switch(i()){case"break":break e;case"continue":continue}}var r=this._shaderInfo.samplers,a=Array.isArray(r),u=0;for(r=a?r:r[Symbol.iterator]();;){var h;if(a){if(u>=r.length)break;h=r[u++]}else{if((u=r.next()).done)break;h=u.value}var d=h;this._handleMap[d.name]=em(Da.SAMPLER,d.type,d.binding)}this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){return this._handleMap[e]}},{key:"getBinding",value:function(e){return o.getBindingFromHandle(this.getHandle(e))}},{key:"setUniform",value:function(e,t){var i=o.getBindingFromHandle(e),n=o.getTypeFromHandle(e),r=o.getIndexFromHandle(e),a=this._blocks[i];Qv[n](a.views[r],t),a.dirty=!0}},{key:"setUniformArray",value:function(e,t){for(var i=o.getBindingFromHandle(e),n=o.getTypeFromHandle(e),r=o.getIndexFromHandle(e),a=this._blocks[i],s=0;s<t.length;s++)null!==t[s]&&Qv[n](a.views[r],t[s],s);a.dirty=!0}},{key:"bindBuffer",value:function(e,t){this._buffers[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindBuffer(e,t)}}},{key:"bindTextureView",value:function(e,t){this._textureViews[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindTextureView(e,t)}}},{key:"bindSampler",value:function(e,t){this._samplers[e]=t;var i=this._resources,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.bindingLayout.bindSampler(e,t)}}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){this._bs=new jv,this._dss=new Wv,this._rs=new Hv,this._fillinPipelineInfo(e),this._fillinPipelineInfo(t)}},{key:"update",value:function(){for(var e=this._blocks.length,t=0;t<e;t++){var i=this._blocks[t];i.dirty&&(this._buffers[t].update(i.buffer),i.dirty=!1)}var n=cc.director.root.pipeline.globalBindings,r=this._shaderInfo.builtins.globals.samplers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=n.get(l);c.sampler&&this.bindSampler(c.samplerInfo.binding,c.sampler),this.bindTextureView(c.samplerInfo.binding,c.textureView)}}},{key:"destroy",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;tm(r.binding)||this._buffers[r.binding].destroy()}this._buffers={},this._samplers={},this._textureViews={}}},{key:"resetUBOs",value:function(){var e=this._shaderInfo.blocks,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(!tm(r.binding)){for(var a=this._blocks[r.binding],s=0;s<r.members.length;s++)for(var o=r.members[s],l=a.views[s],c=this._properties[o.name],u=c&&c.value,h=u||Zv[o.type],d=0;d<o.count;d++)l.set(h,d*h.length);a.dirty=!0}}}},{key:"resetTextures",value:function(){var e=this._device,t=this._shaderInfo.samplers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=this._properties[a.name];s&&s.sampler&&(this._samplers[a.binding]=Is.getSampler(e,s.sampler));var o=s&&s.value?s.value+"-texture":Zv[a.type],l=Vv.get(o);if(l){this._textureViews[a.binding]=l.getGFXTextureView();var c=l.getGFXSamplerInfo();this._samplers[a.binding]&&!c.length||(this._samplers[a.binding]=Is.getSampler(e,c))}else console.warn("illegal texture default value "+o)}}},{key:"tryCompile",value:function(e){e&&Object.assign(this._defines,e);var t=cc.director.root.pipeline;return!!t&&(this._renderPass=t.getRenderPass(this._stage),this._renderPass?(this._shader=Gf.getGFXShader(this._device,this._programName,this._defines,t),this._shader?(this._bindings.length||(this._bindings=this._shaderInfo.blocks.map(function(e){return{name:e.name,binding:e.binding,type:Da.UNIFORM_BUFFER}}).concat(this._shaderInfo.samplers.map(function(e){return{name:e.name,binding:e.binding,type:Da.SAMPLER}}))),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):(console.warn("illegal pass stage."),!1))}},{key:"createPipelineState",value:function(){if(!(this._renderPass&&this._shader&&this._bindings.length||this.tryCompile()))return console.warn("pass resources not complete, create PSO failed"),null;for(var e=this._device.createBindingLayout({bindings:this._bindings}),t=0,i=Object.keys(this._buffers);t<i.length;t++){var n=i[t];e.bindBuffer(parseInt(n),this._buffers[n])}for(var r=0,a=Object.keys(this._samplers);r<a.length;r++){var s=a[r];e.bindSampler(parseInt(s),this._samplers[s])}for(var o=0,l=Object.keys(this._textureViews);o<l.length;o++){var c=l[o];e.bindTextureView(parseInt(c),this._textureViews[c])}var u=cc.director.root.pipeline.globalBindings,h=this._shaderInfo.builtins.globals,d=h.blocks,f=Array.isArray(d),p=0;for(d=f?d:d[Symbol.iterator]();;){var _;if(f){if(p>=d.length)break;_=d[p++]}else{if((p=d.next()).done)break;_=p.value}var v=_,m=u.get(v);m&&m.type===Da.UNIFORM_BUFFER?e.bindBuffer(m.blockInfo.binding,m.buffer):console.warn("builtin UBO '".concat(v,"' not available!"))}var y=h.samplers,g=Array.isArray(y),b=0;for(y=g?y:y[Symbol.iterator]();;){var S;if(g){if(b>=y.length)break;S=y[b++]}else{if((b=y.next()).done)break;S=b.value}var T=S,E=u.get(T);E&&E.type===Da.SAMPLER?(E.sampler&&e.bindSampler(E.samplerInfo.binding,E.sampler),e.bindTextureView(E.samplerInfo.binding,E.textureView)):console.warn("builtin texture '".concat(T,"' not available!"))}var x=this._device.createPipelineLayout({layouts:[e]}),A=this._device.createPipelineState({bs:this._bs,dss:this._dss,dynamicStates:this._dynamicStates,is:new qv,layout:x,primitive:this._primitive,renderPass:this._renderPass,rs:this._rs,shader:this._shader});return this._resources.push({bindingLayout:e,pipelineLayout:x,pipelineState:A}),A}},{key:"destroyPipelineState",value:function(t){var e=this._resources.findIndex(function(e){return e.pipelineState===t});if(0<=e){var i=this._resources[e],n=i.bindingLayout,r=i.pipelineLayout,a=i.pipelineState;n.destroy(),r.destroy(),a.destroy(),this._resources.splice(e,1)}}},{key:"serializePipelineStates",value:function(){var e=Gf.getKey(this._programName,this._defines),t="".concat(e,",").concat(this._stage,",").concat(this._primitive);return t+=dm(this._bs),t+=pm(this._dss),t+=fm(this._rs)}},{key:"_fillinPipelineInfo",value:function(e){if(void 0!==e.priority&&(this._priority=e.priority),void 0!==e.primitive&&(this._primitive=e.primitive),void 0!==e.stage&&(this._stage=e.stage),void 0!==e.dynamics&&(this._dynamicStates=e.dynamics),e.customizations&&(this._customizations=e.customizations),0===this._phase){var t=e.phase||"default";this._phase=Kv(t)}var i=this._bs;if(e.blendState){var n=Object.assign({},e.blendState);n.targets&&n.targets.forEach(function(e,t){return Object.assign(i.targets[t]||(i.targets[t]=new Xv),e)}),delete n.targets,Object.assign(i,n)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState)}},{key:"idxInTech",get:function(){return this._idxInTech}},{key:"programName",get:function(){return this._programName}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"bindings",get:function(){return this._bindings}},{key:"blendState",get:function(){return this._bs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"rasterizerState",get:function(){return this._rs}},{key:"dynamics",get:function(){return this._dynamics}},{key:"customizations",get:function(){return this._customizations}},{key:"shader",get:function(){return this._shader}}]),o}();im.getBindingTypeFromHandle=function(e){return(e&Jv)>>>28},im.getTypeFromHandle=function(e){return(e&$v)>>>22},im.getBindingFromHandle=function(e){return(4192256&e)>>>11},im.getIndexFromHandle=function(e){return 2047&e};var nm,rm,am,sm,om,lm,cm,um,hm,dm=function(e){var t=",bs,".concat(e.isA2C,",").concat(e.blendColor),i=e.targets,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t+=",bt,".concat(s.blend,",").concat(s.blendEq,",").concat(s.blendAlphaEq,",").concat(s.blendColorMask),t+=",".concat(s.blendSrc,",").concat(s.blendDst,",").concat(s.blendSrcAlpha,",").concat(s.blendDstAlpha)}return t},fm=function(e){return",rs,".concat(e.cullMode,",").concat(e.depthBias,",").concat(e.isFrontFaceCCW)},pm=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)},_m=(nm=un("cc.Material"),rm=hn(Hf),nm((om=c((sm=function(e){function r(){var e;return y(this,r),v(e=T(this,S(r).call(this)),"_effectAsset",om,d(d(e))),v(e,"_techIdx",lm,d(d(e))),v(e,"_defines",cm,d(d(e))),v(e,"_states",um,d(d(e))),v(e,"_props",hm,d(d(e))),e._passes=[],e._owner=null,e._hash=0,e.loaded=!1,e}return p(r,qn),l(r,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}}],[{key:"getInstantiatedMaterial",value:function(e,t,i){if(e._owner===t)return e;var n=new r;return n.copy(e),n._native=e._native+" (Instance)",n._owner=t,i&&(n._uuid=e._uuid),n}}]),l(r,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Hf.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"destroy",value:function(){if(this._passes&&this._passes.length){var e=this._passes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}}return this._passes=[],this._effectAsset=null,this._props=[],this._defines=[],this._states=[],_(S(r.prototype),"destroy",this).call(this)}},{key:"resetUniforms",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this._props.length=this._passes.length,this._props.fill({}),e){var t=this._passes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.resetUBOs(),a.resetTextures()}}}},{key:"recompileShaders",value:function(e,t){if(this._passes&&this._effectAsset){if(void 0===t){var i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.tryCompile(e)}}else this._passes[t].tryCompile(e);this._onPassesChange()}}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this._effectAsset){var i=this._effectAsset.techniques[this._techIdx].passes;if(void 0===t){var n=this._passes,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.overridePipelineStates(i[o.idxInTech],e)}}else this._passes[t].overridePipelineStates(i[t],e);this._onPassesChange()}}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,s=0;s<a;s++){var o=r[s];this._uploadProperty(o,e,t)&&(this._props[s][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[i][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++)for(var a=i[r],s=0,o=Object.keys(a);s<o.length;s++){var l=o[s];if(l===e)return a[l]}else{if(t>=this._props.length)return void console.warn("illegal pass index: ".concat(t,"."));for(var c=this._props[t],u=0,h=Object.keys(c);u<h.length;u++){var d=h[u];if(d===e)return c[d]}}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length,this._props.fill({});for(var t=0;t<e._props.length;t++)Object.assign(this._props[t],e._props[t]);this._defines.length=e._defines.length,this._defines.fill({});for(var i=0;i<e._defines.length;i++)Object.assign(this._defines[i],e._defines[i]);Object.assign(this._states,e._states),this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;n++)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_update",value:function(){var s=this,e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length){var t=this._passes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.destroy()}}this._passes=vm(this._effectAsset,{techIdx:this._techIdx,defines:this._defines,states:this._states});var a=this._effectAsset.techniques[this._techIdx].passes.length;this._props.length=a,e?this._passes.forEach(function(e,t){var i=s._props[e.idxInTech];i||(i=s._props[t]={});for(var n=0,r=Object.keys(i);n<r.length;n++){var a=r[n];i[a]&&s._uploadProperty(e,a,i[a])}}):this._props.fill({})}else this._passes=Vv.get("missing-effect-material")._passes.slice();this._onPassesChange()}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(void 0===n)return!1;var r=im.getBindingTypeFromHandle(n);if(r===Da.UNIFORM_BUFFER)Array.isArray(i)?e.setUniformArray(n,i):e.setUniform(n,i);else if(r===Da.SAMPLER){var a=im.getBindingFromHandle(n);if(i instanceof Wf)e.bindTextureView(a,i);else if(i instanceof Kc){var s=i.getGFXTextureView();if(!s||!s.texture.width||!s.texture.height)return console.warn("material '".concat(this._uuid,"' received incomplete texture asset '").concat(i._uuid,"'")),!1;e.bindTextureView(a,s),e.bindSampler(a,Is.getSampler(cc.game._gfxDevice,i.getGFXSamplerInfo()))}}return!0}},{key:"_onPassesChange",value:function(){var t=this,e="",i=this._passes,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}e+=a.serializePipelineStates()}if(this._hash=function(e,t){for(var i=e.length,n=t^i,r=0;4<=i;){var a=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}(e,666),this._owner){var s=this._owner,o=s.sharedMaterials.findIndex(function(e){return e===t});0<=o&&s._onRebuildPSO(o,this)}}}]),r}()).prototype,"_effectAsset",[rm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lm=c(sm.prototype,"_techIdx",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cm=c(sm.prototype,"_defines",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),um=c(sm.prototype,"_states",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hm=c(sm.prototype,"_props",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),am=sm))||am),vm=function(e,t){if(!e.techniques)return[];for(var i=t.techIdx,n=t.defines,r=t.states,a=e.techniques[i||0],s=a.passes.length,o=[],l=0;l<s;++l){var c=a.passes[l],u=c.curDefs=n.length>l?n[l]:{};if(!c.switch||u[c.switch]){c.states=r.length>l?r[l]:{},c.idxInTech=l;var h=new im(cc.game._gfxDevice);h.initialize(c),o.push(h)}}return o};cc.Material=_m;var mm,ym,gm,bm,Sm=function(){function e(){y(this,e),this._arrayBufferOrPaddings=[],this._length=0}return l(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var t=new Uint8Array(this._length),i=0;return this._arrayBufferOrPaddings.forEach(function(e){"number"==typeof e?i+=e:(t.set(new Uint8Array(e),i),i+=e.byteLength)}),t.buffer}}]),e}();var Tm=function(){function t(e){y(this,t),this._subMeshes=e}return l(t,[{key:"getSubmesh",value:function(e){return this._subMeshes[e]}},{key:"clearSubMeshes",value:function(){var e=this._subMeshes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.vertexBuffers,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.destroy()}r.indexBuffer&&r.indexBuffer.destroy()}this._subMeshes.splice(0)}},{key:"destroy",value:function(){this.clearSubMeshes(),this._subMeshes.length=0}},{key:"subMeshes",get:function(){return this._subMeshes}},{key:"subMeshCount",get:function(){return this._subMeshes.length}}]),t}(),Em=un("cc.Mesh")((gm=c((ym=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_struct",gm,d(d(e))),v(e,"_dataLength",bm,d(d(e))),e._data=null,e._initialized=!1,e._renderingMesh=null,e.loaded=!1,e}return p(t,qn),l(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),cc.loader._cache[this.nativeUrl]&&(cc.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingMesh;return e?e.subMeshCount:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}}]),l(t,[{key:"initialize",value:function(){var u=this;if(!this._initialized){var i,n;this._initialized=!0,this._data||(this._data=new Uint8Array(this._dataLength),(i=this).loaded?n&&n():i.nativeUrl?cc.loader.load({url:i.nativeUrl},function(e,t){t&&(i.loaded||(i._nativeAsset=t)),n&&n(e)}):n&&n());var h=this._data.buffer,d=cc.director.root.device,f=this._createVertexBuffers(d,h),p=[],e=function(){if(v){if(m>=_.length)return"break";y=_[m++]}else{if((m=_.next()).done)return"break";y=m.value}var e=y;if(0===e.vertexBundelIndices.length)return"continue";var t=null,i=null;if(e.indexView){var n=e.indexView;t=d.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:n.length,stride:n.stride}),i=new(function(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}(n.stride))(h,n.offset,n.count),u.loaded?t.update(i):u.once("load",function(){t.update(i)})}var r=e.vertexBundelIndices.map(function(e){return f[e]}),a=[];if(0<e.vertexBundelIndices.length){var s=e.vertexBundelIndices[0];a=u._struct.vertexBundles[s].attributes}var o={primitiveMode:e.primitiveMode,vertexBuffers:r,indexBuffer:t,attributes:a};if(e.geometricInfo){var l=e.geometricInfo,c=new Float32Array(h,l.view.offset,l.view.length/4);o.geometricInfo={indices:i,positions:c}}p.push(o)};var _=this._struct.primitives,v=Array.isArray(_),m=0;e:for(_=v?_:_[Symbol.iterator]();;){var y;switch(e()){case"break":break e;case"continue":continue}}this._renderingMesh=new Tm(p)}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),_(S(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){this._renderingMesh&&(this._renderingMesh.destroy(),this._renderingMesh=null,this._data=null,this._initialized=!1)}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this.loaded=!0,this.emit("load")}},{key:"getSubMesh",value:function(e){return this.renderingMesh.getSubmesh(e)}},{key:"merge",value:function(e,t){if(void 0!==t&&t&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;if(!this._initialized&&e._data){var i=JSON.parse(JSON.stringify(e._struct)),n=e._data.slice();return this.reset({struct:i,data:n}),this.initialize(),!0}for(var r,a,s,o,l,c=new Sm,u=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=!1,g=new Array(this._struct.vertexBundles.length),b=0;b<this._struct.vertexBundles.length;++b){var S=this._struct.vertexBundles[b],T=e._struct.vertexBundles[b];d=S.view.offset,f=T.view.offset,h=S.view.stride,u=S.view.count+T.view.count,r=new ArrayBuffer(u*h),a=new Uint8Array(r),d+=(s=this._data.subarray(d,d+S.view.length)).length,f+=(o=e._data.subarray(f,f+T.view.length)).length,a.set(s),p=0;var E=S.attributes,x=Array.isArray(E),A=0;for(E=x?E:E[Symbol.iterator]();;){var C;if(x){if(A>=E.length)break;C=E[A++]}else{if((A=E.next()).done)break;C=A.value}var w=C;v=0,y=!1;var R=T.attributes,k=Array.isArray(R),O=0;for(R=k?R:R[Symbol.iterator]();;){var F;if(k){if(O>=R.length)break;F=R[O++]}else{if((O=R.next()).done)break;F=O.value}var L=F;if(w.name===L.name&&w.format===L.format){y=!0;break}v+=ls[L.format].size}if(y){m=ls[w.format].size,_=S.view.length+p;for(var B=0;B<T.view.count;++B)l=o.subarray(v,v+m),a.set(l,_),_+=S.view.stride,v+=T.view.stride}p+=ls[w.format].size}g[b]={attributes:S.attributes,view:{offset:c.getLength(),length:r.byteLength,count:u,stride:h}},c.addBuffer(r)}for(var M,I,P,D=0,N=2,z=0,U=new Array(this._struct.primitives.length),G=0;G<this._struct.primitives.length;++G){var V=this._struct.primitives[G],H=e._struct.primitives[G];U[G]={primitiveMode:V.primitiveMode,vertexBundelIndices:V.vertexBundelIndices};var W=V.vertexBundelIndices,X=Array.isArray(W),j=0;for(W=X?W:W[Symbol.iterator]();;){var q;if(X){if(j>=W.length)break;q=W[j++]}else{if((j=W.next()).done)break;q=j.value}var Y=q;z=Math.max(z,this._struct.vertexBundles[Y].view.count)}if(V.indexView&&H.indexView){D=V.indexView.count,D+=H.indexView.count,d=V.indexView.offset,f=H.indexView.offset,N=D<256?1:D<65536?2:4;var K=new ArrayBuffer(D*N);if(M=2===N?new Uint16Array(K):1===N?new Uint8Array(K):new Uint32Array(K),I=2===V.indexView.stride?new Uint16Array(this._data.buffer,d,V.indexView.count):1===V.indexView.stride?new Uint8Array(this._data.buffer,d,V.indexView.count):new Uint32Array(this._data.buffer,d,V.indexView.count),N===V.indexView.stride)M.set(I);else for(var Q=0;Q<V.indexView.count;++Q)M[Q]=I[Q];d+=V.indexView.length,P=2===H.indexView.stride?new Uint16Array(e._data.buffer,f,H.indexView.count):1===H.indexView.stride?new Uint8Array(e._data.buffer,f,H.indexView.count):new Uint32Array(e._data.buffer,f,H.indexView.count);for(var Z=0;Z<H.indexView.count;++Z)M[V.indexView.count+Z]=z+P[Z];f+=H.indexView.length,U[G].indexView={offset:c.getLength(),length:K.byteLength,count:D,stride:N},c.setNextAlignment(N),c.addBuffer(K)}if(V.geometricInfo&&H.geometricInfo){var J=V.geometricInfo.view.length+H.geometricInfo.view.length,$=new ArrayBuffer(J),ee=new Uint8Array($),te=new Uint8Array(this._data.buffer,V.geometricInfo.view.offset,V.geometricInfo.view.length),ie=new Uint8Array(e._data.buffer,H.geometricInfo.view.offset,H.geometricInfo.view.length);ee.set(te),ee.set(ie,te.length),c.setNextAlignment(4),U[G].geometricInfo={doubleSided:V.geometricInfo.doubleSided,view:{offset:c.getLength(),length:ee.length,count:V.geometricInfo.view.count+H.geometricInfo.view.count,stride:V.geometricInfo.view.stride}},c.addBuffer($)}}var ne={vertexBundles:g,primitives:U,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return ne.minPosition&&e._struct.minPosition&&Oe.min(ne.minPosition,ne.minPosition,e._struct.minPosition),ne.maxPosition&&e._struct.maxPosition&&Oe.max(ne.maxPosition,ne.maxPosition,e._struct.maxPosition),this.reset({struct:ne,data:new Uint8Array(c.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(!this._data&&e._data)return!0;if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var s=this._struct.primitives[a],o=e._struct.primitives[a];if(s.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var l=0;l<s.vertexBundelIndices.length;++l)if(s.vertexBundelIndices[l]!==o.vertexBundelIndices[l])return!1;if(s.primitiveMode!==o.primitiveMode)return!1;if(s.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var f=this,p=null;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(f._data.buffer,e.view.offset+xm(e.attributes,t)),r=ls[i],a=Am(i),s=Mm(n,i);if(a&&s){for(var o=e.view.count,l=r.count,c=new a(o*l),u=e.view.stride,h=0;h<o;++h)for(var d=0;d<l;++d)c[l*h+d]=s(u*h+c.BYTES_PER_ELEMENT*d);p=c}}),p}},{key:"copyAttribute",value:function(e,t,m,y,g){var b=this,S=!1;return this._accessAttribute(e,t,function(e,t){var i=e.attributes[t].format,n=new DataView(b._data.buffer,e.view.offset+xm(e.attributes,t)),r=new DataView(m,g),a=ls[i],s=Mm(n,i),o=function(i,e){var t=ls[e],n=t.size/t.count;switch(t.type){case rs.UNORM:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Bm)};case 4:return function(e,t){return i.setUint32(e,t,Bm)}}break;case rs.SNORM:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Bm)};case 4:return function(e,t){return i.setInt32(e,t,Bm)}}break;case rs.INT:switch(n){case 1:return function(e,t){return i.setInt8(e,t)};case 2:return function(e,t){return i.setInt16(e,t,Bm)};case 4:return function(e,t){return i.setInt32(e,t,Bm)}}break;case rs.UINT:switch(n){case 1:return function(e,t){return i.setUint8(e,t)};case 2:return function(e,t){return i.setUint16(e,t,Bm)};case 4:return function(e,t){return i.setUint32(e,t,Bm)}}break;case rs.FLOAT:return function(e,t){return i.setFloat32(e,t,Bm)}}return null}(r,i);if(s&&o){for(var l,c=e.view.count,u=a.count,h=e.view.stride,d=(l=ls[i]).size/l.count,f=y,p=d,_=0;_<c;++_)for(var v=0;v<u;++v){o(f*_+p*v,s(h*_+d*v))}S=!0}}),S}},{key:"readIndices",value:function(e){if(!this._data||e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;for(var i=t.indexView.count,n=i<256?Kt.GFXFormat.R8UI:i<65536?Kt.GFXFormat.R16UI:Kt.GFXFormat.R32UI,r=new(Am(n))(i),a=Mm(new DataView(this._data.buffer),n),s=0;s<i;++s)r[s]=a(t.indexView.offset+r.BYTES_PER_ELEMENT*s);return r}},{key:"copyIndices",value:function(e,t){if(!this._data||e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?Kt.GFXFormat.R8UI:2===i.indexView.stride?Kt.GFXFormat.R16UI:Kt.GFXFormat.R32UI,a=Mm(new DataView(this._data.buffer),r),s=0;s<n;++s)t[s]=a(i.indexView.offset+ls[r].size*s);return!0}},{key:"_accessAttribute",value:function(e,t,i){if(this._data&&!(e>=this._struct.primitives.length)){var n=this._struct.primitives[e].vertexBundelIndices,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=this._struct.vertexBundles[o],c=l.attributes.findIndex(function(e){return e.name===t});if(!(c<0)){i(l,c);break}}}}},{key:"_createVertexBuffers",value:function(n,r){var a=this;return this._struct.vertexBundles.map(function(e){var t=n.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:e.view.length,stride:e.view.stride}),i=new Uint8Array(r,e.view.offset,e.view.length);return a.loaded?t.update(i):a.once("load",function(){t.update(i)}),t})}},{key:"renderingMesh",get:function(){return this.initialize(),this._renderingMesh}}]),t}()).prototype,"_struct",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),bm=c(ym.prototype,"_dataLength",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mm=ym))||mm;function xm(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=ls[r.format].size}return i}function Am(e){var t=ls[e],i=t.size/t.count;switch(t.type){case rs.UNORM:case rs.UINT:switch(i){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case rs.SNORM:case rs.INT:switch(i){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case rs.FLOAT:return Float32Array}return null}cc.Mesh=Em;var Cm,wm,Rm,km,Om,Fm,Lm,Bm=cc.sys.isLittleEndian;function Mm(t,e){var i=ls[e],n=i.size/i.count;switch(i.type){case rs.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Bm)};case 4:return function(e){return t.getUint32(e,Bm)}}break;case rs.SNORM:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Bm)};case 4:return function(e){return t.getInt32(e,Bm)}}break;case rs.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Bm)};case 4:return function(e){return t.getInt32(e,Bm)}}break;case rs.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Bm)};case 4:return function(e){return t.getUint32(e,Bm)}}break;case rs.FLOAT:return function(e){return t.getFloat32(e,Bm)}}return null}var Im,Pm,Dm,Nm,zm=(Cm=un("cc.Skeleton"),wm=hn([yi]),Rm=hn([Dr]),Cm((Fm=c((Om=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_joints",Fm,d(d(t))),v(t,"_bindposes",Lm,d(d(t))),t._bindTRS=[],t}return p(a,qn),l(a,[{key:"onLoaded",value:function(){this.bindposes=this._bindposes}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e,this._bindTRS=e.map(function(e){var t=new Br,i=new Pr,n=new Br;return He.toRTS(e,i,t,n),{position:t,rotation:i,scale:n}})}},{key:"bindTRS",get:function(){return this._bindTRS}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}}]),a}()).prototype,"_joints",[wm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lm=c(Om.prototype,"_bindposes",[Rm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),km=Om))||km);cc.Skeleton=zm;var Um,Gm,Vm,Hm,Wm,Xm,jm,qm,Ym,Km,Qm=un("cc.PhysicsMaterial")((Dm=c((Pm=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_friction",Dm,d(d(e))),v(e,"_restitution",Nm,d(d(e))),e}return p(t,qn),l(t,[{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e}}]),t}()).prototype,"_friction",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Nm=c(Pm.prototype,"_restitution",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Im=Pm))||Im;cc.PhysicsMaterial=Qm;var Zm=(Um=un("cc.AudioSourceComponent"),Gm=vn("Components/AudioSourceComponent"),Vm=hn(Sl),Hm=hn({type:Sl}),Um(Wm=Gm((jm=c((Xm=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_clip",jm,d(d(t))),v(t,"_loop",qm,d(d(t))),v(t,"_playOnAwake",Ym,d(d(t))),v(t,"_volume",Km,d(d(t))),t._cachedCurrentTime=0,t}return p(a,Nh),l(a,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;e.playOneShot(this._volume*t)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e},get:function(){return this._volume}},{key:"currentTime",set:function(e){this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime)},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:Sl.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===Sl.PlayingState.PLAYING}}]),a}()).prototype,"_clip",[Vm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qm=c(Xm.prototype,"_loop",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ym=c(Xm.prototype,"_playOnAwake",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Km=c(Xm.prototype,"_volume",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(Xm.prototype,"clip",[Hm],Object.getOwnPropertyDescriptor(Xm.prototype,"clip"),Xm.prototype),c(Xm.prototype,"loop",[hn],Object.getOwnPropertyDescriptor(Xm.prototype,"loop"),Xm.prototype),c(Xm.prototype,"playOnAwake",[hn],Object.getOwnPropertyDescriptor(Xm.prototype,"playOnAwake"),Xm.prototype),c(Xm.prototype,"volume",[hn],Object.getOwnPropertyDescriptor(Xm.prototype,"volume"),Xm.prototype),Wm=Xm))||Wm)||Wm),Jm=Dt.fastRemove,$m=new Array(16),ey=null,ty=new Lr,iy=[Kt.SystemEventType.TOUCH_START.toString(),Kt.SystemEventType.TOUCH_MOVE.toString(),Kt.SystemEventType.TOUCH_END.toString(),Kt.SystemEventType.TOUCH_CANCEL.toString()],ny=[Kt.SystemEventType.MOUSE_DOWN.toString(),Kt.SystemEventType.MOUSE_ENTER.toString(),Kt.SystemEventType.MOUSE_MOVE.toString(),Kt.SystemEventType.MOUSE_LEAVE.toString(),Kt.SystemEventType.MOUSE_UP.toString(),Kt.SystemEventType.MOUSE_WHEEL.toString()];function ry(e,t){var i=this.owner;return!(!i||!i.uiTransfromComp)&&(e.getUILocation(ty),!!i.uiTransfromComp.isHit(ty,this)&&(t.type=Kt.SystemEventType.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function ay(e,t){var i=this.owner;if(!i||!i.uiTransfromComp)return!1;t.type=Kt.SystemEventType.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function sy(e,t){var i=this.owner;i&&i.uiTransfromComp&&(e.getUILocation(ty),i.uiTransfromComp.isHit(ty,this)?t.type=Kt.SystemEventType.TOUCH_END.toString():t.type=Kt.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function oy(e,t){var i=this.owner;i&&i.uiTransfromComp&&(t.type=Kt.SystemEventType.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function ly(e){var t=this.owner;t&&t.uiTransfromComp&&(ty=e.getUILocation(),t.uiTransfromComp.isHit(ty,this)&&(e.type=Kt.SystemEventType.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function cy(e){var t=this.owner;if(t&&t.uiTransfromComp){if(ty=e.getUILocation(),t.uiTransfromComp.isHit(ty,this))this._previousIn||(ey&&ey.eventProcessor.mouseListener&&(e.type=Kt.SystemEventType.MOUSE_LEAVE,ey.dispatchEvent(e),ey.eventProcessor.mouseListener&&(ey.eventProcessor.mouseListener._previousIn=!1)),ey=t,e.type=Kt.SystemEventType.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=Kt.SystemEventType.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=Kt.SystemEventType.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,ey=null}e.propagationStopped=!0}}function uy(e){var t=this.owner;t&&t.uiTransfromComp&&(ty=e.getUILocation(),t.uiTransfromComp.isHit(ty,this)&&(e.type=Kt.SystemEventType.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function hy(e){var t=this.owner;t&&t.uiTransfromComp&&(ty=e.getUILocation(),t.uiTransfromComp.isHit(ty,this)&&(e.type=Kt.SystemEventType.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function dy(e){var t=cc.MaskComponent;if(t)for(var i=0,n=e;n&&bd.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function fy(e,t){if(e._persistNode)return!0;var i=0;if(e.eventProcessor.bubblingTargets)for(;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(;i<t.length;++i)if(e.eventProcessor.capturingTargets.hasEventListener(t[i]))return!0;return!1}var py=function(){function t(e){y(this,t),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=e}return l(t,[{key:"node",get:function(){return this._node}}]),l(t,[{key:"destroy",value:function(){ey===this._node&&(ey=null),(this.touchListener||this.mouseListener)&&(sh.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null))}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new Xn),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){(this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new Xn:this.bubblingTargets=this.bubblingTargets||new Xn).once(e,t,i)}},{key:"off",value:function(e,t,i,n){var r=-1!==iy.indexOf(e),a=!r&&-1!==ny.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!fy(this._node,iy)&&(sh.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!fy(this._node,ny)&&(sh.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e){if(this.bubblingTargets){for(var t,i=arguments.length,n=new Array(1<i?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];(t=this.bubblingTargets).emit.apply(t,[e].concat(n))}}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,$m.length=0,e.eventProcessor.getCapturingTargets(t.type,$m),t.eventPhase=1,n=$m.length-1;0<=n;--n)if((i=$m[n]).eventProcessor.capturingTargets&&((t.currentTarget=i).eventProcessor.capturingTargets.emit(t.type,t,$m),t.propagationStopped))return $m.length=0;if($m.length=0,t.eventPhase=2,(t.currentTarget=e).eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,$m),t.eventPhase=3,n=0;n<$m.length;++n)if((i=$m[n]).eventProcessor.bubblingTargets&&((t.currentTarget=i).eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return $m.length=0;$m.length=0}(this._node,e),$m.length=0}},{key:"hasEventListener",value:function(e){var t=!1;return this.bubblingTargets&&(t=this.bubblingTargets.hasEventListener(e)),!t&&this.capturingTargets&&(t=this.capturingTargets.hasEventListener(e)),t}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.targetOff(e),this.bubblingTargets&&this.bubblingTargets.targetOff(e),this.touchListener&&!fy(this.node,iy)&&(sh.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!fy(this.node,ny)&&(sh.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==iy.indexOf(e)?(this.touchListener||(this.touchListener=cc.EventListener.create({event:cc.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:dy(this._node),onTouchBegan:ry,onTouchMoved:ay,onTouchEnded:sy,onTouchCancelled:oy}),sh.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==ny.indexOf(e)&&(this.mouseListener||(this.mouseListener=cc.EventListener.create({event:cc.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:dy(this._node),onMouseDown:ly,onMouseMove:cy,onMouseUp:uy,onMouseScroll:hy}),sh.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&cc.director.getScheduler().schedule(function(){t._node.activeInHierarchy||sh.pauseTarget(t._node)},this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;if(!(r=n?this.capturingTargets=this.capturingTargets||new Xn:this.bubblingTargets=this.bubblingTargets||new Xn).hasEventListener(e,t,i)){r.on(e,t,i);var a=i;i&&(a.__eventTargets?a.__eventTargets.push(this):a.node&&a.node.__eventTargets&&a.node.__eventTargets.push(this))}return t}cc.errorID(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;if(r){r.off(e,t,i);var a=i;i&&(a.__eventTargets?Jm(a.__eventTargets,this):a.node&&a.node.__eventTargets&&Jm(a.node.__eventTargets,this))}}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),t}();cc.NodeEventProcessor=py;var _y,vy,my,yy,gy,by,Sy,Ty,Ey,xy,Ay,Cy,wy,Ry,ky,Oy,Fy,Ly,By,My,Iy,Py,Dy,Ny,zy,Uy,Gy,Vy,Hy,Wy,Xy,jy,qy,Yy,Ky,Qy,Zy,Jy,$y,eg,tg,ig=function(){function t(e){y(this,t),this._enabled=!0,this._skyColor=Float32Array.from([.2,.5,.8,1]),this._skyIllum=t.SKY_ILLUM,this._groundAlbedo=Float32Array.from([.2,.2,.2,1]),this._scene=void 0,this._scene=e}return l(t,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e}},{key:"skyIllum",set:function(e){this._skyIllum=e},get:function(){return this._skyIllum}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e}}]),l(t,[{key:"update",value:function(){}}]),t}();ig.SUN_ILLUM=65e3,ig.SKY_ILLUM=2e4;var ng=new Br(0,1,0),rg=new Br,ag=new Pr,sg=(_y=un("cc.AmbientInfo"),vy=hn({type:Hr}),my=hn({type:vi}),yy=hn({type:Hr}),_y((Sy=c((by=function(){function e(){y(this,e),v(this,"_skyColor",Sy,this),v(this,"_skyIllum",Ty,this),v(this,"_groundAlbedo",Ey,this),this._resource=null}return l(e,[{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&je.array(this._resource.skyColor,this.skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&je.array(this._resource.groundAlbedo,this.groundAlbedo)},get:function(){return this._groundAlbedo}},{key:"renderScene",set:function(e){this._resource=e.ambient,this.skyColor=this._skyColor,this.skyIllum=this._skyIllum,this.groundAlbedo=this._groundAlbedo}}]),e}()).prototype,"_skyColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(51,128,204,1)}}),Ty=c(by.prototype,"_skyIllum",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ig.SKY_ILLUM}}),Ey=c(by.prototype,"_groundAlbedo",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(51,51,51,255)}}),c(by.prototype,"skyColor",[vy],Object.getOwnPropertyDescriptor(by.prototype,"skyColor"),by.prototype),c(by.prototype,"skyIllum",[my],Object.getOwnPropertyDescriptor(by.prototype,"skyIllum"),by.prototype),c(by.prototype,"groundAlbedo",[yy],Object.getOwnPropertyDescriptor(by.prototype,"groundAlbedo"),by.prototype),gy=by))||gy);cc.AmbientInfo=sg;var og=(xy=un("cc.SkyboxInfo"),Ay=hn(Mv),Cy=hn({type:mi}),wy=hn({type:mi}),Ry=hn({type:Mv}),ky=hn({type:mi}),xy((Ly=c((Fy=function(){function e(){y(this,e),v(this,"_envmap",Ly,this),v(this,"_isRGBE",By,this),v(this,"_enabled",My,this),v(this,"_useIBL",Iy,this),this._resource=null}return l(e,[{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}},{key:"renderScene",set:function(e){this._resource=e.skybox,this.isRGBE=this._isRGBE,this.envmap=this._envmap,this.enabled=this._enabled,this.useIBL=this._useIBL}}]),e}()).prototype,"_envmap",[Ay],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),By=c(Fy.prototype,"_isRGBE",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),My=c(Fy.prototype,"_enabled",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Iy=c(Fy.prototype,"_useIBL",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(Fy.prototype,"enabled",[Cy],Object.getOwnPropertyDescriptor(Fy.prototype,"enabled"),Fy.prototype),c(Fy.prototype,"useIBL",[wy],Object.getOwnPropertyDescriptor(Fy.prototype,"useIBL"),Fy.prototype),c(Fy.prototype,"envmap",[Ry],Object.getOwnPropertyDescriptor(Fy.prototype,"envmap"),Fy.prototype),c(Fy.prototype,"isRGBE",[ky],Object.getOwnPropertyDescriptor(Fy.prototype,"isRGBE"),Fy.prototype),Oy=Fy))||Oy);cc.SkyboxInfo=og;var lg=(Py=un("cc.PlanarShadowInfo"),Dy=hn({type:mi}),Ny=hn({type:Br}),zy=hn({type:vi}),Uy=hn({type:Hr}),Py((Hy=c((Vy=function(){function e(){y(this,e),v(this,"_enabled",Hy,this),v(this,"_normal",Wy,this),v(this,"_distance",Xy,this),v(this,"_shadowColor",jy,this),this._resource=null}return l(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(ag),this.normal=Oe.transformQuat(rg,ng,ag),e.getWorldPosition(rg),this.distance=Oe.dot(this._normal,rg)}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"normal",set:function(e){Oe.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"renderScene",set:function(e){this._resource=e.planarShadows,this.normal=this._normal,this.distance=this._distance,this.shadowColor=this._shadowColor,this.enabled=this._enabled}}]),e}()).prototype,"_enabled",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wy=c(Vy.prototype,"_normal",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(0,1,0)}}),Xy=c(Vy.prototype,"_distance",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jy=c(Vy.prototype,"_shadowColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(0,0,0,76)}}),c(Vy.prototype,"enabled",[Dy],Object.getOwnPropertyDescriptor(Vy.prototype,"enabled"),Vy.prototype),c(Vy.prototype,"normal",[Ny],Object.getOwnPropertyDescriptor(Vy.prototype,"normal"),Vy.prototype),c(Vy.prototype,"distance",[zy],Object.getOwnPropertyDescriptor(Vy.prototype,"distance"),Vy.prototype),c(Vy.prototype,"shadowColor",[Uy],Object.getOwnPropertyDescriptor(Vy.prototype,"shadowColor"),Vy.prototype),Gy=Vy))||Gy);cc.PlanarShadowInfo=lg;var cg,ug,hg,dg,fg=(qy=un("cc.SceneGlobals"),Yy=hn({type:sg}),Ky=hn({type:og}),Qy=hn({type:lg}),qy(($y=c((Jy=function(){function e(){y(this,e),v(this,"ambient",$y,this),v(this,"skybox",eg,this),v(this,"planarShadows",tg,this)}return l(e,[{key:"renderScene",set:function(e){this.ambient.renderScene=e,this.skybox.renderScene=e,this.planarShadows.renderScene=e}}]),e}()).prototype,"ambient",[Yy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new sg}}),eg=c(Jy.prototype,"skybox",[Ky],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new og}}),tg=c(Jy.prototype,"planarShadows",[Qy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new lg}}),Zy=Jy))||Zy);cc.SceneGlobals=fg;var pg,_g=un("cc.Scene")((hg=c((ug=function(e){function i(e){var t;return y(this,i),v(t=T(this,S(i).call(this,e)),"autoReleaseAssets",hg,d(d(t))),v(t,"_globals",dg,d(d(t))),t._renderScene=null,t.dependAssets=null,t._inited=!cc.game._isCloning,t._prefabSyncedInLiveReload=!1,t._activeInHierarchy=!1,cc.director&&cc.director.root&&(t._renderScene=cc.director.root.createScene({})),t}return p(i,bd),l(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),l(i,[{key:"destroy",value:function(){var e=_(S(i.prototype),"destroy",this).call(this);return cc.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"_onHierarchyChanged",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(td._setScene)}},{key:"_activate",value:function(e){e=!1!==e,cc.director._nodeActivator.activateNode(this,e),this._globals.renderScene=this._renderScene}}]),i}()).prototype,"autoReleaseAssets",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dg=c(ug.prototype,"_globals",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fg}}),cg=ug))||cg;function vg(e,t){if(t)0;else{var i=cc.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}cc.Scene=_g,cc.find=vg;var mg=Cn.Flags.HideInHierarchy,yg=un("cc.PrivateNode")(pg=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._objFlags|=mg,t}return p(i,bd),i}())||pg;cc.PrivateNode=yg;Dt.fastRemoveAt;var gg=Cn.Flags.IsStartCalled,bg=Cn.Flags.IsOnEnableCalled,Sg=(Cn.Flags.IsEditorOnEnableCalled,"c.start();c._objFlags|="+gg);function Tg(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,s=a>>>1;r<=a;s=r+a>>>1){var o=e[s],l=o.constructor._executionOrder;if(i<l)a=s-1;else if(l<i)r=s+1;else{var c=o._id;if(n<c)a=s-1;else{if(!(c<n))return s;r=s+1}}}return~r}function Eg(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}var xg=function e(t){y(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var i=Ye;this._zero=new i([]),this._neg=new i([]),this._pos=new i([]),this._invoke=t};function Ag(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}xg.stableRemoveInactive=Eg;var Cg=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,xg),l(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){Eg(this._zero,e),Eg(this._neg,e),Eg(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;0<e.array.length&&(e.array.sort(Ag),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;0<t.array.length&&(t.array.sort(Ag),this._invoke(t),t.array.length=0)}}]),t}(),wg=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,xg),l(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=Tg(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=Tg(i.array,e);0<=n&&i.removeAt(n)}}},{key:"invoke",value:function(e){0<this._neg.array.length&&this._invoke(this._neg,e),this._invoke(this._zero,e),0<this._pos.array.length&&this._invoke(this._pos,e)}}]),t}();function Rg(r,e){if("function"==typeof r)return e?function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];r(n,t)}}:function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];r(i)}};var t="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+r+"}";return e?Function("it","dt",t):Function("it",t)}var kg=function(){function e(){y(this,e),this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this.scheduleInNextFrame=void 0,this._updating=void 0,this.unscheduleAll()}return l(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new Cg(Rg(Sg)),this.updateInvoker=new wg(Rg("c.update(dt)",!0)),this.lateUpdateInvoker=new wg(Rg("c.lateUpdate(dt)",!0)),this.scheduleInNextFrame=[],this._updating=!1}},{key:"_onEnabled",value:function(e){cc.director.getScheduler().resumeTarget(e),e._objFlags|=bg,this._updating?this.scheduleInNextFrame.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){cc.director.getScheduler().pauseTarget(e),e._objFlags&=~bg;var t=this.scheduleInNextFrame.indexOf(e);0<=t?Dt.fastRemoveAt(this.scheduleInNextFrame,t):(!e.start||e._objFlags&gg||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&bg)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&bg&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,0<this.scheduleInNextFrame.length&&this._deferredSchedule(),this.startInvoker.invoke()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1}},{key:"_scheduleImmediate",value:function(e){!e.start||e._objFlags&gg||this.startInvoker.add(e),e.update&&this.updateInvoker.add(e),e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this.scheduleInNextFrame,t=0,i=e.length;t<i;t++){var n=e[t];this._scheduleImmediate(n)}e.length=0}}]),e}();kg.LifeCycleInvoker=xg,kg.OneOffInvoker=Cg,kg.createInvokeImpl=Rg,kg.invokeOnEnable=function(e){var t=cc.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n)}};var Og=Cn.Flags.IsPreloadStarted,Fg=Cn.Flags.IsOnLoadStarted,Lg=Cn.Flags.IsOnLoadCalled,Bg=Cn.Flags.Deactivating,Mg="c.onLoad();c._objFlags|="+Lg,Ig=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,kg.LifeCycleInvoker),l(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){kg.LifeCycleInvoker.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(),Pg=kg.createInvokeImpl("c.__preload();"),Dg=kg.createInvokeImpl(Mg),Ng=new Pt(4);Ng.get=function(){var e=this._get()||{preload:new Ig(Pg),onLoad:new kg.OneOffInvoker(Dg),onEnable:new kg.OneOffInvoker(kg.invokeOnEnable)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var zg,Ug,Gg,Vg=function(){function e(){y(this,e),this.resetComp=void 0,this._activatingStack=void 0,this.reset()}return l(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=Ng.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),Ng.put(i)}else{this._deactivateNodeRecursively(e);var n=this._activatingStack,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.preload.cancelInactive(Og),o.onLoad.cancelInactive(Fg),o.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&Og||(e._objFlags|=Og,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&Fg||(e._objFlags|=Fg,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=Lg):e._objFlags|=Lg),e._enabled){if(!e.node._activeInHierarchy)return;cc.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){cc.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&Lg&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&Bg)cc.errorID(3816,e.name);else{e._activeInHierarchy=!0;for(var r,a,s,o=e._components.length,l=0;l<o;++l){var c=e._components[l];c instanceof cc.Component?this.activateComp(c,t,i,n):(r=e,s=l,(a=c)?r._removeComponent(a):Dt.removeAt(r._components,s),--l,--o)}for(var u=0,h=e._children.length;u<h;++u){var d=e._children[u];d._active&&this._activateNodeRecursively(d,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=Bg,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(cc.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~Bg)}for(var r=0,a=e._children.length;r<a;++r){var s=e._children[r];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~Bg)}e._onPostActivated(!1),e._objFlags&=~Bg}}]),e}();(Gg=Ug||(Ug={}))[Gg.positions=Kt.GFXAttributeName.ATTR_POSITION]="positions",Gg[Gg.normals=Kt.GFXAttributeName.ATTR_NORMAL]="normals",Gg[Gg.uvs=Kt.GFXAttributeName.ATTR_TEX_COORD]="uvs",Gg[Gg.colors=Kt.GFXAttributeName.ATTR_COLOR]="colors";var Hg=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_NORMAL,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA32F}],Wg=new Br;function Xg(e,t,i){i=i||{};var n,r=[],a=0,s=[],o=0;if(0<e.positions.length){if(n=null,e.attributes){var l=e.attributes,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var d=h;if(d.name===Kt.GFXAttributeName.ATTR_POSITION){n=d;break}}}n||(n=Hg[0]);var f=ls[n.format];r.push(n),o=Math.max(o,Math.floor(e.positions.length/f.count)),s.push({offset:a,data:e.positions,attribute:n}),a+=f.size}if(e.normals&&0<e.normals.length){if(n=null,e.attributes){var p=e.attributes,_=Array.isArray(p),v=0;for(p=_?p:p[Symbol.iterator]();;){var m;if(_){if(v>=p.length)break;m=p[v++]}else{if((v=p.next()).done)break;m=v.value}var y=m;if(y.name===Kt.GFXAttributeName.ATTR_NORMAL){n=y;break}}}n||(n=Hg[1]);var g=ls[n.format];r.push(n),o=Math.max(o,Math.floor(e.normals.length/g.count)),s.push({offset:a,data:e.normals,attribute:n}),a+=g.size}if(e.uvs&&0<e.uvs.length){if(n=null,e.attributes){var b=e.attributes,S=Array.isArray(b),T=0;for(b=S?b:b[Symbol.iterator]();;){var E;if(S){if(T>=b.length)break;E=b[T++]}else{if((T=b.next()).done)break;E=T.value}var x=E;if(x.name===Kt.GFXAttributeName.ATTR_TEX_COORD){n=x;break}}}n||(n=Hg[2]);var A=ls[n.format];r.push(n),o=Math.max(o,Math.floor(e.uvs.length/A.count)),s.push({offset:a,data:e.uvs,attribute:n}),a+=A.size}if(e.colors&&0<e.colors.length){if(n=null,e.attributes){var C=e.attributes,w=Array.isArray(C),R=0;for(C=w?C:C[Symbol.iterator]();;){var k;if(w){if(R>=C.length)break;k=C[R++]}else{if((R=C.next()).done)break;k=R.value}var O=k;if(O.name===Kt.GFXAttributeName.ATTR_COLOR){n=O;break}}}n||(n=Hg[3]);var F=ls[n.format];r.push(n),o=Math.max(o,Math.floor(e.colors.length/F.count)),s.push({offset:a,data:e.colors,attribute:n}),a+=F.size}if(e.customAttributes){var L=e.customAttributes,B=Array.isArray(L),M=0;for(L=B?L:L[Symbol.iterator]();;){var I;if(B){if(M>=L.length)break;I=L[M++]}else{if((M=L.next()).done)break;I=M.value}var P=I,D=ls[P.attr.format];r.push(P.attr),o=Math.max(o,Math.floor(P.values.length/D.count)),s.push({offset:a,data:P.values,attribute:P.attr}),a+=D.size}}for(var N=new Sm,z=new ArrayBuffer(o*a),U=new DataView(z),G=0,V=s;G<V.length;G++){var H=V[G];Kg(U,H.data,H.attribute.format,H.offset,a)}N.setNextAlignment(0);var W={attributes:r,view:{offset:N.getLength(),length:z.byteLength,count:o,stride:a}};N.addBuffer(z);var X=null,j=0;if(e.indices){var q=e.indices;j=q.length,X=new ArrayBuffer(2*j),Kg(new DataView(X),q,Kt.GFXFormat.R16UI)}var Y={primitiveMode:e.primitiveMode||Kt.GFXPrimitiveMode.TRIANGLE_LIST,vertexBundelIndices:[0]};if(Y.primitiveMode>=Kt.GFXPrimitiveMode.TRIANGLE_LIST){var K=Float32Array.from(e.positions);N.setNextAlignment(4),Y.geometricInfo={doubleSided:e.doubleSided,view:{offset:N.getLength(),length:K.byteLength,count:e.positions.length/4,stride:4}},N.addBuffer(K.buffer)}X&&(N.setNextAlignment(2),Y.indexView={offset:N.getLength(),length:X.byteLength,count:j,stride:2},N.addBuffer(X));var Q=e.minPos;if(!Q&&i.calculateBounds){Q=Oe.set(new Oe,1/0,1/0,1/0);for(var Z=0;Z<o;++Z)Oe.set(Wg,e.positions[3*Z+0],e.positions[3*Z+1],e.positions[3*Z+2]),Oe.min(Q,Q,Wg)}var J=e.maxPos;if(!J&&i.calculateBounds){J=Oe.set(new Oe,-1/0,-1/0,-1/0);for(var $=0;$<o;++$)Oe.set(Wg,e.positions[3*$+0],e.positions[3*$+1],e.positions[3*$+2]),Oe.max(J,J,Wg)}var ee={vertexBundles:[W],primitives:[Y]};return Q&&(ee.minPosition=new Br(Q.x,Q.y,Q.z)),J&&(ee.maxPosition=new Br(J.x,J.y,J.z)),t||(t=new Em),t.reset({struct:ee,data:new Uint8Array(N.getCombined())}),t}var jg=cc.sys.isLittleEndian,qg=(s(zg={},rs.UNORM,"Uint"),s(zg,rs.SNORM,"Int"),s(zg,rs.UINT,"Uint"),s(zg,rs.INT,"Int"),s(zg,rs.UFLOAT,"Float"),s(zg,rs.FLOAT,"Float"),s(zg,"default","Uint"),zg);function Yg(e){return(qg[e.type]||qg.default)+e.size/e.count*8}function Kg(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Kt.GFXFormat.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=ls[i];r||(r=a.size);for(var s="set"+Yg(a),o=a.size/a.count,l=Math.floor(t.length/a.count),c=0;c<l;++c)for(var u=n+r*c,h=0;h<a.count;++h){var d=u+o*h;e[s](d,t[a.count*c+h],jg)}}function Qg(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Kt.GFXFormat.R32F,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],s=ls[t];r||(r=s.size);for(var o="get"+Yg(s),l=s.size/s.count,c=Math.floor(n/r),u=0;u<c;++u)for(var h=i+r*u,d=0;d<s.count;++d){var f=h+l*d;a[s.count*u+d]=e[o](f,jg)}return a}function Zg(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Kt.GFXFormat.R32F,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0,s=6<arguments.length?arguments[6]:void 0;s||(s=new DataView(new ArrayBuffer(e.byteLength)));var o=ls[i];a||(a=o.size);for(var l="set"+Yg(o),c="get"+Yg(o),u=o.size/o.count,h=Math.floor(r/a),d=0;d<h;++d)for(var f=n+a*d,p=0;p<o.count;++p){var _=f+u*p,v=e[c](_,jg);s[l](_,t(v,p,e),jg)}return s}var Jg=[],$g=function(e,t){if(e===t)return e;var i=t;for(Jg.length=0;i;)Jg.push(i),i=i.parent;for(i=e;i;){if(Jg.find(function(e){return e===i}))return i;i=i.parent}return null},eb=new Br;var tb=new(function(){function e(){y(this,e),this._cached=new Map}return l(e,[{key:"use",value:function(e,t){var i=this._cached.get(e);i||(i=new Map,this._cached.set(e,i));var n=i.get(t);return n||(n={bounds:function(e,t){for(var i=new Array(t.joints.length),n=0;n<i.length;++n)i[n]={hasValue:!1,min:new Br(1/0,1/0,1/0),max:new Br(-1/0,-1/0,-1/0)};for(var r=0;r<e.struct.primitives.length;++r){var a=e.readAttribute(r,Kt.GFXAttributeName.ATTR_JOINTS);if(a){var s=e.readAttribute(r,Kt.GFXAttributeName.ATTR_WEIGHTS);if(s){var o=e.readAttribute(r,Kt.GFXAttributeName.ATTR_POSITION);if(o)for(var l=Math.min(a.length/4,s.length/4,o.length/3),c=0;c<l;++c){Oe.set(Wg,o[3*c+0],o[3*c+1],o[3*c+2]);for(var u=0;u<4;++u)if(0!==s[4*c+u]){var h=a[4*c+u];if(!(h>=t.joints.length)){t.bindposes?Oe.transformMat4(eb,Wg,t.bindposes[h]):Oe.copy(eb,Wg);var d=i[h];d.hasValue=!0,Oe.min(d.min,d.min,eb),Oe.max(d.max,d.max,eb)}}}}}}return i.map(function(e){return e.hasValue?G_.fromPoints(new G_,e.min,e.max):null})}(e,t),referenceCount:0},i.set(t,n)),++n.referenceCount,n.bounds}},{key:"unuse",value:function(e,t){var i=this._cached.get(e);if(i){var n=i.get(t);n&&(--n.referenceCount,0===n.referenceCount&&i.delete(t)),0===i.size&&this._cached.delete(e)}}}]),e}()),ib=new Dr,nb=new G_,rb=new Br,ab=new Br;var sb,ob,lb,cb=Object.freeze({toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter(function(e,t){return t%4<3}).toString(),"\n")},createMesh:Xg,readMesh:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i={positions:[]},n=new DataView(e._nativeAsset),r=e.struct,a=r.primitives[t],s=a.vertexBundelIndices,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=r.vertexBundles[u],d=h.view.offset,f=h.view,p=f.length,_=f.stride,v=h.attributes,m=Array.isArray(v),y=0;for(v=m?v:v[Symbol.iterator]();;){var g;if(m){if(y>=v.length)break;g=v[y++]}else{if((y=v.next()).done)break;g=y.value}var b=g,S=Ug[b.name];S&&(i[S]=(i[S]||[]).concat(Qg(n,b.format,d,p,_))),d+=ls[b.format].size}}var T=a.indexView;return i.indices=Qg(n,Kt.GFXFormat["R".concat(8*T.stride,"UI")],T.offset,T.length),i},writeBuffer:Kg,readBuffer:Qg,mapBuffer:Zg,LCA:$g,calculateSkinnedBounds:function(e,t){if(t.model&&t.mesh&&t.skeleton){var i=t.mesh,n=t.skeleton,r=t.model.joints;Oe.set(rb,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Oe.set(ab,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(var a=tb.use(i,n),s=r.length,o=0;o<s;++o){var l=a[o],c=r[o].node;l&&c&&(c.getWorldMatrix(ib),G_.transform(nb,l,ib),nb.getBoundary(Wg,eb),Oe.min(rb,rb,Wg),Oe.max(ab,ab,eb))}return G_.fromPoints(e,rb,ab),!0}},find:vg});function ub(e,t){return t<=30?ob.UNIFORM:e.hasFeature(ps.TEXTURE_FLOAT)?ob.RGBA32F:ob.RGBA8}(lb=ob||(ob={}))[lb.NONE=0]="NONE",lb[lb.UNIFORM=1]="UNIFORM",lb[lb.RGBA8=2]="RGBA8",lb[lb.RGBA32F=3]="RGBA32F";var hb=(s(sb={},ob.UNIFORM,ms.RGBA32F),s(sb,ob.RGBA8,ms.RGBA8888),s(sb,ob.RGBA32F,ms.RGBA32F),sb),db=new Br,fb=new Br,pb=new Pr,_b=new Pr,vb=new Pr,mb=new Dr,yb=new Float32Array(4),gb=function(){function t(e){y(this,t),this.node=void 0,this.position=new Br,this.rotation=new Pr,this.scale=new Br(1,1,1),this.parent=null,this._lastUpdate=-1,this.node=e}return l(t,[{key:"update",value:function(){var e=cc.director.getTotalFrames();if(!(this._lastUpdate>=e)){this._lastUpdate=e;var t=this.parent;t&&(t.update(),Oe.multiply(this.position,this.node.position,t.scale),Oe.transformQuat(this.position,this.position,t.rotation),Oe.add(this.position,this.position,t.position),De.multiply(this.rotation,t.rotation,this.node.rotation),Oe.multiply(this.scale,t.scale,this.node.scale))}}}]),t}(),bb=function(){function n(){y(this,n)}return l(n,null,[{key:"get",value:function(e,t){var i=n._joints.get(e);return i||(i=new gb(e),e!==t&&e.parent&&(i.parent=n.get(e.parent,t)),n._joints.set(e,i),i)}}]),n}();bb._joints=new Map;var Sb,Tb,Eb,xb,Ab,Cb,wb,Rb,kb,Ob,Fb,Lb,Bb,Mb,Ib,Pb,Db,Nb,zb,Ub,Gb,Vb,Hb,Wb,Xb,jb,qb,Yb,Kb,Qb,Zb,Jb,$b,eS,tS,iS,nS,rS,aS,sS,oS,lS,cS,uS,hS,dS,fS,pS,_S,vS,mS,yS,gS,bS,SS,TS,ES,xS,AS,CS,wS,RS,kS,OS,FS,LS,BS,MS,IS,PS,DS,NS,zS,US,GS,VS,HS,WS,XS,jS,qS,YS,KS,QS,ZS,JS,$S,eT,tT,iT,nT,rT,aT,sT,oT,lT,cT,uT,hT,dT,fT,pT,_T,vT,mT,yT,gT,bT,ST,TT,ET=function(e){function c(e,t){var i;return y(this,c),(i=T(this,S(c).call(this,e,t))).updateJointData=i.updateJointDataDQS,i._skeleton=null,i._joints=[],i._jointsMedium=null,i._type="skinning",t.parent&&(i._transform=t.parent),i}return p(c,Bv),l(c,[{key:"joints",get:function(){return this._joints}}]),l(c,[{key:"bindSkeleton",value:function(e){if(this._destroyJointsMedium(),this._skeleton=e){var t=ub(this._device,e.joints.length),i=hb[t],n=t===ob.UNIFORM?Rf:kf,r=n.BLOCK.binding,a=this._device.createBuffer({usage:Jr.UNIFORM|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:n.SIZE,stride:n.SIZE}),s=Math.ceil(48/ls[i].size),o=e.joints.length,l=new Float32Array(s*o*4);if(this._jointsMedium={type:t,binding:r,buffer:a,nativeData:l},t!==ob.UNIFORM){var c=this._jointsMedium.texture=new Zc;c.reset({width:s,height:o,format:i}),c.setFilters(Ss.NEAREST,Ss.NEAREST),c.setWrapMode(gs.CLAMP_TO_EDGE,gs.CLAMP_TO_EDGE),yb[0]=1/s,yb[1]=1/o,a.update(yb,kf.JOINTS_TEXTURE_SIZE_INV_OFFSET,yb.byteLength)}}}},{key:"commitJointData",value:function(){if(this._jointsMedium){var e=this._jointsMedium,t=e.type,i=e.nativeData,n=e.buffer,r=e.texture;t===ob.UNIFORM?n.update(i,Rf.MAT_JOINT_OFFSET):r.uploadData(i.buffer)}}},{key:"updateUBOs",value:function(){if(!_(S(c.prototype),"updateUBOs",this).call(this)||!this._skeleton)return!1;var e=this._joints.length;if(this._skeleton.bindTRS.length)for(var t=0;t<e;++t){var i=this._joints[t];i.update();var n=this._skeleton.bindTRS[t];Oe.multiply(db,n.position,i.scale),Oe.transformQuat(db,db,i.rotation),Oe.add(db,db,i.position),De.multiply(vb,i.rotation,n.rotation),Oe.multiply(fb,i.scale,n.scale),this.updateJointData(t,db,vb,fb)}else for(var r=0;r<e;++r){var a=this._joints[r];a.update(),this.updateJointData(r,a.position,a.rotation,a.scale)}return this.commitJointData(),!0}},{key:"resetSkinningTarget",value:function(i){var n=this,r=$g(this.node,i);r&&this._skeleton&&(this._joints.length=0,this._skeleton.joints.forEach(function(e){var t=i.getChildByPath(e);t?n._joints.push(bb.get(t,r)):console.warn("Skinning target ".concat(e," not found in scene graph."))}))}},{key:"updateJointDataLBS",value:function(e,t,i,n){if(this._jointsMedium){var r=this._jointsMedium.nativeData,a=12*e;He.fromRTS(mb,i,t,n),r[a+0]=mb.m00,r[a+1]=mb.m01,r[a+2]=mb.m02,r[a+3]=mb.m12,r[a+4]=mb.m04,r[a+5]=mb.m05,r[a+6]=mb.m06,r[a+7]=mb.m13,r[a+8]=mb.m08,r[a+9]=mb.m09,r[a+10]=mb.m10,r[a+11]=mb.m14}}},{key:"updateJointDataDQS",value:function(e,t,i,n){if(this._jointsMedium){var r=this._jointsMedium.nativeData,a=12*e;0===e?De.copy(pb,i):De.dot(pb,i)<0&&De.scale(i,i,-1),De.set(_b,t.x,t.y,t.z,0),De.scale(_b,De.multiply(_b,_b,i),.5),r[a+0]=i.x,r[a+1]=i.y,r[a+2]=i.z,r[a+3]=i.w,r[a+4]=_b.x,r[a+5]=_b.y,r[a+6]=_b.z,r[a+7]=_b.w,r[a+8]=n.x,r[a+9]=n.y,r[a+10]=n.z}}},{key:"_doCreatePSO",value:function(e){var t=_(S(c.prototype),"_doCreatePSO",this).call(this,e);if(!this._jointsMedium)return t;var i=this._jointsMedium,n=i.type,r=i.buffer,a=i.binding,s=i.texture;if(t.pipelineLayout.layouts[0].bindBuffer(a,r),n!==ob.UNIFORM){var o=s.getGFXTextureView(),l=Is.getSampler(this._device,s.getGFXSamplerInfo());o&&l&&(t.pipelineLayout.layouts[0].bindTextureView(Of.binding,o),t.pipelineLayout.layouts[0].bindSampler(Of.binding,l))}return t}},{key:"_destroyJointsMedium",value:function(){if(this._jointsMedium){var e=this._jointsMedium,t=e.type,i=e.buffer,n=e.texture;i.destroy(),t!==ob.UNIFORM&&n.destroy(),this._jointsMedium=null}}}]),c}(),xT=hn,AT=(Sb=un("cc.RenderableComponent"),Tb=xT({type:[_m]}),Eb=xT({type:_m,displayName:"Materials"}),Sb((Cb=c((Ab=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_materials",Cb,d(d(e))),v(e,"_viewID",wb,d(d(e))),e}return p(t,Nh),l(t,[{key:"getMaterial",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=this._materials[e];if(!n)return null;var r=_m.getInstantiatedMaterial(n,this,t);return r!==this._materials[e]&&this.setMaterial(r,e,i||!t),this._materials[e]}},{key:"getSharedMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];this._materials[t]=e,i&&this._onMaterialModified(t,e)}},{key:"_getModel",value:function(){return null}},{key:"recreateModel",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisiblityChange",value:function(e){}},{key:"sharedMaterials",get:function(){return this._materials.slice()},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materials[e]=this.getMaterial(e);return this._materials},set:function(e){var t=e.length-this._materials.length;if(0<t)this._materials=this._materials.concat(new Array(t).fill(null));else if(t<0){for(var i=-t;i<this._materials.length;++i)this.setMaterial(null,i);this._materials=this._materials.splice(-t)}}},{key:"material",get:function(){return this.getMaterial(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterial(e,0)}},{key:"sharedMaterial",get:function(){return this.getSharedMaterial(0)}},{key:"visibility",get:function(){return this._viewID},set:function(e){this._viewID=e,this._onVisiblityChange(e)}}]),t}()).prototype,"_materials",[Tb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wb=c(Ab.prototype,"_viewID",[xT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(Ab.prototype,"sharedMaterials",[Eb],Object.getOwnPropertyDescriptor(Ab.prototype,"sharedMaterials"),Ab.prototype),c(Ab.prototype,"visibility",[xT],Object.getOwnPropertyDescriptor(Ab.prototype,"visibility"),Ab.prototype),xb=Ab))||xb),CT=ai({OFF:0,ON:1}),wT=(Rb=un("cc.ModelComponent"),kb=mn(100),Ob=vn("Components/ModelComponent"),Fb=hn({type:Em}),Lb=hn({type:CT}),Rb(Bb=kb(Bb=Ob(Bb=pn((zb=Nb=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._model=null,v(t,"_mesh",Ib,d(d(t))),v(t,"_shadowCastingMode",Pb,d(d(t))),v(t,"_receiveShadows",Db,d(d(t))),t}return p(a,AT),l(a,[{key:"onLoad",value:function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onEnable",value:function(){this._model&&(this._model.inited||this._updateModels(),this._model.enabled=!0)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"onDestroy",value:function(){this._model&&(this._getRenderScene().destroyModel(this._model),this._model=null)}},{key:"_getModel",value:function(){return this._model}},{key:"recreateModel",value:function(){this._model&&(this._model.destroy(),this._model.scene.destroyModel(this._model),this._model=null),this._updateModels()}},{key:"_updateModels",value:function(){this.enabledInHierarchy&&this._mesh&&(this._model&&this._model.inited?this._model.destroy():this._createModel(),this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._updateModelParams(),this._model&&(this._model.enabled=!0))}},{key:"_createModel",value:function(){if(this.node.scene){var e=this._getRenderScene();this._model=e.createModel(this._getModelConstructor(),this.node)}}},{key:"_getModelConstructor",value:function(){return Bv}},{key:"_updateModelParams",value:function(){if(this.node._hasChanged=!0,this._mesh&&this._model)for(var e=this._mesh?this._mesh.subMeshCount:0,t=0;t<e;++t){var i=this.getSharedMaterial(t),n=this._mesh.renderingMesh;if(n){var r=n.getSubmesh(t);r&&this._model.initSubModel(t,r,i||this._getBuiltinMaterial())}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(null!=this._model)for(var e=0;e<this._model.subModelNum;++e)this._onMaterialModified(e,null)}},{key:"_getBuiltinMaterial",value:function(){return Vv.get("missing-material")}},{key:"_onVisiblityChange",value:function(e){this._model&&(this._model.viewID=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===CT.OFF?this._model.castShadow=!1:this._shadowCastingMode===CT.ON?this._model.castShadow=!0:console.warn("ShadowCastingMode ".concat(this._shadowCastingMode," is not supported.")))}},{key:"_updateReceiveShadow",value:function(){this.enabledInHierarchy&&this._model}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._onMeshChanged(t),this._updateModels()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows=e,this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}}]),a}(),Nb.ShadowCastingMode=CT,c((Mb=zb).prototype,"mesh",[Fb],Object.getOwnPropertyDescriptor(Mb.prototype,"mesh"),Mb.prototype),c(Mb.prototype,"shadowCastingMode",[Lb],Object.getOwnPropertyDescriptor(Mb.prototype,"shadowCastingMode"),Mb.prototype),Ib=c(Mb.prototype,"_mesh",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pb=c(Mb.prototype,"_shadowCastingMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CT.OFF}}),Db=c(Mb.prototype,"_receiveShadows",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bb=Mb))||Bb)||Bb)||Bb)||Bb),RT=(Ub=un("cc.SkinningModelComponent"),Gb=mn(100),Vb=vn("Components/SkinningModelComponent"),Hb=hn({type:zm}),Wb=hn({type:bd}),Xb=hn(zm),jb=hn(bd),Ub(qb=Gb(qb=pn(qb=Vb((c((Yb=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_skeleton",Kb,d(d(t))),v(t,"_skinningRoot",Qb,d(d(t))),t}return p(a,wT),l(a,[{key:"_updateModelParams",value:function(){this._bindSkeleton(),this._resetSkinningTarget(),_(S(a.prototype),"_updateModelParams",this).call(this)}},{key:"_onMaterialModified",value:function(e,t){var i=ub(cc.director.root&&cc.director.root.device,this._skeleton&&this._skeleton.joints.length||0),n=this.getMaterial(e)||this._getBuiltinMaterial();n.recompileShaders({CC_USE_SKINNING:i}),_(S(a.prototype),"_onMaterialModified",this).call(this,e,n)}},{key:"_getModelConstructor",value:function(){return ET}},{key:"_getBuiltinMaterial",value:function(){return Vv.get("missing-skinning-material")}},{key:"_bindSkeleton",value:function(){var i=this;this._model&&this._model.bindSkeleton(this._skeleton),this._materials.forEach(function(e,t){return e&&i._onMaterialModified(t,e)})}},{key:"_resetSkinningTarget",value:function(){this._model&&this._skinningRoot&&this._model.resetSkinningTarget(this._skinningRoot)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){this._skeleton=e,this._bindSkeleton(),this._resetSkinningTarget()}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._resetSkinningTarget()}},{key:"model",get:function(){return this._model}}]),a}()).prototype,"skeleton",[Hb],Object.getOwnPropertyDescriptor(Yb.prototype,"skeleton"),Yb.prototype),c(Yb.prototype,"skinningRoot",[Wb],Object.getOwnPropertyDescriptor(Yb.prototype,"skinningRoot"),Yb.prototype),Kb=c(Yb.prototype,"_skeleton",[Xb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qb=c(Yb.prototype,"_skinningRoot",[jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qb=Yb))||qb)||qb)||qb)||qb),kT=new Lr,OT=(Zb=un("cc.AvatarUnit"),Jb=hn(Em),$b=hn(zm),eS=hn(bd),tS=hn(Zc),iS=hn({type:Zc}),nS=hn({type:RT}),Zb((sS=c((aS=function(){function e(){y(this,e),v(this,"mesh",sS,this),v(this,"skeleton",oS,this),v(this,"skinningRoot",lS,this),v(this,"_offset",cS,this),v(this,"_atlasSize",uS,this),v(this,"_albedoMap",hS,this)}return l(e,[{key:"atlasSize",set:function(e){we.copy(this._atlasSize,e)},get:function(){return this._atlasSize}},{key:"offset",set:function(e){we.copy(this._offset,e)},get:function(){return this._offset}},{key:"albedoMap",get:function(){return this._albedoMap},set:function(e){this._albedoMap!==e&&(this._albedoMap=e,this._albedoMap&&(kT.x=this._albedoMap.width,kT.y=this._albedoMap.height,this.atlasSize=kT))}},{key:"source",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.skinningRoot=e.skinningRoot)},get:function(){return null}}]),e}()).prototype,"mesh",[Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oS=c(aS.prototype,"skeleton",[$b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lS=c(aS.prototype,"skinningRoot",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cS=c(aS.prototype,"_offset",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(0,0)}}),uS=c(aS.prototype,"_atlasSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(256,256)}}),hS=c(aS.prototype,"_albedoMap",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(aS.prototype,"atlasSize",[hn],Object.getOwnPropertyDescriptor(aS.prototype,"atlasSize"),aS.prototype),c(aS.prototype,"offset",[hn],Object.getOwnPropertyDescriptor(aS.prototype,"offset"),aS.prototype),c(aS.prototype,"albedoMap",[iS],Object.getOwnPropertyDescriptor(aS.prototype,"albedoMap"),aS.prototype),c(aS.prototype,"source",[nS],Object.getOwnPropertyDescriptor(aS.prototype,"source"),aS.prototype),rS=aS))||rS),FT=function(e,t){for(var i="",n=t;n&&n!==e;)i="".concat(n.name,"/")+i,n=n.parent;return i},LT=function(e,t){return t?e+t:e.slice(0,-1)},BT=(dS=un("cc.AvatarModelComponent"),fS=mn(100),pS=vn("Components/AvatarModelComponent"),_S=hn({override:!0,visible:!1}),vS=hn({override:!0,visible:!1}),mS=hn({override:!0,visible:!1}),yS=hn({type:_i}),gS=hn({type:yi}),bS=hn({type:[OT]}),dS(SS=fS(SS=pn(SS=pS((ES=c((TS=function(e){function g(){var e,t;y(this,g);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(g)).call.apply(e,[this].concat(n))),"_combinedTexSize",ES,d(d(t))),t._combinedTex=null,v(t,"_albedoMapName",xS,d(d(t))),v(t,"_avatarUnits",AS,d(d(t))),t}return p(g,RT),l(g,[{key:"onLoad",value:function(){_(S(g.prototype),"onLoad",this).call(this),this._combinedTex=new Zc,this._combinedTex.onLoaded(),this._combinedTex.setFilters(Ss.LINEAR,Ss.LINEAR),this.resizeCombinedTexture(),this.combine()}},{key:"onDestroy",value:function(){this._combinedTex&&(this._combinedTex.destroy(),this._combinedTex=null),this._mesh&&(this._mesh.destroy(),this._mesh=null)}},{key:"addAvatarUnit",value:function(e){this._avatarUnits.push(e)}},{key:"clear",value:function(){this._mesh&&this._mesh.destroy()}},{key:"bindTextures",value:function(){if(0<this._albedoMapName.length&&0<this._materials.length){var e=this.material;e&&e.setProperty(this._albedoMapName,this._combinedTex)}}},{key:"combine",value:function(){this.combineTextures(),this.combineSkeletons(),this.combineMeshes(),this.bindTextures()}},{key:"combineTextures",value:function(){var e=!1,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.albedoMap){e=!0;break}}if(e){var a=[],s=[],o=[],l=[],c=this._avatarUnits,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;if(f){var p=f.offset;if((e=0<=p.x&&0<=p.y)&&f.albedoMap&&f.albedoMap.image&&f.albedoMap.image.data){var _=new os;_.texOffset.x=p.x,_.texOffset.y=p.y,_.texExtent.width=f.albedoMap.image.width,_.texExtent.height=f.albedoMap.image.height;var v=f.albedoMap.image.data;v instanceof HTMLCanvasElement||v instanceof HTMLImageElement?(a.push(v),s.push(_)):(o.push(v.buffer),l.push(_))}}}var m=this._combinedTex.getGFXTexture(),y=cc.director.root.device;0<o.length&&y.copyBuffersToTexture(o,m,l),0<a.length&&y.copyTexImagesToTexture(a,m,s)}}},{key:"combineSkeletons",value:function(){var e=null,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a&&a.skinningRoot){var s=a.skinningRoot;e=e?$g(e,s):s}}if(this._skinningRoot=e){var o=new zm,l=[],c=this._avatarUnits,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;if(f&&f.skeleton&&f.skinningRoot)for(var p=f.skeleton,_=FT(e,f.skinningRoot),v=function(e){var t=LT(_,p.joints[e]);if(0<=o.joints.findIndex(function(e){return e===t}))return"continue";o.joints.push(t),l.push(p.bindposes[e]||new Dr)},m=0;m<p.joints.length;m++)v(m)}var y=E(Array(o.joints.length).keys()).sort(function(e,t){return o.joints[e]>o.joints[t]?1:o.joints[e]<o.joints[t]?-1:0});o.joints=o.joints.map(function(e,t,i){return i[y[t]]}),o.bindposes=l.map(function(e,t,i){return i[y[t]]}),b(S(g.prototype),"skeleton",o,this,!0)}else console.warn("illegal skinning roots")}},{key:"combineMeshes",value:function(){var g=this,e=!1,t=this._avatarUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Em,e&&this._skinningRoot){for(var b,S=0,T=Kt.GFXFormat.UNKNOWN,E=0,x=Kt.GFXFormat.UNKNOWN,A=new Array(this._avatarUnits.length),a=this._avatarUnits.length,s=function(e){var t=g._avatarUnits[e];if(!t||!t.skeleton||!t.skinningRoot)return"continue";var i=FT(g._skinningRoot,t.skinningRoot);A[e]=t.skeleton.joints.map(function(e){var t=LT(i,e);return g._skeleton.joints.findIndex(function(e){return t===e})})},o=0;o<a;o++)s(o);var l=function(d){var f=g._avatarUnits[d];if(!f||!f.mesh||!f.mesh.data)return"continue";var p=f.offset,e=f.mesh.data.slice(),t=new Em;t.reset({struct:f.mesh.struct,data:e}),b=new DataView(e.buffer);var i=function(){if(v){if(m>=_.length)return"break";y=_[m++]}else{if((m=_.next()).done)return"break";y=m.value}var e=y;S=e.view.offset,T=Kt.GFXFormat.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(0<=a.name.indexOf(Kt.GFXAttributeName.ATTR_TEX_COORD)){T=a.format;break}S+=ls[a.format].size}T&&Zg(b,function(e,t){var i,n=0===t?"x":"y";return((e=(i=e)-Math.floor(i))*f.atlasSize[n]+p[n])/g._combinedTexSize},T,S,e.view.length,e.view.stride,b);var s=A[d];if(!s)return"continue";E=e.view.offset,x=Kt.GFXFormat.UNKNOWN;var o=e.attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===Kt.GFXAttributeName.ATTR_JOINTS){x=h.format;break}E+=ls[h.format].size}x&&Zg(b,function(e){return s[e]},x,E,e.view.length,e.view.stride,b)};var _=f.mesh.struct.vertexBundles,v=Array.isArray(_),m=0;e:for(_=v?_:_[Symbol.iterator]();;){var y;switch(i()){case"break":break e;case"continue":continue}}g._mesh.merge(t)};for(o=0;o<a;o++)l(o);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"resizeCombinedTexture",value:function(){this._combinedTex&&(this._combinedTex.destroy(),this._combinedTex.reset({width:this._combinedTexSize,height:this._combinedTexSize,format:ms.RGBA8888}))}},{key:"mesh",get:function(){return this._mesh}},{key:"skeleton",get:function(){return this._skeleton}},{key:"skinningRoot",get:function(){return this._skinningRoot}},{key:"combinedTexSize",get:function(){return this._combinedTexSize},set:function(e){this._combinedTexSize=e}},{key:"albedoMapName",get:function(){return this._albedoMapName},set:function(e){this._albedoMapName!==e&&(this._albedoMapName=e)}},{key:"avatarUnits",get:function(){return this._avatarUnits},set:function(e){this._avatarUnits=e}}]),g}()).prototype,"_combinedTexSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),xS=c(TS.prototype,"_albedoMapName",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AS=c(TS.prototype,"_avatarUnits",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(TS.prototype,"mesh",[_S],Object.getOwnPropertyDescriptor(TS.prototype,"mesh"),TS.prototype),c(TS.prototype,"skeleton",[vS],Object.getOwnPropertyDescriptor(TS.prototype,"skeleton"),TS.prototype),c(TS.prototype,"skinningRoot",[mS],Object.getOwnPropertyDescriptor(TS.prototype,"skinningRoot"),TS.prototype),c(TS.prototype,"combinedTexSize",[yS],Object.getOwnPropertyDescriptor(TS.prototype,"combinedTexSize"),TS.prototype),c(TS.prototype,"albedoMapName",[gS],Object.getOwnPropertyDescriptor(TS.prototype,"albedoMapName"),TS.prototype),c(TS.prototype,"avatarUnits",[bS],Object.getOwnPropertyDescriptor(TS.prototype,"avatarUnits"),TS.prototype),SS=TS))||SS)||SS)||SS)||SS),MT={name:Kt.GFXAttributeName.ATTR_BATCH_ID,format:Kt.GFXFormat.R32F,isNormalized:!1},IT={name:Kt.GFXAttributeName.ATTR_BATCH_UV,format:Kt.GFXFormat.RG32F,isNormalized:!1},PT=ls[MT.format].size+ls[IT.format].size,DT=(CS=un("cc.SkinningModelUnit"),wS=hn(Em),RS=hn(zm),kS=hn(bd),OS=hn(_m),FS=hn({type:RT}),CS((MS=c((BS=function(){function e(){y(this,e),v(this,"mesh",MS,this),v(this,"skeleton",IS,this),v(this,"skinningRoot",PS,this),v(this,"material",DS,this),v(this,"_offset",NS,this),v(this,"_size",zS,this)}return l(e,[{key:"offset",set:function(e){we.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){we.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.skinningRoot=e.skinningRoot,this.material=e.getSharedMaterial(0))},get:function(){return null}}]),e}()).prototype,"mesh",[wS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IS=c(BS.prototype,"skeleton",[RS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PS=c(BS.prototype,"skinningRoot",[kS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DS=c(BS.prototype,"material",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NS=c(BS.prototype,"_offset",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(0,0)}}),zS=c(BS.prototype,"_size",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(1,1)}}),c(BS.prototype,"offset",[hn],Object.getOwnPropertyDescriptor(BS.prototype,"offset"),BS.prototype),c(BS.prototype,"size",[hn],Object.getOwnPropertyDescriptor(BS.prototype,"size"),BS.prototype),c(BS.prototype,"copyFrom",[FS],Object.getOwnPropertyDescriptor(BS.prototype,"copyFrom"),BS.prototype),LS=BS))||LS),NT=function(e,t){for(var i="",n=t;n&&n!==e;)i="".concat(n.name,"/")+i,n=n.parent;return i},zT=function(e,t){return t?e+t:e.slice(0,-1)},UT=(US=un("cc.BatchedSkinningModelComponent"),GS=mn(100),VS=vn("Components/BatchedSkinningModelComponent"),HS=hn({type:[yi]}),WS=hn({type:[DT]}),XS=hn({override:!0,visible:!1}),jS=hn({override:!0,visible:!1}),qS=hn({override:!0,visible:!1}),US(YS=GS(YS=pn(YS=VS((QS=c((KS=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"atlasSize",QS,d(d(t))),v(t,"batchableTextureNames",ZS,d(d(t))),v(t,"units",JS,d(d(t))),t._textures={},t._batchMaterial=null,t}return p(a,RT),l(a,[{key:"onLoad",value:function(){_(S(a.prototype),"onLoad",this).call(this),this._batchMaterial=this.getSharedMaterial(0),this.cook()}},{key:"onDestroy",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].destroy()}this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),_(S(a.prototype),"onDestroy",this).call(this)}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var d=this,f=this.getMaterial(0);if(f&&this._batchMaterial&&f.effectAsset){f.copy(this._batchMaterial),this.resizeAtlases();for(var t=f.effectAsset.techniques[f.technique],e=function(l){var c=t.passes[l];if(!c.properties)return"continue";for(var e=function(){var t=h[u];if(c.properties[t].type>=Kr.SAMPLER1D){var i=null;d.batchableTextureNames.find(function(e){return e===t})?((i=d._textures[t])||(i=d.createTexture(t)),d.cookTextures(i,t,l)):d.units.some(function(e){return i=e.material&&e.material.getProperty(t,l)}),i&&f.setProperty(t,i,l)}else{var e=[],n=d.units,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.material&&e.push(o.material.getProperty(t.slice(0,-3),l))}f.setProperty(t,e,l)}},u=0,h=Object.keys(c.properties);u<h.length;u++)e()},i=0;i<t.passes.length;i++)e(i)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){var e=null,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a&&a.skinningRoot){var s=a.skinningRoot;e=e?$g(e,s):s}}if(this._skinningRoot=e){var o=new zm,l=[],c=this.units,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;if(f&&f.skeleton&&f.skinningRoot)for(var p=f.skeleton,_=NT(e,f.skinningRoot),v=function(e){var t=zT(_,p.joints[e]);if(0<=o.joints.findIndex(function(e){return e===t}))return"continue";o.joints.push(t),l.push(p.bindposes[e]||new Dr)},m=0;m<p.joints.length;m++)v(m)}var y=E(Array(o.joints.length).keys()).sort(function(e,t){return o.joints[e]>o.joints[t]?1:o.joints[e]<o.joints[t]?-1:0});o.joints=o.joints.map(function(e,t,i){return i[y[t]]}),o.bindposes=l.map(function(e,t,i){return i[y[t]]}),this.skeleton=o}else console.warn("illegal skinning roots")}},{key:"cookMeshes",value:function(){var W=this,e=!1,t=this.units,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}if(r.mesh){e=!0;break}}if(this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Em,e&&this._skinningRoot){for(var X,j=0,q=Kt.GFXFormat.UNKNOWN,Y=0,K=Kt.GFXFormat.UNKNOWN,Q=new Array(this.units.length),a=this.units.length,s=function(e){var t=W.units[e];if(!t||!t.skeleton||!t.skinningRoot)return"continue";var i=NT(W._skinningRoot,t.skinningRoot);Q[e]=t.skeleton.joints.map(function(e){var t=zT(i,e);return W._skeleton.joints.findIndex(function(e){return t===e})})},o=0;o<a;o++)s(o);var l=function(d){var e=W.units[d];if(!e||!e.mesh||!e.mesh.data)return"continue";var t=JSON.parse(JSON.stringify(e.mesh.struct)),i=0,n=t.vertexBundles,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.attributes.push(MT),o.attributes.push(IT),o.view.offset=i,o.view.length+=o.view.count*PT,o.view.stride+=PT,i+=o.view.length}var l=t.primitives,c=Array.isArray(l),u=0;for(l=c?l:l[Symbol.iterator]();;){var h;if(c){if(u>=l.length)break;h=l[u++]}else{if((u=l.next()).done)break;h=u.value}var f=h;f.indexView&&(f.indexView.offset=i,i+=f.indexView.length),f.geometricInfo&&(i=4*Math.ceil(i/4),f.geometricInfo.view.offset=i,i+=f.geometricInfo.view.length)}var p=e.mesh.data,_=0,v=new Uint8Array(i);X=new DataView(v.buffer);for(var m=0;m<t.vertexBundles.length;m++){var y=e.mesh.readAttribute(m,Kt.GFXAttributeName.ATTR_TEX_COORD),g=e.mesh.struct.vertexBundles[m].view,b=t.vertexBundles[m].view,S=g.stride,T=b.stride;_=g.offset,i=b.offset;for(var E=0;E<b.count;E++){var x=p.subarray(_,_+S);v.set(x,i),X.setFloat32(i+S,d,cc.sys.isLittleEndian),X.setFloat32(i+S+4,y[2*E],cc.sys.isLittleEndian),X.setFloat32(i+S+8,y[2*E+1],cc.sys.isLittleEndian),i+=T,_+=S}}for(var A=0;A<t.primitives.length;A++){var C=e.mesh.struct.primitives[A],w=t.primitives[A];if(C.indexView&&w.indexView){var R=C.indexView.stride,k=w.indexView.stride;_=C.indexView.offset,i=w.indexView.offset;for(var O=0;O<w.indexView.count;O++){var F=p.subarray(_,_+R);v.set(F,i),i+=k,_+=R}}if(C.geometricInfo&&w.geometricInfo){var L=C.geometricInfo.view.stride,B=w.geometricInfo.view.stride;_=C.geometricInfo.view.offset,i=w.geometricInfo.view.offset;for(var M=0;M<w.geometricInfo.view.count;M++){var I=p.subarray(_,_+L);v.set(I,i),i+=B,_+=L}}}var P=new Em;P.reset({struct:t,data:v});var D=e.offset,N=e.size,z=function(){if(G){if(V>=U.length)return"break";H=U[V++]}else{if((V=U.next()).done)return"break";H=V.value}var e=H;j=e.view.offset,q=Kt.GFXFormat.UNKNOWN;var t=e.attributes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===Kt.GFXAttributeName.ATTR_BATCH_UV){q=a.format;break}j+=ls[a.format].size}q&&Zg(X,function(e,t){var i,n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*N[n]+D[n]},q,j,e.view.length,e.view.stride,X);var s=Q[d];if(!s)return"continue";Y=e.view.offset,K=Kt.GFXFormat.UNKNOWN;var o=e.attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===Kt.GFXAttributeName.ATTR_JOINTS){K=h.format;break}Y+=ls[h.format].size}K&&Zg(X,function(e){return s[e]},K,Y,e.view.length,e.view.stride,X)};var U=t.vertexBundles,G=Array.isArray(U),V=0;e:for(U=G?U:U[Symbol.iterator]();;){var H;switch(z()){case"break":break e;case"continue":continue}}W._mesh.merge(P)};for(o=0;o<a;o++)l(o);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){var n=[],r=[],a=[],s=[],o=this.units,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.material){var d=h.material.getProperty(t,i);if(d&&d.image&&d.image.data){var f=new os;f.texOffset.x=h.offset.x*this.atlasSize,f.texOffset.y=h.offset.y*this.atlasSize,f.texExtent.width=h.size.x*this.atlasSize,f.texExtent.height=h.size.y*this.atlasSize;var p=d.image.data;p instanceof HTMLCanvasElement||p instanceof HTMLImageElement?(n.push(p),r.push(f)):(a.push(p.buffer),s.push(f))}}}var _=e.getGFXTexture(),v=cc.director.root.device;0<a.length&&v.copyBuffersToTexture(a,_,s),0<n.length&&v.copyTexImagesToTexture(n,_,r)}},{key:"createTexture",value:function(e){var t=new Zc;return t.setFilters(Ss.LINEAR,Ss.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:ms.RGBA8888}),t.loaded=!0,this._textures[e]=t}},{key:"resizeAtlases",value:function(){for(var e=0,t=Object.keys(this._textures);e<t.length;e++){var i=t[e];this._textures[i].reset({width:this.atlasSize,height:this.atlasSize,format:ms.RGBA8888})}}},{key:"mesh",get:function(){return this._mesh},set:function(e){b(S(a.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return this._skeleton},set:function(e){b(S(a.prototype),"skeleton",e,this,!0)}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){b(S(a.prototype),"skinningRoot",e,this,!0)}}]),a}()).prototype,"atlasSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),ZS=c(KS.prototype,"batchableTextureNames",[HS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JS=c(KS.prototype,"units",[WS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(KS.prototype,"mesh",[XS],Object.getOwnPropertyDescriptor(KS.prototype,"mesh"),KS.prototype),c(KS.prototype,"skeleton",[jS],Object.getOwnPropertyDescriptor(KS.prototype,"skeleton"),KS.prototype),c(KS.prototype,"skinningRoot",[qS],Object.getOwnPropertyDescriptor(KS.prototype,"skinningRoot"),KS.prototype),YS=KS))||YS)||YS)||YS)||YS),GT=ai({ORTHO:0,PERSPECTIVE:1}),VT=ai({SOLID_COLOR:ts.ALL,DEPTH_ONLY:ts.DEPTH_STENCIL,DONT_CLEAR:ts.NONE}),HT=je.create(),WT=($S=un("cc.CameraComponent"),eT=vn("Components/CameraComponent"),tT=hn({type:GT}),iT=hn({type:VT}),$S(nT=eT(nT=pn((bT=gT=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_projection",aT,d(d(e))),v(e,"_priority",sT,d(d(e))),v(e,"_fov",oT,d(d(e))),v(e,"_orthoHeight",lT,d(d(e))),v(e,"_near",cT,d(d(e))),v(e,"_far",uT,d(d(e))),v(e,"_color",hT,d(d(e))),v(e,"_depth",dT,d(d(e))),v(e,"_stencil",fT,d(d(e))),v(e,"_clearFlags",pT,d(d(e))),v(e,"_rect",_T,d(d(e))),v(e,"_screenScale",vT,d(d(e))),v(e,"_targetDisplay",mT,d(d(e))),v(e,"_visibility",yT,d(d(e))),e._camera=null,e}return p(t,Nh),l(t,[{key:"onLoad",value:function(){cc.director.on(cc.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this)}},{key:"onEnable",value:function(){this._camera||this._createCamera(),this._camera.enabled=!0}},{key:"onDisable",value:function(){this._camera&&(this._camera.enabled=!1)}},{key:"onDestroy",value:function(){this._camera&&(this._getRenderScene().destroyCamera(this._camera),this._camera=null)}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=O_.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new Br),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"_createCamera",value:function(){var t=this;if(this.node.scene){var e=this._getRenderScene();this._camera&&e.cameras.find(function(e){return e===t._camera})||(this._camera=e.createCamera({name:this.node.name,node:this.node,projection:this._projection,targetDisplay:this._targetDisplay,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fov=he(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=je.create(this._color.r/255,this._color.g/255,this._color.b/255,this._color.a/255),this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags)}}},{key:"onSceneChanged",value:function(e){this._camera&&this._camera.scene!==e.renderScene&&(this._createCamera(),this._camera.enabled=!0)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=he(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(je.set(HT,e.r/255,e.g/255,e.b/255,e.a/255),this._camera.clearColor=HT)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"stencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"targetDisplay",get:function(){return this._targetDisplay},set:function(e){this._targetDisplay=e,this._camera&&this._camera.changeTargetDisplay(e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}}]),t}(),gT.ProjectionType=GT,aT=c((rT=bT).prototype,"_projection",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GT.PERSPECTIVE}}),sT=c(rT.prototype,"_priority",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oT=c(rT.prototype,"_fov",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),lT=c(rT.prototype,"_orthoHeight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),cT=c(rT.prototype,"_near",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),uT=c(rT.prototype,"_far",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),hT=c(rT.prototype,"_color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return(new Hr).fromHEX("#334C78")}}),dT=c(rT.prototype,"_depth",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fT=c(rT.prototype,"_stencil",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pT=c(rT.prototype,"_clearFlags",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VT.SOLID_COLOR}}),_T=c(rT.prototype,"_rect",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ur(0,0,1,1)}}),vT=c(rT.prototype,"_screenScale",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mT=c(rT.prototype,"_targetDisplay",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yT=c(rT.prototype,"_visibility",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(rT.prototype,"projection",[tT],Object.getOwnPropertyDescriptor(rT.prototype,"projection"),rT.prototype),c(rT.prototype,"priority",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"priority"),rT.prototype),c(rT.prototype,"fov",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"fov"),rT.prototype),c(rT.prototype,"orthoHeight",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"orthoHeight"),rT.prototype),c(rT.prototype,"near",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"near"),rT.prototype),c(rT.prototype,"far",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"far"),rT.prototype),c(rT.prototype,"color",[hn,Xu],Object.getOwnPropertyDescriptor(rT.prototype,"color"),rT.prototype),c(rT.prototype,"depth",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"depth"),rT.prototype),c(rT.prototype,"stencil",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"stencil"),rT.prototype),c(rT.prototype,"clearFlags",[iT],Object.getOwnPropertyDescriptor(rT.prototype,"clearFlags"),rT.prototype),c(rT.prototype,"rect",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"rect"),rT.prototype),c(rT.prototype,"screenScale",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"screenScale"),rT.prototype),c(rT.prototype,"targetDisplay",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"targetDisplay"),rT.prototype),c(rT.prototype,"visibility",[hn],Object.getOwnPropertyDescriptor(rT.prototype,"visibility"),rT.prototype),nT=rT))||nT)||nT)||nT);(TT=ST||(ST={}))[TT.DIRECTIONAL=0]="DIRECTIONAL",TT[TT.SPHERE=1]="SPHERE",TT[TT.SPOT=2]="SPOT",TT[TT.UNKNOWN=3]="UNKNOWN";var XT,jT,qT,YT,KT,QT,ZT,JT,$T,eE,tE,iE,nE,rE,aE,sE,oE,lE,cE=function(e){return 4*Math.PI*Math.PI*e*e},uE=function(){function n(e,t,i){y(this,n),this._enabled=!0,this._color=new Br(1,1,1),this._useColorTemp=!1,this._colorTemp=6550,this._colorTempRGB=new Br(1,1,1),this._scene=void 0,this._node=void 0,this._type=void 0,this._name=void 0,this._scene=e,this._name=t,this._type=ST.UNKNOWN,this._node=i}return l(n,[{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"color",set:function(e){this._color.set(e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){this._useColorTemp=e},get:function(){return this._useColorTemp}},{key:"colorTemperature",set:function(e){this._colorTemp=e,function(e,t){t<1e3?t=1e3:15e3<t&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,s=3*n/a,o=2*r/a,l=1/o*s,c=1/o*(1-s-o);e.x=3.2404542*l-1.5371385+-.4985314*c,e.y=-.969266*l+1.8760108+.041556*c,e.z=.0556434*l-.2040259+1.0572252*c}(this._colorTempRGB,this._colorTemp)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name}}]),l(n,[{key:"update",value:function(){}}]),n}(),hE=ai({LUMINOUS_POWER:0,LUMINANCE:1}),dE=(XT=un("cc.LightComponent"),jT=hn({slide:!0,range:[1e3,15e3,1]}),XT(($T=JT=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_color",KT,d(d(t))),v(t,"_useColorTemperature",QT,d(d(t))),v(t,"_colorTemperature",ZT,d(d(t))),t._type=ST.UNKNOWN,t._light=null,t}return p(a,Nh),l(a,[{key:"onEnable",value:function(){this._light?this._light.enabled=!0:this._createLight()}},{key:"onDisable",value:function(){this._light&&(this._light.enabled=!1)}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(e){this._light&&(this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.enabled=this.enabledInHierarchy)}},{key:"_destroyLight",value:function(e){this._light=null}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"type",get:function(){return this._type}}]),a}(),JT.Type=ST,JT.PhotometricTerm=hE,KT=c((YT=$T).prototype,"_color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.WHITE}}),QT=c(YT.prototype,"_useColorTemperature",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZT=c(YT.prototype,"_colorTemperature",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),c(YT.prototype,"color",[hn,Xu],Object.getOwnPropertyDescriptor(YT.prototype,"color"),YT.prototype),c(YT.prototype,"useColorTemperature",[hn],Object.getOwnPropertyDescriptor(YT.prototype,"useColorTemperature"),YT.prototype),c(YT.prototype,"colorTemperature",[jT],Object.getOwnPropertyDescriptor(YT.prototype,"colorTemperature"),YT.prototype),qT=YT))||qT),fE=(eE=un("cc.DirectionalLightComponent"),tE=vn("Components/DirectionalLightComponent"),iE=hn({unit:"lx"}),eE(nE=tE(nE=pn((aE=c((rE=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_illuminance",aE,d(d(t))),t._type=ST.DIRECTIONAL,t._light=null,t}return p(a,dE),l(a,[{key:"_createLight",value:function(e){this.node.scene&&(e||(e=this._getRenderScene()),e.mainLight.node.activeInHierarchy?console.warn("there can be only one directional(main) light."):(this._light=e.mainLight,this.illuminance=this._illuminance,_(S(a.prototype),"_createLight",this).call(this,e)))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(this._light.enabled=!1,e||(e=this._getRenderScene()),this._light.node=e.defaultMainLightNode,_(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),a}()).prototype,"_illuminance",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),c(rE.prototype,"illuminance",[iE],Object.getOwnPropertyDescriptor(rE.prototype,"illuminance"),rE.prototype),nE=rE))||nE)||nE)||nE),pE=un("cc.EditorCameraComponent")(sE=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._uiEditorCamera=null,t}return p(a,WT),l(a,[{key:"onLoad",value:function(){_(S(a.prototype),"onLoad",this).call(this)}},{key:"onEnable",value:function(){_(S(a.prototype),"onEnable",this).call(this)}},{key:"onDisable",value:function(){_(S(a.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){_(S(a.prototype),"onDestroy",this).call(this),this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null)}},{key:"_createCamera",value:function(){var e=this._camera;_(S(a.prototype),"_createCamera",this).call(this),this._camera!==e&&this._camera&&(this._uiEditorCamera&&(cc.director.root.ui.renderScene.destroyCamera(this._uiEditorCamera),this._uiEditorCamera=null),this._uiEditorCamera=cc.director.root.ui.renderScene.createCamera({name:"Editor UICamera",node:this._camera.node,projection:this._projection,targetDisplay:this._targetDisplay,priority:this._priority,isUI:!0,flows:["UIFlow"]}),this._uiEditorCamera.viewport=this._camera.viewport,this._uiEditorCamera.fov=this._camera.fov,this._uiEditorCamera.nearClip=this._camera.nearClip,this._uiEditorCamera.farClip=this._camera.farClip,this._uiEditorCamera.clearColor=this._camera.clearColor,this._uiEditorCamera.clearDepth=this._camera.clearDepth,this._uiEditorCamera.clearStencil=this._camera.clearStencil,this._uiEditorCamera.clearFlag=this._camera.clearFlag)}},{key:"projection",set:function(e){b(S(a.prototype),"projection",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.projectionType=e)}},{key:"fov",set:function(e){b(S(a.prototype),"fov",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.fov=he(e))}},{key:"orthoHeight",set:function(e){b(S(a.prototype),"orthoHeight",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.orthoHeight=e)}},{key:"near",set:function(e){b(S(a.prototype),"near",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.nearClip=e)}},{key:"far",set:function(e){b(S(a.prototype),"far",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.farClip=e)}},{key:"color",set:function(e){b(S(a.prototype),"color",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearColor=je.create(e.r/255,e.g/255,e.b/255,e.a/255))}},{key:"depth",set:function(e){b(S(a.prototype),"depth",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearDepth=e)}},{key:"stencil",set:function(e){b(S(a.prototype),"stencil",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearStencil=e)}},{key:"clearFlags",set:function(e){b(S(a.prototype),"clearFlags",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.clearFlag=e)}},{key:"rect",set:function(e){b(S(a.prototype),"rect",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.viewport=e)}},{key:"screenScale",set:function(e){b(S(a.prototype),"screenScale",e,this,!0),this._uiEditorCamera&&(this._uiEditorCamera.screenScale=e)}},{key:"targetDisplay",set:function(e){b(S(a.prototype),"targetDisplay",e,this,!0),this._uiEditorCamera&&this._uiEditorCamera.changeTargetDisplay(e)}}]),a}())||sE,_E=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.BUFFER)))._device=void 0,t._usage=Jr.NONE,t._memUsage=ea.NONE,t._size=0,t._stride=1,t._count=0,t._device=e,t}return p(i,ns),l(i,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}}]),i}(),vE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.COMMAND_BUFFER)))._device=void 0,t._allocator=null,t._type=za.PRIMARY,t._numDrawCalls=0,t._numTris=0,t._device=e,t}return p(i,ns),l(i,[{key:"type",get:function(){return this._type}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numTris",get:function(){return this._numTris}}]),i}(),mE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.FRAMEBUFFER)))._device=void 0,t._renderPass=null,t._colorViews=[],t._depthStencilView=null,t._isOffscreen=!0,t._device=e,t}return p(i,ns),l(i,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorViews",get:function(){return this._colorViews}},{key:"depthStencilView",get:function(){return this._depthStencilView}},{key:"isOffscreen",get:function(){return this._isOffscreen}}]),i}(),yE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.INPUT_ASSEMBLER)))._device=void 0,t._attributes=[],t._vertexBuffers=[],t._indexBuffer=null,t._vertexCount=0,t._firstVertex=0,t._indexCount=0,t._firstIndex=0,t._vertexOffset=0,t._instanceCount=0,t._firstInstance=0,t._isIndirect=!1,t._indirectBuffer=null,t._device=e,t}return p(i,ns),l(i,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"isIndirect",get:function(){return this._isIndirect}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),l(i,[{key:"getVertexBuffer",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"extractDrawInfo",value:function(e){e.vertexCount=this._vertexCount,e.firstVertex=this._firstVertex,e.indexCount=this._indexCount,e.firstIndex=this._firstIndex,e.vertexOffset=this._vertexOffset,e.instanceCount=this._instanceCount,e.firstInstance=this._firstInstance}},{key:"updateVertexAttr",value:function(e,t,i){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,r=!(4<arguments.length&&void 0!==arguments[4])||arguments[4],a=0,s=Kt.GFXFormat.UNKNOWN,o=this._attributes,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;if(h.name===t){s=h.format;break}a+=ls[h.format].size}var d=this._vertexBuffers[n];s&&d&&(Kg(new DataView(e),i,s,a,d.stride),r&&d.update(e,0,d.stride*d.count))}},{key:"updateIndexBuffer",value:function(e,t){var i=this._indexCount,n=this._indexBuffer;i&&n&&(Kg(new DataView(e),t,Kt.GFXFormat["R".concat(8*n.stride,"UI")]),n.update(e,0,n.stride*n.count),this._indexCount=t.length)}}]),i}(),gE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.PIPELINE_LAYOUT)))._device=void 0,t._pushConstantsRanges=[],t._layouts=[],t._device=e,t}return p(i,ns),l(i,[{key:"layouts",get:function(){return this._layouts}}]),i}(),bE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.QUEUE)))._device=void 0,t._type=$a.GRAPHICS,t._device=e,t}return p(i,ns),l(i,[{key:"type",get:function(){return this._type}}]),i}(),SE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.RENDER_PASS)))._device=void 0,t._colorInfos=[],t._depthStencilInfo=null,t._device=e,t}return p(i,ns),i}(),TE=function(){function e(){y(this,e),this.name="",this.minFilter=Sa.LINEAR,this.magFilter=Sa.LINEAR,this.mipFilter=Sa.NONE,this.addressU=Ea.WRAP,this.addressV=Ea.WRAP,this.addressW=Ea.WRAP,this.maxAnisotropy=16,this.cmpFunc=ha.NEVER,this.borderColor={r:0,g:0,b:0,a:0},this.minLOD=0,this.maxLOD=0,this.mipLODBias=0}return l(e,[{key:"compare",value:function(e){return this.minFilter===e.minFilter&&this.magFilter===e.magFilter&&this.mipFilter===e.mipFilter&&this.addressU===e.addressU&&this.addressV===e.addressV&&this.addressW===e.addressW&&this.maxAnisotropy===e.maxAnisotropy&&this.cmpFunc===e.cmpFunc&&this.borderColor.r===e.borderColor.r&&this.borderColor.g===e.borderColor.g&&this.borderColor.b===e.borderColor.b&&this.borderColor.a===e.borderColor.a&&this.minLOD===e.minLOD&&this.maxLOD===e.maxLOD&&this.mipLODBias===e.mipLODBias}}]),e}(),EE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.SAMPLER)))._device=void 0,t._state=new TE,t._device=e,t}return p(i,ns),l(i,[{key:"state",get:function(){return this._state}}]),i}(),xE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.SHADER)))._device=void 0,t._id=void 0,t._name="",t._stages=[],t._blocks=[],t._samplers=[],t._device=e,t._id=e.genShaderId(),t}return p(i,ns),l(i,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}}]),i}(),AE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.TEXTURE)))._device=void 0,t._type=Aa.TEX2D,t._usage=wa.NONE,t._format=Kt.GFXFormat.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._arrayLayer=1,t._mipLevel=1,t._samples=ka.X1,t._flags=Fa.NONE,t._isPowerOf2=!1,t._size=0,t._buffer=null,t._device=e,t}return p(i,ns),l(i,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"arrayLayer",get:function(){return this._arrayLayer}},{key:"mipLevel",get:function(){return this._mipLevel}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),i}(),CE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.BINDING_LAYOUT)))._device=void 0,t._bindingUnits=[],t._isDirty=!1,t._device=e,t}return p(i,ns),l(i,[{key:"bindBuffer",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Da.UNIFORM_BUFFER?s.buffer!==t&&(s.buffer=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.UNIFORM_BUFFER."))}}},{key:"bindSampler",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Da.SAMPLER?s.sampler!==t&&(s.sampler=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"bindTextureView",value:function(e,t){var i=this._bindingUnits,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(s.binding===e)return void(s.type===Da.SAMPLER?s.texView!==t&&(s.texView=t,this._isDirty=!0):console.error("Setting binding is not GFXBindingType.SAMPLER."))}}},{key:"getBindingUnit",value:function(e){var t=this._bindingUnits,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.binding===e)return a}return null}}]),i}(),wE=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBindingLayout=null,t}return p(i,CE),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=jr.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case Da.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case Da.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}(),RE=function(){function i(e,t){y(this,i),this.array=void 0,this.length=0,this.cache=void 0,this._compareFn=void 0,this.array=new Array(e),this.cache=this.array,this.length=0,this._compareFn=void 0!==t?t:function(e,t){return e-t}}return l(i,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[this.length--]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.cache.fill(null),this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e.array[t]}},{key:"append",value:function(e){var t=e,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;this.array[this.length++]=a}}}]),i}();function kE(e,t){var i=e-t;return 1e-6<i||i<-1e-6}function OE(e,t){switch(e){case Kt.GFXFormat.R8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.R8SN:return t.BYTE;case Kt.GFXFormat.R8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.R8I:return t.BYTE;case Kt.GFXFormat.R16F:return oE.HALF_FLOAT_OES;case Kt.GFXFormat.R16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.R16I:return t.SHORT;case Kt.GFXFormat.R32F:return t.FLOAT;case Kt.GFXFormat.R32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.R32I:return t.INT;case Kt.GFXFormat.RG8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RG8SN:return t.BYTE;case Kt.GFXFormat.RG8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RG8I:return t.BYTE;case Kt.GFXFormat.RG16F:return oE.HALF_FLOAT_OES;case Kt.GFXFormat.RG16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RG16I:return t.SHORT;case Kt.GFXFormat.RG32F:return t.FLOAT;case Kt.GFXFormat.RG32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RG32I:return t.INT;case Kt.GFXFormat.RGB8:case Kt.GFXFormat.SRGB8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGB8SN:return t.BYTE;case Kt.GFXFormat.RGB8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGB8I:return t.BYTE;case Kt.GFXFormat.RGB16F:return oE.HALF_FLOAT_OES;case Kt.GFXFormat.RGB16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RGB16I:return t.SHORT;case Kt.GFXFormat.RGB32F:return t.FLOAT;case Kt.GFXFormat.RGB32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RGB32I:return t.INT;case Kt.GFXFormat.RGBA8:case Kt.GFXFormat.SRGB8_A8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGBA8SN:return t.BYTE;case Kt.GFXFormat.RGBA8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGBA8I:return t.BYTE;case Kt.GFXFormat.RGBA16F:return oE.HALF_FLOAT_OES;case Kt.GFXFormat.RGBA16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RGBA16I:return t.SHORT;case Kt.GFXFormat.RGBA32F:return t.FLOAT;case Kt.GFXFormat.RGBA32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RGBA32I:return t.INT;case Kt.GFXFormat.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Kt.GFXFormat.R11G11B10F:return t.FLOAT;case Kt.GFXFormat.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Kt.GFXFormat.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Kt.GFXFormat.RGB10A2:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGB10A2UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RGB9E5:return t.UNSIGNED_BYTE;case Kt.GFXFormat.D16:case Kt.GFXFormat.D16S8:return t.UNSIGNED_SHORT;case Kt.GFXFormat.D24:return t.UNSIGNED_INT;case Kt.GFXFormat.D24S8:return oE.UNSIGNED_INT_24_8_WEBGL;case Kt.GFXFormat.D32F:case Kt.GFXFormat.D32F_S8:return t.FLOAT;case Kt.GFXFormat.BC1:case Kt.GFXFormat.BC1_SRGB:case Kt.GFXFormat.BC2:case Kt.GFXFormat.BC2_SRGB:case Kt.GFXFormat.BC3:case Kt.GFXFormat.BC3_SRGB:case Kt.GFXFormat.BC4:return t.UNSIGNED_BYTE;case Kt.GFXFormat.BC4_SNORM:return t.BYTE;case Kt.GFXFormat.BC5:return t.UNSIGNED_BYTE;case Kt.GFXFormat.BC5_SNORM:return t.BYTE;case Kt.GFXFormat.BC6H_SF16:case Kt.GFXFormat.BC6H_UF16:return t.FLOAT;case Kt.GFXFormat.BC7:case Kt.GFXFormat.BC7_SRGB:case Kt.GFXFormat.ETC_RGB8:case Kt.GFXFormat.ETC2_RGB8:case Kt.GFXFormat.ETC2_SRGB8:case Kt.GFXFormat.ETC2_RGB8_A1:case Kt.GFXFormat.ETC2_SRGB8_A1:case Kt.GFXFormat.ETC2_RGB8:case Kt.GFXFormat.ETC2_SRGB8:case Kt.GFXFormat.EAC_R11:return t.UNSIGNED_BYTE;case Kt.GFXFormat.EAC_R11SN:return t.BYTE;case Kt.GFXFormat.EAC_RG11:return t.UNSIGNED_BYTE;case Kt.GFXFormat.EAC_RG11SN:return t.BYTE;case Kt.GFXFormat.PVRTC_RGB2:case Kt.GFXFormat.PVRTC_RGBA2:case Kt.GFXFormat.PVRTC_RGB4:case Kt.GFXFormat.PVRTC_RGBA4:case Kt.GFXFormat.PVRTC2_2BPP:case Kt.GFXFormat.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function FE(e,t){switch(e){case Kt.GFXFormat.A8:return t.ALPHA;case Kt.GFXFormat.L8:return t.LUMINANCE;case Kt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Kt.GFXFormat.RGB8:case Kt.GFXFormat.RGB16F:case Kt.GFXFormat.RGB32F:return t.RGB;case Kt.GFXFormat.RGBA8:case Kt.GFXFormat.RGBA16F:case Kt.GFXFormat.RGBA32F:return t.RGBA;case Kt.GFXFormat.R5G6B5:return t.RGB565;case Kt.GFXFormat.RGB5A1:return t.RGB5_A1;case Kt.GFXFormat.RGBA4:return t.RGBA4;case Kt.GFXFormat.D16:return t.DEPTH_COMPONENT16;case Kt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D24:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D24S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D32F:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.BC1:return oE.COMPRESSED_RGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_ALPHA:return oE.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB:return oE.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB_ALPHA:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC2:return oE.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC2_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC3:return oE.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Kt.GFXFormat.BC3_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Kt.GFXFormat.ETC_RGB8:return oE.COMPRESSED_RGB_ETC1_WEBGL;case Kt.GFXFormat.PVRTC_RGB2:return oE.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA2:return oE.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGB4:return oE.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA4:return oE.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function LE(e,t){switch(e){case Kt.GFXFormat.A8:return t.ALPHA;case Kt.GFXFormat.L8:return t.LUMINANCE;case Kt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Kt.GFXFormat.RGB8:case Kt.GFXFormat.RGB16F:case Kt.GFXFormat.RGB32F:return t.RGB;case Kt.GFXFormat.RGBA8:case Kt.GFXFormat.RGBA16F:case Kt.GFXFormat.RGBA32F:return t.RGBA;case Kt.GFXFormat.R5G6B5:return t.RGB;case Kt.GFXFormat.RGB5A1:case Kt.GFXFormat.RGBA4:return t.RGBA;case Kt.GFXFormat.D16:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D24:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D24S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D32F:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.BC1:return oE.COMPRESSED_RGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_ALPHA:return oE.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB:return oE.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB_ALPHA:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC2:return oE.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC2_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC3:return oE.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Kt.GFXFormat.BC3_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Kt.GFXFormat.ETC_RGB8:return oE.COMPRESSED_RGB_ETC1_WEBGL;case Kt.GFXFormat.ETC2_RGB8:return oE.COMPRESSED_RGB8_ETC2;case Kt.GFXFormat.ETC2_SRGB8:return oE.COMPRESSED_SRGB8_ETC2;case Kt.GFXFormat.ETC2_RGB8_A1:return oE.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Kt.GFXFormat.ETC2_SRGB8_A1:return oE.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Kt.GFXFormat.ETC2_RGBA8:return oE.COMPRESSED_RGBA8_ETC2_EAC;case Kt.GFXFormat.ETC2_SRGB8_A8:return oE.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Kt.GFXFormat.EAC_R11:return oE.COMPRESSED_R11_EAC;case Kt.GFXFormat.EAC_R11SN:return oE.COMPRESSED_SIGNED_R11_EAC;case Kt.GFXFormat.EAC_RG11:return oE.COMPRESSED_RG11_EAC;case Kt.GFXFormat.EAC_RG11SN:return oE.COMPRESSED_SIGNED_RG11_EAC;case Kt.GFXFormat.PVRTC_RGB2:return oE.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA2:return oE.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGB4:return oE.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA4:return oE.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function BE(e,t){switch(e){case Kr.BOOL:return t.BOOL;case Kr.BOOL2:return t.BOOL_VEC2;case Kr.BOOL3:return t.BOOL_VEC3;case Kr.BOOL4:return t.BOOL_VEC4;case Kr.INT:return t.INT;case Kr.INT2:return t.INT_VEC2;case Kr.INT3:return t.INT_VEC3;case Kr.INT4:return t.INT_VEC4;case Kr.UINT:return t.UNSIGNED_INT;case Kr.FLOAT:return t.FLOAT;case Kr.FLOAT2:return t.FLOAT_VEC2;case Kr.FLOAT3:return t.FLOAT_VEC3;case Kr.FLOAT4:return t.FLOAT_VEC4;case Kr.MAT2:return t.FLOAT_MAT2;case Kr.MAT3:return t.FLOAT_MAT3;case Kr.MAT4:return t.FLOAT_MAT4;case Kr.SAMPLER2D:return t.SAMPLER_2D;case Kr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Kr.UNKNOWN}}function ME(e,t){switch(e){case t.BOOL:return Kr.BOOL;case t.BOOL_VEC2:return Kr.BOOL2;case t.BOOL_VEC3:return Kr.BOOL3;case t.BOOL_VEC4:return Kr.BOOL4;case t.INT:return Kr.INT;case t.INT_VEC2:return Kr.INT2;case t.INT_VEC3:return Kr.INT3;case t.INT_VEC4:return Kr.INT4;case t.UNSIGNED_INT:return Kr.UINT;case t.FLOAT:return Kr.FLOAT;case t.FLOAT_VEC2:return Kr.FLOAT2;case t.FLOAT_VEC3:return Kr.FLOAT3;case t.FLOAT_VEC4:return Kr.FLOAT4;case t.FLOAT_MAT2:return Kr.MAT2;case t.FLOAT_MAT3:return Kr.MAT3;case t.FLOAT_MAT4:return Kr.MAT4;case t.SAMPLER_2D:return Kr.SAMPLER2D;case t.SAMPLER_CUBE:return Kr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Kr.UNKNOWN}}function IE(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function PE(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}(lE=oE||(oE={}))[lE.RGBA16F_EXT=34842]="RGBA16F_EXT",lE[lE.RGB16F_EXT=34843]="RGB16F_EXT",lE[lE.RGBA32F_EXT=34836]="RGBA32F_EXT",lE[lE.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",lE[lE.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",lE[lE.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",lE[lE.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",lE[lE.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",lE[lE.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",lE[lE.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",lE[lE.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",lE[lE.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",lE[lE.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",lE[lE.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",lE[lE.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",lE[lE.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",lE[lE.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",lE[lE.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",lE[lE.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",lE[lE.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",lE[lE.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",lE[lE.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",lE[lE.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",lE[lE.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",lE[lE.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",lE[lE.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",lE[lE.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",lE[lE.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",lE[lE.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",lE[lE.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC";var DE,NE,zE=[512,513,514,515,516,517,518,519],UE=[0,7680,7681,7682,7683,5386,34055,34056],GE=[32774,32778,32779,32774,32774],VE=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(NE=DE||(DE={}))[NE.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",NE[NE.END_RENDER_PASS=1]="END_RENDER_PASS",NE[NE.BIND_STATES=2]="BIND_STATES",NE[NE.DRAW=3]="DRAW",NE[NE.UPDATE_BUFFER=4]="UPDATE_BUFFER",NE[NE.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",NE[NE.COUNT=6]="COUNT";var HE=function e(t){y(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},WE=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,DE.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=ts.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return p(t,HE),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),XE=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,DE.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return p(t,HE),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),jE=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,DE.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return p(t,HE),l(t,[{key:"clear",value:function(){}}]),t}(),qE=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,DE.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return p(t,HE),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),YE=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,DE.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return p(t,HE),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),KE=function(){function e(){y(this,e),this.cmds=new RE(1),this.beginRenderPassCmds=new RE(1),this.bindStatesCmds=new RE(1),this.drawCmds=new RE(1),this.updateBufferCmds=new RE(1),this.copyBufferToTextureCmds=new RE(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function QE(e,t,i,n,r){if(t.usage&Jr.UNIFORM)i instanceof Float32Array?t.vf32.set(i,n):t.vf32.set(new Float32Array(i),n);else if(t.usage&Jr.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case s.ELEMENT_ARRAY_BUFFER:e.useVAO&&o.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r))}}var ZE=new Array(DE.COUNT);function JE(e,t){var i=e.gl,n=e.stateCache;ZE.fill(0);for(var r,a,s,o=null,l=null,c=null,u=i.TRIANGLES,h=0;h<t.cmds.length;++h){var d=t.cmds.array[h],f=ZE[d]++;switch(d){case DE.BEGIN_RENDER_PASS:var p=t.beginRenderPassCmds.array[f],_=0;if(p.gpuFramebuffer){n.glFramebuffer!==p.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,p.gpuFramebuffer.glFramebuffer),n.glFramebuffer=p.gpuFramebuffer.glFramebuffer),n.viewport.left===p.renderArea.x&&n.viewport.top===p.renderArea.y&&n.viewport.width===p.renderArea.width&&n.viewport.height===p.renderArea.height||(i.viewport(p.renderArea.x,p.renderArea.y,p.renderArea.width,p.renderArea.height),n.viewport.left=p.renderArea.x,n.viewport.top=p.renderArea.y,n.viewport.width=p.renderArea.width,n.viewport.height=p.renderArea.height),n.scissorRect.x===p.renderArea.x&&n.scissorRect.y===p.renderArea.y&&n.scissorRect.width===p.renderArea.width&&n.scissorRect.height===p.renderArea.height||(i.scissor(p.renderArea.x,p.renderArea.y,p.renderArea.width,p.renderArea.height),n.scissorRect.x=p.renderArea.x,n.scissorRect.y=p.renderArea.y,n.scissorRect.width=p.renderArea.width,n.scissorRect.height=p.renderArea.height);var v=p.gpuFramebuffer.gpuRenderPass,m=p.clearColors.length;e.WEBGL_draw_buffers||(m=1);for(var y=0;y<m;++y){var g=v.colorAttachments[y];if(g.format!==Kt.GFXFormat.UNKNOWN)switch(g.loadOp){case Ga.LOAD:break;case Ga.CLEAR:if(p.clearFlag&ts.COLOR){n.bs.targets[0].blendColorMask!==ga.ALL&&i.colorMask(!0,!0,!0,!0);var b=p.clearColors[0];i.clearColor(b.r,b.g,b.b,b.a),_|=i.COLOR_BUFFER_BIT}break;case Ga.DISCARD:}}if(v.depthStencilAttachment&&v.depthStencilAttachment.format!==Kt.GFXFormat.UNKNOWN){switch(v.depthStencilAttachment.depthLoadOp){case Ga.LOAD:break;case Ga.CLEAR:p.clearFlag&ts.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(p.clearDepth),_|=i.DEPTH_BUFFER_BIT);break;case Ga.DISCARD:}if(ls[v.depthStencilAttachment.format].hasStencil)switch(v.depthStencilAttachment.stencilLoadOp){case Ga.LOAD:break;case Ga.CLEAR:p.clearFlag&ts.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(p.clearStencil),_|=i.STENCIL_BUFFER_BIT);break;case Ga.DISCARD:}}if(_&&i.clear(_),_&i.COLOR_BUFFER_BIT){var S=n.bs.targets[0].blendColorMask;if(S!==ga.ALL){var T=(S&ga.R)!==ga.NONE,E=(S&ga.G)!==ga.NONE,x=(S&ga.B)!==ga.NONE,A=(S&ga.A)!==ga.NONE;i.colorMask(T,E,x,A)}}_&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),_&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case DE.END_RENDER_PASS:break;case DE.BIND_STATES:var C=t.bindStatesCmds.array[f];if(C.gpuPipelineState){if(o=C.gpuPipelineState,u=C.gpuPipelineState.glPrimitive,C.gpuPipelineState.gpuShader){var w=C.gpuPipelineState.gpuShader.glProgram;n.glProgram!==w&&(i.useProgram(w),n.glProgram=w),l=C.gpuPipelineState.gpuShader}var R=C.gpuPipelineState.rs;if(R){if(n.rs.cullMode!==R.cullMode){switch(R.cullMode){case ca.NONE:i.disable(i.CULL_FACE);break;case ca.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ca.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}n.rs.cullMode=R.cullMode}n.rs.isFrontFaceCCW!==R.isFrontFaceCCW&&(i.frontFace(R.isFrontFaceCCW?i.CCW:i.CW),n.rs.isFrontFaceCCW=R.isFrontFaceCCW),n.rs.depthBias===R.depthBias&&n.rs.depthBiasSlop===R.depthBiasSlop||(i.polygonOffset(R.depthBias,R.depthBiasSlop),n.rs.depthBias=R.depthBias,n.rs.depthBiasSlop=R.depthBiasSlop),n.rs.lineWidth!==R.lineWidth&&(i.lineWidth(R.lineWidth),n.rs.lineWidth=R.lineWidth)}var k=C.gpuPipelineState.dss;k&&(n.dss.depthTest!==k.depthTest&&(k.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=k.depthTest),n.dss.depthWrite!==k.depthWrite&&(i.depthMask(k.depthWrite),n.dss.depthWrite=k.depthWrite),n.dss.depthFunc!==k.depthFunc&&(i.depthFunc(zE[k.depthFunc]),n.dss.depthFunc=k.depthFunc),n.dss.stencilTestFront===k.stencilTestFront&&n.dss.stencilTestBack===k.stencilTestBack||(k.stencilTestFront||k.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=k.stencilTestFront,n.dss.stencilTestBack=k.stencilTestBack),n.dss.stencilFuncFront===k.stencilFuncFront&&n.dss.stencilRefFront===k.stencilRefFront&&n.dss.stencilReadMaskFront===k.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,zE[k.stencilFuncFront],k.stencilRefFront,k.stencilReadMaskFront),n.dss.stencilFuncFront=k.stencilFuncFront,n.dss.stencilRefFront=k.stencilRefFront,n.dss.stencilReadMaskFront=k.stencilReadMaskFront),n.dss.stencilFailOpFront===k.stencilFailOpFront&&n.dss.stencilZFailOpFront===k.stencilZFailOpFront&&n.dss.stencilPassOpFront===k.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,UE[k.stencilFailOpFront],UE[k.stencilZFailOpFront],UE[k.stencilPassOpFront]),n.dss.stencilFailOpFront=k.stencilFailOpFront,n.dss.stencilZFailOpFront=k.stencilZFailOpFront,n.dss.stencilPassOpFront=k.stencilPassOpFront),n.dss.stencilWriteMaskFront!==k.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,k.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=k.stencilWriteMaskFront),n.dss.stencilFuncBack===k.stencilFuncBack&&n.dss.stencilRefBack===k.stencilRefBack&&n.dss.stencilReadMaskBack===k.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,zE[k.stencilFuncBack],k.stencilRefBack,k.stencilReadMaskBack),n.dss.stencilFuncBack=k.stencilFuncBack,n.dss.stencilRefBack=k.stencilRefBack,n.dss.stencilReadMaskBack=k.stencilReadMaskBack),n.dss.stencilFailOpBack===k.stencilFailOpBack&&n.dss.stencilZFailOpBack===k.stencilZFailOpBack&&n.dss.stencilPassOpBack===k.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,UE[k.stencilFailOpBack],UE[k.stencilZFailOpBack],UE[k.stencilPassOpBack]),n.dss.stencilFailOpBack=k.stencilFailOpBack,n.dss.stencilZFailOpBack=k.stencilZFailOpBack,n.dss.stencilPassOpBack=k.stencilPassOpBack),n.dss.stencilWriteMaskBack!==k.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,k.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=k.stencilWriteMaskBack));var O=C.gpuPipelineState.bs;if(O){n.bs.isA2C!==O.isA2C&&(O.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=O.isA2C),n.bs.blendColor[0]===O.blendColor[0]&&n.bs.blendColor[1]===O.blendColor[1]&&n.bs.blendColor[2]===O.blendColor[2]&&n.bs.blendColor[3]===O.blendColor[3]||(i.blendColor(O.blendColor[0],O.blendColor[1],O.blendColor[2],O.blendColor[3]),n.bs.blendColor[0]=O.blendColor[0],n.bs.blendColor[1]=O.blendColor[1],n.bs.blendColor[2]=O.blendColor[2],n.bs.blendColor[3]=O.blendColor[3]);var F=O.targets[0],L=n.bs.targets[0];L.blend!==F.blend&&(F.blend?i.enable(i.BLEND):i.disable(i.BLEND),L.blend=F.blend),L.blendEq===F.blendEq&&L.blendAlphaEq===F.blendAlphaEq||(i.blendEquationSeparate(GE[F.blendEq],GE[F.blendAlphaEq]),L.blendEq=F.blendEq,L.blendAlphaEq=F.blendAlphaEq),L.blendSrc===F.blendSrc&&L.blendDst===F.blendDst&&L.blendSrcAlpha===F.blendSrcAlpha&&L.blendDstAlpha===F.blendDstAlpha||(i.blendFuncSeparate(VE[F.blendSrc],VE[F.blendDst],VE[F.blendSrcAlpha],VE[F.blendDstAlpha]),L.blendSrc=F.blendSrc,L.blendDst=F.blendDst,L.blendSrcAlpha=F.blendSrcAlpha,L.blendDstAlpha=F.blendDstAlpha),L.blendColorMask!==F.blendColorMask&&(i.colorMask((F.blendColorMask&ga.R)!==ga.NONE,(F.blendColorMask&ga.G)!==ga.NONE,(F.blendColorMask&ga.B)!==ga.NONE,(F.blendColorMask&ga.A)!==ga.NONE),L.blendColorMask=F.blendColorMask)}}if(C.gpuBindingLayout&&l){var B=C.gpuBindingLayout.gpuBindings,M=Array.isArray(B),I=0;for(B=M?B:B[Symbol.iterator]();;){var P;if(M){if(I>=B.length)break;P=B[I++]}else{if((I=B.next()).done)break;P=I.value}var D=P;switch(D.type){case Da.UNIFORM_BUFFER:if(D.gpuBuffer&&D.gpuBuffer.buffer){var N=null,z=l.glBlocks,U=Array.isArray(z),G=0;for(z=U?z:z[Symbol.iterator]();;){var V;if(U){if(G>=z.length)break;V=z[G++]}else{if((G=z.next()).done)break;V=G.value}var H=V;if(H.binding===D.binding){N=H;break}}if(N&&D.gpuBuffer.vf32){var W=N.glActiveUniforms,X=Array.isArray(W),j=0;for(W=X?W:W[Symbol.iterator]();;){var q;if(X){if(j>=W.length)break;q=W[j++]}else{if((j=W.next()).done)break;q=j.value}var Y=q;switch(Y.glType){case i.BOOL:case i.INT:for(var K=0;K<Y.array.length;++K){var Q=Y.begin+K;if(D.gpuBuffer.vf32[Q]!==Y.array[K]){for(var Z=K,J=Y.begin+K;Z<Y.array.length;++Z,++J)Y.array[Z]=D.gpuBuffer.vf32[J];i.uniform1iv(Y.glLoc,Y.array);break}}break;case i.BOOL_VEC2:case i.INT_VEC2:for(var $=0;$<Y.array.length;++$){var ee=Y.begin+$;if(D.gpuBuffer.vf32[ee]!==Y.array[$]){for(var te=$,ie=Y.begin+$;te<Y.array.length;++te,++ie)Y.array[te]=D.gpuBuffer.vf32[ie];i.uniform2iv(Y.glLoc,Y.array);break}}break;case i.BOOL_VEC3:case i.INT_VEC3:for(var ne=0;ne<Y.array.length;++ne){var re=Y.begin+ne;if(D.gpuBuffer.vf32[re]!==Y.array[ne]){for(var ae=ne,se=Y.begin+ne;ae<Y.array.length;++ae,++se)Y.array[ae]=D.gpuBuffer.vf32[se];i.uniform3iv(Y.glLoc,Y.array);break}}break;case i.BOOL_VEC4:case i.INT_VEC4:for(var oe=0;oe<Y.array.length;++oe){var le=Y.begin+oe;if(D.gpuBuffer.vf32[le]!==Y.array[oe]){for(var ce=oe,ue=Y.begin+oe;ce<Y.array.length;++ce,++ue)Y.array[ce]=D.gpuBuffer.vf32[ue];i.uniform4iv(Y.glLoc,Y.array);break}}break;case i.FLOAT:for(var he=0;he<Y.array.length;++he){var de=Y.begin+he;if(kE(D.gpuBuffer.vf32[de],Y.array[he])){for(var fe=he,pe=Y.begin+he;fe<Y.array.length;++fe,++pe)Y.array[fe]=D.gpuBuffer.vf32[pe];i.uniform1fv(Y.glLoc,Y.array);break}}break;case i.FLOAT_VEC2:for(var _e=0;_e<Y.array.length;++_e){var ve=Y.begin+_e;if(kE(D.gpuBuffer.vf32[ve],Y.array[_e])){for(var me=_e,ye=Y.begin+_e;me<Y.array.length;++me,++ye)Y.array[me]=D.gpuBuffer.vf32[ye];i.uniform2fv(Y.glLoc,Y.array);break}}break;case i.FLOAT_VEC3:for(var ge=0;ge<Y.array.length;++ge){var be=Y.begin+ge;if(kE(D.gpuBuffer.vf32[be],Y.array[ge])){for(var Se=ge,Te=Y.begin+ge;Se<Y.array.length;++Se,++Te)Y.array[Se]=D.gpuBuffer.vf32[Te];i.uniform3fv(Y.glLoc,Y.array);break}}break;case i.FLOAT_VEC4:for(var Ee=0;Ee<Y.array.length;++Ee){var xe=Y.begin+Ee;if(kE(D.gpuBuffer.vf32[xe],Y.array[Ee])){for(var Ae=Ee,Ce=Y.begin+Ee;Ae<Y.array.length;++Ae,++Ce)Y.array[Ae]=D.gpuBuffer.vf32[Ce];i.uniform4fv(Y.glLoc,Y.array);break}}break;case i.FLOAT_MAT2:for(var we=0;we<Y.array.length;++we){var Re=Y.begin+we;if(kE(D.gpuBuffer.vf32[Re],Y.array[we])){for(var ke=we,Oe=Y.begin+we;ke<Y.array.length;++ke,++Oe)Y.array[ke]=D.gpuBuffer.vf32[Oe];i.uniformMatrix2fv(Y.glLoc,!1,Y.array);break}}break;case i.FLOAT_MAT3:for(var Fe=0;Fe<Y.array.length;++Fe){var Le=Y.begin+Fe;if(kE(D.gpuBuffer.vf32[Le],Y.array[Fe])){for(var Be=Fe,Me=Y.begin+Fe;Be<Y.array.length;++Be,++Me)Y.array[Be]=D.gpuBuffer.vf32[Me];i.uniformMatrix3fv(Y.glLoc,!1,Y.array);break}}break;case i.FLOAT_MAT4:for(var Ie=0;Ie<Y.array.length;++Ie){var Pe=Y.begin+Ie;if(kE(D.gpuBuffer.vf32[Pe],Y.array[Ie])){for(var De=Ie,Ne=Y.begin+Ie;De<Y.array.length;++De,++Ne)Y.array[De]=D.gpuBuffer.vf32[Ne];i.uniformMatrix4fv(Y.glLoc,!1,Y.array);break}}}}}}break;case Da.SAMPLER:if(D.gpuSampler){var ze=null,Ue=l.glSamplers,Ge=Array.isArray(Ue),Ve=0;for(Ue=Ge?Ue:Ue[Symbol.iterator]();;){var He;if(Ge){if(Ve>=Ue.length)break;He=Ue[Ve++]}else{if((Ve=Ue.next()).done)break;He=Ve.value}var We=He;if(We.binding===D.binding){ze=We;break}}if(ze){var Xe=ze.units,je=Array.isArray(Xe),qe=0;for(Xe=je?Xe:Xe[Symbol.iterator]();;){var Ye;if(je){if(qe>=Xe.length)break;Ye=Xe[qe++]}else{if((qe=Xe.next()).done)break;Ye=qe.value}var Ke=Ye,Qe=null;if(D.gpuTexView&&0<D.gpuTexView.gpuTexture.size){n.texUnit!==Ke&&(i.activeTexture(i.TEXTURE0+Ke),n.texUnit=Ke);var Ze=D.gpuTexView.gpuTexture;switch(ze.glType){case i.SAMPLER_2D:(Qe=n.glTex2DUnits[Ke]).glTexture!==Ze.glTexture&&(Ze.glTexture?i.bindTexture(i.TEXTURE_2D,Ze.glTexture):i.bindTexture(i.TEXTURE_2D,e.nullTex2D.gpuTexture.glTexture),Qe.glTexture=Ze.glTexture);break;case i.SAMPLER_CUBE:(Qe=n.glTexCubeUnits[Ke]).glTexture!==Ze.glTexture&&(Ze.glTexture?i.bindTexture(i.TEXTURE_CUBE_MAP,Ze.glTexture):i.bindTexture(i.TEXTURE_CUBE_MAP,e.nullTexCube.gpuTexture.glTexture),Qe.glTexture=Ze.glTexture);break;default:console.error("Unsupported GL Texture type.")}if(Qe){var Je=D.gpuSampler;a=Ze.isPowerOf2?(r=Je.glWrapS,Je.glWrapT):(r=i.CLAMP_TO_EDGE,i.CLAMP_TO_EDGE),s=Ze.isPowerOf2?Je.glMinFilter:Je.glMinFilter===i.LINEAR||Je.glMinFilter===i.LINEAR_MIPMAP_NEAREST||Je.glMinFilter===i.LINEAR_MIPMAP_LINEAR?i.LINEAR:i.NEAREST,Ze.glWrapS!==r&&(i.texParameteri(Ze.glTarget,i.TEXTURE_WRAP_S,r),Ze.glWrapS=r),Ze.glWrapT!==a&&(i.texParameteri(Ze.glTarget,i.TEXTURE_WRAP_T,a),Ze.glWrapT=a),Ze.glMinFilter!==s&&(i.texParameteri(Ze.glTarget,i.TEXTURE_MIN_FILTER,s),Ze.glMinFilter=s),Ze.glMagFilter!==Je.glMagFilter&&(i.texParameteri(Ze.glTarget,i.TEXTURE_MAG_FILTER,Je.glMagFilter),Ze.glMagFilter=Je.glMagFilter)}}}}}else console.error("Not found sampler on binding unit "+D.binding)}}}if(C.gpuInputAssembler&&l&&c!==C.gpuInputAssembler)if(c=C.gpuInputAssembler,e.useVAO){var $e=e.OES_vertex_array_object,et=c.glVAOs.get(l.glProgram);if(!et){et=$e.createVertexArrayOES(),c.glVAOs.set(l.glProgram,et),$e.bindVertexArrayOES(et),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);var tt=void 0,it=l.glInputs,nt=Array.isArray(it),rt=0;for(it=nt?it:it[Symbol.iterator]();;){var at;if(nt){if(rt>=it.length)break;at=it[rt++]}else{if((rt=it.next()).done)break;at=rt.value}var st=at;tt=null;var ot=c.glAttribs,lt=Array.isArray(ot),ct=0;for(ot=lt?ot:ot[Symbol.iterator]();;){var ut;if(lt){if(ct>=ot.length)break;ut=ot[ct++]}else{if((ct=ot.next()).done)break;ut=ct.value}var ht=ut;if(ht.name===st.name){tt=ht;break}}if(tt){n.glArrayBuffer!==tt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,tt.glBuffer),n.glArrayBuffer=tt.glBuffer);for(var dt=0;dt<tt.componentCount;++dt){var ft=st.glLoc+dt,pt=tt.offset+tt.size*dt;i.enableVertexAttribArray(ft),n.glCurrentAttribLocs[ft]=!0,i.vertexAttribPointer(ft,tt.count,tt.glType,tt.isNormalized,tt.stride,pt)}}}var _t=c.gpuIndexBuffer;_t&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,_t.glBuffer),$e.bindVertexArrayOES(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==et&&($e.bindVertexArrayOES(et),n.glVAO=et)}else{for(var vt=0;vt<e.maxVertexAttributes;++vt)n.glCurrentAttribLocs[vt]=!1;var mt=l.glInputs,yt=Array.isArray(mt),gt=0;for(mt=yt?mt:mt[Symbol.iterator]();;){var bt;if(yt){if(gt>=mt.length)break;bt=mt[gt++]}else{if((gt=mt.next()).done)break;bt=gt.value}var St=bt,Tt=null,Et=c.glAttribs,xt=Array.isArray(Et),At=0;for(Et=xt?Et:Et[Symbol.iterator]();;){var Ct;if(xt){if(At>=Et.length)break;Ct=Et[At++]}else{if((At=Et.next()).done)break;Ct=At.value}var wt=Ct;if(wt.name===St.name){Tt=wt;break}}if(Tt){n.glArrayBuffer!==Tt.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,Tt.glBuffer),n.glArrayBuffer=Tt.glBuffer);for(var Rt=0;Rt<Tt.componentCount;++Rt){var kt=St.glLoc+Rt,Ot=Tt.offset+Tt.size*Rt;!n.glEnabledAttribLocs[kt]&&0<=kt&&(i.enableVertexAttribArray(kt),n.glEnabledAttribLocs[kt]=!0),n.glCurrentAttribLocs[kt]=!0,i.vertexAttribPointer(kt,Tt.count,Tt.glType,Tt.isNormalized,Tt.stride,Ot)}}}var Ft=c.gpuIndexBuffer;Ft&&n.glElementArrayBuffer!==Ft.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,Ft.glBuffer),n.glElementArrayBuffer=Ft.glBuffer);for(var Lt=0;Lt<e.maxVertexAttributes;++Lt)n.glEnabledAttribLocs[Lt]!==n.glCurrentAttribLocs[Lt]&&(i.disableVertexAttribArray(Lt),n.glEnabledAttribLocs[Lt]=!1)}if(o){var Bt=o.dynamicStates,Mt=Array.isArray(Bt),It=0;for(Bt=Mt?Bt:Bt[Symbol.iterator]();;){var Pt;if(Mt){if(It>=Bt.length)break;Pt=Bt[It++]}else{if((It=Bt.next()).done)break;Pt=It.value}switch(Pt){case Ka.VIEWPORT:C.viewport&&(n.viewport.left===C.viewport.left&&n.viewport.top===C.viewport.top&&n.viewport.width===C.viewport.width&&n.viewport.height===C.viewport.height||(i.viewport(C.viewport.left,C.viewport.top,C.viewport.width,C.viewport.height),n.viewport.left=C.viewport.left,n.viewport.top=C.viewport.top,n.viewport.width=C.viewport.width,n.viewport.height=C.viewport.height));break;case Ka.SCISSOR:C.scissor&&(n.scissorRect.x===C.scissor.x&&n.scissorRect.y===C.scissor.y&&n.scissorRect.width===C.scissor.width&&n.scissorRect.height===C.scissor.height||(i.scissor(C.scissor.x,C.scissor.y,C.scissor.width,C.scissor.height),n.scissorRect.x=C.scissor.x,n.scissorRect.y=C.scissor.y,n.scissorRect.width=C.scissor.width,n.scissorRect.height=C.scissor.height));break;case Ka.LINE_WIDTH:C.lineWidth&&n.rs.lineWidth!==C.lineWidth&&(i.lineWidth(C.lineWidth),n.rs.lineWidth=C.lineWidth);break;case Ka.DEPTH_BIAS:C.depthBias&&(n.rs.depthBias===C.depthBias.constantFactor&&n.rs.depthBiasSlop===C.depthBias.slopeFactor||(i.polygonOffset(C.depthBias.constantFactor,C.depthBias.slopeFactor),n.rs.depthBias=C.depthBias.constantFactor,n.rs.depthBiasSlop=C.depthBias.slopeFactor));break;case Ka.BLEND_CONSTANTS:C.blendConstants&&(n.bs.blendColor[0]===C.blendConstants[0]&&n.bs.blendColor[1]===C.blendConstants[1]&&n.bs.blendColor[2]===C.blendConstants[2]&&n.bs.blendColor[3]===C.blendConstants[3]||(i.blendColor(C.blendConstants[0],C.blendConstants[1],C.blendConstants[2],C.blendConstants[3]),n.bs.blendColor[0]=C.blendConstants[0],n.bs.blendColor[1]=C.blendConstants[1],n.bs.blendColor[2]=C.blendConstants[2],n.bs.blendColor[3]=C.blendConstants[3]));break;case Ka.STENCIL_WRITE_MASK:if(C.stencilWriteMask)switch(C.stencilWriteMask.face){case Za.FRONT:n.dss.stencilWriteMaskFront!==C.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,C.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=C.stencilWriteMask.writeMask);break;case Za.BACK:n.dss.stencilWriteMaskBack!==C.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,C.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=C.stencilWriteMask.writeMask);break;case Za.ALL:n.dss.stencilWriteMaskFront===C.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===C.stencilWriteMask.writeMask||(i.stencilMask(C.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=C.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=C.stencilWriteMask.writeMask)}break;case Ka.STENCIL_COMPARE_MASK:if(C.stencilCompareMask)switch(C.stencilCompareMask.face){case Za.FRONT:n.dss.stencilRefFront===C.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===C.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,zE[n.dss.stencilFuncFront],C.stencilCompareMask.reference,C.stencilCompareMask.compareMask),n.dss.stencilRefFront=C.stencilCompareMask.reference,n.dss.stencilReadMaskFront=C.stencilCompareMask.compareMask);break;case Za.BACK:n.dss.stencilRefBack===C.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===C.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,zE[n.dss.stencilFuncBack],C.stencilCompareMask.reference,C.stencilCompareMask.compareMask),n.dss.stencilRefBack=C.stencilCompareMask.reference,n.dss.stencilReadMaskBack=C.stencilCompareMask.compareMask);break;case Za.ALL:n.dss.stencilRefFront===C.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===C.stencilCompareMask.compareMask&&n.dss.stencilRefBack===C.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===C.stencilCompareMask.compareMask||(i.stencilFunc(zE[n.dss.stencilFuncBack],C.stencilCompareMask.reference,C.stencilCompareMask.compareMask),n.dss.stencilRefFront=C.stencilCompareMask.reference,n.dss.stencilReadMaskFront=C.stencilCompareMask.compareMask,n.dss.stencilRefBack=C.stencilCompareMask.reference,n.dss.stencilReadMaskBack=C.stencilCompareMask.compareMask)}}}}break;case DE.DRAW:var Dt=t.drawCmds.array[f];if(c&&l)if(c.gpuIndirectBuffer){if(c.gpuIndirectBuffer){var Nt=c.gpuIndirectBuffer.indirects,zt=Array.isArray(Nt),Ut=0;for(Nt=zt?Nt:Nt[Symbol.iterator]();;){var Gt;if(zt){if(Ut>=Nt.length)break;Gt=Nt[Ut++]}else{if((Ut=Nt.next()).done)break;Gt=Ut.value}var Vt=Gt,Ht=c.gpuIndexBuffer;if(Ht&&-1<Vt.indexCount){var Wt=Vt.firstIndex*Ht.stride;i.drawElements(u,Vt.indexCount,c.glIndexType,Wt)}else i.drawArrays(u,Vt.firstVertex,Vt.vertexCount)}}}else{var Xt=c.gpuIndexBuffer;if(Xt&&-1<Dt.drawInfo.indexCount){var jt=Dt.drawInfo.firstIndex*Xt.stride;i.drawElements(u,Dt.drawInfo.indexCount,c.glIndexType,jt)}else i.drawArrays(u,Dt.drawInfo.firstVertex,Dt.drawInfo.vertexCount)}break;case DE.UPDATE_BUFFER:var qt=t.updateBufferCmds.array[f];QE(e,qt.gpuBuffer,qt.buffer,qt.offset,qt.size);break;case DE.COPY_BUFFER_TO_TEXTURE:var Yt=t.copyBufferToTextureCmds.array[f];$E(e,[Yt.gpuBuffer.buffer],Yt.gpuTexture,Yt.regions)}}}function $E(e,t,i,n){var r=e.gl,a=0,s=0,o=1,l=1,c=0,u=ls[i.format],h=u.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var d=e.stateCache.glTex2DUnits[e.stateCache.texUnit];d.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),d.glTexture=i.glTexture);var f=n,p=Array.isArray(f),_=0;for(f=p?f:f[Symbol.iterator]();;){var v;if(p){if(_>=f.length)break;v=f[_++]}else{if((_=f.next()).done)break;v=_.value}var m=v;for(s=0,o=m.texExtent.width,l=m.texExtent.height,a=m.texSubres.baseMipLevel;a<m.texSubres.levelCount;++a){var y=u.type!==rs.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,a,m.texOffset.x,m.texOffset.y,o,l,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,a,i.glInternelFmt,o,l,0,y):r.texSubImage2D(r.TEXTURE_2D,a,m.texOffset.x,m.texOffset.y,o,l,i.glFormat,i.glType,y),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];g.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),g.glTexture=i.glTexture);var b=n,S=Array.isArray(b),T=0;for(b=S?b:b[Symbol.iterator]();;){var E;if(S){if(T>=b.length)break;E=b[T++]}else{if((T=b.next()).done)break;E=T.value}var x=E;s=0;var A=x.texSubres.baseArrayLayer+x.texSubres.layerCount;for(c=x.texSubres.baseArrayLayer;c<A;++c){o=x.texExtent.width,l=x.texExtent.height;var C=x.texSubres.baseMipLevel+x.texSubres.levelCount;for(a=x.texSubres.baseMipLevel;a<C;++a){var w=u.type!==rs.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,x.texOffset.x,x.texOffset.y,o,l,i.glFormat,w):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,i.glInternelFmt,o,l,0,w):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,x.texOffset.x,x.texOffset.y,o,l,i.glFormat,i.glType,w),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Fa.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var ex=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBuffer=null,t._uniformBuffer=null,t._indirectBuffer=null,t}return p(i,_E),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._usage&Jr.INDIRECT?this._indirectBuffer={drawInfos:[]}:this._usage&Jr.UNIFORM&&0<this._size&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&Jr.INDIRECT?this._gpuBuffer.indirects=this._indirectBuffer.drawInfos:this._usage&Jr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&ea.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Jr.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Jr.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Jr.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer))):(t.usage&Jr.INDIRECT||t.usage&Jr.TRANSFER_DST||t.usage&Jr.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._gpuBuffer=null),this._status=jr.UNREADY}},{key:"resize",value:function(e){var t,i,n,r,a;this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new ArrayBuffer(this._size)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=this._size,0<this._size&&(t=this._device,i=this._gpuBuffer,n=t.gl,r=t.stateCache,a=i.memUsage&ea.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW,i.usage&Jr.VERTEX?(t.useVAO&&r.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),t.stateCache.glArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,i.glBuffer),n.bufferData(n.ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):i.usage&Jr.INDEX?(t.useVAO&&r.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),r.glVAO=null),t.stateCache.glElementArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):i.usage&Jr.UNIFORM?i.buffer&&(i.vf32=new Float32Array(i.buffer)):(i.usage&Jr.INDIRECT||i.usage&Jr.TRANSFER_DST||i.usage&Jr.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),i.glTarget=n.NONE)))}},{key:"update",value:function(e,t,i){var n;n=void 0!==i?i:this._usage&Jr.INDIRECT?0:e.byteLength,QE(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),tx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.COMMAND_ALLOCATOR)))._device=void 0,t._device=e,t}return p(i,ns),i}(),ix=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new RE(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){return new e}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),nx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new ix(WE,16),t.bindStatesCmdPool=new ix(XE,16),t.drawCmdPool=new ix(jE,16),t.updateBufferCmdPool=new ix(qE,16),t.copyBufferToTextureCmdPool=new ix(YE,16),t}return p(i,tx),l(i,[{key:"initialize",value:function(e){return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),rx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).cmdPackage=new KE,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return p(i,vE),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=jr.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=jr.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(WE);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i,s.clearColors.length=n.length;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(DE.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===za.PRIMARY&&this._isInRenderPass||this._type===za.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(jE);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(DE.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===za.PRIMARY&&!this._isInRenderPass||this._type===za.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(qE);if(a){var s;s=void 0!==n?n:e.usage&Jr.INDIRECT?0:t.byteLength;var o=t;a.gpuBuffer=r,a.buffer=o,a.offset=void 0!==i?i:0,a.size=s,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(DE.UPDATE_BUFFER)}}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===za.PRIMARY&&!this._isInRenderPass||this._type===za.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(YE);s&&(s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(DE.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var d=0;d<n.cmdPackage.copyBufferToTextureCmds.length;++d){var f=n.cmdPackage.copyBufferToTextureCmds.array[d];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(XE);e&&(e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(DE.BIND_STATES),this._isStateInvalied=!1)}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),ax=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuFramebuffer=null,t}return p(i,mE),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=ls[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._isOffscreen&&this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)),this._gpuFramebuffer=null,this._status=jr.UNREADY}}]),i}(),sx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuInputAssembler=null,t}return p(i,yE),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Error index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=OE(a.format,i),c=ls[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:c,count:ls[a.format].count,stride:o.stride,componentCount:PE(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=c}}(this._device,this._gpuInputAssembler),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.OES_vertex_array_object.deleteVertexArrayOES(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=jr.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),ox=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineLayout=null,t}return p(i,gE),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}}]),i}(),lx=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],cx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineState=null,t}return p(i,Yv),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:lx[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=jr.UNREADY}}]),i}(),ux=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return p(i,bE),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;JE(this._device,s.cmdPackage),this.numDrawCalls+=s.numDrawCalls,this.numTris+=s.numTris}}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),hx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuRenderPass=null,t}return p(i,SE),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=jr.UNREADY}}]),i}(),dx=[10497,33648,33071,33071],fx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuSampler=null,t._state=new TE,t}return p(i,EE),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias);var t=0,i=0,n=this._state.minFilter,r=this._state.magFilter,a=this._state.mipFilter;t=n===Sa.LINEAR||n===Sa.ANISOTROPIC?a===Sa.LINEAR||a===Sa.ANISOTROPIC?9987:a===Sa.POINT?9985:9729:a===Sa.LINEAR||a===Sa.ANISOTROPIC?9986:a===Sa.POINT?9984:9728,i=r===Sa.LINEAR||r===Sa.ANISOTROPIC?9729:9728;var s=dx[this._state.addressU],o=dx[this._state.addressV],l=dx[this._state.addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:s,glWrapT:o,glWrapR:l},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuSampler=null,this._status=jr.UNREADY}}]),i}(),px=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuShader=null,t}return p(i,xE),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){var s=e.gl,t=function(){if(l){if(c>=o.length)return"break";u=o[c++]}else{if((c=o.next()).done)return"break";u=c.value}var e=u,t=0,i="",n=1;switch(e.type){case Ia.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case Ia.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),s.getShaderParameter(e.glShader,s.COMPILE_STATUS)||(console.error(i+" in '"+a.name+"' compilation failed."),console.error(e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null))},o=a.gpuStages,l=Array.isArray(o),c=0;e:for(o=l?o:o[Symbol.iterator]();;){var u,i=t();switch(i){case"break":break e;default:if("object"===ye(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),d=0;for(r=h?r:r[Symbol.iterator]();;){var f;if(h){if(d>=r.length)break;f=r[d++]}else{if((d=r.next()).done)break;f=d.value}var p=f;s.attachShader(a.glProgram,p.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS))console.info("Shader '"+a.name+"' compilation successed.");else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var _=a.gpuStages,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y;g.glShader&&(s.deleteShader(g.glShader),g.glShader=null)}}var b=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(b);for(var S=0;S<b;++S){var T=s.getActiveAttrib(a.glProgram,S);if(T){var E=void 0,x=T.name.indexOf("[");E=-1!==x?T.name.substr(0,x):T.name;var A=s.getAttribLocation(a.glProgram,E),C=ME(T.type,s),w=IE(T.type,s);a.glInputs[S]={binding:A,name:E,type:C,stride:w,count:T.size,size:w*T.size,glType:T.type,glLoc:A}}}if(0<a.blocks.length){a.glBlocks=new Array(a.blocks.length);for(var R=0;R<a.blocks.length;++R){var k=a.blocks[R],O={binding:k.binding,name:k.name,size:0,glUniforms:new Array(k.members.length),glActiveUniforms:[],isUniformPackage:!0};a.glBlocks[R]=O;for(var F=0;F<k.members.length;++F){var L=k.members[F],B=BE(L.type,s),M=IE(B,s),I=M*L.count,P=O.size/4,D=new Array(I/4);D.fill(0),O.glUniforms[F]={binding:-1,name:L.name,type:L.type,stride:M,count:L.count,size:I,offset:O.size,glType:B,glLoc:-1,array:D,begin:P,isFirst:!0},O.size+=I}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var N=0;N<a.samplers.length;++N){var z=a.samplers[N];a.glSamplers[N]={binding:z.binding,name:z.name,type:z.type,units:[],glType:BE(z.type,s),glLoc:-1}}}for(var U=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),G=0,V=[],H=0;H<U;++H){var W=s.getActiveUniform(a.glProgram,H);if(W){var X=s.getUniformLocation(a.glProgram,W.name);if(X){var j=void 0,q=W.name.indexOf("[");if(j=-1!==q?W.name.substr(0,q):W.name,W.type===s.SAMPLER_2D||W.type===s.SAMPLER_CUBE){var Y=a.glSamplers,K=Array.isArray(Y),Q=0;for(Y=K?Y:Y[Symbol.iterator]();;){var Z;if(K){if(Q>=Y.length)break;Z=Y[Q++]}else{if((Q=Y.next()).done)break;Z=Q.value}var J=Z;if(J.name===j){for(var $=0;$<W.size;++$)J.units.push(G+$);J.glLoc=X,G+=W.size,V.push(J);break}}}else{var ee=a.glBlocks,te=Array.isArray(ee),ie=0;for(ee=te?ee:ee[Symbol.iterator]();;){var ne;if(te){if(ie>=ee.length)break;ne=ee[ie++]}else{if((ie=ee.next()).done)break;ne=ie.value}var re=ne,ae=re.glUniforms,se=Array.isArray(ae),oe=0;for(ae=se?ae:ae[Symbol.iterator]();;){var le;if(se){if(oe>=ae.length)break;le=ae[oe++]}else{if((oe=ae.next()).done)break;le=oe.value}var ce=le;if(ce.name===j){ce.glLoc=X,re.glActiveUniforms.push(ce);break}}}}}}}if(V.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);for(var ue=0,he=V;ue<he.length;ue++){var de=he[ue];s.uniform1iv(de.glLoc,de.units)}}}}(this._device,this._gpuShader),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(!function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=jr.UNREADY}}]),i}(),_x=function e(){y(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTex2DUnits=void 0,this.glTexCubeUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glTex2DUnits=new Array(16),this.glTexCubeUnits=new Array(16),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Hv,this.dss=new Wv,this.bs=new jv,this.glEnabledAttribLocs=new Array(16),this.glCurrentAttribLocs=new Array(16),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<16;++t)this.glTex2DUnits[t]={glTexture:null},this.glTexCubeUnits[t]={glTexture:null}};function vx(e){return 0<e&&0==(e&e-1)}var mx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTexture=null,t}return p(i,AE),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=vx(this._width)&&vx(this._height),this._size=us(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&Fa.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case Aa.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?Ba.TV1D:Ba.TV1D_ARRAY:Ba.TV1D;break;case Aa.TEX2D:var i=Fa.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?Ba.TV2D:i&Fa.CUBEMAP?Ba.CUBE:Ba.TV2D_ARRAY:Ba.TV2D;break;case Aa.TEX3D:t=Ba.TV3D;break;default:t=Ba.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;switch(t.glInternelFmt=FE(t.format,i),t.glFormat=LE(t.format,i),t.glType=OE(t.format,i),t.viewType){case Ba.TV2D:if(t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===ka.X1){var n=i.createTexture();if(n&&0<t.size){t.glTexture=n;var r=e.stateCache.glTex2DUnits[e.stateCache.texUnit];r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture);var a=t.width,s=t.height;if(ls[t.format].isCompressed)if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=cs(t.format,a,s,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,a,s,0,c),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else{var u=cs(t.format,2,2,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,h)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternelFmt,a,s,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}}break;case Ba.CUBE:t.viewType=Ba.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var f=i.createTexture();if(f&&0<t.size){t.glTexture=f;var p=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(p.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),p.glTexture=t.glTexture),ls[t.format].isCompressed)if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var _=0;_<6;++_)for(var v=t.width,m=t.height,y=0;y<t.mipLevel;++y){var g=cs(t.format,v,m,1),b=new Uint8Array(g);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+_,y,t.glInternelFmt,v,m,0,b),v=Math.max(1,v>>1),m=Math.max(1,m>>1)}else for(var S=0;S<6;++S){var T=cs(t.format,2,2,1),E=new Uint8Array(T);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+S,0,t.glInternelFmt,2,2,0,E)}else for(var x=0;x<6;++x)for(var A=t.width,C=t.height,w=0;w<t.mipLevel;++w)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+x,w,t.glInternelFmt,A,C,0,t.glFormat,t.glType,null),A=Math.max(1,A>>1),C=Math.max(1,C>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._gpuTexture=null),this._status=jr.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._size=us(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;switch(t.glInternelFmt=FE(t.format,i),t.glFormat=LE(t.format,i),t.glType=OE(t.format,i),t.viewType){case Ba.TV2D:if(t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===ka.X1){var n=e.stateCache.glTex2DUnits[e.stateCache.texUnit];n.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),n.glTexture=t.glTexture);var r=t.width,a=t.height;if(ls[t.format].isCompressed){if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var o=cs(t.format,r,a,1),l=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternelFmt,r,a,0,l),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,r,a,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}break;case Ba.CUBE:t.viewType=Ba.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var u=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),u.glTexture=t.glTexture),ls[t.format].isCompressed){if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var h=0;h<6;++h)for(var d=t.width,f=t.height,p=0;p<t.mipLevel;++p){var _=cs(t.format,d,f,1),v=new Uint8Array(_);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+h,p,t.glInternelFmt,d,f,0,v),d=Math.max(1,d>>1),f=Math.max(1,f>>1)}}else for(var m=0;m<6;++m)for(var y=t.width,g=t.height,b=0;b<t.mipLevel;++b)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+m,b,t.glInternelFmt,y,g,0,t.glFormat,t.glType,null),y=Math.max(1,y>>1),g=Math.max(1,g>>1);break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture)),this._status=jr.UNREADY}}]),i}(),yx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTextureView=null,t}return p(i,Wf),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=jr.UNREADY}}]),i}(),gx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,Wr.WINDOW)))._device=void 0,t._title="",t._left=0,t._top=0,t._width=0,t._height=0,t._nativeWidth=0,t._nativeHeight=0,t._colorFmt=Kt.GFXFormat.UNKNOWN,t._depthStencilFmt=Kt.GFXFormat.UNKNOWN,t._isOffscreen=!1,t._renderPass=null,t._colorTex=null,t._colorTexView=null,t._depthStencilTex=null,t._depthStencilTexView=null,t._framebuffer=null,t._device=e,t}return p(i,ns),l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"detphStencilFormat",get:function(){return this._depthStencilFmt}},{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTexView",get:function(){return this._colorTexView}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"framebuffer",get:function(){return this._framebuffer}}]),i}(),bx=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return p(t,gx),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ga.CLEAR,storeOp:Ha.STORE,sampleCount:1,beginLayout:Xa.COLOR_ATTACHMENT_OPTIMAL,endLayout:Xa.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ga.CLEAR,depthStoreOp:Ha.STORE,stencilLoadOp:Ga.CLEAR,stencilStoreOp:Ha.STORE,sampleCount:1,beginLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==Kt.GFXFormat.UNKNOWN&&(this._colorTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Fa.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:Ba.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==Kt.GFXFormat.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Fa.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=jr.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:Ba.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),Sx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).stateCache=new _x,e.nullTex2D=null,e.nullTexCube=null,e._webGLRC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!1,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._EXT_frag_depth=null,e._EXT_shader_texture_lod=null,e._EXT_sRGB=null,e._OES_vertex_array_object=null,e._EXT_color_buffer_half_float=null,e._WEBGL_color_buffer_float=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_astc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_shaders=null,e._WEBGL_draw_buffers=null,e._WEBGL_lose_context=null,e._WEBGL_depth_texture=null,e._WEBGL_debug_renderer_info=null,e._OES_texture_half_float=null,e._OES_texture_half_float_linear=null,e._OES_texture_float=null,e._OES_texture_float_linear=null,e._OES_standard_derivatives=null,e._OES_element_index_uint=null,e._ANGLE_instanced_arrays=null,e}return p(t,ks),l(t,[{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=ds.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=i.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=Kt.GFXFormat.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Kt.GFXFormat.D24S8:this._depthStencilFmt=Kt.GFXFormat.D24:8===this._stencilBits?this._depthStencilFmt=Kt.GFXFormat.D16S8:this._depthStencilFmt=Kt.GFXFormat.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=i.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=i.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=i.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=i.getExtension("EXT_sRGB"),this._OES_vertex_array_object=i.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=i.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=i.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=i.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=i.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=i.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=i.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=i.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=i.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=i.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=i.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=i.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=i.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=i.getExtension("OES_texture_float"),this._OES_texture_float_linear=i.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=i.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=i.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=i.getExtension("ANGLE_instanced_arrays"),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[ps.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[ps.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[ps.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[ps.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[ps.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[ps.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._WEBGL_depth_texture&&(this._features[ps.FORMAT_D24S8]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[ps.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[ps.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[ps.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[ps.FORMAT_PVRTC]=!0,l+="pvrtc "),this._features[ps.MSAA]=!1,this._OES_vertex_array_object&&(this._useVAO=!1),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:$a.GRAPHICS}),this._mainWindow=this.createWindow({title:this._webGLRC.canvas.title,left:this._webGLRC.canvas.offsetLeft,top:this._webGLRC.canvas.offsetTop,width:this._webGLRC.drawingBufferWidth,height:this._webGLRC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new mx(this),this.nullTex2D.initialize({type:Aa.TEX2D,usage:wa.SAMPLED,format:Kt.GFXFormat.RGBA8,width:2,height:2,flags:Fa.GEN_MIPMAP}),this.nullTexCube=new mx(this),this.nullTexCube.initialize({type:Aa.TEX2D,usage:wa.SAMPLED,format:Kt.GFXFormat.RGBA8,width:2,height:2,arrayLayer:6,flags:Fa.CUBEMAP|Fa.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new ex(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new mx(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new yx(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new fx(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new wE(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new px(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new sx(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new hx(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new ax(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new ox(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new cx(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new nx(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new rx(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new ux(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new bx(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){$E(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=0,s=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:var l=e.stateCache.glTex2DUnits[e.stateCache.texUnit];l.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),l.glTexture=i.glTexture);var c=n,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;for(a=f.texSubres.baseMipLevel;a<f.texSubres.levelCount;++a)r.texSubImage2D(r.TEXTURE_2D,a,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[s++])}break;case r.TEXTURE_CUBE_MAP:var p=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];p.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),p.glTexture=i.glTexture);var _=n,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y,b=g.texSubres.baseArrayLayer+g.texSubres.layerCount;for(o=g.texSubres.baseArrayLayer;o<b;++o){var S=g.texSubres.baseMipLevel+g.texSubres.levelCount;for(a=g.texSubres.baseMipLevel;a<S;++a)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,g.texOffset.x,g.texOffset.y,i.glFormat,i.glType,t[s++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Fa.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u,d=h.buffOffset+h.buffTexHeight*h.buffStride,f=h.texExtent.width,p=h.texExtent.height,_=cs(Kt.GFXFormat.RGBA8,f,p,1),v=s.subarray(d,d+_);n.readPixels(h.texOffset.x,h.texOffset.y,f,p,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}(),Tx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBindingLayout=null,t}return p(i,CE),l(i,[{key:"gpuBindingLayout",get:function(){return this._gpuBindingLayout}}]),l(i,[{key:"initialize",value:function(e){this._bindingUnits=new Array(e.bindings.length);for(var t=0;t<e.bindings.length;++t){var i=e.bindings[t];this._bindingUnits[t]={binding:i.binding,type:i.type,name:i.name,buffer:null,texView:null,sampler:null}}this._gpuBindingLayout={gpuBindings:new Array(e.bindings.length)};for(var n=0;n<e.bindings.length;++n){var r=e.bindings[n];this._gpuBindingLayout.gpuBindings[n]={binding:r.binding,type:r.type,name:r.name,gpuBuffer:null,gpuTexView:null,gpuSampler:null}}return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuBindingLayout=null,this._status=jr.UNREADY}},{key:"update",value:function(){if(this._isDirty&&this._gpuBindingLayout){for(var e=0;e<this._bindingUnits.length;++e){var t=this._bindingUnits[e];switch(t.type){case Da.UNIFORM_BUFFER:t.buffer&&(this._gpuBindingLayout.gpuBindings[e].gpuBuffer=t.buffer.gpuBuffer);break;case Da.SAMPLER:t.texView&&(this._gpuBindingLayout.gpuBindings[e].gpuTexView=t.texView.gpuTextureView),t.sampler&&(this._gpuBindingLayout.gpuBindings[e].gpuSampler=t.sampler.gpuSampler)}}this._isDirty=!1}}}]),i}(),Ex=[WebGLRenderingContext.REPEAT,WebGLRenderingContext.MIRRORED_REPEAT,WebGLRenderingContext.CLAMP_TO_EDGE,WebGLRenderingContext.CLAMP_TO_EDGE],xx=[1,2,4,8,16,32,64],Ax=new Float32Array(4);function Cx(e,t){switch(e){case Kt.GFXFormat.R8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.R8SN:return t.BYTE;case Kt.GFXFormat.R8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.R8I:return t.BYTE;case Kt.GFXFormat.R16F:return t.HALF_FLOAT;case Kt.GFXFormat.R16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.R16I:return t.SHORT;case Kt.GFXFormat.R32F:return t.FLOAT;case Kt.GFXFormat.R32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.R32I:return t.INT;case Kt.GFXFormat.RG8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RG8SN:return t.BYTE;case Kt.GFXFormat.RG8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RG8I:return t.BYTE;case Kt.GFXFormat.RG16F:return t.HALF_FLOAT;case Kt.GFXFormat.RG16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RG16I:return t.SHORT;case Kt.GFXFormat.RG32F:return t.FLOAT;case Kt.GFXFormat.RG32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RG32I:return t.INT;case Kt.GFXFormat.RGB8:case Kt.GFXFormat.SRGB8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGB8SN:return t.BYTE;case Kt.GFXFormat.RGB8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGB8I:return t.BYTE;case Kt.GFXFormat.RGB16F:return t.HALF_FLOAT;case Kt.GFXFormat.RGB16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RGB16I:return t.SHORT;case Kt.GFXFormat.RGB32F:return t.FLOAT;case Kt.GFXFormat.RGB32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RGB32I:return t.INT;case Kt.GFXFormat.RGBA8:case Kt.GFXFormat.SRGB8_A8:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGBA8SN:return t.BYTE;case Kt.GFXFormat.RGBA8UI:return t.UNSIGNED_BYTE;case Kt.GFXFormat.RGBA8I:return t.BYTE;case Kt.GFXFormat.RGBA16F:return t.HALF_FLOAT;case Kt.GFXFormat.RGBA16UI:return t.UNSIGNED_SHORT;case Kt.GFXFormat.RGBA16I:return t.SHORT;case Kt.GFXFormat.RGBA32F:return t.FLOAT;case Kt.GFXFormat.RGBA32UI:return t.UNSIGNED_INT;case Kt.GFXFormat.RGBA32I:return t.INT;case Kt.GFXFormat.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Kt.GFXFormat.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Kt.GFXFormat.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Kt.GFXFormat.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Kt.GFXFormat.RGB10A2:case Kt.GFXFormat.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Kt.GFXFormat.RGB9E5:return t.FLOAT;case Kt.GFXFormat.D16:case Kt.GFXFormat.D16S8:return t.UNSIGNED_SHORT;case Kt.GFXFormat.D24:return t.UNSIGNED_INT;case Kt.GFXFormat.D24S8:return t.UNSIGNED_INT_24_8;case Kt.GFXFormat.D32F:return t.FLOAT;case Kt.GFXFormat.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case Kt.GFXFormat.BC1:case Kt.GFXFormat.BC1_SRGB:case Kt.GFXFormat.BC2:case Kt.GFXFormat.BC2_SRGB:case Kt.GFXFormat.BC3:case Kt.GFXFormat.BC3_SRGB:case Kt.GFXFormat.BC4:return t.UNSIGNED_BYTE;case Kt.GFXFormat.BC4_SNORM:return t.BYTE;case Kt.GFXFormat.BC5:return t.UNSIGNED_BYTE;case Kt.GFXFormat.BC5_SNORM:return t.BYTE;case Kt.GFXFormat.BC6H_SF16:case Kt.GFXFormat.BC6H_UF16:return t.FLOAT;case Kt.GFXFormat.BC7:case Kt.GFXFormat.BC7_SRGB:case Kt.GFXFormat.ETC_RGB8:case Kt.GFXFormat.ETC2_RGB8:case Kt.GFXFormat.ETC2_SRGB8:case Kt.GFXFormat.ETC2_RGB8_A1:case Kt.GFXFormat.ETC2_SRGB8_A1:case Kt.GFXFormat.ETC2_RGB8:case Kt.GFXFormat.ETC2_SRGB8:case Kt.GFXFormat.EAC_R11:return t.UNSIGNED_BYTE;case Kt.GFXFormat.EAC_R11SN:return t.BYTE;case Kt.GFXFormat.EAC_RG11:return t.UNSIGNED_BYTE;case Kt.GFXFormat.EAC_RG11SN:return t.BYTE;case Kt.GFXFormat.PVRTC_RGB2:case Kt.GFXFormat.PVRTC_RGBA2:case Kt.GFXFormat.PVRTC_RGB4:case Kt.GFXFormat.PVRTC_RGBA4:case Kt.GFXFormat.PVRTC2_2BPP:case Kt.GFXFormat.PVRTC2_4BPP:default:return t.UNSIGNED_BYTE}}function Rx(e,t){switch(e){case Kt.GFXFormat.A8:return t.ALPHA;case Kt.GFXFormat.L8:return t.LUMINANCE;case Kt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Kt.GFXFormat.R8:return t.R8;case Kt.GFXFormat.R8SN:return t.R8_SNORM;case Kt.GFXFormat.R8UI:return t.R8UI;case Kt.GFXFormat.R8I:return t.R8I;case Kt.GFXFormat.RG8:return t.RG8;case Kt.GFXFormat.RG8SN:return t.RG8_SNORM;case Kt.GFXFormat.RG8UI:return t.RG8UI;case Kt.GFXFormat.RG8I:return t.RG8I;case Kt.GFXFormat.RGB8:return t.RGB8;case Kt.GFXFormat.RGB8SN:return t.RGB8_SNORM;case Kt.GFXFormat.RGB8UI:return t.RGB8UI;case Kt.GFXFormat.RGB8I:return t.RGB8I;case Kt.GFXFormat.RGBA8:return t.RGBA8;case Kt.GFXFormat.RGBA8SN:return t.RGBA8_SNORM;case Kt.GFXFormat.RGBA8UI:return t.RGBA8UI;case Kt.GFXFormat.RGBA8I:return t.RGBA8I;case Kt.GFXFormat.R16I:return t.R16I;case Kt.GFXFormat.R16UI:return t.R16UI;case Kt.GFXFormat.R16F:return t.R16F;case Kt.GFXFormat.RG16I:return t.RG16I;case Kt.GFXFormat.RG16UI:return t.RG16UI;case Kt.GFXFormat.RG16F:return t.RG16F;case Kt.GFXFormat.RGB16I:return t.RGB16I;case Kt.GFXFormat.RGB16UI:return t.RGB16UI;case Kt.GFXFormat.RGB16F:return t.RGB16F;case Kt.GFXFormat.RGBA16I:return t.RGBA16I;case Kt.GFXFormat.RGBA16UI:return t.RGBA16UI;case Kt.GFXFormat.RGBA16F:return t.RGBA16F;case Kt.GFXFormat.R32I:return t.R32I;case Kt.GFXFormat.R32UI:return t.R32UI;case Kt.GFXFormat.R32F:return t.R32F;case Kt.GFXFormat.RG32I:return t.RG32I;case Kt.GFXFormat.RG32UI:return t.RG32UI;case Kt.GFXFormat.RG32F:return t.RG32F;case Kt.GFXFormat.RGB32I:return t.RGB32I;case Kt.GFXFormat.RGB32UI:return t.RGB32UI;case Kt.GFXFormat.RGB32F:return t.RGB32F;case Kt.GFXFormat.RGBA32I:return t.RGBA32I;case Kt.GFXFormat.RGBA32UI:return t.RGBA32UI;case Kt.GFXFormat.RGBA32F:return t.RGBA32F;case Kt.GFXFormat.R5G6B5:return t.RGB565;case Kt.GFXFormat.RGB5A1:return t.RGB5_A1;case Kt.GFXFormat.RGBA4:return t.RGBA4;case Kt.GFXFormat.RGB10A2:return t.RGB10_A2;case Kt.GFXFormat.RGB10A2UI:return t.RGB10_A2UI;case Kt.GFXFormat.R11G11B10F:return t.R11F_G11F_B10F;case Kt.GFXFormat.D16:return t.DEPTH_COMPONENT16;case Kt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D24:return t.DEPTH_COMPONENT24;case Kt.GFXFormat.D24S8:return t.DEPTH24_STENCIL8;case Kt.GFXFormat.D32F:return t.DEPTH_COMPONENT32F;case Kt.GFXFormat.D32F_S8:return t.DEPTH32F_STENCIL8;case Kt.GFXFormat.BC1:return oE.COMPRESSED_RGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_ALPHA:return oE.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB:return oE.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB_ALPHA:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC2:return oE.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC2_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC3:return oE.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Kt.GFXFormat.BC3_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Kt.GFXFormat.ETC_RGB8:return oE.COMPRESSED_RGB_ETC1_WEBGL;case Kt.GFXFormat.ETC2_RGB8:return oE.COMPRESSED_RGB8_ETC2;case Kt.GFXFormat.ETC2_SRGB8:return oE.COMPRESSED_SRGB8_ETC2;case Kt.GFXFormat.ETC2_RGB8_A1:return oE.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Kt.GFXFormat.ETC2_SRGB8_A1:return oE.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Kt.GFXFormat.ETC2_RGBA8:return oE.COMPRESSED_RGBA8_ETC2_EAC;case Kt.GFXFormat.ETC2_SRGB8_A8:return oE.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Kt.GFXFormat.EAC_R11:return oE.COMPRESSED_R11_EAC;case Kt.GFXFormat.EAC_R11SN:return oE.COMPRESSED_SIGNED_R11_EAC;case Kt.GFXFormat.EAC_RG11:return oE.COMPRESSED_RG11_EAC;case Kt.GFXFormat.EAC_RG11SN:return oE.COMPRESSED_SIGNED_RG11_EAC;case Kt.GFXFormat.PVRTC_RGB2:return oE.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA2:return oE.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGB4:return oE.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA4:return oE.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function kx(e,t){switch(e){case Kt.GFXFormat.A8:return t.ALPHA;case Kt.GFXFormat.L8:return t.LUMINANCE;case Kt.GFXFormat.LA8:return t.LUMINANCE_ALPHA;case Kt.GFXFormat.R8:case Kt.GFXFormat.R8SN:return t.RED;case Kt.GFXFormat.R8UI:case Kt.GFXFormat.R8I:return t.RED;case Kt.GFXFormat.RG8:case Kt.GFXFormat.RG8SN:case Kt.GFXFormat.RG8UI:case Kt.GFXFormat.RG8I:return t.RG;case Kt.GFXFormat.RGB8:case Kt.GFXFormat.RGB8SN:case Kt.GFXFormat.RGB8UI:case Kt.GFXFormat.RGB8I:return t.RGB;case Kt.GFXFormat.RGBA8:case Kt.GFXFormat.RGBA8SN:case Kt.GFXFormat.RGBA8UI:case Kt.GFXFormat.RGBA8I:return t.RGBA;case Kt.GFXFormat.R16UI:case Kt.GFXFormat.R16I:case Kt.GFXFormat.R16F:return t.RED;case Kt.GFXFormat.RG16UI:case Kt.GFXFormat.RG16I:case Kt.GFXFormat.RG16F:return t.RG;case Kt.GFXFormat.RGB16UI:case Kt.GFXFormat.RGB16I:case Kt.GFXFormat.RGB16F:return t.RGB;case Kt.GFXFormat.RGBA16UI:case Kt.GFXFormat.RGBA16I:case Kt.GFXFormat.RGBA16F:return t.RGBA;case Kt.GFXFormat.R32UI:case Kt.GFXFormat.R32I:case Kt.GFXFormat.R32F:return t.RED;case Kt.GFXFormat.RG32UI:case Kt.GFXFormat.RG32I:case Kt.GFXFormat.RG32F:return t.RG;case Kt.GFXFormat.RGB32UI:case Kt.GFXFormat.RGB32I:case Kt.GFXFormat.RGB32F:return t.RGB;case Kt.GFXFormat.RGBA32UI:case Kt.GFXFormat.RGBA32I:case Kt.GFXFormat.RGBA32F:case Kt.GFXFormat.RGB10A2:return t.RGBA;case Kt.GFXFormat.R11G11B10F:case Kt.GFXFormat.R5G6B5:return t.RGB;case Kt.GFXFormat.RGB5A1:case Kt.GFXFormat.RGBA4:return t.RGBA;case Kt.GFXFormat.D16:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D16S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D24:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D24S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.D32F:return t.DEPTH_COMPONENT;case Kt.GFXFormat.D32F_S8:return t.DEPTH_STENCIL;case Kt.GFXFormat.BC1:return oE.COMPRESSED_RGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_ALPHA:return oE.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB:return oE.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Kt.GFXFormat.BC1_SRGB_ALPHA:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Kt.GFXFormat.BC2:return oE.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC2_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Kt.GFXFormat.BC3:return oE.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Kt.GFXFormat.BC3_SRGB:return oE.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Kt.GFXFormat.ETC_RGB8:return oE.COMPRESSED_RGB_ETC1_WEBGL;case Kt.GFXFormat.PVRTC_RGB2:return oE.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA2:return oE.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGB4:return oE.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Kt.GFXFormat.PVRTC_RGBA4:return oE.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function Ox(e,t){switch(e){case Kr.BOOL:return t.BOOL;case Kr.BOOL2:return t.BOOL_VEC2;case Kr.BOOL3:return t.BOOL_VEC3;case Kr.BOOL4:return t.BOOL_VEC4;case Kr.INT:return t.INT;case Kr.INT2:return t.INT_VEC2;case Kr.INT3:return t.INT_VEC3;case Kr.INT4:return t.INT_VEC4;case Kr.UINT:return t.UNSIGNED_INT;case Kr.FLOAT:return t.FLOAT;case Kr.FLOAT2:return t.FLOAT_VEC2;case Kr.FLOAT3:return t.FLOAT_VEC3;case Kr.FLOAT4:return t.FLOAT_VEC4;case Kr.MAT2:return t.FLOAT_MAT2;case Kr.MAT2X3:return t.FLOAT_MAT2x3;case Kr.MAT2X4:return t.FLOAT_MAT2x4;case Kr.MAT3X2:return t.FLOAT_MAT3x2;case Kr.MAT3:return t.FLOAT_MAT3;case Kr.MAT3X4:return t.FLOAT_MAT3x4;case Kr.MAT4X2:return t.FLOAT_MAT4x2;case Kr.MAT4X3:return t.FLOAT_MAT4x3;case Kr.MAT4:return t.FLOAT_MAT4;case Kr.SAMPLER2D:return t.SAMPLER_2D;case Kr.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Kr.SAMPLER3D:return t.SAMPLER_3D;case Kr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Kr.UNKNOWN}}function Fx(e,t){switch(e){case t.BOOL:return Kr.BOOL;case t.BOOL_VEC2:return Kr.BOOL2;case t.BOOL_VEC3:return Kr.BOOL3;case t.BOOL_VEC4:return Kr.BOOL4;case t.INT:return Kr.INT;case t.INT_VEC2:return Kr.INT2;case t.INT_VEC3:return Kr.INT3;case t.INT_VEC4:return Kr.INT4;case t.UNSIGNED_INT:return Kr.UINT;case t.UNSIGNED_INT_VEC2:return Kr.UINT2;case t.UNSIGNED_INT_VEC3:return Kr.UINT3;case t.UNSIGNED_INT_VEC4:return Kr.UINT4;case t.UNSIGNED_INT:return Kr.UINT;case t.FLOAT:return Kr.FLOAT;case t.FLOAT_VEC2:return Kr.FLOAT2;case t.FLOAT_VEC3:return Kr.FLOAT3;case t.FLOAT_VEC4:return Kr.FLOAT4;case t.FLOAT_MAT2:return Kr.MAT2;case t.FLOAT_MAT2x3:return Kr.MAT2X3;case t.FLOAT_MAT2x4:return Kr.MAT2X4;case t.FLOAT_MAT3x2:return Kr.MAT3X2;case t.FLOAT_MAT3:return Kr.MAT3;case t.FLOAT_MAT3x4:return Kr.MAT3X4;case t.FLOAT_MAT4x2:return Kr.MAT4X2;case t.FLOAT_MAT4x3:return Kr.MAT4X3;case t.FLOAT_MAT4:return Kr.MAT4;case t.SAMPLER_2D:return Kr.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Kr.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Kr.SAMPLER3D;case t.SAMPLER_CUBE:return Kr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Kr.UNKNOWN}}function Lx(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Bx(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var Mx,Ix,Px=[512,513,514,515,516,517,518,519],Dx=[0,7680,7681,7682,7683,5386,34055,34056],Nx=[32774,32778,32779,32774,32774],zx=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];(Ix=Mx||(Mx={}))[Ix.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",Ix[Ix.END_RENDER_PASS=1]="END_RENDER_PASS",Ix[Ix.BIND_STATES=2]="BIND_STATES",Ix[Ix.DRAW=3]="DRAW",Ix[Ix.UPDATE_BUFFER=4]="UPDATE_BUFFER",Ix[Ix.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",Ix[Ix.COUNT=6]="COUNT";var Ux=function e(t){y(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},Gx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Mx.BEGIN_RENDER_PASS))).gpuFramebuffer=null,e.renderArea={x:0,y:0,width:0,height:0},e.clearFlag=ts.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return p(t,Ux),l(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors=[]}}]),t}(),Vx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Mx.BIND_STATES))).gpuPipelineState=null,e.gpuBindingLayout=null,e.gpuInputAssembler=null,e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=null,e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return p(t,Ux),l(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuBindingLayout=null,this.gpuInputAssembler=null,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=null,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(),Hx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Mx.DRAW))).drawInfo={vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0},e}return p(t,Ux),l(t,[{key:"clear",value:function(){}}]),t}(),Wx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Mx.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return p(t,Ux),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(),Xx=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this,Mx.COPY_BUFFER_TO_TEXTURE))).gpuBuffer=null,e.gpuTexture=null,e.dstLayout=null,e.regions=[],e}return p(t,Ux),l(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.gpuTexture=null,this.dstLayout=null,this.regions=[]}}]),t}(),jx=function(){function e(){y(this,e),this.cmds=new RE(1),this.beginRenderPassCmds=new RE(1),this.bindStatesCmds=new RE(1),this.drawCmds=new RE(1),this.updateBufferCmds=new RE(1),this.copyBufferToTextureCmds=new RE(1)}return l(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function qx(e,t,i,n,r){if(t.usage&Jr.INDIRECT)t.indirects=i.drawInfos;else{var a=i,s=e.gl,o=e.stateCache;switch(t.glTarget){case s.ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ARRAY_BUFFER,t.glBuffer),o.glArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.ELEMENT_ARRAY_BUFFER:o.glVAO&&(s.bindVertexArray(null),o.glVAO=null),o.glElementArrayBuffer!==t.glBuffer&&(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t.glBuffer),o.glElementArrayBuffer=t.glBuffer),r===a.byteLength?s.bufferSubData(t.glTarget,n,a):s.bufferSubData(t.glTarget,n,a.slice(0,r));break;case s.UNIFORM_BUFFER:var l;o.glUniformBuffer!==t.glBuffer&&(s.bindBuffer(s.UNIFORM_BUFFER,t.glBuffer),o.glUniformBuffer=t.glBuffer),r===(l=i instanceof Float32Array?i:new Float32Array(i,0,r/4)).byteLength?s.bufferSubData(t.glTarget,n,l):s.bufferSubData(t.glTarget,n,new Float32Array(a,0,r/4));break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}}}var Yx=new Array(Mx.COUNT);function Kx(e,t){var i=e.gl,n=e.stateCache;Yx.fill(0);for(var r=null,a=null,s=null,o=i.TRIANGLES,l=0;l<t.cmds.length;++l){var c=t.cmds.array[l],u=Yx[c]++;switch(c){case Mx.BEGIN_RENDER_PASS:var h=t.beginRenderPassCmds.array[u],d=0;if(h.gpuFramebuffer){n.glFramebuffer!==h.gpuFramebuffer.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,h.gpuFramebuffer.glFramebuffer),n.glFramebuffer=h.gpuFramebuffer.glFramebuffer),n.viewport.left===h.renderArea.x&&n.viewport.top===h.renderArea.y&&n.viewport.width===h.renderArea.width&&n.viewport.height===h.renderArea.height||(i.viewport(h.renderArea.x,h.renderArea.y,h.renderArea.width,h.renderArea.height),n.viewport.left=h.renderArea.x,n.viewport.top=h.renderArea.y,n.viewport.width=h.renderArea.width,n.viewport.height=h.renderArea.height),n.scissorRect.x===h.renderArea.x&&n.scissorRect.y===h.renderArea.y&&n.scissorRect.width===h.renderArea.width&&n.scissorRect.height===h.renderArea.height||(i.scissor(h.renderArea.x,h.renderArea.y,h.renderArea.width,h.renderArea.height),n.scissorRect.x=h.renderArea.x,n.scissorRect.y=h.renderArea.y,n.scissorRect.width=h.renderArea.width,n.scissorRect.height=h.renderArea.height);for(var f=h.gpuFramebuffer.gpuRenderPass,p=[],_=0;_<h.clearColors.length;++_){var v=f.colorAttachments[_];if(v.format!==Kt.GFXFormat.UNKNOWN)switch(v.loadOp){case Ga.LOAD:break;case Ga.CLEAR:if(h.clearFlag&ts.COLOR)if(n.bs.targets[0].blendColorMask!==ga.ALL&&i.colorMask(!0,!0,!0,!0),h.gpuFramebuffer.isOffscreen)Ax[0]=h.clearColors[_].r,Ax[1]=h.clearColors[_].g,Ax[2]=h.clearColors[_].b,Ax[3]=h.clearColors[_].a,i.clearBufferfv(i.COLOR,_,Ax);else{var m=h.clearColors[0];i.clearColor(m.r,m.g,m.b,m.a),d|=i.COLOR_BUFFER_BIT}break;case Ga.DISCARD:p.push(i.COLOR_ATTACHMENT0+_)}}if(f.depthStencilAttachment&&f.depthStencilAttachment.format!==Kt.GFXFormat.UNKNOWN){switch(f.depthStencilAttachment.depthLoadOp){case Ga.LOAD:break;case Ga.CLEAR:h.clearFlag&ts.DEPTH&&(n.dss.depthWrite||i.depthMask(!0),i.clearDepth(h.clearDepth),d|=i.DEPTH_BUFFER_BIT);break;case Ga.DISCARD:p.push(i.DEPTH_ATTACHMENT)}if(ls[f.depthStencilAttachment.format].hasStencil)switch(f.depthStencilAttachment.stencilLoadOp){case Ga.LOAD:break;case Ga.CLEAR:h.clearFlag&ts.STENCIL&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,4294967295),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,4294967295),i.clearStencil(h.clearStencil),d|=i.STENCIL_BUFFER_BIT);break;case Ga.DISCARD:p.push(i.STENCIL_ATTACHMENT)}}if(p.length&&i.invalidateFramebuffer(i.FRAMEBUFFER,p),d&&i.clear(d),d&i.COLOR_BUFFER_BIT){var y=n.bs.targets[0].blendColorMask;if(y!==ga.ALL){var g=(y&ga.R)!==ga.NONE,b=(y&ga.G)!==ga.NONE,S=(y&ga.B)!==ga.NONE,T=(y&ga.A)!==ga.NONE;i.colorMask(g,b,S,T)}}d&i.DEPTH_BUFFER_BIT&&!n.dss.depthWrite&&i.depthMask(!1),d&i.STENCIL_BUFFER_BIT&&(n.dss.stencilWriteMaskFront||i.stencilMaskSeparate(i.FRONT,0),n.dss.stencilWriteMaskBack||i.stencilMaskSeparate(i.BACK,0))}break;case Mx.END_RENDER_PASS:break;case Mx.BIND_STATES:var E=t.bindStatesCmds.array[u];if(E.gpuPipelineState){if(r=E.gpuPipelineState,o=E.gpuPipelineState.glPrimitive,E.gpuPipelineState.gpuShader){var x=E.gpuPipelineState.gpuShader.glProgram;n.glProgram!==x&&(i.useProgram(x),n.glProgram=x),a=E.gpuPipelineState.gpuShader}var A=E.gpuPipelineState.rs;if(A){if(n.rs.cullMode!==A.cullMode){switch(A.cullMode){case ca.NONE:i.disable(i.CULL_FACE);break;case ca.FRONT:i.enable(i.CULL_FACE),i.cullFace(i.FRONT);break;case ca.BACK:i.enable(i.CULL_FACE),i.cullFace(i.BACK)}e.stateCache.rs.cullMode=A.cullMode}e.stateCache.rs.isFrontFaceCCW!==A.isFrontFaceCCW&&(i.frontFace(A.isFrontFaceCCW?i.CCW:i.CW),e.stateCache.rs.isFrontFaceCCW=A.isFrontFaceCCW),e.stateCache.rs.depthBias===A.depthBias&&e.stateCache.rs.depthBiasSlop===A.depthBiasSlop||(i.polygonOffset(A.depthBias,A.depthBiasSlop),e.stateCache.rs.depthBias=A.depthBias,e.stateCache.rs.depthBiasSlop=A.depthBiasSlop),e.stateCache.rs.lineWidth!==A.lineWidth&&(i.lineWidth(A.lineWidth),e.stateCache.rs.lineWidth=A.lineWidth)}var C=E.gpuPipelineState.dss;C&&(n.dss.depthTest!==C.depthTest&&(C.depthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.dss.depthTest=C.depthTest),n.dss.depthWrite!==C.depthWrite&&(i.depthMask(C.depthWrite),n.dss.depthWrite=C.depthWrite),n.dss.depthFunc!==C.depthFunc&&(i.depthFunc(Px[C.depthFunc]),n.dss.depthFunc=C.depthFunc),n.dss.stencilTestFront===C.stencilTestFront&&n.dss.stencilTestBack===C.stencilTestBack||(C.stencilTestFront||C.stencilTestBack?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.dss.stencilTestFront=C.stencilTestFront,n.dss.stencilTestBack=C.stencilTestBack),n.dss.stencilFuncFront===C.stencilFuncFront&&n.dss.stencilRefFront===C.stencilRefFront&&n.dss.stencilReadMaskFront===C.stencilReadMaskFront||(i.stencilFuncSeparate(i.FRONT,Px[C.stencilFuncFront],C.stencilRefFront,C.stencilReadMaskFront),n.dss.stencilFuncFront=C.stencilFuncFront,n.dss.stencilRefFront=C.stencilRefFront,n.dss.stencilReadMaskFront=C.stencilReadMaskFront),n.dss.stencilFailOpFront===C.stencilFailOpFront&&n.dss.stencilZFailOpFront===C.stencilZFailOpFront&&n.dss.stencilPassOpFront===C.stencilPassOpFront||(i.stencilOpSeparate(i.FRONT,Dx[C.stencilFailOpFront],Dx[C.stencilZFailOpFront],Dx[C.stencilPassOpFront]),n.dss.stencilFailOpFront=C.stencilFailOpFront,n.dss.stencilZFailOpFront=C.stencilZFailOpFront,n.dss.stencilPassOpFront=C.stencilPassOpFront),n.dss.stencilWriteMaskFront!==C.stencilWriteMaskFront&&(i.stencilMaskSeparate(i.FRONT,C.stencilWriteMaskFront),n.dss.stencilWriteMaskFront=C.stencilWriteMaskFront),n.dss.stencilFuncBack===C.stencilFuncBack&&n.dss.stencilRefBack===C.stencilRefBack&&n.dss.stencilReadMaskBack===C.stencilReadMaskBack||(i.stencilFuncSeparate(i.BACK,Px[C.stencilFuncBack],C.stencilRefBack,C.stencilReadMaskBack),n.dss.stencilFuncBack=C.stencilFuncBack,n.dss.stencilRefBack=C.stencilRefBack,n.dss.stencilReadMaskBack=C.stencilReadMaskBack),n.dss.stencilFailOpBack===C.stencilFailOpBack&&n.dss.stencilZFailOpBack===C.stencilZFailOpBack&&n.dss.stencilPassOpBack===C.stencilPassOpBack||(i.stencilOpSeparate(i.BACK,Dx[C.stencilFailOpBack],Dx[C.stencilZFailOpBack],Dx[C.stencilPassOpBack]),n.dss.stencilFailOpBack=C.stencilFailOpBack,n.dss.stencilZFailOpBack=C.stencilZFailOpBack,n.dss.stencilPassOpBack=C.stencilPassOpBack),n.dss.stencilWriteMaskBack!==C.stencilWriteMaskBack&&(i.stencilMaskSeparate(i.BACK,C.stencilWriteMaskBack),n.dss.stencilWriteMaskBack=C.stencilWriteMaskBack));var w=E.gpuPipelineState.bs;if(w){n.bs.isA2C!==w.isA2C&&(w.isA2C?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.bs.isA2C=w.isA2C),n.bs.blendColor[0]===w.blendColor[0]&&n.bs.blendColor[1]===w.blendColor[1]&&n.bs.blendColor[2]===w.blendColor[2]&&n.bs.blendColor[3]===w.blendColor[3]||(i.blendColor(w.blendColor[0],w.blendColor[1],w.blendColor[2],w.blendColor[3]),n.bs.blendColor[0]=w.blendColor[0],n.bs.blendColor[1]=w.blendColor[1],n.bs.blendColor[2]=w.blendColor[2],n.bs.blendColor[3]=w.blendColor[3]);var R=w.targets[0],k=n.bs.targets[0];k.blend!==R.blend&&(R.blend?i.enable(i.BLEND):i.disable(i.BLEND),k.blend=R.blend),k.blendEq===R.blendEq&&k.blendAlphaEq===R.blendAlphaEq||(i.blendEquationSeparate(Nx[R.blendEq],Nx[R.blendAlphaEq]),k.blendEq=R.blendEq,k.blendAlphaEq=R.blendAlphaEq),k.blendSrc===R.blendSrc&&k.blendDst===R.blendDst&&k.blendSrcAlpha===R.blendSrcAlpha&&k.blendDstAlpha===R.blendDstAlpha||(i.blendFuncSeparate(zx[R.blendSrc],zx[R.blendDst],zx[R.blendSrcAlpha],zx[R.blendDstAlpha]),k.blendSrc=R.blendSrc,k.blendDst=R.blendDst,k.blendSrcAlpha=R.blendSrcAlpha,k.blendDstAlpha=R.blendDstAlpha),k.blendColorMask!==R.blendColorMask&&(i.colorMask((R.blendColorMask&ga.R)!==ga.NONE,(R.blendColorMask&ga.G)!==ga.NONE,(R.blendColorMask&ga.B)!==ga.NONE,(R.blendColorMask&ga.A)!==ga.NONE),k.blendColorMask=R.blendColorMask)}}if(E.gpuBindingLayout&&a){var O=E.gpuBindingLayout.gpuBindings,F=Array.isArray(O),L=0;for(O=F?O:O[Symbol.iterator]();;){var B;if(F){if(L>=O.length)break;B=O[L++]}else{if((L=O.next()).done)break;B=L.value}var M=B;switch(M.type){case Da.UNIFORM_BUFFER:if(M.gpuBuffer){var I=a.glBlocks,P=Array.isArray(I),D=0;for(I=P?I:I[Symbol.iterator]();;){var N;if(P){if(D>=I.length)break;N=I[D++]}else{if((D=I.next()).done)break;N=D.value}var z=N;if(z.binding===M.binding){n.glBindUBOs[z.binding]!==M.gpuBuffer.glBuffer&&(i.bindBufferBase(i.UNIFORM_BUFFER,z.binding,M.gpuBuffer.glBuffer),n.glBindUBOs[z.binding]=M.gpuBuffer.glBuffer,n.glUniformBuffer=M.gpuBuffer.glBuffer);break}}}break;case Da.SAMPLER:if(M.gpuSampler){var U=null,G=a.glSamplers,V=Array.isArray(G),H=0;for(G=V?G:G[Symbol.iterator]();;){var W;if(V){if(H>=G.length)break;W=G[H++]}else{if((H=G.next()).done)break;W=H.value}var X=W;if(X.binding===M.binding){U=X;break}}if(U){var j=U.units,q=Array.isArray(j),Y=0;for(j=q?j:j[Symbol.iterator]();;){var K;if(q){if(Y>=j.length)break;K=j[Y++]}else{if((Y=j.next()).done)break;K=Y.value}var Q=K,Z=null;if(M.gpuTexView&&0<M.gpuTexView.gpuTexture.size){n.texUnit!==Q&&(i.activeTexture(i.TEXTURE0+Q),n.texUnit=Q);var J=M.gpuTexView.gpuTexture;switch(U.glType){case i.SAMPLER_2D:(Z=n.glTex2DUnits[Q]).glTexture!==J.glTexture&&(J.glTexture?i.bindTexture(i.TEXTURE_2D,J.glTexture):i.bindTexture(i.TEXTURE_2D,e.nullTex2D.gpuTexture.glTexture),Z.glTexture=J.glTexture);break;case i.SAMPLER_CUBE:(Z=n.glTexCubeUnits[Q]).glTexture!==J.glTexture&&(J.glTexture?i.bindTexture(i.TEXTURE_CUBE_MAP,J.glTexture):i.bindTexture(i.TEXTURE_CUBE_MAP,e.nullTexCube.gpuTexture.glTexture),Z.glTexture=J.glTexture);break;default:console.error("Unsupported GL Texture type.")}var $=M.gpuSampler;n.glSamplerUnits[Q]!==$.glSampler&&(i.bindSampler(Q,$.glSampler),n.glSamplerUnits[Q]=$.glSampler)}}}}else console.error("Not found sampler on binding unit "+M.binding)}}}if(E.gpuInputAssembler&&a&&s!==E.gpuInputAssembler)if(s=E.gpuInputAssembler,e.useVAO){var ee=s.glVAOs.get(a.glProgram);if(!ee){ee=i.createVertexArray(),s.glVAOs.set(a.glProgram,ee),i.bindVertexArray(ee),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null);var te=void 0,ie=a.glInputs,ne=Array.isArray(ie),re=0;for(ie=ne?ie:ie[Symbol.iterator]();;){var ae;if(ne){if(re>=ie.length)break;ae=ie[re++]}else{if((re=ie.next()).done)break;ae=re.value}var se=ae;te=null;var oe=s.glAttribs,le=Array.isArray(oe),ce=0;for(oe=le?oe:oe[Symbol.iterator]();;){var ue;if(le){if(ce>=oe.length)break;ue=oe[ce++]}else{if((ce=oe.next()).done)break;ue=ce.value}var he=ue;if(he.name===se.name){te=he;break}}if(te){i.bindBuffer(i.ARRAY_BUFFER,te.glBuffer);for(var de=0;de<te.componentCount;++de){var fe=se.glLoc+de,pe=te.offset+te.size*de;i.enableVertexAttribArray(fe),n.glCurrentAttribLocs[fe]=!0,i.vertexAttribPointer(fe,te.count,te.glType,te.isNormalized,te.stride,pe),i.vertexAttribDivisor(fe,te.isInstanced?1:0)}}}var _e=s.gpuIndexBuffer;_e&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,_e.glBuffer),i.bindVertexArray(null),i.bindBuffer(i.ARRAY_BUFFER,null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),n.glArrayBuffer=null,n.glElementArrayBuffer=null}n.glVAO!==ee&&(i.bindVertexArray(ee),n.glVAO=ee)}else{for(var ve=0;ve<e.maxVertexAttributes;++ve)n.glCurrentAttribLocs[ve]=!1;var me=a.glInputs,ye=Array.isArray(me),ge=0;for(me=ye?me:me[Symbol.iterator]();;){var be;if(ye){if(ge>=me.length)break;be=me[ge++]}else{if((ge=me.next()).done)break;be=ge.value}var Se=be,Te=null,Ee=s.glAttribs,xe=Array.isArray(Ee),Ae=0;for(Ee=xe?Ee:Ee[Symbol.iterator]();;){var Ce;if(xe){if(Ae>=Ee.length)break;Ce=Ee[Ae++]}else{if((Ae=Ee.next()).done)break;Ce=Ae.value}var we=Ce;if(we.name===Se.name){Te=we;break}}if(Te){n.glArrayBuffer!==Te.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,Te.glBuffer),n.glArrayBuffer=Te.glBuffer);for(var Re=0;Re<Te.componentCount;++Re){var ke=Se.glLoc+Re,Oe=Te.offset+Te.size*Re;!n.glEnabledAttribLocs[ke]&&0<=ke&&(i.enableVertexAttribArray(ke),n.glEnabledAttribLocs[ke]=!0),n.glCurrentAttribLocs[ke]=!0,i.vertexAttribPointer(ke,Te.count,Te.glType,Te.isNormalized,Te.stride,Oe)}}}var Fe=s.gpuIndexBuffer;Fe&&n.glElementArrayBuffer!==Fe.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,Fe.glBuffer),n.glElementArrayBuffer=Fe.glBuffer);for(var Le=0;Le<e.maxVertexAttributes;++Le)n.glEnabledAttribLocs[Le]!==n.glCurrentAttribLocs[Le]&&(i.disableVertexAttribArray(Le),n.glEnabledAttribLocs[Le]=!1)}if(r){var Be=r.dynamicStates,Me=Array.isArray(Be),Ie=0;for(Be=Me?Be:Be[Symbol.iterator]();;){var Pe;if(Me){if(Ie>=Be.length)break;Pe=Be[Ie++]}else{if((Ie=Be.next()).done)break;Pe=Ie.value}switch(Pe){case Ka.VIEWPORT:E.viewport&&(n.viewport.left===E.viewport.left&&n.viewport.top===E.viewport.top&&n.viewport.width===E.viewport.width&&n.viewport.height===E.viewport.height||(i.viewport(E.viewport.left,E.viewport.top,E.viewport.width,E.viewport.height),n.viewport.left=E.viewport.left,n.viewport.top=E.viewport.top,n.viewport.width=E.viewport.width,n.viewport.height=E.viewport.height));break;case Ka.SCISSOR:E.scissor&&(n.scissorRect.x===E.scissor.x&&n.scissorRect.y===E.scissor.y&&n.scissorRect.width===E.scissor.width&&n.scissorRect.height===E.scissor.height||(i.scissor(E.scissor.x,E.scissor.y,E.scissor.width,E.scissor.height),n.scissorRect.x=E.scissor.x,n.scissorRect.y=E.scissor.y,n.scissorRect.width=E.scissor.width,n.scissorRect.height=E.scissor.height));break;case Ka.LINE_WIDTH:E.lineWidth&&n.rs.lineWidth!==E.lineWidth&&(i.lineWidth(E.lineWidth),n.rs.lineWidth=E.lineWidth);break;case Ka.DEPTH_BIAS:E.depthBias&&(n.rs.depthBias===E.depthBias.constantFactor&&n.rs.depthBiasSlop===E.depthBias.slopeFactor||(i.polygonOffset(E.depthBias.constantFactor,E.depthBias.slopeFactor),n.rs.depthBias=E.depthBias.constantFactor,n.rs.depthBiasSlop=E.depthBias.slopeFactor));break;case Ka.BLEND_CONSTANTS:E.blendConstants&&(n.bs.blendColor[0]===E.blendConstants[0]&&n.bs.blendColor[1]===E.blendConstants[1]&&n.bs.blendColor[2]===E.blendConstants[2]&&n.bs.blendColor[3]===E.blendConstants[3]||(i.blendColor(E.blendConstants[0],E.blendConstants[1],E.blendConstants[2],E.blendConstants[3]),n.bs.blendColor[0]=E.blendConstants[0],n.bs.blendColor[1]=E.blendConstants[1],n.bs.blendColor[2]=E.blendConstants[2],n.bs.blendColor[3]=E.blendConstants[3]));break;case Ka.STENCIL_WRITE_MASK:if(E.stencilWriteMask)switch(E.stencilWriteMask.face){case Za.FRONT:n.dss.stencilWriteMaskFront!==E.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.FRONT,E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=E.stencilWriteMask.writeMask);break;case Za.BACK:n.dss.stencilWriteMaskBack!==E.stencilWriteMask.writeMask&&(i.stencilMaskSeparate(i.BACK,E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskBack=E.stencilWriteMask.writeMask);break;case Za.ALL:n.dss.stencilWriteMaskFront===E.stencilWriteMask.writeMask&&n.dss.stencilWriteMaskBack===E.stencilWriteMask.writeMask||(i.stencilMask(E.stencilWriteMask.writeMask),n.dss.stencilWriteMaskFront=E.stencilWriteMask.writeMask,n.dss.stencilWriteMaskBack=E.stencilWriteMask.writeMask)}break;case Ka.STENCIL_COMPARE_MASK:if(E.stencilCompareMask)switch(E.stencilCompareMask.face){case Za.FRONT:n.dss.stencilRefFront===E.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===E.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.FRONT,Px[n.dss.stencilFuncFront],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefFront=E.stencilCompareMask.reference,n.dss.stencilReadMaskFront=E.stencilCompareMask.compareMask);break;case Za.BACK:n.dss.stencilRefBack===E.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===E.stencilCompareMask.compareMask||(i.stencilFuncSeparate(i.BACK,Px[n.dss.stencilFuncBack],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefBack=E.stencilCompareMask.reference,n.dss.stencilReadMaskBack=E.stencilCompareMask.compareMask);break;case Za.ALL:n.dss.stencilRefFront===E.stencilCompareMask.reference&&n.dss.stencilReadMaskFront===E.stencilCompareMask.compareMask&&n.dss.stencilRefBack===E.stencilCompareMask.reference&&n.dss.stencilReadMaskBack===E.stencilCompareMask.compareMask||(i.stencilFunc(Px[n.dss.stencilFuncBack],E.stencilCompareMask.reference,E.stencilCompareMask.compareMask),n.dss.stencilRefFront=E.stencilCompareMask.reference,n.dss.stencilReadMaskFront=E.stencilCompareMask.compareMask,n.dss.stencilRefBack=E.stencilCompareMask.reference,n.dss.stencilReadMaskBack=E.stencilCompareMask.compareMask)}}}}break;case Mx.DRAW:var De=t.drawCmds.array[u];if(s&&a)if(s.gpuIndirectBuffer){if(s.gpuIndirectBuffer){var Ne=s.gpuIndirectBuffer.indirects,ze=Array.isArray(Ne),Ue=0;for(Ne=ze?Ne:Ne[Symbol.iterator]();;){var Ge;if(ze){if(Ue>=Ne.length)break;Ge=Ne[Ue++]}else{if((Ue=Ne.next()).done)break;Ge=Ue.value}var Ve=Ge,He=s.gpuIndexBuffer;if(He&&-1<Ve.indexCount){var We=Ve.firstIndex*He.stride;i.drawElements(o,Ve.indexCount,s.glIndexType,We)}else i.drawArrays(o,Ve.firstVertex,Ve.vertexCount)}}}else if(s.gpuIndexBuffer&&-1<De.drawInfo.indexCount){var Xe=De.drawInfo.firstIndex*s.gpuIndexBuffer.stride;i.drawElements(o,De.drawInfo.indexCount,s.glIndexType,Xe)}else i.drawArrays(o,De.drawInfo.firstVertex,De.drawInfo.vertexCount);break;case Mx.UPDATE_BUFFER:var je=t.updateBufferCmds.array[u];qx(e,je.gpuBuffer,je.buffer,je.offset,je.size);break;case Mx.COPY_BUFFER_TO_TEXTURE:var qe=t.copyBufferToTextureCmds.array[u];Qx(e,[qe.gpuBuffer.buffer],qe.gpuTexture,qe.regions)}}}function Qx(e,t,i,n){var r=e.gl,a=0,s=0,o=1,l=1,c=0,u=ls[i.format],h=u.isCompressed;switch(i.glTarget){case r.TEXTURE_2D:var d=e.stateCache.glTex2DUnits[e.stateCache.texUnit];d.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),d.glTexture=i.glTexture);var f=n,p=Array.isArray(f),_=0;for(f=p?f:f[Symbol.iterator]();;){var v;if(p){if(_>=f.length)break;v=f[_++]}else{if((_=f.next()).done)break;v=_.value}var m=v;for(s=0,o=m.texExtent.width,l=m.texExtent.height,a=m.texSubres.baseMipLevel;a<m.texSubres.levelCount;++a){var y=u.type!==rs.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,a,m.texOffset.x,m.texOffset.y,o,l,i.glFormat,y):r.compressedTexImage2D(r.TEXTURE_2D,a,i.glInternelFmt,o,l,0,y):r.texSubImage2D(r.TEXTURE_2D,a,m.texOffset.x,m.texOffset.y,o,l,i.glFormat,i.glType,y),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}break;case r.TEXTURE_CUBE_MAP:var g=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];g.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),g.glTexture=i.glTexture);var b=n,S=Array.isArray(b),T=0;for(b=S?b:b[Symbol.iterator]();;){var E;if(S){if(T>=b.length)break;E=b[T++]}else{if((T=b.next()).done)break;E=T.value}var x=E;s=0;var A=x.texSubres.baseArrayLayer+x.texSubres.layerCount;for(c=x.texSubres.baseArrayLayer;c<A;++c){o=x.texExtent.width,l=x.texExtent.height;var C=x.texSubres.baseMipLevel+x.texSubres.levelCount;for(a=x.texSubres.baseMipLevel;a<C;++a){var w=u.type!==rs.FLOAT||h?new Uint8Array(t[s++]):new Float32Array(t[s++]);h?i.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,x.texOffset.x,x.texOffset.y,o,l,i.glFormat,w):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,i.glInternelFmt,o,l,0,w):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,a,x.texOffset.x,x.texOffset.y,o,l,i.glFormat,i.glType,w),o=Math.max(1,o>>1),l=Math.max(1,o>>1)}}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Fa.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var Zx=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuBuffer=null,t._indirectBuffer=null,t}return p(i,_E),l(i,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),l(i,[{key:"initialize",value:function(e){return this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._usage&Jr.INDIRECT&&(this._indirectBuffer={drawInfos:[]}),this._gpuBuffer={usage:e.usage,memUsage:e.memUsage,size:e.size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&Jr.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&ea.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&Jr.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,0<t.size&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Jr.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var s=i.createBuffer();s&&(t.glBuffer=s,0<t.size&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Jr.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;var o=i.createBuffer();o&&0<t.size&&(t.glBuffer=o,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Jr.INDIRECT||t.usage&Jr.TRANSFER_DST||t.usage&Jr.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE}(this._device,this._gpuBuffer),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._gpuBuffer=null),this._status=jr.UNREADY}},{key:"resize",value:function(e){var t,i,n,r,a;this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=this._size,0<this._size&&(t=this._device,i=this._gpuBuffer,n=t.gl,r=t.stateCache,a=i.memUsage&ea.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW,i.usage&Jr.VERTEX?(t.useVAO&&r.glVAO&&(n.bindVertexArray(null),r.glVAO=null),r.glArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,i.glBuffer),n.bufferData(n.ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ARRAY_BUFFER,null),r.glArrayBuffer=null):i.usage&Jr.INDEX?(t.useVAO&&r.glVAO&&(n.bindVertexArray(null),r.glVAO=null),t.stateCache.glElementArrayBuffer!==i.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,i.size,a),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):i.usage&Jr.UNIFORM?(t.stateCache.glUniformBuffer!==i.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,i.glBuffer),n.bufferData(n.UNIFORM_BUFFER,i.size,a),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(i.usage&Jr.INDIRECT||i.usage&Jr.TRANSFER_DST||i.usage&Jr.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),i.glTarget=n.NONE)))}},{key:"update",value:function(e,t,i){var n;n=void 0!==i?i:this._usage&Jr.INDIRECT?0:e.byteLength,qx(this._device,this._gpuBuffer,e,t||0,n)}}]),i}(),Jx=function(){function n(e,t){y(this,n),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new RE(t);for(var i=0;i<t;++i)this._frees[i]=new e;this._freeIdx=t-1}return l(n,[{key:"alloc",value:function(e){return new e}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),n}(),$x=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).beginRenderPassCmdPool=void 0,t.bindStatesCmdPool=void 0,t.drawCmdPool=void 0,t.updateBufferCmdPool=void 0,t.copyBufferToTextureCmdPool=void 0,t.beginRenderPassCmdPool=new Jx(Gx,16),t.bindStatesCmdPool=new Jx(Vx,16),t.drawCmdPool=new Jx(Hx,16),t.updateBufferCmdPool=new Jx(Wx,16),t.copyBufferToTextureCmdPool=new Jx(Xx,16),t}return p(i,tx),l(i,[{key:"initialize",value:function(e){return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}},{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),i}(),eA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).cmdPackage=new jx,t._webGLAllocator=null,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUBindingLayout=null,t._curGPUInputAssembler=null,t._curViewport=null,t._curScissor=null,t._curLineWidth=null,t._curDepthBias=null,t._curBlendConstants=[],t._curDepthBounds=null,t._curStencilWriteMask=null,t._curStencilCompareMask=null,t._isStateInvalied=!1,t}return p(i,vE),l(i,[{key:"initialize",value:function(e){return!!e.allocator&&(this._allocator=e.allocator,this._webGLAllocator=this._allocator,this._type=e.type,this._status=jr.SUCCESS,!0)}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._allocator=null,this._webGLAllocator=null),this._status=jr.UNREADY}},{key:"begin",value:function(){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUBindingLayout=null,this._curGPUInputAssembler=null,this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var s=this._webGLAllocator.beginRenderPassCmdPool.alloc(Gx);s.gpuFramebuffer=e.gpuFramebuffer,s.renderArea=t,s.clearFlag=i;for(var o=0;o<n.length;++o)s.clearColors[o]=n[o];s.clearDepth=r,s.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(s),this.cmdPackage.cmds.push(Mx.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;this._curGPUPipelineState=t,this._isStateInvalied=!0}},{key:"bindBindingLayout",value:function(e){var t=e.gpuBindingLayout;this._curGPUBindingLayout=t,this._isStateInvalied=!0}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport={left:e.left,top:e.top,width:e.width,height:e.height,minDepth:e.minDepth,maxDepth:e.maxDepth},this._curViewport!==e&&(this._curViewport=e,this._isStateInvalied=!0)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor={x:e.x,y:e.y,width:e.width,height:e.height}}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){(this._curBlendConstants||4!==e.length)&&(4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3])||(this._curBlendConstants=[e[0],e[1],e[2],e[3]],this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===za.PRIMARY&&this._isInRenderPass||this._type===za.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._allocator.drawCmdPool.alloc(Hx);if(e.extractCmdDraw(t),this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(Mx.DRAW),++this._numDrawCalls,this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case WebGL2RenderingContext.TRIANGLES:this._numTris+=e.indexCount/3*Math.max(e.instanceCount,1);break;case WebGL2RenderingContext.TRIANGLE_STRIP:case WebGL2RenderingContext.TRIANGLE_FAN:this._numTris+=(e.indexCount-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===za.PRIMARY&&!this._isInRenderPass||this._type===za.SECONDARY){var r=e.gpuBuffer;if(r){var a,s=this._webGLAllocator.updateBufferCmdPool.alloc(Wx);a=void 0!==n?n:e.usage&Jr.INDIRECT?0:t.byteLength;var o=t;s.gpuBuffer=r,s.buffer=o,s.offset=void 0!==i?i:0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(Mx.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBufferToTexture",value:function(e,t,i,n){if(this._type===za.PRIMARY&&!this._isInRenderPass||this._type===za.SECONDARY){var r=e.gpuBuffer,a=t.gpuTexture;if(r&&a){var s=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(Xx);s.gpuBuffer=r,s.gpuTexture=a,s.dstLayout=i,s.regions=n,this.cmdPackage.copyBufferToTextureCmds.push(s),this.cmdPackage.cmds.push(Mx.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var s=0;s<n.cmdPackage.bindStatesCmds.length;++s){var o=n.cmdPackage.bindStatesCmds.array[s];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var d=0;d<n.cmdPackage.copyBufferToTextureCmds.length;++d){var f=n.cmdPackage.copyBufferToTextureCmds.array[d];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds),this._numDrawCalls+=n._numDrawCalls,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(Vx);e.gpuPipelineState=this._curGPUPipelineState,e.gpuBindingLayout=this._curGPUBindingLayout,e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,e.blendConstants=this._curBlendConstants,e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Mx.BIND_STATES),this._isStateInvalied=!1}},{key:"webGLDevice",get:function(){return this._device}}]),i}(),tA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuFramebuffer=null,t}return p(i,mE),l(i,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),l(i,[{key:"initialize",value:function(e){if(this._renderPass=e.renderPass,this._colorViews=e.colorViews||[],this._depthStencilView=e.depthStencilView||null,this._isOffscreen=void 0===e.isOffscreen||e.isOffscreen,this._isOffscreen){var t=[];if(void 0!==e.colorViews){var i=e.colorViews,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;t.push(s.gpuTextureView)}}var o=null;e.depthStencilView&&(o=e.depthStencilView.gpuTextureView),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:t,gpuDepthStencilView:o,isOffscreen:this._isOffscreen,glFramebuffer:null},function(e,t){if(t.isOffscreen){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer),e.stateCache.glFramebuffer=t.glFramebuffer);for(var a=0;a<t.gpuColorViews.length;++a){var s=t.gpuColorViews[a];s&&(s.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.gpuTexture.glTarget,s.gpuTexture.glTexture,s.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.gpuTexture.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var o=t.gpuDepthStencilView;if(o){var l=ls[o.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;o.gpuTexture.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,o.gpuTexture.glTarget,o.gpuTexture.glTexture,o.baseLevel):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,o.gpuTexture.glRenderbuffer)}i.drawBuffers(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}}}}(this._device,this._gpuFramebuffer)}else this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorViews:[],gpuDepthStencilView:null,isOffscreen:e.isOffscreen,glFramebuffer:null};return this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._isOffscreen&&this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null)),this._gpuFramebuffer=null,this._status=jr.UNREADY}}]),i}(),iA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuInputAssembler=null,t}return p(i,yE),l(i,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),l(i,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._vertexBuffers=e.vertexBuffers,void 0!==e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride}this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,s=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:s=5121;break;case 2:s=5123;break;case 4:s=5125;break;default:console.error("Illegal index buffer stride.")}var o=null;return void 0!==e.indirectBuffer&&(o=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:o,glAttribs:[],glIndexType:s,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],s=void 0!==a.stream?a.stream:0,o=t.gpuVertexBuffers[s],l=Cx(a.format,i),c=ls[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:o.glBuffer,glType:l,size:c,count:ls[a.format].count,stride:o.stride,componentCount:Bx(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[s]},n[s]+=c}}(this._device,this._gpuInputAssembler),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){var i=t.glVAOs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;e.gl.deleteVertexArray(s[1])}t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null,this._status=jr.UNREADY}},{key:"extractCmdDraw",value:function(e){e.drawInfo.vertexCount=this._vertexCount,e.drawInfo.firstVertex=this._firstVertex,e.drawInfo.indexCount=this._indexCount,e.drawInfo.firstIndex=this._firstIndex,e.drawInfo.vertexOffset=this._vertexOffset,e.drawInfo.instanceCount=this._instanceCount,e.drawInfo.firstInstance=this._firstInstance}}]),i}(),nA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineLayout=null,t}return p(i,gE),l(i,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),l(i,[{key:"initialize",value:function(e){return this._layouts=e.layouts,this._pushConstantsRanges=e.pushConstantsRanges||[],this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}}]),i}(),rA=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],aA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuPipelineState=null,t}return p(i,Yv),l(i,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),l(i,[{key:"initialize",value:function(e){return this._primitive=e.primitive,this._shader=e.shader,this._is=e.is,this._rs=e.rs,this._dss=e.dss,this._bs=e.bs,this._dynamicStates=e.dynamicStates||[],this._layout=e.layout,this._renderPass=e.renderPass,this._gpuPipelineState={glPrimitive:rA[e.primitive],gpuShader:e.shader.gpuShader,rs:e.rs,dss:e.dss,bs:e.bs,dynamicStates:void 0!==e.dynamicStates?e.dynamicStates:[],gpuLayout:e.layout.gpuPipelineLayout,gpuRenderPass:e.renderPass.gpuRenderPass},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuPipelineState=null,this._status=jr.UNREADY}}]),i}(),sA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e))).numDrawCalls=0,t.numTris=0,t._isAsync=!1,t}return p(i,bE),l(i,[{key:"initialize",value:function(e){return this._type=e.type,this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._status=jr.UNREADY}},{key:"submit",value:function(e,t){if(!this._isAsync){var i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;Kx(this._device,s.cmdPackage),this.numDrawCalls+=s.numDrawCalls,this.numTris+=s.numTris}}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numTris=0}}]),i}(),oA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuRenderPass=null,t}return p(i,SE),l(i,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),l(i,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments||[],this._depthStencilInfo=e.depthStencilAttachment||null,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuRenderPass=null,this._status=jr.UNREADY}}]),i}(),lA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuSampler=null,t._state=new TE,t}return p(i,EE),l(i,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),l(i,[{key:"initialize",value:function(e){var t,i,n,r;return void 0!==e.name&&(this._state.name=e.name),void 0!==e.minFilter&&(this._state.minFilter=e.minFilter),void 0!==e.magFilter&&(this._state.magFilter=e.magFilter),void 0!==e.mipFilter&&(this._state.mipFilter=e.mipFilter),void 0!==e.addressU&&(this._state.addressU=e.addressU),void 0!==e.addressV&&(this._state.addressV=e.addressV),void 0!==e.addressW&&(this._state.addressW=e.addressW),void 0!==e.maxAnisotropy&&(this._state.maxAnisotropy=e.maxAnisotropy),void 0!==e.cmpFunc&&(this._state.cmpFunc=e.cmpFunc),void 0!==e.borderColor&&(this._state.borderColor=e.borderColor),void 0!==e.minLOD&&(this._state.minLOD=e.minLOD),void 0!==e.maxLOD&&(this._state.maxLOD=e.maxLOD),void 0!==e.mipLODBias&&(this._state.mipLODBias=e.mipLODBias),this._gpuSampler={glSampler:null,minFilter:this._state.minFilter,magFilter:this._state.magFilter,mipFilter:this._state.mipFilter,addressU:this._state.addressU,addressV:this._state.addressV,addressW:this._state.addressW,minLOD:this._state.minLOD,maxLOD:this._state.maxLOD,glMinFilter:WebGL2RenderingContext.NONE,glMagFilter:WebGL2RenderingContext.NONE,glWrapS:WebGL2RenderingContext.NONE,glWrapT:WebGL2RenderingContext.NONE,glWrapR:WebGL2RenderingContext.NONE},t=this._device,i=this._gpuSampler,n=t.gl,(r=n.createSampler())&&(i.minFilter===Sa.LINEAR||i.minFilter===Sa.ANISOTROPIC?i.mipFilter===Sa.LINEAR||i.mipFilter===Sa.ANISOTROPIC?i.glMinFilter=n.LINEAR_MIPMAP_LINEAR:i.mipFilter===Sa.POINT?i.glMinFilter=n.LINEAR_MIPMAP_NEAREST:i.glMinFilter=n.LINEAR:i.mipFilter===Sa.LINEAR||i.mipFilter===Sa.ANISOTROPIC?i.glMinFilter=n.NEAREST_MIPMAP_LINEAR:i.mipFilter===Sa.POINT?i.glMinFilter=n.NEAREST_MIPMAP_NEAREST:i.glMinFilter=n.NEAREST,i.magFilter===Sa.LINEAR||i.magFilter===Sa.ANISOTROPIC?i.glMagFilter=WebGLRenderingContext.LINEAR:i.glMagFilter=WebGLRenderingContext.NEAREST,i.glWrapS=Ex[i.addressU],i.glWrapT=Ex[i.addressV],i.glWrapR=Ex[i.addressW],i.glSampler=r,n.samplerParameteri(r,n.TEXTURE_MIN_FILTER,i.glMinFilter),n.samplerParameteri(r,n.TEXTURE_MAG_FILTER,i.glMagFilter),n.samplerParameteri(r,n.TEXTURE_WRAP_S,i.glWrapS),n.samplerParameteri(r,n.TEXTURE_WRAP_T,i.glWrapT),n.samplerParameteri(r,n.TEXTURE_WRAP_R,i.glWrapR),n.samplerParameterf(r,n.TEXTURE_MIN_LOD,i.minLOD),n.samplerParameterf(r,n.TEXTURE_MAX_LOD,i.maxLOD)),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null),this._status=jr.UNREADY}}]),i}(),cA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuShader=null,t}return p(i,xE),l(i,[{key:"gpuShader",get:function(){return this._gpuShader}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,void 0!==e.blocks&&(this._blocks=e.blocks),void 0!==e.samplers&&(this._samplers=e.samplers),this._gpuShader={name:e.name?e.name:"",blocks:void 0!==e.blocks?e.blocks:[],samplers:void 0!==e.samplers?e.samplers:[],gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var t=0;t<e.stages.length;++t){var i=e.stages[t];this._gpuShader.gpuStages[t]={type:i.type,source:i.source,macros:i.macros?i.macros:[],glShader:null}}return function(e,a){var s=e.gl,t=function(){if(l){if(c>=o.length)return"break";u=o[c++]}else{if((c=o.next()).done)return"break";u=c.value}var e=u,t=0,i="",n=1;switch(e.type){case Ia.VERTEX:i="VertexShader",t=s.VERTEX_SHADER;break;case Ia.FRAGMENT:i="FragmentShader",t=s.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var r=s.createShader(t);r&&(e.glShader=r,s.shaderSource(e.glShader,e.source),s.compileShader(e.glShader),s.getShaderParameter(e.glShader,s.COMPILE_STATUS)||(console.error(i+" in '"+a.name+"' compilation failed."),console.error(e.source.replace(/^|\n/g,function(){return"\n".concat(n++," ")})),console.error(s.getShaderInfoLog(e.glShader)),s.deleteShader(e.glShader),e.glShader=null))},o=a.gpuStages,l=Array.isArray(o),c=0;e:for(o=l?o:o[Symbol.iterator]();;){var u,i=t();switch(i){case"break":break e;default:if("object"===ye(i))return i.v}}var n=s.createProgram();if(n){a.glProgram=n;var r=a.gpuStages,h=Array.isArray(r),d=0;for(r=h?r:r[Symbol.iterator]();;){var f;if(h){if(d>=r.length)break;f=r[d++]}else{if((d=r.next()).done)break;f=d.value}var p=f;s.attachShader(a.glProgram,p.glShader)}if(s.linkProgram(a.glProgram),s.getProgramParameter(a.glProgram,s.LINK_STATUS))console.info("Shader '"+a.name+"' compilation successed.");else{console.error("Failed to link shader '"+a.name+"'."),console.error(s.getProgramInfoLog(a.glProgram));var _=a.gpuStages,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y;g.glShader&&(s.deleteShader(g.glShader),g.glShader=null)}}var b=s.getProgramParameter(a.glProgram,s.ACTIVE_ATTRIBUTES);a.glInputs=new Array(b);for(var S=0;S<b;++S){var T=s.getActiveAttrib(a.glProgram,S);if(T){var E=void 0,x=T.name.indexOf("[");E=-1!==x?T.name.substr(0,x):T.name;var A=s.getAttribLocation(a.glProgram,E),C=Fx(T.type,s),w=Lx(T.type,s);a.glInputs[S]={binding:A,name:E,type:C,stride:w,count:T.size,size:w*T.size,glType:T.type,glLoc:A}}}var R,k,O,F,L,B,M,I,P,D,N=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORM_BLOCKS);if(N){a.glBlocks=new Array(N);for(var z=0;z<N;++z){var U=(R=s.getActiveUniformBlockName(a.glProgram,z)).indexOf("[");-1!==U&&(R=R.substr(0,U)),F=-1;var G=a.blocks,V=Array.isArray(G),H=0;for(G=V?G:G[Symbol.iterator]();;){var W;if(V){if(H>=G.length)break;W=G[H++]}else{if((H=G.next()).done)break;W=H.value}var X=W;if(X.name===R){F=X.binding;break}}if(0<=F){k=z,O=s.getActiveUniformBlockParameter(a.glProgram,k,s.UNIFORM_BLOCK_DATA_SIZE),L=s.getActiveUniformBlockParameter(a.glProgram,k,s.UNIFORM_BLOCK_ACTIVE_UNIFORMS),s.uniformBlockBinding(a.glProgram,k,F);var j={binding:F,idx:k,name:R,size:O,glUniforms:new Array(L),glActiveUniforms:[],isUniformPackage:!1};a.glBlocks[z]=j,B=s.getActiveUniformBlockParameter(a.glProgram,k,s.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),M=new Array(B.length);for(var q=0;q<B.length;++q)M[q]=B[q];I=s.getActiveUniforms(a.glProgram,M,s.UNIFORM_SIZE),P=s.getActiveUniforms(a.glProgram,M,s.UNIFORM_OFFSET);for(var Y=0;Y<L;++Y)if(D=s.getActiveUniform(a.glProgram,B[Y])){var K=Lx(D.type,s),Q=I[Y]*K,Z=P[Y]/4,J=new Array(Q/4);J.fill(0),j.glUniforms[Y]={binding:-1,name:D.name,type:Fx(D.type,s),stride:K,count:D.size,size:Q,offset:P[Y],glType:D.type,glLoc:-1,array:J,begin:Z,isFirst:!0}}}}}if(0<a.samplers.length){a.glSamplers=new Array(a.samplers.length);for(var $=0;$<a.samplers.length;++$){var ee=a.samplers[$];a.glSamplers[$]={binding:ee.binding,name:ee.name,type:ee.type,units:[],glType:Ox(ee.type,s),glLoc:-1}}}for(var te=s.getProgramParameter(a.glProgram,s.ACTIVE_UNIFORMS),ie=0,ne=[],re=0;re<te;++re){var ae=s.getActiveUniform(a.glProgram,re);if(ae){var se=s.getUniformLocation(a.glProgram,ae.name);if(se){var oe=void 0,le=ae.name.indexOf("[");if(oe=-1!==le?ae.name.substr(0,le):ae.name,ae.type===s.SAMPLER_2D||ae.type===s.SAMPLER_CUBE){var ce=a.glSamplers,ue=Array.isArray(ce),he=0;for(ce=ue?ce:ce[Symbol.iterator]();;){var de;if(ue){if(he>=ce.length)break;de=ce[he++]}else{if((he=ce.next()).done)break;de=he.value}var fe=de;if(fe.name===oe){for(var pe=0;pe<ae.size;++pe)fe.units.push(ie+pe);fe.glLoc=se,ie+=ae.size,ne.push(fe);break}}}}}}if(ne.length){e.stateCache.glProgram!==a.glProgram&&(s.useProgram(a.glProgram),e.stateCache.glProgram=a.glProgram);for(var _e=0,ve=ne;_e<ve.length;_e++){var me=ve[_e];s.uniform1iv(me.glLoc,me.units)}}}}(this._device,this._gpuShader),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuShader&&(!function(e,t){var i=t.gpuStages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.glShader&&(e.gl.deleteShader(s.glShader),s.glShader=null)}t.glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null)}(this._device,this._gpuShader),this._gpuShader=null),this._status=jr.UNREADY}}]),i}(),uA=function e(){y(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=void 0,this.glVAO=null,this.texUnit=0,this.glTex2DUnits=void 0,this.glTexCubeUnits=void 0,this.glSamplerUnits=void 0,this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=void 0,this.scissorRect=void 0,this.rs=void 0,this.dss=void 0,this.bs=void 0,this.glProgram=null,this.glEnabledAttribLocs=void 0,this.glCurrentAttribLocs=void 0,this.glBindUBOs=new Array(24),this.glBindUBOs.fill(null),this.glTex2DUnits=new Array(16),this.glTexCubeUnits=new Array(16),this.glSamplerUnits=new Array(16),this.glSamplerUnits.fill(null),this.viewport={left:0,top:0,width:0,height:0,minDepth:0,maxDepth:0},this.scissorRect={x:0,y:0,width:0,height:0},this.rs=new Hv,this.dss=new Wv,this.bs=new jv,this.glEnabledAttribLocs=new Array(16),this.glCurrentAttribLocs=new Array(16),this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.fill(!1);for(var t=0;t<16;++t)this.glTex2DUnits[t]={glTexture:null},this.glTexCubeUnits[t]={glTexture:null}};function hA(e){return 0<e&&0==(e&e-1)}var dA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTexture=null,t}return p(i,AE),l(i,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),l(i,[{key:"initialize",value:function(e){var t;switch(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,void 0!==e.depth&&(this._depth=e.depth),void 0!==e.arrayLayer&&(this._arrayLayer=e.arrayLayer),void 0!==e.mipLevel&&(this._mipLevel=e.mipLevel),void 0!==e.samples&&(this._samples=e.samples),void 0!==e.flags&&(this._flags=e.flags),this._isPowerOf2=hA(this._width)&&hA(this._height),this._size=us(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._flags&Fa.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),e.type){case Aa.TEX1D:t=e.arrayLayer?e.arrayLayer<=1?Ba.TV1D:Ba.TV1D_ARRAY:Ba.TV1D;break;case Aa.TEX2D:var i=Fa.NONE;e.flags&&(i=e.flags),t=e.arrayLayer?e.arrayLayer<=1?Ba.TV2D:i&Fa.CUBEMAP?Ba.CUBE:Ba.TV2D_ARRAY:Ba.TV2D;break;case Aa.TEX3D:t=Ba.TV3D;break;default:t=Ba.TV2D}return this._gpuTexture={type:this._type,viewType:t,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._arrayLayer,mipLevel:this._mipLevel,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternelFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;switch(t.glInternelFmt=Rx(t.format,i),t.glFormat=kx(t.format,i),t.glType=Cx(t.format,i),t.viewType){case Ba.TV2D:if(t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===ka.X1){var n=i.createTexture();if(n&&0<t.size){t.glTexture=n;var r=e.stateCache.glTex2DUnits[e.stateCache.texUnit];r.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),r.glTexture=t.glTexture);var a=t.width,s=t.height;if(ls[t.format].isCompressed)if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var o=0;o<t.mipLevel;++o){var l=cs(t.format,a,s,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,o,t.glInternelFmt,a,s,0,c),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}else{var u=cs(t.format,2,2,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternelFmt,2,2,0,h)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternelFmt,a,s,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),s=Math.max(1,s>>1)}}else{var f=i.createRenderbuffer();f&&0<t.size&&(t.glRenderbuffer=f,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,xx[t.samples],t.glInternelFmt,t.width,t.height))}break;case Ba.CUBE:t.viewType=Ba.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var p=i.createTexture();if(p&&0<t.size){t.glTexture=p;var _=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),ls[t.format].isCompressed)if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var v=0;v<6;++v)for(var m=t.width,y=t.height,g=0;g<t.mipLevel;++g){var b=cs(t.format,m,y,1),S=new Uint8Array(b);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternelFmt,m,y,0,S),m=Math.max(1,m>>1),y=Math.max(1,y>>1)}else for(var T=0;T<6;++T){var E=cs(t.format,2,2,1),x=new Uint8Array(E);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,0,t.glInternelFmt,2,2,0,x)}else for(var A=0;A<6;++A)for(var C=t.width,w=t.height,R=0;R<t.mipLevel;++R)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+A,R,t.glInternelFmt,C,w,0,t.glFormat,t.glType,null),C=Math.max(1,C>>1),w=Math.max(1,w>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._gpuTexture=null),this._status=jr.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._size=us(this._format,this.width,this.height,this.depth,this.mipLevel)*this._arrayLayer,this._gpuTexture&&(this._gpuTexture.width=this._width,this._gpuTexture.height=this._height,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;switch(t.glInternelFmt=Rx(t.format,i),t.glFormat=kx(t.format,i),t.glType=Cx(t.format,i),t.viewType){case Ba.TV2D:if(t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D,t.samples===ka.X1){var n=e.stateCache.glTex2DUnits[e.stateCache.texUnit];n.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),n.glTexture=t.glTexture);var r=t.width,a=t.height;if(ls[t.format].isCompressed){if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var o=cs(t.format,r,a,1),l=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternelFmt,r,a,0,l),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}}else for(var c=0;c<t.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,t.glInternelFmt,r,a,0,t.glFormat,t.glType,null),r=Math.max(1,r>>1),a=Math.max(1,a>>1)}else{var u=i.createRenderbuffer();u&&0<t.size&&(t.glRenderbuffer=u,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,xx[t.samples],t.glInternelFmt,t.width,t.height))}break;case Ba.CUBE:t.viewType=Ba.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var h=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),ls[t.format].isCompressed){if(t.glInternelFmt!==oE.COMPRESSED_RGB_ETC1_WEBGL)for(var d=0;d<6;++d)for(var f=t.width,p=t.height,_=0;_<t.mipLevel;++_){var v=cs(t.format,f,p,1),m=new Uint8Array(v);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,t.glInternelFmt,f,p,0,m),f=Math.max(1,f>>1),p=Math.max(1,p>>1)}}else for(var y=0;y<6;++y)for(var g=t.width,b=t.height,S=0;S<t.mipLevel;++S)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+y,S,t.glInternelFmt,g,b,0,t.glFormat,t.glType,null),g=Math.max(1,g>>1),b=Math.max(1,b>>1);break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.viewType=Ba.TV2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture)),this._status=jr.UNREADY}}]),i}(),fA=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._gpuTextureView=null,t}return p(i,Wf),l(i,[{key:"gpuTextureView",get:function(){return this._gpuTextureView}}]),l(i,[{key:"initialize",value:function(e){return this._texture=e.texture,this._type=e.type,this._format=e.format,this._format=e.format,void 0!==e.baseLevel&&(this._baseLevel=e.baseLevel),void 0!==e.levelCount&&(this._levelCount=e.levelCount),void 0!==e.baseLayer&&(this._baseLayer=e.baseLayer),void 0!==e.layerCount&&(this._layerCount=e.layerCount),this._gpuTextureView={gpuTexture:e.texture.gpuTexture,type:e.type,format:e.format,baseLevel:e.baseLevel?e.baseLevel:0,levelCount:e.levelCount?e.levelCount:1},this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._gpuTextureView=null,this._texture=null,this._status=jr.UNREADY}}]),i}(),pA=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return p(t,gx),l(t,[{key:"initialize",value:function(e){void 0!==e.title&&(this._title=e.title),void 0!==e.left&&(this._left=e.left),void 0!==e.top&&(this._top=e.top),void 0!==e.isOffscreen&&(this._isOffscreen=e.isOffscreen),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height,this._colorFmt=e.colorFmt,this._depthStencilFmt=e.depthStencilFmt,this._renderPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ga.CLEAR,storeOp:Ha.STORE,sampleCount:1,beginLayout:Xa.COLOR_ATTACHMENT_OPTIMAL,endLayout:Xa.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ga.CLEAR,depthStoreOp:Ha.STORE,stencilLoadOp:Ga.CLEAR,stencilStoreOp:Ha.STORE,sampleCount:1,beginLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}});var t=[];return this._isOffscreen&&(this._colorFmt!==Kt.GFXFormat.UNKNOWN&&(this._colorTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:this._colorFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Fa.NONE}),this._colorTexView=this._device.createTextureView({texture:this._colorTex,type:Ba.TV2D,format:this._colorFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}),t.push(this._colorTexView)),this._depthStencilFmt!==Kt.GFXFormat.UNKNOWN&&(this._depthStencilTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.DEPTH_STENCIL_ATTACHMENT,format:this._depthStencilFmt,width:this._width,height:this._height,depth:1,arrayLayer:1,mipLevel:1,flags:Fa.NONE}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt,baseLevel:0,levelCount:1,baseLayer:0,layerCount:1}))),this._framebuffer=this._device.createFramebuffer({renderPass:this._renderPass,colorViews:t,depthStencilView:this._depthStencilTexView,isOffscreen:this._isOffscreen}),this._status=jr.SUCCESS,!0}},{key:"destroy",value:function(){this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._colorTexView&&(this._colorTexView.destroy(),this._colorTexView=null),this._colorTex&&(this._colorTex.destroy(),this._colorTex=null),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._renderPass&&(this._renderPass.destroy(),this._renderPass=null),this._status=jr.UNREADY}},{key:"resize",value:function(e,t){this._width=e,this._height=t,(e>this._nativeWidth||t>this._nativeHeight)&&(this._nativeWidth=e,this._nativeHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt})),this._colorTex&&(this._colorTex.resize(e,t),this._colorTexView.destroy(),this._colorTexView.initialize({texture:this._colorTex,type:Ba.TV2D,format:this._colorFmt})),this._framebuffer&&this._framebuffer.isOffscreen&&(this._framebuffer.destroy(),this._framebuffer.initialize({renderPass:this._renderPass,colorViews:[this._colorTexView],depthStencilView:this._depthStencilTexView})))}}]),t}(),_A=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).stateCache=new uA,e.nullTex2D=null,e.nullTexCube=null,e._webGL2RC=null,e._isAntialias=!0,e._isPremultipliedAlpha=!0,e._useVAO=!0,e._extensions=null,e._EXT_texture_filter_anisotropic=null,e._OES_texture_float_linear=null,e._OES_texture_half_float_linear=null,e._EXT_color_buffer_float=null,e._EXT_disjoint_timer_query_webgl2=null,e._WEBGL_compressed_texture_etc1=null,e._WEBGL_compressed_texture_etc=null,e._WEBGL_compressed_texture_pvrtc=null,e._WEBGL_compressed_texture_s3tc=null,e._WEBGL_compressed_texture_s3tc_srgb=null,e._WEBGL_debug_renderer_info=null,e._WEBGL_texture_storage_multisample=null,e._WEBGL_debug_shaders=null,e._WEBGL_lose_context=null,e}return p(t,ks),l(t,[{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}}]),l(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=void 0===e.isAntialias||e.isAntialias,this._isPremultipliedAlpha=void 0===e.isPremultipliedAlpha||e.isPremultipliedAlpha;try{var t={alpha:!1,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.error(e),!1}if(!this._webGL2RC)return console.error("This device does not support WebGL2."),!1;this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=ds.WEBGL2,this._deviceName="WebGL2";var i=this._webGL2RC;this._WEBGL_debug_renderer_info=i.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=i.getParameter(i.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=Kt.GFXFormat.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Kt.GFXFormat.D32F_S8:this._depthStencilFmt=Kt.GFXFormat.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Kt.GFXFormat.D24S8:this._depthStencilFmt=Kt.GFXFormat.D24:8===this._stencilBits?this._depthStencilFmt=Kt.GFXFormat.D16S8:this._depthStencilFmt=Kt.GFXFormat.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){var r=this._extensions,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}n+=o+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=i.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=i.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=i.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=i.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=i.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=i.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=i.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=i.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=i.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=i.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=i.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=i.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[ps.TEXTURE_FLOAT]=!0,this._features[ps.TEXTURE_HALF_FLOAT]=!0,this._features[ps.FORMAT_R11G11B10F]=!0,this._features[ps.FORMAT_D24S8]=!0,this._features[ps.FORMAT_ETC2]=!0,this._features[ps.MSAA]=!0,this._EXT_color_buffer_float&&(this._features[ps.COLOR_FLOAT]=!0,this._features[ps.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[ps.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[ps.TEXTURE_HALF_FLOAT_LINEAR]=!0);var l="";this._WEBGL_compressed_texture_etc1&&(this._features[ps.FORMAT_ETC1]=!0,l+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[ps.FORMAT_ETC2]=!0,l+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[ps.FORMAT_DXT]=!0,l+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[ps.FORMAT_PVRTC]=!0,l+="pvrtc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+l),this.initStates(i),this._queue=this.createQueue({type:$a.GRAPHICS}),this._mainWindow=this.createWindow({title:this._webGL2RC.canvas.title,left:this._webGL2RC.canvas.offsetLeft,top:this._webGL2RC.canvas.offsetTop,width:this._webGL2RC.drawingBufferWidth,height:this._webGL2RC.drawingBufferHeight,colorFmt:this._colorFmt,depthStencilFmt:this._depthStencilFmt}),this._cmdAllocator=this.createCommandAllocator({}),this.nullTex2D=new dA(this),this.nullTex2D.initialize({type:Aa.TEX2D,usage:wa.SAMPLED,format:Kt.GFXFormat.RGBA8,width:2,height:2,flags:Fa.GEN_MIPMAP}),this.nullTexCube=new dA(this),this.nullTexCube.initialize({type:Aa.TEX2D,usage:wa.SAMPLED,format:Kt.GFXFormat.RGBA8,width:2,height:2,arrayLayer:6,flags:Fa.CUBEMAP|Fa.GEN_MIPMAP});var c={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:0,y:0,z:0},texExtent:{width:2,height:2,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}},u=new Uint8Array(this.nullTex2D.size);return u.fill(0),this.copyBuffersToTexture([u],this.nullTex2D,[c]),c.texSubres.layerCount=6,this.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[c]),!0}},{key:"destroy",value:function(){this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._mainWindow&&(this._mainWindow.destroy(),this._mainWindow=null),this._cmdAllocator&&(this._cmdAllocator.destroy(),this._cmdAllocator=null),this._queue&&(this._queue.destroy(),this._queue=null),this._webGL2RC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"createBuffer",value:function(e){var t=new Zx(this);return t.initialize(e),t}},{key:"createTexture",value:function(e){var t=new dA(this);return t.initialize(e),t}},{key:"createTextureView",value:function(e){var t=new fA(this);return t.initialize(e),t}},{key:"createSampler",value:function(e){var t=new lA(this);return t.initialize(e),t}},{key:"createBindingLayout",value:function(e){var t=new Tx(this);return t.initialize(e),t}},{key:"createShader",value:function(e){var t=new cA(this);return t.initialize(e),t}},{key:"createInputAssembler",value:function(e){var t=new iA(this);return t.initialize(e),t}},{key:"createRenderPass",value:function(e){var t=new oA(this);return t.initialize(e),t}},{key:"createFramebuffer",value:function(e){var t=new tA(this);return t.initialize(e),t}},{key:"createPipelineLayout",value:function(e){var t=new nA(this);return t.initialize(e),t}},{key:"createPipelineState",value:function(e){var t=new aA(this);return t.initialize(e),t}},{key:"createCommandAllocator",value:function(e){var t=new $x(this);return t.initialize(e),t}},{key:"createCommandBuffer",value:function(e){var t=new eA(this);return t.initialize(e),t}},{key:"createQueue",value:function(e){var t=new sA(this);return t.initialize(e),t}},{key:"createWindow",value:function(e){var t=new pA(this);return t.initialize(e),t}},{key:"present",value:function(){this._cmdAllocator.releaseCmds();var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numTris=e.numTris,e.clear()}},{key:"copyBuffersToTexture",value:function(e,t,i){Qx(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=0,s=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:var l=e.stateCache.glTex2DUnits[e.stateCache.texUnit];l.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_2D,i.glTexture),l.glTexture=i.glTexture);var c=n,u=Array.isArray(c),h=0;for(c=u?c:c[Symbol.iterator]();;){var d;if(u){if(h>=c.length)break;d=c[h++]}else{if((h=c.next()).done)break;d=h.value}var f=d;for(a=f.texSubres.baseMipLevel;a<f.texSubres.levelCount;++a)r.texSubImage2D(r.TEXTURE_2D,a,f.texOffset.x,f.texOffset.y,i.glFormat,i.glType,t[s++])}break;case r.TEXTURE_CUBE_MAP:var p=e.stateCache.glTexCubeUnits[e.stateCache.texUnit];p.glTexture!==i.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,i.glTexture),p.glTexture=i.glTexture);var _=n,v=Array.isArray(_),m=0;for(_=v?_:_[Symbol.iterator]();;){var y;if(v){if(m>=_.length)break;y=_[m++]}else{if((m=_.next()).done)break;y=m.value}var g=y,b=g.texSubres.baseArrayLayer+g.texSubres.layerCount;for(o=g.texSubres.baseArrayLayer;o<b;++o){var S=g.texSubres.baseMipLevel+g.texSubres.levelCount;for(a=g.texSubres.baseMipLevel;a<S;++a)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,a,g.texOffset.x,g.texOffset.y,i.glFormat,i.glType,t[s++])}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&Fa.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGL2RC,r=e.gpuFramebuffer,a=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);var s=new Uint8Array(t),o=i,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u,d=h.buffOffset+h.buffTexHeight*h.buffStride,f=h.texExtent.width,p=h.texExtent.height,_=cs(Kt.GFXFormat.RGBA8,f,p,1),v=s.subarray(d,d+_);n.readPixels(h.texOffset.x,h.texOffset.y,f,p,n.RGBA,n.UNSIGNED_BYTE,v)}this.stateCache.glFramebuffer!==a&&(n.bindFramebuffer(n.FRAMEBUFFER,a),this.stateCache.glFramebuffer=a)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){var s=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(s.bindFramebuffer(s.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var o=i.glFramebuffer!==e.stateCache.glFramebuffer;o&&s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i.glFramebuffer);var l=0;0<t.gpuColorViews.length&&(l|=s.COLOR_BUFFER_BIT),t.gpuDepthStencilView&&(l|=s.DEPTH_BUFFER_BIT,ls[t.gpuDepthStencilView.format].hasStencil&&(l|=s.STENCIL_BUFFER_BIT));var c=a===Sa.LINEAR||a===Sa.ANISOTROPIC?s.LINEAR:s.NEAREST;s.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,r.x,r.y,r.x+r.width,r.y+r.height,l,c),o&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,r)}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,4294967295),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,4294967295),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,4294967295),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}}]),t}();cc.GFXDevice=ks,cc.GFXBuffer=_E,cc.GFXTexture=AE,cc.GFXTextureView=Wf,cc.GFXSampler=EE,cc.GFXShader=xE,cc.GFXInputAssembler=yE,cc.GFXRenderPass=SE,cc.GFXFramebuffer=mE,cc.GFXPipelineLayout=gE,cc.GFXPipelineState=Yv,cc.GFXCommandBuffer=vE,cc.GFXQueue=bE,cc.WebGLGFXDevice=Sx,cc.WebGL2GFXDevice=_A,Object.assign(cc,vs);var vA,mA,yA,gA,bA,SA,TA,EA,xA,AA,CA,wA,RA=0,kA={},OA=function(e){if(void 0===kA[e]){var t=1<<RA;kA[e]=t,RA+=1}};(mA=vA||(vA={}))[mA.OPAQUE=0]="OPAQUE",mA[mA.TRANSPARENT=1]="TRANSPARENT",mA[mA.OVERLAY=2]="OVERLAY",(gA=yA||(yA={}))[gA.DEFAULT=1]="DEFAULT",gA[gA.FORWARD=2]="FORWARD",gA[gA.SHADOWCAST=4]="SHADOWCAST",(SA=bA||(bA={}))[SA.ORTHO=0]="ORTHO",SA[SA.PERSPECTIVE=1]="PERSPECTIVE",(EA=TA||(TA={}))[EA.F1_8=0]="F1_8",EA[EA.F2_0=1]="F2_0",EA[EA.F2_2=2]="F2_2",EA[EA.F2_5=3]="F2_5",EA[EA.F2_8=4]="F2_8",EA[EA.F3_2=5]="F3_2",EA[EA.F3_5=6]="F3_5",EA[EA.F4_0=7]="F4_0",EA[EA.F4_5=8]="F4_5",EA[EA.F5_0=9]="F5_0",EA[EA.F5_6=10]="F5_6",EA[EA.F6_3=11]="F6_3",EA[EA.F7_1=12]="F7_1",EA[EA.F8_0=13]="F8_0",EA[EA.F9_0=14]="F9_0",EA[EA.F10_0=15]="F10_0",EA[EA.F11_0=16]="F11_0",EA[EA.F13_0=17]="F13_0",EA[EA.F14_0=18]="F14_0",EA[EA.F16_0=19]="F16_0",EA[EA.F18_0=20]="F18_0",EA[EA.F20_0=21]="F20_0",EA[EA.F22_0=22]="F22_0",(AA=xA||(xA={}))[AA.ISO100=0]="ISO100",AA[AA.ISO200=1]="ISO200",AA[AA.ISO400=2]="ISO400",AA[AA.ISO800=3]="ISO800",(wA=CA||(CA={}))[wA.D1=0]="D1",wA[wA.D2=1]="D2",wA[wA.D4=2]="D4",wA[wA.D8=3]="D8",wA[wA.D15=4]="D15",wA[wA.D30=5]="D30",wA[wA.D60=6]="D60",wA[wA.D125=7]="D125",wA[wA.D250=8]="D250",wA[wA.D500=9]="D500",wA[wA.D1000=10]="D1000",wA[wA.D2000=11]="D2000",wA[wA.D4000=12]="D4000";var FA=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],LA=[1,.5,.25,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,25e-5],BA=[100,200,400,800],MA=cc.v3(),IA=cc.v3(),PA=cc.mat4(),DA=cc.mat4(),NA=function(){function n(e,t){y(this,n),this._scene=void 0,this._name=void 0,this._enabled=!1,this._proj=void 0,this._isWindowSize=!0,this._width=void 0,this._height=void 0,this._screenScale=void 0,this._aspect=void 0,this._orthoHeight=10,this._fov=he(45),this._nearClip=.1,this._farClip=1e3,this._clearStencil=0,this._clearDepth=1,this._clearFlag=ts.NONE,this._clearColor={r:0,g:0,b:0,a:0},this._viewport=new Ur(0,0,1,1),this._isProjDirty=!0,this._matView=new Dr,this._matProj=new Dr,this._matViewProj=new Dr,this._matViewProjInv=new Dr,this._frustum=new Y_,this._forward=new Br,this._position=new Br,this._node=null,this._view=void 0,this._visibility=0,this._priority=0,this._aperture=TA.F16_0,this._apertureValue=void 0,this._shutter=CA.D125,this._shutterValue=0,this._iso=xA.ISO100,this._isoValue=0,this._ec=0,this._exposure=0,this._scene=e,this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._apertureValue=FA[this._aperture],this._shutterValue=LA[this._shutter],this._isoValue=BA[this._iso],this.updateExposure(),this._aspect=this._width=this._height=this._screenScale=1;var i=void 0!==t.isUI&&t.isUI;this._view=this._scene.root.createView({camera:this,name:this._name,priority:this._priority,isUI:i,flows:t.flows}),this.changeTargetDisplay(t.targetDisplay),console.log("Create Camera: "+this._name+" "+this._width+" x "+this._height)}return l(n,[{key:"destroy",value:function(){this._scene.root.destroyView(this._view)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){this._width=e,this._height=t,this._aspect=this._width/this._height,this._isWindowSize=!1}},{key:"update",value:function(){if(this._node){if(this._node.hasChanged&&(He.invert(this._matView,this.node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position)),this._isProjDirty)if(this._proj===bA.PERSPECTIVE)He.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip);else{var e=this._orthoHeight*this._aspect,t=this._orthoHeight;He.ortho(this._matProj,-e,e,-t,t,this._nearClip,this._farClip)}(this._node.hasChanged||this._isProjDirty)&&(He.multiply(this._matViewProj,this._matProj,this._matView),He.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv)),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),He.invert(this._matView,this.node.worldMatrix),this._proj===bA.PERSPECTIVE)He.perspective(PA,this._fov,this._aspect,t,i);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;He.ortho(PA,-n,n,-r,r,t,i)}He.multiply(DA,PA,this._matView),He.invert(PA,DA),e.update(DA,PA)}}},{key:"changeTargetDisplay",value:function(e){var t=this._scene,i=t.root.windows[e]||t.root.mainWindow;i&&(this._width=i.width,this._height=i.height,this._view.window=i),this._aspect=this._width/this._height}},{key:"screenPointToRay",value:function(e,t,i){var n=this._viewport.x*this._width,r=this._viewport.y*this._height,a=this._viewport.width*this._width,s=this._viewport.height*this._height;return Oe.set(MA,(t-n)/a*2-1,(i-r)/s*2-1,1),Oe.transformMat4(MA,MA,this._matViewProjInv),this._proj===bA.PERSPECTIVE?this._node&&this._node.getWorldPosition(IA):(Oe.set(IA,(t-n)/a*2-1,(i-r)/s*2-1,-1),Oe.transformMat4(IA,IA,this._matViewProjInv)),O_.fromPoints(e,IA,MA)}},{key:"screenToWorld",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return this._proj===bA.PERSPECTIVE?(Oe.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,1),Oe.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(MA),Oe.lerp(e,MA,e,ue(this._nearClip/this._farClip,1,t.z))):(Oe.set(e,(t.x-i)/r*2-1,(t.y-n)/a*2-1,2*t.z-1),Oe.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._viewport.x*this._width,n=this._viewport.y*this._height,r=this._viewport.width*this._width,a=this._viewport.height*this._height;return Oe.transformMat4(e,t,this.matViewProj),e.x=i+.5*(e.x+1)*r,e.y=n+.5*(e.y+1)*a,e.z=.5*e.z+.5,e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this._exposure=.833333/Math.pow(2,e)}},{key:"screenScale",set:function(e){this._screenScale=e},get:function(){return this._screenScale}},{key:"enabled",set:function(e){this._enabled=e,this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"isWindowSize",get:function(){return this._isWindowSize}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"viewport",set:function(e){this._viewport=e},get:function(){return this._viewport}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){je.copy(this._clearColor,e)},get:function(){return this._clearColor}},{key:"clearDepth",set:function(e){this._clearDepth=e},get:function(){return this._clearDepth}},{key:"clearStencil",set:function(e){this._clearStencil=e},get:function(){return this._clearStencil}},{key:"clearFlag",set:function(e){this._clearFlag=e},get:function(){return this._clearFlag}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum}},{key:"forward",get:function(){return this._forward}},{key:"position",get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view.visibility=e},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view.priority},set:function(e){this._priority=e,this._view.priority=this._priority}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=FA[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=LA[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=BA[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return this._exposure}}]),n}(),zA=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t)))._capacity=void 0,i._vertAttrs=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._mesh=void 0,i._vertCount=0,i._indexCount=0,i._type="particle-batch",i._capacity=0,i._vertAttrs=null,i._vertSize=0,i._vBuffer=null,i._vertAttrsFloatCount=0,i._vdataF32=null,i._vdataUint32=null,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:Jr.INDIRECT,memUsage:ea.HOST|ea.DEVICE,size:56,stride:1}),i._subMeshData=null,i._mesh=null,i}return p(n,Bv),l(n,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._inited&&t&&this._recreateBuffer()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;var i=this._vertAttrs,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s.offset=this._vertSize,this._vertSize+=ls[s.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this._inited=!0}}},{key:"_recreateBuffer",value:function(){this._vBuffer=this._createSubMeshData(),this.getSubModel(0).updateCommandBuffer(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex(function(e){return e.name===Kt.GFXAttributeName.ATTR_TEX_COORD2}),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,Kt.GFXAttributeName.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Kt.GFXAttributeName.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex(function(e){return e.name===Kt.GFXAttributeName.ATTR_TEX_COORD})].offset,this._mesh.copyAttribute(0,Kt.GFXAttributeName.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Kt.GFXAttributeName.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=cc.Color.WHITE._val;for(var s=new Float32Array(t),o=1;o<this._capacity;o++)s.copyWithin(o*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var c=1;c<this._capacity;c++)for(var u=0;u<this._indexCount;u++)l[c*this._indexCount+u]=l[u]+c*this._vertCount}else for(var h=0,d=0;d<this._capacity;++d){var f=4*d;l[h++]=f,l[h++]=f+1,l[h++]=f+2,l[h++]=f+3,l[h++]=f+2,l[h++]=f+1}var p=this._device.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return p.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:p,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Kt.GFXPrimitiveMode.TRIANGLE_LIST},this.setSubModelMesh(0,this._subMeshData),t}},{key:"setSubModelMaterial",value:function(e,t){this.initLocalBindings(t),_(S(n.prototype),"setSubModelMaterial",this).call(this,e,t)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=e,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataUint32[n++]=t[3]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataUint32[r++]=t[3],t[4]&&(this._vdataF32[r++]=t[4].x,this._vdataF32[r++]=t[4].y,this._vdataF32[r++]=t[4].z)}}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this.getSubModel(0).inputAssembler.indexCount=0}},{key:"destroy",value:function(){_(S(n.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this._subMeshData&&this.destroySubMeshData(),this._iaInfoBuffer.destroy(),this._subMeshData=null}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),UA=OA;cc.samplerLib=Is;var GA,VA,HA,WA,XA,jA,qA,YA,KA,QA,ZA,JA,$A,eC,tC,iC,nC,rC,aC,sC,oC,lC,cC=Object.freeze({addStage:UA,samplerLib:Is,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.uvs[3*r+1],t.colors[3*r+2]);var a=[];a.push({name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F}),t.normals&&a.push({name:Kt.GFXAttributeName.ATTR_NORMAL,format:Kt.GFXFormat.RGB32F}),t.uvs&&a.push({name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RG32F}),t.colors&&a.push({name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGB32F});var s=e.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:4*i.length,stride:4*i.length/n});s.update(new Float32Array(i));var o=e.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:2*t.indices.length,stride:2});return o.update(new Uint16Array(t.indices)),e.createInputAssembler({attributes:a,vertexBuffers:[s],indexBuffer:o})},get RenderQueue(){return vA},get PassStage(){return yA},Pass:im,programLib:Gf,Light:uE,Camera:NA,Model:Bv,ParticleBatchModel:zA,SkinningModel:ET}),uC=(GA=un("cc.ClickEvent"),VA=hn(cc.Node),GA((c((WA=function(){function o(){y(this,o),v(this,"target",XA,this),v(this,"component",jA,this),v(this,"_componentId",qA,this),v(this,"handler",YA,this),v(this,"customEventData",KA,this)}return l(o,[{key:"emit",value:function(e){var t=this.target;if(cc.isValid(t)){this._genCompIdIfNeeded();var i=cc.js._getClassById(this._componentId),n=t.getComponent(i);if(cc.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=cc.js.getClassByName(e);return cc.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=cc.js._getClassById(e);return cc.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];for(var r=0,a=e.length;r<a;r++){var s=e[r];s instanceof o&&s.emit(i)}}}]),o}()).prototype,"_componentName",[hn],Object.getOwnPropertyDescriptor(WA.prototype,"_componentName"),WA.prototype),XA=c(WA.prototype,"target",[VA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jA=c(WA.prototype,"component",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qA=c(WA.prototype,"_componentId",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),YA=c(WA.prototype,"handler",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KA=c(WA.prototype,"customEventData",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HA=WA))||HA);cc.Component.EventHandler=uC;var hC=(QA=un("cc.MissingClass"),ZA=hn({visible:!1,editorOnly:!0}),QA((eC=c(($A=function e(){y(this,e),v(this,"_$erialized",eC,this)}).prototype,"_$erialized",[ZA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JA=$A))||JA),dC=(tC=un("cc.MissingScript"),iC=bn("packages://inspector/inspectors/comps/missing-script.js"),nC=hn({serializable:!1}),rC=hn({visible:!1,editorOnly:!0}),tC(aC=iC((oC=c((sC=function(e){function n(){var e;return y(this,n),v(e=T(this,S(n).call(this)),"compiled",oC,d(d(e))),v(e,"_$erialized",lC,d(d(e))),e}return p(n,Nh),l(n,null,[{key:"safeFindClass",value:function(e,t){var i=Bt(e);return i||(e?(cc.deserialize.reportMissingClass(e),n.getMissingWrapper(e,t)):null)}},{key:"getMissingWrapper",value:function(e,t){return t.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||zt.test(e))?n:hC}}]),l(n,[{key:"onLoad",value:function(){cc.warnID(4600,this.node.name)}}]),n}()).prototype,"compiled",[nC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lC=c(sC.prototype,"_$erialized",[rC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aC=sC))||aC)||aC);function fC(e){return e*e}function pC(e){return e*(2-e)}function _C(e){return e*e*e}function vC(e){return--e*e*e+1}function mC(e){return e*e*e*e}function yC(e){return 1- --e*e*e*e}function gC(e){return e*e*e*e*e}function bC(e){return--e*e*e*e*e+1}function SC(e){return 1-Math.cos(e*Math.PI/2)}function TC(e){return Math.sin(e*Math.PI/2)}function EC(e){return 0===e?0:Math.pow(1024,e-1)}function xC(e){return 1===e?1:1-Math.pow(2,-10*e)}function AC(e){return 1-Math.sqrt(1-e*e)}function CC(e){return Math.sqrt(1- --e*e)}function wC(e){return e*e*(2.70158*e-1.70158)}function RC(e){return--e*e*(2.70158*e+1.70158)+1}function kC(e){return 1-OC(1-e)}function OC(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}cc._MissingScript=dC;var FC=UC(fC,pC),LC=UC(_C,vC),BC=UC(mC,yC),MC=UC(gC,bC),IC=UC(SC,TC),PC=UC(EC,xC),DC=UC(AC,CC),NC=UC(wC,RC),zC=UC(kC,OC);function UC(t,i){return function(e){return e<.5?i(2*e)/2:t(2*e-1)/2+.5}}var GC=Object.freeze({constant:function(){return 0},linear:function(e){return e},quadIn:fC,quadOut:pC,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:_C,cubicOut:vC,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:mC,quartOut:yC,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:gC,quintOut:bC,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:SC,sineOut:TC,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:EC,expoOut:xC,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:AC,circOut:CC,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))},elasticOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)},elasticInOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4)*.5+1)},backIn:wC,backOut:RC,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:kC,bounceOut:OC,bounceInOut:function(e){return e<.5?.5*kC(2*e):.5*OC(2*e-1)+.5},smooth:function(e){return e<=0?0:1<=e?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:1<=e?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:FC,cubicOutIn:LC,quartOutIn:BC,quintOutIn:MC,sineOutIn:IC,expoOutIn:PC,circOutIn:DC,backOutIn:NC,bounceOutIn:zC});function VC(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}var HC=Math.cos,WC=Math.acos,XC=Math.max,jC=2*Math.PI,qC=Math.sqrt;function YC(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function KC(e,t){var i=function(e,t){var i,n,r,a,s=t-0,o=t-e[0],l=3*s,c=3*o,u=3*(t-e[2]),h=1/(-s+c-u+(t-1)),d=(l-6*o+u)*h,f=d*(1/3),p=(-l+c)*h,_=1/3*(3*p-d*d),v=_*(1/3),m=(2*d*d*d-9*d*p+s*h*27)/27,y=m/2,g=y*y+v*v*v;if(g<0){var b=1/3*-_,S=qC(b*b*b),T=-m/(2*S),E=WC(T<-1?-1:1<T?1:T),x=2*YC(S);return n=x*HC(E*(1/3))-f,r=x*HC((E+jC)*(1/3))-f,a=x*HC((E+2*jC)*(1/3))-f,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?XC(n,r,a):XC(n,r):0<=a&&a<=1?XC(n,a):n:0<=r&&r<=1?0<=a&&a<=1?XC(r,a):r:a}if(0===g)return r=-(i=y<0?YC(-y):-YC(y))-f,0<=(n=2*i-f)&&n<=1?0<=r&&r<=1?XC(n,r):n:r;var A=qC(g);return n=(i=YC(-y+A))-YC(y+A)-f}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}var QC,ZC,JC,$C,ew=1e-6;function tw(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+ew<a)n=r-1;else{if(!(a<t-ew))return r;i=r+1}}return~i}function iw(e,t,i){return i.value||(i.value=new Br),0===i.weight&&Oe.zero(i.value),0===t?i.value:1===t?Oe.copy(i.value,e):Oe.scaleAndAdd(i.value,i.value,e,t)}function nw(e,t,i){if(i.value||(i.value=new Pr),0===i.weight&&De.identity(i.value),0===t)return i.value;if(1===t)return De.copy(i.value,e);var n=t/(i.weight+t);return De.slerp(i.value,i.value,e,n)}(ZC=QC||(QC={}))[ZC.Loop=2]="Loop",ZC[ZC.ShouldWrap=4]="ShouldWrap",ZC[ZC.PingPong=22]="PingPong",ZC[ZC.Reverse=36]="Reverse",($C=JC||(JC={}))[$C.Default=0]="Default",$C[$C.Normal=1]="Normal",$C[$C.Reverse=QC.Reverse]="Reverse",$C[$C.Loop=QC.Loop]="Loop",$C[$C.LoopReverse=QC.Loop|QC.Reverse]="LoopReverse",$C[$C.PingPong=QC.PingPong]="PingPong",$C[$C.PingPongReverse=QC.PingPong|QC.Reverse]="PingPongReverse",si(JC);var rw,aw,sw,ow,lw,cw,uw,hw=function(){function t(e){y(this,t),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return l(t,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),t}();var dw=function(){function s(e){var t,i;y(this,s),this.ratios=void 0;for(var n=!(this._findRatio=void 0),r=1,a=(this.ratios=e).length;r<a;r++)if(t=e[r]-e[r-1],1===r)i=t;else if(1e-6<Math.abs(t-i)){n=!1;break}this._findRatio=n?vw:tw}return l(s,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),s}(),fw=un("cc.AnimCurve")((uw=cw=function(){function s(e,t,i,n){y(this,s),v(this,"types",sw,this),v(this,"type",ow,this),this._blendFunction=void 0,v(this,"_values",lw,this),this._lerp=void 0,this._stepfiedValues=void 0,this._duration=void 0,this._duration=i,this._values=e.values;var r=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?s.Linear:s.Bezier(e):s.Linear};void 0!==e.easingMethod?this.type=r(e.easingMethod):void 0!==e.easingMethods?this.types=e.easingMethods.map(r):this.type=null;var a=e.values[0];if((void 0===e.interpolate||e.interpolate)&&(this._lerp=mw(a)),n)switch(t){case"position":case"scale":this._blendFunction=iw;break;case"rotation":this._blendFunction=nw}}return l(s,null,[{key:"Bezier",value:function(e){return e}}]),l(s,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}},{key:"valueBetween",value:function(e,t,i,n,r){if(!this._lerp)return this.valueAt(t);var a=this.types?this.types[t]:this.type,s=r-i,o=(e-i)/s;a&&(o=_w(o,a));var l=this._values[t],c=this._values[n];return this._lerp(l,c,o,s*this._duration)}},{key:"empty",value:function(){return 0===this._values.length}}]),s}(),cw.Linear=null,sw=c((aw=uw).prototype,"types",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),ow=c(aw.prototype,"type",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lw=c(aw.prototype,"_values",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rw=aw))||rw,pw=function(){function e(){y(this,e),this.events=[]}return l(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}();function _w(e,t){if("string"==typeof t){var i=GC[t];i?e=i(e):j(3906,t)}else Array.isArray(t)&&(e=KC(t,e));return e}function vw(e,t){var i=e.length-1;if(0===i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(r<t)return i;var a=(t=(t-n)/(r-n))/(1/i),s=0|a;return a-s<1e-6?s:s+1-a<1e-6?s+1:~(s+1)}var mw=function(){function t(e,t,i,n){return e.lerp(t,i,n)}var i=ue;return function(e){if(null!==e){if("number"==typeof e)return i;if("object"===ye(e)&&e.constructor){if(e instanceof Fr)return n=e.constructor,r=new n,function(e,t,i){return n.lerp(e,t,i,r)};if(e.constructor===Number)return i;if("function"==typeof e.lerp)return t}var n,r}}}(),yw=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];y(this,t),this.points=e,this.beziers=[],this.ratios=[],this.progresses=[],this.length=0,this.computeBeziers()}return l(t,[{key:"computeBeziers",value:function(){this.beziers.length=0,this.ratios.length=0,this.progresses.length=0,this.length=0;for(var e=1;e<this.points.length;e++){var t=this.points[e-1],i=this.points[e],n=new gw;n.start=t.pos,n.startCtrlPoint=t.out,n.end=i.pos,n.endCtrlPoint=i.in,this.beziers.push(n),this.length+=n.getLength()}for(var r=0,a=0;a<this.beziers.length;a++){var s=this.beziers[a];this.ratios[a]=s.getLength()/this.length,this.progresses[a]=r+=this.ratios[a]}return this.beziers}}]),t}(),gw=function(){function e(){y(this,e),this.start=new Lr,this.end=new Lr,this.startCtrlPoint=new Lr,this.endCtrlPoint=new Lr,this.__arcLengthDivisions=void 0,this.cacheArcLengths=void 0}return l(e,[{key:"getPointAt",value:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)}},{key:"getPoint",value:function(e){var t=VC(this.start.x,this.startCtrlPoint.x,this.endCtrlPoint.x,this.end.x,e),i=VC(this.start.y,this.startCtrlPoint.y,this.endCtrlPoint.y,this.end.y,e);return new Lr(t,i)}},{key:"getLength",value:function(){var e=this.getLengths();return e[e.length-1]}},{key:"getLengths",value:function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1)return this.cacheArcLengths;var t,i,n=[],r=this.getPoint(0),a=new Lr,s=0;for(n.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),a.x=r.x-t.x,a.y=r.y-t.y,s+=a.mag(),n.push(s),r=t;return this.cacheArcLengths=n}},{key:"getUtoTmapping",value:function(e,t){var i,n=this.getLengths(),r=0,a=n.length;i=t||e*n[a-1];for(var s,o=0,l=a-1;o<=l;)if((s=n[r=Math.floor(o+(l-o)/2)]-i)<0)o=r+1;else{if(!(0<s)){l=r;break}l=r-1}if(n[r=l]===i)return r/(a-1);var c=n[r];return(r+(i-c)/(n[r+1]-c))/(a-1)}}]),e}();function bw(e){if(!Array.isArray(e))return!1;for(var t=0,i=e.length;t<i;t++){var n=e[t];if(!Array.isArray(n)||6!==n.length)return!1}return!0}var Sw,Tw,Ew,xw,Aw,Cw,ww,Rw,kw,Ow,Fw,Lw,Bw,Mw;var Iw=(Sw=un("cc.AnimationClip"),Tw=hn({visible:!1}),Sw((Mw=Bw=function(e){function o(){var e,t;y(this,o);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(o)).call.apply(e,[this].concat(n))),"sample",Aw,d(d(t))),v(t,"speed",Cw,d(d(t))),v(t,"wrapMode",ww,d(d(t))),v(t,"curveDatas",Rw,d(d(t))),v(t,"events",kw,d(d(t))),v(t,"_duration",Ow,d(d(t))),v(t,"_keys",Fw,d(d(t))),t._ratioSamplers=[],t._propertyCurves=void 0,t._runtimeEvents=void 0,t.frameRate=0,v(t,"_stepness",Lw,d(d(t))),t}return p(o,qn),l(o,[{key:"onLoad",value:function(){this.duration=this._duration,this.speed=this.speed,this.wrapMode=this.wrapMode,this.frameRate=this.sample}},{key:"updateCurveDatas",value:function(){delete this._propertyCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(t+1e-6<a)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"_createPropertyCurves",value:function(){var t=this;this._ratioSamplers=this._keys.map(function(e){return new dw(e.map(function(e){return e/t._duration}))}),this._propertyCurves=[];for(var e=0,i=Object.keys(this.curveDatas);e<i.length;e++){var n=i[e],r=this.curveDatas[n];if(r.props)for(var a=0,s=Object.keys(r.props);a<s.length;a++){var o=s[a],l=r.props[o];this._propertyCurves.push({path:n,propertyName:o,curve:new fw(l,o,this._duration,!0),sampler:0<=l.keys?this._ratioSamplers[l.keys]:null})}if(r.comps)for(var c=0,u=Object.keys(r.comps);c<u.length;c++)for(var h=u[c],d=r.comps[h],f=0,p=Object.keys(d);f<p.length;f++){var _=p[f],v=d[_];this._propertyCurves.push({path:n,component:h,propertyName:_,curve:new fw(v,_,this._duration,!1),sampler:0<=v.keys?this._ratioSamplers[v.keys]:null})}}this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){var n=this;var r=[],a=[],e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,t=e.frame/n._duration,i=r.findIndex(function(e){return e===t});i<0&&(i=r.length,r.push(t),a.push({events:[]})),a[i].events.push({functionName:e.func,parameters:e.params})},s=this.events.sort(function(e,t){return e.frame-t.frame}),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}this._runtimeEvents={ratios:r,eventGroups:a}}},{key:"_applyStepness",value:function(){this._propertyCurves}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"propertyCurves",get:function(){return this._propertyCurves||this._createPropertyCurves(),this._propertyCurves}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}}],[{key:"createWithSpriteFrames",value:function(e,t){if(!Array.isArray(e))return j(3905),null;var i=new o;i.sample=t||i.sample,i.duration=e.length/i.sample;for(var n=1/i.sample,r=new Array(e.length),a=new Array(r.length),s=0;s<e.length;s++)r[s]=s*n,a[s]=e[s];return i.keys=[r],i.curveDatas={"/":{comps:{"cc.Sprite":{spriteFrame:{keys:0,values:a}}}}},i}}]),o}(),Bw.WrapMode=JC,Aw=c((xw=Mw).prototype,"sample",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Cw=c(xw.prototype,"speed",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ww=c(xw.prototype,"wrapMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JC.Normal}}),Rw=c(xw.prototype,"curveDatas",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),kw=c(xw.prototype,"events",[Tw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ow=c(xw.prototype,"_duration",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fw=c(xw.prototype,"_keys",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lw=c(xw.prototype,"_stepness",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ew=xw))||Ew);cc.AnimationClip=Iw;var Pw,Dw=function(){function e(){y(this,e),this._blendTargets=[]}return l(e,[{key:"refPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.find(function(e){return e.target===t});e||(e={target:t,properties:[]},this._blendTargets.push(e));var n=e.properties,r=n.find(function(e){return e.name===i});return r||(r={name:i,weight:0,value:void 0,refCount:0},n.push(r)),++r.refCount,r}},{key:"derefPropertyBlendTarget",value:function(t,i){var e=this._blendTargets.findIndex(function(e){return e.target===t});if(!(e<0)){var n=this._blendTargets[e].properties,r=n.findIndex(function(e){return e.name===i});if(!(r<0)){var a=n[r];--a.refCount,0<a.refCount||(2<=n.length?n.splice(r,1):this._blendTargets.splice(e,1))}}}},{key:"apply",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=r.target,s=r.properties,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;0!==u.weight&&(a[u.name]=u.value)}}}},{key:"clear",value:function(){var e=this._blendTargets,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.properties,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.weight=0}}}}]),e}(),Nw=un(Pw=function(){function e(){y(this,e),this._anims=new Ye([]),this._delayEvents=[],this._blendState=new Dw,this._crossFades=[],cc.director._scheduler&&cc.director._scheduler.enableForTarget(this)}return l(e,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){Qe(this._crossFades,e)}},{key:"update",value:function(e){var t=this._crossFades,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.update(e)}this._blendState.clear();var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var o=s[a.i];o.isPlaying&&!o.isPaused&&o.update(e)}this._blendState.apply();for(var l=this._delayEvents,c=0,u=l.length;c<u;c++){var h=l[c];h.target[h.func].apply(h.target,h.args)}l.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&(e.attachToBlendState(this._blendState),this._anims.push(e))}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);0<=t?(e.detachFromBlendState(this._blendState),this._anims.fastRemoveAt(t)):j(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({target:e,func:t,args:i})}},{key:"blendState",get:function(){return this._blendState}}]),e}())||Pw;cc.AnimationManager=Nw;var zw=function(){function e(){y(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return l(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(G(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}}]),e}();var Uw,Gw,Vw,Hw,Ww,Xw=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this))).duration=1,i.speed=1,i.time=0,i.weight=0,i.frameRate=0,i._lastframeEventOn=!1,i._wrapMode=JC.Normal,i._repeatCount=1,i._currentFramePlayed=!1,i._delay=0,i._delayTime=0,i._wrappedInfo=new hw,i._lastWrapInfo=null,i._lastWrapInfoEvent=null,i._process=i.process,i._target=null,i._targetNode=null,i._clip=void 0,i._name=void 0,i._lastIterations=void 0,i._samplerSharedGroups=[],i._curveLoaded=!1,i._ignoreIndex=-1,i._clip=e,i._name=t||e&&e.name,i}return p(n,zw),l(n,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&QC.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&QC.ShouldWrap,i=(this.wrapMode&QC.Reverse)===QC.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),l(n,[{key:"initialize",value:function(a){var s=this;this._curveLoaded=!0,this._samplerSharedGroups.length=0,this._targetNode=a;var e=this._clip;this.duration=e.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,(this.wrapMode&QC.Loop)===QC.Loop?this.repeatCount=1/0:this.repeatCount=1;var t=function(){if(l){if(c>=o.length)return"break";u=o[c++]}else{if((c=o.next()).done)return"break";u=c.value}var t=u,e=a.getChildByPath(t.path);if(!e)return console.warn("Target animation node referenced by path ".concat(t.path," is not found(from ").concat(a.name,").")),"continue";var i=e;if(t.component){var n=e.getComponent(t.component);if(!n)return"continue";i=n}var r=s._samplerSharedGroups.find(function(e){return e.sampler===t.sampler});r||(r={sampler:t.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},s._samplerSharedGroups.push(r)),r.curves.push({target:i,propertyName:t.propertyName,curve:t.curve,blendTarget:null})};var o=e.propertyCurves,l=Array.isArray(o),c=0;e:for(o=l?o:o[Symbol.iterator]();;){var u;switch(t()){case"break":break e;case"continue":continue}}}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"emit",value:function(){for(var e=new Array(arguments.length),t=0,i=e.length;t<i;t++)e[t]=t<0||arguments.length<=t?void 0:arguments[t];cc.director.getAnimationManager().pushDelayEvent(this,"_emit",e)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.on(e,t,i)):null}},{key:"once",value:function(e,t,i){var n=this;return this._target&&this._target.isValid?("lastframe"===e&&(this._lastframeEventOn=!0),this._target.once(e,function(e){t.call(i,e),n._lastframeEventOn=!1})):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&("lastframe"===e&&(this._target.hasEventListener(e)||(this._lastframeEventOn=!1)),this._target.off(e,t,i))}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){0<this._delayTime&&(this._delayTime-=e,0<this._delayTime)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&QC.PingPong)===QC.PingPong&&(e-(0|e)==0&&0<e&&(e-=1),1&e&&(i=!i));return(t&QC.Reverse)===QC.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new hw;var i=!1,n=this.duration,r=this.repeatCount,a=0<e?e/n:-e/n;if(r<=a){i=!0;var s=(a=r)-(0|r);0===s&&(s=1),e=s*n*(0<e?1:-1)}if(n<e){var o=e%n;e=0===o?n:o}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,c=this._wrapMode&QC.ShouldWrap;c&&(l=this._needReverse(a));var u=l?-1:1;return this.speed<0&&(u*=-1),c&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=u,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._lastframeEventOn&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new hw(t),1<this.repeatCount&&(0|t.iterations)>(0|e.iterations)&&this.emit("lastframe",this),e.set(t));t.stopped&&(this.stop(),this.emit("finished",this))}},{key:"simpleProcess",value:function(){var e=this.time,t=this.duration;t<e?0===(e%=t)&&(e=t):e<0&&0!==(e%=t)&&(e+=t);var i=e/t;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._lastframeEventOn&&(void 0===this._lastIterations&&(this._lastIterations=i),(0<this.time&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit("lastframe",this),this._lastIterations=i)}},{key:"attachToBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;c.blendTarget=e.refPropertyBlendTarget(c.target,c.propertyName)}}}},{key:"detachFromBlendState",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r.curves,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;c.blendTarget=null,e.derefPropertyBlendTarget(c.target,c.propertyName)}}}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,cc.director.getAnimationManager().addAnimation(this),this.emit("play",this)}},{key:"onStop",value:function(){this.isPaused||cc.director.getAnimationManager().removeAnimation(this),this.emit("stop",this)}},{key:"onResume",value:function(){cc.director.getAnimationManager().addAnimation(this),this.emit("resume",this)}},{key:"onPause",value:function(){cc.director.getAnimationManager().removeAnimation(this),this.emit("pause",this)}},{key:"_sampleCurves",value:function(e){var t=this._samplerSharedGroups,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.sampler,o=a.samplerResultCache,l=0,c=!1;s?(l=s.sample(e))<0&&((l=~l)<=0?l=0:l>=s.ratios.length?l=s.ratios.length-1:(c=!0,o.from=l-1,o.fromRatio=s.ratios[o.from],o.to=l,o.toRatio=s.ratios[o.to])):l=0;var u=a.curves,h=Array.isArray(u),d=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(d>=u.length)break;f=u[d++]}else{if((d=u.next()).done)break;f=d.value}var p=f;if(!p.curve.empty()){var _=void 0;if(_=c?p.curve.valueBetween(e,o.from,o.fromRatio,o.to,o.toRatio):p.curve.valueAt(l),!p.curve._blendFunction||!p.blendTarget||p.blendTarget.refCount<=1)p.target[p.propertyName]=_;else{var v=this.weight;p.blendTarget.value=p.curve._blendFunction(_,v,p.blendTarget),p.blendTarget.weight+=v}}}}}},{key:"_sampleEvents",value:function(e){var t=e.direction,i=this._clip.getEventGroupIndexAtRatio(e.ratio);if(i<0&&(i=~i-1,t<0&&(i+=1)),this._ignoreIndex!==i&&(this._ignoreIndex=-1),e.frameIndex=i,!this._lastWrapInfoEvent)return this._fireEvent(i),void(this._lastWrapInfoEvent=new hw(e));var n=this.wrapMode,r=jw(e.iterations),a=this._lastWrapInfoEvent,s=jw(a.iterations),o=a.frameIndex,l=a.direction,c=-1!==s&&r!==s;if(o===i&&c&&1===length)this._fireEvent(0);else if(o!==i||c){t=l;do{if(o!==i){if(-1===t&&0===o&&0<i?((n&QC.PingPong)===QC.PingPong?t*=-1:o=length,s++):1===t&&o===length-1&&i<length-1&&((n&QC.PingPong)===QC.PingPong?t*=-1:o=-1,s++),o===i)break;if(r<s)break}o+=t,cc.director.getAnimationManager().pushDelayEvent(this,"_fireEvent",[o])}while(o!==i&&-1<o&&o<length)}this._lastWrapInfoEvent.set(e)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e)){var i=t[e],n=this._targetNode.components,r=i.events,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o,c=l.functionName,u=n,h=Array.isArray(u),d=0;for(u=h?u:u[Symbol.iterator]();;){var f;if(h){if(d>=u.length)break;f=u[d++]}else{if((d=u.next()).done)break;f=d.value}var p=f,_=p[c];"function"==typeof _&&_.apply(p,l.parameters)}}}}}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),n}();function jw(e){return e-(0|e)==0&&(e-=1),0|e}function qw(e,r,u,h){var t,i,a,s,o,d=new r,f=new r,p=new r;return un(e)((a=c((i=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",a,this),v(this,"inTangent",s,this),v(this,"outTangent",o,this),this.dataPoint=e||new r,this.inTangent=t||new r,this.outTangent=i||new r}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint;f=u(f,this.outTangent,i),p=u(p,e.inTangent,i);var a=t*t*t,s=t*t,o=a-2*s+t,l=-2*a+3*s,c=a-s;return d=u(d,n,2*a-3*s+1),d=h(d,d,f,o),d=h(d,d,r,l),d=h(d,d,p,c)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),s=c(i.prototype,"inTangent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),o=c(i.prototype,"outTangent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new r}}),t=i))||t}cc.AnimationState=Xw;var Yw=qw("cc.CubicSplineVec2Value",Lr,we.scale,we.scaleAndAdd);cc.CubicSplineVec2Value=Yw;var Kw=qw("cc.CubicSplineVec3Value",Br,Oe.scale,Oe.scaleAndAdd);cc.CubicSplineVec3Value=Kw;var Qw=qw("cc.CubicSplineVec4Value",Ir,Be.scale,Be.scaleAndAdd);cc.CubicSplineVec4Value=Qw;var Zw=qw("cc.CubicSplineQuatValue",Pr,De.scale,De.scaleAndAdd);cc.CubicSplineQuatValue=Zw;var Jw=un("cc.CubicSplineNumberValue")((Vw=c((Gw=function(){function n(e,t,i){y(this,n),v(this,"dataPoint",Vw,this),v(this,"inTangent",Hw,this),v(this,"outTangent",Ww,this),this.dataPoint=e,this.inTangent=t,this.outTangent=i}return l(n,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,s=t*t;return n*(2*a-3*s+1)+this.outTangent*i*(a-2*s+t)+r*(-2*a+3*s)+e.inTangent*i*(a-s)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),n}()).prototype,"dataPoint",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hw=c(Gw.prototype,"inTangent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ww=c(Gw.prototype,"outTangent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uw=Gw))||Uw;cc.CubicSplineNumberValue=Jw;var $w,eR,tR,iR,nR,rR,aR,sR,oR,lR,cR,uR,hR,dR,fR,pR=function(e){function s(){var e;return y(this,s),(e=T(this,S(s).call(this)))._fadings=[],e._unshiftDefault(),e}return p(s,zw),l(s,[{key:"update",value:function(e){if(this.isPlaying&&!this.isPaused)for(var t=1,i=0;i<this._fadings.length;++i){if(0===t){for(var n=i;n<this._fadings.length;++n){var r=this._fadings[n];r.state&&this._directStopState(r.state)}this._fadings.splice(i);break}var a=this._fadings[i];a.easeTime+=e;var s=ce(a.easeTime/a.easeDuration),o=s*t;t*=1-s,a.state&&(a.state.weight=o)}}},{key:"crossFade",value:function(t,e){var i=Ze(this._fadings,function(e){return e.state===t});void 0===i&&(i={easeDuration:e,easeTime:0,state:t}),this._fadings.unshift(i),t&&this._directPlayState(t)}},{key:"onPause",value:function(){_(S(s.prototype),"onPause",this).call(this);var e=this._fadings,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.state&&r.state.pause()}}},{key:"onResume",value:function(){_(S(s.prototype),"onResume",this).call(this);var e=this._fadings,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.state&&r.state.resume()}}},{key:"onStop",value:function(){_(S(s.prototype),"onStop",this).call(this);var e=this._fadings[0];e.state&&(e.state.weight=1);var t=this._fadings,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.state&&this._directStopState(a.state)}this._fadings.splice(1,this._fadings.length-1)}},{key:"clear",value:function(){this.stop(),this._fadings.length=0,this._unshiftDefault()}},{key:"_unshiftDefault",value:function(){this._fadings.unshift({state:null,easeDuration:Number.POSITIVE_INFINITY,easeTime:0})}},{key:"_directStopState",value:function(e){e.stop()}},{key:"_directPlayState",value:function(e){e.weight=1,e.play()}}]),s}();(fR=dR||(dR={})).PLAY="play",fR.STOP="stop",fR.PAUSE="pause",fR.RESUME="resume",fR.LASTFRAME="lastframe",fR.FINISHED="finished",si(dR);var _R,vR,mR,yR,gR,bR,SR,TR,ER,xR,AR=($w=un("cc.AnimationComponent"),eR=mn(99),tR=vn("Components/AnimationComponent"),iR=hn({type:[Iw]}),nR=hn({type:Iw}),rR=hn({type:[Iw]}),$w(aR=eR(aR=pn(aR=tR((hR=uR=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"playOnLoad",oR,d(d(e))),e._callbackTable=dt(!0),e._crossFade=new pR,e._nameToState=dt(!0),v(e,"_clips",lR,d(d(e))),v(e,"_defaultClip",cR,d(d(e))),e}return p(t,Nh),l(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();var i=this._clips,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;s&&this._removeStateOfAutomaticClip(s)}var o=e,l=Array.isArray(o),c=0;for(o=l?o:o[Symbol.iterator]();;){var u;if(l){if(c>=o.length)break;u=o[c++]}else{if((c=o.next()).done)break;u=c.value}var h=u;h&&this.createState(h)}var d=e.find(function(e){return kR(e,t._defaultClip)});this._defaultClip=d||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){(this._defaultClip=t)&&(0<=this._clips.findIndex(function(e){return kR(e,t)})||(this._clips.push(t),this.createState(t)))}}]),l(t,[{key:"onLoad",value:function(){this.clips=this._clips}},{key:"start",value:function(){for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].initialize(this.node)}cc.director.getAnimationManager().addCrossFade(this._crossFade),this._crossFade.play(),this.playOnLoad&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade&&this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade&&this._crossFade.pause()}},{key:"onDestroy",value:function(){this._crossFade&&(this._crossFade.stop(),cc.director.getAnimationManager().removeCrossFade(this._crossFade),this._crossFade.stop());for(var e=0,t=Object.keys(this._nameToState);e<t.length;e++){var i=t[e];this._nameToState[i].stop()}this._nameToState=null}},{key:"play",value:function(e){if(!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.3,i=this._nameToState[e];i&&this._crossFade.crossFade(i,t)}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return Je(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(t,e){for(var i,n=0,r=Object.keys(this._nameToState);n<r.length;n++){var a=r[n];if((i=this._nameToState[a]).clip===t)break}if(t===this._defaultClip){if(!e)return void I(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void I(3903);i.stop()}this._clips=this._clips.filter(function(e){return e!==t}),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,t,i){var n=Xn.prototype.on.call(this,e,t,i);if("lastframe"===e)for(var r=0,a=Object.keys(this._nameToState);r<a.length;r++){var s=a[r];this._nameToState[s]._lastframeEventOn=!0}return n}},{key:"off",value:function(e,t,i){if("lastframe"===e)for(var n=this._nameToState,r=0,a=Object.keys(n);r<a.length;r++){n[a[r]]._lastframeEventOn=!1}Xn.prototype.off.call(this,e,t,i)}},{key:"targetOff",value:function(e){}},{key:"once",value:function(e,t,i){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];kR(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"_doCreateState",value:function(e,t){var i=new Xw(e,t);return i._setEventTarget(this),this.node&&i.initialize(this.node),this._nameToState[i.name]=i}}]),t}(),uR.EventType=dR,c((sR=hR).prototype,"clips",[iR],Object.getOwnPropertyDescriptor(sR.prototype,"clips"),sR.prototype),c(sR.prototype,"defaultClip",[nR],Object.getOwnPropertyDescriptor(sR.prototype,"defaultClip"),sR.prototype),oR=c(sR.prototype,"playOnLoad",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lR=c(sR.prototype,"_clips",[rR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cR=c(sR.prototype,"_defaultClip",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aR=sR))||aR)||aR)||aR)||aR),CR=AR.prototype,wR=CR.on,RR=CR.off;function kR(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}jn(AR,[Pn,Xn]),AR.prototype.on=wR,AR.prototype.off=RR,cc.AnimationComponent=AR;var OR,FR,LR,BR,MR,IR,PR,DR,NR,zR,UR,GR,VR,HR,WR,XR,jR,qR,YR,KR,QR,ZR,JR,$R,ek,tk,ik,nk,rk,ak,sk,ok,lk,ck,uk,hk,dk,fk,pk,_k,vk,mk,yk,gk,bk,Sk,Tk,Ek,xk,Ak,Ck,wk,Rk,kk,Ok,Fk,Lk,Bk,Mk,Ik,Pk,Dk,Nk,zk,Uk,Gk,Vk,Hk,Wk,Xk,jk,qk,Yk,Kk,Qk,Zk,Jk,$k,eO,tO,iO,nO,rO,aO,sO,oO,lO,cO,uO,hO,dO,fO=(_R=un("cc.BillboardComponent"),vR=vn("Components/BillboardComponent"),mR=hn({type:Zc}),yR=hn({type:Zc}),_R(gR=vR(gR=pn((SR=c((bR=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_texture",SR,d(d(e))),v(e,"_height",TR,d(d(e))),v(e,"_width",ER,d(d(e))),v(e,"_rotation",xR,d(d(e))),e._model=null,e._mesh=null,e._material=null,e._uniform=cc.v4(1,1,0,0),e}return p(t,Nh),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*de(this._rotation))/100},set:function(e){this._rotation=he(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),l(t,[{key:"onEnable",value:function(){this._model||this.createModel(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}},{key:"createModel",value:function(){this._mesh=Xg({primitiveMode:Kt.GFXPrimitiveMode.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Hr.WHITE.r,Hr.WHITE.g,Hr.WHITE.b,Hr.WHITE.a,Hr.WHITE.r,Hr.WHITE.g,Hr.WHITE.b,Hr.WHITE.a,Hr.WHITE.r,Hr.WHITE.g,Hr.WHITE.b,Hr.WHITE.a,Hr.WHITE.r,Hr.WHITE.g,Hr.WHITE.b,Hr.WHITE.a],attributes:[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8UI,isNormalized:!0}],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1}),this._model=this._getRenderScene().createModel(Bv,this.node),null==this._material&&(this._material=new _m,this._material.copy(Vv.get("default-billboard-material"))),this._model.initSubModel(0,this._mesh.getSubMesh(0),this._material)}}]),t}()).prototype,"_texture",[mR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(bR.prototype,"texture",[yR],Object.getOwnPropertyDescriptor(bR.prototype,"texture"),bR.prototype),TR=c(bR.prototype,"_height",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(bR.prototype,"height",[hn],Object.getOwnPropertyDescriptor(bR.prototype,"height"),bR.prototype),ER=c(bR.prototype,"_width",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(bR.prototype,"width",[hn],Object.getOwnPropertyDescriptor(bR.prototype,"width"),bR.prototype),xR=c(bR.prototype,"_rotation",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(bR.prototype,"rotation",[hn],Object.getOwnPropertyDescriptor(bR.prototype,"rotation"),bR.prototype),gR=bR))||gR)||gR)||gR),pO=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RGBA32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD1,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8,isNormalized:!0}],_O=cc.v3(),vO=cc.v3(),mO=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t)))._capacity=void 0,i._vertSize=void 0,i._vBuffer=void 0,i._vertAttrsFloatCount=void 0,i._vdataF32=void 0,i._vdataUint32=void 0,i._iaInfo=void 0,i._iaInfoBuffer=void 0,i._subMeshData=void 0,i._vertCount=0,i._indexCount=0,i._capacity=100,i._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},i._iaInfoBuffer=i._device.createBuffer({usage:Jr.INDIRECT,memUsage:ea.HOST|ea.DEVICE,size:56,stride:1}),i}return p(n,Bv),l(n,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){for(var e=this._vertSize=0,t=pO;e<t.length;e++){var i=t[e];i.offset=this._vertSize,this._vertSize+=ls[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this._createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"_createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:this._vertSize*this._capacity*this._vertCount,stride:this._vertSize}),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=a+1,i[n++]=a+2,i[n++]=a+3,i[n++]=a+2,i[n++]=a+1}var s=this._device.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[e],indexBuffer:s,indirectBuffer:this._iaInfoBuffer,attributes:pO,primitiveMode:Kt.GFXPrimitiveMode.TRIANGLE_LIST},this.setSubModelMesh(0,this._subMeshData),t}},{key:"addLineVertexData",value:function(e,t,i){if(1<e.length){var n=0;Oe.subtract(_O,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=_O.x,this._vdataF32[n++]=_O.y,this._vdataF32[n++]=_O.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=_O.x,this._vdataF32[n++]=_O.y,this._vdataF32[n++]=_O.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){Oe.subtract(_O,e[r-1],e[r]),Oe.subtract(vO,e[r+1],e[r]),Oe.subtract(vO,vO,_O);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=vO.x,this._vdataF32[n++]=vO.y,this._vdataF32[n++]=vO.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=vO.x,this._vdataF32[n++]=vO.y,this._vdataF32[n++]=vO.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}Oe.subtract(_O,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=_O.x,this._vdataF32[n++]=_O.y,this._vdataF32[n++]=_O.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=_O.x,this._vdataF32[n++]=_O.y,this._vdataF32[n++]=_O.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vdataF32),this.getSubModel(0).inputAssembler.indexCount=this._indexCount*e,this.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){var e=this._subMeshData.vertexBuffers,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._subMeshData.indexBuffer.destroy()}}]),n}(),yO=ai({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),gO=(OR=un("cc.CurveRange"),FR=hn({type:yO}),LR=hn({type:bv}),BR=hn({type:bv}),MR=hn({type:bv}),OR((jR=XR=function(){function e(){y(this,e),v(this,"mode",DR,this),v(this,"curve",NR,this),v(this,"curveMin",zR,this),v(this,"curveMax",UR,this),v(this,"constant",GR,this),v(this,"constantMin",VR,this),v(this,"constantMax",HR,this),v(this,"multiplier",WR,this)}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case yO.Constant:return this.constant;case yO.Curve:return this.curve.evaluate(e)*this.multiplier;case yO.TwoCurves:return ue(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case yO.TwoConstants:return ue(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case yO.Constant:return this.constant;case yO.Curve:return this.multiplier;case yO.TwoConstants:return this.constantMax;case yO.TwoCurves:return this.multiplier}return 0}}]),e}(),XR.Mode=yO,DR=c((PR=jR).prototype,"mode",[FR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yO.Constant}}),NR=c(PR.prototype,"curve",[LR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bv}}),zR=c(PR.prototype,"curveMin",[BR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bv}}),UR=c(PR.prototype,"curveMax",[MR],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bv}}),GR=c(PR.prototype,"constant",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VR=c(PR.prototype,"constantMin",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HR=c(PR.prototype,"constantMax",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WR=c(PR.prototype,"multiplier",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IR=PR))||IR),bO=Hr.BLACK,SO=Hr.WHITE,TO=ai({Blend:0,Fixed:1}),EO=(un("cc.ColorKey")((KR=c((YR=function e(){y(this,e),v(this,"color",KR,this),v(this,"time",QR,this)}).prototype,"color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE}}),QR=c(YR.prototype,"time",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qR=YR)),un("cc.AlphaKey")(($R=c((JR=function e(){y(this,e),v(this,"alpha",$R,this),v(this,"time",ek,this)}).prototype,"alpha",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ek=c(JR.prototype,"time",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZR=JR)),un("cc.Gradient")((ok=sk=function(){function e(){y(this,e),v(this,"colorKeys",nk,this),v(this,"alphaKeys",rk,this),v(this,"mode",ak,this),this._color=void 0,this._color=cc.Color.WHITE}return l(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){1<this.colorKeys.length&&this.colorKeys.sort(function(e,t){return e.time-t.time}),1<this.alphaKeys.length&&this.alphaKeys.sort(function(e,t){return e.time-t.time})}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(1<this.colorKeys.length))return 1===this.colorKeys.length?this._color.set(this.colorKeys[0].color):this._color.set(SO),this._color;e=ge(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(i<=e&&e<n){if(this.mode===TO.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return Hr.lerp(this.colorKeys[t-1].color,this.colorKeys[t].color,r,this._color),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?Hr.lerp(bO,this.colorKeys[0].color,e/this.colorKeys[0].time,this._color):e>this.colorKeys[a].time&&Hr.lerp(this.colorKeys[a].color,bO,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time),this._color)}},{key:"getAlpha",value:function(e){if(!(1<this.alphaKeys.length))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=ge(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(i<=e&&e<n){if(this.mode===TO.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return ue(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?ue(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?ue(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),sk.Mode=TO,nk=c((ik=ok).prototype,"colorKeys",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),rk=c(ik.prototype,"alphaKeys",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),ak=c(ik.prototype,"mode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TO.Blend}}),tk=ik))||tk),xO=ai({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),AO=(lk=un("cc.GradientRange"),ck=hn({type:xO}),uk=hn({type:xO}),hk=hn({type:EO}),dk=hn({type:EO}),fk=hn({type:EO}),lk((xk=Ek=function(){function e(){y(this,e),v(this,"_mode",vk,this),v(this,"color",mk,this),v(this,"colorMin",yk,this),v(this,"colorMax",gk,this),v(this,"gradient",bk,this),v(this,"gradientMin",Sk,this),v(this,"gradientMax",Tk,this)}return l(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case xO.Color:return this.color;case xO.TwoColors:return Hr.lerp(this.colorMin,this.colorMax,t,this.color),this.color;case xO.RandomColor:return this.gradient.randomColor();case xO.Gradient:return this.gradient.evaluate(e);case xO.TwoGradients:return this.colorMin=this.gradientMin.evaluate(e),this.colorMax=this.gradientMax.evaluate(e),Hr.lerp(this.colorMin,this.colorMax,t,this.color),this.color}}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),Ek.Mode=xO,vk=c((_k=xk).prototype,"_mode",[ck],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xO.Color}}),c(_k.prototype,"mode",[uk],Object.getOwnPropertyDescriptor(_k.prototype,"mode"),_k.prototype),mk=c(_k.prototype,"color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE}}),yk=c(_k.prototype,"colorMin",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE}}),gk=c(_k.prototype,"colorMax",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.Color.WHITE}}),bk=c(_k.prototype,"gradient",[hk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EO}}),Sk=c(_k.prototype,"gradientMin",[dk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EO}}),Tk=c(_k.prototype,"gradientMax",[fk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new EO}}),pk=_k))||pk),CO="CC_USE_WORLD_SPACE",wO={CC_USE_WORLD_SPACE:!1},RO=(Ak=un("cc.LineComponent"),Ck=vn("Components/LineComponent"),wk=hn({type:Zc}),Rk=hn({type:Zc,displayOrder:0}),kk=hn({displayOrder:1}),Ok=hn({type:[Br]}),Fk=hn({type:[Br],displayOrder:2}),Lk=hn({type:gO}),Bk=hn({type:gO,displayOrder:3}),Mk=hn({type:Lr,displayOrder:4}),Ik=hn({type:Lr,displayOrder:5}),Pk=hn({type:AO}),Dk=hn({type:AO,displayOrder:6}),Ak(Nk=Ck(Nk=pn((Uk=c((zk=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_texture",Uk,d(d(e))),e._material=null,v(e,"_worldSpace",Gk,d(d(e))),v(e,"_positions",Vk,d(d(e))),v(e,"_width",Hk,d(d(e))),v(e,"_tile",Wk,d(d(e))),v(e,"_offset",Xk,d(d(e))),v(e,"_color",jk,d(d(e))),e._model=null,e._tile_offset=cc.v4(),e}return p(t,Nh),l(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._material&&(wO[CO]=this.worldSpace,this._material.recompileShaders(wO),this._model&&this._model.setSubModelMaterial(0,this._material))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),l(t,[{key:"onEnable",value:function(){this._model||(this._model=this._getRenderScene().createModel(mO,this.node),this._model.setCapacity(100),null==this._material&&(this._material=new _m,this._material.copy(Vv.get("default-trail-material")),wO[CO]=this.worldSpace,this._material.recompileShaders(wO)),this._model.setSubModelMaterial(0,this._material)),this._model.enabled=!0,this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=!1)}}]),t}()).prototype,"_texture",[wk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(zk.prototype,"texture",[Rk],Object.getOwnPropertyDescriptor(zk.prototype,"texture"),zk.prototype),Gk=c(zk.prototype,"_worldSpace",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(zk.prototype,"worldSpace",[kk],Object.getOwnPropertyDescriptor(zk.prototype,"worldSpace"),zk.prototype),Vk=c(zk.prototype,"_positions",[Ok],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),c(zk.prototype,"positions",[Fk],Object.getOwnPropertyDescriptor(zk.prototype,"positions"),zk.prototype),Hk=c(zk.prototype,"_width",[Lk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),c(zk.prototype,"width",[Bk],Object.getOwnPropertyDescriptor(zk.prototype,"width"),zk.prototype),Wk=c(zk.prototype,"_tile",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.v2(1,1)}}),c(zk.prototype,"tile",[Mk],Object.getOwnPropertyDescriptor(zk.prototype,"tile"),zk.prototype),Xk=c(zk.prototype,"_offset",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cc.v2(0,0)}}),c(zk.prototype,"offset",[Ik],Object.getOwnPropertyDescriptor(zk.prototype,"offset"),zk.prototype),jk=c(zk.prototype,"_color",[Pk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AO}}),c(zk.prototype,"color",[Dk],Object.getOwnPropertyDescriptor(zk.prototype,"color"),zk.prototype),Nk=zk))||Nk)||Nk)||Nk),kO=(qk=un("cc.ColorOvertimeModule"),Yk=hn({displayOrder:0}),Kk=hn({type:AO,displayOrder:1}),qk((Jk=c((Zk=function(){function e(){y(this,e),v(this,"enable",Jk,this),v(this,"color",$k,this)}return l(e,[{key:"animate",value:function(e){this.enable&&e.startColor.mul(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,ve(e.randomSeed+91041)),e.color)}}]),e}()).prototype,"enable",[Yk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$k=c(Zk.prototype,"color",[Kk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AO}}),Qk=Zk))||Qk),OO=ai({World:0,Local:1}),FO=ai({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),LO=ai({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),BO=ai({Base:0,Edge:1,Shell:2,Volume:3}),MO=ai({Random:0,Loop:1,PingPong:2}),IO=ai({Particles:0,Ribbon:1}),PO=ai({Stretch:0,Repeat:1}),DO=Oe.create(0,0,-1);function NO(e,t,i,n){return t!==e?(e===OO.World||He.invert(i,i),He.getRotation(n,i),!0):(De.set(n,0,0,0,1),!1)}function zO(e,t){we.set(e,Math.cos(t),Math.sin(t))}function UO(e){var t=pe(-1,1),i=pe(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);Oe.set(e,r,a,t)}function GO(e,t,i){UO(e),Oe.scale(e,e,t+(i-t)*fe())}function VO(e,t,i,n){zO(e,n),e.z=0,Oe.scale(e,e,t+(i-t)*fe())}function HO(e){for(var t=0;t<e.length;t++){var i=t+_e(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function WO(){var e=pe(-1,1);return 0===e&&e++,Ee(e)}var XO,jO,qO,YO,KO,QO,ZO,JO,$O,eF,tF,iF,nF,rF,aF,sF,oF,lF,cF,uF,hF,dF,fF,pF,_F,vF,mF,yF,gF,bF,SF,TF,EF=212165,xF=cc.v3(),AF=(eO=un("cc.ForceOvertimeModule"),tO=hn({displayOrder:0}),iO=hn({type:gO,range:[-1,1],displayOrder:2}),nO=hn({type:gO,range:[-1,1],displayOrder:3}),rO=hn({type:gO,range:[-1,1],displayOrder:4}),aO=hn({type:OO,displayOrder:1}),eO((lO=c((oO=function(){function e(){y(this,e),v(this,"enable",lO,this),v(this,"x",cO,this),v(this,"y",uO,this),v(this,"z",hO,this),v(this,"space",dO,this),this.randomized=!1,this.rotation=void 0,this.needTransform=void 0,this.rotation=De.create(),this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=NO(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=Oe.set(xF,this.x.evaluate(i,ve(e.randomSeed+EF)),this.y.evaluate(i,ve(e.randomSeed+EF)),this.z.evaluate(i,ve(e.randomSeed+EF)));this.needTransform&&Oe.transformQuat(n,n,this.rotation),Oe.scaleAndAdd(e.velocity,e.velocity,n,t)}}]),e}()).prototype,"enable",[tO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cO=c(oO.prototype,"x",[iO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),uO=c(oO.prototype,"y",[nO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),hO=c(oO.prototype,"z",[rO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),dO=c(oO.prototype,"space",[aO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.Local}}),sO=oO))||sO),CF=23541,wF=cc.v3(),RF=(XO=un("cc.LimitVelocityOvertimeModule"),jO=hn({displayOrder:0}),qO=hn({type:gO,range:[-1,1],displayOrder:4}),YO=hn({type:gO,range:[-1,1],displayOrder:5}),KO=hn({type:gO,range:[-1,1],displayOrder:6}),QO=hn({type:gO,range:[-1,1],displayOrder:3}),ZO=hn({displayOrder:7}),JO=hn({displayOrder:2}),$O=hn({type:OO,displayOrder:1}),XO((iF=c((tF=function(){function e(){y(this,e),v(this,"enable",iF,this),v(this,"limitX",nF,this),v(this,"limitY",rF,this),v(this,"limitZ",aF,this),v(this,"limit",sF,this),v(this,"dampen",oF,this),v(this,"separateAxes",lF,this),v(this,"space",cF,this),this.drag=null,this.multiplyDragByParticleSize=!1,this.multiplyDragByParticleVelocity=!1}return l(e,[{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=wF;this.separateAxes?Oe.set(i,kF(e.ultimateVelocity.x,this.limitX.evaluate(t,ve(e.randomSeed+CF)),this.dampen),kF(e.ultimateVelocity.y,this.limitY.evaluate(t,ve(e.randomSeed+CF)),this.dampen),kF(e.ultimateVelocity.z,this.limitZ.evaluate(t,ve(e.randomSeed+CF)),this.dampen)):(Oe.normalize(i,e.ultimateVelocity),Oe.scale(i,i,kF(Oe.magnitude(e.ultimateVelocity),this.limit.evaluate(t,ve(e.randomSeed+CF)),this.dampen))),Oe.copy(e.ultimateVelocity,i)}}]),e}()).prototype,"enable",[jO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nF=c(tF.prototype,"limitX",[qO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),rF=c(tF.prototype,"limitY",[YO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),aF=c(tF.prototype,"limitZ",[KO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),sF=c(tF.prototype,"limit",[QO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),oF=c(tF.prototype,"dampen",[ZO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),lF=c(tF.prototype,"separateAxes",[JO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cF=c(tF.prototype,"space",[$O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.Local}}),eF=tF))||eF);function kF(e,t,i){var n=Math.sign(e),r=Math.abs(e);return t<r&&(r=ue(r,t,i)),r*n}var OF,FF,LF,BF,MF,IF,PF,DF,NF,zF,UF,GF,VF,HF,WF,XF,jF,qF,YF,KF,QF,ZF,JF,$F,eL,tL,iL,nL,rL,aL,sL,oL,lL,cL,uL,hL,dL,fL,pL,_L,vL,mL,yL,gL,bL,SL,TL,EL,xL,AL,CL,wL,RL,kL,OL,FL,LL,BL,ML,IL,PL,DL,NL,zL,UL,GL,VL,HL,WL,XL,jL,qL,YL,KL,QL,ZL,JL,$L,eB,tB,iB,nB,rB,aB,sB,oB,lB,cB,uB,hB,dB,fB,pB,_B,vB,mB,yB,gB,bB,SB,TB,EB,xB,AB,CB,wB,RB,kB,OB=(uF=un("cc.RotationOvertimeModule"),hF=hn({displayOrder:0}),dF=hn({displayOrder:1}),fF=hn({type:gO,range:[-1,1],radian:!0,displayOrder:2}),pF=hn({type:gO,range:[-1,1],radian:!0,displayOrder:3}),_F=hn({type:gO,range:[-1,1],radian:!0,displayOrder:4}),uF((yF=c((mF=function(){function e(){y(this,e),v(this,"enable",yF,this),v(this,"_separateAxes",gF,this),v(this,"x",bF,this),v(this,"y",SF,this),v(this,"z",TF,this)}return l(e,[{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){e?console.error("rotation overtime separateAxes is not supported!"):this._separateAxes=e}}]),l(e,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;this._separateAxes||(e.rotation.x+=this.z.evaluate(i,ve(e.randomSeed+125292))*t)}}]),e}()).prototype,"enable",[hF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gF=c(mF.prototype,"_separateAxes",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(mF.prototype,"separateAxes",[dF],Object.getOwnPropertyDescriptor(mF.prototype,"separateAxes"),mF.prototype),bF=c(mF.prototype,"x",[fF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),SF=c(mF.prototype,"y",[pF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),TF=c(mF.prototype,"z",[_F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),vF=mF))||vF),FB=(OF=un("cc.SizeOvertimeModule"),FF=hn({displayOrder:0}),LF=hn({displayOrder:1}),BF=hn({type:gO,displayOrder:2}),MF=hn({type:gO,displayOrder:3}),IF=hn({type:gO,displayOrder:4}),PF=hn({type:gO,displayOrder:5}),OF((zF=c((NF=function(){function e(){y(this,e),v(this,"enable",zF,this),v(this,"separateAxes",UF,this),v(this,"size",GF,this),v(this,"x",VF,this),v(this,"y",HF,this),v(this,"z",WF,this)}return l(e,[{key:"animate",value:function(e){this.separateAxes||Oe.scale(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,ve(e.randomSeed+39825)))}}]),e}()).prototype,"enable",[FF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UF=c(NF.prototype,"separateAxes",[LF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GF=c(NF.prototype,"size",[BF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),VF=c(NF.prototype,"x",[MF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),HF=c(NF.prototype,"y",[IF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),WF=c(NF.prototype,"z",[PF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),DF=NF))||DF),LB=90794,BB=ai({Grid:0,Sprites:1}),MB=ai({WholeSheet:0,SingleRow:1}),IB=(XF=un("cc.TextureAnimationModule"),jF=hn({displayOrder:0}),qF=hn({type:BB}),YF=hn({type:BB,displayOrder:1}),KF=hn({displayOrder:2}),QF=hn({displayOrder:3}),ZF=hn({type:MB,displayOrder:4}),JF=hn({type:gO,displayOrder:7}),$F=hn({type:gO,displayOrder:8}),eL=hn({displayOrder:9}),tL=hn({displayOrder:5}),iL=hn({displayOrder:6}),XF((aL=c((rL=function(){function e(){y(this,e),v(this,"_enable",aL,this),v(this,"_mode",sL,this),v(this,"numTilesX",oL,this),v(this,"numTilesY",lL,this),v(this,"animation",cL,this),v(this,"frameOverTime",uL,this),v(this,"startFrame",hL,this),v(this,"cycleCount",dL,this),v(this,"_flipU",fL,this),v(this,"_flipV",pL,this),v(this,"_uvChannelMask",_L,this),v(this,"randomRow",vL,this),v(this,"rowIndex",mL,this),this.ps=null}return l(e,[{key:"onInit",value:function(e){this.ps=e}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=this.startFrame.evaluate(t,ve(e.randomSeed+LB))/(this.numTilesX*this.numTilesY);if(this.animation===MB.WholeSheet)e.frameIndex=ge(this.cycleCount*(this.frameOverTime.evaluate(t,ve(e.randomSeed+LB))+i),1);else if(this.animation===MB.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=ge(this.cycleCount*(this.frameOverTime.evaluate(t,ve(e.randomSeed+LB))+i),1),a=Math.floor(Math.random()*this.numTilesY)*n,s=a+n;e.frameIndex=ue(a,s,r)}else{var o=this.rowIndex*n,l=o+n;e.frameIndex=ue(o,l,ge(this.cycleCount*(this.frameOverTime.evaluate(t,ve(e.randomSeed+LB))+i),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e,this.ps.renderer._updateMaterialParams()}},{key:"mode",get:function(){return this._mode},set:function(e){e!==BB.Sprites||console.error("particle texture animation's sprites is not supported!")}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}()).prototype,"_enable",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(rL.prototype,"enable",[jF],Object.getOwnPropertyDescriptor(rL.prototype,"enable"),rL.prototype),sL=c(rL.prototype,"_mode",[qF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BB.Grid}}),c(rL.prototype,"mode",[YF],Object.getOwnPropertyDescriptor(rL.prototype,"mode"),rL.prototype),oL=c(rL.prototype,"numTilesX",[KF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lL=c(rL.prototype,"numTilesY",[QF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cL=c(rL.prototype,"animation",[ZF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MB.WholeSheet}}),uL=c(rL.prototype,"frameOverTime",[JF],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),hL=c(rL.prototype,"startFrame",[$F],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),dL=c(rL.prototype,"cycleCount",[eL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fL=c(rL.prototype,"_flipU",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pL=c(rL.prototype,"_flipV",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_L=c(rL.prototype,"_uvChannelMask",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),vL=c(rL.prototype,"randomRow",[tL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mL=c(rL.prototype,"rowIndex",[iL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nL=rL))||nL),PB=197866,DB=cc.v3(),NB=(yL=un("cc.VelocityOvertimeModule"),gL=hn({displayOrder:0}),bL=hn({type:gO,range:[-1,1],displayOrder:2}),SL=hn({type:gO,range:[-1,1],displayOrder:3}),TL=hn({type:gO,range:[-1,1],displayOrder:4}),EL=hn({type:gO,range:[-1,1],displayOrder:5}),xL=hn({type:OO,displayOrder:1}),yL((wL=c((CL=function(){function e(){y(this,e),v(this,"enable",wL,this),v(this,"x",RL,this),v(this,"y",kL,this),v(this,"z",OL,this),v(this,"speedModifier",FL,this),v(this,"space",LL,this),this.rotation=void 0,this.needTransform=void 0,this.rotation=De.create(),this.speedModifier.constant=1,this.needTransform=!1}return l(e,[{key:"update",value:function(e,t){this.needTransform=NO(e,this.space,t,this.rotation)}},{key:"animate",value:function(e){var t=1-e.remainingLifetime/e.startLifetime,i=Oe.set(DB,this.x.evaluate(t,ve(e.randomSeed+PB)),this.y.evaluate(t,ve(e.randomSeed+PB)),this.z.evaluate(t,ve(e.randomSeed+PB)));this.needTransform&&Oe.transformQuat(i,i,this.rotation),Oe.add(e.animatedVelocity,e.animatedVelocity,i),Oe.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),Oe.scale(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,ve(e.randomSeed+PB)))}}]),e}()).prototype,"enable",[gL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RL=c(CL.prototype,"x",[bL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),kL=c(CL.prototype,"y",[SL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),OL=c(CL.prototype,"z",[TL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),FL=c(CL.prototype,"speedModifier",[EL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),LL=c(CL.prototype,"space",[xL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.Local}}),AL=CL))||AL),zB=(BL=un("cc.Burst"),ML=hn({type:gO}),BL((DL=c((PL=function(){function e(){y(this,e),v(this,"_time",DL,this),v(this,"minCount",NL,this),v(this,"maxCount",zL,this),v(this,"_repeatCount",UL,this),v(this,"repeatInterval",GL,this),v(this,"count",VL,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=1,this._curTime=0}return l(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),l(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),0<this._remainingCount){var i=ge(e._time-e.startDelay.evaluate(),e.duration)-t;i=0<i?i:0;var n=ge(e.time-e.startDelay.evaluate(),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(PL.prototype,"time",[hn],Object.getOwnPropertyDescriptor(PL.prototype,"time"),PL.prototype),NL=c(PL.prototype,"minCount",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),zL=c(PL.prototype,"maxCount",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),UL=c(PL.prototype,"_repeatCount",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(PL.prototype,"repeatCount",[hn],Object.getOwnPropertyDescriptor(PL.prototype,"repeatCount"),PL.prototype),GL=c(PL.prototype,"repeatInterval",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VL=c(PL.prototype,"count",[ML],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),IL=PL))||IL),UB=Oe.create(0,0,0),GB=new Array,VB=Oe.create(.5,.5,.5),HB=(HL=un("cc.ShapeModule"),WL=hn({displayOrder:0}),XL=hn({type:LO,displayOrder:1}),jL=hn({type:BO,displayOrder:2}),qL=hn({displayOrder:12}),YL=hn({displayOrder:13}),KL=hn({displayOrder:14}),QL=hn({displayOrder:15}),ZL=hn({displayOrder:16}),JL=hn({displayOrder:17}),$L=hn({displayOrder:18}),eB=hn({displayOrder:3}),tB=hn({displayOrder:4}),iB=hn({displayOrder:6}),nB=hn({type:MO,displayOrder:7}),rB=hn({displayOrder:0}),aB=hn({type:gO,displayOrder:9}),sB=hn({displayOrder:5}),oB=hn({displayOrder:10}),lB=hn({displayOrder:11}),HL((hB=c((uB=function(){function e(){y(this,e),v(this,"enable",hB,this),v(this,"shapeType",dB,this),v(this,"emitFrom",fB,this),v(this,"_position",pB,this),v(this,"_rotation",_B,this),v(this,"_scale",vB,this),v(this,"alignToDirection",mB,this),v(this,"randomDirectionAmount",yB,this),v(this,"sphericalDirectionAmount",gB,this),v(this,"randomPositionAmount",bB,this),v(this,"radius",SB,this),v(this,"radiusThickness",TB,this),v(this,"_arc",EB,this),v(this,"arcMode",xB,this),v(this,"arcSpread",AB,this),v(this,"arcSpeed",CB,this),v(this,"_angle",wB,this),v(this,"length",RB,this),v(this,"boxThickness",kB,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=He.create(),this.quat=De.create(),this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return l(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return de(this._arc)},set:function(e){this._arc=he(e)}},{key:"angle",get:function(){return Math.round(100*de(this._angle))/100},set:function(e){this._angle=he(e)}}]),l(e,[{key:"onInit",value:function(e){this.constructMat(),this.particleSystem=e,this.lastTime=this.particleSystem._time,this.totalAngle=0}},{key:"constructMat",value:function(){De.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),He.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"emit",value:function(e){switch(this.shapeType){case LO.Box:!function(e,t,i,n){switch(e){case BO.Volume:r=i,a=VB,Oe.set(r,pe(-a.x,a.x),pe(-a.y,a.y),pe(-a.z,a.z));break;case BO.Shell:GB.splice(0,GB.length),GB.push(pe(-.5,.5)),GB.push(pe(-.5,.5)),GB.push(.5*WO()),HO(GB),WB(GB,t),Oe.set(i,GB[0],GB[1],GB[2]);break;case BO.Edge:GB.splice(0,GB.length),GB.push(pe(-.5,.5)),GB.push(.5*WO()),GB.push(.5*WO()),HO(GB),WB(GB,t),Oe.set(i,GB[0],GB[1],GB[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,a;Oe.copy(n,DO)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case LO.Circle:t=this.radius,i=this.radiusThickness,n=this.generateArcAngle(),r=e.position,a=e.velocity,VO(r,t*(1-i),t,n),Oe.normalize(a,r);break;case LO.Cone:!function(e,t,i,n,r,a,s,o){switch(e){case BO.Base:VO(s,t*(1-i),t,n),we.scale(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Oe.normalize(o,o),s.z=0;break;case BO.Shell:zO(s,n),we.scale(o,s,Math.sin(r)),o.z=-Math.cos(r),Oe.normalize(o,o),we.scale(s,s,t),s.z=0;break;case BO.Volume:VO(s,t*(1-i),t,n),we.scale(o,s,Math.sin(r)),o.z=-Math.cos(r)*t,Oe.normalize(o,o),s.z=0,Oe.add(s,s,Oe.scale(UB,o,a*fe()/-o.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case LO.Sphere:!function(e,t,i,n,r){switch(e){case BO.Volume:GO(n,t*(1-i),t),Oe.copy(r,n),Oe.normalize(r,r);break;case BO.Shell:UO(n),Oe.scale(n,n,t),Oe.copy(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case LO.Hemisphere:!function(e,t,i,n,r){switch(e){case BO.Volume:GO(n,t*(1-i),t),0<n.z&&(n.z*=-1),Oe.copy(r,n),Oe.normalize(r,r);break;case BO.Shell:UO(n),Oe.scale(n,n,t),n.z<0&&(n.z*=-1),Oe.copy(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var t,i,n,r,a;if(0<this.randomPositionAmount&&(e.position.x+=pe(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=pe(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=pe(-this.randomPositionAmount,this.randomPositionAmount)),Oe.transformQuat(e.velocity,e.velocity,this.quat),Oe.transformMat4(e.position,e.position,this.mat),0<this.sphericalDirectionAmount){var s=Oe.normalize(UB,e.position);Oe.lerp(e.velocity,e.velocity,s,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"generateArcAngle",value:function(){if(this.arcMode===MO.Random)return pe(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case MO.Loop:return ge(e,this._arc);case MO.PingPong:return be(e,this._arc)}}}]),e}()).prototype,"enable",[WL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dB=c(uB.prototype,"shapeType",[XL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LO.Box}}),fB=c(uB.prototype,"emitFrom",[jL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BO.Volume}}),pB=c(uB.prototype,"_position",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(0,0,0)}}),c(uB.prototype,"position",[qL],Object.getOwnPropertyDescriptor(uB.prototype,"position"),uB.prototype),_B=c(uB.prototype,"_rotation",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(0,0,0)}}),c(uB.prototype,"rotation",[YL],Object.getOwnPropertyDescriptor(uB.prototype,"rotation"),uB.prototype),vB=c(uB.prototype,"_scale",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(1,1,1)}}),c(uB.prototype,"scale",[KL],Object.getOwnPropertyDescriptor(uB.prototype,"scale"),uB.prototype),mB=c(uB.prototype,"alignToDirection",[QL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yB=c(uB.prototype,"randomDirectionAmount",[ZL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gB=c(uB.prototype,"sphericalDirectionAmount",[JL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bB=c(uB.prototype,"randomPositionAmount",[$L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SB=c(uB.prototype,"radius",[eB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TB=c(uB.prototype,"radiusThickness",[tB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),EB=c(uB.prototype,"_arc",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return he(360)}}),c(uB.prototype,"arc",[iB],Object.getOwnPropertyDescriptor(uB.prototype,"arc"),uB.prototype),xB=c(uB.prototype,"arcMode",[nB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MO.Random}}),AB=c(uB.prototype,"arcSpread",[rB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),CB=c(uB.prototype,"arcSpeed",[aB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),wB=c(uB.prototype,"_angle",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return he(25)}}),c(uB.prototype,"angle",[sB],Object.getOwnPropertyDescriptor(uB.prototype,"angle"),uB.prototype),RB=c(uB.prototype,"length",[oB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kB=c(uB.prototype,"boxThickness",[lB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(0,0,0)}}),cB=uB))||cB);function WB(e,t){0<t.x&&(e[0]+=.5*pe(-t.x,t.x),e[0]=le(e[0],-.5,.5)),0<t.y&&(e[1]+=.5*pe(-t.y,t.y),e[1]=le(e[1],-.5,.5)),0<t.z&&(e[2]+=.5*pe(-t.z,t.z),e[2]=le(e[2],-.5,.5))}var XB,jB,qB,YB,KB,QB,ZB,JB,$B,eM,tM,iM,nM,rM,aM,sM,oM,lM,cM,uM,hM,dM,fM,pM,_M,vM,mM,yM,gM,bM,SM,TM,EM,xM,AM,CM,wM,RM,kM,OM,FM,LM,BM,MM,IM,PM=function e(t){y(this,e),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=cc.Color.WHITE,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.particleSystem=t,this.position=Oe.create(0,0,0),this.velocity=Oe.create(0,0,0),this.animatedVelocity=Oe.create(0,0,0),this.ultimateVelocity=Oe.create(0,0,0),this.angularVelocity=Oe.create(0,0,0),this.axisOfRotation=Oe.create(0,0,0),this.rotation=Oe.create(0,0,0),this.startSize=Oe.create(0,0,0),this.size=Oe.create(0,0,0),this.startColor=cc.Color.WHITE,this.color=cc.Color.WHITE,this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0},DM=new Br,NM=new Lr,zM=new Dr,UM=[0,0,1,0,0,1,1,1],GM="CC_USE_WORLD_SPACE",VM="CC_USE_BILLBOARD",HM="CC_USE_STRETCHED_BILLBOARD",WM="CC_USE_HORIZONTAL_BILLBOARD",XM="CC_USE_VERTICAL_BILLBOARD",jM="CC_USE_MESH",qM=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD1,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8,isNormalized:!0}],YM=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD1,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8,isNormalized:!0},{name:Kt.GFXAttributeName.ATTR_COLOR1,format:Kt.GFXFormat.RGB32F}],KM=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD1,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8,isNormalized:!0},{name:Kt.GFXAttributeName.ATTR_TEX_COORD2,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_NORMAL,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_COLOR1,format:Kt.GFXFormat.RGBA8,isNormalized:!0}],QM=(XB=un("cc.ParticleSystemRenderer"),jB=hn({type:FO,displayOrder:0}),qB=hn({displayOrder:1}),YB=hn({displayOrder:2}),KB=hn({type:FO,displayOrder:3}),QB=hn({displayOrder:4}),ZB=hn({displayOrder:5}),JB=hn({displayOrder:6}),$B=hn({type:Em,displayOrder:7}),eM=hn({type:_m,displayOrder:8}),tM=hn({type:_m,displayOrder:9}),XB((c((nM=function(){function e(){y(this,e),v(this,"_renderMode",rM,this),v(this,"_velocityScale",aM,this),v(this,"_lengthScale",sM,this),v(this,"_mesh",oM,this),this._defines=void 0,this._trailDefines=void 0,this._model=void 0,this.frameTile_velLenScale=void 0,this._node_scale=void 0,this.attrs=void 0,this._vertAttrs=[],this.particleSystem=void 0,this._particles=null,this._defaultMat=null,this._defaultTrailMat=null,this._model=null,this.frameTile_velLenScale=new Ir(1,1,0,0),this._node_scale=new Ir,this.attrs=new Array(5),this._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},this._trailDefines={CC_USE_WORLD_SPACE:!0}}return l(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._setVertexAttrib(),this._updateModel(),this._updateMaterialParams())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._model&&this._model.setVertexAttributes(this._renderMode===FO.Mesh?this._mesh:null,this._vertAttrs)}},{key:"particleMaterial",get:function(){return this.particleSystem.getMaterial(0)},set:function(e){this.particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this.particleSystem.getMaterial(1)},set:function(e){this.particleSystem.setMaterial(e,1)}}]),l(e,[{key:"onInit",value:function(e){var t=this;this.particleSystem=e.node.getComponent(pP),this._particles=new lv(function(){return new PM(t)},16),this._setVertexAttrib(),this.onEnable(),this._updateModel(),this._updateMaterialParams(),this._updateTrailMaterial()}},{key:"onEnable",value:function(){this.particleSystem&&(null==this._model&&(this._model=this.particleSystem._getRenderScene().createModel(zA,this.particleSystem.node)),this._model.inited||(this._model.setCapacity(this.particleSystem.capacity),this._model.node=this.particleSystem.node),this._model.enabled=this.particleSystem.enabledInHierarchy)}},{key:"onDisable",value:function(){this._model&&(this._model.enabled=this.particleSystem.enabledInHierarchy)}},{key:"onDestroy",value:function(){this.particleSystem._getRenderScene().destroyModel(this._model),this._model=null}},{key:"clear",value:function(){this._particles.reset(),this._updateRenderData()}},{key:"_getFreeParticle",value:function(){return this._particles.length>=this.particleSystem.capacity?null:this._particles.add()}},{key:"_setNewParticle",value:function(e){}},{key:"_updateParticles",value:function(e){switch(this.particleSystem.node.getWorldMatrix(zM),this.particleSystem.scaleSpace){case OO.Local:this.particleSystem.node.getScale(this._node_scale);break;case OO.World:this.particleSystem.node.getWorldScale(this._node_scale)}(this.particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat).setProperty("scale",this._node_scale),this.particleSystem.velocityOvertimeModule.enable&&this.particleSystem.velocityOvertimeModule.update(this.particleSystem._simulationSpace,zM),this.particleSystem.forceOvertimeModule.enable&&this.particleSystem.forceOvertimeModule.update(this.particleSystem._simulationSpace,zM),this.particleSystem.trailModule.enable&&this.particleSystem.trailModule.update();for(var t=0;t<this._particles.length;++t){var i=this._particles.data[t];i.remainingLifetime-=e,Oe.set(i.animatedVelocity,0,0,0),i.remainingLifetime<0?(this.particleSystem.trailModule.enable&&this.particleSystem.trailModule.removeParticle(i),this._particles.removeAt(t),--t):(i.velocity.y-=9.8*this.particleSystem.gravityModifier.evaluate(1-i.remainingLifetime/i.startLifetime,i.randomSeed)*e,this.particleSystem.sizeOvertimeModule.enable&&this.particleSystem.sizeOvertimeModule.animate(i),this.particleSystem.colorOverLifetimeModule.enable&&this.particleSystem.colorOverLifetimeModule.animate(i),this.particleSystem.forceOvertimeModule.enable&&this.particleSystem.forceOvertimeModule.animate(i,e),this.particleSystem.velocityOvertimeModule.enable?this.particleSystem.velocityOvertimeModule.animate(i):Oe.copy(i.ultimateVelocity,i.velocity),this.particleSystem.limitVelocityOvertimeModule.enable&&this.particleSystem.limitVelocityOvertimeModule.animate(i),this.particleSystem.rotationOvertimeModule.enable&&this.particleSystem.rotationOvertimeModule.animate(i,e),this.particleSystem.textureAnimationModule.enable&&this.particleSystem.textureAnimationModule.animate(i),Oe.scaleAndAdd(i.position,i.position,i.ultimateVelocity,e),this.particleSystem.trailModule.enable&&this.particleSystem.trailModule.animate(i,e))}return this._particles.length}},{key:"_updateRenderData",value:function(){for(var e=0,t=this._renderMode===FO.StrecthedBillboard,i=0;i<this._particles.length;++i){var n=this._particles.data[i],r=0;this.particleSystem.textureAnimationModule.enable&&(r=n.frameIndex),e=4*i;var a=0;if(this._renderMode!==FO.Mesh)for(var s=0;s<4;++s)a=0,this.attrs[a++]=n.position,DM.x=UM[2*s],DM.y=UM[2*s+1],DM.z=r,this.attrs[a++]=DM,NM.x=n.size.x,NM.y=n.rotation.x,this.attrs[a++]=NM,this.attrs[a++]=n.color._val,this.attrs[a++]=t?n.ultimateVelocity:null,this._model.addParticleVertexData(e++,this.attrs);else a=0,this.attrs[a++]=n.position,DM.z=r,this.attrs[a++]=DM,NM.x=n.size.x,NM.y=n.rotation.x,this.attrs[a++]=NM,this.attrs[a++]=n.color._val,this._model.addParticleVertexData(i,this.attrs)}this._model.updateIA(this._particles.length)}},{key:"updateShaderUniform",value:function(){}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"_onMaterialModified",value:function(e,t){0===e?(this._updateMaterialParams(),this._updateModel()):this._updateTrailMaterial()}},{key:"_onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t),this.particleSystem.trailModule._trailModel&&1===e&&this.particleSystem.trailModule._trailModel.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderMode){case FO.StrecthedBillboard:this._vertAttrs=YM.slice();break;case FO.Mesh:this._vertAttrs=KM.slice();break;default:this._vertAttrs=qM.slice()}}},{key:"_updateMaterialParams",value:function(){if(this.particleSystem){null!=this.particleSystem.sharedMaterial&&-1===this.particleSystem.sharedMaterial._effectAsset._name.indexOf("particle")&&this.particleSystem.setMaterial(null,0,!1),null==this.particleSystem.sharedMaterial&&null==this._defaultMat&&(this._defaultMat=_m.getInstantiatedMaterial(Vv.get("default-particle-material"),this.particleSystem,!0));var e=this.particleSystem.sharedMaterial?this.particleMaterial:this._defaultMat;this.particleSystem._simulationSpace===OO.World?this._defines[GM]=!0:this._defines[GM]=!1,this._renderMode===FO.Billboard?(this._defines[VM]=!0,this._defines[HM]=!1,this._defines[WM]=!1,this._defines[XM]=!1,this._defines[jM]=!1):this._renderMode===FO.StrecthedBillboard?(this._defines[VM]=!1,this._defines[HM]=!0,this._defines[WM]=!1,this._defines[XM]=!1,this._defines[jM]=!1,this.frameTile_velLenScale.z=this._velocityScale,this.frameTile_velLenScale.w=this._lengthScale):this._renderMode===FO.HorizontalBillboard?(this._defines[VM]=!1,this._defines[HM]=!1,this._defines[WM]=!0,this._defines[XM]=!1,this._defines[jM]=!1):this._renderMode===FO.VerticalBillboard?(this._defines[VM]=!1,this._defines[HM]=!1,this._defines[WM]=!1,this._defines[XM]=!0,this._defines[jM]=!1):this._renderMode===FO.Mesh?(this._defines[VM]=!1,this._defines[HM]=!1,this._defines[WM]=!1,this._defines[XM]=!1,this._defines[jM]=!0):console.warn("particle system renderMode ".concat(this._renderMode," not support.")),e.recompileShaders(this._defines),this.particleSystem.textureAnimationModule.enable&&we.set(this.frameTile_velLenScale,this.particleSystem.textureAnimationModule.numTilesX,this.particleSystem.textureAnimationModule.numTilesY),e.setProperty("frameTile_velLenScale",this.frameTile_velLenScale),this._model&&this._model.setSubModelMaterial(0,this.particleSystem.sharedMaterial||this._defaultMat)}}},{key:"_updateTrailMaterial",value:function(){if(this.particleSystem.trailModule.enable){this.particleSystem._simulationSpace===OO.World||this.particleSystem.trailModule.space===OO.World?this._trailDefines[GM]=!0:this._trailDefines[GM]=!1;var e=this.trailMaterial;null===e&&null===this._defaultTrailMat&&(this._defaultTrailMat=_m.getInstantiatedMaterial(Vv.get("default-trail-material"),this.particleSystem,!0)),null===e&&(e=this._defaultTrailMat),e.recompileShaders(this._trailDefines),this.particleSystem.trailModule._updateMaterial()}}},{key:"_updateModel",value:function(){this._model&&this._model.setVertexAttributes(this._renderMode===FO.Mesh?this._mesh:null,this._vertAttrs)}}]),e}()).prototype,"renderMode",[jB],Object.getOwnPropertyDescriptor(nM.prototype,"renderMode"),nM.prototype),c(nM.prototype,"velocityScale",[qB],Object.getOwnPropertyDescriptor(nM.prototype,"velocityScale"),nM.prototype),c(nM.prototype,"lengthScale",[YB],Object.getOwnPropertyDescriptor(nM.prototype,"lengthScale"),nM.prototype),rM=c(nM.prototype,"_renderMode",[KB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FO.Billboard}}),aM=c(nM.prototype,"_velocityScale",[QB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sM=c(nM.prototype,"_lengthScale",[ZB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oM=c(nM.prototype,"_mesh",[JB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c(nM.prototype,"mesh",[$B],Object.getOwnPropertyDescriptor(nM.prototype,"mesh"),nM.prototype),c(nM.prototype,"particleMaterial",[eM],Object.getOwnPropertyDescriptor(nM.prototype,"particleMaterial"),nM.prototype),c(nM.prototype,"trailMaterial",[tM],Object.getOwnPropertyDescriptor(nM.prototype,"trailMaterial"),nM.prototype),iM=nM))||iM);Object.assign(QM,{uv:UM});var ZM,JM,$M,eI,tI,iI,nI,rI,aI,sI,oI,lI,cI,uI,hI,dI,fI,pI,_I,vI,mI,yI,gI,bI,SI,TI,EI,xI,AI,CI,wI,RI,kI,OI,FI,LI,BI,MI,II,PI,DI,NI,zI,UI,GI,VI,HI,WI,XI,jI,qI,YI,KI,QI,ZI,JI,$I,eP,tP,iP,nP,rP,aP={position:cc.v3(),velocity:cc.v3()},sP=cc.quat(),oP=cc.mat4(),lP=cc.v3(),cP=cc.v3(),uP=cc.color(),hP=function(){function t(e){for(y(this,t),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:cc.v3(),lifetime:0,width:0,velocity:cc.v3(),color:cc.color()})}return l(t,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),t}(),dP=(lM=un("cc.TrailModule"),cM=hn({displayOrder:0}),uM=hn({type:IO,displayOrder:1}),hM=hn({type:gO,displayOrder:3}),dM=hn({displayOrder:5}),fM=hn({type:OO}),pM=hn({type:OO,displayOrder:6}),_M=hn({displayOrder:7}),vM=hn({type:PO,displayOrder:8}),mM=hn({displayOrder:9}),yM=hn({type:gO,displayOrder:10}),gM=hn({displayOrder:11}),bM=hn({type:AO,displayOrder:12}),SM=hn({type:AO,displayOrder:13}),lM((c((EM=function(){function a(){y(this,a),v(this,"_enable",xM,this),v(this,"mode",AM,this),v(this,"lifeTime",CM,this),v(this,"_minParticleDistance",wM,this),v(this,"_space",RM,this),v(this,"existWithParticles",kM,this),v(this,"textureMode",OM,this),v(this,"widthFromParticle",FM,this),v(this,"widthRatio",LM,this),v(this,"colorFromParticle",BM,this),v(this,"colorOverTrail",MM,this),v(this,"colorOvertime",IM,this),this._particleSystem=void 0,this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=void 0,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=void 0,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=void 0,this._vbUint32=void 0,this._iBuffer=void 0,this._needTransform=void 0,this._defaultMat=null,this._iaInfo={drawInfos:[{vertexCount:0,firstVertex:0,indexCount:0,firstIndex:0,vertexOffset:0,instanceCount:0,firstInstance:0}]},this._vertAttrs=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RGBA32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD1,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA8,isNormalized:!0}],this._vertSize=0;var e=this._vertAttrs,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;this._vertSize+=ls[r.format].size}this._particleTrail=new Map}return l(a,[{key:"enable",get:function(){return this._enable},set:function(e){e&&!this._trailModel&&this._createModel(),e&&!this._enable&&(this._enable=e,this._particleSystem.renderer._updateTrailMaterial()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e)}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem.renderer._updateTrailMaterial()}}]),l(a,[{key:"init",value:function(e){var t=this,i=0,n=(this._particleSystem=e).bursts,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}i+=s.getMaxCount(e)}this._trailNum=Math.ceil(e.startLifetime.getMax()*this.lifeTime.getMax()*60*(e.rateOverTime.getMax()*e.duration+i)),this._trailSegments=new kn(function(){return new hP(Math.ceil(e.startLifetime.getMax()*t.lifeTime.getMax()*60))},Math.ceil(e.rateOverTime.getMax()*e.duration)),this._enable&&(this.enable=this._enable,this._updateMaterial())}},{key:"onEnable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!0)}},{key:"onDisable",value:function(){this._enable&&this._trailModel&&(this._trailModel.enabled=!1)}},{key:"destroy",value:function(){this._trailModel&&(this._particleSystem._getRenderScene().destroyModel(this._trailModel),this._trailModel=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"_createModel",value:function(){if(!this._trailModel){var e=cc.director.root.device,t=e.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:this._vertSize*(this._trailNum+1)*2,stride:this._vertSize}),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,stride:Uint16Array.BYTES_PER_ELEMENT});this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer({usage:Jr.INDIRECT,memUsage:ea.HOST|ea.DEVICE,size:56,stride:1}),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData={vertexBuffers:[t],indexBuffer:n,indirectBuffer:this._iaInfoBuffer,attributes:this._vertAttrs,primitiveMode:Kt.GFXPrimitiveMode.TRIANGLE_LIST},this._trailModel=this._particleSystem._getRenderScene().createModel(Bv,this._particleSystem.node),this._trailModel.setSubModelMesh(0,this._subMeshData),this._trailModel.enabled=!0}}},{key:"_updateMaterial",value:function(){if(this._particleSystem){var e=this._particleSystem.renderer.trailMaterial;e?this._trailModel.setSubModelMaterial(0,e):this._trailModel.setSubModelMaterial(0,this._particleSystem.renderer._defaultTrailMat)}}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===OO.World&&this._particleSystem._simulationSpace===OO.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(oP),this._particleSystem.node.getWorldRotation(sP)):this._needTransform=!1}},{key:"animate",value:function(e,t){var i=this._particleTrail.get(e);i||(i=this._trailSegments.alloc(),this._particleTrail.set(e,i));var n=i.getElement(i.end-1);if(this._needTransform?Oe.transformMat4(lP,e.position,oP):Oe.copy(lP,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),Oe.squaredDistance(n.position,lP)<this._minSquaredDistance))&&(n=i.addElement())){Oe.copy(n.position,lP),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);Oe.subtract(a.velocity,n.position,a.position)}else if(2<r){var s=i.getElement(i.end-2),o=i.getElement(i.end-3);Oe.subtract(lP,o.position,s.position),Oe.subtract(cP,n.position,s.position),Oe.subtract(s.velocity,cP,lP)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?i.color.mul(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1),t.color):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;var e=this._particleTrail.keys(),t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n,a=this._particleTrail.get(r);if(-1!==a.start){var s=4*this.vbOffset/this._vertSize,o=a.start>=a.end?a.end+a.trailElements.length:a.end,l=o-a.start,c=1/l,u=a.trailElements[a.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),s,0,0,4);for(var h=a.start+1;h<o;h++){var d=a.trailElements[h%a.trailElements.length],f=h-a.start;this._fillVertexBuffer(d,this.colorOverTrail.evaluate(1-f/l,1),s,f*c,f,5)}if(this._needTransform?Oe.transformMat4(aP.position,r.position,oP):Oe.copy(aP.position,r.position),1===l){var p=a.getElement(a.end-1);Oe.subtract(p.velocity,aP.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,Oe.subtract(aP.velocity,aP.position,p.position)}else if(2<l){var _=a.getElement(a.end-1),v=a.getElement(a.end-2);Oe.subtract(lP,v.position,_.position),Oe.subtract(cP,aP.position,_.position),Oe.subtract(_.velocity,cP,lP),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,Oe.subtract(aP.velocity,aP.position,_.position)}aP.width=r.size.x,aP.color=r.color,this._fillVertexBuffer(aP,this.colorOverTrail.evaluate(0,1),s,1,l,1)}}this.updateIA(this.ibOffset)}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,e.color.mul(t,uP),this._vbUint32[this.vbOffset++]=uP._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=uP._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"updateIA",value:function(e){this._trailModel.getSubModel(0).inputAssembler.vertexBuffers[0].update(this._vbF32),this._trailModel.getSubModel(0).inputAssembler.indexBuffer.update(this._iBuffer),this._trailModel.getSubModel(0).inputAssembler.indexCount=e,this._trailModel.getSubModel(0).inputAssembler.extractDrawInfo(this._iaInfo.drawInfos[0]),this._iaInfoBuffer.update(this._iaInfo)}}]),a}()).prototype,"enable",[cM],Object.getOwnPropertyDescriptor(EM.prototype,"enable"),EM.prototype),xM=c(EM.prototype,"_enable",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AM=c(EM.prototype,"mode",[uM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IO.Particles}}),CM=c(EM.prototype,"lifeTime",[hM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),c(EM.prototype,"minParticleDistance",[dM],Object.getOwnPropertyDescriptor(EM.prototype,"minParticleDistance"),EM.prototype),wM=c(EM.prototype,"_minParticleDistance",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),RM=c(EM.prototype,"_space",[fM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.World}}),c(EM.prototype,"space",[pM],Object.getOwnPropertyDescriptor(EM.prototype,"space"),EM.prototype),kM=c(EM.prototype,"existWithParticles",[_M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),OM=c(EM.prototype,"textureMode",[vM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PO.Stretch}}),FM=c(EM.prototype,"widthFromParticle",[mM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LM=c(EM.prototype,"widthRatio",[yM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),BM=c(EM.prototype,"colorFromParticle",[gM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MM=c(EM.prototype,"colorOverTrail",[bM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AO}}),IM=c(EM.prototype,"colorOvertime",[SM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AO}}),TM=EM))||TM),fP=new Dr,pP=(ZM=un("cc.ParticleSystemComponent"),JM=vn("Components/ParticleSystemComponent"),$M=mn(99),eI=hn({displayOrder:1}),tI=hn({type:AO,displayOrder:8}),iI=hn({type:OO,displayOrder:9}),nI=hn({type:gO,displayOrder:10}),rI=hn({type:gO,range:[-1,1],displayOrder:11}),aI=hn({type:gO,range:[-1,1],radian:!0,displayOrder:12}),sI=hn({type:gO,displayOrder:6}),oI=hn({type:gO,displayOrder:7}),lI=hn({displayOrder:0}),cI=hn({displayOrder:2}),uI=hn({displayOrder:3}),hI=hn({type:OO,displayOrder:4}),dI=hn({displayOrder:5}),fI=hn({displayOrder:2}),pI=hn({type:gO,range:[-1,1],displayOrder:13}),_I=hn({type:gO,displayOrder:14}),vI=hn({type:gO,displayOrder:15}),mI=hn({type:[zB],displayOrder:16}),yI=hn({type:_m,displayName:"Materials",visible:!1,override:!0}),gI=hn({type:kO,displayOrder:23}),bI=hn({type:HB,displayOrder:17}),SI=hn({type:FB,displayOrder:21}),TI=hn({type:NB,displayOrder:18}),EI=hn({type:AF,displayOrder:19}),xI=hn({type:RF,displayOrder:20}),AI=hn({type:OB,displayOrder:22}),CI=hn({type:IB,displayOrder:24}),wI=hn({type:dP,displayOrder:25}),RI=hn({type:QM,displayOrder:26}),ZM(kI=JM(kI=$M(kI=pn((c((OI=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"startColor",FI,d(d(e))),v(e,"scaleSpace",LI,d(d(e))),v(e,"startSize",BI,d(d(e))),v(e,"startSpeed",MI,d(d(e))),v(e,"startRotation",II,d(d(e))),v(e,"startDelay",PI,d(d(e))),v(e,"startLifetime",DI,d(d(e))),v(e,"duration",NI,d(d(e))),v(e,"loop",zI,d(d(e))),v(e,"simulationSpeed",UI,d(d(e))),v(e,"playOnAwake",GI,d(d(e))),v(e,"gravityModifier",VI,d(d(e))),v(e,"rateOverTime",HI,d(d(e))),v(e,"rateOverDistance",WI,d(d(e))),v(e,"bursts",XI,d(d(e))),v(e,"colorOverLifetimeModule",jI,d(d(e))),v(e,"shapeModule",qI,d(d(e))),v(e,"sizeOvertimeModule",YI,d(d(e))),v(e,"velocityOvertimeModule",KI,d(d(e))),v(e,"forceOvertimeModule",QI,d(d(e))),v(e,"limitVelocityOvertimeModule",ZI,d(d(e))),v(e,"rotationOvertimeModule",JI,d(d(e))),v(e,"textureAnimationModule",$I,d(d(e))),v(e,"trailModule",eP,d(d(e))),v(e,"renderer",tP,d(d(e))),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,v(e,"_prewarm",iP,d(d(e))),v(e,"_capacity",nP,d(d(e))),v(e,"_simulationSpace",rP,d(d(e))),e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSize.constant=1,e.startSpeed.constant=1,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new Br,e._curWPos=new Br,e._customData1=new Lr,e._customData2=new Lr,e._subEmitters=[],e}return p(t,AT),l(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=e,this.renderer&&this.renderer._model&&this.renderer._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.renderer._updateMaterialParams(),this.renderer._updateTrailMaterial())}},{key:"sharedMaterials",get:function(){return _(S(t.prototype),"sharedMaterials",this)},set:function(e){b(S(t.prototype),"sharedMaterials",e,this,!0)}}]),l(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this.shapeModule.onInit(this),this.trailModule.init(this),this.textureAnimationModule.onInit(this),this.node.getWorldPosition(this._oldWPos),Oe.copy(this._curWPos,this._oldWPos)}},{key:"_onMaterialModified",value:function(e,t){this.renderer._onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.renderer._onRebuildPSO(e,t)}},{key:"_getModel",value:function(){return this.renderer._model}},{key:"recreateModel",value:function(){var e=this.renderer;e._model&&(e._model.destroy(),e._model=null,e.onEnable())}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.renderer.clear(),this.trailModule.clear()}},{key:"getParticleCount",value:function(){return this.renderer.getParticleCount()}},{key:"setCustomData1",value:function(e,t){we.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){we.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.renderer.onDestroy(),this.trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.renderer.onEnable(),this.trailModule.onEnable()}},{key:"onDisable",value:function(){this.renderer.onDisable(),this.trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.renderer._updateParticles(t)||this._isEmitting||this.stop(),this.renderer._updateRenderData(),this.trailModule.enable&&this.trailModule.updateRenderData())}},{key:"_onVisiblityChange",value:function(e){this.renderer._model&&(this.renderer._model.viewID=e)}},{key:"emit",value:function(e,t){for(var i=0;i<e;++i){var n=this.renderer._getFreeParticle();if(null===n)return;var r=ve(_e(0,Te));switch(this.shapeModule.enable?this.shapeModule.emit(n):(Oe.set(n.position,0,0,0),Oe.copy(n.velocity,DO)),Oe.scale(n.velocity,n.velocity,this.startSpeed.evaluate(this._time/this.duration,r)),this._simulationSpace){case OO.Local:break;case OO.World:this.node.getWorldMatrix(fP),Oe.transformMat4(n.position,n.position,fP);var a=new Pr;this.node.getWorldRotation(a),Oe.transformQuat(n.velocity,n.velocity,a);break;case OO.Custom:}Oe.copy(n.ultimateVelocity,n.velocity),Oe.set(n.rotation,this.startRotation.evaluate(this._time/this.duration,r),0,0),Oe.set(n.startSize,this.startSize.evaluate(this._time/this.duration,r),0,0),Oe.copy(n.size,n.startSize),n.startColor.set(this.startColor.evaluate(this._time/this.duration,r)),n.color.set(n.startColor),n.startLifetime=this.startLifetime.evaluate(this._time/this.duration,r)+t,n.remainingLifetime=n.startLifetime,n.randomSeed=_e(0,233280),this.renderer._setNewParticle(n)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode="constant",this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.renderer._updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,1<this._emitRateTimeCounter&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=Oe.distance(this._curWPos,this._oldWPos);if(Oe.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),1<this._emitRateDistanceCounter&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}var a=this.bursts,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}l.update(this,e)}}}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}()).prototype,"capacity",[eI],Object.getOwnPropertyDescriptor(OI.prototype,"capacity"),OI.prototype),FI=c(OI.prototype,"startColor",[tI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AO}}),LI=c(OI.prototype,"scaleSpace",[iI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.Local}}),BI=c(OI.prototype,"startSize",[nI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),MI=c(OI.prototype,"startSpeed",[rI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),II=c(OI.prototype,"startRotation",[aI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),PI=c(OI.prototype,"startDelay",[sI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),DI=c(OI.prototype,"startLifetime",[oI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),NI=c(OI.prototype,"duration",[lI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),zI=c(OI.prototype,"loop",[cI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),c(OI.prototype,"prewarm",[uI],Object.getOwnPropertyDescriptor(OI.prototype,"prewarm"),OI.prototype),c(OI.prototype,"simulationSpace",[hI],Object.getOwnPropertyDescriptor(OI.prototype,"simulationSpace"),OI.prototype),UI=c(OI.prototype,"simulationSpeed",[dI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),GI=c(OI.prototype,"playOnAwake",[fI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VI=c(OI.prototype,"gravityModifier",[pI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),HI=c(OI.prototype,"rateOverTime",[_I],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),WI=c(OI.prototype,"rateOverDistance",[vI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gO}}),XI=c(OI.prototype,"bursts",[mI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),c(OI.prototype,"sharedMaterials",[yI],Object.getOwnPropertyDescriptor(OI.prototype,"sharedMaterials"),OI.prototype),jI=c(OI.prototype,"colorOverLifetimeModule",[gI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kO}}),qI=c(OI.prototype,"shapeModule",[bI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HB}}),YI=c(OI.prototype,"sizeOvertimeModule",[SI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FB}}),KI=c(OI.prototype,"velocityOvertimeModule",[TI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NB}}),QI=c(OI.prototype,"forceOvertimeModule",[EI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AF}}),ZI=c(OI.prototype,"limitVelocityOvertimeModule",[xI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RF}}),JI=c(OI.prototype,"rotationOvertimeModule",[AI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new OB}}),$I=c(OI.prototype,"textureAnimationModule",[CI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IB}}),eP=c(OI.prototype,"trailModule",[wI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dP}}),tP=c(OI.prototype,"renderer",[RI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QM}}),iP=c(OI.prototype,"_prewarm",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nP=c(OI.prototype,"_capacity",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),rP=c(OI.prototype,"_simulationSpace",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OO.Local}}),kI=OI))||kI)||kI)||kI)||kI),_P=function(){function e(){y(this,e)}return l(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new kn(function(){return cc.instantiate(e)},1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach(function(e){e.clear(function(e){e.destroy()})}),this.particleSystemPool.clear()}},{key:"play",value:function(e){var t=e.getComponentsInChildren(cc.ParticleSystemComponent),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.play()}}},{key:"stop",value:function(e){var t=e.getComponentsInChildren(cc.ParticleSystemComponent),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.stop()}}}]),e}();function vP(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}_P.particleSystemPool=new Map,_P.registeredSceneEvent=!1;var mP,yP,gP,bP,SP,TP=(function(e,t){e.exports=function r(a,s,o){function l(i,e){if(!s[i]){if(!a[i]){var t=vP;if(!e&&t)return t(i,!0);if(c)return c(i,!0);throw new Error("Cannot find module '"+i+"'")}var n=s[i]={exports:{}};a[i][0].call(n.exports,function(e){var t=a[i][1][e];return l(t||e)},n,n.exports,r,a,s,o)}return s[i].exports}for(var c=vP,e=0;e<o.length;e++)l(o[e]);return l}({1:[function(e,t,i){t.exports={name:"cannon",version:"1.0.0",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"JayceLai",keywords:["cannon.js","cannon","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -d doProfiling=false,CANNON=false,DEBUG=false -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t,i){var n=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var c=new n;r.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,a=this.upperBound,s=i;r.copy(e[0]),s&&s.vmult(r,r),a.copy(r);for(var o=1;o<e.length;o++){var l=e[o];s&&(s.vmult(l,c),l=c),l.x>a.x&&(a.x=l.x),l.x<r.x&&(r.x=l.x),l.y>a.y&&(a.y=l.y),l.y<r.y&&(r.y=l.y),l.z>a.z&&(a.z=l.z),l.z<r.z&&(r.z=l.z)}return t&&(t.vadd(r,r),t.vadd(a,a)),n&&(r.x-=n,r.y-=n,r.z-=n,a.x+=n,a.y+=n,a.z+=n),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound,a=n.x<=i.x&&i.x<=r.x||t.x<=r.x&&r.x<=i.x,s=n.y<=i.y&&i.y<=r.y||t.y<=r.y&&r.y<=i.y,o=n.z<=i.z&&i.z<=r.z||t.z<=r.z&&r.z<=i.z;return a&&s&&o},r.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound;return t.x<=n.x&&i.x>=r.x&&t.y<=n.y&&i.y>=r.y&&t.z<=n.z&&i.z>=r.z},r.prototype.getCorners=function(e,t,i,n,r,a,s,o){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),n.set(l.x,c.y,c.z),r.set(c.x,l.y,l.z),a.set(l.x,c.y,l.z),s.set(l.x,l.y,c.z),o.copy(c)};var f=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=f,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,r,a,s,o,l,c,u);for(var h=0;8!==h;h++){var d=i[h];e.pointToLocal(d,d)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=f,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,r,a,s,o,l,c,u);for(var h=0;8!==h;h++){var d=i[h];e.pointToWorld(d,d)}return t.setFromPoints(i)},r.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,a=(this.upperBound.x-e.from.x)*t,s=(this.lowerBound.y-e.from.y)*i,o=(this.upperBound.y-e.from.y)*i,l=(this.lowerBound.z-e.from.z)*n,c=(this.upperBound.z-e.from.z)*n,u=Math.max(Math.max(Math.min(r,a),Math.min(s,o)),Math.min(l,c)),h=Math.min(Math.min(Math.max(r,a),Math.max(s,o)),Math.max(l,c));return!(h<0||h<u)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t,i){function n(){this.matrix=[]}(t.exports=n).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var n=e("../objects/Body"),r=e("../math/Vec3"),a=e("../math/Quaternion");function s(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=s).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},s.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(0==(e.type&n.STATIC)&&e.sleepState!==n.SLEEPING||0==(t.type&n.STATIC)&&t.sleepState!==n.SLEEPING)},s.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var o=new r;new r,new a,new r,s.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=o;t.position.vsub(e.position,r);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<a&&(i.push(e),n.push(t))},s.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var h={keys:[]},d=[],f=[];s.prototype.makePairsUnique=function(e,t){for(var i=h,n=d,r=f,a=e.length,s=0;s!==a;s++)n[s]=e[s],r[s]=t[s];for(e.length=0,s=t.length=0;s!==a;s++){var o=n[s].id,l=r[s].id;i[c=o<l?o+","+l:l+","+o]=s,i.keys.push(c)}for(s=0;s!==i.keys.length;s++){var c=i.keys.pop(),u=i[c];e.push(n[u]),t.push(r[u]),delete i[c]}},s.prototype.setWorld=function(e){};var l=new r;s.boundingSphereCheck=function(e,t){var i=l;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},s.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t,i){t.exports=n;var o=e("./Broadphase"),l=e("../math/Vec3"),ie=e("../shapes/Shape");function n(e,t,i,n,r){o.apply(this),this.nx=i||10,this.ny=n||10,this.nz=r||10,this.aabbMin=e||new l(100,100,100),this.aabbMax=t||new l(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var s=0;s<a;s++)this.bins[s]=[],this.binLengths[s]=0}(n.prototype=new o).constructor=n;var ne=new l;new l,n.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),r=e.bodies,a=this.aabbMax,s=this.aabbMin,m=this.nx,y=this.ny,g=this.nz,b=y*g,S=g,T=1,o=a.x,l=a.y,c=a.z,E=s.x,x=s.y,A=s.z,C=m/(o-E),w=y/(l-x),R=g/(c-A),u=(o-E)/m,h=(l-x)/y,d=(c-A)/g,f=.5*Math.sqrt(u*u+h*h+d*d),p=ie.types,_=p.SPHERE,v=p.PLANE,k=(p.BOX,p.COMPOUND,p.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,F=this.bins.length,L=0;L!==F;L++)O[L]=0;var B=Math.ceil;function M(e,t,i,n,r,a,s){var o=(e-E)*C|0,l=(t-x)*w|0,c=(i-A)*R|0,u=B((n-E)*C),h=B((r-x)*w),d=B((a-A)*R);o<0?o=0:m<=o&&(o=m-1),l<0?l=0:y<=l&&(l=y-1),c<0?c=0:g<=c&&(c=g-1),u<0?u=0:m<=u&&(u=m-1),h<0?h=0:y<=h&&(h=y-1),d<0?d=0:g<=d&&(d=g-1),l*=S,c*=T,u*=b,h*=S,d*=T;for(var f=o*=b;f<=u;f+=b)for(var p=l;p<=h;p+=S)for(var _=c;_<=d;_+=T){var v=f+p+_;k[v][O[v]++]=s}}for(s=Math.min,a=Math.max,L=0;L!==n;L++){var I=(ee=r[L]).shape;switch(I.type){case _:var P=ee.position.x,D=ee.position.y,N=ee.position.z,z=I.radius;M(P-z,D-z,N-z,P+z,D+z,N+z,ee);break;case v:I.worldNormalNeedsUpdate&&I.computeWorldNormal(ee.quaternion);var U=I.worldNormal,G=E+.5*u-ee.position.x,V=x+.5*h-ee.position.y,H=A+.5*d-ee.position.z,W=ne;W.set(G,V,H);for(var X=0,j=0;X!==m;X++,j+=b,W.y=V,W.x+=u)for(var q=0,Y=0;q!==y;q++,Y+=S,W.z=H,W.y+=h)for(var K=0,Q=0;K!==g;K++,Q+=T,W.z+=d)if(W.dot(U)<f){var Z=j+Y+Q;k[Z][O[Z]++]=ee}break;default:ee.aabbNeedsUpdate&&ee.computeAABB(),M(ee.aabb.lowerBound.x,ee.aabb.lowerBound.y,ee.aabb.lowerBound.z,ee.aabb.upperBound.x,ee.aabb.upperBound.y,ee.aabb.upperBound.z,ee)}}for(L=0;L!==F;L++){var J=O[L];if(1<J){var $=k[L];for(X=0;X!==J;X++){var ee=$[X];for(q=0;q!==X;q++){var te=$[q];this.needBroadphaseCollision(ee,te)&&this.intersectionTest(ee,te,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t,i){t.exports=a;var n=e("./Broadphase"),r=e("./AABB");function a(){n.apply(this)}((a.prototype=new n).constructor=a).prototype.collisionPairs=function(e,t,i){var n,r,a,s,o=e.bodies,l=o.length;for(n=0;n!==l;n++)for(r=0;r!==n;r++)a=o[n],s=o[r],this.needBroadphaseCollision(a,s)&&this.intersectionTest(a,s,t,i)},new r,a.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function n(){this.matrix={}}(t.exports=n).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function n(){this.current=[],this.previous=[]}function u(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=n).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},n.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.reset=function(){this.previous.length=0,this.current.length=0},n.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,r=i.length,a=n.length,s=0,o=0;o<r;o++){for(var l=i[o];l>n[s];)s++;l===n[s]||u(e,l)}for(o=s=0;o<a;o++){for(var c=n[o];c>i[s];)s++;i[s]===c||u(t,c)}},n.prototype.copy=function(e){this.current.length=0,this.previous.length=0,this.current=e.current.slice(),this.previous=e.previous.slice()}},{}],10:[function(e,t,i){t.exports=c;var v=e("../math/Vec3"),n=e("../math/Quaternion"),C=e("../math/Transform"),r=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),p=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new v,this.to=t?t.clone():new v,this._direction=new v,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new r,this.hasHit=!1,this.callback=function(e){}}(c.prototype.constructor=c).CLOSEST=1,c.ANY=2,c.ALL=4;var s=new p,o=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new r,this.skipBackfaces=!!t.skipBackfaces,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(s),o.length=0,e.broadphase.aabbQuery(e,s,o),this.intersectBodies(o),this.hasHit};var h=new v,d=new v;function R(e,t,i,n){n.vsub(t,f),i.vsub(t,h),e.vsub(t,d);var r,a,s=f.dot(f),o=f.dot(h),l=f.dot(d),c=h.dot(h),u=h.dot(d);return 0<=(r=c*l-o*u)&&0<=(a=s*u-o*l)&&r+a<s*c-o*o}c.pointInTriangle=R;var l=new v,u=new n;c.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=l,r=u,a=0,s=e.shapes.length;a<s;a++){var o=e.shapes[a];if((!i||o.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],r),e.quaternion.vmult(e.shapeOffsets[a],n),n.vadd(e.position,n),this.intersectShape(o,r,n,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,f);var n=f.dot(t);return t.mult(n,T),T.vadd(e,T),i.distanceTo(T)}(this.from,this._direction,i)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,i,n,e)}},new v,new v;var k=new v,O=new v,F=new v,L=new v;new v,new r,c.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,i,n,r){var a=this.from,s=this.to,o=this._direction,l=new v(0,0,1);t.vmult(l,l);var c=new v;a.vsub(i,c);var u=c.dot(l);if(s.vsub(i,c),!(0<u*c.dot(l)||a.distanceTo(s)<u)){var h=l.dot(o);if(!(Math.abs(h)<this.precision)){var d=new v,f=new v,p=new v;a.vsub(i,d);var _=-l.dot(d)/h;o.scale(_,f),a.vadd(f,p),this.reportIntersection(l,p,r,n,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var _={faceList:[0]},m=new v,y=new c,g=[];c.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var a=y;a.from.copy(this.from),a.to.copy(this.to),C.pointToLocalFrame(i,t,a.from,a.from),C.pointToLocalFrame(i,t,a.to,a.to),a._updateDirection();var s,o,l,c,u=g;s=o=0,l=c=e.data.length-1;var h=new p;a.getAABB(h),e.getIndexOfPosition(h.lowerBound.x,h.lowerBound.y,u,!0),s=Math.max(s,u[0]),o=Math.max(o,u[1]),e.getIndexOfPosition(h.upperBound.x,h.upperBound.y,u,!0),l=Math.min(l,u[0]+1),c=Math.min(c,u[1]+1);for(var d=s;d<l;d++)for(var f=o;f<c;f++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(d,f,h),h.overlapsRay(a)){if(e.getConvexTrianglePillar(d,f,!1),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_),this.result._shouldStop)return;e.getConvexTrianglePillar(d,f,!0),C.pointToWorldFrame(i,t,e.pillarOffset,m),this.intersectConvex(e.pillarConvex,t,m,n,r,_)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var b=new v,S=new v;c.prototype.intersectSphere=function(e,t,i,n,r){var a=this.from,s=this.to,o=e.radius,l=Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)+Math.pow(s.z-a.z,2),c=2*((s.x-a.x)*(a.x-i.x)+(s.y-a.y)*(a.y-i.y)+(s.z-a.z)*(a.z-i.z)),u=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(o,2),h=Math.pow(c,2)-4*l*u,d=b,f=S;if(!(h<0))if(0==h)a.lerp(s,h,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1);else{var p=(-c-Math.sqrt(h))/(2*l),_=(-c+Math.sqrt(h))/(2*l);if(0<=p&&p<=1&&(a.lerp(s,p,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1)),this.result._shouldStop)return;0<=_&&_<=1&&(a.lerp(s,_,d),d.vsub(i,f),f.normalize(),this.reportIntersection(f,d,r,n,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var B=new v,M=(new v,new v,new v);c.prototype.intersectConvex=function(e,t,i,n,r,a){for(var s=B,o=M,l=a&&a.faceList||null,c=e.faces,u=e.vertices,h=e.faceNormals,d=this._direction,f=this.from,p=this.to,_=f.distanceTo(p),v=l?l.length:c.length,m=this.result,y=0;!m._shouldStop&&y<v;y++){var g=l?l[y]:y,b=c[g],S=h[g],T=t,E=i;o.copy(u[b[0]]),T.vmult(o,o),o.vadd(E,o),o.vsub(f,o),T.vmult(S,s);var x=d.dot(s);if(!(Math.abs(x)<this.precision)){var A=s.dot(o)/x;if(!(A<0)){d.mult(A,k),k.vadd(f,k),O.copy(u[b[0]]),T.vmult(O,O),E.vadd(O,O);for(var C=1;!m._shouldStop&&C<b.length-1;C++){F.copy(u[b[C]]),L.copy(u[b[C+1]]),T.vmult(F,F),T.vmult(L,L),E.vadd(F,F),E.vadd(L,L);var w=k.distanceTo(f);!R(k,O,F,L)&&!R(k,F,O,L)||_<w||this.reportIntersection(s,k,r,n,g)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var w=new v,I=new v,P=new v,D=new v,N=new v,z=new v,U=(new p,[]),G=new C;c.prototype.intersectTrimesh=function(e,t,i,n,r,a){var s=w,o=U,l=G,c=M,u=I,h=P,d=D,f=z,p=N,_=(a&&a.faceList,e.indices),v=(e.vertices,e.faceNormals,this.from),m=this.to,y=this._direction;l.position.copy(i),l.quaternion.copy(t),C.vectorToLocalFrame(i,t,y,u),C.pointToLocalFrame(i,t,v,h),C.pointToLocalFrame(i,t,m,d),d.x*=e.scale.x,d.y*=e.scale.y,d.z*=e.scale.z,h.x*=e.scale.x,h.y*=e.scale.y,h.z*=e.scale.z,d.vsub(h,u),u.normalize();var g=h.distanceSquared(d);e.tree.rayQuery(this,l,o);for(var b=0,S=o.length;!this.result._shouldStop&&b!==S;b++){var T=o[b];e.getNormal(T,s),e.getVertex(_[3*T],O),O.vsub(h,c);var E=u.dot(s),x=s.dot(c)/E;if(!(x<0)){u.scale(x,k),k.vadd(h,k),e.getVertex(_[3*T+1],F),e.getVertex(_[3*T+2],L);var A=k.distanceSquared(h);!R(k,F,O,L)&&!R(k,O,F,L)||g<A||(C.vectorToWorldFrame(t,s,p),C.pointToWorldFrame(i,t,k,f),this.reportIntersection(p,f,r,n,T))}}o.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,i,n,r){var a=this.from,s=this.to,o=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(a,s,e,t,i,n,o),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(o<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,s,e,t,i,n,o),l._shouldStop=!0}};var f=new v,T=new v},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t,i){var n=e("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=r).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,n,r,a,s){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=a,this.distance=s}},{"../math/Vec3":31}],12:[function(e,t,i){e("../shapes/Shape");var n=e("../collision/Broadphase");function u(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var i=this.axisList;this._addBodyHandler=function(e){i.push(e.body)},this._removeBodyHandler=function(e){var t=i.indexOf(e.body);-1!==t&&i.splice(t,1)},e&&this.setWorld(e)}((t.exports=u).prototype=new n).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},u.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},u.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},u.prototype.collisionPairs=function(e,t,i){var n,r,a=this.axisList,s=a.length,o=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var l=a[n];for(r=n+1;r<s;r++){var c=a[r];if(this.needBroadphaseCollision(l,c)){if(!u.checkBounds(l,c,o))break;this.intersectionTest(l,c,t,i)}}}},u.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var r=e[n];r.aabbNeedsUpdate&&r.computeAABB()}0===t?u.insertionSortX(e):1===t?u.insertionSortY(e):2===t&&u.insertionSortZ(e)},u.checkBounds=function(e,t,i){var n,r;0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var a=e.boundingRadius,s=t.boundingRadius;return r-s<n+a},u.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,a=0,s=this.axisList,o=s.length,l=1/o,c=0;c!==o;c++){var u=s[c],h=u.position.x;e+=h,t+=h*h;var d=u.position.y;i+=d,n+=d*d;var f=u.position.z;r+=f,a+=f*f}var p=t-e*e*l,_=n-i*i*l,v=a-r*r*l;this.axisIndex=_<p?v<p?0:2:v<_?1:2},u.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var a=this.axisList,s=(t.lowerBound[r],t.upperBound[r],0);s<a.length;s++){var o=a[s];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(t)&&i.push(o)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t,i){t.exports=n,e("./Constraint");var l=e("./PointToPointConstraint"),c=e("../equations/ConeEquation"),u=e("../equations/RotationalEquation"),h=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new h,a=i.pivotB?i.pivotB.clone():new h;this.axisA=i.axisA?i.axisA.clone():new h,this.axisB=i.axisB?i.axisB.clone():new h,l.call(this,e,r,t,a,n),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var s=this.coneEquation=new c(e,t,i),o=this.twistEquation=new u(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,s.maxForce=0,s.minForce=-n,o.maxForce=0,o.minForce=-n,this.equations.push(s,o)}n.prototype=new l,n.constructor=n,new h,new h,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,n=this.twistEquation;l.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(n.axisA,n.axisA),e.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),i.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":54}],15:[function(e,t,i){t.exports=n;var a=e("./Constraint"),s=e("../equations/ContactEquation");function n(e,t,i,n){a.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===n&&(n=1e6),this.distance=i;var r=this.distanceEquation=new s(e,t);this.equations.push(r),r.minForce=-n,r.maxForce=n}(n.prototype=new a).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=n,e("./Constraint");var c=e("./PointToPointConstraint"),u=e("../equations/RotationalEquation"),h=e("../equations/RotationalMotorEquation"),d=(e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=i.pivotA?i.pivotA.clone():new d,a=i.pivotB?i.pivotB.clone():new d;c.call(this,e,r,t,a,n),(this.axisA=i.axisA?i.axisA.clone():new d(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new d(1,0,0)).normalize();var s=this.rotationalEquation1=new u(e,t,i),o=this.rotationalEquation2=new u(e,t,i),l=this.motorEquation=new h(e,t,n);l.enabled=!1,this.equations.push(s,o,l)}n.prototype=new c,(n.constructor=n).prototype.enableMotor=function(){this.motorEquation.enabled=!0},n.prototype.disableMotor=function(){this.motorEquation.enabled=!1},n.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},n.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var f=new d,p=new d;n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,n=this.rotationalEquation1,r=this.rotationalEquation2,a=f,s=p,o=this.axisA,l=this.axisB;c.prototype.update.call(this),e.quaternion.vmult(o,a),t.quaternion.vmult(l,s),a.tangents(n.axisA,r.axisA),n.axisB.copy(s),r.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=n,e("./Constraint");var u=e("./PointToPointConstraint"),h=e("../equations/RotationalEquation"),d=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,r=new d,a=new d,s=new d;e.position.vadd(t.position,s),s.scale(.5,s),t.pointToLocalFrame(s,a),e.pointToLocalFrame(s,r),u.call(this,e,r,t,a,n),this.xA=e.vectorToLocalFrame(d.UNIT_X),this.xB=t.vectorToLocalFrame(d.UNIT_X),this.yA=e.vectorToLocalFrame(d.UNIT_Y),this.yB=t.vectorToLocalFrame(d.UNIT_Y),this.zA=e.vectorToLocalFrame(d.UNIT_Z),this.zB=t.vectorToLocalFrame(d.UNIT_Z);var o=this.rotationalEquation1=new h(e,t,i),l=this.rotationalEquation2=new h(e,t,i),c=this.rotationalEquation3=new h(e,t,i);this.equations.push(o,l,c)}n.prototype=new u,n.constructor=n,new d,new d,n.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),n=this.rotationalEquation2,r=this.rotationalEquation3;u.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,n.axisA),t.vectorToWorldFrame(this.zB,n.axisB),e.vectorToWorldFrame(this.zA,r.axisA),t.vectorToWorldFrame(this.xB,r.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=n;var l=e("./Constraint"),c=e("../equations/ContactEquation"),u=e("../math/Vec3");function n(e,t,i,n,r){l.call(this,e,i),r=void 0!==r?r:1e6,this.pivotA=t?t.clone():new u,this.pivotB=n?n.clone():new u;var a=this.equationX=new c(e,i),s=this.equationY=new c(e,i),o=this.equationZ=new c(e,i);this.equations.push(a,s,o),a.minForce=s.minForce=o.minForce=-r,a.maxForce=s.maxForce=o.maxForce=r,a.ni.set(1,0,0),s.ni.set(0,1,0),o.ni.set(0,0,1)}(n.prototype=new l).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(n.prototype=new a).constructor=n;var c=new r,u=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=c,s=u,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var g=new r,b=new r,S=new r;a.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,a=this.ri,s=this.rj,o=g,l=b,c=n.velocity,u=n.angularVelocity,h=(n.force,n.torque,r.velocity),d=r.angularVelocity,f=(r.force,r.torque,S),p=this.jacobianElementA,_=this.jacobianElementB,v=this.ni;a.cross(v,o),s.cross(v,l),v.negate(p.spatial),o.negate(p.rotational),_.spatial.copy(v),_.rotational.copy(l),f.copy(r.position),f.vadd(s,f),f.vsub(n.position,f),f.vsub(a,f);var m=v.dot(f),y=this.restitution+1;return-m*t-(y*h.dot(v)-y*c.dot(v)+d.dot(l)-u.dot(o))*i-e*this.computeGiMf()};var s=new r,o=new r,l=new r,c=new r,u=new r;a.prototype.getImpactVelocityAlongNormal=function(){var e=s,t=o,i=l,n=c,r=u;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t,i){t.exports=a;var r=e("../math/JacobianElement"),n=e("../math/Vec3");function a(e,t,i,n){this.id=a.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===n?1e6:n,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new r,this.jacobianElementB=new r,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(a.prototype.constructor=a).id=0,a.prototype.setSpookParams=function(e,t,i){var n=t,r=e,a=i;this.a=4/(a*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(a*a*r*(1+4*n))},a.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.position,a=n.position;return e.spatial.dot(r)+t.spatial.dot(a)},new n,a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,a=n.velocity,s=i.angularVelocity,o=n.angularVelocity;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,a=n.vlambda,s=i.wlambda,o=n.wlambda;return e.multiplyVectors(r,s)+t.multiplyVectors(a,o)};var u=new n,h=new n,d=new n,f=new n;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,a=i.torque,s=n.force,o=n.torque,l=i.invMassSolve,c=n.invMassSolve;return r.scale(l,u),s.scale(c,h),i.invInertiaWorldSolve.vmult(a,d),n.invInertiaWorldSolve.vmult(o,f),e.multiplyVectors(u,d)+t.multiplyVectors(h,f)};var c=new n;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,a=n.invMassSolve,s=i.invInertiaWorldSolve,o=n.invInertiaWorldSolve,l=r+a;return s.vmult(e.rotational,c),l+=c.dot(e.rotational),o.vmult(t.rotational,c),l+=c.dot(t.rotational)};var s=new n;new n,new n,new n,new n,new n,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,a=s;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,a),n.wlambda.addScaledVector(e,a,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,a),r.wlambda.addScaledVector(e,a,r.wlambda)},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var c=new r,u=new r;a.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=c,a=u,s=this.t;i.cross(s,r),n.cross(s,a);var o=this.jacobianElementA,l=this.jacobianElementB;return s.negate(o.spatial),r.negate(o.rotational),l.spatial.copy(s),l.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t,i){t.exports=n;var r=e("../math/Vec3"),a=(e("../math/Mat3"),e("./Equation"));function n(e,t,i){var n=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;a.call(this,e,t,-n,n),this.axisA=i.axisA?i.axisA.clone():new r(1,0,0),this.axisB=i.axisB?i.axisB.clone():new r(0,1,0),this.maxAngle=Math.PI/2}(n.prototype=new a).constructor=n;var c=new r,u=new r;n.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,a=c,s=u,o=this.jacobianElementA,l=this.jacobianElementB;return n.cross(r,a),r.cross(n,s),o.rotational.copy(s),l.rotational.copy(a),-(Math.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function a(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((a.prototype=new r).constructor=a).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,a=this.jacobianElementB;return r.rotational.copy(i),n.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t,i){var r=e("../utils/Utils");(t.exports=function e(t,i,n){n=r.defaults(n,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=n.friction,this.restitution=n.restitution,this.contactEquationStiffness=n.contactEquationStiffness,this.contactEquationRelaxation=n.contactEquationRelaxation,this.frictionEquationStiffness=n.frictionEquationStiffness,this.frictionEquationRelaxation=n.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":54}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t,i){t.exports=c;var u=e("./Vec3");function c(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}c.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},c.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},c.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},c.prototype.getTrace=function(e){e=e||new u;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},c.prototype.vmult=function(e,t){t=t||new u;var i=this.elements,n=e.x,r=e.y,a=e.z;return t.x=i[0]*n+i[1]*r+i[2]*a,t.y=i[3]*n+i[4]*r+i[5]*a,t.z=i[6]*n+i[7]*r+i[8]*a,t},c.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},c.prototype.mmult=function(e,t){for(var i=t||new c,n=0;n<3;n++)for(var r=0;r<3;r++){for(var a=0,s=0;s<3;s++)a+=e.elements[n+3*s]*this.elements[s+3*r];i.elements[n+3*r]=a}return i},c.prototype.scale=function(e,t){t=t||new c;for(var i=this.elements,n=t.elements,r=0;3!==r;r++)n[3*r+0]=e.x*i[3*r+0],n[3*r+1]=e.y*i[3*r+1],n[3*r+2]=e.z*i[3*r+2];return t},c.prototype.solve=function(e,t){t=t||new u;for(var i,n=[],r=0;r<12;r++)n.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)n[r+4*i]=this.elements[r+3*i];n[3]=e.x,n[7]=e.y,n[11]=e.z;var a,s,o=3,l=o;do{if(0===n[(r=l-o)+4*r])for(i=r+1;i<l;i++)if(0!==n[r+4*i]){for(a=4;n[(s=4-a)+4*r]+=n[s+4*i],--a;);break}if(0!==n[r+4*r])for(i=r+1;i<l;i++){var c=n[r+4*i]/n[r+4*r];for(a=4;n[(s=4-a)+4*i]=s<=r?0:n[s+4*i]-n[s+4*r]*c,--a;);}}while(--o);if(t.z=n[11]/n[10],t.y=(n[7]-n[6]*t.z)/n[5],t.x=(n[3]-n[2]*t.z-n[1]*t.y)/n[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},c.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},c.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},c.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},c.prototype.reverse=function(e){e=e||new c;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,a,s=3,o=s;do{if(0===i[(n=o-s)+6*n])for(t=n+1;t<o;t++)if(0!==i[n+6*t]){for(r=6;i[(a=6-r)+6*n]+=i[a+6*t],--r;);break}if(0!==i[n+6*n])for(t=n+1;t<o;t++){var l=i[n+6*t]/i[n+6*n];for(r=6;i[(a=6-r)+6*t]=a<=n?0:i[a+6*t]-i[a+6*n]*l,--r;);}}while(--s);n=2;do{t=n-1;do{for(l=i[n+6*t]/i[n+6*n],r=6;i[(a=6-r)+6*t]=i[a+6*t]-i[a+6*n]*l,--r;);}while(t--)}while(--n);n=2;do{for(l=1/i[n+6*n],r=6;i[(a=6-r)+6*n]=i[a+6*n]*l,--r;);}while(n--);n=2;do{t=2;do{if(a=i[3+t+6*n],isNaN(a)||a===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(n,t,a)}while(t--)}while(n--);return e},c.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,s=i+i,o=n+n,l=t*a,c=t*s,u=t*o,h=i*s,d=i*o,f=n*o,p=r*a,_=r*s,v=r*o,m=this.elements;return m[0]=1-(h+f),m[1]=c-v,m[2]=u+_,m[3]=c+v,m[4]=1-(l+f),m[5]=d-p,m[6]=u-_,m[7]=d+p,m[8]=1-(l+h),this},c.prototype.transpose=function(e){for(var t=(e=e||new c).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)t[3*n+r]=i[3*r+n];return e}},{"./Vec3":31}],29:[function(e,t,i){t.exports=v;var f=e("./Vec3");function v(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}v.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},v.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},v.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},v.prototype.setFromAxisAngle=function(e,t){var i=Math.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=Math.cos(.5*t),this},v.prototype.toAxisAngle=function(e){e=e||new f,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return e.z=i<.001?(e.x=this.x,e.y=this.y,this.z):(e.x=this.x/i,e.y=this.y/i,this.z/i),[e,t]};var a=new f,s=new f;v.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=a,n=s;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new f,new f,new f,v.prototype.mult=function(e,t){t=t||new v;var i=this.x,n=this.y,r=this.z,a=this.w,s=e.x,o=e.y,l=e.z,c=e.w;return t.x=i*c+a*s+n*l-r*o,t.y=n*c+a*o+r*s-i*l,t.z=r*c+a*l+i*o-n*s,t.w=a*c-i*s-n*o-r*l,t},v.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;e=e||new v,this.conjugate(e);var a=1/(t*t+i*i+n*n+r*r);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},v.prototype.conjugate=function(e){return(e=e||new v).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},v.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},v.prototype.vmult=function(e,t){t=t||new f;var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z,l=this.w,c=l*i+s*r-o*n,u=l*n+o*i-a*r,h=l*r+a*n-s*i,d=-a*i-s*n-o*r;return t.x=c*l+d*-a+u*-o-h*-s,t.y=u*l+d*-s+h*-a-c*-o,t.z=h*l+d*-o+c*-s-u*-a,t},v.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},v.prototype.toEuler=function(e,t){var i,n,r;t=t||"YZX";var a=this.x,s=this.y,o=this.z,l=this.w;switch(t){case"YZX":var c=a*s+o*l;if(.499<c&&(i=2*Math.atan2(a,l),n=Math.PI/2,r=0),c<-.499&&(i=-2*Math.atan2(a,l),n=-Math.PI/2,r=0),isNaN(i)){var u=a*a,h=s*s,d=o*o;i=Math.atan2(2*s*l-2*a*o,1-2*h-2*d),n=Math.asin(2*c),r=Math.atan2(2*a*l-2*s*o,1-2*u-2*d)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=r},v.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var r=Math.cos(e/2),a=Math.cos(t/2),s=Math.cos(i/2),o=Math.sin(e/2),l=Math.sin(t/2),c=Math.sin(i/2);return"XYZ"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s-o*l*c):"YXZ"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s+o*l*c):"ZXY"===n?(this.x=o*a*s-r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s-o*l*c):"ZYX"===n?(this.x=o*a*s-r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s+o*l*c):"YZX"===n?(this.x=o*a*s+r*l*c,this.y=r*l*s+o*a*c,this.z=r*a*c-o*l*s,this.w=r*a*s-o*l*c):"XZY"===n&&(this.x=o*a*s-r*l*c,this.y=r*l*s-o*a*c,this.z=r*a*c+o*l*s,this.w=r*a*s+o*l*c),this},v.prototype.clone=function(){return new v(this.x,this.y,this.z,this.w)},v.prototype.slerp=function(e,t,i){i=i||new v;var n,r,a,s,o,l=this.x,c=this.y,u=this.z,h=this.w,d=e.x,f=e.y,p=e.z,_=e.w;return(r=l*d+c*f+u*p+h*_)<0&&(r=-r,d=-d,f=-f,p=-p,_=-_),o=1e-6<1-r?(n=Math.acos(r),a=Math.sin(n),s=Math.sin((1-t)*n)/a,Math.sin(t*n)/a):(s=1-t,t),i.x=s*l+o*d,i.y=s*c+o*f,i.z=s*u+o*p,i.w=s*h+o*_,i},v.prototype.integrate=function(e,t,i,n){n=n||new v;var r=e.x*i.x,a=e.y*i.y,s=e.z*i.z,o=this.x,l=this.y,c=this.z,u=this.w,h=.5*t;return n.x+=h*(r*u+a*c-s*l),n.y+=h*(a*u+s*o-r*c),n.z+=h*(s*u+r*l-a*o),n.w+=h*(-r*o-a*l-s*c),n}},{"./Vec3":31}],30:[function(e,t,i){var r=e("./Vec3"),n=e("./Quaternion");function a(e){e=e||{},this.position=new r,e.position&&this.position.copy(e.position),this.quaternion=new n,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var s=new n;a.pointToLocalFrame=function(e,t,i,n){return n=n||new r,i.vsub(e,n),t.conjugate(s),s.vmult(n,n),n},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,i,n){return n=n||new r,t.vmult(i,n),n.vadd(e,n),n},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},a.vectorToLocalFrame=function(e,t,i,n){return n=n||new r,t.w*=-1,t.vmult(i,n),t.w*=-1,n}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t,i){t.exports=l;var n=e("./Mat3");function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}l.ZERO=new l(0,0,0),l.UNIT_X=new l(1,0,0),l.UNIT_Y=new l(0,1,0),l.UNIT_Z=new l(0,0,1),l.prototype.cross=function(e,t){var i=e.x,n=e.y,r=e.z,a=this.x,s=this.y,o=this.z;return(t=t||new l).x=s*r-o*n,t.y=o*i-a*r,t.z=a*n-s*i,t},l.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},l.prototype.setZero=function(){this.x=this.y=this.z=0},l.prototype.vadd=function(e,t){if(!t)return new l(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},l.prototype.vsub=function(e,t){if(!t)return new l(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},l.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},l.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(0<n){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},l.prototype.unit=function(e){e=e||new l;var t=this.x,i=this.y,n=this.z,r=Math.sqrt(t*t+i*i+n*n);return e.z=0<r?(r=1/r,e.x=t*r,e.y=i*r,n*r):(e.x=1,e.y=0),e},l.prototype.length=l.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},l.prototype.lengthSquared=l.prototype.norm2=function(){return this.dot(this)},l.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return Math.sqrt((r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n))},l.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,s=e.z;return(r-t)*(r-t)+(a-i)*(a-i)+(s-n)*(s-n)},l.prototype.mult=function(e,t){t=t||new l;var i=this.x,n=this.y,r=this.z;return t.x=e*i,t.y=e*n,t.z=e*r,t},l.prototype.vmul=function(e,t){return(t=t||new l).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},l.prototype.scale=l.prototype.mult,l.prototype.addScaledVector=function(e,t,i){return(i=i||new l).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},l.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},l.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},l.prototype.negate=function(e){return(e=e||new l).x=-this.x,e.y=-this.y,e.z=-this.z,e};var s=new l,o=new l;l.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var n=s,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var a=o;Math.abs(n.x)<.9?a.set(1,0,0):a.set(0,1,0),n.cross(a,e),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},l.prototype.toString=function(){return this.x+","+this.y+","+this.z},l.prototype.toArray=function(){return[this.x,this.y,this.z]},l.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},l.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,a=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=a+(e.z-a)*t},l.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},l.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var r=new l;l.prototype.isAntiparallelTo=function(e,t){return this.negate(r),r.almostEquals(e,t)},l.prototype.clone=function(){return new l(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t,i){t.exports=y;var n=e("../utils/EventTarget"),a=(e("../shapes/Shape"),e("../math/Vec3")),r=e("../math/Mat3"),s=e("../math/Quaternion"),o=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box"),c=e("../world/World");function y(e){e=e||{},n.apply(this),this.id=y.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new a,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new a,this.previousPosition=new a,this.interpolatedPosition=new a,this.initPosition=new a,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new a,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new a,this.force=new a;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?y.STATIC:y.DYNAMIC,typeof e.type==typeof y.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new a,this.quaternion=new s,this.initQuaternion=new s,this.previousQuaternion=new s,this.interpolatedQuaternion=new s,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new a,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new a,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new a,this.invInertia=new a,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new a,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new a(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new a(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new o,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new a,e.shape&&this.addShape(e.shape),this.updateMassProperties()}((y.prototype=new n).constructor=y).COLLIDE_EVENT_NAME="collide",y.DYNAMIC=1,y.STATIC=2,y.KINEMATIC=4,y.AWAKE=0,y.SLEEPY=1,y.SLEEPING=2,y.idCounter=0,y.wakeupEvent={type:"wakeup"},y.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===y.SLEEPING&&this.dispatchEvent(y.wakeupEvent)},y.prototype.sleep=function(){this.sleepState=y.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},y.sleepyEvent={type:"sleepy"},y.sleepEvent={type:"sleep"},y.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===y.AWAKE&&i<n?(this.sleepState=y.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(y.sleepyEvent)):t===y.SLEEPY&&n<i?this.wakeUp():t===y.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(y.sleepEvent))}},y.prototype.updateSolveMassProperties=function(){this.sleepState===y.SLEEPING||this.type===y.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},y.prototype.pointToLocalFrame=function(e,t){return t=t||new a,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},y.prototype.vectorToLocalFrame=function(e,t){return t=t||new a,this.quaternion.conjugate().vmult(e,t),t},y.prototype.pointToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},y.prototype.vectorToWorldFrame=function(e,t){return t=t||new a,this.quaternion.vmult(e,t),t};var h=new a,d=new s;y.prototype.addShape=function(e,t,i){if(-1===this.shapes.indexOf(e)){var n=new a,r=new s;return t&&n.copy(t),i&&r.copy(i),c.idToShapeMap[e.id]=e,this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,e.body=this}},y.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0)},y.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var a=e[r];a.updateBoundingSphereRadius();var s=t[r].norm(),o=a.boundingSphereRadius;n<s+o&&(n=s+o)}this.boundingRadius=n};var f=new o;y.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,a=d,s=this.quaternion,o=this.aabb,l=f,c=0;c!==n;c++){var u=e[c];s.vmult(t[c],r),r.vadd(this.position,r),i[c].mult(s,a),u.calculateWorldAABB(r,a,l.lowerBound,l.upperBound),0===c?o.copy(l):o.extend(l)}this.aabbNeedsUpdate=!1};var u=new r,p=new r;new r,y.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=u,n=p;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}};var _=new a;y.prototype.applyForce=function(e,t){if(this.type===y.DYNAMIC){var i=_;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new a,m=new a;y.prototype.applyLocalForce=function(e,t){if(this.type===y.DYNAMIC){var i=v,n=m;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}};var g=new a,b=new a;y.prototype.applyImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=t,n=g;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=b;i.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var S=new a,T=new a;y.prototype.applyLocalImpulse=function(e,t){if(this.type===y.DYNAMIC){var i=S,n=T;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var E=new a;y.prototype.updateMassProperties=function(){var e=E;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},y.prototype.getVelocityAtWorldPoint=function(e,t){var i=new a;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},y.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===y.DYNAMIC||this.type===y.KINEMATIC)&&this.sleepState!==y.SLEEPING){var n=this.velocity,r=this.angularVelocity,a=this.position,s=this.force,o=this.torque,l=this.quaternion,c=this.invMass,u=this.invInertiaWorld,h=this.linearFactor,d=c*e;n.x+=s.x*d*h.x,n.y+=s.y*d*h.y,n.z+=s.z*d*h.z;var f=u.elements,p=this.angularFactor,_=o.x*p.x,v=o.y*p.y,m=o.z*p.z;r.x+=e*(f[0]*_+f[1]*v+f[2]*m),r.y+=e*(f[3]*_+f[4]*v+f[5]*m),r.z+=e*(f[6]*_+f[7]*v+f[8]*m),a.x+=n.x*e,a.y+=n.y*e,a.z+=n.z*e,l.integrate(this.angularVelocity,e,this.angularFactor,l),t&&(i?l.normalizeFast():l.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},y.prototype.isSleeping=function(){return this.sleepState===y.SLEEPING},y.prototype.isSleepy=function(){return this.sleepState===y.SLEEPY},y.prototype.isAwake=function(){return this.sleepState===y.AWAKE}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t,i){e("./Body");var I=e("../math/Vec3"),u=e("../math/Quaternion"),n=(e("../collision/RaycastResult"),e("../collision/Ray")),r=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new I,new I,new I;var h=new I,d=new I,f=new I;new n,a.prototype.addWheel=function(e){var t=new r(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new I,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,n=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*n.velocity.norm();var a=new I;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(t[r]);this.updateSuspension(e);var s=new I,o=new I;for(r=0;r<i;r++){var l=(d=t[r]).suspensionForce;l>d.maxSuspensionForce&&(l=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(l*e,s),d.raycastResult.hitPointWorld.vsub(n.position,o),n.applyImpulse(s,o)}this.updateFriction(e);var c=new I,u=new I,h=new I;for(r=0;r<i;r++){var d=t[r];n.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,h);var f=1;switch(this.indexUpAxis){case 1:f=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var p=u.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(p,c),u.vsub(c,u);var _=u.dot(h);d.deltaRotation=f*_*e/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(0<d.engineForce?1:-1)*d.customSlidingRotationalSpeed*e),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},a.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,r=0;r<n;r++){var a=i[r];if(a.isInContact){var s,o=a.suspensionRestLength-a.suspensionLength;s=a.suspensionStiffness*o*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;s-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=s*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var m=new I,y=new I;a.prototype.castRay=function(e){var t=m,i=y;this.updateWheelTransformWorld(e);var n=this.chassisBody,r=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var o=e.raycastResult;o.reset();var l=n.collisionResponse;n.collisionResponse=!1,this.world.rayTest(s,i,o),n.collisionResponse=l;var c=o.body;if(e.raycastResult.groundObject=0,c){r=o.distance,e.raycastResult.hitNormalWorld=o.hitNormalWorld,e.isInContact=!0;var u=o.distance;e.suspensionLength=u-e.radius;var h=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<h&&(e.suspensionLength=h),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var f=e.raycastResult.hitNormalWorld.dot(e.directionWorld),p=new I;n.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,p);var _=e.raycastResult.hitNormalWorld.dot(p);if(-.1<=f)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var v=-1/f;e.suspensionRelativeVelocity=_*v,e.clippedInvContactDotSuspension=v}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return r},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=h,i=d,n=f,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,t),i.copy(r.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var a=r.steering,s=new u;s.setFromAxisAngle(t,a);var o=new u;o.setFromAxisAngle(i,r.rotation);var l=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,l),l.mult(o,l),l.normalize();var c=r.worldTransform.position;c.copy(r.directionWorld),c.scale(r.suspensionLength,c),c.vadd(r.chassisConnectionPointWorld,c)};var P=[new I(1,0,0),new I(0,1,0),new I(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var D=new I,N=[],z=[];a.prototype.updateFriction=function(e){for(var t=D,i=this.wheelInfos,n=i.length,r=this.chassisBody,a=z,s=N,o=0;o<n;o++)h=(O=i[o]).raycastResult.body,O.sideImpulse=0,O.forwardImpulse=0,a[o]||(a[o]=new I),s[o]||(s[o]=new I);for(o=0;o<n;o++)if(h=(O=i[o]).raycastResult.body){var l=s[o];this.getWheelTransformWorld(o).vectorToWorldFrame(P[this.indexRightAxis],l);var c=O.raycastResult.hitNormalWorld,u=l.dot(c);c.scale(u,t),l.vsub(t,l),l.normalize(),c.cross(l,a[o]),a[o].normalize(),O.sideImpulse=W(r,O.raycastResult.hitPointWorld,h,O.raycastResult.hitPointWorld,l),O.sideImpulse*=1}for(this.sliding=!1,o=0;o<n;o++){var h=(O=i[o]).raycastResult.body,d=0;if(O.slipInfo=1,h){var f=O.brake?O.brake:0;b=r,S=h,T=O.raycastResult.hitPointWorld,E=a[o],x=f,w=A=void 0,A=0,C=T,w=U,R=G,k=V,b.getVelocityAtWorldPoint(C,w),S.getVelocityAtWorldPoint(C,R),w.vsub(R,k),x<(A=-E.dot(k)*(1/(H(b,T,E)+H(S,T,E))))&&(A=x),A<-x&&(A=-x),d=A;var p=f/(d+=O.engineForce*e);O.slipInfo*=p}if(O.forwardImpulse=0,O.skidInfo=1,h){O.skidInfo=1;var _=O.suspensionForce*e*O.frictionSlip,v=_*_;O.forwardImpulse=d;var m=.5*O.forwardImpulse,y=1*O.sideImpulse,g=m*m+y*y;O.sliding=!1,v<g&&(this.sliding=!0,O.sliding=!0,p=_/Math.sqrt(g),O.skidInfo*=p)}}var b,S,T,E,x,A,C,w,R,k;if(this.sliding)for(o=0;o<n;o++)0!==(O=i[o]).sideImpulse&&O.skidInfo<1&&(O.forwardImpulse*=O.skidInfo,O.sideImpulse*=O.skidInfo);for(o=0;o<n;o++){var O=i[o],F=new I;if(O.raycastResult.hitPointWorld.vsub(r.position,F),0!==O.forwardImpulse){var L=new I;a[o].scale(O.forwardImpulse,L),r.applyImpulse(L,F)}if(0!==O.sideImpulse){h=O.raycastResult.body;var B=new I;O.raycastResult.hitPointWorld.vsub(h.position,B);var M=new I;s[o].scale(O.sideImpulse,M),r.vectorToLocalFrame(F,F),F["xyz"[this.indexUpAxis]]*=O.rollInfluence,r.vectorToWorldFrame(F,F),r.applyImpulse(M,F),M.scale(-1,M),h.applyImpulse(M,B)}}};var U=new I,G=new I,V=new I;var o=new I,l=new I,c=new I,p=new I;function H(e,t,i){var n=o,r=l,a=c,s=p;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,s),s.cross(n,a),e.invMass+i.dot(a)}var _=new I,v=new I,g=new I;function W(e,t,i,n,r){if(1.1<r.norm2())return 0;var a=_,s=v,o=g;return e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(n,s),a.vsub(s,o),-.2*r.dot(o)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t,i){var s=e("./Body"),o=e("../shapes/Sphere"),n=e("../shapes/Box"),l=e("../math/Vec3"),c=e("../constraints/HingeConstraint");function r(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new l(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new n(new l(5,2,.5));this.chassisBody=new s(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=r).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new s(1,new o(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new l;var i=void 0!==e.position?e.position.clone():new l,n=new l;this.chassisBody.pointToWorldFrame(i,n),t.position.set(n.x,n.y,n.z);var r=void 0!==e.axis?e.axis.clone():new l(0,1,0);this.wheelAxes.push(r);var a=new c(this.chassisBody,t,{pivotA:i,axisA:r,pivotB:l.ZERO,axisB:r,collideConnected:!1});return this.constraints.push(a),this.wheelBodies.length-1},r.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=Math.cos(e),r=Math.sin(e),a=i.x,s=i.y;this.constraints[t].axisA.set(n*a-r*s,r*a+n*s,0)},r.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},r.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var a=new l;r.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},r.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],r=n.torque;i.scale(e,a),n.vectorToWorldFrame(a,a),r.vadd(a,r)},r.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},r.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},r.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var u=new l;r.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,u),i.dot(u)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t,i){t.exports=r,e("../shapes/Shape");var n=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,a=l,s=0;s!==i;s++){var o=this.particles[s];o.position.vsub(e.position,a),n!==o.id&&a.norm2()<r&&t.push(o)}};var T=new n,E=new n,x=new n,A=new n,C=new n,w=new n;r.prototype.update=function(){for(var e=this.particles.length,t=T,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var a=this.particles[r];(y=this.neighbors[r]).length=0,this.getNeighbors(a,y),y.push(this.particles[r]);for(var s=y.length,o=0,l=0;l!==s;l++){a.position.vsub(y[l].position,t);var c=t.norm(),u=this.w(c);o+=y[l].mass*u}this.densities[r]=o,this.pressures[r]=i*i*(this.densities[r]-this.density)}var h=E,d=x,f=A,p=C,_=w;for(r=0;r!==e;r++){var v,m,y,g=this.particles[r];for(h.set(0,0,0),d.set(0,0,0),s=(y=this.neighbors[r]).length,l=0;l!==s;l++){var b=y[l];g.position.vsub(b.position,p);var S=p.norm();v=-b.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[l]/(this.densities[l]*this.densities[l]+n)),this.gradw(p,f),f.mult(v,f),h.vadd(f,h),b.velocity.vsub(g.velocity,_),_.mult(1/(1e-4+this.densities[r]*this.densities[l])*this.viscosity*b.mass,_),m=this.nablaw(S),_.mult(m,_),d.vadd(_,d)}d.mult(g.mass,d),h.mult(g.mass,h),g.force.vadd(d,g.force),g.force.vadd(h,g.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t,i){var n=e("../math/Vec3");function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=r).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var m=new n,y=new n,g=new n,b=new n,S=new n,T=new n,E=new n,x=new n,A=new n,C=new n,w=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,a=m,s=y,o=g,l=b,c=w,u=S,h=T,d=E,f=x,p=A,_=C;this.getWorldAnchorA(u),this.getWorldAnchorB(h),u.vsub(n.position,d),h.vsub(r.position,f),h.vsub(u,a);var v=a.norm();s.copy(a),s.normalize(),r.velocity.vsub(n.velocity,o),r.angularVelocity.cross(f,c),o.vadd(c,o),n.angularVelocity.cross(d,c),o.vsub(c,o),s.mult(-e*(v-i)-t*o.dot(s),l),n.force.vsub(l,n.force),r.force.vadd(l,r.force),d.cross(l,p),f.cross(l,_),n.torque.vsub(p,n.torque),r.torque.vadd(_,r.torque)}},{"../math/Vec3":31}],37:[function(e,t,i){var n=e("../math/Vec3"),r=e("../math/Transform"),a=e("../collision/RaycastResult"),s=e("../utils/Utils");function o(e){e=s.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new r,this.isInContact=!1}t.exports=o;var l=new n,c=new n;l=new n,o.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var n=t.hitNormalWorld.dot(l);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t,i){t.exports=r;var n=e("./Shape"),s=e("../math/Vec3"),o=e("./ConvexPolyhedron");function r(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((r.prototype=new n).constructor=r).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=s,r=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],a=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new o(r,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=a).material=this.material},r.prototype.calculateLocalInertia=function(e,t){return t=t||new s,r.calculateInertia(this.halfExtents,e,t),t},r.calculateInertia=function(e,t,i){var n=e;i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x)},r.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var r=0;r!==i.length;r++)t.vmult(i[r],i[r]);return i},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new s;new s,r.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<r.length;a++)l.set(r[a][0],r[a][1],r[a][2]),t.vmult(l,l),e.vadd(l,l),i(l.x,l.y,l.z)};var u=[new s,new s,new s,new s,new s,new s,new s,new s];r.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents;u[0].set(r.x,r.y,r.z),u[1].set(-r.x,r.y,r.z),u[2].set(-r.x,-r.y,r.z),u[3].set(-r.x,-r.y,-r.z),u[4].set(r.x,-r.y,-r.z),u[5].set(r.x,r.y,-r.z),u[6].set(-r.x,r.y,-r.z),u[7].set(r.x,-r.y,r.z);var a=u[0];t.vmult(a,a),e.vadd(a,a),n.copy(a),i.copy(a);for(var s=1;s<8;s++){a=u[s],t.vmult(a,a),e.vadd(a,a);var o=a.x,l=a.y,c=a.z;o>n.x&&(n.x=o),l>n.y&&(n.y=l),c>n.z&&(n.z=c),o<i.x&&(i.x=o),l<i.y&&(i.y=l),c<i.z&&(i.z=c)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t,i){t.exports=d;var n=e("./Shape"),b=e("../math/Vec3"),_=(e("../math/Quaternion"),e("../math/Transform"));function d(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(d.prototype=new n).constructor=d;var h=new b;d.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=h,r=0;r!==e.length;r++)for(var a=e[r],s=a.length,o=0;o!==s;o++){var l=(o+1)%s;t[a[o]].vsub(t[a[l]],n),n.normalize();for(var c=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(n)||i[u].almostEquals(n)){c=!0;break}c||i.push(n.clone())}},d.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new b;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var r=new b,a=new b;d.computeNormal=function(e,t,i,n){t.vsub(e,a),i.vsub(t,r),r.cross(a,n),n.isZero()||n.normalize()},d.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],r=this.vertices[i[1]],a=this.vertices[i[2]];return d.computeNormal(n,r,a,t)};var S=new b;d.prototype.clipAgainstHull=function(e,t,i,n,r,a,s,o,l){for(var c=S,u=-1,h=-Number.MAX_VALUE,d=0;d<i.faces.length;d++){c.copy(i.faceNormals[d]),r.vmult(c,c);var f=c.dot(a);h<f&&(h=f,u=d)}for(var p=[],_=i.faces[u],v=_.length,m=0;m<v;m++){var y=i.vertices[_[m]],g=new b;g.copy(y),r.vmult(g,g),n.vadd(g,g),p.push(g)}0<=u&&this.clipFaceAgainstHull(a,e,t,p,s,o,l)};var x=new b,A=new b,C=new b,w=new b,R=new b,k=new b;d.prototype.findSeparatingAxis=function(e,t,i,n,r,a,s,o){var l=x,c=A,u=C,h=w,d=R,f=k,p=Number.MAX_VALUE,_=this;if(_.uniqueAxes)for(m=0;m!==_.uniqueAxes.length;m++){if(i.vmult(_.uniqueAxes[m],l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}else for(var v=s?s.length:_.faces.length,m=0;m<v;m++){var y=s?s[m]:m;if(l.copy(_.faceNormals[y]),i.vmult(l,l),!1===(b=_.testSepAxis(l,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(l))}if(e.uniqueAxes)for(m=0;m!==e.uniqueAxes.length;m++){if(r.vmult(e.uniqueAxes[m],c),!1===(b=_.testSepAxis(c,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(c))}else for(var g=o?o.length:e.faces.length,m=0;m<g;m++){var b;if(y=o?o[m]:m,c.copy(e.faceNormals[y]),r.vmult(c,c),!1===(b=_.testSepAxis(c,e,t,i,n,r)))return!1;b<p&&(p=b,a.copy(c))}for(var S=0;S!==_.uniqueEdges.length;S++){i.vmult(_.uniqueEdges[S],h);for(var T=0;T!==e.uniqueEdges.length;T++)if(r.vmult(e.uniqueEdges[T],d),h.cross(d,f),!f.almostZero()){f.normalize();var E=_.testSepAxis(f,e,t,i,n,r);if(!1===E)return!1;E<p&&(p=E,a.copy(f))}}return n.vsub(t,u),0<u.dot(a)&&a.negate(a),!0};var f=[],p=[];d.prototype.testSepAxis=function(e,t,i,n,r,a){d.project(this,e,i,n,f),d.project(t,e,r,a,p);var s=f[0],o=f[1],l=p[0],c=p[1];if(s<c||l<o)return!1;var u=s-c,h=l-o;return u<h?u:h};var s=new b,o=new b;d.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(s,o);var i=o.x-s.x,n=o.y-s.y,r=o.z-s.z;t.x=1/12*e*(2*n*2*n+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*n*2*n+2*i*2*i)},d.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var M=new b,I=new b,P=new b,D=new b,N=new b,z=new b,U=new b,G=new b;d.prototype.clipFaceAgainstHull=function(e,t,i,n,r,a,s){for(var o=M,l=I,c=P,u=D,h=N,d=z,f=U,p=G,_=n,v=[],m=-1,y=Number.MAX_VALUE,g=0;g<this.faces.length;g++){o.copy(this.faceNormals[g]),i.vmult(o,o);var b=o.dot(e);b<y&&(y=b,m=g)}if(!(m<0)){var S=this.faces[m];S.connectedFaces=[];for(var T=0;T<this.faces.length;T++)for(var E=0;E<this.faces[T].length;E++)-1!==S.indexOf(this.faces[T][E])&&T!==m&&-1===S.connectedFaces.indexOf(T)&&S.connectedFaces.push(T);_.length;for(var x=S.length,A=0;A<x;A++){var C=this.vertices[S[A]],w=this.vertices[S[(A+1)%x]];C.vsub(w,l),c.copy(l),i.vmult(c,c),t.vadd(c,c),u.copy(this.faceNormals[m]),i.vmult(u,u),t.vadd(u,u),c.cross(u,h),h.negate(h),d.copy(C),i.vmult(d,d),t.vadd(d,d),d.dot(h);var R=S.connectedFaces[A];f.copy(this.faceNormals[R]);var k=this.getPlaneConstantOfFace(R);p.copy(f),i.vmult(p,p);var O=k-p.dot(t);for(this.clipFaceAgainstPlane(_,v,p,O);_.length;)_.shift();for(;v.length;)_.push(v.shift())}for(f.copy(this.faceNormals[m]),k=this.getPlaneConstantOfFace(m),p.copy(f),i.vmult(p,p),O=k-p.dot(t),T=0;T<_.length;T++){var F=p.dot(_[T])+O;if(F<=r&&(F=r),F<=a){var L=_[T];if(F<=0){var B={point:L,normal:p,depth:F};s.push(B)}}}}},d.prototype.clipFaceAgainstPlane=function(e,t,i,n){var r,a,s=e.length;if(s<2)return t;var o=e[e.length-1],l=e[0];r=i.dot(o)+n;for(var c=0;c<s;c++){if(l=e[c],a=i.dot(l)+n,r<0)if(a<0)(u=new b).copy(l),t.push(u);else{var u=new b;o.lerp(l,r/(r-a),u),t.push(u)}else a<0&&(u=new b,o.lerp(l,r/(r-a),u),t.push(u),t.push(l));o=l,r=a}return t},d.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new b);for(var n=this.vertices,r=this.worldVertices,a=0;a!==i;a++)t.vmult(n[a],r[a]),e.vadd(r[a],r[a]);this.worldVerticesNeedsUpdate=!1},new b,d.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var a=n[r];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},d.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new b);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==t;r++)e.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},d.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var v=new b;d.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,a,s,o,l,c,u=this.vertices.length,h=this.vertices,d=0;d<u;d++){v.copy(h[d]),t.vmult(v,v),e.vadd(v,v);var f=v;f.x<r||void 0===r?r=f.x:(f.x>o||void 0===o)&&(o=f.x),f.y<a||void 0===a?a=f.y:(f.y>l||void 0===l)&&(l=f.y),f.z<s||void 0===s?s=f.z:(f.z>c||void 0===c)&&(c=f.z)}i.set(r,a,s),n.set(o,l,c)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.prototype.getAveragePointLocal=function(e){e=e||new b;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},d.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var a=n[r];t.vmult(a,a)}for(r=0;r<this.faceNormals.length;r++)a=this.faceNormals[r],t.vmult(a,a)}if(e)for(r=0;r<i;r++)(a=n[r]).vadd(e,a)};var m=new b,y=new b,g=new b;d.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,a=this.faces.length,s=m;this.getAveragePointLocal(s);for(var o=0;o<a;o++){this.faces[o].length,t=r[o];var l=i[n[o][0]],c=y;e.vsub(l,c);var u=t.dot(c),h=g;s.vsub(l,h);var d=t.dot(h);if(u<0&&0<d||0<u&&d<0)return!1}return-1},new b;var T=new b,E=new b;d.project=function(e,t,i,n,r){var a=e.vertices.length,s=T,o=0,l=0,c=E,u=e.vertices;c.setZero(),_.vectorToLocalFrame(i,n,t,s),_.pointToLocalFrame(i,n,c,c);var h=c.dot(s);l=o=u[0].dot(s);for(var d=1;d<a;d++){var f=u[d].dot(s);o<f&&(o=f),f<l&&(l=f)}if((o-=h)<(l-=h)){var p=l;l=o,o=p}r[0]=o,r[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t,i){t.exports=n,e("./Shape");var v=e("../math/Vec3"),m=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function n(e,t,i,n){var r=n,a=[],s=[],o=[],l=[],c=[],u=Math.cos,h=Math.sin;a.push(new v(t*u(0),t*h(0),.5*-i)),l.push(0),a.push(new v(e*u(0),e*h(0),.5*i)),c.push(1);for(var d=0;d<r;d++){var f=2*Math.PI/r*(d+1),p=2*Math.PI/r*(d+.5);d<r-1?(a.push(new v(t*u(f),t*h(f),.5*-i)),l.push(2*d+2),a.push(new v(e*u(f),e*h(f),.5*i)),c.push(2*d+3),o.push([2*d+2,2*d+3,2*d+1,2*d])):o.push([0,1,2*d+1,2*d]),(r%2==1||d<r/2)&&s.push(new v(u(p),h(p),0))}o.push(c),s.push(new v(0,0,1));var _=[];for(d=0;d<l.length;d++)_.push(l[l.length-d-1]);o.push(_),m.call(this,a,o,s)}n.prototype=new m},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t,i){var n=e("./Shape"),h=e("./ConvexPolyhedron"),d=e("../math/Vec3"),r=e("../utils/Utils");function a(e,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new h,this.pillarOffset=new d,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=a).prototype=new n).update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var a=this.data,s=this.minValue,o=e;o<=i;o++)for(var l=t;l<=n;l++){var c=a[o][l];s<c&&(s=c)}r[0]=this.minValue,r[1]=s},a.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,a=this.data,s=Math.floor(e/r),o=Math.floor(t/r);return i[0]=s,i[1]=o,n&&(s<0&&(s=0),o<0&&(o=0),s>=a.length-1&&(s=a.length-1),o>=a[0].length-1&&(o=a[0].length-1)),!(s<0||o<0||s>=a.length-1||o>=a[0].length-1)};var S=[],T=new d,E=new d,x=new d,A=new d;a.prototype.getTriangleAt=function(e,t,i,n,r,a){var s=S;this.getIndexOfPosition(e,t,s,i);var o=s[0],l=s[1],c=this.data;i&&(o=Math.min(c.length-2,Math.max(0,o)),l=Math.min(c[0].length-2,Math.max(0,l)));var u=this.elementSize,h=Math.pow(e/u-o,2)+Math.pow(t/u-l,2),d=Math.pow(e/u-(o+1),2)+Math.pow(t/u-(l+1),2)<h;return this.getTriangle(o,l,d,n,r,a),d};var c=new d,u=new d,f=new d,p=new d,_=new d;a.prototype.getNormalAt=function(e,t,i,n){var r=c,a=u,s=f,o=p,l=_;this.getTriangleAt(e,t,i,r,a,s),a.vsub(r,o),s.vsub(r,l),o.cross(l,n),n.normalize()},a.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},a.prototype.getHeightAt=function(e,t,i){var n=this.data,r=E,a=x,s=A,o=S;this.getIndexOfPosition(e,t,o,i);var l=o[0],c=o[1];i&&(l=Math.min(n.length-2,Math.max(0,l)),c=Math.min(n[0].length-2,Math.max(0,c)));var u,h,d,f,p,_,v,m,y,g=this.getTriangleAt(e,t,i,r,a,s);u=e,h=t,d=r.x,f=r.y,p=a.x,_=a.y,v=s.x,m=s.y,(y=T).x=((_-m)*(u-v)+(v-p)*(h-m))/((_-m)*(d-v)+(v-p)*(f-m)),y.y=((m-f)*(u-v)+(d-v)*(h-m))/((_-m)*(d-v)+(v-p)*(f-m)),y.z=1-y.x-y.y;var b=T;return g?n[l+1][c+1]*b.x+n[l][c+1]*b.y+n[l+1][c]*b.z:n[l][c]*b.x+n[l+1][c]*b.y+n[l][c+1]*b.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},a.prototype.getTriangle=function(e,t,i,n,r,a){var s=this.data,o=this.elementSize;i?(n.set((e+1)*o,(t+1)*o,s[e+1][t+1]),r.set(e*o,(t+1)*o,s[e][t+1]),a.set((e+1)*o,t*o,s[e+1][t])):(n.set(e*o,t*o,s[e][t]),r.set((e+1)*o,t*o,s[e+1][t]),a.set(e*o,(t+1)*o,s[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,r=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);n=new h,r=new d,this.pillarConvex=n,this.pillarOffset=r}var a=this.data,s=this.elementSize,o=n.faces;n.vertices.length=6;for(var l=0;l<6;l++)n.vertices[l]||(n.vertices[l]=new d);for(o.length=5,l=0;l<5;l++)o[l]||(o[l]=[]);var c=n.vertices,u=(Math.min(a[e][t],a[e+1][t],a[e][t+1],a[e+1][t+1])-this.minValue)/2+this.minValue;o[4][3]=i?(r.set((e+.75)*s,(t+.75)*s,u),c[0].set(.25*s,.25*s,a[e+1][t+1]-u),c[1].set(-.75*s,.25*s,a[e][t+1]-u),c[2].set(.25*s,-.75*s,a[e+1][t]-u),c[3].set(.25*s,.25*s,-u-1),c[4].set(-.75*s,.25*s,-u-1),c[5].set(.25*s,-.75*s,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=2,o[2][1]=5,o[2][2]=3,o[2][3]=0,o[3][0]=3,o[3][1]=4,o[3][2]=1,o[3][3]=0,o[4][0]=1,o[4][1]=4,o[4][2]=5,2):(r.set((e+.25)*s,(t+.25)*s,u),c[0].set(-.25*s,-.25*s,a[e][t]-u),c[1].set(.75*s,-.25*s,a[e+1][t]-u),c[2].set(-.25*s,.75*s,a[e][t+1]-u),c[3].set(-.25*s,-.25*s,-u-1),c[4].set(.75*s,-.25*s,-u-1),c[5].set(-.25*s,.75*s,-u-1),o[0][0]=0,o[0][1]=1,o[0][2]=2,o[1][0]=5,o[1][1]=4,o[1][2]=3,o[2][0]=0,o[2][1]=2,o[2][2]=5,o[2][3]=3,o[3][0]=1,o[3][1]=0,o[3][2]=3,o[3][3]=4,o[4][0]=4,o[4][1]=5,o[4][2]=2,1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,r)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new d).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new d(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,0,e.width,e.height),a=this.data;a.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var s=0;s<r.height;s++){for(var o=[],l=0;l<r.width;l++){var c=(r.data[4*(s*r.height+l)]+r.data[4*(s*r.height+l)+1]+r.data[4*(s*r.height+l)+2])/4/255*t.z;t.x<0?o.push(c):o.unshift(c)}t.y<0?a.unshift(o):a.push(o)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PARTICLE})}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((a.prototype=new n).constructor=a).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t=t||new r},a.prototype.volume=function(){return Number.MAX_VALUE};var s=new r;a.prototype.calculateWorldAABB=function(e,t,i,n){s.set(0,0,1),t.vmult(s,s);var r=Number.MAX_VALUE;i.set(-r,-r,-r),n.set(r,r,r),1===s.x&&(n.x=e.x),1===s.y&&(n.y=e.y),1===s.z&&(n.z=e.z),-1===s.x&&(i.x=e.x),-1===s.y&&(i.y=e.y),-1===s.z&&(i.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t,i){t.exports=r;var n=e("../utils/EventTarget"),r=e("./Shape");function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),r.prototype=new n,(r.prototype.constructor=r).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){t=t||new r;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,a=["x","y","z"],s=0;s<a.length;s++){var o=a[s];i[o]=e[o]-r,n[o]=e[o]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t,i){t.exports=y;var n=e("./Shape"),c=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),u=e("../collision/AABB"),a=e("../utils/Octree");function y(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new u,this.edges=null,this.scale=new c(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(y.prototype=new n).constructor=y;var o=new c;y.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new u,n=new c,r=new c,a=new c,s=[n,r,a],o=0;o<this.indices.length/3;o++){var l=3*o;this._getUnscaledVertex(this.indices[l],n),this._getUnscaledVertex(this.indices[1+l],r),this._getUnscaledVertex(this.indices[2+l],a),i.setFromPoints(s),e.insert(i,o)}e.removeEmptyNodes()};var l=new u;y.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var i=this.scale,n=i.x,r=i.y,a=i.z,s=l.lowerBound,o=l.upperBound;return s.x/=n,s.y/=r,s.z/=a,o.x/=n,o.y/=r,o.z/=a,this.tree.aabbQuery(l,t)},y.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},y.prototype.updateNormals=function(){for(var e=o,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n],s=this.indices[2+n];this.getVertex(r,p),this.getVertex(a,_),this.getVertex(s,v),y.computeNormal(_,p,v,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},y.prototype.updateEdges=function(){function e(e,t){i[r<a?r+"_"+a:a+"_"+r]=!0}for(var i={},t=0;t<this.indices.length/3;t++){var n=3*t,r=this.indices[n],a=this.indices[1+n];this.indices[2+n],e(),e(),e()}var s=Object.keys(i);for(this.edges=new Int16Array(2*s.length),t=0;t<s.length;t++){var o=s[t].split("_");this.edges[2*t]=parseInt(o[0],10),this.edges[2*t+1]=parseInt(o[1],10)}},y.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var s=new c,h=new c;y.prototype.getEdgeVector=function(e,t){var i=s,n=h;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var d=new c,f=new c;y.computeNormal=function(e,t,i,n){t.vsub(e,f),i.vsub(t,d),d.cross(f,n),n.isZero()||n.normalize()};var p=new c,_=new c,v=new c;y.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},y.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[1+i],n[2+i])},y.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),r.pointToWorldFrame(t,i,n,n),n},y.prototype.getTriangleVertices=function(e,t,i,n){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[1+r],i),this.getVertex(this.indices[2+r],n)},y.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var m=new u;y.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(m);var i=m.upperBound.x-m.lowerBound.x,n=m.upperBound.y-m.lowerBound.y,r=m.upperBound.z-m.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*i*2*i+2*r*2*r),1/12*e*(2*n*2*n+2*i*2*i))};var g=new c;y.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,r=(this.vertices,g);this.getVertex(0,r),t.copy(r),i.copy(r);for(var a=0;a!==n;a++)this.getVertex(a,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)},y.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},y.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new c,n=0,r=t.length/3;n!==r;n++){this.getVertex(n,i);var a=i.norm2();e<a&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new c;var b=new r,S=new u;y.prototype.calculateWorldAABB=function(e,t,i,n){var r=b,a=S;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)},y.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},y.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var a=[],s=[],o=0;o<=i;o++)for(var l=0;l<=n;l++){var c=l/n*r,u=o/i*Math.PI*2,h=(e+t*Math.cos(u))*Math.cos(c),d=(e+t*Math.cos(u))*Math.sin(c),f=t*Math.sin(u);a.push(h,d,f)}for(o=1;o<=i;o++)for(l=1;l<=n;l++){var p=(n+1)*o+l-1,_=(n+1)*(o-1)+l-1,v=(n+1)*(o-1)+l,m=(n+1)*o+l;s.push(p,_,m),s.push(_,v,m)}return new y(a,s)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t,i){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var R=[],k=[],O=[];r.prototype.solve=function(e,t){var i,n,r,a,s,o=0,l=this.iterations,c=this.tolerance*this.tolerance,u=this.equations,h=u.length,d=t.bodies,f=d.length,p=e;if(0!==h)for(var _=0;_!==f;_++)d[_].updateSolveMassProperties();var v=k,m=O,y=R;for(v.length=h,m.length=h,y.length=h,_=0;_!==h;_++){var g=u[_];y[_]=0,m[_]=g.computeB(p),v[_]=1/g.computeC()}if(0!==h){for(_=0;_!==f;_++){var b=(E=d[_]).vlambda,S=E.wlambda;b.set(0,0,0),S.set(0,0,0)}for(o=0;o!==l;o++){for(var T=a=0;T!==h;T++)g=u[T],i=m[T],n=v[T],(s=y[T])+(r=n*(i-g.computeGWlambda()-g.eps*s))<g.minForce?r=g.minForce-s:s+r>g.maxForce&&(r=g.maxForce-s),y[T]+=r,a+=0<r?r:-r,g.addToWlambda(r);if(a*a<c)break}for(_=0;_!==f;_++){var E,x=(E=d[_]).velocity,A=E.angularVelocity;E.vlambda.vmul(E.linearFactor,E.vlambda),x.vadd(E.vlambda,x),E.wlambda.vmul(E.angularFactor,E.wlambda),A.vadd(E.wlambda,A)}for(var C=u.length,w=1/p;C--;)u[C].multiplier=y[C]*w}return o}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t,i){function n(){this.equations=[]}(t.exports=n).prototype.solve=function(e,t){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t,i){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),r=e("../objects/Body");function a(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new n;var S=[],T=[],E={bodies:[]},s=r.STATIC;function x(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&s))return n}return!1}var o=[];function A(e,t,i,n){for(o.push(e),e.visited=!0,t(e,i,n);o.length;)for(var r,a=o.pop();r=x(a.children);)r.visited=!0,t(r,i,n),o.push(r)}function C(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var a=e.eqs[r];-1===i.indexOf(a)&&i.push(a)}}function w(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var i=S,n=this.nodePool,r=t.bodies,a=this.equations,s=a.length,o=r.length,l=this.subsolver;n.length<o;)n.push(this.createNode());i.length=o;for(var c=0;c<o;c++)i[c]=n[c];for(c=0;c!==o;c++){var u=i[c];u.body=r[c],u.children.length=0,u.eqs.length=0,u.visited=!1}for(var h=0;h!==s;h++){var d=a[h],f=(c=r.indexOf(d.bi),r.indexOf(d.bj)),p=i[c],_=i[f];p.children.push(_),p.eqs.push(d),_.children.push(p),_.eqs.push(d)}var v,m=0,y=T;l.tolerance=this.tolerance,l.iterations=this.iterations;for(var g=E;v=x(i);){y.length=0,g.bodies.length=0,A(v,C,g.bodies,y);var b=y.length;for(y=y.sort(w),c=0;c!==b;c++)l.addEquation(y[c]);l.solve(e,g),l.removeAllEquations(),m++}return m}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t,i){function n(){}(t.exports=n).prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],51:[function(e,t,i){var l=e("../collision/AABB"),c=e("../math/Vec3");function u(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new l,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,u.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new u,u.prototype.reset=function(e,t){this.children.length=this.data.length=0},u.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var a=!1;r.length||(this.subdivide(),a=!0);for(var s=0;8!==s;s++)if(r[s].insert(e,t,i+1))return!0;a&&(r.length=0)}return n.push(t),!0};var h=new c;u.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,n=this.children;n.push(new u({aabb:new l({lowerBound:new c(0,0,0)})}),new u({aabb:new l({lowerBound:new c(1,0,0)})}),new u({aabb:new l({lowerBound:new c(1,1,0)})}),new u({aabb:new l({lowerBound:new c(1,1,1)})}),new u({aabb:new l({lowerBound:new c(0,1,1)})}),new u({aabb:new l({lowerBound:new c(0,0,1)})}),new u({aabb:new l({lowerBound:new c(1,0,1)})}),new u({aabb:new l({lowerBound:new c(0,1,0)})})),i.vsub(t,h),h.scale(.5,h);for(var r=this.root||this,a=0;8!==a;a++){var s=n[a];s.root=r;var o=s.aabb.lowerBound;o.x*=h.x,o.y*=h.y,o.z*=h.z,o.vadd(t,o),o.vadd(h,s.aabb.upperBound)}},u.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var n=new l;u.prototype.rayQuery=function(e,t,i){return e.getAABB(n),n.toLocalFrame(t,n),this.aabbQuery(n,i),i},u.prototype.removeEmptyNodes=function(){for(var e=[this];e.length;){for(var t=e.pop(),i=t.children.length-1;0<=i;i--)t.children[i].data.length||t.children.splice(i,1);Array.prototype.push.apply(e,t.children)}}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t,i){function n(){this.objects=[],this.type=Object}(t.exports=n).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t,i){function n(){this.data={keys:[]}}(t.exports=n).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},n.prototype.set=function(e,t,i){if(t<e){var n=t;t=e,e=n}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=i,this.data[r]},n.prototype.reset=function(){for(var e=this.data,t=e.keys;0<t.length;)delete e[t.pop()]},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],55:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=e("./Pool");function a(){r.call(this),this.type=n}(a.prototype=new r).constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t,i){t.exports=o;var n=e("../collision/AABB"),E=e("../objects/Body"),r=e("../shapes/Shape"),I=e("../collision/Ray"),y=e("../math/Vec3"),P=e("../math/Transform"),a=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),s=(e("../solver/Solver"),e("../utils/Vec3Pool")),u=e("../equations/ContactEquation"),v=e("../equations/FrictionEquation");function o(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new s,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}o.prototype.createContactEquation=function(e,t,i,n,r,a){var s;this.contactPointPool.length?((s=this.contactPointPool.pop()).bi=e,s.bj=t):s=new u(e,t);var o=this.currentContactMaterial;s.restitution=o.restitution,s.setSpookParams(o.contactEquationStiffness,o.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,c=n.material||t.material;return l&&c&&0<=l.restitution&&0<=c.restitution&&(s.restitution=l.restitution*c.restitution),s.si=r||i,s.sj=a||n,s},o.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,r=e.si,a=e.sj,s=this.world,o=this.currentContactMaterial,l=o.friction,c=r.material||i.material,u=a.material||n.material;if(c&&u&&0<=c.friction&&0<=u.friction&&(l=c.friction*u.friction),0<l){var h=l*s.gravity.length(),d=i.invMass+n.invMass;0<d&&(d=1/d);var f=this.frictionEquationPool,p=f.length?f.pop():new v(i,n,h*d),_=f.length?f.pop():new v(i,n,h*d);return p.bi=_.bi=i,p.bj=_.bj=n,p.minForce=_.minForce=-h*d,p.maxForce=_.maxForce=h*d,p.ri.copy(e.ri),p.rj.copy(e.rj),_.ri.copy(e.ri),_.rj.copy(e.rj),e.ni.tangents(p.t,_.t),p.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),_.setSpookParams(o.frictionEquationStiffness,o.frictionEquationRelaxation,s.dt),p.enabled=_.enabled=e.enabled,t.push(p,_),!0}return!1};var l=new y,c=new y,h=new y;o.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];l.setZero(),c.setZero(),h.setZero();for(var r=t.bi,a=(t.bj,0);a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==r?(l.vadd(t.ni,l),c.vadd(t.ri,c),h.vadd(t.rj,h)):(l.vsub(t.ni,l),c.vadd(t.rj,c),h.vadd(t.ri,h));var s=1/e;c.scale(s,i.ri),h.scale(s,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),l.normalize(),l.tangents(i.t,n.t)}};var x=new y,A=new y,C=new a,w=new a;o.prototype.getContacts=function(e,t,i,n,r,a,s){this.contactPointPool=r,this.frictionEquationPool=s,this.result=n,this.frictionResult=a;for(var o=C,l=w,c=x,u=A,h=0,d=e.length;h!==d;h++){var f=e[h],p=t[h],_=null;f.material&&p.material&&(_=i.getContactMaterial(f.material,p.material)||null);for(var v=0==f.collisionResponse||0==p.collisionResponse||f.type&E.KINEMATIC&&p.type&E.STATIC||f.type&E.STATIC&&p.type&E.KINEMATIC||f.type&E.KINEMATIC&&p.type&E.KINEMATIC,m=0;m<f.shapes.length;m++){f.quaternion.mult(f.shapeOrientations[m],o),f.quaternion.vmult(f.shapeOffsets[m],c),c.vadd(f.position,c);for(var y=f.shapes[m],g=0;g<p.shapes.length;g++){p.quaternion.mult(p.shapeOrientations[g],l),p.quaternion.vmult(p.shapeOffsets[g],u),u.vadd(p.position,u);var b=p.shapes[g];if(y.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&y.collisionFilterGroup&&!(c.distanceTo(u)>y.boundingSphereRadius+b.boundingSphereRadius)){v|=0==y.collisionResponse||0==b.collisionResponse;var S=null;y.material&&b.material&&(S=i.getContactMaterial(y.material,b.material)||null),this.currentContactMaterial=S||_||i.defaultContactMaterial;var T=this[y.type|b.type];T&&(y.type<b.type?T.call(this,y,b,c,u,o,l,f,p,y,b,v):T.call(this,b,y,u,c,l,o,p,f,y,b,v))&&v&&(i.shapeOverlapKeeper.set(y.id,b.id),i.shapeOverlapKeeperExit.set(y.id,b.id),i.bodyOverlapKeeper.set(f.id,p.id))}}}}},o.prototype[r.types.BOX|r.types.BOX]=o.prototype.boxBox=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=o.prototype.boxConvex=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.BOX|r.types.PARTICLE]=o.prototype.boxParticle=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)},o.prototype[r.types.SPHERE]=o.prototype.sphereSphere=function(e,t,i,n,r,a,s,o,l,c,u){if(u)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(s,o,e,t,l,c);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(s.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(o.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var g=new y,b=new y,S=new y;o.prototype[r.types.PLANE|r.types.TRIMESH]=o.prototype.planeTrimesh=function(e,t,i,n,r,a,s,o,l,c,u){var h=new y,d=g;d.set(0,0,1),r.vmult(d,d);for(var f=0;f<t.vertices.length/3;f++){t.getVertex(f,h);var p=new y;p.copy(h),P.pointToWorldFrame(n,a,p,h);var _=b;if(h.vsub(i,_),d.dot(_)<=0){if(u)return!0;var v=this.createContactEquation(s,o,e,t,l,c);v.ni.copy(d);var m=S;d.scale(_.dot(d),m),h.vsub(m,m),v.ri.copy(m),v.ri.vsub(s.position,v.ri),v.rj.copy(h),v.rj.vsub(o.position,v.rj),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}}};var D=new y,N=new y,z=(new y,new y),U=new y,G=new y,V=new y,H=new y,W=new y,X=new y,j=new y,q=new y,Y=new y,K=new y,Q=new n,Z=[];o.prototype[r.types.SPHERE|r.types.TRIMESH]=o.prototype.sphereTrimesh=function(e,t,i,n,r,a,s,o,l,c,u){var h=G,d=V,f=H,p=W,_=X,v=j,m=Q,y=U,g=N,b=Z;P.pointToLocalFrame(n,a,i,_);var S=e.radius;m.lowerBound.set(_.x-S,_.y-S,_.z-S),m.upperBound.set(_.x+S,_.y+S,_.z+S),t.getTrianglesInAABB(m,b);for(var T=z,E=e.radius*e.radius,x=0;x<b.length;x++)for(var A=0;A<3;A++)if(t.getVertex(t.indices[3*b[x]+A],T),T.vsub(_,g),g.norm2()<=E){if(y.copy(T),P.pointToWorldFrame(n,a,y,T),T.vsub(i,g),u)return!0;(R=this.createContactEquation(s,o,e,t,l,c)).ni.copy(g),R.ni.normalize(),R.ri.copy(R.ni),R.ri.scale(e.radius,R.ri),R.ri.vadd(i,R.ri),R.ri.vsub(s.position,R.ri),R.rj.copy(T),R.rj.vsub(o.position,R.rj),this.result.push(R),this.createFrictionEquationsFromContact(R,this.frictionResult)}for(x=0;x<b.length;x++)for(A=0;A<3;A++){t.getVertex(t.indices[3*b[x]+A],h),t.getVertex(t.indices[3*b[x]+(A+1)%3],d),d.vsub(h,f),_.vsub(d,v);var C=v.dot(f);_.vsub(h,v);var w=v.dot(f);if(0<w&&C<0&&(_.vsub(h,v),p.copy(f),p.normalize(),w=v.dot(p),p.scale(w,v),v.vadd(h,v),(M=v.distanceTo(_))<e.radius)){if(u)return!0;var R=this.createContactEquation(s,o,e,t,l,c);v.vsub(_,R.ni),R.ni.normalize(),R.ni.scale(e.radius,R.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,R.rj),P.vectorToWorldFrame(a,R.ni,R.ni),P.vectorToWorldFrame(a,R.ri,R.ri),this.result.push(R),this.createFrictionEquationsFromContact(R,this.frictionResult)}}for(var k=q,O=Y,F=K,L=D,B=(x=0,b.length);x!==B;x++){t.getTriangleVertices(b[x],k,O,F),t.getNormal(b[x],L),_.vsub(k,v);var M=v.dot(L);if(L.scale(M,v),_.vsub(v,v),M=v.distanceTo(_),I.pointInTriangle(v,k,O,F)&&M<e.radius){if(u)return!0;R=this.createContactEquation(s,o,e,t,l,c),v.vsub(_,R.ni),R.ni.normalize(),R.ni.scale(e.radius,R.ri),P.pointToWorldFrame(n,a,v,v),v.vsub(o.position,R.rj),P.vectorToWorldFrame(a,R.ni,R.ni),P.vectorToWorldFrame(a,R.ri,R.ri),this.result.push(R),this.createFrictionEquationsFromContact(R,this.frictionResult)}}b.length=0};var p=new y,_=new y,m=new y,T=new y,R=new y;o.prototype[r.types.SPHERE|r.types.PLANE]=o.prototype.spherePlane=function(e,t,i,n,r,a,s,o,l,c,u){if(m.set(0,0,1),a.vmult(m,m),m.negate(m),m.normalize(),m.mult(e.radius,T),i.vsub(n,p),m.mult(m.dot(p),_),p.vsub(_,R),-p.dot(m)<=e.radius){if(u)return!0;var h=this.createContactEquation(s,o,e,t,l,c);h.ni.copy(m),h.ri.copy(T),h.rj.copy(R);var d=h.ri,f=h.rj;d.vadd(i,d),d.vsub(s.position,d),f.vadd(n,f),f.vsub(o.position,f),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var d=new y,f=new y,k=new y;function J(e,t,i){for(var n=null,r=e.length,a=0;a!==r;a++){var s=e[a],o=d;e[(a+1)%r].vsub(s,o);var l=f;o.cross(t,l);var c=k;i.vsub(s,c);var u=l.dot(c);if(!(null===n||0<u&&!0===n||u<=0&&!1===n))return!1;null===n&&(n=0<u)}return!0}var $=new y,ee=new y,te=new y,ie=new y,ne=[new y,new y,new y,new y,new y,new y],re=new y,ae=new y,se=new y,oe=new y;o.prototype[r.types.SPHERE|r.types.BOX]=o.prototype.sphereBox=function(e,t,i,n,r,a,s,o,l,c,u){var h=this.v3pool,d=ne;i.vsub(n,$),t.getSideNormals(d,a);for(var f=e.radius,p=!1,_=ae,v=se,m=oe,y=null,g=0,b=0,S=0,T=null,E=0,x=d.length;E!==x&&!1===p;E++){var A=ee;A.copy(d[E]);var C=A.norm();A.normalize();var w=$.dot(A);if(w<C+f&&0<w){var R=te,k=ie;R.copy(d[(E+1)%3]),k.copy(d[(E+2)%3]);var O=R.norm(),F=k.norm();R.normalize(),k.normalize();var L=$.dot(R),B=$.dot(k);if(L<O&&-O<L&&B<F&&-F<B){var M=Math.abs(w-C-f);if((null===T||M<T)&&(T=M,b=L,S=B,y=C,_.copy(A),v.copy(R),m.copy(k),g++,u))return!0}}}if(g){p=!0;var I=this.createContactEquation(s,o,e,t,l,c);_.mult(-f,I.ri),I.ni.copy(_),I.ni.negate(I.ni),_.mult(y,_),v.mult(b,v),_.vadd(v,_),m.mult(S,m),_.vadd(m,I.rj),I.ri.vadd(i,I.ri),I.ri.vsub(s.position,I.ri),I.rj.vadd(n,I.rj),I.rj.vsub(o.position,I.rj),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult)}for(var P=h.get(),D=re,N=0;2!==N&&!p;N++)for(var z=0;2!==z&&!p;z++)for(var U=0;2!==U&&!p;U++)if(P.set(0,0,0),N?P.vadd(d[0],P):P.vsub(d[0],P),z?P.vadd(d[1],P):P.vsub(d[1],P),U?P.vadd(d[2],P):P.vsub(d[2],P),n.vadd(P,D),D.vsub(i,D),D.norm2()<f*f){if(u)return!0;p=!0,(I=this.createContactEquation(s,o,e,t,l,c)).ri.copy(D),I.ri.normalize(),I.ni.copy(I.ri),I.ri.mult(f,I.ri),I.rj.copy(P),I.ri.vadd(i,I.ri),I.ri.vsub(s.position,I.ri),I.rj.vadd(n,I.rj),I.rj.vsub(o.position,I.rj),this.result.push(I),this.createFrictionEquationsFromContact(I,this.frictionResult)}h.release(P),P=null;var G=h.get(),V=h.get(),H=(I=h.get(),h.get()),W=(M=h.get(),d.length);for(N=0;N!==W&&!p;N++)for(z=0;z!==W&&!p;z++)if(N%3!=z%3){d[z].cross(d[N],G),G.normalize(),d[N].vadd(d[z],V),I.copy(i),I.vsub(V,I),I.vsub(n,I);var X=I.dot(G);for(G.mult(X,H),U=0;U===N%3||U===z%3;)U++;M.copy(i),M.vsub(H,M),M.vsub(V,M),M.vsub(n,M);var j=Math.abs(X),q=M.norm();if(j<d[U].norm()&&q<f){if(u)return!0;p=!0;var Y=this.createContactEquation(s,o,e,t,l,c);V.vadd(H,Y.rj),Y.rj.copy(Y.rj),M.negate(Y.ni),Y.ni.normalize(),Y.ri.copy(Y.rj),Y.ri.vadd(n,Y.ri),Y.ri.vsub(i,Y.ri),Y.ri.normalize(),Y.ri.mult(f,Y.ri),Y.ri.vadd(i,Y.ri),Y.ri.vsub(s.position,Y.ri),Y.rj.vadd(n,Y.rj),Y.rj.vsub(o.position,Y.rj),this.result.push(Y),this.createFrictionEquationsFromContact(Y,this.frictionResult)}}h.release(G,V,I,H,M)};var le=new y,ce=new y,ue=new y,he=new y,de=new y,fe=new y,pe=new y,_e=new y,ve=new y,me=new y;o.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=o.prototype.sphereConvex=function(e,t,i,n,r,a,s,o,l,c,u){var h=this.v3pool;i.vsub(n,le);for(var d=t.faceNormals,f=t.faces,p=t.vertices,_=e.radius,v=0;v!==p.length;v++){var m=p[v],y=de;a.vmult(m,y),n.vadd(y,y);var g=he;if(y.vsub(i,g),g.norm2()<_*_)return!!u||(b=!0,(M=this.createContactEquation(s,o,e,t,l,c)).ri.copy(g),M.ri.normalize(),M.ni.copy(M.ri),M.ri.mult(_,M.ri),y.vsub(n,M.rj),M.ri.vadd(i,M.ri),M.ri.vsub(s.position,M.ri),M.rj.vadd(n,M.rj),M.rj.vsub(o.position,M.rj),this.result.push(M),void this.createFrictionEquationsFromContact(M,this.frictionResult))}for(var b=!1,S=(v=0,f.length);v!==S&&!1===b;v++){var T=d[v],E=f[v],x=fe;a.vmult(T,x);var A=pe;a.vmult(p[E[0]],A),A.vadd(n,A);var C=_e;x.mult(-_,C),i.vadd(C,C);var w=ve;C.vsub(A,w);var R=w.dot(x),k=me;if(i.vsub(A,k),R<0&&0<k.dot(x)){for(var O=[],F=0,L=E.length;F!==L;F++){var B=h.get();a.vmult(p[E[F]],B),n.vadd(B,B),O.push(B)}if(J(O,x,i)){if(u)return!0;b=!0;var M=this.createContactEquation(s,o,e,t,l,c);x.mult(-_,M.ri),x.negate(M.ni);var I=h.get();x.mult(-R,I);var P=h.get();x.mult(-_,P),i.vsub(n,M.rj),M.rj.vadd(P,M.rj),M.rj.vadd(I,M.rj),M.rj.vadd(n,M.rj),M.rj.vsub(o.position,M.rj),M.ri.vadd(i,M.ri),M.ri.vsub(s.position,M.ri),h.release(I),h.release(P),this.result.push(M),this.createFrictionEquationsFromContact(M,this.frictionResult),F=0;for(var D=O.length;F!==D;F++)h.release(O[F]);return}for(F=0;F!==E.length;F++){var N=h.get(),z=h.get();a.vmult(p[E[(F+1)%E.length]],N),a.vmult(p[E[(F+2)%E.length]],z),n.vadd(N,N),n.vadd(z,z);var U=ce;z.vsub(N,U);var G=ue;U.unit(G);var V=h.get(),H=h.get();i.vsub(N,H);var W=H.dot(G);G.mult(W,V),V.vadd(N,V);var X=h.get();if(V.vsub(i,X),0<W&&W*W<U.norm2()&&X.norm2()<_*_){if(u)return!0;for(M=this.createContactEquation(s,o,e,t,l,c),V.vsub(n,M.rj),V.vsub(i,M.ni),M.ni.normalize(),M.ni.mult(_,M.ri),M.rj.vadd(n,M.rj),M.rj.vsub(o.position,M.rj),M.ri.vadd(i,M.ri),M.ri.vsub(s.position,M.ri),this.result.push(M),this.createFrictionEquationsFromContact(M,this.frictionResult),F=0,D=O.length;F!==D;F++)h.release(O[F]);return h.release(N),h.release(z),h.release(V),h.release(X),void h.release(H)}h.release(N),h.release(z),h.release(V),h.release(X),h.release(H)}for(F=0,D=O.length;F!==D;F++)h.release(O[F])}}},new y,new y,o.prototype[r.types.PLANE|r.types.BOX]=o.prototype.planeBox=function(e,t,i,n,r,a,s,o,l,c,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,a,s,o,e,t,u)};var O=new y,F=new y,L=new y,B=new y;o.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=o.prototype.planeConvex=function(e,t,i,n,r,a,s,o,l,c,u){var h=O,d=F;d.set(0,0,1),r.vmult(d,d);for(var f=0,p=L,_=0;_!==t.vertices.length;_++)if(h.copy(t.vertices[_]),a.vmult(h,h),n.vadd(h,h),h.vsub(i,p),d.dot(p)<=0){if(u)return!0;var v=this.createContactEquation(s,o,e,t,l,c),m=B;d.mult(d.dot(p),m),h.vsub(m,m),m.vsub(i,v.ri),v.ni.copy(d),h.vsub(n,v.rj),v.ri.vadd(i,v.ri),v.ri.vsub(s.position,v.ri),v.rj.vadd(n,v.rj),v.rj.vsub(o.position,v.rj),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)};var M=new y,ye=new y;o.prototype[r.types.CONVEXPOLYHEDRON]=o.prototype.convexConvex=function(e,t,i,n,r,a,s,o,l,c,u,h,d){var f=M;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,a,f,h,d)){var p=[],_=ye;e.clipAgainstHull(i,r,t,n,a,f,-100,100,p);for(var v=0,m=0;m!==p.length;m++){if(u)return!0;var y=this.createContactEquation(s,o,e,t,l,c),g=y.ri,b=y.rj;f.negate(y.ni),p[m].normal.negate(_),_.mult(p[m].depth,_),p[m].point.vadd(_,g),b.copy(p[m].point),g.vsub(i,g),b.vsub(n,b),g.vadd(i,g),g.vsub(s.position,g),b.vadd(n,b),b.vsub(o.position,b),this.result.push(y),v++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(y,this.frictionResult)}this.enableFrictionReduction&&v&&this.createFrictionFromAverage(v)}};var ge=new y,be=new y,Se=new y;o.prototype[r.types.PLANE|r.types.PARTICLE]=o.prototype.planeParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=ge;h.set(0,0,1),s.quaternion.vmult(h,h);var d=be;if(n.vsub(s.position,d),h.dot(d)<=0){if(u)return!0;var f=this.createContactEquation(o,s,t,e,l,c);f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0);var p=Se;h.mult(h.dot(n),p),n.vsub(p,p),f.rj.copy(p),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var Te=new y;o.prototype[r.types.PARTICLE|r.types.SPHERE]=o.prototype.sphereParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=Te;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var d=this.createContactEquation(o,s,t,e,l,c);h.normalize(),d.rj.copy(h),d.rj.mult(e.radius,d.rj),d.ni.copy(h),d.ni.negate(d.ni),d.ri.set(0,0,0),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var Ee=new a,xe=new y,Ae=(new y,new y),Ce=new y,we=new y;o.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=o.prototype.convexParticle=function(e,t,i,n,r,a,s,o,l,c,u){var h=-1,d=Ae,f=we,p=null,_=xe;if(_.copy(n),_.vsub(i,_),r.conjugate(Ee),Ee.vmult(_,_),e.pointIsInside(_)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var v=0,m=e.faces.length;v!==m;v++){var y=[e.worldVertices[e.faces[v][0]]],g=e.worldFaceNormals[v];n.vsub(y[0],Ce);var b=-g.dot(Ce);if(null===p||Math.abs(b)<Math.abs(p)){if(u)return!0;p=b,h=v,d.copy(g)}}if(-1!==h){var S=this.createContactEquation(o,s,t,e,l,c);d.mult(p,f),f.vadd(n,f),f.vsub(i,f),S.rj.copy(f),d.negate(S.ni),S.ri.set(0,0,0);var T=S.ri,E=S.rj;T.vadd(n,T),T.vsub(o.position,T),E.vadd(i,E),E.vsub(s.position,E),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},o.prototype[r.types.BOX|r.types.HEIGHTFIELD]=o.prototype.boxHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,a,s,o,e,t,u)};var Re=new y,ke=new y,Oe=[0];o.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=o.prototype.convexHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){var h=t.data,d=t.elementSize,f=e.boundingSphereRadius,p=ke,_=Oe,v=Re;P.pointToLocalFrame(n,a,i,v);var m=Math.floor((v.x-f)/d)-1,y=Math.ceil((v.x+f)/d)+1,g=Math.floor((v.y-f)/d)-1,b=Math.ceil((v.y+f)/d)+1;if(!(y<0||b<0||m>h.length||g>h[0].length)){m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),b<0&&(b=0),m>=h.length&&(m=h.length-1),y>=h.length&&(y=h.length-1),b>=h[0].length&&(b=h[0].length-1),g>=h[0].length&&(g=h[0].length-1);var S=[];t.getRectMinMax(m,g,y,b,S);var T=S[0],E=S[1];if(!(v.z-f>E||v.z+f<T))for(var x=m;x<y;x++)for(var A=g;A<b;A++){var C=!1;if(t.getConvexTrianglePillar(x,A,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,u,_,null)),u&&C)return!0;if(t.getConvexTrianglePillar(x,A,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(C=this.convexConvex(e,t.pillarConvex,i,p,r,a,s,o,null,null,u,_,null)),u&&C)return!0}}};var Fe=new y,Le=new y;o.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=o.prototype.sphereHeightfield=function(e,t,i,n,r,a,s,o,l,c,u){var h=t.data,d=e.radius,f=t.elementSize,p=Le,_=Fe;P.pointToLocalFrame(n,a,i,_);var v=Math.floor((_.x-d)/f)-1,m=Math.ceil((_.x+d)/f)+1,y=Math.floor((_.y-d)/f)-1,g=Math.ceil((_.y+d)/f)+1;if(!(m<0||g<0||v>h.length||g>h[0].length)){v<0&&(v=0),m<0&&(m=0),y<0&&(y=0),g<0&&(g=0),v>=h.length&&(v=h.length-1),m>=h.length&&(m=h.length-1),g>=h[0].length&&(g=h[0].length-1),y>=h[0].length&&(y=h[0].length-1);var b=[];t.getRectMinMax(v,y,m,g,b);var S=b[0],T=b[1];if(!(_.z-d>T||_.z+d<S))for(var E=this.result,x=v;x<m;x++)for(var A=y;A<g;A++){var C=E.length,w=!1;if(t.getConvexTrianglePillar(x,A,!1),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,u)),u&&w)return!0;if(t.getConvexTrianglePillar(x,A,!0),P.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.sphereConvex(e,t.pillarConvex,i,p,r,a,s,o,e,t,u)),u&&w)return!0;if(2<E.length-C)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(y,g,e){(function(e){g.exports=f,y("../shapes/Shape");var t=y("../math/Vec3"),i=(y("../math/Quaternion"),y("../solver/GSSolver")),n=(y("../equations/ContactEquation"),y("../equations/FrictionEquation"),y("./Narrowphase")),r=y("../utils/EventTarget"),a=(y("../collision/ArrayCollisionMatrix"),y("../collision/ObjectCollisionMatrix")),s=y("../collision/OverlapKeeper"),o=y("../material/Material"),l=y("../material/ContactMaterial"),P=y("../objects/Body"),c=y("../utils/TupleDictionary"),u=y("../collision/RaycastResult"),h=(y("../collision/AABB"),y("../collision/Ray")),d=y("../collision/NaiveBroadphase");function f(e){e=e||{},r.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.contactsDic=new c,this.oldContactsDic=new c,this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new t,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new d,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new i,this.constraints=[],this.narrowphase=new n(this),this.collisionMatrix=new a,this.triggerMatrix=new a,this.bodyOverlapKeeper=new s,this.shapeOverlapKeeper=new s,this.shapeOverlapKeeperExit=new s,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new l(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.broadphase.setWorld(this)}e&&(e.CANNON=!0),f.idToBodyMap={},f.idToShapeMap={},f.prototype=new r;var p=new h;f.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},f.prototype.numObjects=function(){return this.bodies.length},f.prototype.collisionMatrixTick=function(){},f.prototype.add=f.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof P&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,f.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},f.prototype.addConstraint=function(e){this.constraints.push(e)},f.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},f.prototype.rayTest=function(e,t,i){i instanceof u?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},f.prototype.raycastAll=function(e,t,i,n){return i.mode=h.ALL,i.from=e,i.to=t,i.callback=n,p.intersectWorld(this,i)},f.prototype.raycastAny=function(e,t,i,n){return i.mode=h.ANY,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},f.prototype.raycastClosest=function(e,t,i,n){return i.mode=h.CLOSEST,i.from=e,i.to=t,i.result=n,p.intersectWorld(this,i)},f.prototype.removeBody=f.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete f.idToBodyMap[e.id],this.dispatchEvent(this.removeBodyEvent)}},f.prototype.getBodyById=function(e){return f.idToBodyMap[e]},f.prototype.getShapeById=function(e){return f.idToShapeMap[e]},f.prototype.addMaterial=function(e){this.materials.push(e)},f.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},f.prototype.step=function(e,t,i){if(i=i||10,0===(t=t||0))this.internalStep(e),this.time+=e;else{this.accumulator+=t;for(var n=0;this.accumulator>=e&&n<i;)this.internalStep(e),this.accumulator-=e,n++;for(var r=this.accumulator%e/e,a=0;a!==this.bodies.length;a++){var s=this.bodies[a];s.previousPosition.lerp(s.position,r,s.interpolatedPosition),s.previousQuaternion.slerp(s.quaternion,r,s.interpolatedQuaternion),s.previousQuaternion.normalize()}this.time+=t}for(var o,l,c=this.contacts,u=this.contacts.length;u--;){var h=(g=c[u]).si,d=g.sj,f=this.contactsDic.get(h.id,d.id);null==f&&(f=this.contactsDic.set(h.id,d.id,[])),f.push(g)}for(this.emitTriggeredEvents(),u=this.contactsDic.getLength();u--;)if(o=this.contactsDic.getKeyByIndex(u),null!=(l=this.contactsDic.getDataByKey(o))){var p=l[0].bi,_=l[0].bj;if(h=l[0].si,d=l[0].sj,p.allowSleep&&p.type===P.DYNAMIC&&p.sleepState===P.SLEEPING&&_.sleepState===P.AWAKE&&_.type!==P.STATIC){var v=_.velocity.norm2()+_.angularVelocity.norm2();2*Math.pow(_.sleepSpeedLimit,2)<=v&&p.wakeUp()}if(_.allowSleep&&_.type===P.DYNAMIC&&_.sleepState===P.SLEEPING&&p.sleepState===P.AWAKE&&p.type!==P.STATIC){var m=p.velocity.norm2()+p.angularVelocity.norm2();2*Math.pow(p.sleepSpeedLimit,2)<=m&&_.wakeUp()}this.collisionMatrix.get(p,_)?b.event="onCollisionStay":(this.collisionMatrix.set(p,_,!0),b.event="onCollisionEnter"),b.contacts=l,b.body=d.body,b.selfShape=h,b.otherShape=d,h.body.dispatchEvent(b),b.body=h.body,b.selfShape=d,b.otherShape=h,d.body.dispatchEvent(b),this.bodyOverlapKeeper.set(p.id,_.id)}var y=D;for(u=y.length;u--;){var g;h=(g=y[u]).si,d=g.sj,null==this.oldContactsDic.get(h.id,d.id)&&this.oldContactsDic.set(h.id,d.id,g)}for(u=this.oldContactsDic.getLength();u--;)o=this.oldContactsDic.getKeyByIndex(u),null==this.contactsDic.getDataByKey(o)&&(p=(l=this.oldContactsDic.getDataByKey(o)).bi,_=l.bj,h=l.si,d=l.sj,this.collisionMatrix.get(p,_)&&(p.isSleeping()&&_.isSleeping()||(this.collisionMatrix.set(p,_,!1),b.event="onCollisionExit",b.body=d.body,b.selfShape=h,b.otherShape=d,b.contacts.length=0,b.contacts.push(l),h.body.dispatchEvent(b),b.body=h.body,b.selfShape=d,b.otherShape=h,d.body.dispatchEvent(b))));this.contactsDic.reset(),this.oldContactsDic.reset(),this.shapeOverlapKeeper.reset()};var b={type:"collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},D=[],N=[],z=[],U=[];f.prototype.internalStep=function(e){this.dt=e;var t=this.contacts,i=z,n=U,r=this.numObjects(),a=this.bodies,s=this.solver,o=this.gravity,l=(this.profile,P.DYNAMIC),c=this.constraints,u=N,h=o.x,d=o.y,f=o.z,p=0;for(p=0;p!==r;p++)if((x=a[p]).useGravity&&x.type===l){var _=x.force,v=x.mass;_.x+=v*h,_.y+=v*d,_.z+=v*f}p=0;for(var m=this.subsystems.length;p!==m;p++)this.subsystems[p].update();i.length=0,n.length=0,this.broadphase.collisionPairs(this,i,n);var y=c.length;for(p=0;p!==y;p++)if(!(C=c[p]).collideConnected)for(var g=i.length-1;0<=g;g-=1)(C.bodyA===i[g]&&C.bodyB===n[g]||C.bodyB===i[g]&&C.bodyA===n[g])&&(i.splice(g,1),n.splice(g,1));this.shapeOverlapKeeperExit.tick();var b=D,S=t.length;for(p=0;p!==S;p++)b.push(t[p]);t.length=0;var T=this.frictionEquations.length;for(p=0;p!==T;p++)u.push(this.frictionEquations[p]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,n,this,t,b,this.frictionEquations,u),p=0;p<this.frictionEquations.length;p++)s.addEquation(this.frictionEquations[p]);var E=t.length;for(p=0;p!==E;p++){var x=(C=t[p]).bi,A=C.bj;C.si,C.sj,(x.material&&A.material&&this.getContactMaterial(x.material,A.material)||this.defaultContactMaterial).friction,x.material&&A.material&&(0<=x.material.friction&&0<=A.material.friction&&(x.material.friction,A.material.friction),0<=x.material.restitution&&0<=A.material.restitution&&(C.restitution=x.material.restitution*A.material.restitution)),s.addEquation(C)}for(y=c.length,p=0;p!==y;p++){var C;(C=c[p]).update(),g=0;for(var w=C.equations.length;g!==w;g++){var R=C.equations[g];s.addEquation(R)}}s.solve(e,this),s.removeAllEquations();var k=Math.pow;for(r=this.numObjects(),p=0;p!==r;p++)if((x=a[p]).type&l){var O=k(1-x.linearDamping,e),F=x.velocity;F.mult(O,F);var L=x.angularVelocity;if(L){var B=k(1-x.angularDamping,e);L.mult(B,L)}}var M=this.stepnumber%(this.quatNormalizeSkip+1)==0,I=this.quatNormalizeFast;for(p=0;p!==r;p++)a[p].integrate(e,M,I);if(this.clearForces(),this.broadphase.dirty=!0,this.time+=e,this.stepnumber+=1,this.allowSleep)for(p=0;p!==r;p++)a[p].sleepTick(this.time)};var _=[],v=[],m={type:"triggered",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null};f.prototype.emitTriggeredEvents=function(){_.length=v.length=0,this.shapeOverlapKeeperExit.getDiff(_,v);for(var e=0,t=v.length;e<t;e+=2){m.event="onTriggerExit";var i=this.getShapeById(v[e]),n=this.getShapeById(v[e+1]);this.triggerMatrix.set(i,n,!1),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}for(_.length=v.length=0,this.shapeOverlapKeeper.getDiff(_,v),e=0,t=_.length;e<t;e+=2){var r=_[e],a=_[e+1];i=this.getShapeById(r),n=this.getShapeById(a),this.triggerMatrix.get(i,n)?m.event="onTriggerStay":(this.triggerMatrix.set(i,n,!0),m.event="onTriggerEnter"),m.selfShape=i,m.otherShape=n,m.selfBody=i.body,m.otherBody=n.body,i.dispatchEvent(m),m.selfShape=n,m.otherShape=i,m.selfBody=n.body,m.otherBody=i.body,n.dispatchEvent(m)}},f.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force.set(0,0,0),n.torque.set(0,0,0)}}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(mP={exports:{}},mP.exports),mP.exports);TP.CANNON,TP.Shape;function EP(e){return Oe.exactEquals(e,Oe.create())?"<origin>":"(x: ".concat(e.x,", y: ").concat(e.y,", z: ").concat(e.z,")")}function xP(e,t){e.__cc_wrapper__=t}function AP(e){return e.__cc_wrapper__}(gP=yP||(yP={}))[gP.DYNAMIC=1]="DYNAMIC",gP[gP.STATIC=2]="STATIC",gP[gP.KINEMATIC=4]="KINEMATIC",(SP=bP||(bP={}))[SP.SCENE=0]="SCENE",SP[SP.PHYSIC=1]="PHYSIC";var CP=new TP.Material(""),wP=new TP.ContactMaterial(CP,CP,{friction:.06,restitution:0});function RP(e){return function(e,t){for(var i={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],s=a;if(t){var o=t[a];o&&(s=o)}i[s]=e[a]}return i}(e,{queryTriggerInteraction:"checkCollisionResponse"})}function kP(e){return new TP.Vec3(e.x,e.y,e.z)}function OP(e,t){return Oe.copy(t,e)}function FP(e,t){e._assign(t.hitPointWorld,t.distance,AP(t.shape),AP(t.body))}function LP(e){e.updateMassProperties(),e.updateBoundingRadius(),e.aabbNeedsUpdate=!0}var BP=function(){function t(e){y(this,t),this._body=void 0,this._material=void 0,this._onCollidedListener=void 0,this._collisionCallbacks=[],this._shapes=[],this._userData=void 0,this._world=null,this._name=void 0,e=e||{},this._name=e.name||"",this._material=CP,this._body=new TP.Body({material:this._material,type:yP.DYNAMIC}),xP(this._body,this),this._body.allowSleep=!0,this._body.sleepSpeedLimit=.1,this._body.sleepTimeLimit=1,this._onCollidedListener=this._onCollided.bind(this)}return l(t,[{key:"impl",get:function(){return this._body}}]),l(t,[{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e}},{key:"wakeUp",value:function(){return this._body.wakeUp()}},{key:"sleep",value:function(){return this._body.sleep()}},{key:"name",value:function(){return this._name}},{key:"getType",value:function(){return this._body.type}},{key:"setType",value:function(e){this._body.type=e}},{key:"isAwake",value:function(){return this._body.isAwake()}},{key:"isSleepy",value:function(){return this._body.isSleepy()}},{key:"isSleeping",value:function(){return this._body.isSleeping()}},{key:"addShape",value:function(e,t){this._shapes.push(e),null!=t?this._body.addShape(e.impl,kP(t)):this._body.addShape(e.impl),e.setBody(this._body,this._shapes.length-1)}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&(this._shapes.splice(t,1),this._body.removeShape(e.impl),e.setBody(null,-1))}},{key:"getMass",value:function(){return this._body.mass}},{key:"setMass",value:function(e){this._body.mass=e,this._body.updateMassProperties()}},{key:"getIsKinematic",value:function(){return this._body.type===TP.Body.KINEMATIC}},{key:"setIsKinematic",value:function(e){this._body.type=e?TP.Body.KINEMATIC:TP.Body.DYNAMIC}},{key:"getLinearDamping",value:function(){return this._body.linearDamping}},{key:"setLinearDamping",value:function(e){this._body.linearDamping=e}},{key:"getAngularDamping",value:function(){return this._body.angularDamping}},{key:"setAngularDamping",value:function(e){this._body.angularDamping=e}},{key:"getUseGravity",value:function(){return this._body.useGravity}},{key:"setUseGravity",value:function(e){this._body.useGravity=e}},{key:"getCollisionResponse",value:function(){return this._body.collisionResponse}},{key:"setCollisionResponse",value:function(e){this._body.collisionResponse=!e}},{key:"getLinearVelocity",value:function(e){return e=e||new Br,Oe.copy(e,this._body.velocity),e}},{key:"setLinearVelocity",value:function(e){Oe.copy(this._body.velocity,e)}},{key:"getAngularVelocity",value:function(e){return e=e||new Br,Oe.copy(e,this._body.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){Oe.copy(this._body.angularVelocity,e)}},{key:"getLinearFactor",value:function(e){return e=e||new Br,Oe.copy(e,this._body.linearFactor),e}},{key:"setLinearFactor",value:function(e){Oe.copy(this._body.linearFactor,e)}},{key:"getAngularFactor",value:function(e){return e=e||new Br,Oe.copy(e,this._body.angularFactor),e}},{key:"setAngularFactor",value:function(e){Oe.copy(this._body.angularFactor,e)}},{key:"getFreezeRotation",value:function(){return this._body.fixedRotation}},{key:"setFreezeRotation",value:function(e){this._body.fixedRotation=e,this._body.updateMassProperties()}},{key:"applyForce",value:function(e,t){null==t&&(t=new Br,Oe.copy(t,this._body.position)),this._body.wakeUp(),this._body.applyForce(kP(e),kP(t))}},{key:"applyImpulse",value:function(e,t){null==t&&(t=new Br,Oe.copy(t,this._body.position)),this._body.wakeUp(),this._body.applyImpulse(kP(e),kP(t))}},{key:"applyLocalForce",value:function(e,t){null==t&&(t=new Br),this._body.wakeUp(),this._body.applyLocalForce(kP(e),kP(t))}},{key:"applyLocalImpulse",value:function(e,t){null==t&&(t=new Br),this._body.wakeUp(),this._body.applyLocalImpulse(kP(e),kP(t))}},{key:"setWorld",value:function(e){this._world&&(this._body.removeEventListener("collide",this._onCollidedListener),this._body.world.remove(this._body),this._world=null);var t=e;t&&(t.impl.addBody(this._body),this._body.addEventListener("collide",this._onCollidedListener)),this._world=t}},{key:"getPosition",value:function(e){Oe.copy(e,this._body.position)}},{key:"setPosition",value:function(e){Oe.copy(this._body.position,e)}},{key:"getRotation",value:function(e){De.copy(e,this._body.quaternion)}},{key:"setRotation",value:function(e){De.copy(this._body.quaternion,e)}},{key:"translateAndRotate",value:function(e,t){He.getTranslation(this._body.position,e),De.copy(this._body.quaternion,t)}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setScale(e)}}},{key:"addCollisionCallback",value:function(e){this._collisionCallbacks.push(e)}},{key:"removeCollisionCllback",value:function(e){var t=this._collisionCallbacks.indexOf(e);0<=t&&this._collisionCallbacks.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"_stringfyThis",value:function(){return"".concat(this._name.length?this._name:"<No-name>")}},{key:"_devStrinfy",value:function(){var e=this._body.shapes.map(function(e){return AP(e)._devStrinfy()}).join("; ");return"Name: [[".concat(this._name.length?this._name:"<No-name>","]], position: ").concat(EP(this._body.position),", shapes: [").concat(e,"]")}},{key:"_onCollided",value:function(e){MP.type=e.event,MP.selfCollider=AP(e.selfShape).getUserData(),MP.otherCollider=AP(e.otherShape).getUserData();var t=0;for(t=MP.contacts.length;t--;)IP.push(MP.contacts.pop());for(t=0;t<e.contacts.length;t++){var i=e.contacts[t];if(0<IP.length){var n=IP.pop();OP(i.ri,n.contactA),OP(i.rj,n.contactB),OP(i.ni,n.normal),MP.contacts.push(n)}else{var r={contactA:OP(i.ri,new Br),contactB:OP(i.rj,new Br),normal:OP(i.ni,new Br)};MP.contacts.push(r)}}for(t=0;t<this._collisionCallbacks.length;t++){(0,this._collisionCallbacks[t])(MP)}}}]),t}(),MP={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[]},IP=[],PP=function(){function e(){y(this,e),this._hitPoint=new Br,this._distance=0,this._collidier=null,this._node=null}return l(e,[{key:"_assign",value:function(e,t,i,n){Oe.copy(this._hitPoint,e),this._distance=t,this._node=n.getUserData(),this._collidier=i.getUserData()}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collidier}},{key:"node",get:function(){return this._node}}]),e}(),DP=function(){function e(){y(this,e),this._world=void 0,this._customBeforeStepListener=[],this._customAfterStepListener=[],this._raycastResult=new TP.RaycastResult,this._world=new TP.World,xP(this._world,this),this._world.allowSleep=!0,this._world.gravity.set(0,-9.81,0),this._world.broadphase=new TP.NaiveBroadphase,this._world.defaultMaterial=CP,this._world.defaultContactMaterial=wP}return l(e,[{key:"destroy",value:function(){}},{key:"step",value:function(e,t,i){this._callCustomBeforeSteps(),this._world.step(e,t,i),this._callCustomAfterSteps()}},{key:"addBeforeStep",value:function(e){this._customBeforeStepListener.push(e)}},{key:"removeBeforeStep",value:function(e){var t=this._customBeforeStepListener.indexOf(e);t<0||this._customBeforeStepListener.splice(t,1)}},{key:"addAfterStep",value:function(e){this._customAfterStepListener.push(e)}},{key:"removeAfterStep",value:function(e){var t=this._customAfterStepListener.indexOf(e);t<0||this._customAfterStepListener.splice(t,1)}},{key:"raycastClosest",value:function(e,t,i,n){var r=this._world.raycastClosest(e,t,RP(i),this._raycastResult);return r&&FP(n,this._raycastResult),r}},{key:"raycastAny",value:function(e,t,i,n){var r=this._world.raycastAny(e,t,RP(i),this._raycastResult);return r&&FP(n,this._raycastResult),r}},{key:"raycastAll",value:function(e,t,i,n){return this._world.raycastAll(e,t,RP(i),function(e){var t=new PP;FP(t,e),n(t)})}},{key:"addConstraint",value:function(e){this._world.addConstraint(e.impl)}},{key:"removeConstraint",value:function(e){this._world.removeConstraint(e.impl)}},{key:"_callCustomBeforeSteps",value:function(){this._customBeforeStepListener.forEach(function(e){return e()})}},{key:"_callCustomAfterSteps",value:function(){this._customAfterStepListener.forEach(function(e){return e()})}},{key:"impl",get:function(){return this._world}}]),e}(),NP=function(){function e(){y(this,e),this._scale=new Br(1,1,1),this._shape=null,this._body=null,this._index=-1,this._center=new Br(0,0,0),this._userData=void 0,this._onTriggerListener=void 0,this._triggeredCB=[],this._onTriggerListener=this.onTrigger.bind(this)}return l(e,[{key:"impl",get:function(){return this._shape}}]),l(e,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"getUserData",value:function(){return this._userData}},{key:"setUserData",value:function(e){this._userData=e}},{key:"setBody",value:function(e,t){null==e?this._shape.removeEventListener("triggered",this._onTriggerListener):this._shape.addEventListener("triggered",this._onTriggerListener),this._body=e,this._index=t}},{key:"setCenter",value:function(e){Oe.copy(this._center,e),this._recalcCenter()}},{key:"setScale",value:function(e){Oe.copy(this._scale,e),this._recalcCenter()}},{key:"setRotation",value:function(e){}},{key:"getCollisionResponse",value:function(){return this.impl.collisionResponse}},{key:"setCollisionResponse",value:function(e){this.impl.collisionResponse=e}},{key:"_devStrinfy",value:function(){return this._body?"centerOffset: ".concat(EP(this._body.shapeOffsets[this._index])):"<NotAttached>"}},{key:"onTrigger",value:function(e){zP.type=e.event,zP.selfCollider=AP(e.selfShape).getUserData(),zP.otherCollider=AP(e.otherShape).getUserData();var t=this._triggeredCB,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r(zP)}}},{key:"_recalcCenter",value:function(){if(this._body){var e=this._body.shapeOffsets[this._index];Oe.copy(e,this._center),Oe.multiply(e,e,this._scale),LP(this._body)}}}]),e}(),zP={type:"",selfCollider:null,otherCollider:null},UP=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this)))._box=void 0,t._halfExtent=new TP.Vec3,Oe.scale(t._halfExtent,e,.5),t._box=new TP.Box(t._halfExtent.clone()),xP(t._box,d(d(t))),t._shape=t._box,t._shape.addEventListener("trigger",t.onTrigger),t}return p(i,NP),l(i,[{key:"setScale",value:function(e){_(S(i.prototype),"setScale",this).call(this,e),this._recalcExtents()}},{key:"setSize",value:function(e){Oe.scale(this._halfExtent,e,.5),this._recalcExtents()}},{key:"_stringfyThis",value:function(){return"".concat(this._body?AP(this._body)._stringfyThis():"<No-body>","(Box)")}},{key:"_devStrinfy",value:function(){return"Box(".concat(_(S(i.prototype),"_devStrinfy",this).call(this),", halfExtents: ").concat(EP(this._box.halfExtents),")")}},{key:"_recalcExtents",value:function(){Oe.multiply(this._box.halfExtents,this._halfExtent,this._scale),this._box.updateConvexPolyhedronRepresentation(),null!=this._body&&LP(this._body)}}]),i}(),GP=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this)))._sphere=void 0,t._radius=0,t._radius=e,t._sphere=new TP.Sphere(t._radius),xP(t._sphere,d(d(t))),t._shape=t._sphere,t}return p(i,NP),l(i,[{key:"setScale",value:function(e){_(S(i.prototype),"setScale",this).call(this,e),this._recalcRadius()}},{key:"setRadius",value:function(e){this._radius=e,this._recalcRadius()}},{key:"_devStrinfy",value:function(){return"Sphere(".concat(_(S(i.prototype),"_devStrinfy",this).call(this),", radius: ").concat(this._sphere.radius,")")}},{key:"_recalcRadius",value:function(){var e;this._sphere.radius=this._radius*(e=this._scale,Math.max(e.x,Math.max(e.y,e.z))),null!=this._body&&LP(this._body)}}]),i}(),VP=function(){function e(){y(this,e),this.collisionFilterGroup=1,this.collisionFilterMask=1}return l(e,[{key:"getGroup",value:function(){return this.collisionFilterGroup}},{key:"setGroup",value:function(e){this.collisionFilterGroup=e}},{key:"addGroup",value:function(e){this.collisionFilterGroup|=e}},{key:"removeGroup",value:function(e){this.collisionFilterGroup&=~e}},{key:"getMask",value:function(){return this.collisionFilterMask}},{key:"setMask",value:function(e){this.collisionFilterMask=e}},{key:"addMask",value:function(e){this.collisionFilterMask|=e}},{key:"removeMask",value:function(e){this.collisionFilterMask&=~e}}]),e}(),HP=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this)))._id=void 0,t._type=yP.DYNAMIC,t._world=void 0,t._shapes=[],t.userData=void 0,t._id=i.idCounter++,t}return p(i,VP),l(i,[{key:"id",get:function(){return this._id}}]),l(i,[{key:"intersects",value:function(e){for(var t=0;t<this._shapes.length;t++)for(var i=this._shapes[t],n=0;n<e._shapes.length;n++){var r=e._shapes[n];0!=(i.collisionFilterGroup&r.collisionFilterMask)&&0!=(r.collisionFilterGroup&i.collisionFilterMask)&&(E_.resolve(i.worldShape,r.worldShape)&&(this._world.shapeArr.push(i),this._world.shapeArr.push(r)))}}},{key:"addShape",value:function(e){this._shapes.push(e),e.body=this}},{key:"removeShape",value:function(e){var t=this._shapes.indexOf(e);0<=t&&this._shapes.splice(t,1)}},{key:"setWorld",value:function(e){var t=e;t?t.addBody(this):null!=this._world&&this._world.removeBody(this),this._world=t}},{key:"getPosition",value:function(e){}},{key:"setPosition",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setPosition(e)}}},{key:"getRotation",value:function(e){}},{key:"setRotation",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setRotation(e)}}},{key:"scaleAllShapes",value:function(e){var t=this._shapes,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.setScale(e)}}},{key:"getUserData",value:function(){return this.userData}},{key:"setUserData",value:function(e){this.userData=e}},{key:"transform",value:function(e,t,i,n){for(var r=this._shapes.length;r--;)this._shapes[r].transform(e,t,i,n)}},{key:"translateAndRotate",value:function(e,t){for(var i=this._shapes.length;i--;)this._shapes[i].translateAndRotate(e,t)}}]),i}();HP.idCounter=0;var WP=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).body=void 0,e._localShape=void 0,e._worldShape=void 0,e._id=void 0,e.userData=void 0,e._triggeredCB=[],e._id=t.idCounter++,e}return p(t,VP),l(t,[{key:"localShape",get:function(){return this._worldShape}},{key:"worldShape",get:function(){return this._worldShape}},{key:"id",get:function(){return this._id}}]),l(t,[{key:"addTriggerCallback",value:function(e){this._triggeredCB.push(e)}},{key:"removeTriggerCallback",value:function(e){var t=this._triggeredCB.indexOf(e);0<=t&&this._triggeredCB.splice(t,1)}},{key:"onTrigger",value:function(e){var t=this._triggeredCB,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r(e)}}},{key:"setCenter",value:function(e){Oe.copy(this._localShape.center,e)}},{key:"getUserData",value:function(){return this.userData}},{key:"setUserData",value:function(e){this.userData=e}},{key:"getCollisionResponse",value:function(){return!1}},{key:"setCollisionResponse",value:function(e){}},{key:"setPosition",value:function(e){}},{key:"setRotation",value:function(e){throw new Error("Method not implemented.")}},{key:"transform",value:function(e,t,i,n){this._localShape.transform(e,t,i,n,this._worldShape)}},{key:"translateAndRotate",value:function(e,t){this._localShape.translateAndRotate(e,t,this._worldShape)}},{key:"setScale",value:function(e){this._localShape.setScale(e,this._worldShape)}}]),t}();WP.idCounter=0;var XP,jP,qP,YP,KP="undefined"==typeof window?global:window;void 0===KP.CC_PHYSICS_CANNON&&(KP.CC_PHYSICS_CANNON=!0),void 0===KP.CC_PHYSICS_AMMO&&(KP.CC_PHYSICS_AMMO=!1),void 0===KP.CC_PHYSICS_BUILT_IN&&(KP.CC_PHYSICS_BUILT_IN=!1),XP=UP,jP=GP,qP=BP,YP=DP,cc.createRaycastResult=function(){return new PP};var QP,ZP,JP,$P,eD,tD,iD,nD=function(e){function o(){var e;return y(this,o),(e=T(this,S(o).call(this)))._sharedBody=void 0,e._isPreLoaded=!1,e}return p(o,Nh),l(o,[{key:"_body",get:function(){return this._sharedBody.body}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_assertPreload",get:function(){return this._isPreLoaded||console.error("Physic Error :","Please make sure that the node has been added to the scene"),this._isPreLoaded}}]),l(o,[{key:"setGroup",value:function(e){if(this._assertPreload)return this._body.setGroup(e)}},{key:"getGroup",value:function(){return this._assertPreload?this._body.getGroup():0}},{key:"addGroup",value:function(e){if(this._assertPreload)return this._body.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertPreload)return this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertPreload?this._body.getMask():0}},{key:"setMask",value:function(e){if(this._assertPreload)return this._body.setMask(e)}},{key:"addMask",value:function(e){if(this._assertPreload)return this._body.addMask(e)}},{key:"removeMask",value:function(e){if(this._assertPreload)return this._body.removeMask(e)}},{key:"__preload",value:function(){if(null==this._sharedBody){var e=null,t=this.node.getComponents(o),i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a._sharedBody){e=a._sharedBody;break}}if(!e){var s=this.getComponent(cc.RigidBodyComponent);e=new rD(this.node,s,cc.director._physicsSystem.world)}e.ref(),this._sharedBody=e}this._isPreLoaded=!0}},{key:"onEnable",value:function(){this.sharedBody.enable()}},{key:"onDisable",value:function(){this.sharedBody.disable()}},{key:"onDestroy",value:function(){this._sharedBody.deref(),this._sharedBody=null}},{key:"_findRigidbody",value:function(e){var t=e.getComponent(cc.RigidBodyComponent);return t||(e.parent?e.parent===e.scene?null:this._findRigidbody(e.parent):null)}}]),o}(),rD=function(){function r(e,t,i){var n;y(this,r),this._body=void 0,this._refCount=0,this._actived=!1,this._world=void 0,this._rigidBody=void 0,this._node=void 0,this._worldScale=new Br(1,1,1),this._beforeStepCallback=void 0,this._afterStepCallback=void 0,this._isShapeOnly=!0,this._prevScale=new Br,this._body=(n={name:e.name},new qP(n)),this._node=e,this._rigidBody=t,this._world=i,this._body.setUserData(this._rigidBody),this._beforeStepCallback=this._beforeStep.bind(this),this._afterStepCallback=this._afterStep.bind(this),this._rigidBody?this._isShapeOnly=!1:(this._isShapeOnly=!0,this._body.setUseGravity(!1))}return l(r,[{key:"isShapeOnly",get:function(){return this._isShapeOnly}},{key:"body",get:function(){return this._body}},{key:"transfromSource",set:function(e){e===bP.SCENE?this._isShapeOnly=!0:this._isShapeOnly=!1}},{key:"rigidBody",get:function(){return this._rigidBody}}]),l(r,[{key:"ref",value:function(){++this._refCount}},{key:"deref",value:function(){--this._refCount,this._refCount||this.destroy()}},{key:"enable",value:function(){this._activeBody()}},{key:"disable",value:function(){this._deactiveBody()}},{key:"destroy",value:function(){this._deactiveBody(),this._body.setUserData(null),this._body=null,this._beforeStepCallback=null,this._afterStepCallback=null,this._world=null,this._node=null,this._rigidBody&&(this._rigidBody=null)}},{key:"syncPhysWithScene",value:function(){this._syncPhysWithScene(this._node)}},{key:"_syncPhysWithScene",value:function(e){e.getWorldMatrix(r._tempMat4),e.getWorldRotation(r._tempQuat),this._body.translateAndRotate(r._tempMat4,r._tempQuat)}},{key:"_syncSceneWithPhys",value:function(){this._node&&(this._body.getPosition(r._tempVec3),this._node.setWorldPosition(r._tempVec3),this._body.getFreezeRotation()||(this._body.getRotation(r._tempQuat),this._node.setWorldRotation(r._tempQuat)))}},{key:"_activeBody",value:function(){this._syncPhysWithScene(this._node),this._actived||(this._actived=!0,this._body.setWorld(this._world),this._world.addBeforeStep(this._beforeStepCallback),this._world.addAfterStep(this._afterStepCallback),this._body.wakeUp())}},{key:"_deactiveBody",value:function(){this._actived&&(this._actived=!1,this._world.removeBeforeStep(this._beforeStepCallback),this._world.removeAfterStep(this._afterStepCallback),this._body.sleep(),this._body.setWorld(null))}},{key:"_beforeStep",value:function(){this._node.hasChanged&&(Oe.equals(this._prevScale,this._node.worldScale)||(this._body.scaleAllShapes(this._node.worldScale),Oe.copy(this._prevScale,this._node.worldScale)),this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp())}},{key:"_afterStep",value:function(){this._isShapeOnly||this._body.getType()!==yP.DYNAMIC?this._node.hasChanged&&(this._syncPhysWithScene(this._node),this._body.isSleeping()&&this._body.wakeUp()):this._syncSceneWithPhys()}}]),r}();rD._tempMat4=new Dr,rD._tempQuat=new Pr,rD._tempVec3=new Br;var aD=(QP=un("cc.ColliderComponent"),ZP=hn({displayOrder:0}),JP=hn({type:Br,displayOrder:1,tooltip:"The center of the collider, in local space"}),QP((c((eD=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this)))._callbackTable=dt(!0),e._shapeBase=void 0,e._trrigerCallback=void 0,e._collisionCallBack=void 0,v(e,"_isTrigger",tD,d(d(e))),v(e,"_center",iD,d(d(e))),e._trrigerCallback=e._onTrigger.bind(d(d(e))),e._collisionCallBack=e._onCollision.bind(d(d(e))),e}return p(t,nD),l(t,[{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e;var t=this._isTrigger?yP.DYNAMIC:yP.STATIC;this.sharedBody.body.setType(t),this._shapeBase.setCollisionResponse(!this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){Oe.copy(this._center,e);var t=this.sharedBody.rigidBody;null!=t?(Oe.sub(oN,this.node.worldPosition,t.node.worldPosition),Oe.add(oN,oN,this._center),this._shapeBase.setCenter(oN)):this._shapeBase.setCenter(this._center)}},{key:"attachedRigidbody",get:function(){return this.sharedBody.rigidBody}}]),l(t,[{key:"on",value:function(e,t,i,n){}},{key:"off",value:function(e,t,i,n){}},{key:"once",value:function(e,t,i,n){}},{key:"targetOff",value:function(e){}},{key:"dispatchEvent",value:function(e){}},{key:"hasEventListener",value:function(e,t,i){return!1}},{key:"removeAll",value:function(e){}},{key:"emit",value:function(e){}},{key:"onLoad",value:function(){this.isTrigger=this._isTrigger,this.center=this._center}},{key:"onEnable",value:function(){_(S(t.prototype),"onEnable",this).call(this);var e=this.sharedBody.rigidBody;null!=e?(Oe.sub(oN,this.node.worldPosition,e.node.worldPosition),Oe.add(oN,oN,this._center),this.sharedBody.body.addShape(this._shapeBase,oN)):this.sharedBody.body.addShape(this._shapeBase,this._center),this._shapeBase.addTriggerCallback(this._trrigerCallback),this.sharedBody.body.addCollisionCallback(this._collisionCallBack),this.sharedBody.syncPhysWithScene()}},{key:"onDisable",value:function(){this._shapeBase.removeTriggerCallback(this._trrigerCallback),this.sharedBody.body.removeCollisionCllback(this._collisionCallBack),this.sharedBody.body.removeShape(this._shapeBase),this.sharedBody.isShapeOnly&&_(S(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this.sharedBody.body.removeShape(this._shapeBase),_(S(t.prototype),"onDestroy",this).call(this)}},{key:"_onTrigger",value:function(e){this.emit(e.type,e)}},{key:"_onCollision",value:function(e){this.emit(e.type,e)}}]),t}()).prototype,"isTrigger",[ZP],Object.getOwnPropertyDescriptor(eD.prototype,"isTrigger"),eD.prototype),c(eD.prototype,"center",[JP],Object.getOwnPropertyDescriptor(eD.prototype,"center"),eD.prototype),tD=c(eD.prototype,"_isTrigger",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iD=c(eD.prototype,"_center",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new cc.Vec3(0,0,0)}}),$P=eD))||$P);jn(aD,[Pn,Xn]);var sD,oD,lD,cD,uD,hD,dD,fD,pD,_D,vD,mD,yD,gD,bD,SD,TD,ED,xD,AD,CD,wD,RD,kD,OD,FD,LD,BD,MD,ID,PD,DD,ND,zD,UD,GD,VD,HD,WD,XD,jD,qD,YD,KD,QD,ZD,JD,$D,eN,tN,iN,nN,rN,aN,sN,oN=new Br,lN=(sD=un("cc.BoxColliderComponent"),oD=mn(98),lD=vn("Components/BoxColliderComponent"),cD=hn({type:Br}),sD(uD=oD(uD=lD(uD=pn((dD=c((hD=function(e){function i(){var e,t;return y(this,i),(e=T(this,S(i).call(this)))._shape=void 0,v(e,"_size",dD,d(d(e))),e._shape=(t=e._size,new XP(t)),e._shape.setUserData(d(d(e))),e._shapeBase=e._shape,e}return p(i,aD),l(i,[{key:"onLoad",value:function(){_(S(i.prototype),"onLoad",this).call(this),this.size=this._size,this._shape.setScale(this.node.worldScale)}},{key:"size",get:function(){return this._size},set:function(e){Oe.copy(this._size,e),this._shape.setSize(this._size)}}]),i}()).prototype,"_size",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(0,0,0)}}),c(hD.prototype,"size",[cD],Object.getOwnPropertyDescriptor(hD.prototype,"size"),hD.prototype),uD=hD))||uD)||uD)||uD)||uD),cN=un("cc.SphereColliderComponent")(fD=mn(98)(fD=vn("Components/SphereColliderComponent")(fD=pn((_D=c((pD=function(e){function i(){var e,t;return y(this,i),(e=T(this,S(i).call(this)))._shape=void 0,v(e,"_radius",_D,d(d(e))),e._shape=(t=e._radius,new jP(t)),e._shape.setUserData(d(d(e))),e._shapeBase=e._shape,e}return p(i,aD),l(i,[{key:"onLoad",value:function(){_(S(i.prototype),"onLoad",this).call(this),this.radius=this._radius,this._shape.setScale(this.node.worldScale)}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._shape.setRadius(this._radius)}}]),i}()).prototype,"_radius",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c(pD.prototype,"radius",[hn],Object.getOwnPropertyDescriptor(pD.prototype,"radius"),pD.prototype),fD=pD))||fD)||fD)||fD)||fD,uN=10,hN=0,dN=0,fN=(vD=un("cc.RigidBodyComponent"),mD=mn(99),yD=vn("Components/RigidBodyComponent"),gD=hn({displayOrder:0}),bD=hn({displayOrder:1}),SD=hn({displayOrder:2}),TD=hn({displayOrder:3}),ED=hn({displayOrder:4}),xD=hn({displayOrder:5}),AD=hn({displayOrder:6}),CD=hn({displayOrder:7}),vD(wD=mD(wD=yD(wD=pn((c((RD=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_mass",kD,d(d(e))),v(e,"_linearDamping",OD,d(d(e))),v(e,"_angularDamping",FD,d(d(e))),v(e,"_fixedRotation",LD,d(d(e))),v(e,"_isKinematic",BD,d(d(e))),v(e,"_useGravity",MD,d(d(e))),v(e,"_linearFactor",ID,d(d(e))),v(e,"_angularFactor",PD,d(d(e))),e}return p(t,nD),l(t,[{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._body.setMass(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body.setUseGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body.setFreezeRotation(e)}},{key:"linearFactor",get:function(){return this._body.getLinearFactor(this._linearFactor)},set:function(e){Oe.copy(this._linearFactor,e),this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._body.getAngularFactor(this._angularFactor)},set:function(e){Oe.copy(this._angularFactor,e),this._body.setAngularFactor(this._angularFactor)}},{key:"isAwake",get:function(){return!!this._assertPreload&&this._body.isAwake()}},{key:"isSleepy",get:function(){return!!this._assertPreload&&this._body.isSleepy()}},{key:"isSleeping",get:function(){return!!this._assertPreload&&this._body.isSleeping()}}]),l(t,[{key:"applyForce",value:function(e,t){this._assertPreload&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertPreload&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertPreload&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertPreload&&this._body.applyLocalImpulse(e,t)}},{key:"wakeUp",value:function(){this._assertPreload&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertPreload&&this._body.sleep()}},{key:"getLinearVelocity",value:function(e){return this._assertPreload?this._body.getLinearVelocity(e):e=e||new Br}},{key:"setLinearVelocity",value:function(e){this._assertPreload&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){return this._assertPreload?this._body.getAngularVelocity(e):e=e||new Br}},{key:"setAngularVelocity",value:function(e){this._assertPreload&&this._body.setAngularVelocity(e)}},{key:"onLoad",value:function(){this.sharedBody&&(this.mass=this._mass,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.useGravity=this._useGravity,this.isKinematic=this._isKinematic,this.fixedRotation=this._fixedRotation,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor)}}]),t}()).prototype,"mass",[gD],Object.getOwnPropertyDescriptor(RD.prototype,"mass"),RD.prototype),c(RD.prototype,"linearDamping",[bD],Object.getOwnPropertyDescriptor(RD.prototype,"linearDamping"),RD.prototype),c(RD.prototype,"angularDamping",[SD],Object.getOwnPropertyDescriptor(RD.prototype,"angularDamping"),RD.prototype),c(RD.prototype,"isKinematic",[TD],Object.getOwnPropertyDescriptor(RD.prototype,"isKinematic"),RD.prototype),c(RD.prototype,"useGravity",[ED],Object.getOwnPropertyDescriptor(RD.prototype,"useGravity"),RD.prototype),c(RD.prototype,"fixedRotation",[xD],Object.getOwnPropertyDescriptor(RD.prototype,"fixedRotation"),RD.prototype),c(RD.prototype,"linearFactor",[AD],Object.getOwnPropertyDescriptor(RD.prototype,"linearFactor"),RD.prototype),c(RD.prototype,"angularFactor",[CD],Object.getOwnPropertyDescriptor(RD.prototype,"angularFactor"),RD.prototype),kD=c(RD.prototype,"_mass",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uN}}),OD=c(RD.prototype,"_linearDamping",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hN}}),FD=c(RD.prototype,"_angularDamping",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dN}}),LD=c(RD.prototype,"_fixedRotation",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BD=c(RD.prototype,"_isKinematic",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MD=c(RD.prototype,"_useGravity",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ID=c(RD.prototype,"_linearFactor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(1,1,1)}}),PD=c(RD.prototype,"_angularFactor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Br(1,1,1)}}),wD=RD))||wD)||wD)||wD)||wD),pN=(DD=un("cc.SphereLightComponent"),ND=vn("Components/SphereLightComponent"),zD=hn({unit:"lm"}),UD=hn({unit:"cd/m"}),GD=hn({type:hE}),DD(VD=ND(VD=pn((WD=c((HD=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_size",WD,d(d(t))),v(t,"_luminance",XD,d(d(t))),v(t,"_term",jD,d(d(t))),v(t,"_range",qD,d(d(t))),t._type=ST.SPHERE,t._light=null,t}return p(a,dE),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e||(e=this._getRenderScene()),this._light&&e.sphereLights.find(function(e){return e===t._light})||(this._light=e.createSphereLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,_(S(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(e||(e=this._getRenderScene()),e.destroySphereLight(this._light),_(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*cE(this._size)},set:function(e){this._luminance=e/cE(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),a}()).prototype,"_size",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),XD=c(HD.prototype,"_luminance",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/cE(.15)}}),jD=c(HD.prototype,"_term",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hE.LUMINOUS_POWER}}),qD=c(HD.prototype,"_range",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(HD.prototype,"luminousPower",[zD],Object.getOwnPropertyDescriptor(HD.prototype,"luminousPower"),HD.prototype),c(HD.prototype,"luminance",[UD],Object.getOwnPropertyDescriptor(HD.prototype,"luminance"),HD.prototype),c(HD.prototype,"term",[GD],Object.getOwnPropertyDescriptor(HD.prototype,"term"),HD.prototype),c(HD.prototype,"size",[hn],Object.getOwnPropertyDescriptor(HD.prototype,"size"),HD.prototype),c(HD.prototype,"range",[hn],Object.getOwnPropertyDescriptor(HD.prototype,"range"),HD.prototype),VD=HD))||VD)||VD)||VD),_N=(YD=un("cc.SpotLightComponent"),KD=vn("Components/SpotLightComponent"),QD=hn({unit:"lm"}),ZD=hn({unit:"cd/m"}),JD=hn({type:hE}),$D=hn({slide:!0,range:[2,180,1]}),YD(eN=KD(eN=pn((iN=c((tN=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_size",iN,d(d(t))),v(t,"_luminance",nN,d(d(t))),v(t,"_term",rN,d(d(t))),v(t,"_range",aN,d(d(t))),v(t,"_spotAngle",sN,d(d(t))),t._type=ST.SPOT,t._light=null,t}return p(a,dE),l(a,[{key:"_createLight",value:function(e){var t=this;this.node.scene&&(e||(e=this._getRenderScene()),this._light&&e.spotLights.find(function(e){return e===t._light})||(this._light=e.createSpotLight(this.name,this.node),this._light?(this._light.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,_(S(a.prototype),"_createLight",this).call(this,e)):console.warn("we don't support this many lights in forward pipeline.")))}},{key:"_destroyLight",value:function(e){this.node.scene&&this._light&&(e||(e=this._getRenderScene()),e.destroySpotLight(this._light),_(S(a.prototype),"_destroyLight",this).call(this,e))}},{key:"luminousPower",get:function(){return this._luminance*cE(this._size)},set:function(e){this._luminance=e/cE(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=he(e))}}]),a}()).prototype,"_size",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),nN=c(tN.prototype,"_luminance",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/cE(.15)}}),rN=c(tN.prototype,"_term",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hE.LUMINOUS_POWER}}),aN=c(tN.prototype,"_range",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sN=c(tN.prototype,"_spotAngle",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),c(tN.prototype,"luminousPower",[QD],Object.getOwnPropertyDescriptor(tN.prototype,"luminousPower"),tN.prototype),c(tN.prototype,"luminance",[ZD],Object.getOwnPropertyDescriptor(tN.prototype,"luminance"),tN.prototype),c(tN.prototype,"term",[JD],Object.getOwnPropertyDescriptor(tN.prototype,"term"),tN.prototype),c(tN.prototype,"size",[hn],Object.getOwnPropertyDescriptor(tN.prototype,"size"),tN.prototype),c(tN.prototype,"range",[hn],Object.getOwnPropertyDescriptor(tN.prototype,"range"),tN.prototype),c(tN.prototype,"spotAngle",[$D],Object.getOwnPropertyDescriptor(tN.prototype,"spotAngle"),tN.prototype),eN=tN))||eN)||eN)||eN),vN=function(){function e(){y(this,e),this._world=void 0,this._enable=!0,this._deltaTime=1/60,this._maxSubStep=2,this._world=new YP}return l(e,[{key:"update",value:function(e){this._enable&&this._world.step(this._deltaTime,e,this._maxSubStep)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"maxSubStep",get:function(){return this._maxSubStep},set:function(e){this._maxSubStep=e}},{key:"deltaTime",get:function(){return this._deltaTime},set:function(e){this._deltaTime=e}},{key:"world",get:function(){return this._world}}]),e}();function mN(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function yN(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,s=(e.length||1)/2,_=[Oe.set(EN,-r,-a,s),Oe.set(xN,r,-a,s),Oe.set(AN,r,a,s),Oe.set(CN,-r,a,s),Oe.set(wN,r,-a,-s),Oe.set(RN,-r,-a,-s),Oe.set(kN,-r,a,-s),Oe.set(ON,r,a,-s)],v=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],y=[],g=[],b=[],S=[],o=new Br(-r,-a,-s),l=new Br(r,a,s),c=Math.sqrt(r*r+a*a+s*s);function u(e,t,i){var n,r,a,s,o=y.length/3,l=v[e],c=m[e];for(s=0;s<=i;s++)for(a=0;a<=t;a++)if(n=a/t,r=s/i,Oe.lerp(gN,_[l[0]],_[l[1]],n),Oe.lerp(bN,_[l[0]],_[l[2]],r),Oe.subtract(SN,bN,_[l[0]]),Oe.add(TN,gN,SN),y.push(TN.x,TN.y,TN.z),g.push(c[0],c[1],c[2]),b.push(n,r),a<t&&s<i){var u=t+1,h=a+s*u,d=a+(s+1)*u,f=a+1+(s+1)*u,p=a+1+s*u;S.push(o+h,o+p,o+d),S.push(o+d,o+p,o+f)}}return u(0,t,i),u(4,n,i),u(1,t,i),u(5,n,i),u(3,t,n),u(2,t,n),{positions:y,normals:g,uvs:b,indices:S,minPos:o,maxPos:l,boundingRadius:c}}cc.AudioSourceComponent=Zm,cc.CameraComponent=WT,cc.EditorComponent=pE,cc.RenderableComponent=AT,cc.ModelComponent=wT,cc.SkinningModelComponent=RT,cc.AvatarModelComponent=BT,cc.AvatarUnit=OT,cc.BatchedSkinningModelComponent=UT,cc.SkinningModelUnit=DT,cc.LightComponent=dE,cc.DirectionalLightComponent=fE,cc.SphereLightComponent=pN,cc.SpotLightComponent=_N,cc.ParticleSystemComponent=pP,cc.BillboardComponent=fO,cc.LineComponent=RO,cc.ColliderComponent=aD,cc.BoxColliderComponent=lN,cc.SphereColliderComponent=cN,cc.RigidBodyComponent=fN,cc.ParticleUtils=_P;var gN=new Br,bN=new Br,SN=new Br,TN=new Br,EN=new Br,xN=new Br,AN=new Br,CN=new Br,wN=new Br,RN=new Br,kN=new Br,ON=new Br,FN=Oe.create(0,0,0),LN=Oe.create(0,0,0);function BN(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,b=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},S=.5*b,T=e.radialSegments||32,E=e.heightSegments||1,t=void 0===e.capped||e.capped,x=e.arc||2*Math.PI,i=0;t||(0<y&&i++,0<g&&i++);var n=(T+1)*(E+1);t&&(n+=(T+1)*i+T*i);var r=T*E*2*3;t&&(r+=T*i*3);var A=new Array(r),C=new Array(3*n),w=new Array(3*n),R=new Array(2*n),a=Math.max(y,g),s=Oe.create(-a,-S,-a),o=Oe.create(a,S,a),l=Math.sqrt(a*a+S*S),k=0,O=0;return function(){for(var e=[],t=y-g,i=t*t/b*Math.sign(t),n=0;n<=E;n++){for(var r=[],a=n/E,s=a*t+g,o=0;o<=T;++o){var l=o/T,c=l*x,u=Math.sin(c),h=Math.cos(c);C[3*k]=s*u,C[3*k+1]=a*b-S,C[3*k+2]=s*h,Oe.normalize(FN,Oe.set(LN,u,-i,h)),w[3*k]=FN.x,w[3*k+1]=FN.y,w[3*k+2]=FN.z,R[2*k]=2*(1-l)%1,R[2*k+1]=a,r.push(k),++k}e.push(r)}for(var d=0;d<E;++d)for(var f=0;f<T;++f){var p=e[d][f],_=e[d+1][f],v=e[d+1][f+1],m=e[d][f+1];A[O]=p,A[++O]=m,A[++O]=_,A[++O]=m,A[++O]=v,A[++O]=_,++O}}(),t&&(0<g&&c(!1),0<y&&c(!0)),{positions:C,normals:w,uvs:R,indices:A,minPos:s,maxPos:o,boundingRadius:l};function c(e){for(var t=e?y:g,i=e?1:-1,n=k,r=1;r<=T;++r)C[3*k]=0,C[3*k+1]=S*i,C[3*k+2]=0,w[3*k]=0,w[3*k+1]=i,w[3*k+2]=0,R[2*k]=.5,R[2*k+1]=.5,++k;for(var a=k,s=0;s<=T;++s){var o=s/T*x,l=Math.cos(o),c=Math.sin(o);C[3*k]=t*c,C[3*k+1]=S*i,C[3*k+2]=t*l,w[3*k]=0,w[3*k+1]=i,w[3*k+2]=0,R[2*k]=.5-.5*c*i,R[2*k+1]=.5+.5*l,++k}for(var u=0;u<T;++u){var h=n+u,d=a+u;A[++O]=(A[++O]=e?(A[O]=d+1,h):(A[O]=h,d+1),d),++O}}}var MN=Oe.create(0,0,0),IN=Oe.create(0,0,0),PN=Oe.create(0,0,0),DN=Oe.create(0,0,0),NN=Oe.create(0,0,0),zN=Oe.create(0,0,0),UN=Oe.create(0,0,0);var GN=Oe.create(0,0,0),VN=Oe.create(0,0,0);var HN,WN,XN,jN,qN,YN,KN,QN,ZN,JN,$N,ez=Object.freeze({box:yN,cone:function(){return BN(0,0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:{})},cylinder:BN,plane:function(e){var t,i=((t=mN(t=e)).width=t.width||10,t.length=t.length||10,t.widthSegments=t.widthSegments||10,t.lengthSegments=t.lengthSegments||10,t),n=i.width,r=i.length,a=i.widthSegments,s=i.lengthSegments,o=.5*n,l=.5*r,c=[],u=[],h=[],d=new Br(-o,0,-l),f=new Br(o,0,l),p=Math.sqrt(n*n+r*r);Oe.set(NN,-o,0,l),Oe.set(zN,o,0,l),Oe.set(UN,-o,0,-l);for(var _=0;_<=s;_++)for(var v=0;v<=a;v++){var m=v/a,y=_/s;if(Oe.lerp(MN,NN,zN,m),Oe.lerp(IN,NN,UN,y),Oe.subtract(PN,IN,NN),Oe.add(DN,MN,PN),c.push(DN.x,DN.y,DN.z),i.includeUV&&u.push(m,y),v<a&&_<s){var g=a+1,b=v+_*g,S=v+(_+1)*g,T=v+1+(_+1)*g,E=v+1+_*g;h.push(b,E,S),h.push(E,T,S)}}var x={positions:c,indices:h,minPos:d,maxPos:f,boundingRadius:p};if(i.includeNormal){var A=(s+1)*(a+1),C=new Array(3*A);x.normals=C;for(var w=0;w<A;++w)C[3*w+0]=0,C[3*w+1]=1,C[3*w+2]=0}return i.includeUV&&(x.uvs=u),x},quad:function(e){var t=mN(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],s=[],o=Oe.create(-e,-e,-e),l=Oe.create(e,e,e),c=e,u=0;u<=i;++u)for(var h=u*Math.PI/i,d=Math.sin(h),f=-Math.cos(h),p=0;p<=i;++p){var _=2*p*Math.PI/i-Math.PI/2,v=Math.sin(_)*d,m=f,y=Math.cos(_)*d,g=p/i,b=u/i;if(n.push(v*e,m*e,y*e),r.push(v,m,y),a.push(g,b),u<i&&p<i){var S=i+1,T=S*u+p,E=S*(u+1)+p,x=S*(u+1)+p+1,A=S*u+p+1;s.push(T,A,E),s.push(A,x,E)}}return{positions:n,indices:s,normals:r,uvs:a,minPos:o,maxPos:l,boundingRadius:c}},torus:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.4,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.1,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,s=[],o=[],l=[],c=[],u=Oe.create(-e-t,-t,-e-t),h=Oe.create(e+t,t,e+t),d=e+t,f=0;f<=n;f++)for(var p=0;p<=r;p++){var _=p/r,v=f/n,m=_*a,y=v*Math.PI*2,g=(e+t*Math.cos(y))*Math.sin(m),b=t*Math.sin(y),S=(e+t*Math.cos(y))*Math.cos(m),T=Math.sin(m)*Math.cos(y),E=Math.sin(y),x=Math.cos(m)*Math.cos(y);if(s.push(g,b,S),o.push(T,E,x),l.push(_,v),p<r&&f<n){var A=r+1,C=A*f+p,w=A*(f+1)+p,R=A*(f+1)+p+1,k=A*f+p+1;c.push(C,k,w),c.push(k,R,w)}}return{positions:s,normals:o,uvs:l,indices:c,minPos:u,maxPos:h,boundingRadius:d}},capsule:function(){var y=0<arguments.length&&void 0!==arguments[0]?arguments[0]:.5,g=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.5,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:2,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},m=e-y-g,b=t.sides||32,S=t.heightSegments||32,T=g/e,E=m/e,x=y/e,A=Math.floor(S*T),C=Math.floor(S*x),w=Math.floor(S*E),R=m+g-e/2,k=g-e/2,O=g-e/2,F=t.arc||2*Math.PI,L=[],B=[],M=[],I=[],i=Math.max(y,g),n=Oe.create(-i,-e/2,-i),r=Oe.create(i,e/2,i),a=e/2,P=0,D=[];return function(){for(var e=0;e<=A;++e)for(var t=e*Math.PI/A/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,d=e/S;if(L.push(l*g,c*g+O,u*g),B.push(l,c,u),M.push(h,d),e<A&&r<b){var f=b+1,p=f*e+r,_=f*(e+1)+r,v=f*(e+1)+r+1,m=f*e+r+1;I.push(p,m,_),I.push(m,v,_)}++P}}(),function(){for(var e=(y-g)/m,t=0;t<=w;t++){for(var i=[],n=t/w,r=n*(y-g)+g,a=0;a<=b;++a){var s=a/b,o=n*E+T,l=s*F-F/4,c=Math.sin(l),u=Math.cos(l);L.push(r*c),L.push(n*m+k),L.push(r*u),Oe.normalize(GN,Oe.set(VN,c,-e,u)),B.push(GN.x),B.push(GN.y),B.push(GN.z),M.push(s,o),i.push(P),++P}D.push(i)}for(var h=0;h<w;++h)for(var d=0;d<b;++d){var f=D[h][d],p=D[h+1][d],_=D[h+1][d+1],v=D[h][d+1];I.push(f),I.push(v),I.push(p),I.push(v),I.push(_),I.push(p)}}(),function(){for(var e=0;e<=C;++e)for(var t=e*Math.PI/C/2+Math.PI/2,i=Math.sin(t),n=-Math.cos(t),r=0;r<=b;++r){var a=2*r*Math.PI/b-Math.PI/2,s=Math.sin(a),o=Math.cos(a),l=s*i,c=n,u=o*i,h=r/b,d=e/S+(1-x);if(L.push(l*y,c*y+R,u*y),B.push(l,c,u),M.push(h,d),e<C&&r<b){var f=b+1,p=f*e+r+D[w][b]+1,_=f*(e+1)+r+D[w][b]+1,v=f*(e+1)+r+1+D[w][b]+1,m=f*e+r+1+D[w][b]+1;I.push(p,m,_),I.push(m,v,_)}}}(),{positions:L,normals:B,uvs:M,indices:I,minPos:n,maxPos:r,boundingRadius:a}},circle:function(e){var t,i=((t=mN(t=e)).segments=64,t).segments,n=new Array(3*(i+1));n[0]=0,n[1]=0,n[2]=0;var r=new Array(1+2*i);r[0]=0;for(var a=2*Math.PI/i,s=0;s<i;++s){var o=a*s,l=Math.cos(o),c=Math.sin(o),u=3*(s+1);n[u+0]=l,n[u+1]=c,n[u+2]=0;var h=2*s;r[1+h]=s+1,r[1+(h+1)]=s+2}return 0<i&&(r[r.length-1]=1),{positions:n,indices:r,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Kt.GFXPrimitiveMode.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]=e.positions[o]+i,e.positions[l]=e.positions[l]+n,e.positions[c]=e.positions[c]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),s=0;s<a;++s){var o=3*s,l=3*s+1,c=3*s+2;e.positions[o]*=i,e.positions[l]*=n,e.positions[c]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Kt.GFXPrimitiveMode.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var s=0;s<3;++s){var o=t[a+i[s][0]],l=t[a+i[s][1]],c=l<o?l<<16|o:o<<16|l;void 0===r[c]&&(r[c]=0,n.push(o,l))}return e.indices=n,e.primitiveMode=Kt.GFXPrimitiveMode.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var s=e[r+t[a][0]],o=e[r+t[a][1]],l=o<s?o<<16|s:s<<16|o;void 0===n[l]&&(n[l]=0,i.push(s,o))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Kt.GFXPrimitiveMode.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,s=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},o="",l=0;l<i.length;l+=3)o+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var c=0;c<n.length;c+=2)o+="vt ".concat(n[c]," ").concat(n[c+1],"\n");for(var u=0;u<r.length;u+=3)o+="vn ".concat(r[u]," ").concat(r[u+1]," ").concat(r[u+2],"\n");for(var h=0;h<a.length;h+=3)o+="f ".concat(s(h)," ").concat(s(h+1)," ").concat(s(h+2),"\n");return o},normals:function(e,t){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,s=6*r;n[s+0]=e[a+0],n[s+1]=e[a+1],n[s+2]=e[a+2],n[s+3]=e[a+0]+t[a+0]*i,n[s+4]=e[a+1]+t[a+1]*i,n[s+5]=e[a+2]+t[a+2]*i}return n},applyDefaultGeometryOptions:mN}),tz=Oe.create(),iz=new Dr;function nz(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData,h=a.iData;e.getWorldMatrix(iz);for(var d=0;d<o;d++){var f=r[d];Oe.set(tz,f.x,f.y,0),Oe.transformMat4(tz,tz,iz),u[s++]=tz.x,u[s++]=tz.y,u[s++]=tz.z,u[s++]=f.u,u[s++]=f.v,je.array(u,n,s),s+=4}for(var p=0,_=o/4;p<_;p++){var v=c+4*p;h[l++]=v,h[l++]=v+1,h[l++]=v+2,h[l++]=v+1,h[l++]=v+3,h[l++]=v+2}}var rz,az,sz,oz,lz,cz,uz,hz,dz=new Lr,fz=new Lr,pz=new Dr,_z=new Dr,vz=new Dr,mz=(HN=un("cc.UITransformComponent"),WN=mn(110),XN=vn("UI/UITransform"),jN=hn({displayOrder:0}),qN=hn({displayOrder:1}),HN(YN=WN(YN=XN(YN=pn(($N=JN=function(e){function h(){var e,t;y(this,h);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(h)).call.apply(e,[this].concat(n))),"_contentSize",QN,d(d(t))),v(t,"_anchorPoint",ZN,d(d(t))),t}return p(h,Nh),l(h,[{key:"__preload",value:function(){(this.node.uiTransfromComp=this).node.layer=cc.Layers.UI}},{key:"onDestroy",value:function(){this.node.uiTransfromComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;0,i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;0,i.width=e,i.height=t}this.node.emit(Kt.SystemEventType.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(Kt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=dz,a=fz,s=-1,o=this.node.getComponent(cc.UIRenderComponent);s=o?o.visibility:this._getVisibility();var l=cc.director.root.ui.getScreen(s);if(l){l.node.getWorldRT(pz);var c=pz.m12,u=pz.m13,h=cc.visibleRect.center;if(pz.m12=h.x-(pz.m00*c+pz.m04*u),pz.m13=h.y-(pz.m01*c+pz.m05*u),He.invert(pz,pz),we.transformMat4(r,e,pz),this.node.getWorldMatrix(vz),He.invert(pz,vz),we.transformMat4(a,r,pz),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,0<=a.x&&0<=a.y&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var d=t.mask,f=this.node,p=0;f&&p<d.index;++p,f=f.parent);if(f!==d.node)return!(t.mask=null);var _=f.getComponent(cc.MaskComponent);return!_||!_.enabledInHierarchy||_.isHit(r)}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(vz),He.invert(pz,vz),t||(t=new Br),Oe.transformMat4(t,e,pz)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(vz),t||(t=new Br),Oe.transformMat4(t,e,vz)}},{key:"getBoundingBox",value:function(){He.fromRTS(_z,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Ur(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(i,_z)}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(vz),this.getBoundingBoxTo(vz)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){He.fromRTS(_z,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,i=this._contentSize.height,n=new Ur(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i);if(He.multiply(vz,e,_z),n.transformMat4(n,vz),!this.node.children)return n;var r=this.node.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;if(l&&l.active){var c=l.getComponent(h);if(c){var u=c.getBoundingBoxTo(e);u&&n.union(n,u)}}}return n}},{key:"getComputeAABB",value:function(e){var t=this.getBoundingBoxToWorld(),i=t.center.x,n=t.center.y,r=this.node.worldPosition.z,a=t.width/2,s=t.height/2;if(null==e)return new G_(i,n,r,a,s,.01);G_.set(e,i,n,r,a,s,.01)}},{key:"_getVisibility",value:function(){for(var e=-1,t=this.node;t;){if(t){var i=t.getComponent("cc.CanvasComponent");if(i){e=i.visibility;break}}t=t.parent}return e}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Kt.SystemEventType.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Kt.SystemEventType.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Kt.SystemEventType.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Kt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Kt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Kt.SystemEventType.ANCHOR_CHANGED,this._anchorPoint))}}]),h}(),JN.EventType=Kt.SystemEventType,c((KN=$N).prototype,"contentSize",[jN,Xu],Object.getOwnPropertyDescriptor(KN.prototype,"contentSize"),KN.prototype),c(KN.prototype,"anchorPoint",[qN,Xu],Object.getOwnPropertyDescriptor(KN.prototype,"anchorPoint"),KN.prototype),QN=c(KN.prototype,"_contentSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zr(100,100)}}),ZN=c(KN.prototype,"_anchorPoint",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(.5,.5)}}),YN=KN))||YN)||YN)||YN)||YN);cc.UITransformComponent=mz;var yz,gz=new Br,bz=(rz=un("cc.CanvasComponent"),az=mn(100),sz=_n(mz),oz=vn("UI/Canvas"),lz=hn(),rz(cz=az(cz=sz(cz=oz(cz=pn(cz=yn((c((uz=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_priority",hz,d(d(e))),e._thisOnResized=void 0,e._camera=null,e._pos=new Br,e._thisOnResized=e.alignWithScreen.bind(d(d(e))),e}return p(t,Nh),l(t,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),l(t,[{key:"__preload",value:function(){var e=new cc.Node("UICamera_"+this.node.name);e.setPosition(0,0,999),this._camera=cc.director.root.ui.renderScene.createCamera({name:"ui_"+this.node.name,node:e,projection:cc.CameraComponent.ProjectionType.ORTHO,targetDisplay:0,priority:this._priority,isUI:!0,flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=ts.COLOR|ts.DEPTH|ts.STENCIL;var t=cc.director.root.device;this._camera.resize(t.width,t.height),cc.view.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),cc.director.root.ui.addScreen(this)}},{key:"onDestroy",value:function(){this._camera&&cc.director.root.ui.renderScene.destroyCamera(this._camera),cc.view.off("design-resolution-changed",this._thisOnResized),cc.director.root.ui.removeScreen(this)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=cc.visibleRect;e=i,t=cc.view.getDesignResolutionSize();var n=0,r=0;if(cc.view.getResolutionPolicy()===cc.ResolutionPolicy.NO_BORDER&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),Oe.set(gz,.5*i.width+n,.5*i.height+r,0),this._pos.equals(gz)||this.node.setPosition(gz),this.node.width!==e.width&&(this.node.width=e.width),this.node.height!==e.height&&(this.node.height=e.height),this.node.getWorldPosition(gz),this._camera){var a=cc.view.getVisibleSize();this._camera.resize(a.width,a.height),this._camera.orthoHeight=this._camera.height/2,this._camera.node.setPosition(gz.x,gz.y,999),this._camera.update()}}}]),t}()).prototype,"priority",[lz],Object.getOwnPropertyDescriptor(uz.prototype,"priority"),uz.prototype),hz=c(uz.prototype,"_priority",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cz=uz))||cz)||cz)||cz)||cz)||cz)||cz);cc.CanvasComponent=bz;var Sz,Tz,Ez,xz=new Br,Az=un("cc.DebugCanvasComponent")(yz=mn(100)(yz=_n(mz)(yz=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this)))._thisOnResized=e.alignWithScreen.bind(d(d(e))),e}return p(t,bz),l(t,[{key:"__preload",value:function(){var e=new cc.Node("UICamera_Debug");e.setPosition(0,0,1e3),this._camera=cc.director.root.ui.renderScene.createCamera({name:"ui_Debug",node:e,projection:cc.CameraComponent.ProjectionType.ORTHO,targetDisplay:0,priority:this._priority,isUI:!0,flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=ts.COLOR|ts.DEPTH|ts.STENCIL;var t=cc.director.root.device;this._camera.resize(t.width,t.height),cc.view.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),cc.director.root&&cc.director.root.ui&&(cc.director.root.ui.debugScreen=this)}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this._camera&&this._getRenderScene().destroyCamera(this._camera),cc.view.off("design-resolution-changed",this._thisOnResized),cc.director.root&&cc.director.root.ui&&(cc.director.root.ui.debugScreen=null)}},{key:"alignWithScreen",value:function(){var e=cc.visibleRect,t=e,i=cc.view.getDesignResolutionSize(),n=0,r=0;if(cc.view.getResolutionPolicy()===cc.ResolutionPolicy.NO_BORDER&&(n=.5*(i.width-e.width),r=.5*(i.height-e.height)),this.node.setPosition(.5*e.width+n,.5*e.height+r,1),this.node.width!==t.width&&(this.node.width=t.width),this.node.height!==t.height&&(this.node.height=t.height),this.node.getWorldPosition(xz),this._camera){var a=cc.view.getVisibleSize();this._camera.resize(a.width,a.height),this._camera.orthoHeight=this._camera.height/2,this._camera.node.setPosition(xz.x,xz.y,1e3),this._camera.update()}}},{key:"applySettings",value:function(){}}]),t}())||yz)||yz)||yz;cc.DebugCanvasComponent=Az;var Cz,wz,Rz,kz,Oz,Fz,Lz,Bz,Mz,Iz,Pz,Dz,Nz,zz,Uz,Gz,Vz,Hz=un("cc.UIComponent")(Sz=mn(110)(Sz=yn(Sz=pn((c((Tz=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_priority",Ez,d(d(t))),t._visibility=-1,t._lastParent=null,t}return p(a,Nh),l(a,[{key:"onEnable",value:function(){this._lastParent=this.node.parent,this._updateVisibility(),this._lastParent&&this.node.on(Kt.SystemEventType.CHILD_REMOVED,this._parentChanged,this)}},{key:"onDisable",value:function(){this._cancelEventFromParent()}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}},{key:"setVisibility",value:function(e){this._visibility=e}},{key:"_parentChanged",value:function(e){return e===this.node&&(this._updateVisibility(),this._cancelEventFromParent(),this._lastParent=this.node.parent,!0)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent(bz);if(t){this._visibility=t.visibility;break}}e=e.parent}}},{key:"_cancelEventFromParent",value:function(){this._lastParent&&(this._lastParent.off(Kt.SystemEventType.CHILD_REMOVED,this._parentChanged,this),this._lastParent=null),this._visibility=-1}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._priority=e)}},{key:"visibility",get:function(){return this._visibility}}]),a}()).prototype,"priority",[hn],Object.getOwnPropertyDescriptor(Tz.prototype,"priority"),Tz.prototype),Ez=c(Tz.prototype,"_priority",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sz=Tz))||Sz)||Sz)||Sz)||Sz,Wz=function e(){y(this,e),this.material=null,this.vertexCount=0,this.indiceCount=0},Xz=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).uvDirty=!0,t.vertDirty=!0,t._datas=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t}return p(a,Wz),l(a,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._datas.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indiceCount=0}},{key:"dataLength",get:function(){return this._datas.length},set:function(e){var t=this._datas;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)qz.free(t[n]);for(n=i;n<e;n++)t[n]=qz.alloc();t.length=e}}},{key:"datas",get:function(){return this._datas}}],[{key:"add",value:function(){var e=Yz.add();return{pooID:Yz.length-1,data:e}}},{key:"remove",value:function(e){Yz.data[e].clear(),Yz.removeAt(e)}}]),a}(),jz=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),t.iData=new Uint16Array(1536),t.vertexStart=0,t.indiceStart=0,t.byteStart=0,t.byteCount=0,t._formatByte=9*Float32Array.BYTES_PER_ELEMENT,t}return p(a,Wz),l(a,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indiceCount+t;if(65535<e+this.vertexCount)return!1;var r=this.vData.byteLength,a=this.iData.length,s=this.vData.length,o=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)r=4*(s*=2),a=o*=2;var l=new Float32Array(this.vData.buffer);this.vData=new Float32Array(s),this.vData.set(l,0);var c=new Uint16Array(this.iData.buffer);this.iData=new Uint16Array(o),this.iData.set(c,0)}return this.vertexCount+=e,this.indiceCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indiceCount=0,this.byteCount=0,this.vertexStart=0,this.indiceStart=0,this.byteStart=0}}]),a}(),qz=new kn(function(){return{x:0,y:0,z:0,u:0,v:0,color:Hr.WHITE}},128),Yz=new lv(function(){return new Xz},32);si(ma),(Vz=Gz||(Gz={}))[Vz.ADDCOLOR=0]="ADDCOLOR",Vz[Vz.ADDCOLORANDTEXTURE=1]="ADDCOLORANDTEXTURE";var Kz,Qz,Zz,Jz,$z,eU,tU,iU,nU,rU,aU,sU,oU,lU,cU,uU,hU,dU,fU,pU,_U,vU,mU,yU,gU,bU,SU,TU,EU=(Cz=un("cc.UIRenderComponent"),wz=mn(110),Rz=_n(mz),kz=hn({type:ma,displayOrder:0}),Oz=hn({type:ma,displayOrder:1}),Fz=hn({displayOrder:2}),Lz=hn({type:_m,displayOrder:3}),Cz(Bz=wz(Bz=Rz(Bz=pn((Uz=zz=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_srcBlendFactor",Iz,d(d(t))),v(t,"_dstBlendFactor",Pz,d(d(t))),v(t,"_color",Dz,d(d(t))),v(t,"_sharedMaterial",Nz,d(d(t))),t._assembler=null,t._postAssembler=null,t._renderDataPoolID=-1,t._renderData=null,t._renderDataDirty=!1,t._renderPermit=!0,t._material=null,t._instanceMaterialType=Gz.ADDCOLORANDTEXTURE,t._blendTemplate={blendState:{targets:[{blendSrc:ma.SRC_ALPHA,blendDst:ma.ONE_MINUS_SRC_ALPHA}]},depthStencilState:{},rasterizerState:{}},t}return p(a,Hz),l(a,[{key:"__preload",value:function(){this._instanceMaterial(),this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){_(S(a.prototype),"onEnable",this).call(this),this.node.on(Kt.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Kt.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this),this._renderDataDirty=!0}},{key:"onDisable",value:function(){_(S(a.prototype),"onDisable",this).call(this),this.node.off(Kt.SystemEventType.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Kt.SystemEventType.SIZE_CHANGED,this._nodeStateChange,this)}},{key:"onDestroy",value:function(){this.destroyRenderData(),this._material&&(this._material.destroy(),cc.director.root.ui._removeUIMaterial(this._material.hash)),this._updateMaterial(null),this._renderData=null}},{key:"markForUpdateRenderData",value:function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(e&&this._canRender()){var t=this._renderData;t&&(t.uvDirty=!0,t.vertDirty=!0),this._renderDataDirty=e}else e||(this._renderDataDirty=e)}},{key:"requestRenderData",value:function(){var e=Xz.add();return this._renderData=e.data,this._renderDataPoolID=e.pooID,this._renderData}},{key:"destroyRenderData",value:function(){-1!==this._renderDataPoolID&&(Xz.remove(this._renderDataPoolID),this._renderDataPoolID=-1,this._renderData=null)}},{key:"updateAssembler",value:function(e){return!!this._canRender()&&(this._checkAndUpdateRenderData(),!0)}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataDirty&&(this._assembler.updateRenderData(this),this._renderDataDirty=!1)}},{key:"_canRender",value:function(){return null!==this.material&&this._renderPermit}},{key:"_updateColor",value:function(){var e=this._material;e&&e.setProperty("color",this._color)}},{key:"_updateMaterial",value:function(e){this._material=e,this._updateBlendFunc()}},{key:"_updateBlendFunc",value:function(){if(this._material){var e=this._blendTemplate.blendState.targets[0];e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this._blendTemplate.depthStencilState=this._material.passes[0].depthStencilState,this._blendTemplate.rasterizerState=this._material.passes[0].rasterizerState,this._material.overridePipelineStates(this._blendTemplate,0))}}},{key:"_nodeStateChange",value:function(){this._renderData&&this.markForUpdateRenderData();var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n.getComponent(a);r&&r.markForUpdateRenderData()}}},{key:"_instanceMaterial",value:function(){var e=null;if(this._sharedMaterial)e=_m.getInstantiatedMaterial(this._sharedMaterial,new AT,!1);else switch(this._instanceMaterialType){case Gz.ADDCOLOR:e=_m.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new AT,!1);break;case Gz.ADDCOLORANDTEXTURE:e=_m.getInstantiatedMaterial(cc.builtinResMgr.get("ui-sprite-material"),new AT,!1)}this._updateMaterial(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"sharedMaterial",get:function(){return this._sharedMaterial},set:function(e){this._sharedMaterial!==e&&(this._sharedMaterial=e,this._instanceMaterial&&this._instanceMaterial())}},{key:"material",get:function(){return this._material||this._instanceMaterial&&this._instanceMaterial(),this._material}},{key:"renderData",get:function(){return this._renderData}}]),a}(),zz.BlendState=ma,zz.Assembler=null,zz.PostAssembler=null,c((Mz=Uz).prototype,"srcBlendFactor",[kz],Object.getOwnPropertyDescriptor(Mz.prototype,"srcBlendFactor"),Mz.prototype),c(Mz.prototype,"dstBlendFactor",[Oz],Object.getOwnPropertyDescriptor(Mz.prototype,"dstBlendFactor"),Mz.prototype),c(Mz.prototype,"color",[Fz,Xu],Object.getOwnPropertyDescriptor(Mz.prototype,"color"),Mz.prototype),c(Mz.prototype,"sharedMaterial",[Lz],Object.getOwnPropertyDescriptor(Mz.prototype,"sharedMaterial"),Mz.prototype),Iz=c(Mz.prototype,"_srcBlendFactor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ma.SRC_ALPHA}}),Pz=c(Mz.prototype,"_dstBlendFactor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ma.ONE_MINUS_SRC_ALPHA}}),Dz=c(Mz.prototype,"_color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.WHITE}}),Nz=c(Mz.prototype,"_sharedMaterial",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bz=Mz))||Bz)||Bz)||Bz)||Bz);cc.UIRenderComponent=EU,(yU=mU||(mU={}))[yU.SIMPLE=0]="SIMPLE",yU[yU.SLICED=1]="SLICED",yU[yU.FILLED=3]="FILLED",si(mU),(bU=gU||(gU={}))[bU.HORIZONTAL=0]="HORIZONTAL",bU[bU.VERTICAL=1]="VERTICAL",bU[bU.RADIAL=2]="RADIAL",si(gU),(TU=SU||(SU={}))[TU.CUSTOM=0]="CUSTOM",TU[TU.TRIMMED=1]="TRIMMED",TU[TU.RAW=2]="RAW",si(SU);var xU,AU,CU,wU,RU,kU,OU,FU,LU,BU,MU,IU,PU,DU,NU,zU,UU,GU,VU,HU,WU,XU,jU,qU,YU,KU,QU,ZU,JU,$U,eG,tG,iG,nG,rG=(Kz=un("cc.SpriteComponent"),Qz=mn(110),Zz=vn("UI/Render/Sprite"),Jz=hn({type:su,displayOrder:4}),$z=hn({type:iu,displayOrder:5}),eU=hn({type:mU,displayOrder:6}),tU=hn({type:gU}),iU=hn({displayOrder:8}),nU=hn({type:SU,displayOrder:7}),Kz(rU=Qz(rU=Zz((vU=_U=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_spriteFrame",sU,d(d(t))),v(t,"_type",oU,d(d(t))),v(t,"_fillType",lU,d(d(t))),v(t,"_sizeMode",cU,d(d(t))),v(t,"_fillCenter",uU,d(d(t))),v(t,"_fillStart",hU,d(d(t))),v(t,"_fillRange",dU,d(d(t))),v(t,"_isTrimmedMode",fU,d(d(t))),v(t,"_atlas",pU,d(d(t))),t}return p(a,EU),l(a,[{key:"__preload",value:function(){_(S(a.prototype),"__preload",this)&&_(S(a.prototype),"__preload",this).call(this)}},{key:"onEnable",value:function(){_(S(a.prototype),"onEnable",this).call(this),this._activateMaterial()}},{key:"updateAssembler",value:function(e){return!(!_(S(a.prototype),"updateAssembler",this).call(this,e)||!this._spriteFrame)&&(e.commitComp(this,this._spriteFrame.getGFXTextureView(),this._assembler),!0)}},{key:"onDestroy",value:function(){_(S(a.prototype),"onDestroy",this).call(this),this.destroyRenderData()}},{key:"_canRender",value:function(){if(!_(S(a.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=a.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material,this.markForUpdateRenderData())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(SU.RAW===this._sizeMode){var e=this._spriteFrame.getOriginalSize();this.node.setContentSize(e)}else if(SU.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this._material;cc.game.renderType!==cc.game.RENDER_TYPE_CANVAS?(e&&t&&(t.setProperty("mainTexture",e),this.markForUpdateRenderData()),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData(!0)}},{key:"_applyAtlas",value:function(e){}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;t&&(e&&t===e||this._activateMaterial())}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e,this.spriteFrame=null)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===gU.RADIAL||this._fillType===gU.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===mU.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=qt(e,-1,1),this._type===mU.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=qt(e,0,1),this._type===mU.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===mU.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e)!==SU.CUSTOM&&this._applySpriteSize()}}]),a}(),_U.FillType=gU,_U.Type=mU,_U.SizeMode=SU,c((aU=vU).prototype,"spriteAtlas",[Jz],Object.getOwnPropertyDescriptor(aU.prototype,"spriteAtlas"),aU.prototype),c(aU.prototype,"spriteFrame",[$z],Object.getOwnPropertyDescriptor(aU.prototype,"spriteFrame"),aU.prototype),c(aU.prototype,"type",[eU],Object.getOwnPropertyDescriptor(aU.prototype,"type"),aU.prototype),c(aU.prototype,"fillType",[tU],Object.getOwnPropertyDescriptor(aU.prototype,"fillType"),aU.prototype),c(aU.prototype,"fillCenter",[hn],Object.getOwnPropertyDescriptor(aU.prototype,"fillCenter"),aU.prototype),c(aU.prototype,"fillStart",[hn],Object.getOwnPropertyDescriptor(aU.prototype,"fillStart"),aU.prototype),c(aU.prototype,"fillRange",[hn],Object.getOwnPropertyDescriptor(aU.prototype,"fillRange"),aU.prototype),c(aU.prototype,"trim",[iU],Object.getOwnPropertyDescriptor(aU.prototype,"trim"),aU.prototype),c(aU.prototype,"sizeMode",[nU],Object.getOwnPropertyDescriptor(aU.prototype,"sizeMode"),aU.prototype),sU=c(aU.prototype,"_spriteFrame",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oU=c(aU.prototype,"_type",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mU.SIMPLE}}),lU=c(aU.prototype,"_fillType",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gU.HORIZONTAL}}),cU=c(aU.prototype,"_sizeMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SU.TRIMMED}}),uU=c(aU.prototype,"_fillCenter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Lr(0,0)}}),hU=c(aU.prototype,"_fillStart",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dU=c(aU.prototype,"_fillRange",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fU=c(aU.prototype,"_isTrimmedMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pU=c(aU.prototype,"_atlas",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rU=aU))||rU)||rU)||rU);cc.SpriteComponent=rG,(tG=eG||(eG={}))[tG.NONE=0]="NONE",tG[tG.COLOR=1]="COLOR",tG[tG.SPRITE=2]="SPRITE",tG[tG.SCALE=3]="SCALE",si(eG),(nG=iG||(iG={})).NORMAL="normal",nG.HOVER="hover",nG.PRESSED="pressed",nG.DISABLED="disabled";var aG=(xU=un("cc.ButtonComponent"),AU=mn(110),CU=vn("UI/Button"),wU=hn({displayOrder:1}),RU=hn({type:eG,displayOrder:2}),kU=hn({min:0,max:10}),OU=hn({type:iu}),FU=hn({type:iu}),LU=hn({type:iu}),BU=hn({type:iu}),MU=hn({type:bd,displayOrder:0}),IU=hn({type:uC,displayOrder:3}),xU(PU=AU(PU=CU(PU=pn(($U=JU=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"clickEvents",NU,d(d(t))),v(t,"_interactable",zU,d(d(t))),v(t,"_transition",UU,d(d(t))),v(t,"_normalColor",GU,d(d(t))),v(t,"_hoverColor",VU,d(d(t))),v(t,"_pressColor",HU,d(d(t))),v(t,"_disabledColor",WU,d(d(t))),v(t,"_normalSprite",XU,d(d(t))),v(t,"_hoverSprite",jU,d(d(t))),v(t,"_pressedSprite",qU,d(d(t))),v(t,"_disabledSprite",YU,d(d(t))),v(t,"_duration",KU,d(d(t))),v(t,"_zoomScale",QU,d(d(t))),v(t,"_target",ZU,d(d(t))),t._pressed=!1,t._hovered=!1,t._fromColor=new Hr,t._toColor=new Hr,t._time=0,t._transitionFinished=!0,t._fromScale=new Br,t._toScale=new Br,t._originalScale=new Br,t._sprite=null,t._targetScale=new Br,t}return p(a,Nh),l(a,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(rG);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._updateState()}},{key:"onEnable",value:function(){this._registerEvent()}},{key:"onDisable",value:function(){this._resetState(),this.node.off(Kt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(Kt.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Kt.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Kt.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this._target?this._target:this.node;if(!this._transitionFinished&&(this._transition===eG.COLOR||this._transition===eG.SCALE)){this._time+=e;var i=1;0<this._duration&&(i=this._time/this._duration),1<=i&&(i=1,this._transitionFinished=!0);var n=t.getComponent(EU);n&&(this._transition===eG.COLOR?Hr.lerp(this._fromColor,this._toColor,i,n.color):this.transition===eG.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=Qt(this._fromScale.x,this._toScale.x,i),this._targetScale.y=Qt(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)))}}},{key:"_resizeNodeToTargetNode",value:function(){0}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this._target;if(e){var t=e.getComponent(EU);if(t){var i=this._transition;i===eG.COLOR&&this._interactable?t.color=this._normalColor:i===eG.SCALE&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerEvent",value:function(){this.node.on(Kt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(Kt.SystemEventType.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Kt.SystemEventType.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Kt.SystemEventType.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(rG)),t}},{key:"_applyTarget",value:function(){this._sprite=this._getTargetSprite(this._target),this._target&&Oe.copy(this._originalScale,this._target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node.uiTransfromComp.isHit(t.getUILocation());if(this._transition===eG.SCALE&&this._target)n?(Oe.copy(this._fromScale,this._originalScale),Oe.scale(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this._target&&this._target.setScale(this._originalScale));else i=n?iG.PRESSED:iG.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(uC.emitEvents(this.clickEvents,e),this.node.emit("click",this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==eG.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=iG.NORMAL;return this._interactable?this._pressed?e=iG.PRESSED:this._hovered&&(e=iG.HOVER):e=iG.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t=this[e+"Color"],i=this._target;if(i){var n=i.getComponent(EU);n&&(e===iG.DISABLED?n.color=t:(this._fromColor=n.color.clone(),this._toColor=t,this._time=0,this._transitionFinished=!1))}}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===iG.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){Oe.copy(this._fromScale,this._originalScale),Oe.scale(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1}},{key:"_zoomBack",value:function(){this._target&&(Oe.copy(this._fromScale,this._target.getScale()),Oe.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===eG.COLOR?this._updateColorTransition(e):t===eG.SPRITE?this._updateSpriteTransition(e):t===eG.SCALE&&this._updateScaleTransition(e)}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition=e)}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressColor},set:function(e){this._pressColor!==e&&this._pressColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(rG);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._applyTarget())}}]),a}(),JU.Transition=eG,c((DU=$U).prototype,"interactable",[wU],Object.getOwnPropertyDescriptor(DU.prototype,"interactable"),DU.prototype),c(DU.prototype,"transition",[RU],Object.getOwnPropertyDescriptor(DU.prototype,"transition"),DU.prototype),c(DU.prototype,"normalColor",[hn,Xu],Object.getOwnPropertyDescriptor(DU.prototype,"normalColor"),DU.prototype),c(DU.prototype,"pressedColor",[hn,Xu],Object.getOwnPropertyDescriptor(DU.prototype,"pressedColor"),DU.prototype),c(DU.prototype,"hoverColor",[hn,Xu],Object.getOwnPropertyDescriptor(DU.prototype,"hoverColor"),DU.prototype),c(DU.prototype,"disabledColor",[hn,Xu],Object.getOwnPropertyDescriptor(DU.prototype,"disabledColor"),DU.prototype),c(DU.prototype,"duration",[kU],Object.getOwnPropertyDescriptor(DU.prototype,"duration"),DU.prototype),c(DU.prototype,"zoomScale",[hn],Object.getOwnPropertyDescriptor(DU.prototype,"zoomScale"),DU.prototype),c(DU.prototype,"normalSprite",[OU],Object.getOwnPropertyDescriptor(DU.prototype,"normalSprite"),DU.prototype),c(DU.prototype,"pressedSprite",[FU],Object.getOwnPropertyDescriptor(DU.prototype,"pressedSprite"),DU.prototype),c(DU.prototype,"hoverSprite",[LU],Object.getOwnPropertyDescriptor(DU.prototype,"hoverSprite"),DU.prototype),c(DU.prototype,"disabledSprite",[BU],Object.getOwnPropertyDescriptor(DU.prototype,"disabledSprite"),DU.prototype),c(DU.prototype,"target",[MU],Object.getOwnPropertyDescriptor(DU.prototype,"target"),DU.prototype),NU=c(DU.prototype,"clickEvents",[IU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zU=c(DU.prototype,"_interactable",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UU=c(DU.prototype,"_transition",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eG.NONE}}),GU=c(DU.prototype,"_normalColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(214,214,214,255)}}),VU=c(DU.prototype,"_hoverColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(211,211,211,255)}}),HU=c(DU.prototype,"_pressColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.WHITE}}),WU=c(DU.prototype,"_disabledColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(124,124,124,255)}}),XU=c(DU.prototype,"_normalSprite",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jU=c(DU.prototype,"_hoverSprite",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qU=c(DU.prototype,"_pressedSprite",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YU=c(DU.prototype,"_disabledSprite",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KU=c(DU.prototype,"_duration",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),QU=c(DU.prototype,"_zoomScale",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),ZU=c(DU.prototype,"_target",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PU=DU))||PU)||PU)||PU)||PU);cc.ButtonComponent=aG;var sG,oG,lG,cG,uG,hG,dG,fG,pG,_G,vG,mG,yG,gG,bG,SG,TG,EG,xG,AG,CG,wG,RG,kG,OG,FG,LG,BG,MG,IG,PG,DG,NG,zG,UG,GG,VG,HG,WG,XG,jG,qG,YG,KG=function(){function e(){y(this,e),this.pool=[]}return l(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){32<=this.pool.length||this.pool.push(e)}}]),e}();(WG=Kt.HorizontalTextAlignment||(Kt.HorizontalTextAlignment={}))[WG.LEFT=0]="LEFT",WG[WG.CENTER=1]="CENTER",WG[WG.RIGHT=2]="RIGHT",si(Kt.HorizontalTextAlignment),(XG=Kt.VerticalTextAlignment||(Kt.VerticalTextAlignment={}))[XG.TOP=0]="TOP",XG[XG.CENTER=1]="CENTER",XG[XG.BOTTOM=2]="BOTTOM",si(Kt.VerticalTextAlignment),(jG=Kt.Overflow||(Kt.Overflow={}))[jG.NONE=0]="NONE",jG[jG.CLAMP=1]="CLAMP",jG[jG.SHRINK=2]="SHRINK",jG[jG.RESIZE_HEIGHT=3]="RESIZE_HEIGHT",si(Kt.Overflow),(YG=qG||(qG={}))[YG.NONE=0]="NONE",YG[YG.BITMAP=1]="BITMAP",YG[YG.CHAR=2]="CHAR",si(qG);var QG,ZG,JG,$G,eV,tV,iV,nV=(sG=un("cc.LabelComponent"),oG=mn(110),lG=vn("UI/Render/Label"),cG=hn({displayOrder:4}),uG=hn({type:Kt.HorizontalTextAlignment,displayOrder:5}),hG=hn({type:Kt.VerticalTextAlignment,displayOrder:6}),dG=hn({readonly:!0,displayName:"Actual Font Size",visible:!1}),fG=hn({displayOrder:7}),pG=hn({displayOrder:8}),_G=hn({displayOrder:8}),vG=hn({type:Kt.Overflow,displayOrder:9}),mG=hn({displayOrder:10}),yG=hn({type:Lu,displayOrder:11}),gG=hn({displayOrder:12}),bG=hn({type:qG,displayOrder:13}),SG=hn({displayOrder:15}),TG=hn({displayOrder:16}),EG=hn({displayOrder:17}),sG(xG=oG(xG=lG((HG=VG=function(e){function i(){var e;return y(this,i),v(e=T(this,S(i).call(this)),"_useOriginalSize",CG,d(d(e))),v(e,"_string",wG,d(d(e))),v(e,"_horizontalAlign",RG,d(d(e))),v(e,"_verticalAlign",kG,d(d(e))),v(e,"_actualFontSize",OG,d(d(e))),v(e,"_fontSize",FG,d(d(e))),v(e,"_fontFamily",LG,d(d(e))),v(e,"_lineHeight",BG,d(d(e))),v(e,"_overflow",MG,d(d(e))),v(e,"_enableWrapText",IG,d(d(e))),v(e,"_font",PG,d(d(e))),v(e,"_isSystemFontUsed",DG,d(d(e))),e._spacingX=0,v(e,"_isItalic",NG,d(d(e))),v(e,"_isBold",zG,d(d(e))),v(e,"_isUnderline",UG,d(d(e))),v(e,"_cacheMode",GG,d(d(e))),e._N$file=null,e._texture=null,e._ttfTexture=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfTexture=null,e}return p(i,EU),l(i,[{key:"string",get:function(){return this._string},set:function(e){e=e.toString(),this._string!==e&&(this._string=e,this._checkStringEmpty(),this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,"string"==typeof(this._font=e)&&cc.warnID(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._flushAssembler(),this._applyFontTexture(!0),this.updateRenderData())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData(),this._checkStringEmpty()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===qG.CHAR&&(this._ttfTexture=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof Hu?this._font.fontSize:-1}}]),l(i,[{key:"onEnable",value:function(){_(S(i.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._checkStringEmpty(),this.updateRenderData(!0)}},{key:"onDisable",value:function(){_(S(i.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfTexture&&(this._ttfTexture.destroy(),this._ttfTexture=null),_(S(i.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(!0),e&&(this._flushAssembler(),this._applyFontTexture(e))}},{key:"updateAssembler",value:function(e){return!(!_(S(i.prototype),"updateAssembler",this).call(this,e)||!this._texture)&&(e.commitComp(this,this._texture.getGFXTextureView(),this._assembler),!0)}},{key:"_updateColor",value:function(){this._font instanceof Hu?_(S(i.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!_(S(i.prototype),"_canRender",this).call(this))return!1;var e=this._font;if(e&&e instanceof Hu){var t=e.spriteFrame;if(!t||!t.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this._material)}},{key:"_checkStringEmpty",value:function(){this._renderPermit=!!this.string}},{key:"_flushMaterial",value:function(){var e=this._material;e&&e.setProperty("mainTexture",this._texture),this._updateMaterial(e)}},{key:"_applyFontTexture",value:function(e){var t=this._font;if(t instanceof Hu){var i=t.spriteFrame,n=this;i&&(n._texture=i,n._flushMaterial())}else{if(this.cacheMode===qG.CHAR&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfTexture){this._ttfTexture=new iu,this._assemblerData=this._assembler.getAssemblerData();var r=new Ls(this._assemblerData.canvas);this._ttfTexture.image=r}this.cacheMode!==qG.CHAR&&(this._texture=this._ttfTexture),this._flushMaterial()}e&&this._assembler&&this._assembler.updateRenderData&&this._assembler.updateRenderData(this)}}]),i}(),VG.HorizontalAlign=Kt.HorizontalTextAlignment,VG.VerticalAlign=Kt.VerticalTextAlignment,VG.Overflow=Kt.Overflow,VG.CacheMode=qG,VG.CanvasPool=new KG,c((AG=HG).prototype,"string",[cG],Object.getOwnPropertyDescriptor(AG.prototype,"string"),AG.prototype),c(AG.prototype,"horizontalAlign",[uG],Object.getOwnPropertyDescriptor(AG.prototype,"horizontalAlign"),AG.prototype),c(AG.prototype,"verticalAlign",[hG],Object.getOwnPropertyDescriptor(AG.prototype,"verticalAlign"),AG.prototype),c(AG.prototype,"actualFontSize",[dG],Object.getOwnPropertyDescriptor(AG.prototype,"actualFontSize"),AG.prototype),c(AG.prototype,"fontSize",[fG],Object.getOwnPropertyDescriptor(AG.prototype,"fontSize"),AG.prototype),c(AG.prototype,"fontFamily",[pG],Object.getOwnPropertyDescriptor(AG.prototype,"fontFamily"),AG.prototype),c(AG.prototype,"lineHeight",[_G],Object.getOwnPropertyDescriptor(AG.prototype,"lineHeight"),AG.prototype),c(AG.prototype,"overflow",[vG],Object.getOwnPropertyDescriptor(AG.prototype,"overflow"),AG.prototype),c(AG.prototype,"enableWrapText",[mG],Object.getOwnPropertyDescriptor(AG.prototype,"enableWrapText"),AG.prototype),c(AG.prototype,"font",[yG],Object.getOwnPropertyDescriptor(AG.prototype,"font"),AG.prototype),c(AG.prototype,"useSystemFont",[gG],Object.getOwnPropertyDescriptor(AG.prototype,"useSystemFont"),AG.prototype),c(AG.prototype,"cacheMode",[bG],Object.getOwnPropertyDescriptor(AG.prototype,"cacheMode"),AG.prototype),c(AG.prototype,"isBold",[SG],Object.getOwnPropertyDescriptor(AG.prototype,"isBold"),AG.prototype),c(AG.prototype,"isItalic",[TG],Object.getOwnPropertyDescriptor(AG.prototype,"isItalic"),AG.prototype),c(AG.prototype,"isUnderline",[EG],Object.getOwnPropertyDescriptor(AG.prototype,"isUnderline"),AG.prototype),CG=c(AG.prototype,"_useOriginalSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wG=c(AG.prototype,"_string",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),RG=c(AG.prototype,"_horizontalAlign",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kt.HorizontalTextAlignment.LEFT}}),kG=c(AG.prototype,"_verticalAlign",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kt.VerticalTextAlignment.TOP}}),OG=c(AG.prototype,"_actualFontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FG=c(AG.prototype,"_fontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),LG=c(AG.prototype,"_fontFamily",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),BG=c(AG.prototype,"_lineHeight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),MG=c(AG.prototype,"_overflow",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kt.Overflow.NONE}}),IG=c(AG.prototype,"_enableWrapText",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),PG=c(AG.prototype,"_font",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DG=c(AG.prototype,"_isSystemFontUsed",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NG=c(AG.prototype,"_isItalic",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zG=c(AG.prototype,"_isBold",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UG=c(AG.prototype,"_isUnderline",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GG=c(AG.prototype,"_cacheMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qG.NONE}}),xG=AG))||xG)||xG)||xG);cc.LabelComponent=nV,(ZG=QG||(QG={}))[ZG.DEFAULT=0]="DEFAULT",ZG[ZG.DONE=1]="DONE",ZG[ZG.SEND=2]="SEND",ZG[ZG.SEARCH=3]="SEARCH",ZG[ZG.GO=4]="GO",ZG[ZG.NEXT=5]="NEXT",ai(QG),($G=JG||(JG={}))[$G.ANY=0]="ANY",$G[$G.EMAIL_ADDR=1]="EMAIL_ADDR",$G[$G.NUMERIC=2]="NUMERIC",$G[$G.PHONE_NUMBER=3]="PHONE_NUMBER",$G[$G.URL=4]="URL",$G[$G.DECIMAL=5]="DECIMAL",$G[$G.SINGLE_LINE=6]="SINGLE_LINE",ai(JG),(tV=eV||(eV={}))[tV.PASSWORD=0]="PASSWORD",tV[tV.SENSITIVE=1]="SENSITIVE",tV[tV.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",tV[tV.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",tV[tV.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",tV[tV.DEFAULT=5]="DEFAULT",ai(eV);var rV=new Dr,aV=new Dr,sV=new Br,oV=null,lV={zoomInvalid:!1};cc.sys.OS_ANDROID!==cc.sys.os||cc.sys.browserType!==cc.sys.BROWSER_TYPE_SOUGOU&&cc.sys.browserType!==cc.sys.BROWSER_TYPE_360||(lV.zoomInvalid=!0);var cV,uV,hV,dV,fV,pV,_V,vV,mV,yV,gV,bV,SV,TV,EV,xV,AV,CV,wV,RV,kV,OV,FV,LV,BV,MV,IV,PV,DV,NV,zV,UV,GV,VV,HV,WV=un(iV=function(){function e(){y(this,e),this._delegate=null,this._inputMode=-1,this._inputFlag=-1,this._returnType=QG.DEFAULT,this._maxLength=50,this._text="",this._placeholderText="",this._alwaysOnTop=!1,this._size=cc.size(),this._node=null,this._editing=!1,this.__eventListeners={},this.__fullscreen=!1,this.__autoResize=!1,this.__rotateScreen=!1,this.__orientationChanged=void 0,this._edTxt=null,this._textColor=Hr.WHITE,this._edFontSize=14}return l(e,[{key:"onEnable",value:function(){this._edTxt&&(this._alwaysOnTop?this._edTxt.style.display="":this._edTxt.style.display="none")}},{key:"onDisable",value:function(){this._edTxt&&(this._edTxt.style.display="none")}},{key:"setTabIndex",value:function(e){this._edTxt&&(this._edTxt.tabIndex=e)}},{key:"setFocus",value:function(){this._beginEditing()}},{key:"isFocused",value:function(){return this._edTxt?document.activeElement===this._edTxt:(cc.warnID(4700),!1)}},{key:"stayOnTop",value:function(e){this._alwaysOnTop!==e&&this._edTxt&&(this._alwaysOnTop=e,this._edTxt.style.display=e?"":"none")}},{key:"setMaxLength",value:function(e){isNaN(e)||(e<0&&(e=65535),this._maxLength=e,this._edTxt&&(this._edTxt.maxLength=e))}},{key:"setString",value:function(e){this._text=e,this._edTxt&&(this._edTxt.value=e)}},{key:"getString",value:function(){return this._text}},{key:"setPlaceholderText",value:function(e){this._placeholderText=e}},{key:"getPlaceholderText",value:function(){return this._placeholderText}},{key:"setDelegate",value:function(e){this._delegate=e}},{key:"setInputMode",value:function(e){this._inputMode!==e&&(this._inputMode=e,this.createInput(),this._updateDomInputType(),this._updateSize(this._size.width,this._size.height))}},{key:"setInputFlag",value:function(e){if(this._inputFlag!==e){this._inputFlag=e,this._updateDomInputType();var t="none";e===eV.INITIAL_CAPS_ALL_CHARACTERS?t="uppercase":e===eV.INITIAL_CAPS_WORD&&(t="capitalize"),this._edTxt&&(this._edTxt.style.textTransform=t,this._edTxt.value=this._text)}}},{key:"setReturnType",value:function(e){this._returnType=e,this._updateDomInputType()}},{key:"setFontSize",value:function(e){this._edFontSize=e||this._edFontSize,this._edTxt&&(this._edTxt.style.fontSize=this._edFontSize+"px")}},{key:"setFontColor",value:function(e){this._textColor=e,this._edTxt&&(this._edTxt.style.color=e.toCSS("rgba"))}},{key:"setSize",value:function(e,t){this._size.width=e,this._size.height=t,this._updateSize(e,t)}},{key:"setNode",value:function(e){this._node=e}},{key:"update",value:function(){this._updateMatrix()}},{key:"clear",value:function(){this._node=null,this.setDelegate(null),this.removeDom()}},{key:"_onTouchBegan",value:function(e){}},{key:"_onTouchEnded",value:function(){this._beginEditing()}},{key:"_beginEditing",value:function(){if(cc.sys.isMobile&&!this._editing&&this._beginEditingOnMobile(),this._edTxt){var e=function(){t._edTxt.focus()};this._edTxt.style.display="";var t=this;cc.sys.browserType===cc.sys.BROWSER_TYPE_UC?setTimeout(e,400):cc.sys.browserType===cc.sys.BROWSER_TYPE_FIREFOX?setTimeout(e,0):e()}this._editing=!0}},{key:"_endEditing",value:function(){var e=this,t=function(){!e._alwaysOnTop&&e._edTxt&&(e._edTxt.style.display="none"),e._delegate&&e._delegate.editBoxEditingDidEnded&&e._delegate.editBoxEditingDidEnded()};this._editing&&(cc.sys.isMobile?setTimeout(function(){e._endEditingOnMobile(),t()},400):t()),this._editing=!1}},{key:"_updateDomInputType",value:function(){var e=this._inputMode,t=this._edTxt;if(t)if(this._inputFlag!==eV.PASSWORD){var i=t.type;e===JG.EMAIL_ADDR?i="email":e===JG.NUMERIC||e===JG.DECIMAL?i="number":e===JG.PHONE_NUMBER?(i="number",t.pattern="[0-9]*"):e===JG.URL?i="url":(i="text",this._returnType===QG.SEARCH&&(i="search")),t.type=i}else t.type="password"}},{key:"_updateSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._node,t=cc.view._scaleX,i=cc.view._scaleY,n=cc.view._viewportRect,r=cc.view._devicePixelRatio;e.getWorldMatrix(rV);var a=e.uiTransfromComp;a&&Oe.set(sV,-a.anchorX*a.width,-a.anchorY*a.height,sV.z),He.translate(rV,rV,sV);var s=e.getComponent(EU);if(!s)return!1;var o=cc.director.root.ui.getScreen(s.visibility);if(o){o.node.getWorldRT(aV);var l=aV.m12,c=aV.m13,u=cc.visibleRect.center;aV.m12=u.x-(aV.m00*l+aV.m04*c),aV.m13=u.y-(aV.m01*l+aV.m05*c),He.multiply(aV,aV,rV),t/=r,i/=r;var h=cc.game.container,d=aV.m00*t,f=rV.m01,p=rV.m04,_=aV.m05*i,v=h&&h.style.paddingLeft&&parseInt(h.style.paddingLeft);v+=n.x/r;var m=h&&h.style.paddingBottom&&parseInt(h.style.paddingBottom);m+=n.y/r;var y=aV.m12*t+v,g=aV.m13*i+m;lV.zoomInvalid&&(this._updateSize(this._size.width*d,this._size.height*_),_=d=1);var b="matrix("+d+","+-f+","+-p+","+_+","+y+","+-g+")";this._edTxt.style.transform=b,this._edTxt.style["-webkit-transform"]=b,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_adjustEditBoxPosition",value:function(){this._node.getWorldMatrix(rV);var t=rV.m13,i=cc.visibleRect.height,e=cc.visibleRect.width,n=.5;i<e&&(n=.7),setTimeout(function(){if(window.scrollY<40&&t<i*n){var e=i*n-t-window.scrollY;e<35&&(e=35),320<e&&(e=320),window.scrollTo(0,e)}},400)}},{key:"createInput",value:function(){this._inputMode===JG.ANY?this._createDomTextArea():this._createDomInput()}},{key:"_beginEditingOnMobile",value:function(){var e=this;this.__orientationChanged=function(){e._adjustEditBoxPosition()},window.addEventListener("orientationchange",this.__orientationChanged),cc.view.isAutoFullScreenEnabled()?(this.__fullscreen=!0,cc.view.enableAutoFullScreen(!1),cc.screen.exitFullScreen()):this.__fullscreen=!1,this.__autoResize=cc.view._resizeWithBrowserSize,cc.view.resizeWithBrowserSize(!1),oV=this}},{key:"_endEditingOnMobile",value:function(){if(this.__rotateScreen){cc.game.container.style["-webkit-transform"]="rotate(90deg)",cc.game.container.style.transform="rotate(90deg)";var e=cc.view,t=e._originalDesignResolutionSize.width,i=e._originalDesignResolutionSize.height;0<t&&e.setDesignResolutionSize(t,i,e._resolutionPolicy),this.__rotateScreen=!1}this.__orientationChanged&&window.removeEventListener("orientationchange",this.__orientationChanged),this.__fullscreen&&cc.view.enableAutoFullScreen(!0),this.__autoResize&&oV===this&&cc.view.resizeWithBrowserSize(!0)}},{key:"_createDomInput",value:function(){this.removeDom();var e=this._edTxt=document.createElement("input");return e.type="text",e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.style["-moz-appearance"]="textfield",e.className="cocosEditBox",e.style.fontFamily="Arial",jV(e,this),e}},{key:"_createDomTextArea",value:function(){this.removeDom();var e=this._edTxt=document.createElement("textarea");return e.style.fontSize=this._edFontSize+"px",e.style.color="#000000",e.style.border="0",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.resize="none",e.style.textTransform="uppercase",e.style.overflowY="scroll",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",jV(e,this,!0),e}},{key:"_addDomToGameContainer",value:function(){cc.game.container.appendChild(this._edTxt)}},{key:"removeDom",value:function(){var e=this._edTxt;if(e){var t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionstart),e.removeEventListener("compositionend",t.compositionend),e.removeEventListener("input",t.input),e.removeEventListener("focus",t.focus),e.removeEventListener("keypress",t.keypress),e.removeEventListener("blur",t.blur),t.compositionstart=null,t.compositionend=null,t.input=null,t.focus=null,t.keypress=null,t.blur=null,$t(cc.game.container,e)&&cc.game.container.removeChild(e)}this._edTxt=null}},{key:"text",get:function(){return this._text},set:function(e){this._text=e}},{key:"textColor",get:function(){return this._textColor}},{key:"fontSize",get:function(){return this._edFontSize}},{key:"returnType",set:function(e){this._returnType=e}},{key:"alwayOnTop",get:function(){return this._alwaysOnTop}},{key:"editing",get:function(){return this._editing},set:function(e){this._editing=e}},{key:"delegate",get:function(){return this._delegate}},{key:"eventListeners",get:function(){return this.__eventListeners}}]),e}())||iV;function XV(e,t){e.value.length>t._maxLength&&(e.value=e.value.slice(0,t._maxLength)),t._delegate&&t._delegate.editBoxTextChanged&&t._text!==e.value&&(t._text=e.value,t._delegate.editBoxTextChanged(t._text))}function jV(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=!1,r=t.eventListeners;r.compositionstart=function(){n=!0},e.addEventListener("compositionstart",r.compositionstart),r.compositionend=function(){n=!1,XV(this,t)},e.addEventListener("compositionend",r.compositionend),r.input=function(){n||XV(this,t)},e.addEventListener("input",r.input),r.focus=function(){this.style.fontSize=t.fontSize+"px",this.style.color=t.textColor.toCSS("rgba"),t.alwayOnTop&&(t.editing=!0),cc.sys.isMobile&&t._beginEditingOnMobile(),t.delegate&&t.delegate.editBoxEditingDidBegan&&t.delegate.editBoxEditingDidBegan()},e.addEventListener("focus",r.focus),r.keypress=function(e){e.keyCode===oh.KEY.enter&&(e.propagationStopped=!0,t.delegate&&t.delegate.editBoxEditingReturn&&t.delegate.editBoxEditingReturn(),i||(t.text=this.value,t._endEditing(),cc.game.canvas.focus()))},e.addEventListener("keypress",r.keypress),r.blur=function(){t.text=this.value,t._endEditing()},e.addEventListener("blur",r.blur),t._addDomToGameContainer()}var qV,YV,KV,QV,ZV,JV,$V,eH,tH,iH,nH,rH,aH,sH,oH,lH,cH,uH,hH,dH,fH,pH,_H,vH,mH,yH,gH=(cV=un("cc.EditBoxComponent"),uV=mn(100),hV=vn("UI/EditBox"),dV=hn({type:iu}),fV=hn({type:QG}),pV=hn({type:eV}),_V=hn({type:JG}),vV=hn({type:Hr}),mV=hn({type:uC}),yV=hn({type:uC}),gV=hn({type:uC}),bV=hn({type:uC}),cV(SV=uV(SV=hV(SV=pn((HV=VV=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"editingDidBegan",EV,d(d(t))),v(t,"textChanged",xV,d(d(t))),v(t,"editingDidEnded",AV,d(d(t))),v(t,"editingReturn",CV,d(d(t))),t._impl=null,t._textLabel=null,t._placeholderLabel=null,t._background=null,v(t,"_returnType",wV,d(d(t))),v(t,"_useOriginalSize",RV,d(d(t))),v(t,"_string",kV,d(d(t))),v(t,"_tabIndex",OV,d(d(t))),v(t,"_backgroundImage",FV,d(d(t))),v(t,"_inputFlag",LV,d(d(t))),v(t,"_inputMode",BV,d(d(t))),v(t,"_fontSize",MV,d(d(t))),v(t,"_lineHeight",IV,d(d(t))),v(t,"_maxLength",PV,d(d(t))),v(t,"_fontColor",DV,d(d(t))),v(t,"_placeholder",NV,d(d(t))),v(t,"_placeholderFontSize",zV,d(d(t))),v(t,"_placeholderFontColor",UV,d(d(t))),v(t,"_stayOnTop",GV,d(d(t))),t}return p(a,Nh),l(a,[{key:"onEnable",value:function(){this._impl&&this._impl.onEnable()}},{key:"onDisable",value:function(){this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"_init",value:function(){this._createBackgroundSprite(),this._createLabels(),this.node.on(Kt.SystemEventType.SIZE_CHANGED,this._resizeChildNodes,this);var e=this._impl=new WV;e.setDelegate(this),e.setNode(this.node),e.setInputMode(this._inputMode),e.setMaxLength(this._maxLength),e.setInputFlag(this._inputFlag),e.setReturnType(this._returnType),e.setTabIndex(this._tabIndex),e.setFontColor(this._fontColor),e.setFontSize(this._fontSize),e.setPlaceholderText(this._placeholder),this._updateStayOnTop(),this._updateString(this._string),this._syncSize()}},{key:"__preload",value:function(){this._registerEvent(),this._init()}},{key:"_registerEvent",value:function(){this.node.on(Kt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateStayOnTop",value:function(){this.stayOnTop?this._hideLabels():this._showLabels(),this._impl&&this._impl.stayOnTop(this.stayOnTop)}},{key:"_syncSize",value:function(){var e=this.node.getContentSize();this._background&&(this._background.node.setAnchorPoint(this.node.getAnchorPoint()),this._background.node.setContentSize(e)),this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}},{key:"_updateLabelPosition",value:function(e){var t=this.node,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node.setContentSize(e.width-2,e.height),a.node.setPosition(i+2,n+e.height,a.node.getPosition().z),a.verticalAlign=this._inputMode===JG.ANY?Kt.VerticalTextAlignment.TOP:Kt.VerticalTextAlignment.CENTER,a.enableWrapText=this._inputMode===JG.ANY),r&&(r.node.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(i+2,n+e.height,r.node.getPosition().z),r.verticalAlign=this._inputMode===JG.ANY?Kt.VerticalTextAlignment.TOP:Kt.VerticalTextAlignment.CENTER,r.enableWrapText=this._inputMode===JG.ANY)}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(cc.SpriteComponent),this._background||(this._background=this.node.addComponent(cc.SpriteComponent))),this._background.type=cc.SpriteComponent.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_createLabels",value:function(){if(!this._textLabel){var e=this.node.getChildByName("TEXT_LABEL");e||(e=new cc.Node("TEXT_LABEL"));var t=e.getComponent(nV);e.parent=this.node,t||(t=e.addComponent(nV)),e.getComponent(mz).setAnchorPoint(0,1),t.color=this._fontColor,t.overflow=nV.Overflow.CLAMP,t.fontSize=this._fontSize,t.lineHeight=this.lineHeight,this._textLabel=t}if(!this._placeholderLabel){var i=this.node.getChildByName("PLACEHOLDER_LABEL");i||(i=new bd("PLACEHOLDER_LABEL"));var n=i.getComponent(nV);n||(n=i.addComponent(nV));var r=i.getComponent(mz);i.parent=this.node,n.color=this._placeholderFontColor,r.setAnchorPoint(0,1),n.overflow=nV.Overflow.CLAMP,n.fontSize=this._placeholderFontSize,n.string=this._placeholder,this._placeholderLabel=n}}},{key:"_resizeChildNodes",value:function(){var e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-this.node.width/2,this.node.height/2,e.getPosition().z),e.width=this.node.width,e.height=this.node.height);var t=this._placeholderLabel&&this._placeholderLabel.node;t&&(t.setPosition(-this.node.width/2,this.node.height/2,t.getPosition().z),t.width=this.node.width,t.height=this.node.height);var i=this._background&&this._background.node;i&&(i.width=this.node.width,i.height=this.node.height)}},{key:"_showLabels",value:function(){if(this._textLabel){var e=this._textLabel.string;this._textLabel.node.active=""!==e,this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_hideLabels",value:function(){this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._impl&&(this._impl.setString(e),this._impl.editing||this.stayOnTop||this._showLabels())}}},{key:"_updateLabelStringStyle",value:function(e){var t,i=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=this._inputFlag;if(i||n!==eV.PASSWORD)n===eV.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():n===eV.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):n===eV.INITIAL_CAPS_SENTENCE&&(e=(t=e).charAt(0).toUpperCase()+t.slice(1));else{for(var r="",a=e.length,s=0;s<a;++s)r+="";e=r}return e}},{key:"editBoxEditingDidBegan",value:function(){this._hideLabels(),uC.emitEvents(this.editingDidBegan,this),this.node.emit("editing-did-began",this)}},{key:"editBoxEditingDidEnded",value:function(){this.stayOnTop||this._showLabels(),uC.emitEvents(this.editingDidEnded,this),this.node.emit("editing-did-ended",this)}},{key:"editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,uC.emitEvents(this.textChanged,e,this),this.node.emit("text-changed",this)}},{key:"editBoxEditingReturn",value:function(){uC.emitEvents(this.editingReturn,this),this.node.emit("editing-return",this)}},{key:"_onTouchBegan",value:function(e){this._impl&&this._impl._onTouchBegan(e.touch),e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl._onTouchEnded(),e.propagationStopped=!0}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus()}},{key:"isFocused",value:function(){var e=!1;return this._impl&&(e=this._impl.isFocused()),e}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"string",get:function(){return this._string},set:function(e){0<=this._maxLength&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._impl&&this._updateString(e)}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e,this._impl&&(this._impl.returnType=this._returnType)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._impl&&(this._impl.setInputFlag(this._inputFlag),this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode=e,this._impl&&this._impl.setInputMode(this._inputMode)}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._textLabel&&(this._textLabel.fontSize=this._fontSize),this._impl&&this._impl.setFontSize(this._fontSize))}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._textLabel&&(this._textLabel.lineHeight=this._lineHeight))}},{key:"fontColor",get:function(){return this._fontColor},set:function(e){if(this._fontColor!==e){if(this._fontColor.set(e),this._textLabel){var t=this._textLabel.node.getComponent(EU);t&&(t.color=this._fontColor)}this._impl&&this._impl.setFontColor(this._fontColor)}}},{key:"placeholder",get:function(){return this._placeholder},set:function(e){this._placeholder!==e&&(this._placeholder=e,this._placeholderLabel&&(this._placeholderLabel.string=this._placeholder),this._impl&&this._impl.setPlaceholderText(this._placeholder))}},{key:"placeholderFontSize",get:function(){return this._placeholderFontSize},set:function(e){this._placeholderFontSize!==e&&(this._placeholderFontSize=e,this._placeholderLabel&&(this._placeholderLabel.fontSize=this._placeholderFontSize))}},{key:"placeholderFontColor",get:function(){return this._placeholderFontColor},set:function(e){if(this._placeholderFontColor!==e&&(this._placeholderFontColor=e,this._placeholderLabel)){var t=this._placeholderLabel.node.getComponent(EU);t&&(t.color=this._placeholderFontColor)}}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength!==e&&(this._maxLength=e,this._impl&&this._impl.setMaxLength(this._maxLength))}},{key:"stayOnTop",get:function(){return this._stayOnTop},set:function(e){this._stayOnTop=e,this._impl&&this._updateStayOnTop()}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex=e,this._impl&&this._impl.setTabIndex(e)}}]),a}(),VV._EditBoxImpl=WV,VV.KeyboardReturnType=QG,VV.InputFlag=eV,VV.InputMode=JG,c((TV=HV).prototype,"string",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"string"),TV.prototype),c(TV.prototype,"backgroundImage",[dV],Object.getOwnPropertyDescriptor(TV.prototype,"backgroundImage"),TV.prototype),c(TV.prototype,"returnType",[fV],Object.getOwnPropertyDescriptor(TV.prototype,"returnType"),TV.prototype),c(TV.prototype,"inputFlag",[pV],Object.getOwnPropertyDescriptor(TV.prototype,"inputFlag"),TV.prototype),c(TV.prototype,"inputMode",[_V],Object.getOwnPropertyDescriptor(TV.prototype,"inputMode"),TV.prototype),c(TV.prototype,"fontSize",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"fontSize"),TV.prototype),c(TV.prototype,"lineHeight",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"lineHeight"),TV.prototype),c(TV.prototype,"fontColor",[vV],Object.getOwnPropertyDescriptor(TV.prototype,"fontColor"),TV.prototype),c(TV.prototype,"placeholder",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"placeholder"),TV.prototype),c(TV.prototype,"placeholderFontSize",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"placeholderFontSize"),TV.prototype),c(TV.prototype,"placeholderFontColor",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"placeholderFontColor"),TV.prototype),c(TV.prototype,"maxLength",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"maxLength"),TV.prototype),c(TV.prototype,"stayOnTop",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"stayOnTop"),TV.prototype),c(TV.prototype,"tabIndex",[hn],Object.getOwnPropertyDescriptor(TV.prototype,"tabIndex"),TV.prototype),EV=c(TV.prototype,"editingDidBegan",[mV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xV=c(TV.prototype,"textChanged",[yV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AV=c(TV.prototype,"editingDidEnded",[gV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CV=c(TV.prototype,"editingReturn",[bV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wV=c(TV.prototype,"_returnType",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QG.DEFAULT}}),RV=c(TV.prototype,"_useOriginalSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kV=c(TV.prototype,"_string",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OV=c(TV.prototype,"_tabIndex",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FV=c(TV.prototype,"_backgroundImage",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LV=c(TV.prototype,"_inputFlag",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eV.DEFAULT}}),BV=c(TV.prototype,"_inputMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JG.ANY}}),MV=c(TV.prototype,"_fontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),IV=c(TV.prototype,"_lineHeight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),PV=c(TV.prototype,"_maxLength",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),DV=c(TV.prototype,"_fontColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.WHITE}}),NV=c(TV.prototype,"_placeholder",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Enter text here..."}}),zV=c(TV.prototype,"_placeholderFontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),UV=c(TV.prototype,"_placeholderFontColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.GRAY}}),GV=c(TV.prototype,"_stayOnTop",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SV=TV))||SV)||SV)||SV)||SV);cc.EditBoxComponent=gH;var bH,SH,TH,EH,xH,AH,CH,wH,RH,kH,OH=bd.EventType;(SH=bH||(bH={}))[SH.NONE=0]="NONE",SH[SH.HORIZONTAL=1]="HORIZONTAL",SH[SH.VERTICAL=2]="VERTICAL",SH[SH.GRID=3]="GRID",si(bH),(EH=TH||(TH={}))[EH.NONE=0]="NONE",EH[EH.CONTAINER=1]="CONTAINER",EH[EH.CHILDREN=2]="CHILDREN",si(TH),(AH=xH||(xH={}))[AH.HORIZONTAL=0]="HORIZONTAL",AH[AH.VERTICAL=1]="VERTICAL",si(xH),(wH=CH||(CH={}))[wH.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",wH[wH.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM",si(CH),(kH=RH||(RH={}))[kH.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",kH[kH.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT",si(RH);var FH,LH,BH,MH,IH,PH,DH,NH,zH,UH,GH,VH,HH,WH,XH,jH,qH,YH,KH,QH,ZH,JH,$H=new Br,eW=new Br,tW=(qV=un("cc.LayoutComponent"),YV=mn(110),KV=vn("UI/Layout"),QV=hn({type:bH}),ZV=hn({type:TH}),JV=hn({type:xH}),$V=hn({type:CH}),eH=hn({type:RH}),qV(tH=YV(tH=KV(tH=pn((yH=mH=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._layoutDirty=!0,v(t,"_resizeMode",nH,d(d(t))),v(t,"_N$layoutType",rH,d(d(t))),v(t,"_N$padding",aH,d(d(t))),v(t,"_cellSize",sH,d(d(t))),v(t,"_startAxis",oH,d(d(t))),v(t,"_paddingLeft",lH,d(d(t))),v(t,"_paddingRight",cH,d(d(t))),v(t,"_paddingTop",uH,d(d(t))),v(t,"_paddingBottom",hH,d(d(t))),v(t,"_spacingX",dH,d(d(t))),v(t,"_spacingY",fH,d(d(t))),t._layoutSize=cc.size(300,200),v(t,"_verticalDirection",pH,d(d(t))),v(t,"_horizontalDirection",_H,d(d(t))),v(t,"_affectedByScale",vH,d(d(t))),t}return p(a,Nh),l(a,[{key:"updateLayout",value:function(){this._layoutDirty&&0<this.node.children.length&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners(),this.node.getContentSize().equals(cc.size(0,0))&&this.node.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){cc.director.on(cc.Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(OH.SIZE_CHANGED,this._resized,this),this.node.on(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(OH.CHILD_ADDED,this._childAdded,this),this.node.on(OH.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){cc.director.off(cc.Director.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(OH.SIZE_CHANGED,this._resized,this),this.node.off(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(OH.CHILD_ADDED,this._childAdded,this),this.node.off(OH.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.on(OH.SCALE_PART,this._doScaleDirty,this),r.on(OH.SIZE_CHANGED,this._doLayoutDirty,this),r.on(OH.POSITION_PART,this._doLayoutDirty,this),r.on(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),r.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){var e=this.node.children,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.off(OH.SCALE_PART,this._doScaleDirty,this),r.off(OH.SIZE_CHANGED,this._doLayoutDirty,this),r.off(OH.POSITION_PART,this._doLayoutDirty,this),r.off(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),r.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(OH.SCALE_PART,this._doScaleDirty,this),e.on(OH.SIZE_CHANGED,this._doLayoutDirty,this),e.on(OH.POSITION_PART,this._doLayoutDirty,this),e.on(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(OH.SCALE_PART,this._doScaleDirty,this),e.off(OH.SIZE_CHANGED,this._doLayoutDirty,this),e.off(OH.POSITION_PART,this._doLayoutDirty,this),e.off(OH.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize=this.node.getContentSize(),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingLeft,l=-r.x*e;this._horizontalDirection===RH.RIGHT_TO_LEFT&&(s=-1,l=(1-r.x)*e,o=this._paddingRight);var c=l+s*o-s*this._spacingX,u=0,h=0,d=0,f=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var S=this._cellSize.width;this._N$layoutType!==bH.GRID&&this._resizeMode===TH.CHILDREN&&(S=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);var T=a,E=Array.isArray(T),x=0;for(T=E?T:T[Symbol.iterator]();;){var A;if(E){if(x>=T.length)break;A=T[x++]}else{if((x=T.next()).done)break;A=x.value}var C=A;if(C.activeInHierarchy){C.getScale(eW);var w=this._getUsedScaleValue(eW.x),R=this._getUsedScaleValue(eW.y);this._resizeMode===TH.CHILDREN&&(C.width=S/w,this._N$layoutType===bH.GRID&&(C.height=this._cellSize.height/R));var k=C.anchorX,O=C.width*w,F=C.height*R;h<d&&(h=d),h<=F&&(d=h,h=F,_=C.getAnchorPoint().y),this._horizontalDirection===RH.RIGHT_TO_LEFT&&(k=1-C.anchorX),c=c+s*k*O+s*this._spacingX;var L=s*(1-k)*O;if(t){var B=c+L+s*(0<s?this._paddingRight:this._paddingLeft),M=!1;this._horizontalDirection===RH.LEFT_TO_RIGHT&&B>(1-r.x)*e&&(M=!0);var I=!1;this._horizontalDirection===RH.RIGHT_TO_LEFT&&B<-r.x*e&&(I=!0),(M||I)&&(h<=F?(0===d&&(d=h),u+=d,d=h):(u+=h,d=F,h=0),c=l+s*(o+k*O),f++)}var P=i(C,u,f);e>=O+this._paddingLeft+this._paddingRight&&n&&(C.getPosition($H),C.setPosition(c,P,$H.z));var D=1,N=void 0,z=0===h?F:h;this._verticalDirection===CH.TOP_TO_BOTTOM?(p=p||this.node.getContentSize().height,(N=P+(D=-1)*(z*_+this._paddingBottom))<p&&(p=N)):(p=p||-this.node.getContentSize().height)<(N=P+D*(z*_+this._paddingTop))&&(p=N),c+=L}}return p}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node.getAnchorPoint(),a=this.node.children,s=1,o=this._paddingBottom,l=-r.y*e;this._verticalDirection===CH.TOP_TO_BOTTOM&&(s=-1,l=(1-r.y)*e,o=this._paddingTop);var c=l+s*o-s*this._spacingY,u=0,h=0,d=0,f=0,p=0,_=0,v=0,m=a,y=Array.isArray(m),g=0;for(m=y?m:m[Symbol.iterator]();;){var b;if(y){if(g>=m.length)break;b=m[g++]}else{if((g=m.next()).done)break;b=g.value}b.activeInHierarchy&&v++}var S=this._cellSize.height;this._N$layoutType!==bH.GRID&&this._resizeMode===TH.CHILDREN&&(S=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);var T=a,E=Array.isArray(T),x=0;for(T=E?T:T[Symbol.iterator]();;){var A;if(E){if(x>=T.length)break;A=T[x++]}else{if((x=T.next()).done)break;A=x.value}var C=A;if(C){var w=C.getScale(),R=this._getUsedScaleValue(w.x),k=this._getUsedScaleValue(w.y);if(C.activeInHierarchy){this._resizeMode===TH.CHILDREN&&(C.height=S/k,this._N$layoutType===bH.GRID&&(C.width=this._cellSize.width/R));var O=C.anchorY,F=C.width*R,L=C.height*k;h<d&&(h=d),h<=F&&(d=h,h=F,_=C.getAnchorPoint().x),this._verticalDirection===CH.TOP_TO_BOTTOM&&(O=1-C.anchorY),c=c+s*O*L+s*this._spacingY;var B=s*(1-O)*L;if(t){var M=c+B+s*(0<s?this._paddingTop:this._paddingBottom),I=!1;this._verticalDirection===CH.BOTTOM_TO_TOP&&M>(1-r.y)*e&&(I=!0);var P=!1;this._verticalDirection===CH.TOP_TO_BOTTOM&&M<-r.y*e&&(P=!0),(I||P)&&(h<=F?(0===d&&(d=h),u+=d,d=h):(u+=h,d=F,h=0),c=l+s*(o+O*L),f++)}var D=i(C,u,f);e>=L+(this._paddingTop+this._paddingBottom)&&n&&(C.getPosition($H),C.setPosition(D,c,$H.z));var N=1,z=void 0,U=0===h?F:h;this._horizontalDirection===RH.RIGHT_TO_LEFT?(N=-1,p=p||this.node.getContentSize().width,(z=D+N*(U*_+this._paddingLeft))<p&&(p=z)):(p=p||-this.node.getContentSize().width)<(z=D+N*(U*_+this._paddingRight))&&(p=z),c+=B}}}return p}},{key:"_doLayoutBasic",value:function(){var e=null,t=this.node.children,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r,s=a.getComponent(mz);s&&(a.activeInHierarchy&&(e?e.union(e,s.getBoundingBoxToWorld()):e=s.getBoundingBoxToWorld()))}if(e){var o=this.node.parent.getComponent(mz);if(!o)return;Oe.set($H,e.x,e.y,0);var l=new Br;o.convertToNodeSpaceAR($H,l),Oe.set(l,l.x-this._paddingLeft,l.y-this._paddingBottom,l.z),Oe.set($H,e.x+e.width,e.y+e.height,0);var c=new Br;o.convertToNodeSpaceAR($H,c),Oe.set(c,c.x+this._paddingRight,c.y+this._paddingTop,c.z);var u=cc.size(parseFloat((c.x-l.x).toFixed(2)),parseFloat((c.y-l.y).toFixed(2)));if(this.node.getPosition($H),0!==u.width){var h=($H.x-l.x)/u.width;this.node.anchorX=parseFloat(h.toFixed(2))}if(0!==u.height){var d=($H.y-l.y)/u.height;this.node.anchorY=parseFloat(d.toFixed(2))}this.node.setContentSize(u)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var n=this,i=t.width,r=1,a=-e.y*t.height,s=this._paddingBottom;this._verticalDirection===CH.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,s=this._paddingTop);var o=this,l=function(e,t,i){return a+r*(t+e.anchorY*e.height*o._getUsedScaleValue(e.getScale().y)+s+i*n._spacingY)},c=0;if(this._resizeMode===TH.CONTAINER){var u=this._doLayoutHorizontally(i,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.y*c,this._verticalDirection===CH.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)}this._doLayoutHorizontally(i,!0,l,!0),this._resizeMode===TH.CONTAINER&&this.node.setContentSize(i,c)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var n=this,i=t.height,r=1,a=-e.x*t.width,s=this._paddingLeft;this._horizontalDirection===RH.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,s=this._paddingRight);var o=this,l=function(e,t,i){return a+r*(t+e.anchorX*e.width*o._getUsedScaleValue(e.getScale().x)+s+i*n._spacingX)},c=0;if(this._resizeMode===TH.CONTAINER){var u=this._doLayoutVertically(i,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.x*c,this._horizontalDirection===RH.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)}this._doLayoutVertically(i,!0,l,!0),this._resizeMode===TH.CONTAINER&&this.node.setContentSize(c,i)}},{key:"_doLayoutGrid",value:function(){var e=this.node.getAnchorPoint(),t=this.node.getContentSize();this.startAxis===xH.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,t):this.startAxis===xH.VERTICAL&&this._doLayoutGridAxisVertical(e,t)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===TH.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(eW),o.activeInHierarchy&&(i++,t+=o.width*this._getUsedScaleValue(eW.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node.getContentSize().width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===TH.CONTAINER){var n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.getScale(eW),o.activeInHierarchy&&(i++,t+=o.height*this._getUsedScaleValue(eW.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node.getContentSize().height;return t}},{key:"_doLayout",value:function(){if(this._N$layoutType===bH.HORIZONTAL){var e=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(e,!1,function(e){return e.getPosition($H),$H.y},!0),this.node.width=e}else if(this._N$layoutType===bH.VERTICAL){var t=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(t,!1,function(e){return e.getPosition($H),$H.x},!0),this.node.height=t}else this._N$layoutType===bH.NONE?this._resizeMode===TH.CONTAINER&&this._doLayoutBasic():this._N$layoutType===bH.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(){this._layoutDirty=this._layoutDirty||this._affectedByScale}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===bH.NONE&&e===TH.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),a}(),mH.Type=bH,mH.VerticalDirection=CH,mH.HorizontalDirection=RH,mH.ResizeMode=TH,mH.AxisDirection=xH,c((iH=yH).prototype,"type",[QV],Object.getOwnPropertyDescriptor(iH.prototype,"type"),iH.prototype),c(iH.prototype,"resizeMode",[ZV],Object.getOwnPropertyDescriptor(iH.prototype,"resizeMode"),iH.prototype),c(iH.prototype,"cellSize",[hn,Xu],Object.getOwnPropertyDescriptor(iH.prototype,"cellSize"),iH.prototype),c(iH.prototype,"startAxis",[JV],Object.getOwnPropertyDescriptor(iH.prototype,"startAxis"),iH.prototype),c(iH.prototype,"paddingLeft",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"paddingLeft"),iH.prototype),c(iH.prototype,"paddingRight",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"paddingRight"),iH.prototype),c(iH.prototype,"paddingTop",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"paddingTop"),iH.prototype),c(iH.prototype,"paddingBottom",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"paddingBottom"),iH.prototype),c(iH.prototype,"spacingX",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"spacingX"),iH.prototype),c(iH.prototype,"spacingY",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"spacingY"),iH.prototype),c(iH.prototype,"verticalDirection",[$V],Object.getOwnPropertyDescriptor(iH.prototype,"verticalDirection"),iH.prototype),c(iH.prototype,"horizontalDirection",[eH],Object.getOwnPropertyDescriptor(iH.prototype,"horizontalDirection"),iH.prototype),c(iH.prototype,"padding",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"padding"),iH.prototype),c(iH.prototype,"affectedByScale",[hn],Object.getOwnPropertyDescriptor(iH.prototype,"affectedByScale"),iH.prototype),nH=c(iH.prototype,"_resizeMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TH.NONE}}),rH=c(iH.prototype,"_N$layoutType",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bH.NONE}}),aH=c(iH.prototype,"_N$padding",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sH=c(iH.prototype,"_cellSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zr(40,40)}}),oH=c(iH.prototype,"_startAxis",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xH.HORIZONTAL}}),lH=c(iH.prototype,"_paddingLeft",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cH=c(iH.prototype,"_paddingRight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uH=c(iH.prototype,"_paddingTop",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hH=c(iH.prototype,"_paddingBottom",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dH=c(iH.prototype,"_spacingX",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fH=c(iH.prototype,"_spacingY",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pH=c(iH.prototype,"_verticalDirection",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CH.TOP_TO_BOTTOM}}),_H=c(iH.prototype,"_horizontalDirection",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return RH.LEFT_TO_RIGHT}}),vH=c(iH.prototype,"_affectedByScale",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tH=iH))||tH)||tH)||tH)||tH);cc.LayoutComponent=tW,(LH=FH||(FH={}))[LH.BUTT=0]="BUTT",LH[LH.ROUND=1]="ROUND",LH[LH.SQUARE=2]="SQUARE",si(FH),(MH=BH||(BH={}))[MH.BEVEL=0]="BEVEL",MH[MH.ROUND=1]="ROUND",MH[MH.MITER=2]="MITER",si(BH),(PH=IH||(IH={}))[PH.PT_CORNER=1]="PT_CORNER",PH[PH.PT_LEFT=2]="PT_LEFT",PH[PH.PT_BEVEL=4]="PT_BEVEL",PH[PH.PT_INNERBEVEL=8]="PT_INNERBEVEL",si(IH);var iW,nW,rW,aW,sW,oW,lW,cW,uW,hW,dW,fW,pW,_W=(DH=un("cc.GraphicsComponent"),NH=mn(110),zH=vn("UI/Render/Graphics"),UH=hn({type:BH}),GH=hn({type:FH}),VH=hn({override:!0,visible:!1}),DH(HH=NH(HH=zH((JH=ZH=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).impl=null,e.model=null,v(e,"_lineWidth",XH,d(d(e))),v(e,"_strokeColor",jH,d(d(e))),v(e,"_lineJoin",qH,d(d(e))),v(e,"_lineCap",YH,d(d(e))),v(e,"_fillColor",KH,d(d(e))),v(e,"_miterLimit",QH,d(d(e))),e._instanceMaterialType=Gz.ADDCOLOR,e}return p(t,EU),l(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color}}]),l(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){_(S(t.prototype),"__preload",this)&&_(S(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=cc.director.root.ui.getRenderSceneGetter()}},{key:"onEnable",value:function(){_(S(t.prototype),"onEnable",this)&&_(S(t.prototype),"onEnable",this).call(this),this.model&&(this.model.enabled=!0),this._activateMaterial()}},{key:"onDisable",value:function(){this.model&&(this.model.enabled=!1)}},{key:"onDestroy",value:function(){_(S(t.prototype),"onDestroy",this)&&_(S(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this._getRenderScene().destroyModel(this.model),this.model=null),this.impl&&(this.impl.clear(),this.impl=null)}},{key:"_activateMaterial",value:function(){this._material&&this._updateMaterial(this._material)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){this.impl&&this.impl.clear()}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler.stroke(this)}},{key:"fill",value:function(){this._assembler.fill(this)}},{key:"updateAssembler",value:function(e){return!!_(S(t.prototype),"updateAssembler",this).call(this,e)&&(e.commitModel(this,this.model,this._material),!0)}},{key:"helpInstanceMaterial",value:function(){var e=null;this._sharedMaterial?e=_m.getInstantiatedMaterial(this._sharedMaterial,new AT,!1):((e=_m.getInstantiatedMaterial(cc.builtinResMgr.get("ui-base-material"),new AT,!1)).recompileShaders({USE_LOCAL:!0}),e.onLoaded()),this._updateMaterial(e),this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"_instanceMaterial",value:function(){this.helpInstanceMaterial()}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!_(S(t.prototype),"_canRender",this).call(this)&&!!this.model}}]),t}(),ZH.LineJoin=BH,ZH.LineCap=FH,c((WH=JH).prototype,"lineJoin",[UH],Object.getOwnPropertyDescriptor(WH.prototype,"lineJoin"),WH.prototype),c(WH.prototype,"lineCap",[GH],Object.getOwnPropertyDescriptor(WH.prototype,"lineCap"),WH.prototype),c(WH.prototype,"strokeColor",[hn,Xu],Object.getOwnPropertyDescriptor(WH.prototype,"strokeColor"),WH.prototype),c(WH.prototype,"fillColor",[hn,Xu],Object.getOwnPropertyDescriptor(WH.prototype,"fillColor"),WH.prototype),c(WH.prototype,"miterLimit",[hn],Object.getOwnPropertyDescriptor(WH.prototype,"miterLimit"),WH.prototype),c(WH.prototype,"color",[VH],Object.getOwnPropertyDescriptor(WH.prototype,"color"),WH.prototype),XH=c(WH.prototype,"_lineWidth",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jH=c(WH.prototype,"_strokeColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.BLACK}}),qH=c(WH.prototype,"_lineJoin",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return BH.MITER}}),YH=c(WH.prototype,"_lineCap",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FH.BUTT}}),KH=c(WH.prototype,"_fillColor",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hr.WHITE}}),QH=c(WH.prototype,"_miterLimit",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),HH=WH))||HH)||HH)||HH);cc.GraphicsComponent=_W;var vW,mW,yW=new Dr,gW=new Lr,bW=new Dr,SW=[];(mW=vW||(vW={}))[mW.RECT=0]="RECT",mW[mW.ELLIPSE=1]="ELLIPSE",si(vW);var TW,EW,xW,AW,CW,wW,RW,kW,OW,FW,LW,BW,MW,IW,PW,DW,NW,zW=(iW=un("cc.MaskComponent"),nW=mn(110),rW=vn("UI/Render/Mask"),aW=hn({type:vW,displayOrder:4}),sW=hn({visible:!1,override:!0}),oW=hn({visible:!1,override:!0}),lW=hn({visible:!1,override:!0}),iW(cW=nW(cW=rW((pW=fW=function(e){function i(){var e;return y(this,i),v(e=T(this,S(i).call(this)),"_type",hW,d(d(e))),v(e,"_segments",dW,d(d(e))),e._graphics=null,e._clearGraphics=null,e._lastVisibleSize=new zr,e._instanceMaterialType=Gz.ADDCOLOR,e}return p(i,EU),l(i,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._activateMaterial())}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments=le(e,3,1e4),this._updateGraphics()}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),l(i,[{key:"onLoad",value:function(){this._createGraphics()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){_(S(i.prototype),"onEnable",this).call(this),this._flushVisibility(),this._clearGraphics&&this._clearGraphics.onEnable(),this._updateGraphics(),this._activateMaterial(),this.node.on(Kt.SystemEventType.ROTATION_PART,this._nodeStateChange,this),this.node.on(Kt.SystemEventType.SCALE_PART,this._nodeStateChange,this)}},{key:"onDisable",value:function(){_(S(i.prototype),"onDisable",this).call(this),this._disableGraphics(),this.node.off(Kt.SystemEventType.ROTATION_PART,this._nodeStateChange,this),this.node.off(Kt.SystemEventType.SCALE_PART,this._nodeStateChange,this)}},{key:"onDestroy",value:function(){_(S(i.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"updateAssembler",value:function(e){if(_(S(i.prototype),"updateAssembler",this).call(this,e)){var t=cc.visibleRect;return t.width===this._lastVisibleSize.width&&t.height===this._lastVisibleSize.height||this._updateClearGraphics(),e.commitComp(this,null,this._assembler),!0}return!1}},{key:"postUpdateAssembler",value:function(e){this._canRender()&&this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"isHit",value:function(e){var t=this.node,i=t.getContentSize(),n=i.width,r=i.height,a=gW;this.node.getWorldMatrix(yW),He.invert(bW,yW),we.transformMat4(a,e,bW);var s=t.getAnchorPoint();a.x+=s.x*n,a.y+=s.y*r;var o=!1;if(this.type===vW.RECT)o=0<=a.x&&0<=a.y&&a.x<=n&&a.y<=r;else if(this.type===vW.ELLIPSE){var l=n/2,c=r/2,u=a.x-.5*n,h=a.y-.5*r;o=u*u/(l*l)+h*h/(c*c)<1}return o}},{key:"_resizeNodeToTargetNode",value:function(){}},{key:"_nodeStateChange",value:function(){_(S(i.prototype),"_nodeStateChange",this).call(this),this._updateGraphics()}},{key:"_canRender",value:function(){return!!_(S(i.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics&&this._renderPermit)}},{key:"_flushAssembler",value:function(){var e=i.Assembler.getAssembler(this),t=i.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==t&&(this._postAssembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_parentChanged",value:function(e){return!!_(S(i.prototype),"_parentChanged",this).call(this,e)&&(this._flushVisibility(),!0)}},{key:"_onTextureLoaded",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderData.vertDirty=!0),this.enabledInHierarchy&&this._activateMaterial()}},{key:"_applySpriteFrame",value:function(e){}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=this._clearGraphics=new _W;e.node=new bd("clear-graphics"),e.helpInstanceMaterial(),e._activateMaterial(),e.lineWidth=0;var t=cc.visibleRect;this._lastVisibleSize.width=t.width,this._lastVisibleSize.height=t.height,e.node.setWorldPosition(t.width/2,t.height/2,0),e.rect(-t.width/2,-t.height/2,t.width,t.height);var i=Hr.WHITE;i.a=0,this._clearGraphics.fillColor=i,e.fill()}if(!this._graphics){var n=this._graphics=new _W;n.node=this.node,n.node.getWorldMatrix(),n.helpInstanceMaterial(),n.lineWidth=0;var r=Hr.WHITE;r.a=0,n.fillColor=r}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=cc.visibleRect;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._lastVisibleSize.width=e.width,this._lastVisibleSize.height=e.height,this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node,t=this._graphics;t.clear();var i=e.getContentSize(),n=i.width,r=i.height,a=e.getAnchorPoint(),s=-n*a.x,o=-r*a.y;if(this._type===vW.RECT)t.rect(s,o,n,r);else if(this._type===vW.ELLIPSE){for(var l=function(e,t,i){SW.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)SW.push(cc.v3(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return SW}(cc.v3(s+n/2,o+r/2,0),cc.v3(n/2,r/2,0),this._segments),c=0;c<l.length;++c){var u=l[c];0===c?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}},{key:"_flushVisibility",value:function(){this._clearGraphics&&this._clearGraphics.setVisibility(this._visibility),this._graphics&&this._graphics.setVisibility(this._visibility)}},{key:"_activateMaterial",value:function(){}}]),i}(),fW.Type=vW,c((uW=pW).prototype,"type",[aW],Object.getOwnPropertyDescriptor(uW.prototype,"type"),uW.prototype),c(uW.prototype,"segments",[hn],Object.getOwnPropertyDescriptor(uW.prototype,"segments"),uW.prototype),c(uW.prototype,"dstBlendFactor",[sW],Object.getOwnPropertyDescriptor(uW.prototype,"dstBlendFactor"),uW.prototype),c(uW.prototype,"srcBlendFactor",[oW],Object.getOwnPropertyDescriptor(uW.prototype,"srcBlendFactor"),uW.prototype),c(uW.prototype,"color",[lW,Xu],Object.getOwnPropertyDescriptor(uW.prototype,"color"),uW.prototype),hW=c(uW.prototype,"_type",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vW.RECT}}),dW=c(uW.prototype,"_segments",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),cW=uW))||cW)||cW)||cW);cc.MaskComponent=zW,(NW=DW||(DW={}))[NW.HORIZONTAL=0]="HORIZONTAL",NW[NW.VERTICAL=1]="VERTICAL",NW[NW.FILLED=2]="FILLED",ai(DW);var UW,GW,VW,HW,WW=(TW=un("cc.ProgressBarComponent"),EW=mn(110),xW=vn("UI/ProgressBar"),AW=hn({type:rG}),CW=hn({type:DW}),wW=hn({range:[0,1,.1],slide:!0}),TW(RW=EW(RW=xW((PW=IW=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_barSprite",OW,d(d(t))),v(t,"_mode",FW,d(d(t))),v(t,"_totalLength",LW,d(d(t))),v(t,"_progress",BW,d(d(t))),v(t,"_reverse",MW,d(d(t))),t}return p(a,Nh),l(a,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node.getContentSize(),i=this.node.getAnchorPoint(),n=e.getContentSize();if(this._barSprite.fillType===rG.FillType.RADIAL&&(this._mode=DW.FILLED),this._mode===DW.HORIZONTAL?this.totalLength=n.width:this._mode===DW.VERTICAL?this.totalLength=n.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var r=-t.width*i.x;e.setPosition(r,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e.getAnchorPoint(),i=e.getContentSize(),n=e.getPosition(),r=new Lr(0,.5),a=Yt(this._progress),s=this._totalLength*a,o=i,l=0,c=0;switch(this._mode){case DW.HORIZONTAL:this._reverse&&(r=new Lr(1,.5)),o=new zr(s,i.height),l=this._totalLength,c=i.height;break;case DW.VERTICAL:r=this._reverse?new Lr(.5,1):new Lr(.5,0),o=new zr(i.width,s),l=i.width,c=this._totalLength}if(this._mode===DW.FILLED)this._barSprite.type!==cc.SpriteComponent.Type.FILLED?cc.warn("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==cc.SpriteComponent.Type.FILLED){var u=r.x-t.x,h=r.y-t.y,d=new Br(l*u,c*h,0);e.setPosition(n.x+d.x,n.y+d.y,n.z),e.setAnchorPoint(r),e.setContentSize(o)}else cc.warn("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t.getContentSize();this._mode===DW.HORIZONTAL?this.totalLength=i.width:this._mode===DW.VERTICAL?this.totalLength=i.height:this._mode===DW.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===DW.FILLED&&(e=Yt(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),a}(),IW.Mode=DW,c((kW=PW).prototype,"barSprite",[AW],Object.getOwnPropertyDescriptor(kW.prototype,"barSprite"),kW.prototype),c(kW.prototype,"mode",[CW],Object.getOwnPropertyDescriptor(kW.prototype,"mode"),kW.prototype),c(kW.prototype,"totalLength",[hn],Object.getOwnPropertyDescriptor(kW.prototype,"totalLength"),kW.prototype),c(kW.prototype,"progress",[wW],Object.getOwnPropertyDescriptor(kW.prototype,"progress"),kW.prototype),c(kW.prototype,"reverse",[hn],Object.getOwnPropertyDescriptor(kW.prototype,"reverse"),kW.prototype),OW=c(kW.prototype,"_barSprite",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FW=c(kW.prototype,"_mode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DW.HORIZONTAL}}),LW=c(kW.prototype,"_totalLength",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BW=c(kW.prototype,"_progress",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),MW=c(kW.prototype,"_reverse",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RW=kW))||RW)||RW)||RW);cc.ProgressBarComponent=WW;var XW,jW,qW,YW,KW,QW,ZW,JW,$W,eX,tX,iX,nX,rX,aX,sX,oX,lX,cX,uX=un("cc.LabelOutlineComponent")(UW=mn(110)(UW=vn("UI/Render/LabelOutline")((VW=c((GW=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_color",VW,d(d(t))),v(t,"_width",HW,d(d(t))),t}return p(a,Nh),l(a,[{key:"_updateRenderData",value:function(){var e=this.node.getComponent(nV);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),a}()).prototype,"_color",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hr(255,255,255,255)}}),HW=c(GW.prototype,"_width",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c(GW.prototype,"color",[hn,Xu],Object.getOwnPropertyDescriptor(GW.prototype,"color"),GW.prototype),c(GW.prototype,"width",[hn],Object.getOwnPropertyDescriptor(GW.prototype,"width"),GW.prototype),UW=GW))||UW)||UW)||UW;cc.LabelOutlineComponent=uX;var hX=new Kd,dX="RICHTEXT_CHILD",fX="RICHTEXT_Image_CHILD";var pX=new Pt(function(e){return!!cc.isValid(e.node)&&!e.node.getComponent(cc.LabelOutlineComponent)},20);pX.get=function(e,t){var i=this._get();i||(i={node:new yg(dX),comp:null,lineCount:0,styleIndex:0,clickHandler:""});var n=i.node;n||(n=new yg(dX));var r=n.getComponent(nV);return r||(r=n.addComponent(nV)),r=r,n.setPosition(0,0,0),n.setAnchorPoint(.5,.5),n.setContentSize(128,128),"string"!=typeof e&&(e=""+e),t.font instanceof Lu?r.font=t.font:r.fontFamily="Arial",r.string=e,r.horizontalAlign=Kt.HorizontalTextAlignment.LEFT,r.verticalAlign=Kt.VerticalTextAlignment.TOP,r.fontSize=t.fontSize||40,r.overflow=0,r.enableWrapText=!0,r.lineHeight=40,r.isBold=!1,r.isItalic=!1,r.isUnderline=!1,{node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0}};var _X,vX,mX,yX,gX,bX,SX,TX,EX,xX,AX,CX,wX,RX,kX=(XW=un("cc.RichTextComponent"),jW=mn(110),qW=vn("UI/Render/RichText"),YW=hn({multiline:!0}),KW=hn({type:Kt.HorizontalTextAlignment}),QW=hn({type:Gu}),ZW=hn({type:su}),XW(JW=jW(JW=qW(JW=pn((cX=lX=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"_lineHeight",eX,d(d(e))),v(e,"_string",tX,d(d(e))),v(e,"_horizontalAlign",iX,d(d(e))),v(e,"_fontSize",nX,d(d(e))),v(e,"_maxWidth",rX,d(d(e))),v(e,"_font",aX,d(d(e))),v(e,"_imageAtlas",sX,d(d(e))),v(e,"_handleTouchEvent",oX,d(d(e))),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return p(t,Hz),l(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font&&this._onTTFLoaded(),this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),l(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded()}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){var e=this._labelSegments,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.node.removeFromParent(),pX.put(r)}}},{key:"_addEventListeners",value:function(){this.node.on(cc.Node.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(cc.Node.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var t=this;this._labelSegments.forEach(function(e){t._applyTextAttribute(e)})}},{key:"_createFontLabel",value:function(e){return pX.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof Gu)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var i=this;cc.loader.load(this._font.nativeUrl,function(e,t){i._layoutDirty=!0,i._updateRichText()})}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(i,e){var n=this,t=function(e){var t;return 0===n._labelSegmentsCache.length?(t=n._createFontLabel(e),n._labelSegmentsCache.push(t)):(t=n._labelSegmentsCache[0]).node.getComponent(nV).string=e,t.styleIndex=i,n._applyTextAttribute(t),t.node.getContentSize().width};return e?t(e):t}},{key:"_onTouchEnded",value:function(n){var t=this,r=this.node.getComponents(Hz),a=this,e=function(){if(o){if(l>=s.length)return"break";c=s[l++]}else{if((l=s.next()).done)return"break";c=l.value}var e=c,i=e.clickHandler;i&&t._containsTouchLocation(e,n.touch.getUILocation())&&(r.forEach(function(e){var t=e[i];e.enabledInHierarchy&&t&&t.call(a,n)}),n.propagationStopped=!0)},s=this._labelSegments,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if("break"===e())break}}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(mz);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var n=this,r=this.node.children,e=function(e){var t=r[e];if((t.name===dX||t.name===fX)&&(t.parent===n.node?t.parent=null:r.splice(e,1),t.name===dX)){var i=n._labelSegments.findIndex(function(e){return e.node===t});-1!==i&&pX.put(n._labelSegments[i])}},t=r.length-1;0<=t;t--)e(t);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;0<=t;t--){var i=this.node.children[t];i.name!==dX&&i.name!==fX||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(nV);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(0<this._lineOffsetX&&n+this._lineOffsetX>this.maxWidth)for(var r=0;this._lineOffsetX<=this.maxWidth;){var a=this._getFirstWordLen(e,r,e.length),s=e.substr(r,a),o=this._measureText(i,s);if(!(this._lineOffsetX+o<=this.maxWidth)){if(0<r){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=o,r+=a}if(n>this.maxWidth)for(var c=Xl(e,n,this.maxWidth,this._measureText(i)),u=0;u<c.length;++u){var h=c[u],d=this._addLabelSegment(h,i).node.getContentSize();this._lineOffsetX+=d.width,1<c.length&&u<c.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;if(i.style){if(n.style){if(!!n.style.outline!=!!i.style.outline)return!0;if(i.style.size!==n.style.size||i.style.italic!==n.style.italic||i.style.isImage!==n.style.isImage)return!0;if(i.style.isImage===n.style.isImage&&i.style.src!==n.style.src)return!0}else if(i.style.size||i.style.italic||i.style.isImage||i.style.outline)return!0}else if(n.style&&(n.style.size||n.style.italic||n.style.isImage||n.style.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style.src,i=this._imageAtlas&&t&&this._imageAtlas.getSpriteFrame(t);if(i){var n=new yg(fX),r=n.addComponent(rG);n.setAnchorPoint(0,0),r.type=cc.SpriteComponent.Type.SLICED,r.sizeMode=cc.SpriteComponent.SizeMode.CUSTOM,this.node.addChild(n);var a={node:n,comp:r,lineCount:0,clickHandler:"",styleIndex:0};this._labelSegments.push(a);var s=i.getRect(),o=1,l=s.width,c=s.height,u=e.style.imageWidth,h=e.style.imageHeight;if(void 0!==h&&0<h&&h<this.lineHeight?l*=o=h/c:l*=o=this.lineHeight/c,c*=o,void 0!==u&&0<u&&(l=u),0<this.maxWidth?(this._lineOffsetX+l>this.maxWidth&&this._updateLineInfo(),this._lineOffsetX+=l):(this._lineOffsetX+=l,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.spriteFrame=i,n.setContentSize(l,c),a.lineCount=this._lineCount,e.style.event){e.style.event.click&&(a.clickHandler=e.style.event.click)}}else cc.warnID(4400)}}},{key:"_updateRichText",value:function(){if(this.enabled){var e=hX.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this.imageAtlas){this._addRichTextImageElement(r);continue}}for(var s=a.split("\n"),o=0;o<s.length;++o){var l=s[o];if(""!==l)if(i=!1,0<this.maxWidth){var c=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,c,n),1<s.length&&o<s.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n).node.getContentSize(),this._lineOffsetX+=t.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),1<s.length&&o<s.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&o===s.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),0<this.maxWidth&&(this._labelWidth=this.maxWidth),this._labelHeight=this._lineCount*this.lineHeight,this.node.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Vl(n)||Hl(n))return 1;for(var r=1,a=t+1;a<i&&(!Hl(n=e.charAt(a))&&!Vl(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){var e=0,t=1,i=this._lineCount,n=this._labelSegments,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s,l=o.lineCount;t<l&&(e=0,t=l);var c=0;switch(this.horizontalAlign){case Kt.HorizontalTextAlignment.LEFT:c=-this._labelWidth/2;break;case Kt.HorizontalTextAlignment.CENTER:c=-this._linesWidth[l-1]/2;break;case Kt.HorizontalTextAlignment.RIGHT:c=this._labelWidth/2-this._linesWidth[l-1]}var u=o.node.getContentSize(),h=o.node.getPosition();o.node.setPosition(e+c,this.lineHeight*(i-l)-this._labelHeight/2,h.x),l===t&&(e+=u.width)}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return Hr[t]?Hr[t]:(new Hr).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(nV);if(t){var i,n=e.styleIndex;t.lineHeight=this.lineHeight,t.horizontalAlign=Kt.HorizontalTextAlignment.LEFT,t.verticalAlign=Kt.VerticalTextAlignment.CENTER,this._textArray[n]&&(i=this._textArray[n].style);var r=e.node.getComponent(nV);if(r&&(i&&i.color?r.color=this._convertLiteralColorValue(i.color):r.color=this._convertLiteralColorValue("white")),t.isBold=!(!i||!i.bold),t.isItalic=!(!i||!i.italic),t.isUnderline=!(!i||!i.underline),i&&i.outline){var a=e.node.getComponent(uX);a||(a=e.node.addComponent(uX)),a.color=this._convertLiteralColorValue(i.outline.color),a.width=i.outline.width}if(i&&i.size?t.fontSize=i.size:t.fontSize=this._fontSize,t.updateRenderData(!0),i&&i.event){i.event.click&&(e.clickHandler=i.event.click)}}}}]),t}(),lX.HorizontalAlign=Kt.HorizontalTextAlignment,lX.VerticalAlign=Kt.VerticalTextAlignment,c(($W=cX).prototype,"string",[YW],Object.getOwnPropertyDescriptor($W.prototype,"string"),$W.prototype),c($W.prototype,"horizontalAlign",[KW],Object.getOwnPropertyDescriptor($W.prototype,"horizontalAlign"),$W.prototype),c($W.prototype,"fontSize",[hn],Object.getOwnPropertyDescriptor($W.prototype,"fontSize"),$W.prototype),c($W.prototype,"font",[QW],Object.getOwnPropertyDescriptor($W.prototype,"font"),$W.prototype),c($W.prototype,"maxWidth",[hn],Object.getOwnPropertyDescriptor($W.prototype,"maxWidth"),$W.prototype),c($W.prototype,"lineHeight",[hn],Object.getOwnPropertyDescriptor($W.prototype,"lineHeight"),$W.prototype),c($W.prototype,"imageAtlas",[ZW],Object.getOwnPropertyDescriptor($W.prototype,"imageAtlas"),$W.prototype),c($W.prototype,"handleTouchEvent",[hn],Object.getOwnPropertyDescriptor($W.prototype,"handleTouchEvent"),$W.prototype),eX=c($W.prototype,"_lineHeight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),tX=c($W.prototype,"_string",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</c><color=#0fffff>Text</color>"}}),iX=c($W.prototype,"_horizontalAlign",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kt.HorizontalTextAlignment.LEFT}}),nX=c($W.prototype,"_fontSize",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),rX=c($W.prototype,"_maxWidth",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aX=c($W.prototype,"_font",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sX=c($W.prototype,"_imageAtlas",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oX=c($W.prototype,"_handleTouchEvent",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JW=$W))||JW)||JW)||JW)||JW);cc.RichTextComponent=kX;var OX,FX,LX=new Br,BX=new Br,MX=new Br,IX=new Lr,PX=new Hr;(FX=OX||(OX={}))[FX.HORIZONTAL=0]="HORIZONTAL",FX[FX.VERTICAL=1]="VERTICAL",si(OX);var DX,NX=(_X=un("cc.ScrollBarComponent"),vX=mn(110),mX=vn("UI/ScrollBar"),yX=hn({type:rG}),gX=hn({type:OX}),_X(bX=vX(bX=mX((RX=wX=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"_scrollView",TX,d(d(t))),v(t,"_handle",EX,d(d(t))),v(t,"_direction",xX,d(d(t))),v(t,"_enableAutoHide",AX,d(d(t))),v(t,"_autoHideTime",CX,d(d(t))),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}return p(a,Nh),l(a,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t.getContentSize(),n=this._scrollView.node.getContentSize(),r=this.node.getContentSize();if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,s=0,o=0,l=0,c=0;this._direction===OX.HORIZONTAL?(a=i.width,s=n.width,c=r.width,o=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===OX.VERTICAL&&(a=i.height,s=n.height,c=r.height,o=e.y,l=-this._convertToScrollViewSpace(t).y);var u=this._calculateLength(a,s,c,o),h=this._calculatePosition(a,s,c,l,o,u);this._updateLength(u),this._updateHanlderPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e.getContentSize(),i=this._scrollView.node.getContentSize();if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(rG);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){if(!this._scrollView)return LX;var t=e.getAnchorPoint(),i=e.getContentSize(),n=new Br(-t.x*i.width,-t.y*i.height,0);return e.uiTransfromComp.convertToWorldSpaceAR(n,n),t=this._scrollView.node.getAnchorPoint(),i=this._scrollView.node.getContentSize(),n.x+=t.x*i.width,n.y+=t.y*i.height,this._scrollView.node.uiTransfromComp.convertToNodeSpaceAR(n,n),n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(rG);t&&(PX.set(t.color),PX.a=e,t.color=PX),(t=this._handle.getComponent(rG))&&(PX.set(t.color),PX.a=e,t.color=PX)}}},{key:"_updateHanlderPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node.getContentSize(),t=this.node.getAnchorPoint(),i=this.handle.node.getContentSize(),n=this.handle.node.parent;Oe.set(BX,-e.width*t.x,-e.height*t.y,0);var r=this.node.uiTransfromComp.convertToWorldSpaceAR(BX,MX),a=new Br;return n.uiTransfromComp.convertToNodeSpaceAR(r,a),this.direction===OX.HORIZONTAL?a=new Br(a.x,a.y+(e.height-i.height)/2,0):this.direction===OX.VERTICAL&&(a=new Br(a.x+(e.width-i.width)/2,a.y,0)),this.handle.node.setPosition(a),a}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===OX.HORIZONTAL||e.height<=t.height&&this._direction===OX.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(0<n?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var s=e-t;r&&(s+=Math.abs(r));var o=0;s&&(o=Yt(o=n/s));var l=(i-a)*o;return this._direction===OX.VERTICAL?new Br(0,l,0):new Br(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node,i=t.getContentSize(),n=t.getAnchorPoint();n.x===IX.x&&n.y===IX.y||t.setAnchorPoint(IX),this._direction===OX.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(cc.v2(0,0)))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new Br))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),a}(),wX.Direction=OX,c((SX=RX).prototype,"handle",[yX],Object.getOwnPropertyDescriptor(SX.prototype,"handle"),SX.prototype),c(SX.prototype,"direction",[gX],Object.getOwnPropertyDescriptor(SX.prototype,"direction"),SX.prototype),c(SX.prototype,"enableAutoHide",[hn],Object.getOwnPropertyDescriptor(SX.prototype,"enableAutoHide"),SX.prototype),c(SX.prototype,"autoHideTime",[hn],Object.getOwnPropertyDescriptor(SX.prototype,"autoHideTime"),SX.prototype),TX=c(SX.prototype,"_scrollView",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EX=c(SX.prototype,"_handle",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xX=c(SX.prototype,"_direction",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OX.HORIZONTAL}}),AX=c(SX.prototype,"_enableAutoHide",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CX=c(SX.prototype,"_autoHideTime",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bX=SX))||bX)||bX)||bX);cc.ScrollBarComponent=NX;var zX,UX,GX,VX,HX,WX,XX,jX,qX,YX,KX,QX,ZX,JX,$X,ej,tj,ij,nj,rj,aj,sj,oj,lj,cj=un("cc.ViewGroupComponent")(DX=mn(110)(DX=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Nh),t}())||DX)||DX;cc.ViewGroupComponent=cj;var uj,hj,dj=bd.EventType,fj=1e-4,pj=new Br,_j=new Br,vj=function(){return(new Date).getMilliseconds()};(hj=uj||(uj={}))[hj.SCROLL_TO_TOP=0]="SCROLL_TO_TOP",hj[hj.SCROLL_TO_BOTTOM=1]="SCROLL_TO_BOTTOM",hj[hj.SCROLL_TO_LEFT=2]="SCROLL_TO_LEFT",hj[hj.SCROLL_TO_RIGHT=3]="SCROLL_TO_RIGHT",hj[hj.SCROLLING=4]="SCROLLING",hj[hj.BOUNCE_TOP=5]="BOUNCE_TOP",hj[hj.BOUNCE_BOTTOM=6]="BOUNCE_BOTTOM",hj[hj.BOUNCE_LEFT=7]="BOUNCE_LEFT",hj[hj.BOUNCE_RIGHT=8]="BOUNCE_RIGHT",hj[hj.SCROLL_ENDED=9]="SCROLL_ENDED",hj[hj.TOUCH_UP=10]="TOUCH_UP",hj[hj.AUTOSCROLL_ENDED_WITH_THRESHOLD=11]="AUTOSCROLL_ENDED_WITH_THRESHOLD",hj[hj.SCROLL_BEGAN=12]="SCROLL_BEGAN",si(uj);var mj,yj,gj,bj,Sj,Tj,Ej,xj,Aj,Cj,wj,Rj,kj,Oj,Fj,Lj={"scroll-to-top":uj.SCROLL_TO_TOP,"scroll-to-bottom":uj.SCROLL_TO_BOTTOM,"scroll-to-left":uj.SCROLL_TO_LEFT,"scroll-to-right":uj.SCROLL_TO_RIGHT,scrolling:uj.SCROLLING,"bounce-bottom":uj.BOUNCE_BOTTOM,"bounce-left":uj.BOUNCE_LEFT,"bounce-right":uj.BOUNCE_RIGHT,"bounce-top":uj.BOUNCE_TOP,"scroll-ended":uj.SCROLL_ENDED,"touch-up":uj.TOUCH_UP,"scroll-ended-with-threshold":uj.AUTOSCROLL_ENDED_WITH_THRESHOLD,"scroll-began":uj.SCROLL_BEGAN},Bj=(zX=un("cc.ScrollViewComponent"),UX=mn(110),GX=vn("UI/ScrollView"),VX=hn({type:bd}),HX=hn({type:NX}),WX=hn({type:NX}),XX=hn({range:[0,1,.1]}),jX=hn({range:[0,10]}),qX=hn({type:uC}),zX(YX=UX(YX=GX((lj=oj=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"horizontal",QX,d(d(t))),v(t,"vertical",ZX,d(d(t))),v(t,"inertia",JX,d(d(t))),v(t,"brake",$X,d(d(t))),v(t,"elastic",ej,d(d(t))),v(t,"bounceDuration",tj,d(d(t))),v(t,"scrollEvents",ij,d(d(t))),v(t,"cancelInnerEvents",nj,d(d(t))),v(t,"_content",rj,d(d(t))),v(t,"_horizontalScrollBar",aj,d(d(t))),v(t,"_verticalScrollBar",sj,d(d(t))),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrolling=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Br,t._autoScrollTargetDelta=new Br,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Br,t._outOfBoundaryAmount=new Br,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._scrolling=!1,t._contentPos=new Br,t._deltaPos=new Br,t}return p(a,cj),l(a,[{key:"scrollToBottom",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e,t){var i=this._calculateMovePercentDelta({anchor:new Lr(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t,i){var n=this.getMaxScrollOffset(),r=new Lr(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Br(t,e,0)}},{key:"getMaxScrollOffset",value:function(){var e=this.node.getContentSize(),t=this._content.getContentSize(),i=t.width-e.width,n=t.height-e.height;return new Br(i=0<=i?i:0,n=0<=n?n:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Lr(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Lr(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new Lr(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){e.fuzzyEquals(this.getContentPosition(),fj)||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},{key:"getContentPosition",value:function(){return this._content?(this._content.getPosition(this._contentPos),this._contentPos):pj}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return fj}},{key:"start",value:function(){this._calculateBoundary(),this._content&&cc.director.once(cc.Director.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this.content&&(this.content.on(dj.SIZE_CHANGED,this._calculateBoundary,this),this.content.on(dj.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.on(dj.POSITION_PART,this._calculateBoundary,this),this.view.on(dj.SCALE_PART,this._calculateBoundary,this),this.view.on(dj.SIZE_CHANGED,this._calculateBoundary,this))),this._showScrollbar()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this.content&&(this.content.off(dj.SIZE_CHANGED,this._calculateBoundary,this),this.content.off(dj.SCALE_PART,this._calculateBoundary,this),this.view&&(this.view.off(dj.POSITION_PART,this._calculateBoundary,this),this.view.off(dj.SCALE_PART,this._calculateBoundary,this),this.view.off(dj.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollbar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(dj.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(dj.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(dj.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(dj.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(dj.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(dj.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(dj.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(dj.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(dj.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(dj.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new Br,n=-.1;0,this.vertical?i=new Br(0,e.getScrollY()*n,0):this.horizontal&&(i=new Br(e.getScrollY()*n,0,0)),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._content&&this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)&&e&&e.touch){var i=e.touch;if(this._content&&this._handleMoveLogic(i),this.cancelInnerEvents){if(7<i.getUILocation().sub(i.getStartLocation()).mag()&&!this._touchMoved&&e.target!==this.node){var n=new Yu(e.getTouches(),e.bubbles);n.type=dj.TOUCH_CANCEL,n.touch=e.touch,n.simulate=!0,e.target.dispatchEvent(n),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent("touch-up");var i=e.touch;this._content&&this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._content&&this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this.content){var e=this.content.getComponent(tW);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view.getContentSize(),i=t.width*this.view.anchorX,n=t.height*this.view.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===cc.Event.CAPTURING_PHASE){if(t){var i=t,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;if(this.node===s)return!(!e.target||!e.target.getComponent(cj));if(s.getComponent(cj))return!0}}return!1}}},{key:"_startInertiaScroll",value:function(e){var t=e.mul(.7);this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=this._calculateAutoScrollTimeByInitalSpeed(t.mag()),n=e.normalize(),r=this._content.getContentSize(),a=this.node.getContentSize(),s=r.width-a.width,o=r.height-a.height,l=this._calculateAttenuatedFactor(s),c=this._calculateAttenuatedFactor(o);n=new Br(n.x*s*(1-this.brake)*l,n.y*o*c*(1-this.brake),0);var u=e.mag(),h=n.mag()/u;n=n.add(e),0<this.brake&&7<h&&(h=Math.sqrt(h),n=e.mul(h).add(e)),0<this.brake&&3<h&&(i*=h=3),0===this.brake&&1<h&&(i*=h),this._startAutoScroll(n,i,!0)}},{key:"_calculateAutoScrollTimeByInitalSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,Oe.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new Br,this._getHowMuchOutOfBoundary().fuzzyEquals(pj,fj)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce(function(e,t){return e+t},e))<=0||.5<=e)return new Br;var t=new Br;return t=this._touchMoveDisplacements.reduce(function(e,t){return e.add(t)},t),new Br(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);this.getContentPosition().add(i,_j),this.setContentPosition(_j);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){return this.getContentPosition().x-this._content.getAnchorPoint().x*this._content.getContentSize().width}},{key:"_getContentRightBoundary",value:function(){var e=this._content.getContentSize();return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){var e=this._content.getContentSize();return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){return this.getContentPosition().y-this._content.getAnchorPoint().y*this._content.getContentSize().height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new Br).fuzzyEquals(pj,fj)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Br;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.fuzzyEquals(pj,fj)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if("scroll-ended"===e)this._scrollEventEmitMask=0;else if("scroll-to-top"===e||"scroll-to-bottom"===e||"scroll-to-left"===e||"scroll-to-right"===e){var t=1<<Lj[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}cc.Component.EventHandler.emitEvents(this.scrollEvents,this,Lj[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary(new Br),t=this.getContentPosition().add(e);this._content&&(this._content.setPosition(t),this._updateScrollBar(pj))}}},{key:"_hideScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this.verticalScrollBar&&this.verticalScrollBar.hide()}},{key:"_showScrollbar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.show(),this.verticalScrollBar&&this.verticalScrollBar.show()}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e&&e.eventPhase===cc.Event.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){var t=e.getUIDelta();Oe.set(this._deltaPos,t.x,t.y,0),this._processDeltaMove(this._deltaPos)}},{key:"_scrollChildren",value:function(e){var t,i=e=this._clampDelta(e);this.elastic&&(t=this._getHowMuchOutOfBoundary(),i.x*=0===t.x?1:.5,i.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(i),i=i.add(t));var n="",r=new Br;if(this._content.getPosition(r),0<i.y)r.y-this._content.anchorY*this._content.height+i.y>this._bottomBoundary&&(n="scroll-to-bottom");else if(i.y<0){r.y-this._content.anchorY*this._content.height+this._content.height+i.y<=this._topBoundary&&(n="scroll-to-top")}else if(i.x<0){r.x-this._content.anchorX*this._content.width+this._content.width+i.x<=this._rightBoundary&&(n="scroll-to-right")}else if(0<i.x){r.x-this._content.anchorX*this._content.width+i.x>=this._leftBoundary&&(n="scroll-to-left")}this._moveContent(i,!1),0===i.x&&0===i.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent("scroll-began")),this._dispatchEvent("scrolling")),0<n.length&&this._dispatchEvent(n)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent("scroll-ended"),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=vj(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){var t=this._content.getContentSize(),i=this.node.getContentSize();return t.width<i.width&&(e.x=0),t.height<i.height&&(e.y=0),e}},{key:"_gatherTouchMove",value:function(e){for(e=this._clampDelta(e);5<=this._touchMoveDisplacements.length;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var t=vj();this._touchMoveTimeDeltas.push((t-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=t}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).fuzzyEquals(_j,fj))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(0<e.y&&this._dispatchEvent("bounce-top"),e.y<0&&this._dispatchEvent("bounce-bottom"),0<e.x&&this._dispatchEvent("bounce-right"),e.x<0&&this._dispatchEvent("bounce-left"),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.fuzzyEquals(_j,fj)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_handleReleaseLogic",value:function(e){var t=e.getUIDelta();Oe.set(this._deltaPos,t.x,t.y,0),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent("scroll-ended"))}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().fuzzyEquals(pj,fj)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var a=this._autoScrollStartPosition.add(this._autoScrollTargetDelta.mul(r)),s=Math.abs(r-1)<=fj;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent("scroll-ended-with-threshold"),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var o=a.sub(this._autoScrollBrakingStartPosition);t&&(o=o.mul(i)),a=this._autoScrollBrakingStartPosition.add(o)}else{var l=a.sub(this.getContentPosition()),c=this._getHowMuchOutOfBoundary(l);c.fuzzyEquals(pj,fj)||(a=a.add(c),s=!0)}s&&(this._autoScrolling=!1);var u=a.sub(this.getContentPosition());this._moveContent(this._clampDelta(u),s),this._dispatchEvent("scrolling"),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent("scroll-ended"))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().fuzzyEquals(pj,fj))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,.1<this._mouseWheelEventElapsedTime&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t=t.clampf(new Lr(0,0),new Lr(1,1));var r=this.node.getContentSize(),a=this._content.getContentSize(),s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var l=new Br,c=0;return i&&(c=a.width-r.width,l.x=o-c*t.x),n&&(c=a.height-r.height,l.y=s-c*t.y),l}},{key:"_moveContentToTopLeft",value:function(e){var t=this._content.getContentSize(),i=this._getContentBottomBoundary()-this._bottomBoundary;i=-i;var n=new Br,r=0,a=this._getContentLeftBoundary()-this._leftBoundary;a=-a,t.height<e.height?(r=t.height-e.height,n.y=i-r,this.verticalScrollBar&&this.verticalScrollBar.hide()):this.verticalScrollBar&&this.verticalScrollBar.show(),t.width<e.width?(r=t.width-e.width,n.x=a,this._horizontalScrollBar&&this._horizontalScrollBar.hide()):this._horizontalScrollBar&&this._horizontalScrollBar.show(),this._moveContent(n),this._adjustContentOutOfBoundary()}},{key:"content",get:function(){return this._content},set:function(e){this._content!==e&&(this._content=e,this._calculateBoundary())}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(pj)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(pj)))}},{key:"view",get:function(){return this._content?this._content.parent:null}}]),a}(),oj.EventType=uj,c((KX=lj).prototype,"content",[VX],Object.getOwnPropertyDescriptor(KX.prototype,"content"),KX.prototype),c(KX.prototype,"horizontalScrollBar",[HX],Object.getOwnPropertyDescriptor(KX.prototype,"horizontalScrollBar"),KX.prototype),c(KX.prototype,"verticalScrollBar",[WX],Object.getOwnPropertyDescriptor(KX.prototype,"verticalScrollBar"),KX.prototype),QX=c(KX.prototype,"horizontal",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ZX=c(KX.prototype,"vertical",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),JX=c(KX.prototype,"inertia",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$X=c(KX.prototype,"brake",[XX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),ej=c(KX.prototype,"elastic",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tj=c(KX.prototype,"bounceDuration",[jX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ij=c(KX.prototype,"scrollEvents",[qX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nj=c(KX.prototype,"cancelInnerEvents",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rj=c(KX.prototype,"_content",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aj=c(KX.prototype,"_horizontalScrollBar",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sj=c(KX.prototype,"_verticalScrollBar",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YX=KX))||YX)||YX)||YX);cc.ScrollViewComponent=Bj;var Mj,Ij,Pj=new Br;(Ij=Mj||(Mj={}))[Ij.Horizontal=0]="Horizontal",Ij[Ij.Vertical=1]="Vertical",si(Mj);var Dj,Nj,zj,Uj,Gj,Vj,Hj,Wj,Xj=(mj=un("cc.SliderComponent"),yj=mn(110),gj=vn("UI/Slider"),bj=hn({type:rG}),Sj=hn({type:Mj}),Tj=hn({slide:!0,range:[0,1,.01]}),Ej=hn({type:uC}),mj(xj=yj(xj=gj((Fj=Oj=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"slideEvents",Cj,d(d(t))),v(t,"_handle",wj,d(d(t))),v(t,"_direction",Rj,d(d(t))),v(t,"_progress",kj,d(d(t))),t._offset=new Br,t._dragging=!1,t._touchHandle=!1,t._handlelocalPos=new Br,t._touchPos=new Br,t}return p(a,Nh),l(a,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(Kt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.on(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.on(Kt.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Kt.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(Kt.SystemEventType.TOUCH_START,this._onTouchBegan,this),this.node.off(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this),this.node.off(Kt.SystemEventType.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Kt.SystemEventType.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Kt.SystemEventType.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Kt.SystemEventType.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node.uiTransfromComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Oe.set(this._touchPos,t.x,t.y,0),this._handle.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=cc.v2(),e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){cc.Component.EventHandler.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();Oe.set(this._touchPos,t.x,t.y,0);var i=this.node.uiTransfromComp.convertToNodeSpaceAR(this._touchPos,Pj);this.direction===Mj.Horizontal?this.progress=Yt(.5+(i.x-this._offset.x)/this.node.width):this.progress=Yt(.5+(i.y-this._offset.y)/this.node.height)}}},{key:"_updateHandlePosition",value:function(){this._handle&&(this._handlelocalPos.set(this._handle.node.getPosition()),this._direction===Mj.Horizontal?this._handlelocalPos.x=-this.node.width*this.node.anchorX+this.progress*this.node.width:this._handlelocalPos.y=-this.node.height*this.node.anchorY+this.progress*this.node.height,this._handle.node.setPosition(this._handlelocalPos))}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),a}(),Oj.Direction=Mj,c((Aj=Fj).prototype,"handle",[bj],Object.getOwnPropertyDescriptor(Aj.prototype,"handle"),Aj.prototype),c(Aj.prototype,"direction",[Sj],Object.getOwnPropertyDescriptor(Aj.prototype,"direction"),Aj.prototype),c(Aj.prototype,"progress",[Tj],Object.getOwnPropertyDescriptor(Aj.prototype,"progress"),Aj.prototype),Cj=c(Aj.prototype,"slideEvents",[Ej],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wj=c(Aj.prototype,"_handle",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rj=c(Aj.prototype,"_direction",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mj.Horizontal}}),kj=c(Aj.prototype,"_progress",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),xj=Aj))||xj)||xj)||xj);cc.SliderComponent=Xj;var jj,qj,Yj,Kj,Qj,Zj,Jj,$j,eq,tq,iq,nq,rq=(Dj=un("cc.ToggleContainerComponent"),Nj=mn(110),zj=vn("UI/ToggleContainer"),Uj=hn({type:uC}),Dj(Gj=Nj(Gj=zj(Gj=pn((Hj=c((Vj=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"checkEvents",Hj,d(d(t))),v(t,"_allowSwitchOff",Wj,d(d(t))),t._toggleItems=[],t}return p(a,Nh),l(a,[{key:"start",value:function(){this._makeAtLeastOneToggleChecked()}},{key:"updateToggles",value:function(t){this.enabledInHierarchy&&t.isChecked&&(this.toggleItems.forEach(function(e){e!==t&&e.isChecked&&e.enabled&&(e.isChecked=!1)}),this.checkEvents&&uC.emitEvents(this.checkEvents,t))}},{key:"addToggle",value:function(e){-1===this._toggleItems.indexOf(e)&&this._toggleItems.push(e),this._allowOnlyOneToggleChecked()}},{key:"removeToggle",value:function(e){var t=this._toggleItems.indexOf(e);-1<t&&this._toggleItems.splice(t,1),this._makeAtLeastOneToggleChecked()}},{key:"_allowOnlyOneToggleChecked",value:function(){var t=!1;return this._toggleItems.forEach(function(e){t&&e.enabled&&(e.isChecked=!1),e.isChecked&&e.enabled&&(t=!0)}),t}},{key:"_makeAtLeastOneToggleChecked",value:function(){this._allowOnlyOneToggleChecked()||this._allowSwitchOff||0<this._toggleItems.length&&(this._toggleItems[0].isChecked=!0)}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this._toggleItems}}]),a}()).prototype,"checkEvents",[Uj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wj=c(Vj.prototype,"_allowSwitchOff",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c(Vj.prototype,"allowSwitchOff",[hn],Object.getOwnPropertyDescriptor(Vj.prototype,"allowSwitchOff"),Vj.prototype),Gj=Vj))||Gj)||Gj)||Gj)||Gj);cc.ToggleContainerComponent=rq;var aq,sq=(jj=un("cc.ToggleComponent"),qj=mn(110),Yj=vn("UI/Toggle"),Kj=hn({type:rq}),Qj=hn({type:rG}),Zj=hn({type:uC}),jj(Jj=qj(Jj=Yj(Jj=pn((c(($j=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return v(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))),"checkEvents",eq,d(d(t))),v(t,"_isChecked",tq,d(d(t))),v(t,"_toggleGroup",iq,d(d(t))),v(t,"_checkMark",nq,d(d(t))),t}return p(a,aG),l(a,[{key:"onEnable",value:function(){_(S(a.prototype),"onEnable",this).call(this),this._registerToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this)}},{key:"onDisable",value:function(){_(S(a.prototype),"onDisable",this).call(this),this._unregisterToggleEvent(),this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.removeToggle(this)}},{key:"toggle",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!this.isChecked,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"check",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!0,e&&e.enabled&&e.updateToggles(this),this._emitToggleEvents())}},{key:"uncheck",value:function(){var e=this.toggleGroup||this._toggleContainer;e&&e.enabled&&this.isChecked&&!e.allowSwitchOff||(this.isChecked=!1,this._emitToggleEvents())}},{key:"_updateCheckMark",value:function(){this._checkMark&&(this._checkMark.node.active=!!this.isChecked)}},{key:"_registerToggleEvent",value:function(){this.node.on("click",this.toggle,this)}},{key:"_unregisterToggleEvent",value:function(){this.node.off("click",this.toggle,this)}},{key:"_emitToggleEvents",value:function(){this.node.emit("toggle",this),this.checkEvents&&uC.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._isChecked!==e&&(this._isChecked=e,this._updateCheckMark())}},{key:"toggleGroup",get:function(){return this._toggleGroup},set:function(e){this._toggleGroup!==e&&(this._toggleGroup&&this._toggleGroup.removeToggle(this),this._toggleGroup=e,this._toggleGroup&&this._toggleGroup.enabled&&this._toggleGroup.addToggle(this))}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){this.node.parent;return null}}]),a}()).prototype,"isChecked",[hn],Object.getOwnPropertyDescriptor($j.prototype,"isChecked"),$j.prototype),c($j.prototype,"toggleGroup",[Kj],Object.getOwnPropertyDescriptor($j.prototype,"toggleGroup"),$j.prototype),c($j.prototype,"checkMark",[Qj],Object.getOwnPropertyDescriptor($j.prototype,"checkMark"),$j.prototype),eq=c($j.prototype,"checkEvents",[Zj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tq=c($j.prototype,"_isChecked",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iq=c($j.prototype,"_toggleGroup",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nq=c($j.prototype,"_checkMark",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jj=$j))||Jj)||Jj)||Jj)||Jj);cc.ToggleComponent=sq;var oq,lq,cq,uq=un("cc.UIModelComponent")(aq=mn(110)(aq=vn("UI/Model")(aq=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._modelComponent=null,t}return p(a,Hz),l(a,[{key:"onLoad",value:function(){this._modelComponent=this.getComponent(cc.RenderableComponent),this._modelComponent._sceneGetter=cc.director.root.ui.getRenderSceneGetter(),this._modelComponent.recreateModel()}},{key:"onDestroy",value:function(){this._modelComponent=this.getComponent(cc.RenderableComponent),this._modelComponent._sceneGetter=null,this._modelComponent.recreateModel()}},{key:"updateAssembler",value:function(e){return!!this._modelComponent&&(e.commitModel.call(e,this,this._modelComponent._getModel(),this._modelComponent.material),!0)}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent){for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterial(t);if(null!=i){for(var n=i.passes,r=i.effectAsset,a=i.technique,s=n.length,o=!1,l=0;l<s;l++){if(!n[l].blendState.targets[0].blend)o=!0,n[l].blendState.targets[0].blend=!0,n[l].overridePipelineStates(r.techniques[a].passes[l],{blendState:n[l].blendState})}o&&i._onPassesChange()}}for(var c=0;c<e;c++){var u=this._modelComponent.getMaterial(c);if(null!=u){var h=u.passes,d=Array.isArray(h),f=0;for(h=d?h:h[Symbol.iterator]();;){var p;if(d){if(f>=h.length)break;p=h[f++]}else{if((f=h.next()).done)break;p=f.value}p._priority=yf.MAX-11}}}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),a}())||aq)||aq)||aq;cc.UIModelComponent=uq;var hq,dq,fq=He.create();(dq=hq||(hq={}))[dq.LOADING=0]="LOADING",dq[dq.LOADED=1]="LOADED",dq[dq.ERROR=2]="ERROR";var pq={devicePixelRatio:!(dq[dq.JS_EVALUATED=3]="JS_EVALUATED"),enableDiv:!1};mo.os===mo.OS_IOS&&(pq.enableDiv=!0),mo.isMobile?mo.browserType===mo.BROWSER_TYPE_FIREFOX&&(pq.enableBG=!0):mo.browserType===mo.BROWSER_TYPE_IE&&(pq.closeHistory=!0);var _q,vq,mq,yq,gq,bq,Sq,Tq,Eq,xq,Aq=un("cc.WebviewImpl")((cq=lq=function(){function n(){y(this,n),this._EventList=new Map,this._visible=!1,this._div=null,this._iframe=null,this._forceUpdate=!0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._w=0,this._h=0,this._eventListeners={load:function(){},error:function(){}}}return l(n,[{key:"createDomElementIfNeeded",value:function(e,t){this._div?this._updateSize(e,t):this._createNativeControl(e,t)}},{key:"removeDom",value:function(){var e=this._div;e&&($t(cc.game.container,e)&&cc.game.container.removeChild(e),this._div=null);var t=this._iframe;if(t){var i=this._eventListeners;t.removeEventListener("load",i.load),t.removeEventListener("error",i.error),i.load=null,i.error=null,this._iframe=null}}},{key:"loadURL",value:function(e){var t=this._iframe;if(t){t.src=e;var i=this;t.addEventListener("load",function e(){i._updateVisibility(),t.removeEventListener("load",e)}),this._dispatchEvent(n.EventType.LOADING)}}},{key:"stopLoading",value:function(){cc.logID(7800)}},{key:"reload",value:function(){var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.location.reload()}}},{key:"canGoBack",value:function(){return cc.logID(7801),!0}},{key:"canGoForward",value:function(){return cc.logID(7802),!0}},{key:"goBack",value:function(){try{if(n.Polyfill.closeHistory)return cc.logID(7803);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.back.call(t)}}catch(e){cc.log(e)}}},{key:"goForward",value:function(){try{if(n.Polyfill.closeHistory)return cc.logID(7804);var e=this._iframe;if(e){var t=e.contentWindow;t&&t.location&&t.history.forward.call(t)}}catch(e){cc.log(e)}}},{key:"evaluateJS",value:function(e){var t=this._iframe;if(t)t.contentWindow}},{key:"setScalesPageToFit",value:function(){cc.logID(7805)}},{key:"setEventListener",value:function(e,t){this._EventList[e]=t}},{key:"removeEventListener",value:function(e){this._EventList[e]=null}},{key:"_dispatchEvent",value:function(e){var t=this._EventList[e];t&&this._iframe&&t.call(this,this,this._iframe.src)}},{key:"destroy",value:function(){this.removeDom()}},{key:"setVisible",value:function(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}},{key:"updateMatrix",value:function(e){if(this._div&&this._visible){e.getWorldMatrix(fq);var t=e.getContentSize();if(this._forceUpdate||this._m00!==fq.m00||this._m01!==fq.m01||this._m04!==fq.m04||this._m05!==fq.m05||this._m12!==fq.m12||this._m13!==fq.m13||this._w!==t.width||this._h!==t.height){this._m00=fq.m00,this._m01=fq.m01,this._m04=fq.m04,this._m05=fq.m05,this._m12=fq.m12,this._m13=fq.m13,this._w=t.width,this._h=t.height;var i=cc.view._scaleX,n=cc.view._scaleY,r=cc.view._devicePixelRatio;i/=r,n/=r;var a=cc.game.container,s=fq.m00*i,o=fq.m01,l=fq.m04,c=fq.m05*n,u=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,h=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0;this._updateSize(this._w,this._h);var d=this._div.clientWidth*i,f=this._div.clientHeight*n,p=e.getAnchorPoint(),_=d*fq.m00*p.x,v=f*fq.m05*p.y,m="matrix("+s+","+-o+","+-l+","+c+","+(fq.m12*i-_+u)+","+-(fq.m13*n-v+h)+")";this._div.style.transform=m,this._div.style["-webkit-transform"]=m,this._div.style["transform-origin"]="0px 100% 0px",this._div.style["-webkit-transform-origin"]="0px 100% 0px";var y=e.getComponent(EU);y&&this._setOpacity(y.color.a)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"loadData",value:function(e,t,i,n){}},{key:"loadHTMLString",value:function(e,t){}},{key:"_updateVisibility",value:function(){if(this._div){var e=this._div;this._visible?e.style.visibility="visible":e.style.visibility="hidden",this._forceUpdate=!0}}},{key:"_updateSize",value:function(e,t){var i=this._div;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"_initEvent",value:function(){var e=this._iframe;if(e){var t=this._eventListeners,i=this;t.load=function(){i._dispatchEvent(n.EventType.LOADED)},t.error=function(){i._dispatchEvent(n.EventType.ERROR)},e.addEventListener("load",t.load),e.addEventListener("error",t.error)}}},{key:"_initStyle",value:function(){if(this._div){var e=this._div;e.style.position="absolute",e.style.bottom="0px",e.style.left="0px"}}},{key:"_setOpacity",value:function(e){var t=this._iframe;t&&t.style&&(t.style.opacity=(e/255).toString())}},{key:"_createDom",value:function(e,t){n.Polyfill.enableDiv?(this._div=document.createElement("div"),this._div.style["-webkit-overflow"]="auto",this._div.style["-webkit-overflow-scrolling"]="touch",this._iframe=document.createElement("iframe"),this._div.appendChild(this._iframe),this._iframe.style.width="100%",this._iframe.style.height="100%"):this._div=this._iframe=document.createElement("iframe"),n.Polyfill.enableBG&&(this._div.style.background="#FFF"),this._div.style.background="#FFF",this._div.style.height=t+"px",this._div.style.width=e+"px",this._div.style.overflow="scroll",this._iframe.style.border="none",cc.game.container.appendChild(this._div),this._updateVisibility()}},{key:"_createNativeControl",value:function(e,t){this._createDom(e,t),this._initStyle(),this._initEvent()}}]),n}(),lq.Polyfill=pq,lq.EventType=hq,oq=cq))||oq,Cq=hq;function wq(){}var Rq,kq,Oq,Fq,Lq,Bq,Mq,Iq,Pq,Dq,Nq,zq,Uq,Gq,Vq,Hq,Wq,Xq,jq,qq,Yq,Kq,Qq,Zq,Jq,$q,eY,tY,iY,nY,rY,aY,sY,oY=(_q=un("cc.WebviewComponent"),vq=vn("UI/WebView"),mq=mn(100),yq=hn({type:uC}),_q(gq=vq(gq=mq((xq=Eq=function(e){function t(){var e;return y(this,t),v(e=T(this,S(t).call(this)),"webviewEvents",Sq,d(d(e))),v(e,"_url",Tq,d(d(e))),e._impl=null,e._impl=new Aq,e}return p(t,Hz),l(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e;var t=this._impl;t&&t.loadURL(e)}}]),l(t,[{key:"onRestore",value:function(){this._impl||(this._impl=new Aq)}},{key:"onEnable",value:function(){if(this._impl){var e=this._impl;e.createDomElementIfNeeded(this.node.width,this.node.height),e.loadURL(this._url),e.setVisible(!0),e.setEventListener(Cq.LOADED,this._onWebViewLoaded.bind(this)),e.setEventListener(Cq.LOADING,this._onWebViewLoading.bind(this)),e.setEventListener(Cq.ERROR,this._onWebViewLoadError.bind(this))}}},{key:"onDisable",value:function(){if(this._impl){var e=this._impl;e.setVisible(!1),e.setEventListener(Cq.LOADED,wq),e.setEventListener(Cq.LOADING,wq),e.setEventListener(Cq.ERROR,wq)}}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.updateMatrix(this.node)}},{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"_onWebViewLoaded",value:function(){uC.emitEvents(this.webviewEvents,this,Cq.LOADED),this.node.emit("loaded",this)}},{key:"_onWebViewLoading",value:function(){return uC.emitEvents(this.webviewEvents,this,Cq.LOADING),this.node.emit("loading",this),!0}},{key:"_onWebViewLoadError",value:function(){uC.emitEvents(this.webviewEvents,this,Cq.ERROR),this.node.emit("error",this)}}]),t}(),Eq.EventType=Cq,c((bq=xq).prototype,"url",[hn],Object.getOwnPropertyDescriptor(bq.prototype,"url"),bq.prototype),Sq=c(bq.prototype,"webviewEvents",[yq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tq=c(bq.prototype,"_url",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gq=bq))||gq)||gq)||gq);cc.WebviewComponent=oY,(rY=nY||(nY={}))[rY.ONCE=0]="ONCE",rY[rY.ALWAYS=1]="ALWAYS",si(nY),(sY=aY||(aY={}))[sY.TOP=1]="TOP",sY[sY.MID=2]="MID",sY[sY.BOT=4]="BOT",sY[sY.LEFT=8]="LEFT",sY[sY.CENTER=16]="CENTER",sY[sY.RIGHT=32]="RIGHT",sY[sY.HORIZONTAL=56]="HORIZONTAL",sY[sY.VERTICAL=7]="VERTICAL";var lY=aY.TOP|aY.BOT,cY=aY.LEFT|aY.RIGHT,uY=(Rq=un("cc.WidgetComponent"),kq=mn(110),Oq=vn("UI/Widget"),Fq=_n(mz),Lq=hn({type:bd}),Bq=hn({visible:!1}),Mq=hn({visible:!1}),Iq=hn({type:nY}),Rq(Pq=kq(Pq=Oq(Pq=Fq(Pq=pn((iY=tY=function(e){function a(){var e,t;y(this,a);for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=T(this,(e=S(a)).call.apply(e,[this].concat(n))))._lastPos=new Br,t._lastSize=new zr,t._dirty=!0,v(t,"_alignFlags",Nq,d(d(t))),v(t,"_target",zq,d(d(t))),v(t,"_left",Uq,d(d(t))),v(t,"_right",Gq,d(d(t))),v(t,"_top",Vq,d(d(t))),v(t,"_bottom",Hq,d(d(t))),v(t,"_horizontalCenter",Wq,d(d(t))),v(t,"_verticalCenter",Xq,d(d(t))),v(t,"_isAbsLeft",jq,d(d(t))),v(t,"_isAbsRight",qq,d(d(t))),v(t,"_isAbsTop",Yq,d(d(t))),v(t,"_isAbsBottom",Kq,d(d(t))),v(t,"_isAbsHorizontalCenter",Qq,d(d(t))),v(t,"_isAbsVerticalCenter",Zq,d(d(t))),v(t,"_originalWidth",Jq,d(d(t))),v(t,"_originalHeight",$q,d(d(t))),v(t,"_alignMode",eY,d(d(t))),t}return p(a,Nh),l(a,[{key:"updateAlignment",value:function(){cc._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this.node.getContentSize(this._lastSize),cc._widgetManager.add(this),this._registerTargetEvents()}},{key:"update",value:function(){this._dirty||this.node.hasChanged&&this._recursiveDirty()}},{key:"onDisable",value:function(){cc._widgetManager.remove(this),this._unregisterTargetEvents()}},{key:"_aotuChangedValue",value:function(e,t){if(0<(this._alignFlags&e)&&this.node.parent&&this.node.parent.uiTransfromComp){var i=this.node.parent.getContentSize();this.isAlignLeft&&e===aY.LEFT?this._left=t?this._left*i.width:this._left/i.width:this.isAlignRight&&e===aY.RIGHT?this._right=t?this._right*i.width:this._right/i.width:this.isAlignHorizontalCenter&&e===aY.CENTER?this._horizontalCenter=t?this._horizontalCenter*i.width:this._horizontalCenter/i.width:this.isAlignTop&&e===aY.TOP?this._top=t?this._top*i.height:this._top/i.height:this.isAlignBottom&&e===aY.BOT?this._bottom=t?this._bottom*i.height:this._bottom/i.height:this.isAbsoluteVerticalCenter&&e===aY.MID&&(this._verticalCenter=t?this._verticalCenter*i.height:this._verticalCenter/i.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){this._target&&(this._target.on(Kt.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),this._target.on(Kt.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterTargetEvents",value:function(){this._target&&(this._target.off(Kt.SystemEventType.TRANSFORM_CHANGED,this._targetChangedOperation,this),this._target.off(Kt.SystemEventType.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==0<(this._alignFlags&e)){var i=0<(e&cY);t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=this.node.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=this.node.height))):(i?this.isStretchWidth&&(this.node.width=this._originalWidth):this.isStretchHeight&&(this.node.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||this.node.getComponentsInChildren(a).forEach(function(e){e._dirty=!0})}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return 0<(this._alignFlags&aY.TOP)},set:function(e){this._setAlign(aY.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return 0<(this._alignFlags&aY.BOT)},set:function(e){this._setAlign(aY.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return 0<(this._alignFlags&aY.LEFT)},set:function(e){this._setAlign(aY.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return 0<(this._alignFlags&aY.RIGHT)},set:function(e){this._setAlign(aY.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return 0<(this._alignFlags&aY.MID)},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=aY.MID):this._alignFlags&=~aY.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return 0<(this._alignFlags&aY.CENTER)},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=aY.CENTER):this._alignFlags&=~aY.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&cY)===cY}},{key:"isStretchHeight",get:function(){return(this._alignFlags&lY)===lY}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._aotuChangedValue(aY.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._aotuChangedValue(aY.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._aotuChangedValue(aY.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._aotuChangedValue(aY.RIGHT,this._isAbsRight))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._aotuChangedValue(aY.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._aotuChangedValue(aY.MID,this._isAbsVerticalCenter))}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),a}(),tY.AlignMode=nY,c((Dq=iY).prototype,"target",[Lq],Object.getOwnPropertyDescriptor(Dq.prototype,"target"),Dq.prototype),c(Dq.prototype,"isAlignTop",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignTop"),Dq.prototype),c(Dq.prototype,"isAlignBottom",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignBottom"),Dq.prototype),c(Dq.prototype,"isAlignLeft",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignLeft"),Dq.prototype),c(Dq.prototype,"isAlignRight",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignRight"),Dq.prototype),c(Dq.prototype,"isAlignVerticalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignVerticalCenter"),Dq.prototype),c(Dq.prototype,"isAlignHorizontalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAlignHorizontalCenter"),Dq.prototype),c(Dq.prototype,"isStretchWidth",[Bq],Object.getOwnPropertyDescriptor(Dq.prototype,"isStretchWidth"),Dq.prototype),c(Dq.prototype,"isStretchHeight",[Mq],Object.getOwnPropertyDescriptor(Dq.prototype,"isStretchHeight"),Dq.prototype),c(Dq.prototype,"top",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"top"),Dq.prototype),c(Dq.prototype,"bottom",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"bottom"),Dq.prototype),c(Dq.prototype,"left",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"left"),Dq.prototype),c(Dq.prototype,"right",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"right"),Dq.prototype),c(Dq.prototype,"horizontalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"horizontalCenter"),Dq.prototype),c(Dq.prototype,"verticalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"verticalCenter"),Dq.prototype),c(Dq.prototype,"isAbsoluteTop",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteTop"),Dq.prototype),c(Dq.prototype,"isAbsoluteBottom",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteBottom"),Dq.prototype),c(Dq.prototype,"isAbsoluteLeft",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteLeft"),Dq.prototype),c(Dq.prototype,"isAbsoluteRight",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteRight"),Dq.prototype),c(Dq.prototype,"alignMode",[Iq],Object.getOwnPropertyDescriptor(Dq.prototype,"alignMode"),Dq.prototype),c(Dq.prototype,"isAbsoluteHorizontalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteHorizontalCenter"),Dq.prototype),c(Dq.prototype,"isAbsoluteVerticalCenter",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"isAbsoluteVerticalCenter"),Dq.prototype),c(Dq.prototype,"alignFlags",[hn],Object.getOwnPropertyDescriptor(Dq.prototype,"alignFlags"),Dq.prototype),Nq=c(Dq.prototype,"_alignFlags",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zq=c(Dq.prototype,"_target",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uq=c(Dq.prototype,"_left",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gq=c(Dq.prototype,"_right",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vq=c(Dq.prototype,"_top",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hq=c(Dq.prototype,"_bottom",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wq=c(Dq.prototype,"_horizontalCenter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xq=c(Dq.prototype,"_verticalCenter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jq=c(Dq.prototype,"_isAbsLeft",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qq=c(Dq.prototype,"_isAbsRight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yq=c(Dq.prototype,"_isAbsTop",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Kq=c(Dq.prototype,"_isAbsBottom",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qq=c(Dq.prototype,"_isAbsHorizontalCenter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Zq=c(Dq.prototype,"_isAbsVerticalCenter",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jq=c(Dq.prototype,"_originalWidth",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$q=c(Dq.prototype,"_originalHeight",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eY=c(Dq.prototype,"_alignMode",[hn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nY.ALWAYS}}),Pq=Dq))||Pq)||Pq)||Pq)||Pq)||Pq);cc.WidgetComponent=uY;var hY=new Br,dY=new Br,fY=new Lr;function pY(e){return e instanceof cc.Scene?cc.visibleRect:e.getContentSize()}function _Y(e,t,i,n){for(var r=e.parent?e.parent.getScale():dY,a=r.x,s=r.y,o=0,l=0,c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var u=c.getPosition();if(o+=u.x,l+=u.y,(c=c.parent)===t)break;var h=(r=c?c.getScale():dY).x,d=r.y;o*=h,l*=d,a*=h,s*=d}n.x=0!==a?1/a:1,n.y=0!==s?1/s:1,i.x=-o,i.y=-l}var vY=new Br,mY=new Br(1,1,1);function yY(e,t){var i,n=t.target,r=vY,a=mY;n?_Y(e,i=n,r,a):i=e.parent;var s=pY(i),o=i instanceof cc.Scene,l=o?fY:i.getAnchorPoint(),c=o;e.getPosition(hY);var u=hY.x,h=hY.y,d=e.getAnchorPoint(),f=e.getScale();if(t.alignFlags&aY.HORIZONTAL){var p=0,_=0,v=s.width;_=c?(p=cc.visibleRect.left.x,cc.visibleRect.right.x):(p=-l.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,_-=t.isAbsoluteRight?t.right:t.right*v,n&&(p+=r.x,p*=a.x,_+=r.x,_*=a.x);var m=0,y=d.x,g=f.x;if(g<0&&(y=1-y,g=-g),t.isStretchWidth)m=_-p,0!==g&&(e.width=m/g),u=p+y*m;else if(m=e.width*g,t.isAlignHorizontalCenter){var b=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,S=(.5-l.x)*s.width;n&&(b*=a.x,S+=r.x,S*=a.x),u=S+(y-.5)*m+b}else u=t.isAlignLeft?p+y*m:_+(y-1)*m}if(t.alignFlags&aY.VERTICAL){var T=0,E=0,x=s.height;T=c?(E=cc.visibleRect.bottom.y,cc.visibleRect.top.y):(E=-l.y*x)+x,E+=t.isAbsoluteBottom?t.bottom:t.bottom*x,T-=t.isAbsoluteTop?t.top:t.top*x,n&&(E+=r.y,E*=a.y,T+=r.y,T*=a.y);var A=0,C=d.y,w=f.y;if(w<0&&(C=1-C,w=-w),t.isStretchHeight)A=T-E,0!==w&&(e.height=A/w),h=E+C*A;else if(A=e.height*w,t.isAlignVerticalCenter){var R=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*x,k=(.5-l.y)*s.height;n&&(R*=a.y,k+=r.y,k*=a.y),h=k+(C-.5)*A+R}else h=t.isAlignBottom?E+C*A:T+(C-1)*A}e.setPosition(u,h,hY.z),Oe.set(t._lastPos,u,h,hY.z)}function gY(){var e=cc.director.getScene();if(e){if(xY.isAligning=!0,xY._nodesOrderDirty)TY.length=0,function e(t){var i=t.getComponent(uY);i&&(yY(t,i),i.alignMode!==nY.ALWAYS?i.enabled=!1:TY.push(i));var n=t.children,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=s;o.active&&e(o)}}(e),xY._nodesOrderDirty=!1;else{var t=null,i=xY._activeWidgetsIterator;for(i.i=0;i.i<TY.length;++i.i)(t=TY[i.i])._dirty&&(yY(t.node,t),t._dirty=!1)}xY.isAligning=!1}}function bY(e){if(e===Kt.SystemEventType.POSITION_PART&&!xY.isAligning){var t=this,i=t.node.getPosition(),n=this._lastPos,r=i.sub(n);n.set(i);var a=t.node.parent,s=new Br(1,1,1);t.target&&(a=t.target,_Y(t.node,a,new Br,s));var o=pY(a),l=new Br;0!==o.width&&0!==o.height&&Oe.set(l,r.x/o.width,r.y/o.height,l.z),t.isAlignTop&&(t.top-=(t.isAbsoluteTop?r.y:l.y)*s.y),t.isAlignBottom&&(t.bottom+=(t.isAbsoluteBottom?r.y:l.y)*s.y),t.isAlignLeft&&(t.left+=(t.isAbsoluteLeft?r.x:l.x)*s.x),t.isAlignRight&&(t.right-=(t.isAbsoluteRight?r.x:l.x)*s.x),t.isAlignHorizontalCenter&&(t.horizontalCenter+=(t.isAbsoluteHorizontalCenter?r.x:l.x)*s.x),t.isAlignVerticalCenter&&(t.verticalCenter+=(t.isAbsoluteVerticalCenter?r.y:l.y)*s.y)}}function SY(){if(!xY.isAligning){this.setDirty();var e=this,t=e.node.getContentSize(),i=this._lastSize,n=new Br(t.width-i.width,t.height-i.height,0);i.set(t);var r=e.node.parent,a=new Br(1,1,1);e.target&&(r=e.target,_Y(e.node,r,new Br,a));var s=pY(r),o=new Br;0!==s.width&&0!==s.height&&Oe.set(o,n.x/s.width,n.y/s.height,o.z);var l=e.node.getAnchorPoint();e.isAlignTop&&(e.top-=(e.isAbsoluteTop?n.y:o.y)*(1-l.y)*a.y),e.isAlignBottom&&(e.bottom-=(e.isAbsoluteBottom?n.y:o.y)*l.y*a.y),e.isAlignLeft&&(e.left-=(e.isAbsoluteLeft?n.x:o.x)*l.x*a.x),e.isAlignRight&&(e.right-=(e.isAbsoluteRight?n.x:o.x)*(1-l.x)*a.x)}}var TY=[];var EY=[],xY=cc._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Dt.MutableForwardIterator(TY),animationState:null,init:function(e){e.on(cc.Director.EVENT_AFTER_UPDATE,gY),cc.sys.isMobile?window.addEventListener("resize",this.onResized.bind(this)):cc.view.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=e.node.getComponent(EU);if(t){var i=cc.director.root.ui.getScreen(t.visibility);i&&-1===EY.indexOf(i)&&(EY.push(i),i.node.on("design-resolution-changed",this.onResized,this))}e.node.on(Kt.SystemEventType.TRANSFORM_CHANGED,bY,e),e.node.on(Kt.SystemEventType.SIZE_CHANGED,SY,e)},remove:function(e){this._activeWidgetsIterator.remove(e),e.node.off(Kt.SystemEventType.TRANSFORM_CHANGED,bY,e),e.node.off(Kt.SystemEventType.SIZE_CHANGED,SY,e)},onResized:function(){var e=cc.director.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(bd.isNode(e)){var t=e.getComponent(uY);if(t&&t.alignFlags===nY.ALWAYS)return}var i=e.children,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a;this.refreshWidgetOnResized(s)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return 1e-10<Math.abs(e-t)?t:e}var n=e.node,r=n.parent;if(r){var a=new Br,s=new Br(1,1,1);if(e.target&&_Y(n,r=e.target,a,s),!t)return;var o=r.getAnchorPoint(),l=pY(r),c=n.getAnchorPoint(),u=n.getPosition(),h=aY,d=n.getScale(),f=0;if(t&h.LEFT){var p=-o.x*l.width;p+=a.x,p*=s.x,f=u.x-c.x*n.width*d.x-p,e.isAbsoluteLeft||(f/=l.width),f/=s.x,e.left=i(e.left,f)}if(t&h.RIGHT){var _=(1-o.x)*l.width;_+=a.x,f=(_*=s.x)-(u.x+(1-c.x)*n.width*d.x),e.isAbsoluteRight||(f/=l.width),f/=s.x,e.right=i(e.right,f)}if(t&h.TOP){var v=(1-o.y)*l.height;v+=a.y,f=(v*=s.y)-(u.y+(1-c.y)*n.height*d.y),e.isAbsoluteTop||(f/=l.height),f/=s.y,e.top=i(e.top,f)}if(t&h.BOT){var m=-o.y*l.height;m+=a.y,m*=s.y,f=u.y-c.y*n.height*d.y-m,e.isAbsoluteBottom||(f/=l.height),f/=s.y,e.bottom=i(e.bottom,f)}}},updateAlignment:function e(t){var i=t.parent;i&&bd.isNode(i)&&e(i);var n=t.getComponent(uY);n&&i&&yY(t,n)},AlignMode:nY,AlignFlags:aY},AY=[{name:Kt.GFXAttributeName.ATTR_POSITION,format:Kt.GFXFormat.RGB32F},{name:Kt.GFXAttributeName.ATTR_TEX_COORD,format:Kt.GFXFormat.RG32F},{name:Kt.GFXAttributeName.ATTR_COLOR,format:Kt.GFXFormat.RGBA32F}],CY=Object.freeze({vfmt:AY}),wY=function e(t,i,n){y(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=i,this.y=n};function RY(e,t,i,n,r){var a=0,s=null;if(r===0<function(e,t,i,n){for(var r=0,a=t,s=i-n;a<i;a+=n)r+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return r}(e,t,i,n))for(a=t;a<i;a+=n)s=XY(a,e[a],e[a+1],s);else for(a=i-n;t<=a;a-=n)s=XY(a,e[a],e[a+1],s);return s&&GY(s,s.next)&&(jY(s),s=s.next),s}function kY(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!GY(i,i.next)&&0!==UY(i.prev,i,i.next))i=i.next;else{if(jY(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function OY(e,t,i,n,r,a){var s=6<arguments.length&&void 0!==arguments[6]?arguments[6]:0;if(e){!s&&a&&function(e,t,i,n){var r=e;for(;null===r.z&&(r.z=DY(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==e;);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,s=0,o=0,l=0,c=1;do{for(i=e,a=e=null,s=0;i;){for(s++,n=i,t=o=0;t<c&&(o++,n=n.nextZ);t++);for(l=c;0<o||0<l&&n;)0===o?(n=(r=n).nextZ,l--):0!==l&&n?i.z<=n.z?(i=(r=i).nextZ,o--):(n=(r=n).nextZ,l--):(i=(r=i).nextZ,o--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,c*=2}while(1<s)}(r)}(e,n,r,a);for(var o=e,l=null,c=null;e.prev!==e.next;)if(l=e.prev,c=e.next,a?LY(e,n,r,a):FY(e))t.push(l.i/i),t.push(e.i/i),t.push(c.i/i),jY(e),e=c.next,o=c.next;else if((e=c)===o){s?1===s?OY(e=BY(e,t,i),t,i,n,r,a,2):2===s&&MY(e,t,i,n,r,a):OY(kY(e),t,i,n,r,a,1);break}}}function FY(e){var t=e.prev,i=e,n=e.next;if(0<=UY(t,i,n))return!1;for(var r=e.next.next;r!==e.prev;){if(zY(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=UY(r.prev,r,r.next))return!1;r=r.next}return!0}function LY(e,t,i,n){var r=e.prev,a=e,s=e.next;if(0<=UY(r,a,s))return!1;for(var o=r.x<a.x?r.x<s.x?r.x:s.x:a.x<s.x?a.x:s.x,l=r.y<a.y?r.y<s.y?r.y:s.y:a.y<s.y?a.y:s.y,c=r.x>a.x?r.x>s.x?r.x:s.x:a.x>s.x?a.x:s.x,u=r.y>a.y?r.y>s.y?r.y:s.y:a.y>s.y?a.y:s.y,h=DY(o,l,t,i,n),d=DY(c,u,t,i,n),f=e.nextZ;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&zY(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=UY(f.prev,f,f.next))return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&zY(r.x,r.y,a.x,a.y,s.x,s.y,f.x,f.y)&&0<=UY(f.prev,f,f.next))return!1;f=f.prevZ}return!0}function BY(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!GY(r,a)&&VY(r,n,n.next,a)&&HY(r,a)&&HY(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),jY(n),jY(n.next),n=e=a),n=n.next}while(n!==e);return n}function MY(e,t,i,n,r,a){var s,o,l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.i!==c.i&&(o=c,(s=l).next.i!==o.i&&s.prev.i!==o.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&VY(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(s,o)&&HY(s,o)&&HY(o,s)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;for(;i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==e;);return n}(s,o))){var u=WY(l,c);return l=kY(l,l.next),u=kY(u,u.next),OY(l,t,i,n,r,a),void OY(u,t,i,n,r,a)}c=c.next}l=l.next}while(l!==e)}function IY(e,t){return e.x-t.x}function PY(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,s=null;do{if(r<=i.y&&r>=i.next.y){var o=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&a<o){if((a=o)===n){if(r===i.y)return i;if(r===i.next.y)return i.next}s=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!s)return null;if(n===a)return s.prev;var l,c=s,u=s.x,h=s.y,d=1/0;i=s.next;for(;i!==c;)n>=i.x&&i.x>=u&&zY(r<h?n:a,r,u,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<d||l===d&&i.x>s.x)&&HY(i,e)&&(s=i,d=l),i=i.next;return s}(e,t)){var i=WY(t,e);kY(i,i.next)}}function DY(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function NY(e){for(var t=e,i=e;t.x<i.x&&(i=t),(t=t.next)!==e;);return i}function zY(e,t,i,n,r,a,s,o){return 0<=(r-s)*(t-o)-(e-s)*(a-o)&&0<=(e-s)*(n-o)-(i-s)*(t-o)&&0<=(i-s)*(a-o)-(r-s)*(n-o)}function UY(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function GY(e,t){return e.x===t.x&&e.y===t.y}function VY(e,t,i,n){return!!(GY(e,t)&&GY(i,n)||GY(e,n)&&GY(i,t))||0<UY(e,t,i)!=0<UY(e,t,n)&&0<UY(i,n,e)!=0<UY(i,n,t)}function HY(e,t){return UY(e.prev,e,e.next)<0?0<=UY(e,t,e.next)&&0<=UY(e,e.prev,t):UY(e,t,e.prev)<0||UY(e,e.next,t)<0}function WY(e,t){var i=new wY(e.i,e.x,e.y),n=new wY(t.i,t.x,t.y),r=e.next,a=t.prev;return(e.next=t).prev=e,(i.next=r).prev=i,(n.next=i).prev=n,(a.next=n).prev=a,n}function XY(e,t,i,n){var r=new wY(e,t,i);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function jY(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function qY(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=RY(e,0,r,i,!0),s=[];if(!a)return s;var o=0,l=0,c=0,u=0,h=0,d=0,f=0;if(n&&(a=function(e,t,i,n){var r,a=[],s=0,o=null;for(s=0,r=t.length;s<r;s++)(o=RY(e,t[s]*n,s<r-1?t[s+1]*n:e.length,n,!1))&&(o===o.next&&(o.steiner=!0),a.push(NY(o)));if(a.sort(IY),!i)return i;for(s=0;s<a.length;s++)PY(a[s],i),i=kY(i,i.next);return i}(e,t,a,i)),e.length>80*i){o=c=e[0],l=u=e[1];for(var p=i;p<r;p+=i)(h=e[p])<o&&(o=h),(d=e[p+1])<l&&(l=d),c<h&&(c=h),u<d&&(u=d);f=Math.max(c-o,u-l)}return OY(a,s,i,o,l,f),s}var YY=Math.PI,KY=Math.min,QY=Math.max,ZY=Math.cos,JY=Math.sin,$Y=Math.abs,eK=Math.sign,tK=.5522847493;function iK(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*tK,t-n*tK,i+r,t,i+r),e.bezierCurveTo(t+n*tK,i+r,t+n,i+r*tK,t+n,i),e.bezierCurveTo(t+n,i-r*tK,t+n*tK,i-r,t,i-r),e.bezierCurveTo(t-n*tK,i-r,t-n,i-r*tK,t-n,i),e.close()}for(var nK=function(e){function n(e,t){var i;return y(this,n),(i=T(this,S(n).call(this,e,t))).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return p(n,Lr),l(n,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),n}(),rK=function(){function e(){y(this,e),this.closed=!1,this.nbevel=0,this.complex=!0,this.points=[],this.reset()}return l(e,[{key:"reset",value:function(){this.closed=!1,this.nbevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),aK=function(){function e(){y(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Hr.WHITE,this.lineCap=FH.BUTT,this.strokeColor=Hr.BLACK,this.lineJoin=BH.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandx=0,this._commandy=0,this._points=[],this._renderDatasPool=new lv(function(){return new jz},16),this._renderDatas=[],this._curPath=null}return l(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,IH.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,IH.PT_CORNER),this._commandx=e,this._commandy=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var s=this._curPath,o=s.points[s.points.length-1];o&&(o.x!==e||o.y!==t||i!==r||n!==a?(!function e(t,i,n,r,a,s,o,l,c,u,h){var d,f,p,_,v,m,y,g,b,S,T,E,x,A,C,w;10<u||(v=.5*(s+l),m=.5*(o+c),y=.5*((d=.5*(i+r))+(p=.5*(r+s))),g=.5*((f=.5*(n+a))+(_=.5*(a+o))),((C=$Y((r-l)*(A=c-n)-(a-c)*(x=l-i)))+(w=$Y((s-l)*A-(o-c)*x)))*(C+w)<t.tessTol*(x*x+A*A)?t.addPoint(l,c,0===h?h|IH.PT_BEVEL:h):(e(t,i,n,d,f,y,g,T=.5*(y+(b=.5*(p+v))),E=.5*(g+(S=.5*(_+m))),u+1,0),e(t,T,E,b,S,v,m,l,c,u+1,h)))}(this,o.x,o.y,e,t,i,n,r,a,0,IH.PT_CORNER),this._commandx=r,this._commandy=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandx,a=this._commandy;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,s){var o,l,c=0,u=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=0,g=0,b=0,S=0,T=0;if(u=a-r,s=s||!1)if($Y(u)>=2*YY)u=2*YY;else for(;u<0;)u+=2*YY;else if($Y(u)>=2*YY)u=2*-YY;else for(;0<u;)u-=2*YY;for(l=0|QY(1,KY($Y(u)/(.5*YY)+.5,5)),h=$Y(4/3*(1-ZY(o=u/l/2))/JY(o)),s||(h=-h),T=0;T<=l;T++)p=t+(d=ZY(c=r+u*(T/l)))*n,_=i+(f=JY(c))*n,v=-f*n*h,m=d*n*h,0===T?e.moveTo(p,_):e.bezierCurveTo(y+b,g+S,p-v,_-m,p,_),y=p,g=_,b=v,S=m}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){iK(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){iK(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var s=KY(a,.5*$Y(n))*eK(n),o=KY(a,.5*$Y(r))*eK(r);e.moveTo(t,i+o),e.lineTo(t,i+r-o),e.bezierCurveTo(t,i+r-o*(1-tK),t+s*(1-tK),i+r,t+s,i+r),e.lineTo(t+n-s,i+r),e.bezierCurveTo(t+n-s*(1-tK),i+r,t+n,i+r-o*(1-tK),t+n,i+r-o),e.lineTo(t+n,i+o),e.bezierCurveTo(t+n,i+o*(1-tK),t+n-s*(1-tK),i,t+n-s,i),e.lineTo(t+s,i),e.bezierCurveTo(t+s*(1-tK),i,t,i+o*(1-tK),t,i+o),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0,this._renderDatasPool.reset();for(var e=this._renderDatas,t=0,i=e.length;t<i;t++){var n=e[t];n&&n.reset()}}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDatasPool.add();return this._renderDatas.push(e),e}},{key:"getRenderDatas",value:function(){return 0===this._renderDatas.length&&this.requestRenderData(),this._renderDatas}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,s=r[this.pointsOffset++];s?(s.x=e,s.y=t):(s=new nK(e,t),r.push(s)),s.flags=i,a.push(s)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new rK,this.paths.push(t)),this.pathLength++,this._curPath=t}}]),e}(),sK=Math.PI,oK=Math.min,lK=Math.max,cK=Math.ceil,uK=Math.acos,hK=Math.cos,dK=Math.sin,fK=Math.atan2,pK=AY,_K=[],vK=[],mK=[],yK=[],gK=null,bK=null,SK=new Hr,TK=[],EK=0;EK<4;EK++)TK.push(new Br);function xK(e,t,i){return e<t?t:i<e?i:e}var AK={useModel:!0,createImpl:function(e){return new aK},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderDatas():[],i=0,n=t.length;i<n;i++)t[i].material=e.material},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!bK)return null;var i=bK.getRenderDatas(),n=i[bK.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(65535<a||131070<3*a)&&(++bK.dataOffset,bK.dataOffset<i.length?n=i[bK.dataOffset]:(n=bK.requestRenderData(),i[bK.dataOffset]=n),n.material=e.material,r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){je.copy(SK,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){je.copy(SK,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=cc.director.root.ui.renderScene;e.model&&(e.model.destroy(),t.destroyModel(e.model),e.model=null);var i=e.impl,n=Kt.GFXPrimitiveMode.TRIANGLE_LIST,r=i&&i.getRenderDatas();r||(r=[]);var a=0;_K.length=0,vK.length=0,mK.length=0,yK.length=0;var s=r,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c,h=u.byteCount>>2,d=u.vData;for(a=0;a<h;)_K.push(d[a++]),_K.push(d[a++]),_K.push(d[a++]),vK.push(d[a++]),vK.push(d[a++]),mK.push(d[a++]),mK.push(d[a++]),mK.push(d[a++]),mK.push(d[a++]);h=u.indiceCount;var f=u.iData;for(a=0;a<h;)yK.push(f[a++])}var p=Xg({primitiveMode:n,positions:_K,uvs:vK,colors:mK,attributes:pK,indices:yK},void 0,{calculateBounds:!1});e.model=t.createModel(Bv,e.node),e.model.initSubModel(0,p.getSubMesh(0),e.material),e.model.enabled=!0},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(bK=e.impl){var a,s,o,l,c=(a=t,s=sK,o=bK.tessTol,l=2*uK(a/(a+o)),lK(2,cK(s/l)));this._calculateJoins(bK,t,n,r);for(var u=bK.paths,h=0,d=bK.pathOffset,f=bK.pathLength;d<f;d++){var p=u[d],_=p.points.length;n===BH.ROUND?h+=2*(_+p.nbevel*(c+2)+1):h+=2*(_+5*p.nbevel+1),p.closed||(i===FH.ROUND?h+=2*(2*c+2):h+=12)}var v=gK=this.getRenderData(e,h);if(v){for(var m=v.vData,y=v.iData,g=bK.pathOffset,b=bK.pathLength;g<b;g++){var S=u[g],T=S.points,E=T.length,x=v.vertexStart,A=void 0,C=void 0,w=0,R=0,k=S.closed;if(R=k?(A=T[E-1],C=T[0],w=0,E):(A=T[0],C=T[1],E-(w=1)),!k){var O=C.sub(A);O.normalizeSelf();var F=O.x,L=O.y;i===FH.BUTT?this._buttCap(A,F,L,t,0):i===FH.SQUARE?this._buttCap(A,F,L,t,t):i===FH.ROUND&&this._roundCapStart(A,F,L,t,c)}for(var B=w;B<R;++B)n===BH.ROUND?this._roundJoin(A,C,t,t,c):0!=(C.flags&(IH.PT_BEVEL|IH.PT_INNERBEVEL))?this._bevelJoin(A,C,t,t):(this._vset(C.x+C.dmx*t,C.y+C.dmy*t),this._vset(C.x-C.dmx*t,C.y-C.dmy*t)),A=C,C=T[B+1];if(k){var M=9*x,I=m.slice(M,M+9);m.set(I,9*v.vertexStart),M+=9,v.vertexStart++,I=m.slice(M,M+9),m.set(I,9*v.vertexStart),v.vertexStart++}else{var P=C.sub(A);P.normalizeSelf();var D=P.x,N=P.y;i===FH.BUTT?this._buttCap(C,D,N,t,0):i===FH.SQUARE?this._buttCap(C,D,N,t,t):i===FH.ROUND&&this._roundCapEnd(C,D,N,t,c)}for(var z=v.indiceStart,U=x+2,G=v.vertexStart;U<G;U++)y[z++]=U-2,y[z++]=U-1,y[z++]=U;if((v.indiceStart=z)!==v.indiceCount){var V=new Array(v.indiceCount-z);v.iData.set(V,z)}}bK=gK=null}}},_expandFill:function(e){if(bK=e.impl){for(var t=bK.paths,i=0,n=bK.pathOffset,r=bK.pathLength;n<r;n++){i+=t[n].points.length}var a=gK=this.getRenderData(e,i);if(a){for(var s=a,o=s.vData,l=s.iData,c=bK.pathOffset,u=bK.pathLength;c<u;c++){var h=t[c],d=h.points,f=d.length;if(0!==f){for(var p=a.vertexStart,_=0;_<f;++_)this._vset(d[_].x,d[_].y);var v=a.indiceStart;if(h.complex){for(var m=[],y=p,g=a.vertexStart;y<g;y++){var b=9*y;m.push(o[b++]),m.push(o[b++]),m.push(o[b++])}var S=qY(m,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)l[v++]=S[T]+p}else for(var x=p,A=p+2,C=s.vertexStart;A<C;A++)l[v++]=x,l[v++]=A-1,l[v++]=A;if((s.indiceStart=v)!==s.indiceCount){var w=new Array(s.indiceCount-v);s.iData.set(w,v)}}}bK=gK=null}}},_calculateJoins:function(e,t,i,n){var r=0;0<t&&(r=1/t);for(var a=e.paths,s=e.pathOffset,o=e.pathLength;s<o;s++)for(var l=a[s],c=l.points,u=c.length,h=c[u-1],d=c[0],f=l.nbevel=0;f<u;f++){var p,_,v=h.dy,m=-h.dx,y=d.dy,g=-d.dx;if(d.dmx=.5*(v+y),d.dmy=.5*(m+g),1e-6<(p=d.dmx*d.dmx+d.dmy*d.dmy)){var b=1/p;600<b&&(b=600),d.dmx*=b,d.dmy*=b}0<d.dx*h.dy-h.dx*d.dy&&(d.flags|=IH.PT_LEFT),p*(_=lK(11,oK(h.len,d.len)*r))*_<1&&(d.flags|=IH.PT_INNERBEVEL),d.flags&IH.PT_CORNER&&(p*n*n<1||i===BH.BEVEL||i===BH.ROUND)&&(d.flags|=IH.PT_BEVEL),0!=(d.flags&(IH.PT_BEVEL|IH.PT_INNERBEVEL))&&l.nbevel++,h=d,d=c[f+1]}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,s=a[a.length-1],o=a[0];s.equals(o)&&(r.closed=!0,a.pop(),s=a[a.length-1]);for(var l=0,c=a.length;l<c;l++){var u=o.sub(s);s.len=u.mag(),(u.x||u.y)&&u.normalizeSelf(),s.dx=u.x,s.dy=u.y,s=o,o=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,s=0,o=0,l=0,c=0;return 0!==e?(s=r+t.dy*n,o=a-t.dx*n,l=r+i.dy*n,c=a-i.dx*n):(s=l=r+i.dmx*n,o=c=a+i.dmy*n),[s,o,l,c]},_buttCap:function(e,t,i,n,r){var a=e.x-t*r,s=e.y-i*r,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,s=e.y,o=i,l=-t,c=0;c<r;c++){var u=c/(r-1)*sK,h=hK(u)*n,d=dK(u)*n;this._vset(a-o*h-t*d,s-l*h-i*d),this._vset(a,s)}this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,s=e.y,o=i,l=-t;this._vset(a+o*n,s+l*n),this._vset(a-o*n,s-l*n);for(var c=0;c<r;c++){var u=c/(r-1)*sK,h=hK(u)*n,d=dK(u)*n;this._vset(a,s),this._vset(a-o*h+t*d,s-l*h+i*d)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,s=-e.dx,o=t.dy,l=-t.dx,c=t.x,u=t.y;if(0!=(t.flags&IH.PT_LEFT)){var h=this._chooseBevel(t.flags&IH.PT_INNERBEVEL,e,t,i),d=h[0],f=h[1],p=h[2],_=h[3],v=fK(-s,-a),m=fK(-l,-o);v<m&&(m-=2*sK),this._vset(d,f),this._vset(c-a*n,t.y-s*n);for(var y=xK(cK((v-m)/sK)*r,2,r),g=0;g<y;g++){var b=v+g/(y-1)*(m-v),S=c+hK(b)*n,T=u+dK(b)*n;this._vset(c,u),this._vset(S,T)}this._vset(p,_),this._vset(c-o*n,u-l*n)}else{var E=this._chooseBevel(t.flags&IH.PT_INNERBEVEL,e,t,-n),x=E[0],A=E[1],C=E[2],w=E[3],R=fK(s,a),k=fK(l,o);k<R&&(k+=2*sK),this._vset(c+a*n,u+s*n,0),this._vset(x,A,0);for(var O=xK(cK((k-R)/sK)*r,2,r),F=0;F<O;F++){var L=R+F/(O-1)*(k-R),B=c+hK(L)*i,M=u+dK(L)*i;this._vset(B,M,0),this._vset(c,u,0)}this._vset(c+o*n,u+l*n),this._vset(C,w)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,s=0,o=0,l=0,c=0,u=0,h=0,d=e.dy,f=-e.dx,p=t.dy,_=-t.dx;if(t.flags&IH.PT_LEFT){var v=this._chooseBevel(t.flags&IH.PT_INNERBEVEL,e,t,i);l=v[0],c=v[1],u=v[2],h=v[3],this._vset(l,c,0),this._vset(t.x-d*n,t.y-f*n,0),this._vset(u,h,0),this._vset(t.x-p*n,t.y-_*n,0)}else{var m=this._chooseBevel(t.flags&IH.PT_INNERBEVEL,e,t,-n);r=m[0],a=m[1],s=m[2],o=m[3],this._vset(t.x+d*i,t.y+f*i,0),this._vset(r,a),this._vset(t.x+p*i,t.y+_*i,0),this._vset(s,o)}},_vset:function(e,t){if(gK){var i=gK,n=9*i.vertexStart,r=i.vData;r[n++]=e,r[n++]=t,r[n++]=0,r[n++]=1,r[n++]=1,je.array(r,SK,n),i.vertexStart++}}},CK={getAssembler:function(e){return AK}};_W.Assembler=CK;var wK=function e(){y(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},RK=function(){function t(e){y(this,t),this._letterDefinitions={}}return l(t,[{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),l(t,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new wK;cc.js.mixin(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n],a=this._letterDefinitions[n];cc.js.mixin(a,r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions.hasOwnProperty(e.charCodeAt(0))?this._letterDefinitions[e.charCodeAt(0)]:null}}]),t}();cc.FontAtlas=RK;var kK=function e(){y(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},OK=new Ur,FK=null,LK=[],BK=[],MK=[],IK=[],PK=new zr,DK=null,NK=null,zK=0,UK=0,GK=0,VK=0,HK=0,WK=1,XK=null,jK="",qK=0,YK=0,KK=new zr,QK=0,ZK=0,JK=0,$K=0,eQ=0,tQ=!1,iQ=0,nQ=0,rQ=0,aQ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){nz(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,s){var o=e.renderData;if(o){var l=o.dataLength;o.dataLength+=4,o.vertexCount=o.dataLength,o.indiceCount=o.dataLength/2*3;var c=o.datas,u=t.width,h=t.height,d=i.width,f=i.height,p=0,_=0,v=0,m=0;c[l+3].v=n?(p=i.x/u,m=(i.x+f)/u,_=(i.y+d)/h,v=i.y/h,c[l].u=p,c[l].v=v,c[l+1].u=p,c[l+1].v=_,c[l+2].u=m,c[l+2].v=v,c[l+3].u=m,_):(p=i.x/u,m=(i.x+d)/u,_=(i.y+f)/h,v=i.y/h,c[l].u=p,c[l].v=_,c[l+1].u=m,c[l+1].v=_,c[l+2].u=p,c[l+2].v=v,c[l+3].u=m,v),c[l].x=r,c[l].y=a-f*s,c[l+1].x=r+d*s,c[l+1].y=a-f*s,c[l+2].x=r,c[l+2].y=a,c[l+3].x=r+d*s,c[l+3].y=a}}};Tt(aQ,{updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&FK!==e&&(FK=e,this._updateProperties(),this._updateContent(),FK.actualFontSize=qK,FK.node.setContentSize(KK),FK.renderData.vertDirty=FK.renderData.uvDirty=!1,FK=null,this._resetProperties())},_updateFontScale:function(){WK=qK/YK},_updateProperties:function(){if(FK){var e=FK.font;if(e){if(XK=e.spriteFrame,NK=e.fntConfig,!(DK=FK.fontAtlas)){DK=new RK(NK);for(var t=NK.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new wK,s=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=s.width,a.height=s.height,a.u=s.x,a.v=s.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,DK.addLetterDefinitions(r,a)}FK.fontAtlas=DK}jK=FK.string.toString(),qK=FK.fontSize,YK=NK.fontSize;var o=FK.node.getContentSize();KK.width=o.width,KK.height=o.height,QK=FK.horizontalAlign,ZK=FK.verticalAlign,JK=FK.spacingX,eQ=FK.overflow,$K=FK.lineHeight,tQ=eQ!==Kt.Overflow.NONE&&(eQ===Kt.Overflow.RESIZE_HEIGHT||FK.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){XK=NK=DK=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=jK,t=e.length,i=NK.kerningDict,n=LK,r=-1,a=0;a<t;++a){var s=e.charCodeAt(a),o=i[r<<16|65535&s]||0;n[a]=a<t-1?o:0,r=s}},_multilineTextWrap:function(e){var t=jK.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Lr;this._updateFontScale();for(var h=DK.letterDefinitions,d=0;d<t;){var f=jK.charAt(d);if("\n"!==f){for(var p=e(jK,d,t),_=o,v=l,m=s,y=n,g=!1,b=0;b<p;++b){var S=d+b;if("\r"!==(f=jK.charAt(S)))if(c=DK&&DK.getLetterDefinitionForChar(f)){var T=y+c.offsetX*WK;if(tQ&&0<rQ&&0<n&&T+c.width*WK>rQ&&!Hl(f)){MK.push(s),i++,r-=$K*WK+(n=s=0),g=!0;break}u.x=T,u.y=r-c.offsetY*WK,this._recordLetterInfo(h,u,f,S,i),S+1<LK.length&&S<t-1&&(y+=LK[S+1]),y+=c.xAdvance*WK+JK,m=u.x+c.width*WK,_<u.y&&(_=u.y),v>u.y-c.height*WK&&(v=u.y-c.height*WK)}else this._recordPlaceholderInfo(S,f),console.log("Can't find letter definition in texture atlas "+NK.atlasName+" for letter:"+f);else this._recordPlaceholderInfo(S,f)}g||(n=y,o<_&&(o=_),v<l&&(l=v),a<(s=m)&&(a=s),d+=p)}else MK.push(s),i++,r-=$K*WK+(n=s=0),this._recordPlaceholderInfo(d,f),d++}return MK.push(s),UK=(zK=i+1)*$K*WK,1<zK&&(UK+=0*(zK-1)),KK.width=iQ,KK.height=nQ,iQ<=0&&(KK.width=parseFloat(a.toFixed(2))),nQ<=0&&(KK.height=parseFloat(UK.toFixed(2))),VK=KK.height,(HK=0)<o&&(VK=KK.height+o),l<-UK&&(HK=UK+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Vl(n)||"\n"===n||Hl(n))return 1;var r=1,a=DK&&DK.getLetterDefinitionForChar(n);if(!a)return r;for(var s=a._xAdvance*WK+JK,o=t+1;o<i&&(n=e.charAt(o),a=DK&&DK.getLetterDefinitionForChar(n));++o){if(s+a._offsetX*WK+a._width*WK>rQ&&!Hl(n)&&0<rQ)return r;if(s+=a._xAdvance*WK+JK,"\n"===n||Hl(n)||Vl(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=BK.length){var i=new kK;BK.push(i)}BK[e].char=t,BK[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=BK.length){var a=new kK;BK.push(a)}var s=i.charCodeAt(0);BK[n].lineIndex=r,BK[n].char=i,BK[n].valid=e[s].validDefinition,BK[n].positionX=t.x,BK[n].positionY=t.y},_alignText:function(){UK=0,MK.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),eQ===Kt.Overflow.SHRINK&&0<qK&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||eQ===Kt.Overflow.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),qK=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=qK,i=$K,n=DK,r=0,a=n?n.cloneLetterDefinition():{},s=!0;e();){var o=t-++r;if(s=!1,o<=0)break;var l=o/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),$K=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}$K=i,n&&n.assignLetterDefinitions(a),s||0<=t-r&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return UK>KK.height},_isHorizontalClamp:function(){if(DK){for(var e=DK.letterDefinitions,t=!1,i=0,n=jK.length;i<n;++i){var r=BK[i];if(r.valid){var a=e[r.char],s=r.positionX+a.width/2*WK,o=r.lineIndex;if(0<iQ)if(tQ){if(MK[o]>KK.width&&(s>KK.width||s<0)){t=!0;break}}else if(s>KK.width){t=!0;break}}}return t}},_isHorizontalClamped:function(e,t){var i=MK[t],n=e>KK.width||e<0;return tQ?i>KK.width&&n:n},_updateQuads:function(){if(!FK)return!1;var e=DK?DK.letterDefinitions:{},t=XK,i=FK.node,n=FK.renderData;n.dataLength=n.vertexCount=n.indiceCount=0;for(var r=i.getAnchorPoint(),a=KK,s=r.x*a.width,o=r.y*a.height,l=!0,c=0,u=jK.length;c<u;++c){var h=BK[c];if(h.valid){var d=e[h.char.charCodeAt(0)];if(d){OK.height=d.height,OK.width=d.width,OK.x=d.u,OK.y=d.v;var f=h.positionY+GK;if(0<nQ){if(VK<f){var p=f-VK;OK.y+=p,OK.height-=p,f-=p}f-d.height*WK<HK&&(OK.height=f<HK?0:f-HK)}var _=h.lineIndex,v=h.positionX+d.width/2*WK+IK[_];if(0<iQ&&this._isHorizontalClamped(v,_))if(eQ===Kt.Overflow.CLAMP)OK.width=0;else if(eQ===Kt.Overflow.SHRINK){if(KK.width>d.width){l=!1;break}OK.width=0}if(XK&&0<OK.height&&0<OK.width){var m=XK.isRotated(),y=XK.getOriginalSize(),g=XK.getRect(),b=XK.getOffset(),S=b.x+(y.width-g.width)/2,T=b.y-(y.height-g.height)/2;if(m){var E=OK.x;OK.x=g.x+g.height-OK.y-OK.height-T,OK.y=E+g.y-S,OK.y<0&&(OK.height=OK.height+T)}else OK.x+=g.x-S,OK.y+=g.y+T;var x=h.positionX+IK[h.lineIndex];this.appendQuad(FK,t,OK,m,x-s,f-o,WK)}}else console.warn("Can't find letter in this bitmap-font")}}return l},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(IK.length=0,QK){case Kt.HorizontalTextAlignment.LEFT:for(var e=0;e<zK;++e)IK.push(0);break;case Kt.HorizontalTextAlignment.CENTER:for(var t=0,i=MK.length;t<i;t++)IK.push((KK.width-MK[t])/2);break;case Kt.HorizontalTextAlignment.RIGHT:for(var n=0,r=MK.length;n<r;n++)IK.push(KK.width-MK[n])}switch(ZK){case Kt.VerticalTextAlignment.TOP:GK=KK.height;break;case Kt.VerticalTextAlignment.CENTER:GK=(KK.height+UK)/2;break;case Kt.VerticalTextAlignment.BOTTOM:GK=UK}},_setupBMFontOverflowMetrics:function(){var e=KK.width,t=KK.height;eQ===Kt.Overflow.RESIZE_HEIGHT&&(t=0),eQ===Kt.Overflow.NONE&&(t=e=0),iQ=e,nQ=t,PK.width=e,PK.height=t,rQ=e}});var sQ=nV.Overflow,oQ=Hr.WHITE,lQ=nV.HorizontalAlign,cQ=nV.VerticalAlign,uQ=function e(){y(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},hQ=function e(){y(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},dQ=function(){function i(e,t){y(this,i),this.texture=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}return l(i,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.texture.destroy(),this.texture=null}},{key:"_updateProperties",value:function(){if(this.texture=new iu,this.data=nV.CanvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Wl(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height);var t=new Ls(this.canvas);this.texture.image=t}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ",1,")"),t.isOutlined){var o=t.out||oQ;e.strokeStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ").concat(o.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a),this.texture.updateImage()}}}]),i}(),fQ=function(e){function t(){return y(this,t),T(this,S(t).apply(this,arguments))}return p(t,Zc),l(t,[{key:"initWithSize",value:function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Kt.GFXFormat.RGBA8;this.destroy();var n=this._getGlobalDevice();if(n){var r=this._getTextureCreateInfo();r.width=e,r.height=t,r.format=i,this._texture=n.createTexture(r),this._textureView=n.createTextureView(this._getTextureViewCreateInfo()),this.loaded=!0,this.emit("load")}else console.warn("Unable to get device")}},{key:"drawTextureAt",value:function(e,t,i){if(e.image&&this._texture){var n=this._getGlobalDevice();if(n){var r={buffOffset:0,buffStride:0,buffTexHeight:0,texOffset:{x:t,y:i,z:0},texExtent:{width:e.image.width,height:e.image.height,depth:1},texSubres:{baseMipLevel:0,levelCount:1,baseArrayLayer:0,layerCount:1}};n.copyTexImagesToTexture([e.image.data],this._texture,[r])}else console.warn("Unable to get device")}}}]),t}(),pQ=function(){function i(e,t){y(this,i),this.texture=void 0,this._x=2,this._y=2,this._nexty=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._imageAssets=[],this._dirty=!1,this.texture=new fQ,this.texture.initWithSize(e,t),this._width=e,this._height=t,cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return l(i,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),l(i,[{key:"insertLetterTexture",value:function(e){var t=e.texture,i=cc.director.root.device;if(!(t&&this.texture&&i&&t.image))return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nexty),this._y+r>this._nexty&&(this._nexty=this._y+r+2),this._nexty>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new hQ;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nexty=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new fQ;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new hQ;Et(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var i=this;e.forEach(function(e,t){Et(i._letterDefinitions[t],e)})}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new dQ(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),i}(),_Q=new Ur,vQ=null,mQ=[],yQ=[],gQ=[],bQ=[],SQ=new zr,TQ=null,EQ=0,xQ=0,AQ=0,CQ=0,wQ=0,RQ=1,kQ="",OQ=0,FQ=0,LQ=new zr,BQ=0,MQ=0,IQ=0,PQ=0,DQ=0,NQ=!1,zQ=0,UQ=0,GQ=0,VQ="",HQ=!1,WQ={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:oQ,isOutlined:!1,out:oQ,margin:0},XQ={getAssemblerData:function(){return TQ||(TQ=new pQ(1024,1024)),TQ.texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&vQ!==e&&(vQ=e,this._updateFontFamily(e),WQ.fontFamily=VQ,this._updateProperties(),WQ.fontDesc=this._getFontDesc(),this._updateContent(),vQ.actualFontSize=OQ,vQ.node.setContentSize(LQ),vQ.renderData.vertDirty=vQ.renderData.uvDirty=!1,vQ=null,this._resetProperties())},_updateFontScale:function(){RQ=OQ/FQ},_updateProperties:function(){if(vQ){kQ=vQ.string.toString(),OQ=vQ.fontSize,FQ=OQ;var e=vQ.node.getContentSize();LQ.width=e.width,LQ.height=e.height,BQ=vQ.horizontalAlign,MQ=vQ.verticalAlign,IQ=vQ.spacingX,DQ=vQ.overflow,PQ=vQ.lineHeight,HQ=vQ.isBold,NQ=DQ!==sQ.NONE&&(DQ===sQ.RESIZE_HEIGHT||vQ.enableWrapText);var t=vQ.getComponent(uX);t&&t.enabled?(WQ.isOutlined=!0,WQ.margin=t.width,WQ.out=t.color,WQ.out.a=t.color.a*vQ.color.a/255):(WQ.isOutlined=!1,WQ.margin=0),WQ.lineHeight=PQ,WQ.fontSize=OQ,WQ.fontFamily=VQ,WQ.color=vQ.color,WQ.hash=this._computeHash(WQ),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(i){i.useSystemFont?VQ=i.fontFamily:i.font?i.font._nativeAsset?VQ=i.font._nativeAsset:(VQ=cc.loader.getRes(i.font.nativeUrl))||cc.loader.load(i.font.nativeUrl,function(e,t){VQ=t||"Arial",i.font&&(i.font._nativeAsset=t),i.updateRenderData(!0)}):VQ="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=OQ.toString()+"px ";return e+=VQ,HQ&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=kQ.length,i=0,n=0,r=0,a=0,s=0,o=0,l=0,c=null,u=new Lr(0,0);this._updateFontScale();for(var h=0;h<t;){var d=kQ.charAt(h);if("\n"!==d){for(var f=e(kQ,h,t),p=o,_=l,v=s,m=n,y=!1,g=0;g<f;++g){var b=h+g;if("\r"!==(d=kQ.charAt(b)))if(c=TQ&&TQ.getLetterDefinitionForChar(d,WQ)){var S=m+c.offsetX*RQ;if(NQ&&0<GQ&&0<n&&S+c.w*RQ>GQ&&!Hl(d)){gQ.push(s),i++,r-=PQ*RQ+(n=s=0),y=!0;break}u.x=S,u.y=r-c.offsetY*RQ,this._recordLetterInfo(u,d,b,i),b+1<mQ.length&&b<t-1&&(m+=mQ[b+1]),m+=c.xAdvance*RQ+IQ,v=u.x+c.w*RQ,p<u.y&&(p=u.y),_>u.y-c.h*RQ&&(_=u.y-c.h*RQ)}else this._recordPlaceholderInfo(b,d);else this._recordPlaceholderInfo(b,d)}y||(n=m,o<p&&(o=p),_<l&&(l=_),a<(s=v)&&(a=s),h+=f)}else gQ.push(s),i++,r-=PQ*RQ+(n=s=0),this._recordPlaceholderInfo(h,d),h++}return gQ.push(s),xQ=(EQ=i+1)*PQ*RQ,1<EQ&&(xQ+=0*(EQ-1)),LQ.width=zQ,LQ.height=UQ,zQ<=0&&(LQ.width=parseFloat(a.toFixed(2))),UQ<=0&&(LQ.height=parseFloat(xQ.toFixed(2))),CQ=LQ.height,(wQ=0)<o&&(CQ=LQ.height+o),l<-xQ&&(wQ=xQ+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Vl(n)||"\n"===n||Hl(n))return 1;if(TQ){var r=1,a=TQ.getLetterDefinitionForChar(n,WQ);if(!a)return r;for(var s=a.xAdvance*RQ+IQ,o=t+1;o<i&&(n=e.charAt(o),a=TQ.getLetterDefinitionForChar(n,WQ));++o){if(s+a.offsetX*RQ+a.w*RQ>GQ&&!Hl(n)&&0<GQ)return r;if(s+=a.xAdvance*RQ+IQ,"\n"===n||Hl(n)||Vl(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=yQ.length){var i=new uQ;yQ.push(i)}yQ[e].char=t,yQ[e].hash=t.charCodeAt(0)+WQ.hash,yQ[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=yQ.length){var r=new uQ;yQ.push(r)}var a=t.charCodeAt(0)+WQ.hash;yQ[i].line=n,yQ[i].char=t,yQ[i].hash=a;var s=TQ&&TQ.getLetter(a);yQ[i].valid=!!s&&!!s.valid,yQ[i].x=e.x,yQ[i].y=e.y},_alignText:function(){xQ=0,gQ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(t=!(e=.1)),OQ=e,t&&this._updateContent()},_isVerticalClamp:function(){return xQ>LQ.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=kQ.length;t<i;++t){var n=yQ[t];if(n.valid){var r=TQ.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*RQ,s=n.line;if(0<zQ)if(NQ){if(gQ[s]>LQ.width&&(a>LQ.width||a<0)){e=!0;break}}else if(a>LQ.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=gQ[t],n=e>LQ.width||e<0;return NQ?i>LQ.width&&n:n},_updateQuads:function(){if(vQ&&TQ){var e=TQ.texture,t=vQ.node,i=vQ.renderData;i.dataLength=i.vertexCount=i.indiceCount=0;for(var n=LQ,r=t.getAnchorPoint(),a=r.x*n.width,s=r.y*n.height,o=!0,l=0,c=kQ.length;l<c;++l){var u=yQ[l];if(u.valid){var h=TQ.getLetter(u.hash);if(h){_Q.height=h.h,_Q.width=h.w,_Q.x=h.u,_Q.y=h.v;var d=u.y+AQ;if(0<UQ){if(CQ<d){var f=d-CQ;_Q.y+=f,_Q.height-=f,d-=f}d-h.h*RQ<wQ&&(_Q.height=d<wQ?0:d-wQ)}var p=u.line,_=u.x+h.w/2*RQ+bQ[p];if(0<zQ&&this._isHorizontalClamped(_,p))if(DQ===sQ.CLAMP)_Q.width=0;else if(DQ===sQ.SHRINK){if(LQ.width>h.w){o=!1;break}_Q.width=0}if(0<_Q.height&&0<_Q.width){var v=u.x+bQ[u.line];this.appendQuad(i,e,_Q,!1,v-a,d-s,RQ)}}}}return o}},appendQuad:function(e,t,i,n,r,a,s){},_computeAlignmentOffset:function(){switch(bQ.length=0,BQ){case lQ.LEFT:for(var e=0;e<EQ;++e)bQ.push(0);break;case lQ.CENTER:for(var t=0,i=gQ.length;t<i;t++)bQ.push((LQ.width-gQ[t])/2);break;case lQ.RIGHT:for(var n=0,r=gQ.length;n<r;n++)bQ.push(LQ.width-gQ[n])}switch(MQ){case cQ.TOP:AQ=LQ.height;break;case cQ.CENTER:AQ=(LQ.height+xQ)/2-(PQ-OQ)/2;break;case cQ.BOTTOM:AQ=(LQ.height+xQ)/2-(PQ-OQ)}},_setupBMFontOverflowMetrics:function(){var e=LQ.width,t=LQ.height;DQ===sQ.RESIZE_HEIGHT&&(t=0),DQ===sQ.NONE&&(t=e=0),zQ=e,UQ=t,SQ.width=e,SQ.height=t,GQ=e}},jQ=cc.color(255,255,255,255),qQ={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;jQ.a=e.color.a,nz(i,t,e.renderData,jQ)}},appendQuad:aQ.appendQuad};Tt(qQ,XQ);var YQ=nV.Overflow,KQ=Hr.WHITE,QQ=cc.js.isChildClassOf(uX,Nh),ZQ=null,JQ=null,$Q=null,eZ="",tZ="",iZ=0,nZ=0,rZ=[],aZ=new zr,sZ=0,oZ=0,lZ=0,cZ=new Hr,uZ="",hZ=YQ.NONE,dZ=!1,fZ=!1,pZ=new Hr,_Z=0,vZ=0,mZ=!1,yZ=!1,gZ=!1,bZ=new KG,SZ={getAssemblerData:function(){var e=document.createElement("canvas"),t={canvas:e,context:e.getContext("2d")};return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(e){cc.game.renderType===cc.game.RENDER_TYPE_CANVAS&&e&&bZ.put(e)},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&(this._updateFontFamly(e),this._updateProperties(e),this._calculateLabelFont(),this._calculateSplitedStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=iZ,e.node.setContentSize(aZ),this.updateVerts(e),e.markForUpdateRenderData(!1),$Q=JQ=ZQ=null)},updateVerts:function(e){},_updateFontFamly:function(i){i.useSystemFont?uZ=i.fontFamily:i.font?i.font._nativeAsset?uZ=i.font._nativeAsset:cc.loader.load(i.font.nativeUrl,function(e,t){uZ=t||"Arial",i.updateRenderData(!0)}):uZ="Arial"},_updateProperties:function(e){var t=e.assemblerData;if(t){ZQ=t.context,JQ=t.canvas,$Q=e.spriteFrame,tZ=e.string.toString(),iZ=e.fontSize,nZ=iZ,hZ=e.overflow,aZ.width=e.node.width,aZ.height=e.node.height,sZ=e.lineHeight,oZ=e.horizontalAlign,lZ=e.verticalAlign,cZ=e.color,mZ=e.isBold,yZ=e.isItalic,gZ=e.isUnderline,dZ=hZ!==YQ.NONE&&(hZ===YQ.RESIZE_HEIGHT||e.enableWrapText);var i=QQ&&e.getComponent(uX);i&&i.enabled?(fZ=!0,vZ=_Z=i.width,(pZ=i.color.clone()).a=pZ.a*e.color.a/255):(fZ=!1,vZ=0)}},_calculateFillTextStartPosition:function(){var e,t,i=this._getLineHeight(),n=rZ.length;return e=oZ===Kt.HorizontalTextAlignment.RIGHT?aZ.width-vZ:oZ===Kt.HorizontalTextAlignment.CENTER?aZ.width/2:0+vZ,t=lZ===Kt.VerticalTextAlignment.TOP?0:lZ===Kt.VerticalTextAlignment.CENTER?aZ.height/2-i*(n-1)/2:aZ.height-i*(n-1),cc.v2(e,t)},_updateTexture:function(){if(ZQ&&JQ){ZQ.clearRect(0,0,JQ.width,JQ.height),ZQ.font=eZ;var e,t=this._calculateFillTextStartPosition(),i=this._getLineHeight();ZQ.lineJoin="round",ZQ.fillStyle="rgba(".concat(cZ.r,", ").concat(cZ.g,", ").concat(cZ.b,", ").concat(cZ.a/255,")");for(var n=0;n<rZ.length;++n){if(fZ){var r=pZ||KQ;ZQ.strokeStyle="rgba(".concat(r.r,", ").concat(r.g,", ").concat(r.b,", ").concat(r.a/255,")"),ZQ.lineWidth=2*_Z,ZQ.strokeText(rZ[n],t.x,t.y+n*i)}ZQ.fillText(rZ[n],t.x,t.y+n*i),gZ&&(e=this._calculateUnderlineStartPosition(),ZQ.save(),ZQ.beginPath(),ZQ.lineWidth=iZ/8,ZQ.strokeStyle="rgba(".concat(cZ.r,", ").concat(cZ.g,", ").concat(cZ.b,", ").concat(cZ.a/255,")"),ZQ.moveTo(e.x,e.y+n*i-1),ZQ.lineTo(e.x+JQ.width,e.y+n*i-1),ZQ.stroke(),ZQ.restore())}$Q&&($Q.mipmaps=[$Q.image])}},_calculateUnderlineStartPosition:function(){var e,t,i=this._getLineHeight(),n=rZ.length;return e=0+vZ,t=lZ===Kt.VerticalTextAlignment.TOP?iZ:lZ===Kt.VerticalTextAlignment.CENTER?aZ.height/2-i*(n-1)/2+iZ/2:aZ.height-i*(n-1),cc.v2(e,t)},_updateLabelDimensions:function(){if(ZQ){var e=tZ.split("\n");if(hZ===YQ.RESIZE_HEIGHT)aZ.height=rZ.length*this._getLineHeight();else if(hZ===YQ.NONE){var t=0,i=0,n=rZ=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Wl(ZQ,s);t=o<t?t:o}i=rZ.length*this._getLineHeight(),aZ.width=parseFloat(t.toFixed(2))+2*vZ,aZ.height=parseFloat(i.toFixed(2)),yZ&&(aZ.width+=nZ*Math.tan(.20943951))}JQ&&(JQ.width=aZ.width,JQ.height=aZ.height)}},_calculateTextBaseline:function(){var e,t;e=oZ===Kt.HorizontalTextAlignment.RIGHT?"right":oZ===Kt.HorizontalTextAlignment.CENTER?"center":"left",t=lZ===Kt.VerticalTextAlignment.TOP?"top":lZ===Kt.VerticalTextAlignment.CENTER?"middle":"bottom",ZQ&&(ZQ.textAlign=e,ZQ.textBaseline=t)},_calculateSplitedStrings:function(){if(ZQ){var e=tZ.split("\n");if(dZ){rZ=[];var t=aZ.width-2*vZ,i=e,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=Xl(a,Wl(ZQ,a),t,this._measureText(ZQ));rZ=rZ.concat(s)}}else rZ=e}},_getFontDesc:function(){var e=iZ.toString()+"px ";return e+=uZ,mZ&&(e="bold "+e),yZ&&(e="italic "+e),e},_getLineHeight:function(){var e=sZ;return 0|(e=0===e?iZ:e*iZ/nZ)},_calculateParagraphLength:function(e,t){var i=[],n=e,r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}var o=Wl(t,s);i.push(o)}return i},_measureText:function(t){return function(e){return Wl(t,e)}},_calculateLabelFont:function(){if(ZQ&&(eZ=this._getFontDesc(),ZQ.font=eZ,hZ===YQ.SHRINK)){var e=tZ.split("\n"),t=this._calculateParagraphLength(e,ZQ);rZ=e;var i=0,n=0,r=0;if(dZ){var a=aZ.width-2*vZ,s=aZ.height-2*vZ;if(a<0||s<0)return eZ=this._getFontDesc(),void(ZQ.font=eZ);n=s+1,r=a+1;for(var o=iZ+1,l=[],c=!0,u=0|o;s<n||a<r;){if(c?o=u/2|0:u=o=u-1,o<=0){cc.logID(4003);break}for(iZ=o,eZ=this._getFontDesc(),ZQ.font=eZ,rZ=[],i=n=0;i<e.length;++i){var h=0,d=Wl(ZQ,e[i]);for(l=Xl(e[i],d,a,this._measureText(ZQ));h<l.length;){r=Wl(ZQ,l[h]),n+=this._getLineHeight(),++h}rZ=rZ.concat(l)}c&&(s<n?u=0|o:(c=!1,n=s+1))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var f=(aZ.width-2*vZ)/r,p=aZ.height/n;iZ=nZ*Math.min(1,f,p)|0,eZ=this._getFontDesc(),ZQ.font=eZ}}}},TZ=Hr.WHITE,EZ={useModel:!1,createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indiceCount=6;var i=t.datas;return i[0].u=0,i[0].v=1,i[1].u=1,i[1].v=1,i[2].u=0,i[2].v=0,i[3].u=1,i[3].v=0,t},fillBuffers:function(e,t){nz(e.node,t,e.renderData,TZ)},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=i.width,r=i.height,a=i.anchorX*n,s=i.anchorY*r,o=t.datas;o[0].x=-a,o[0].y=-s,o[1].x=n-a,o[1].y=-s,o[2].x=-a,o[2].y=r-s,o[3].x=n-a,o[3].y=r-s}}};Tt(EZ,SZ);var xZ,AZ,CZ={getAssembler:function(e){var t=EZ;return e.font instanceof Hu?t=aQ:e.cacheMode===nV.CacheMode.CHAR&&(cc.sys.browserType===cc.sys.BROWSER_TYPE_WECHAT_GAME_SUB?cc.warn("sorry, subdomain does not support CHAR mode currently!"):t=qQ),t}};nV.Assembler=CZ,(AZ=xZ||(xZ={}))[AZ.DISABLED=0]="DISABLED",AZ[AZ.CLEAR=1]="CLEAR",AZ[AZ.ENTER_LEVEL=2]="ENTER_LEVEL",AZ[AZ.ENABLED=3]="ENABLED",AZ[AZ.EXIT_LEVEL=4]="EXIT_LEVEL";var wZ=function(){function e(){y(this,e),this.stage=xZ.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:ha.ALWAYS,stencilMask:4294967295,writeMask:4294967295,failOp:fa.KEEP,zFailOp:fa.KEEP,passOp:fa.KEEP,ref:1},this._defaultPipelineState={depthStencilState:{},rasterizerState:{},blendState:{}}}return l(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=xZ.CLEAR}},{key:"enterLevel",value:function(){this.stage=xZ.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=xZ.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=xZ.DISABLED:this.stage=xZ.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;this.stage===xZ.DISABLED?(t.stencilTest=!1,t.func=ha.ALWAYS,t.failOp=fa.KEEP,t.stencilMask=t.writeMask=4294967295,t.ref=1):(t.stencilTest=!0,this.stage===xZ.ENABLED?(t.func=ha.EQUAL,t.failOp=fa.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):this.stage===xZ.CLEAR?(t.func=ha.NEVER,t.failOp=fa.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):this.stage===xZ.ENTER_LEVEL&&(t.func=ha.NEVER,t.failOp=fa.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()));var i=e.passes[0];if(this._changed(i)){var n=this._stencilPattern;return this._defaultPipelineState.depthStencilState={stencilTestFront:n.stencilTest,stencilFuncFront:n.func,stencilReadMaskFront:n.stencilMask,stencilWriteMaskFront:n.writeMask,stencilFailOpFront:n.failOp,stencilZFailOpFront:n.zFailOp,stencilPassOpFront:n.passOp,stencilRefFront:n.ref,stencilTestBack:n.stencilTest,stencilFuncBack:n.func,stencilReadMaskBack:n.stencilMask,stencilWriteMaskBack:n.writeMask,stencilFailOpBack:n.failOp,stencilZFailOpBack:n.zFailOp,stencilPassOpBack:n.passOp,stencilRefBack:n.ref},this._defaultPipelineState.blendState=i.blendState,this._defaultPipelineState.rasterizerState=i.rasterizerState,e.overridePipelineStates(this._defaultPipelineState),!0}return!1}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"getInvertedRef",value:function(){for(var e=0,t=0;t<this._maskStack.length-1;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=xZ.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}}]),e}();wZ.sharedManager=null,wZ.sharedManager=new wZ;var RZ=wZ.sharedManager,kZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVerts&&this.updateVerts(e)},updateVerts:function(e){var t=e.renderData;if(t){var i,n,r,a,s=e.node,o=t.datas,l=s.width,c=s.height,u=s.anchorX*l,h=s.anchorY*c;i=-u,n=-h,r=l-u,a=c-h,o[0].x=i,o[0].y=n,o[3].x=r,o[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){RZ.pushMask(e),RZ.clear(),e.clearGraphics.updateAssembler(t),RZ.enterLevel(),e.graphics.updateAssembler(t),RZ.enableMask()}},OZ={fillBuffers:function(e,t){RZ.exitMask()}},FZ={getAssembler:function(){return kZ}},LZ={getAssembler:function(){return OZ}};zW.Assembler=FZ,zW.PostAssembler=LZ;var BZ=rG.FillType,MZ=new Dr,IZ={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,s=e.fillRange;s<0&&(a+=s,s=-s),s=(s=1<(s=a+s)?1:s)<0?0:s;var o=(a=(a=1<a?1:a)<0?0:a)+(s=(s-=a)<0?0:s);o=1<o?1:o,n&&this.updateUVs(e,a,o),r&&(this.updateVerts&&this.updateVerts(e,a,o),this.updateWorldVerts(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.datas,s=n.width,o=n.height,l=n.getRect(),c=0,u=0,h=0,d=0,f=0,p=0,_=0,v=0,m=0,y=0;switch(n.isRotated()?(c=l.x/s,u=(l.y+l.width)/o,h=f=c,_=m=(l.x+l.height)/s,p=y=u,d=v=l.y/o):(c=l.x/s,u=(l.y+l.height)/o,h=_=c,f=m=(l.x+l.width)/s,d=p=u,v=y=l.y/o),e.fillType){case BZ.HORIZONTAL:a[0].u=h+(f-h)*t,a[0].v=d+(p-d)*t,a[1].u=h+(f-h)*i,a[1].v=d+(p-d)*i,a[2].u=_+(m-_)*t,a[2].v=v+(y-v)*t,a[3].u=_+(m-_)*i,a[3].v=v+(y-v)*i;break;case BZ.VERTICAL:a[0].u=h+(_-h)*t,a[0].v=d+(v-d)*t,a[1].u=f+(m-f)*t,a[1].v=p+(y-p)*t,a[2].u=h+(_-h)*i,a[2].v=d+(v-d)*i,a[3].u=f+(m-f)*i,a[3].v=p+(y-p)*i;break;default:cc.errorID(2626)}r.uvDirty=!1},updateVerts:function(e,t,i){var n=e.renderData,r=n.datas,a=e.node,s=a.width,o=a.height,l=a.anchorX*s,c=a.anchorY*o,u=-l,h=-c,d=s-l,f=o-c,p=0;switch(e.fillType){case BZ.HORIZONTAL:p=u+(d-u)*i,u=u+(d-u)*t,d=p;break;case BZ.VERTICAL:p=h+(f-h)*i,h=h+(f-h)*t,f=p;break;default:cc.errorID(2626)}r[4].x=u,r[4].y=h,r[5].x=d,r[5].y=h,r[6].x=u,r[6].y=f,r[7].x=d,r[7].y=f,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indiceCount=6;var i=t.datas,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.z=0}return t},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(MZ);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];Oe.transformMat4(a,r,MZ)}},fillBuffers:function(e,t){e.node.hasChanged&&this.updateWorldVerts(e);e.node;!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);for(var u=a.vData,h=0;h<o;h++){var d=r[h];u[s++]=d.x,u[s++]=d.y,u[s++]=d.z,u[s++]=d.u,u[s++]=d.v,je.array(u,n,s),s+=4}var f=a.iData;f[l++]=c,f[l++]=c+1,f[l++]=c+2,f[l++]=c+1,f[l++]=c+3,f[l++]=c+2}(0,t,e.renderData,e.color)}},PZ=2*Math.PI,DZ=[new Lr,new Lr,new Lr,new Lr],NZ=new Array(4),zZ=new Array(8),UZ=[new Lr,new Lr,new Lr,new Lr],GZ=[new Lr,new Lr,new Lr,new Lr],VZ=new Lr,HZ=[new Lr,new Lr,new Lr,new Lr];function WZ(e,t,i,n,r,a,s){var o=Math.sin(a);o=1e-6<Math.abs(o)?o:0;var l=Math.cos(a),c=0,u=0;if(0!==(l=1e-6<Math.abs(l)?l:0)){if(c=o/l,0<(e-r.x)*l){var h=r.y+c*(e-r.x);s[0].x=e,s[0].y=h}if(0<(t-r.x)*l){var d=r.y+c*(t-r.x);s[2].x=t,s[2].y=d}}if(0!==o){if(u=l/o,0<(n-r.y)*o){var f=r.x+u*(n-r.y);s[3].x=f,s[3].y=n}if(0<(i-r.y)*o){var p=r.x+u*(i-r.y);s[1].x=p,s[1].y=i}}}function XZ(e,t){var i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return 0<n?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function jZ(e,t,i,n,r){var a=NZ,s=a[0],o=a[1],l=a[2],c=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;qZ((i.x-s)/(l-s),(i.y-o)/(c-o),e,t),qZ((n.x-s)/(l-s),(n.y-o)/(c-o),e,t+1),qZ((r.x-s)/(l-s),(r.y-o)/(c-o),e,t+2)}function qZ(e,t,i,n){var r=zZ,a=r[0]+(r[2]-r[0])*e,s=r[4]+(r[6]-r[4])*e,o=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,c=i[n];c.u=a+(s-a)*t,c.v=o+(l-o)*t}for(var YZ={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t,i,n,r,a,s,o,l,c,u=e.spriteFrame,h=e.renderData;if(h&&u&&(h.vertDirty||h.uvDirty)){var d=h.datas,f=e.fillStart,p=e.fillRange;for(p<0&&(f+=p,p=-p);1<=f;)f-=1;for(;f<0;)f+=1;var _=(f*=PZ)+(p*=PZ);!function(e){var t=e.node,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,s=-r,o=-a,l=i-r,c=n-a,u=NZ;u[0]=s,u[1]=o,u[2]=l,u[3]=c;var h=e.fillCenter,d=VZ.x=Math.min(Math.max(0,h.x),1)*(l-s)+s,f=VZ.y=Math.min(Math.max(0,h.y),1)*(c-o)+o;DZ[0].x=DZ[3].x=s,DZ[1].x=DZ[2].x=l,DZ[0].y=DZ[1].y=o,DZ[2].y=DZ[3].y=c;for(var p=0,_=HZ;p<_.length;p++){var v=_[p];we.set(v,0,0)}d!==u[0]&&we.set(HZ[0],3,0),d!==u[2]&&we.set(HZ[2],1,2),f!==u[1]&&we.set(HZ[1],0,1),f!==u[3]&&we.set(HZ[3],2,3)}(e),i=(t=u).width,n=t.height,r=t.getRect(),l=o=s=a=0,c=zZ,t.isRotated()?(a=r.x/i,s=(r.x+r.height)/i,o=r.y/n,l=(r.y+r.width)/n,c[0]=c[2]=a,c[4]=c[6]=s,c[3]=c[7]=l,c[1]=c[5]=o):(a=r.x/i,s=(r.x+r.width)/i,o=r.y/n,l=(r.y+r.height)/n,c[0]=c[4]=a,c[2]=c[6]=s,c[1]=c[3]=l,c[5]=c[7]=o),WZ(NZ[0],NZ[2],NZ[1],NZ[3],VZ,f,UZ),WZ(NZ[0],NZ[2],NZ[1],NZ[3],VZ,f+p,GZ);for(var v=0,m=0;m<4;++m){var y=HZ[m];if(y)if(PZ<=p)h.dataLength=v+3,jZ(d,v,VZ,DZ[y.x],DZ[y.y]),v+=3;else{var g=XZ(VZ,DZ[y.x]),b=XZ(VZ,DZ[y.y]);b<g&&(b+=PZ),g-=PZ,b-=PZ;for(var S=0;S<3;++S)_<=g||(f<=g?(h.dataLength=v+3,jZ(d,v,VZ,DZ[y.x],_<=b?GZ[m]:DZ[y.y]),v+=3):b<=f||(b<=_?(h.dataLength=v+3,jZ(d,v,VZ,UZ[m],DZ[y.y])):(h.dataLength=v+3,jZ(d,v,VZ,UZ[m],GZ[m])),v+=3)),g+=PZ,b+=PZ}}h.indiceCount=h.vertexCount=v,h.vertDirty=h.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.datas,a=t.currBufferBatch,s=a.byteOffset>>2,o=i.vertexCount,l=a.indiceOffset,c=a.vertexOffset;a.request(o,i.indiceCount)||(a=t.currBufferBatch,c=l=o=0);var u=a.vData;e.getWorldMatrix(iz);for(var h=0;h<o;h++){var d=r[h];Oe.set(tz,d.x,d.y,0),Oe.transformMat4(tz,tz,iz),u[s++]=tz.x,u[s++]=tz.y,u[s++]=tz.z,u[s++]=d.u,u[s++]=d.v,je.array(u,n,s),s+=4}for(var f=a.iData,p=0;p<i.dataLength;p++)f[l+p]=c+p}(e.node,t,e.renderData,e.color)}},KZ=cc.mat4(),QZ=[],ZZ=0;ZZ<4;ZZ++)QZ.push(new Br);var JZ={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indiceCount=6,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&i.vertDirty&&this.updateVerts&&this.updateVerts(e)},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.datas,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,s=r.indiceOffset,o=r.vertexOffset;r.request(4,6)||(r=t.currBufferBatch,o=s=a=0);var l=r.vData,c=r.iData,u=i[0],h=i[3];Oe.set(QZ[0],u.x,u.y,u.z),Oe.set(QZ[1],h.x,u.y,u.z),Oe.set(QZ[2],u.x,h.y,u.z),Oe.set(QZ[3],h.x,h.y,u.z);var d=e.spriteFrame.uv;n.getWorldMatrix(KZ);for(var f=0;f<4;f++){var p=QZ[f];Oe.transformMat4(p,p,KZ),l[a++]=p.x,l[a++]=p.y,l[a++]=p.z;var _=2*f;l[a++]=d[0+_],l[a++]=d[1+_],je.array(l,e.color,a),a+=4}c[s++]=o,c[s++]=o+1,c[s++]=o+2,c[s++]=o+1,c[s++]=o+3,c[s++]=o+2}},updateVerts:function(e){var t=e.renderData;if(t){var i=e.node,n=t.datas,r=i.width,a=i.height,s=i.anchorX*r,o=i.anchorY*a,l=0,c=0,u=0,h=0;if(e.trim)l=-s,c=-o,u=r-s,h=a-o;else{var d=e.spriteFrame,f=d.getOriginalSize(),p=d.getRect(),_=f.width,v=f.height,m=p.width,y=p.height,g=d.getOffset(),b=r/_,S=a/v,T=g.x+(_-m)/2,E=g.x-(_-m)/2;l=T*b-s,c=(g.y+(v-y)/2)*S-o,u=r+E*b-s,h=a+(g.y-(v-y)/2)*S-o}n[0].x=l,n[0].y=c,n[0].z=0,n[3].x=u,n[3].y=h,n[3].z=0,t.vertDirty=!1}}},$Z=Oe.create(),eJ=new Dr,tJ={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indiceCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&(this.updateVerts(e),this.updateWorldVerts(e)))},updateVerts:function(e){var t=e.renderData,i=t.datas,n=e.node,r=n.width,a=n.height,s=n.anchorX*r,o=n.anchorY*a,l=e.spriteFrame,c=l.insetLeft,u=l.insetRight,h=l.insetTop,d=l.insetBottom,f=r-c-u,p=a-h-d,_=r/(c+u),v=a/(h+d);_=isNaN(_)||1<_?1:_,v=isNaN(v)||1<v?1:v,f=f<0?0:f,p=p<0?0:p,i[0].x=-s,i[0].y=-o,i[1].x=c*_-s,i[1].y=d*v-o,i[2].x=i[1].x+f,i[2].y=i[1].y+p,i[3].x=r-s,i[3].y=a-o,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChanged&&this.updateWorldVerts(e);var i=t.currBufferBatch,n=e.renderData,r=n.datas,a=i.byteOffset>>2,s=n.vertexCount,o=i.indiceOffset,l=i.vertexOffset,c=e.spriteFrame.uvSliced;i.request(s,n.indiceCount)||(i=t.currBufferBatch,l=o=a=0);for(var u=i.vData,h=i.iData,d=4;d<20;++d){var f=r[d],p=c[d-4];u[a++]=f.x,u[a++]=f.y,u[a++]=f.z,u[a++]=p.u,u[a++]=p.v,je.array(u,e.color,a),a+=4}for(var _=0;_<3;++_)for(var v=0;v<3;++v){var m=l+4*_+v;h[o++]=m,h[o++]=m+1,h[o++]=m+4,h[o++]=m+1,h[o++]=m+5,h[o++]=m+4}},updateWorldVerts:function(e){var t=e.node,i=e.renderData.datas;t.getWorldMatrix(eJ);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var s=i[a],o=i[4+4*n+a];Oe.set($Z,s.x,r.y,0),Oe.transformMat4(o,$Z,eJ)}}},iJ=rG.Type,nJ=rG.FillType,rJ={getAssembler:function(e){var t=JZ,i=e;switch(i.type){case iJ.SLICED:t=tJ;break;case iJ.FILLED:t=i.fillType===nJ.RADIAL?YZ:IZ}return t}};rG.Assembler=rJ;var aJ=function(){function t(e){y(this,t),this.batcher=void 0,this.vData=null,this.iData=null,this.vb=null,this.ib=null,this.ia=null,this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1,this._vertexFormatBytes=9*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes,this._initIDataCount=1536,this._outofCallback=null,this.batcher=e}return l(t,[{key:"initialize",value:function(e,t){this._outofCallback=t;var i=9*Float32Array.BYTES_PER_ELEMENT;this.vb=this.vb||this.batcher.device.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:0,stride:i});var n=Uint16Array.BYTES_PER_ELEMENT;this.ib=this.ib||this.batcher.device.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:0,stride:n}),this.ia=this.ia||this.batcher.device.createInputAssembler({attributes:e,vertexBuffers:[this.vb],indexBuffer:this.ib}),this._reallocBuffer()}},{key:"request",value:function(e,t){var i=this.byteOffset+e*this._vertexFormatBytes,n=this.indiceOffset+t;if(65535<e+this.vertexOffset)return this.batcher.autoMergeBatches(),this._outofCallback&&this._outofCallback.call(this.batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(r<i||a<n){for(;r<i||a<n;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indiceOffset+=t,this.byteOffset=i,this.dirty=!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indiceStart=0,this.indiceOffset=0,this.vertexStart=0,this.vertexOffset=0,this.dirty=!1}},{key:"destroy",value:function(){this.ib.destroy(),this.vb.destroy(),this.ia.destroy(),this.ib=null,this.vb=null,this.ia=null}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this.dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indiceOffset);this.byteOffset>this.vb.size&&this.vb.resize(this.byteOffset),this.vb.update(e),2*this.indiceOffset>this.ib.size&&this.ib.resize(2*this.indiceOffset),this.ib.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),t}();cc.UI={MeshBuffer:aJ,UIVertexFormat:CY,barFilled:IZ,radialFilled:YZ,simple:JZ,sliced:tJ,ttf:EZ,bmfont:aQ,letter:qQ,mask:kZ,maskEnd:OZ,graphics:AK,spriteAssembler:rJ,graphicsAssembler:CK,labelAssembler:CZ},cc.geometry=Sv,cc.primitives=ez,cc.utils=cb;(sJ=new Y_).accurate=!0;var sJ,oJ=function(){var o=cc.v3(),l=cc.v3(),c=cc.quat(),u=new Y_;u.accurate=!0;var h=cc.mat4(),d=cc.mat4(),f=cc.v3(),p=cc.v3();return function(e,t,i,n,r,a){He.fromRT(h,i.node.getWorldRotation(c),t.node.getWorldPosition(o)),He.invert(d,h),t.getSplitFrustum(u,n,r),u.transform(d),Oe.set(f,u.vertices[0].x,u.vertices[0].y,u.vertices[0].z),Oe.copy(p,f);for(var s=1;s<u.vertices.length;s++)f.x=Math.min(f.x,u.vertices[s].x),f.y=Math.min(f.y,u.vertices[s].y),f.z=Math.min(f.z,u.vertices[s].z),p.x=Math.max(p.x,u.vertices[s].x),p.y=Math.max(p.y,u.vertices[s].y),p.z=Math.max(p.z,u.vertices[s].z);Oe.set(l,(f.x+p.x)/2,(f.y+p.y)/2,p.z),l.z+=a,Oe.transformMat4(o,l,h),He.fromRT(h,i.node.getWorldRotation(c),o),Y_.createOrtho(e,p.x-f.x,p.y-f.y,0,f.z-a-p.z,h)}}(),lJ=function(){function t(e){y(this,t),this._device=void 0,this._pipeline=void 0,this._name="",this._priority=0,this._stages=[],this._material=new _m,this._device=e.device,this._pipeline=e}return l(t,[{key:"device",get:function(){return this._device}},{key:"pipeline",get:function(){return this._pipeline}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"stages",get:function(){return this._stages}},{key:"material",get:function(){return this._material}}]),l(t,[{key:"resize",value:function(e,t){var i=this._stages,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}}},{key:"render",value:function(e){var t=this._stages,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"createStage",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._stages.push(i),this._stages.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyStages",value:function(){var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._stages=[]}}]),t}(),cJ=function(){function t(e){if(y(this,t),this._flow=void 0,this._pipeline=void 0,this._device=void 0,this._name="",this._priority=0,this._framebuffer=null,this._cmdBuff=null,this._clearColors=void 0,this._clearDepth=1,this._clearStencil=0,this._renderArea=void 0,this._pass=null,this._pso=null,this._flow=e,this._pipeline=e.pipeline,this._device=e.device,!this._flow.pipeline.root.device)throw new Error("");this._device=this._flow.pipeline.root.device,this._clearColors=[{r:.3,g:.6,b:.9,a:1}],this._renderArea={x:0,y:0,width:0,height:0}}return l(t,[{key:"flow",get:function(){return this._flow}},{key:"pipeline",get:function(){return this._pipeline}},{key:"priority",get:function(){return this._priority}},{key:"framebuffer",get:function(){return this._framebuffer}}]),l(t,[{key:"setClearColor",value:function(e){0<this._clearColors.length?this._clearColors[0]=e:this._clearColors.push(e)}},{key:"setClearColors",value:function(e){this._clearColors=e}},{key:"setClearDepth",value:function(e){this._clearDepth=e}},{key:"setClearStencil",value:function(e){this._clearStencil=e}},{key:"setRenderArea",value:function(e,t){this._renderArea.width=e,this._renderArea.height=t}}]),t}(),uJ=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._areaTexImage=new Image,t._searchTexImage=new Image,t._areaTexAsset=new Zc,t._searchTexAsset=new Zc,t._hEdgeTexSampler=0,t._hAreaTexSampler=0,t._hSearchTexSampler=0,t._isAreaImageLoaded=!1,t._isSearchImageLoaded=!1,t._isLoaded=!1,t._bindingLayout=null,t}return p(i,cJ),l(i,[{key:"initialize",value:function(e){var t=this;void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:za.PRIMARY}),this._pass=this._flow.material.passes[1],this._hEdgeTexSampler=this._pass.getBinding("u_edgeTexSampler"),this._hAreaTexSampler=this._pass.getBinding("u_areaTexSampler"),this._hSearchTexSampler=this._pass.getBinding("u_searchTexSampler");var i=this._pipeline.globalBindings.get(Tf.BLOCK.name);return this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Tf.BLOCK.binding,i.buffer),this._pass.bindTextureView(this._hEdgeTexSampler,this._pipeline.smaaEdgeTexView),this._pass.update(),this._bindingLayout.update(),this._areaTexImage.src=this.getAreaTexEncode(),this._areaTexImage.onload=function(){t._isAreaImageLoaded=!0,t.bindTextures()},this._searchTexImage.src=this.getSearchTexEncode(),this._searchTexImage.onload=function(){t._isSearchImageLoaded=!0,t.bindTextures()},!0}},{key:"destroy",value:function(){this._areaTexAsset.destroy(),this._searchTexAsset.destroy(),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){if(this._isLoaded){var t=e.camera;this._cmdBuff&&(this._renderArea.width=t.width,this._renderArea.height=t.height,this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(this._framebuffer,this._renderArea,ts.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._bindingLayout),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()),this._device.queue.submit([this._cmdBuff])}}},{key:"bindTextures",value:function(){this._isAreaImageLoaded&&this._isSearchImageLoaded&&(this._areaTexAsset.image=new Ls(this._areaTexImage),this._searchTexAsset.image=new Ls(this._searchTexImage),this._pass.bindTextureView(this._hAreaTexSampler,this._areaTexAsset.getGFXTextureView()),this._pass.bindTextureView(this._hSearchTexSampler,this._searchTexAsset.getGFXTextureView()),this._pass.update(),this._bindingLayout.update(),this._isLoaded=!0)}},{key:"getAreaTexEncode",value:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAIwCAIAAACOVPcQAACBeklEQVR42u39W4xlWXrnh/3WWvuciIzMrKxrV8/0rWbY0+SQFKcb4owIkSIFCjY9AC1BT/LYBozRi+EX+cV+8IMsYAaCwRcBwjzMiw2jAWtgwC8WR5Q8mDFHZLNHTarZGrLJJllt1W2qKrsumZWZcTvn7L3W54e1vrXX3vuciLPPORFR1XE2EomorB0nVuz//r71re/y/1eMvb4Cb3N11xV/PP/2v4UBAwJG/7H8urx6/25/Gf8O5hypMQ0EEEQwAqLfoN/Z+97f/SW+/NvcgQk4sGBJK6H7N4PFVL+K+e0N11yNfkKvwUdwdlUAXPHHL38oa15f/i/46Ih6SuMSPmLAYAwyRKn7dfMGH97jaMFBYCJUgotIC2YAdu+LyW9vvubxAP8kAL8H/koAuOKP3+q6+xGnd5kdYCeECnGIJViwGJMAkQKfDvB3WZxjLKGh8VSCCzhwEWBpMc5/kBbjawT4HnwJfhr+pPBIu7uu+OOTo9vsmtQcniMBGkKFd4jDWMSCRUpLjJYNJkM+IRzQ+PQvIeAMTrBS2LEiaiR9b/5PuT6Ap/AcfAFO4Y3dA3DFH7/VS+M8k4baEAQfMI4QfbVDDGIRg7GKaIY52qAjTAgTvGBAPGIIghOCYAUrGFNgzA7Q3QhgCwfwAnwe5vDejgG44o/fbm1C5ZlYQvQDARPAIQGxCWBM+wWl37ZQESb4gImexGMDouhGLx1Cst0Saa4b4AqO4Hk4gxo+3DHAV/nx27p3JziPM2pVgoiia5MdEzCGULprIN7gEEeQ5IQxEBBBQnxhsDb5auGmAAYcHMA9eAAz8PBol8/xij9+C4Djlim4gJjWcwZBhCBgMIIYxGAVIkH3ZtcBuLdtRFMWsPGoY9rN+HoBji9VBYdwD2ZQg4cnO7OSq/z4rU5KKdwVbFAjNojCQzTlCLPFSxtamwh2jMUcEgg2Wm/6XgErIBhBckQtGN3CzbVacERgCnfgLswhnvqf7QyAq/z4rRZm1YglYE3affGITaZsdIe2FmMIpnOCap25I6jt2kCwCW0D1uAD9sZctNGXcQIHCkINDQgc78aCr+zjtw3BU/ijdpw3zhCwcaONwBvdeS2YZKkJNJsMPf2JKEvC28RXxxI0ASJyzQCjCEQrO4Q7sFArEzjZhaFc4cdv+/JFdKULM4px0DfUBI2hIsy06BqLhGTQEVdbfAIZXYMPesq6VoCHICzUyjwInO4Y411//LYLs6TDa9wvg2CC2rElgAnpTBziThxaL22MYhzfkghz6GAs2VHbbdM91VZu1MEEpupMMwKyVTb5ij9+u4VJG/5EgEMMmFF01cFai3isRbKbzb+YaU/MQbAm2XSMoUPAmvZzbuKYRIFApbtlrfFuUGd6vq2hXNnH78ZLh/iFhsQG3T4D1ib7k5CC6vY0DCbtrohgLEIClXiGtl10zc0CnEGIhhatLBva7NP58Tvw0qE8yWhARLQ8h4+AhQSP+I4F5xoU+VilGRJs6wnS7ruti/4KvAY/CfdgqjsMy4pf8fodQO8/gnuX3f/3xi3om1/h7THr+co3x93PP9+FBUfbNUjcjEmhcrkT+8K7ml7V10Jo05mpIEFy1NmCJWx9SIKKt+EjAL4Ez8EBVOB6havuT/rByPvHXK+9zUcfcbb254+9fydJknYnRr1oGfdaiAgpxu1Rx/Rek8KISftx3L+DfsLWAANn8Hvw0/AFeAGO9DFV3c6D+CcWbL8Dj9e7f+T1k8AZv/d7+PXWM/Z+VvdCrIvuAKO09RpEEQJM0Ci6+B4xhTWr4cZNOvhktabw0ta0rSJmqz3Yw5/AKXwenod7cAhTmBSPKf6JBdvH8IP17h95pXqw50/+BFnj88fev4NchyaK47OPhhtI8RFSvAfDSNh0Ck0p2gLxGkib5NJj/JWCr90EWQJvwBzO4AHcgztwAFN1evHPUVGwfXON+0debT1YeGON9Yy9/63X+OguiwmhIhQhD7l4sMqlG3D86Suc3qWZ4rWjI1X7u0Ytw6x3rIMeIOPDprfe2XzNgyj6PahhBjO4C3e6puDgXrdg+/5l948vF3bqwZetZ+z9Rx9zdIY5pInPK4Nk0t+l52xdK2B45Qd87nM8fsD5EfUhIcJcERw4RdqqH7Yde5V7m1vhNmtedkz6EDzUMF/2jJYWbC+4fzzA/Y+/8PPH3j9dcBAPIRP8JLXd5BpAu03aziOL3VVHZzz3CXWDPWd+SH2AnxIqQoTZpo9Ckc6HIrFbAbzNmlcg8Ag8NFDDAhbJvTBZXbC94P7t68EXfv6o+21gUtPETU7bbkLxvNKRFG2+KXzvtObonPP4rBvsgmaKj404DlshFole1Glfh02fE7bYR7dZ82oTewIBGn1Md6CG6YUF26X376oevOLzx95vhUmgblI6LBZwTCDY7vMq0op5WVXgsObOXJ+1x3qaBl9j1FeLxbhU9w1F+Wiba6s1X/TBz1LnUfuYDi4r2C69f1f14BWfP+p+W2GFKuC9phcELMYRRLur9DEZTUdEH+iEqWdaM7X4WOoPGI+ZYD2+wcQ+y+ioHUZ9dTDbArzxmi/bJI9BND0Ynd6lBdve/butBw8+f/T9D3ABa3AG8W3VPX4hBin+bj8dMMmSpp5pg7fJ6xrBFE2WQQEWnV8Qg3FbAWzYfM1rREEnmvkN2o1+acG2d/9u68GDzx91v3mAjb1zkpqT21OipPKO0b9TO5W0nTdOmAQm0TObts3aBKgwARtoPDiCT0gHgwnbArzxmtcLc08HgF1asN0C4Ms/fvD5I+7PhfqyXE/b7RbbrGyRQRT9ARZcwAUmgdoz0ehJ9Fn7QAhUjhDAQSw0bV3T3WbNa59jzmiP6GsWbGXDX2ytjy8+f9T97fiBPq9YeLdBmyuizZHaqXITnXiMUEEVcJ7K4j3BFPurtB4bixW8wTpweL8DC95szWMOqucFYGsWbGU7p3TxxxefP+r+oTVktxY0v5hbq3KiOKYnY8ddJVSBxuMMVffNbxwIOERShst73HZ78DZrHpmJmH3K6sGz0fe3UUj0eyRrSCGTTc+rjVNoGzNSv05srAxUBh8IhqChiQgVNIIBH3AVPnrsnXQZbLTm8ammv8eVXn/vWpaTem5IXRlt+U/LA21zhSb9cye6jcOfCnOwhIAYXAMVTUNV0QhVha9xjgA27ODJbLbmitt3tRN80lqG6N/khgot4ZVlOyO4WNg3OIMzhIZQpUEHieg2im6F91hB3I2tubql6BYNN9Hj5S7G0G2tahslBWKDnOiIvuAEDzakDQKDNFQT6gbn8E2y4BBubM230YIpBnDbMa+y3dx0n1S0BtuG62lCCXwcY0F72T1VRR3t2ONcsmDjbmzNt9RFs2LO2hQNyb022JisaI8rAWuw4HI3FuAIhZdOGIcdjLJvvObqlpqvWTJnnQbyi/1M9O8UxWhBs//H42I0q1Yb/XPGONzcmm+ri172mHKvZBpHkJaNJz6v9jxqiklDj3U4CA2ugpAaYMWqNXsdXbmJNd9egCnJEsphXNM+MnK3m0FCJ5S1kmJpa3DgPVbnQnPGWIDspW9ozbcO4K/9LkfaQO2KHuqlfFXSbdNzcEcwoqNEFE9zcIXu9/6n/ym/BC/C3aJLzEKPuYVlbFnfhZ8kcWxV3dbv4bKl28566wD+8C53aw49lTABp9PWbsB+knfc/Li3eVizf5vv/xmvnPKg5ihwKEwlrcHqucuVcVOxEv8aH37E3ZqpZypUulrHEtIWKUr+txHg+ojZDGlwnqmkGlzcVi1dLiNSJiHjfbRNOPwKpx9TVdTn3K05DBx4psIk4Ei8aCkJahRgffk4YnEXe07T4H2RR1u27E6wfQsBDofUgjFUFnwC2AiVtA+05J2zpiDK2Oa0c5fmAecN1iJzmpqFZxqYBCYhFTCsUNEmUnIcZ6aEA5rQVhEywG6w7HSW02XfOoBlQmjwulOFQAg66SvJblrTEX1YtJ3uG15T/BH1OfOQeuR8g/c0gdpT5fx2SKbs9EfHTKdM8A1GaJRHLVIwhcGyydZsbifAFVKl5EMKNU2Hryo+06BeTgqnxzYjThVySDikbtJPieco75lYfKAJOMEZBTjoITuWHXXZVhcUDIS2hpiXHV9Ku4u44bN5OYLDOkJo8w+xJSMbhBRHEdEs9JZUCkQrPMAvaHyLkxgkEHxiNkx/x2YB0mGsQ8EUWj/stW5YLhtS5SMu+/YBbNPDCkGTUybN8krRLBGPlZkVOA0j+a1+rkyQKWGaPHPLZOkJhioQYnVZ2hS3zVxMtgC46KuRwbJNd9nV2PHgb36F194ecf/Yeu2vAFe5nm/bRBFrnY4BauE8ERmZRFUn0k8hbftiVYSKMEme2dJCJSCGYAlNqh87bXOPdUkGy24P6d1ll21MBqqx48Fvv8ZHH8HZFY7j/uAq1xMJUFqCSUlJPmNbIiNsmwuMs/q9CMtsZsFO6SprzCS1Z7QL8xCQClEelpjTduDMsmWD8S1PT152BtvmIGvUeDA/yRn83u/x0/4qxoPHjx+PXY9pqX9bgMvh/Nz9kpP4pOe1/fYf3axUiMdHLlPpZCNjgtNFAhcHEDxTumNONhHrBduW+vOyY++70WWnPXj98eA4kOt/mj/5E05l9+O4o8ePx67HFqyC+qSSnyselqjZGaVK2TadbFLPWAQ4NBhHqDCCV7OTpo34AlSSylPtIdd2AJZlyzYQrDJ5lcWGNceD80CunPLGGzsfD+7wRb95NevJI5docQ3tgCyr5bGnyaPRlmwNsFELViOOx9loebGNq2moDOKpHLVP5al2cymWHbkfzGXL7kfRl44H9wZy33tvt+PB/Xnf93e+nh5ZlU18wCiRUa9m7kib9LYuOk+hudQNbxwm0AQqbfloimaB2lM5fChex+ylMwuTbfmXQtmWlenZljbdXTLuOxjI/fDDHY4Hjx8/Hrse0zXfPFxbUN1kKqSCCSk50m0Ajtx3ub9XHBKHXESb8iO6E+qGytF4nO0OG3SXzbJlhxBnKtKyl0NwybjvYCD30aMdjgePHz8eu56SVTBbgxJMliQ3Oauwg0QHxXE2Ez/EIReLdQj42Gzb4CLS0YJD9xUx7bsi0vJi5mUbW1QzL0h0PFk17rtiIPfJk52MB48fPx67npJJwyrBa2RCCQRTbGZSPCxTPOiND4G2pYyOQ4h4jINIJh5wFU1NFZt+IsZ59LSnDqBjZ2awbOku+yInunLcd8VA7rNnOxkPHj9+PGY9B0MWJJNozOJmlglvDMXDEozdhQWbgs/U6oBanGzLrdSNNnZFjOkmbi5bNt1lX7JLLhn3vXAg9/h4y/Hg8ePHI9dzQMEkWCgdRfYykYKnkP7D4rIujsujaKPBsB54vE2TS00ccvFY/Tth7JXeq1hz+qgVy04sAJawTsvOknHfCwdyT062HA8eP348Zj0vdoXF4pilKa2BROed+9fyw9rWRXeTFXESMOanvDZfJuJaSXouQdMdDJZtekZcLLvEeK04d8m474UDuaenW44Hjx8/Xns9YYqZpszGWB3AN/4VHw+k7WSFtJ3Qicuqb/NlVmgXWsxh570xg2UwxUw3WfO6B5nOuO8aA7lnZxuPB48fPx6znm1i4bsfcbaptF3zNT78eFPtwi1OaCNOqp1x3zUGcs/PN++AGD1+fMXrSVm2baTtPhPahbPhA71wIHd2bXzRa69nG+3CraTtPivahV/55tXWg8fyRY/9AdsY8VbSdp8V7cKrrgdfM//z6ILQFtJ2nxHtwmuoB4/kf74+gLeRtvvMaBdeSz34+vifx0YG20jbfTa0C6+tHrwe//NmOG0L8EbSdp8R7cLrrQe/996O+ai3ujQOskpTNULa7jOjXXj99eCd8lHvoFiwsbTdZ0a78PrrwTvlo966pLuRtB2fFe3Cm6oHP9kNH/W2FryxtN1nTLvwRurBO+Kj3pWXHidtx2dFu/Bm68Fb81HvykuPlrb7LGkX3mw9eGs+6h1Y8MbSdjegXcguQLjmevDpTQLMxtJ2N6NdyBZu9AbrwVvwUW+LbteULUpCdqm0HTelXbhNPe8G68Gb8lFvVfYfSNuxvrTdTWoXbozAzdaDZzfkorOj1oxVxlIMlpSIlpLrt8D4hrQL17z+c3h6hU/wv4Q/utps4+bm+6P/hIcf0JwQ5oQGPBL0eKPTYEXTW+eL/2DKn73J9BTXYANG57hz1cEMviVf/4tf5b/6C5pTQkMIWoAq7hTpOJjtAM4pxKu5vg5vXeUrtI09/Mo/5H+4z+Mp5xULh7cEm2QbRP2tFIKR7WM3fPf/jZ3SWCqLM2l4NxID5zB72HQXv3jj/8mLR5xXNA5v8EbFQEz7PpRfl1+MB/hlAN65qgDn3wTgH13hK7T59bmP+NIx1SHHU84nLOITt3iVz8mNO+lPrjGAnBFqmioNn1mTyk1ta47R6d4MrX7tjrnjYUpdUbv2rVr6YpVfsGG58AG8Ah9eyUN8CX4WfgV+G8LVWPDGb+Zd4cU584CtqSbMKxauxTg+dyn/LkVgA+IR8KHtejeFKRtTmLLpxN6mYVLjYxwXf5x2VofiZcp/lwKk4wGOpYDnoIZPdg/AAbwMfx0+ge9dgZvYjuqKe4HnGnykYo5TvJbG0Vj12JagRhwKa44H95ShkZa5RyLGGdfYvG7aw1TsF6iapPAS29mNS3NmsTQZCmgTzFwgL3upCTgtBTRwvGMAKrgLn4evwin8+afJRcff+8izUGUM63GOOuAs3tJkw7J4kyoNreqrpO6cYLQeFUd7TTpr5YOTLc9RUUogUOVJQ1GYJaFLAW0oTmKyYS46ZooP4S4EON3xQ5zC8/CX4CnM4c1PE8ApexpoYuzqlP3d4S3OJP8ZDK7cKWNaTlqmgDiiHwl1YsE41w1zT4iRTm3DBqxvOUsbMKKDa/EHxagtnta072ejc3DOIh5ojvh8l3tk1JF/AV6FU6jh3U8HwEazLgdCLYSQ+MYiAI2ltomkzttUb0gGHdSUUgsIYjTzLG3mObX4FBRaYtpDVNZrih9TgTeYOBxsEnN1gOCTM8Bsw/ieMc75w9kuAT6A+/AiHGvN/+Gn4KRkiuzpNNDYhDGFndWRpE6SVfm8U5bxnSgVV2jrg6JCKmneqey8VMFgq2+AM/i4L4RUbfSi27lNXZ7R7W9RTcq/q9fk4Xw3AMQd4I5ifAZz8FcVtm9SAom/dyN4lczJQW/kC42ZrHgcCoIf1oVMKkVItmMBi9cOeNHGLqOZk+QqQmrbc5YmYgxELUUN35z2iohstgfLIFmcMV7s4CFmI74L9+EFmGsi+tGnAOD4Yk9gIpo01Y4cA43BWGygMdr4YZekG3OBIUXXNukvJS8tqa06e+lSDCtnqqMFu6hWHXCF+WaYt64m9QBmNxi7Ioy7D+fa1yHw+FMAcPt7SysFLtoG4PXAk7JOA3aAxBRqUiAdU9Yp5lK3HLSRFtOim0sa8euEt08xvKjYjzeJ2GU7YawexrnKI9tmobInjFXCewpwriY9+RR4aaezFhMhGCppKwom0ChrgFlKzyPKkGlTW1YQrE9HJqu8hKGgMc6hVi5QRq0PZxNfrYNgE64utmRv6KKHRpxf6VDUaOvNP5jCEx5q185My/7RKz69UQu2im5k4/eownpxZxNLwiZ1AZTO2ZjWjkU9uaB2HFn6Q3u0JcsSx/qV9hTEApRzeBLDJQXxYmTnq7bdLa3+uqFrxLJ5w1TehnNHx5ECvCh2g2c3hHH5YsfdaSKddztfjQ6imKFGSyFwlLzxEGPp6r5IevVjk1AMx3wMqi1NxDVjLBiPs9tbsCkIY5we5/ML22zrCScFxnNtzsr9Wcc3CnD+pYO+4VXXiDE0oc/vQQ/fDK3oPESJMYXNmJa/DuloJZkcTpcYE8lIH8Dz8DJMiynNC86Mb2lNaaqP/+L7f2fcE/yP7/Lde8xfgSOdMxvOixZf/9p3+M4hT1+F+zApxg9XfUvYjc8qX2lfOOpK2gNRtB4flpFu9FTKCp2XJRgXnX6olp1zyYjTKJSkGmLE2NjUr1bxFM4AeAAHBUFIeSLqXR+NvH/M9fOnfHzOD2vCSyQJKzfgsCh+yi/Mmc35F2fUrw7miW33W9hBD1vpuUojFphIyvg7aTeoymDkIkeW3XLHmguMzbIAJejN6B5MDrhipE2y6SoFRO/AK/AcHHZHNIfiWrEe/C6cr3f/yOvrQKB+zMM55/GQdLDsR+ifr5Fiuu+/y+M78LzOE5dsNuXC3PYvYWd8NXvphLSkJIasrlD2/HOqQ+RjcRdjKTGWYhhVUm4yxlyiGPuMsZR7sMCHUBeTuNWA7if+ifXgc/hovftHXs/DV+Fvwe+f8shzMiMcweFgBly3//vwJfg5AN4450fn1Hd1Rm1aBLu22Dy3y3H2+OqMemkbGZ4jozcDjJf6596xOLpC0eMTHbKnxLxH27uZ/bMTGs2jOaMOY4m87CfQwF0dw53oa1k80JRuz/XgS+8fX3N9Af4qPIMfzKgCp4H5TDGe9GGeFPzSsZz80SlPTxXjgwJmC45njzgt2vbQ4b4OAdUK4/vWhO8d8v6EE8fMUsfakXbPpFJeLs2ubM/qdm/la3WP91uWhxXHjoWhyRUq2iJ/+5mA73zwIIo+LoZ/SgvIRjAd1IMvvn98PfgOvAJfhhm8scAKVWDuaRaK8aQ9f7vuPDH6Bj47ZXau7rqYJ66mTDwEDU6lLbCjCK0qTXyl5mnDoeNRxanj3FJbaksTk0faXxHxLrssgPkWB9LnA/MFleXcJozzjwsUvUG0X/QCve51qkMDXp9mtcyOy3rwBfdvVJK7D6/ACSzg3RoruIq5UDeESfEmVclDxnniU82vxMLtceD0hGZWzBNPMM/jSPne2OVatiTKUpY5vY7gc0LdUAWeWM5tH+O2I66AOWw9xT2BuyRVLGdoDHUsVRXOo/c+ZdRXvFfnxWyIV4upFLCl9eAL7h8Zv0QH8Ry8pA2cHzQpGesctVA37ZtklBTgHjyvdSeKY/RZw/kJMk0Y25cSNRWSigQtlULPTw+kzuJPeYEkXjQRpoGZobYsLF79pyd1dMRHInbgFTZqNLhDqiIsTNpoex2WLcy0/X6rHcdMMQvFSd5dWA++4P7xv89deACnmr36uGlL69bRCL6BSZsS6c0TU2TKK5gtWCzgAOOwQcurqk9j8whvziZSMLcq5hbuwBEsYjopUBkqw1yYBGpLA97SRElEmx5MCInBY5vgLk94iKqSWmhIGmkJ4Bi9m4L645J68LyY4wsFYBfUg5feP/6gWWm58IEmKQM89hq7KsZNaKtP5TxxrUZZVkNmMJtjbKrGxLNEbHPJxhqy7lAmbC32ZqeF6lTaknRWcYaFpfLUBh/rwaQycCCJmW15Kstv6jRHyJFry2C1ahkkIW0LO75s61+owxK1y3XqweX9m5YLM2DPFeOjn/iiqCKJ+yKXF8t5Yl/kNsqaSCryxPq5xWTFIaP8KSW0RYxqupaUf0RcTNSSdJZGcKYdYA6kdtrtmyBckfKXwqk0pHpUHlwWaffjNRBYFPUDWa8e3Lt/o0R0CdisKDM89cX0pvRHEfM8ca4t0s2Xx4kgo91MPQJ/0c9MQYq0co8MBh7bz1fio0UUHLR4aAIOvOmoYO6kwlEVODSSTliWtOtH6sPkrtctF9ZtJ9GIerBskvhdVS5cFNv9s1BU0AbdUgdK4FG+dRnjFmDTzniRMdZO1QhzMK355vigbdkpz9P6qjUGE5J2qAcXmwJ20cZUiAD0z+pGMx6xkzJkmEf40Hr4qZfVg2XzF9YOyoV5BjzVkUJngKf8lgNYwKECEHrCNDrWZzMlflS3yBhr/InyoUgBc/lKT4pxVrrC6g1YwcceK3BmNxZcAtz3j5EIpqguh9H6wc011YN75cKDLpFDxuwkrPQmUwW4KTbj9mZTwBwLq4aQMUZbHm1rylJ46dzR0dua2n3RYCWZsiHROeywyJGR7mXKlpryyCiouY56sFkBWEnkEB/raeh/Sw4162KeuAxMQpEkzy5alMY5wamMsWKKrtW2WpEWNnReZWONKWjrdsKZarpFjqCslq773PLmEhM448Pc3+FKr1+94vv/rfw4tEcu+lKTBe4kZSdijBrykwv9vbCMPcLQTygBjzVckSLPRVGslqdunwJ4oegtFOYb4SwxNgWLCmD7T9kVjTv5YDgpo0XBmN34Z/rEHp0sgyz7lngsrm4lvMm2Mr1zNOJYJ5cuxuQxwMGJq/TP5emlb8fsQBZviK4t8hFL+zbhtlpwaRSxQRWfeETjuauPsdGxsBVdO7nmP4xvzSoT29pRl7kGqz+k26B3Oy0YNV+SXbbQas1ctC/GarskRdFpKczVAF1ZXnLcpaMuzVe6lZ2g/1ndcvOVgRG3sdUAY1bKD6achijMPdMxV4muKVorSpiDHituH7rSTs7n/4y5DhRXo4FVBN4vO/zbAcxhENzGbHCzU/98Mcx5e7a31kWjw9FCe/zNeYyQjZsWb1uc7U33pN4Mji6hCLhivqfa9Ss6xLg031AgfesA/l99m9fgvnaF9JoE6bYKmkGNK3aPbHB96w3+DnxFm4hs0drLsk7U8kf/N/CvwQNtllna0rjq61sH8L80HAuvwH1tvBy2ChqWSCaYTaGN19sTvlfzFD6n+iKTbvtayfrfe9ueWh6GJFoxLdr7V72a5ZpvHcCPDzma0wTO4EgbLyedxstO81n57LYBOBzyfsOhUKsW1J1BB5vr/tz8RyqOFylQP9Tvst2JALsC5lsH8PyQ40DV4ANzYa4dedNiKNR1s+x2wwbR7q4/4cTxqEk4LWDebfisuo36JXLiWFjOtLrlNWh3K1rRS4xvHcDNlFnNmWBBAl5SWaL3oPOfnvbr5pdjVnEaeBJSYjuLEkyLLsWhKccadmOphZkOPgVdalj2QpSmfOsADhMWE2ZBu4+EEJI4wKTAuCoC4xwQbWXBltpxbjkXJtKxxabo9e7tyhlgb6gNlSbUpMh+l/FaqzVwewGu8BW1Zx7pTpQDJUjb8tsUTW6+GDXbMn3mLbXlXJiGdggxFAoUrtPS3wE4Nk02UZG2OOzlk7fRs7i95QCLo3E0jtrjnM7SR3uS1p4qtS2nJ5OwtQVHgOvArLBFijZUV9QtSl8dAY5d0E0hM0w3HS2DpIeB6m/A1+HfhJcGUq4sOxH+x3f5+VO+Ds9rYNI7zPXOYWPrtf8bYMx6fuOAX5jzNR0PdsuON+X1f7EERxMJJoU6GkTEWBvVolVlb5lh3tKCg6Wx1IbaMDdJ+9sUCc5KC46hKGCk3IVOS4TCqdBNfUs7Kd4iXf2RjnT/LLysJy3XDcHLh/vde3x8DoGvwgsa67vBk91G5Pe/HbOe7xwym0NXbtiuuDkGO2IJDh9oQvJ4cY4vdoqLDuoH9Zl2F/ofsekn8lkuhIlhQcffUtSjytFyp++p6NiE7Rqx/lodgKVoceEp/CP4FfjrquZaTtj2AvH5K/ywpn7M34K/SsoYDAdIN448I1/0/wveW289T1/lX5xBzc8N5IaHr0XMOQdHsIkDuJFifj20pBm5jzwUv9e2FhwRsvhAbalCIuIw3bhJihY3p6nTFFIZgiSYjfTf3aXuOjmeGn4bPoGvwl+CFzTRczBIuHBEeImHc37/lGfwZR0cXzVDOvaKfNHvwe+suZ771K/y/XcBlsoN996JpBhoE2toYxOznNEOS5TJc6Id5GEXLjrWo+LEWGNpPDU4WAwsIRROu+1vM+0oW37z/MBN9kqHnSArwPfgFJ7Cq/Ai3Ie7g7ncmI09v8sjzw9mzOAEXoIHxURueaAce5V80f/DOuuZwHM8vsMb5wBzOFWM7wymTXPAEvm4vcFpZ2ut0VZRjkiP2MlmLd6DIpbGSiHOjdnUHN90hRYmhTnmvhzp1iKDNj+b7t5hi79lWGwQ+HN9RsfFMy0FXbEwhfuczKgCbyxYwBmcFhhvo/7a44v+i3XWcwDP86PzpGQYdWh7csP5dBvZ1jNzdxC8pBGuxqSW5vw40nBpj5JhMwvOzN0RWqERHMr4Lv1kWX84xLR830G3j6yqZ1a8UstTlW+qJPOZ+sZ7xZPKTJLhiNOAFd6tk+jrTH31ncLOxid8+nzRb128HhUcru/y0Wn6iT254YPC6FtVSIMoW2sk727AhvTtrWKZTvgsmckfXYZWeNRXx/3YQ2OUxLDrbHtN11IwrgXT6c8dATDwLniYwxzO4RzuQqTKSC5gAofMZ1QBK3zQ4JWobFbcvJm87FK+6JXrKahLn54m3p+McXzzYtP8VF/QpJuh1OwieElEoI1pRxPS09FBrkq2tWCU59+HdhNtTIqKm8EBrw2RTOEDpG3IKo2Y7mFdLm3ZeVjYwVw11o/oznceMve4CgMfNym/utA/d/ILMR7gpXzRy9eDsgLcgbs8O2Va1L0zzIdwGGemTBuwROHeoMShkUc7P+ISY3KH5ZZeWqO8mFTxQYeXTNuzvvK5FGPdQfuu00DwYFY9dyhctEt+OJDdnucfpmyhzUJzfsJjr29l8S0bXBfwRS9ZT26tmMIdZucch5ZboMz3Nio3nIOsYHCGoDT4kUA9MiXEp9Xsui1S8th/kbWIrMBxDGLodWUQIWcvnXy+9M23xPiSMOiRPqM+YMXkUN3gXFrZJwXGzUaMpJfyRS9ZT0lPe8TpScuRlbMHeUmlaKDoNuy62iWNTWNFYjoxFzuJs8oR+RhRx7O4SVNSXpa0ZJQ0K1LAHDQ+D9IepkMXpcsq5EVCvClBUIzDhDoyKwDw1Lc59GbTeORivugw1IcuaEOaGWdNm+Ps5fQ7/tm0DjMegq3yM3vb5j12qUId5UZD2oxDSEWOZMSqFl/W+5oynWDa/aI04tJRQ2eTXusg86SQVu/nwSYwpW6wLjlqIzwLuxGIvoAvul0PS+ZNz0/akp/pniO/8JDnGyaCkzbhl6YcqmK/69prxPqtpx2+Km9al9sjL+rwMgHw4jE/C8/HQ3m1vBuL1fldbzd8mOueVJ92syqdEY4KJjSCde3mcRw2TA6szxedn+zwhZMps0XrqEsiUjnC1hw0TELC2Ek7uAAdzcheXv1BYLagspxpzSAoZZUsIzIq35MnFQ9DOrlNB30jq3L4pkhccKUAA8/ocvN1Rzx9QyOtERs4CVsJRK/DF71kPYrxYsGsm6RMh4cps5g1DOmM54Ly1ii0Hd3Y/BMk8VWFgBVmhqrkJCPBHAolwZaWzLR9Vb7bcWdX9NyUYE+uB2BKfuaeBUcjDljbYVY4DdtsVWvzRZdWnyUzDpjNl1Du3aloAjVJTNDpcIOVVhrHFF66lLfJL1zJr9PQ2nFJSBaKoDe+sAvLufZVHVzYh7W0h/c6AAZ+7Tvj6q9j68G/cTCS/3n1vLKHZwNi+P+pS0WkZNMBMUl+LDLuiE4omZy71r3UFMwNJV+VJ/GC5ixVUkBStsT4gGKh0Gm4Oy3qvq7Lbmq24nPdDuDR9deR11XzP4vFu3TYzfnIyiSVmgizUYGqkIXNdKTY9pgb9D2Ix5t0+NHkVzCdU03suWkkVZAoCONCn0T35gAeW38de43mf97sMOpSvj4aa1KYUm58USI7Wxxes03bAZdRzk6UtbzMaCQ6IxO0dy7X+XsjoD16hpsBeGz9dfzHj+R/Hp8nCxZRqkEDTaCKCSywjiaoMJ1TITE9eg7Jqnq8HL6gDwiZb0u0V0Rr/rmvqjxKuaLCX7ZWXTvAY+uvm3z8CP7nzVpngqrJpZKwWnCUjIviYVlirlGOzPLI3SMVyp/elvBUjjDkNhrtufFFErQ8pmdSlbK16toBHlt/HV8uHMX/vEGALkV3RJREiSlopxwdMXOZPLZ+ix+kAHpMKIk8UtE1ygtquttwxNhphrIZ1IBzjGF3IIGxGcBj6q8bHJBG8T9vdsoWrTFEuebEZuVxhhClH6P5Zo89OG9fwHNjtNQTpD0TG9PJLEYqvEY6Rlxy+ZZGfL0Aj62/bnQCXp//eeM4KzfQVJbgMQbUjlMFIm6TpcfWlZje7NBSV6IsEVmumWIbjiloUzQX9OzYdo8L1wjw2PrrpimONfmfNyzKklrgnEkSzT5QWYQW40YShyzqsRmMXbvVxKtGuYyMKaU1ugenLDm5Ily4iT14fP11Mx+xJv+zZ3MvnfdFqxU3a1W/FTB4m3Qfsyc1XUcdVhDeUDZXSFHHLQj/Y5jtC7ZqM0CXGwB4bP11i3LhOvzPGygYtiUBiwQV/4wFO0majijGsafHyRLu0yG6q35cL1rOpVxr2s5cM2jJYMCdc10Aj6q/blRpWJ//+dmm5psMl0KA2+AFRx9jMe2WbC4jQxnikd4DU8TwUjRVacgdlhmr3bpddzuJ9zXqr2xnxJfzP29RexdtjDVZqzkqa6PyvcojGrfkXiJ8SEtml/nYskicv0ivlxbqjemwUjMw5evdg8fUX9nOiC/lf94Q2i7MURk9nW1MSj5j8eAyV6y5CN2S6qbnw3vdA1Iwq+XOSCl663udN3IzLnrt+us25cI1+Z83SXQUldqQq0b5XOT17bGpLd6ssN1VMPf8c+jG8L3NeCnMdF+Ra3fRa9dft39/LuZ/3vwHoHrqGmQFafmiQw6eyzMxS05K4bL9uA+SKUQzCnSDkqOGokXyJvbgJ/BHI+qvY69//4rl20NsmK2ou2dTsyIALv/91/8n3P2Aao71WFGi8KKv1fRC5+J67Q/507/E/SOshqN5TsmYIjVt+kcjAx98iz/4SaojbIV1rexE7/C29HcYD/DX4a0rBOF5VTu7omsb11L/AWcVlcVZHSsqGuXLLp9ha8I//w3Mv+T4Ew7nTBsmgapoCrNFObIcN4pf/Ob/mrvHTGqqgAupL8qWjWPS9m/31jAe4DjA+4+uCoQoT/zOzlrNd3qd4SdphFxsUvYwGWbTWtISc3wNOWH+kHBMfc6kpmpwPgHWwqaSUG2ZWWheYOGQGaHB+eQ/kn6b3pOgLV+ODSn94wDvr8Bvb70/LLuiPPEr8OGVWfDmr45PZyccEmsVXZGe1pRNX9SU5+AVQkNTIVPCHF/jGmyDC9j4R9LfWcQvfiETmgMMUCMN1uNCakkweZsowdYobiMSlnKA93u7NzTXlSfe+SVbfnPQXmg9LpYAQxpwEtONyEyaueWM4FPjjyjG3uOaFmBTWDNgBXGEiQpsaWhnAqIijB07Dlsy3fUGeP989xbWkyf+FF2SNEtT1E0f4DYYVlxFlbaSMPIRMk/3iMU5pME2SIWJvjckciebkQuIRRyhUvkHg/iUljG5kzVog5hV7vIlCuBrmlhvgPfNHQM8lCf+FEGsYbMIBC0qC9a0uuy2wLXVbLBaP5kjHokCRxapkQyzI4QEcwgYHRZBp+XEFTqXFuNVzMtjXLJgX4gAid24Hjwc4N3dtVSe+NNiwTrzH4WVUOlDobUqr1FuAgYllc8pmzoVrELRHSIW8ViPxNy4xwjBpyR55I6J220qQTZYR4guvUICJiSpr9gFFle4RcF/OMB7BRiX8sSfhpNSO3lvEZCQfLUVTKT78Ek1LRLhWN+yLyTnp8qWUZ46b6vxdRGXfHVqx3eI75YaLa4iNNiK4NOW7wPW6lhbSOF9/M9qw8e/aoB3d156qTzxp8pXx5BKAsYSTOIIiPkp68GmTq7sZtvyzBQaRLNxIZ+paozHWoLFeExIhRBrWitHCAHrCF7/thhD8JhYz84wg93QRV88wLuLY8zF8sQ36qF1J455bOlgnELfshKVxYOXKVuKx0jaj22sczTQqPqtV/XDgpswmGTWWMSDw3ssyUunLLrVPGjYRsH5ggHeHSWiV8kT33ycFSfMgkoOK8apCye0J6VW6GOYvffgU9RWsukEi2kUV2nl4dOYUzRik9p7bcA4ggdJ53LxKcEe17B1R8eqAd7dOepV8sTXf5lhejoL85hUdhDdknPtKHFhljOT+bdq0hxbm35p2nc8+Ja1Iw+tJykgp0EWuAAZYwMVwac5KzYMslhvgHdHRrxKnvhTYcfKsxTxtTETkjHO7rr3zjoV25lAQHrqpV7bTiy2aXMmUhTBnKS91jhtR3GEoF0oLnWhWNnYgtcc4N0FxlcgT7yz3TgNIKkscx9jtV1ZKpWW+Ub1tc1eOv5ucdgpx+FJy9pgbLE7xDyXb/f+hLHVGeitHOi6A7ybo3sF8sS7w7cgdk0nJaOn3hLj3uyD0Zp5pazFIUXUpuTTU18d1EPkDoX8SkmWTnVIozEdbTcZjoqxhNHf1JrSS/AcvHjZ/SMHhL/7i5z+POsTUh/8BvNfYMTA8n+yU/MlTZxSJDRStqvEuLQKWwDctMTQogUDyQRoTQG5Kc6oQRE1yV1jCA7ri7jdZyK0sYTRjCR0Hnnd+y7nHxNgTULqw+8wj0mQKxpYvhjm9uSUxg+TTy7s2GtLUGcywhXSKZN275GsqlclX90J6bRI1aouxmgL7Q0Nen5ziM80SqMIo8cSOo+8XplT/5DHNWsSUr/6lLN/QQ3rDyzLruEW5enpf7KqZoShEduuSFOV7DLX7Ye+GmXb6/hnNNqKsVXuMDFpb9Y9eH3C6NGEzuOuI3gpMH/I6e+zDiH1fXi15t3vA1czsLws0TGEtmPEJdiiFPwlwKbgLHAFk4P6ZyPdymYYHGE0dutsChQBl2JcBFlrEkY/N5bQeXQ18gjunuMfMfsBlxJSx3niO485fwO4fGD5T/+3fPQqkneWVdwnw/3bMPkW9Wbqg+iC765Zk+xcT98ibKZc2EdgHcLoF8cSOo/Oc8fS+OyEULF4g4sJqXVcmfMfsc7A8v1/yfGXmL9I6Fn5pRwZhsPv0TxFNlAfZCvG+Oohi82UC5f/2IsJo0cTOm9YrDoKhFPEUr/LBYTUNht9zelHXDqwfPCIw4owp3mOcIQcLttWXFe3VZ/j5H3cIc0G6oPbCR+6Y2xF2EC5cGUm6wKC5tGEzhsWqw5hNidUiKX5gFWE1GXh4/Qplw4sVzOmx9QxU78g3EF6wnZlEN4FzJ1QPSLEZz1KfXC7vd8ssGdIbNUYpVx4UapyFUHzJoTOo1McSkeNn1M5MDQfs4qQuhhX5vQZFw8suwWTcyYTgioISk2YdmkhehG4PkE7w51inyAGGaU+uCXADabGzJR1fn3lwkty0asIo8cROm9Vy1g0yDxxtPvHDAmpu+PKnM8Ix1wwsGw91YJqhteaWgjYBmmQiebmSpwKKzE19hx7jkzSWOm66oPbzZ8Yj6kxVSpYjVAuvLzYMCRo3oTQecOOjjgi3NQ4l9K5/hOGhNTdcWVOTrlgYNkEXINbpCkBRyqhp+LdRB3g0OU6rMfW2HPCFFMV9nSp+uB2woepdbLBuJQyaw/ZFysXrlXwHxI0b0LovEkiOpXGA1Ijagf+KUNC6rKNa9bQnLFqYNkEnMc1uJrg2u64ELPBHpkgWbmwKpJoDhMwNbbGzAp7Yg31wS2T5rGtzit59PrKhesWG550CZpHEzpv2NGRaxlNjbMqpmEIzygJqQfjypycs2pg2cS2RY9r8HUqkqdEgKTWtWTKoRvOBPDYBltja2SO0RGjy9UHtxwRjA11ujbKF+ti5cIR9eCnxUg6owidtyoU5tK4NLji5Q3HCtiyF2IqLGYsHViOXTXOYxucDqG0HyttqYAKqYo3KTY1ekyDXRAm2AWh9JmsVh/ccg9WJ2E8YjG201sPq5ULxxX8n3XLXuMInbft2mk80rRGjCGctJ8/GFdmEQ9Ug4FlE1ll1Y7jtiraqm5Fe04VV8lvSVBL8hiPrfFVd8+7QH3Qbu2ipTVi8cvSGivc9cj8yvH11YMHdNSERtuOslM97feYFOPKzGcsI4zW0YGAbTAOaxCnxdfiYUmVWslxiIblCeAYr9VYR1gM7GmoPrilunSxxeT3DN/2eBQ9H11+nk1adn6VK71+5+Jfct4/el10/7KBZfNryUunWSCPxPECk1rdOv1WVSrQmpC+Tl46YD3ikQYcpunSQgzVB2VHFhxHVGKDgMEY5GLlQnP7FMDzw7IacAWnO6sBr12u+XanW2AO0wQ8pknnFhsL7KYIqhkEPmEXFkwaN5KQphbkUmG72wgw7WSm9RiL9QT925hkjiVIIhphFS9HKI6/8QAjlpXqg9W2C0apyaVDwKQwrwLY3j6ADR13ZyUNByQXHQu6RY09Hu6zMqXRaNZGS/KEJs0cJEe9VH1QdvBSJv9h09eiRmy0V2uJcqHcShcdvbSNg5fxkenkVprXM9rDVnX24/y9MVtncvbKY706anNl3ASll9a43UiacVquXGhvq4s2FP62NGKfQLIQYu9q1WmdMfmUrDGt8eDS0cXozH/fjmUH6Jruvm50hBDSaEU/2Ru2LEN/dl006TSc/g7tfJERxGMsgDUEr104pfWH9lQaN+M4KWQjwZbVc2rZVNHsyHal23wZtIs2JJqtIc/WLXXRFCpJkfE9jvWlfFbsNQ9pP5ZBS0zKh4R0aMFj1IjTcTnvi0Zz2rt7NdvQb2mgbju1plsH8MmbnEk7KbK0b+wC2iy3aX3szW8xeZvDwET6hWZYwqTXSSG+wMETKum0Dq/q+x62gt2ua2ppAo309TRk9TPazfV3qL9H8z7uhGqGqxNVg/FKx0HBl9OVUORn8Q8Jx9gFttGQUDr3tzcXX9xGgN0EpzN9mdZ3GATtPhL+CjxFDmkeEU6x56kqZRusLzALXVqkCN7zMEcqwjmywDQ6OhyUe0Xao1Qpyncrg6wKp9XfWDsaZplElvQ/b3sdweeghorwBDlHzgk1JmMc/wiERICVy2VJFdMjFuLQSp3S0W3+sngt2njwNgLssFGVQdJ0tu0KH4ky1LW4yrbkuaA6Iy9oz/qEMMXMMDWyIHhsAyFZc2peV9hc7kiKvfULxCl9iddfRK1f8kk9qvbdOoBtOg7ZkOZ5MsGrSHsokgLXUp9y88smniwWyuFSIRVmjplga3yD8Uij5QS1ZiM4U3Qw5QlSm2bXjFe6jzzBFtpg+/YBbLAWG7OPynNjlCw65fukGNdkJRf7yM1fOxVzbxOJVocFoYIaGwH22mIQkrvu1E2nGuebxIgW9U9TSiukPGU+Lt++c3DJPKhyhEEbXCQLUpae2exiKy6tMPe9mDRBFCEMTWrtwxN8qvuGnt6MoihKWS5NSyBhbH8StXoAz8PLOrRgLtOT/+4vcu+7vDLnqNvztOq7fmd8sMmY9Xzn1zj8Dq8+XVdu2Nv0IIySgEdQo3xVHps3Q5i3fLFsV4aiqzAiBhbgMDEd1uh8qZZ+lwhjkgokkOIv4xNJmyncdfUUzgB4oFMBtiu71Xumpz/P+cfUP+SlwFExwWW62r7b+LSPxqxn/gvMZ5z9C16t15UbNlq+jbGJtco7p8wbYlL4alSyfWdeuu0j7JA3JFNuVAwtst7F7FhWBbPFNKIUORndWtLraFLmMu7KFVDDOzqkeaiN33YAW/r76wR4XDN/yN1z7hejPau06EddkS/6XThfcz1fI/4K736fO48vlxt2PXJYFaeUkFS8U15XE3428xdtn2kc8GQlf1vkIaNRRnOMvLTWrZbElEHeLWi1o0dlKPAh1MVgbbVquPJ5+Cr8LU5/H/+I2QlHIU2ClXM9G8v7Rr7oc/hozfUUgsPnb3D+I+7WF8kNO92GY0SNvuxiE+2Bt8prVJTkzE64sfOstxuwfxUUoyk8VjcTlsqe2qITSFoSj6Epd4KsT6BZOWmtgE3hBfir8IzZDwgV4ZTZvD8VvPHERo8v+vL1DASHTz/i9OlKueHDjK5Rnx/JB1Vb1ioXdBra16dmt7dgik10yA/FwJSVY6XjA3oy4SqM2frqDPPSRMex9qs3XQtoWxMj7/Er8GWYsXgjaVz4OYumP2+9kbxvny/6kvWsEBw+fcb5bInc8APdhpOSs01tEqIkoiZjbAqKMruLbJYddHuHFRIyJcbdEdbl2sVLaySygunutBg96Y2/JjKRCdyHV+AEFtTvIpbKIXOamknYSiB6KV/0JetZITgcjjk5ZdaskBtWO86UF0ap6ozGXJk2WNiRUlCPFir66lzdm/SLSuK7EUdPz8f1z29Skq6F1fXg8+5UVR6bszncP4Tn4KUkkdJ8UFCY1zR1i8RmL/qQL3rlei4THG7OODlnKko4oI01kd3CaM08Ia18kC3GNoVaO9iDh+hWxSyTXFABXoau7Q6q9OxYg/OVEMw6jdbtSrJ9cBcewGmaZmg+bvkUnUUaGr+ZfnMH45Ivevl61hMcXsxYLFTu1hTm2zViCp7u0o5l+2PSUh9bDj6FgYypufBDhqK2+oXkiuHFHR3zfj+9PtA8oR0xnqX8qn+sx3bFODSbbF0X8EUvWQ8jBIcjo5bRmLOljDNtcqNtOe756h3l0VhKa9hDd2l1eqmsnh0MNMT/Cqnx6BInumhLT8luljzQ53RiJeA/0dxe5NK0o2fA1+GLXr6eNQWHNUOJssQaTRlGpLHKL9fD+IrQzTOMZS9fNQD4AnRNVxvTdjC+fJdcDDWQcyB00B0t9BDwTxXgaAfzDZ/DBXzRnfWMFRwuNqocOmX6OKNkY63h5n/fFcB28McVHqnXZVI27K0i4rDLNE9lDKV/rT+udVbD8dFFu2GGZ8mOt0kAXcoX3ZkIWVtw+MNf5NjR2FbivROHmhV1/pj2egv/fMGIOWTIWrV3Av8N9imV9IWml36H6cUjqEWNv9aNc+veb2sH46PRaHSuMBxvtW+twxctq0z+QsHhux8Q7rCY4Ct8lqsx7c6Sy0dl5T89rIeEuZKoVctIk1hNpfavER6yyH1Vvm3MbsUHy4ab4hWr/OZPcsRBphnaV65/ZcdYPNNwsjN/djlf9NqCw9U5ExCPcdhKxUgLSmfROpLp4WSUr8ojdwbncbvCf+a/YzRaEc6QOvXcGO256TXc5Lab9POvB+AWY7PigWYjzhifbovuunzRawsO24ZqQQAqguBtmpmPB7ysXJfyDDaV/aPGillgz1MdQg4u5MYaEtBNNHFjkRlSpd65lp4hd2AVPTfbV7FGpyIOfmNc/XVsPfg7vzaS/3nkvLL593ANLvMuRMGpQIhiF7kUEW9QDpAUbTWYBcbp4WpacHHY1aacqQyjGZS9HI3yCBT9kUZJhVOD+zUDvEH9ddR11fzPcTDQ5TlgB0KwqdXSavk9BC0pKp0WmcuowSw07VXmXC5guzSa4p0UvRw2lbDiYUx0ExJJRzWzi6Gm8cnEkfXXsdcG/M/jAJa0+bmCgdmQ9CYlNlSYZOKixmRsgiFxkrmW4l3KdFKv1DM8tk6WxPYJZhUUzcd8Kdtgrw/gkfXXDT7+avmfVak32qhtkg6NVdUS5wgkru1YzIkSduTW1FDwVWV3JQVJVuieTc0y4iDpFwc7/BvSalvKdQM8sv662cevz/+8sQVnjVAT0W2wLllw1JiMhJRxgDjCjLQsOzSFSgZqx7lAW1JW0e03yAD3asC+GD3NbQhbe+mN5GXH1F83KDOM4n/e5JIuH4NpdQARrFPBVptUNcjj4cVMcFSRTE2NpR1LEYbYMmfWpXgP9KejaPsLUhuvLCsVXznAG9dfx9SR1ud/3hZdCLHb1GMdPqRJgqDmm76mHbvOXDtiO2QPUcKo/TWkQ0i2JFXpBoo7vij1i1Lp3ADAo+qvG3V0rM//vFnnTE4hxd5Ka/Cor5YEdsLVJyKtDgVoHgtW11pWSjolPNMnrlrVj9Fv2Qn60twMwKPqr+N/wvr8z5tZcDsDrv06tkqyzESM85Ycv6XBWA2birlNCXrI6VbD2lx2L0vQO0QVTVVLH4SE67fgsfVXv8n7sz7/85Z7cMtbE6f088wSaR4kCkCm10s6pKbJhfqiUNGLq+0gLWC6eUAZFPnLjwqtKd8EwGvWX59t7iPW4X/eAN1svgRVSY990YZg06BD1ohLMtyFTI4pKTJsS9xREq9EOaPWiO2gpms7397x6nQJkbh+Fz2q/rqRROX6/M8bJrqlVW4l6JEptKeUFuMYUbtCQ7CIttpGc6MY93x1r1vgAnRXvY5cvwWPqb9uWQm+lP95QxdNMeWhOq1x0Db55C7GcUv2ZUuN6n8iKzsvOxibC//Yfs9Na8r2Rlz02vXXDT57FP/zJi66/EJSmsJKa8QxnoqW3VLQ+jZVUtJwJ8PNX1NQCwfNgdhhHD9on7PdRdrdGPF28rJr1F+3LBdeyv+8yYfLoMYet1vX4upNAjVvwOUWnlNXJXlkzk5Il6kqeoiL0C07qno+/CYBXq/+utlnsz7/Mzvy0tmI4zm4ag23PRN3t/CWryoUVJGm+5+K8RJ0V8Hc88/XHUX/HfiAq7t+BH+x6v8t438enWmdJwFA6ZINriLGKv/95f8lT9/FnyA1NMVEvQyaXuu+gz36f/DD73E4pwqpLcvm/o0Vle78n//+L/NPvoefp1pTJye6e4A/D082FERa5/opeH9zpvh13cNm19/4v/LDe5xMWTi8I0Ta0qKlK27AS/v3/r+/x/2GO9K2c7kVMonDpq7//jc5PKCxeNPpFVzaRr01wF8C4Pu76hXuX18H4LduTr79guuFD3n5BHfI+ZRFhY8w29TYhbbLi/bvBdqKE4fUgg1pBKnV3FEaCWOWyA+m3WpORZr/j+9TKJtW8yBTF2/ZEODI9/QavHkVdGFp/Pjn4Q+u5hXapsP5sOH+OXXA1LiKuqJxiMNbhTkbdJTCy4llEt6NnqRT4dhg1V3nbdrm6dYMecA1yTOL4PWTE9L5VzPFlLBCvlG58AhehnN4uHsAYinyJ+AZ/NkVvELbfOBUuOO5syBIEtiqHU1k9XeISX5bsimrkUUhnGDxourN8SgUsCZVtKyGbyGzHXdjOhsAvOAswSRyIBddRdEZWP6GZhNK/yjwew9ehBo+3jEADu7Ay2n8mDc+TS7awUHg0OMzR0LABhqLD4hJEh/BEGyBdGlSJoXYXtr+3HS4ijzVpgi0paWXtdruGTknXBz+11qT1Q2inxaTzQCO46P3lfLpyS4fou2PH/PupwZgCxNhGlj4IvUuWEsTkqMWm6i4xCSMc9N1RDQoCVcuGItJ/MRWefais+3synowi/dESgJjkilnWnBTGvRWmaw8oR15257t7CHmCf8HOn7cwI8+NQBXMBEmAa8PMRemrNCEhLGEhDQKcGZWS319BX9PFBEwGTbRBhLbDcaV3drFcDqk5kCTd2JF1Wp0HraqBx8U0wwBTnbpCadwBA/gTH/CDrcCs93LV8E0YlmmcyQRQnjBa8JESmGUfIjK/7fkaDJpmD2QptFNVJU1bbtIAjjWQizepOKptRjbzR9Kag6xZmMLLjHOtcLT3Tx9o/0EcTT1XN3E45u24AiwEypDJXihKjQxjLprEwcmRKclaDNZCVqr/V8mYWyFADbusiY5hvgFoU2vio49RgJLn5OsReRFN6tabeetiiy0V7KFHT3HyZLx491u95sn4K1QQSPKM9hNT0wMVvAWbzDSVdrKw4zRjZMyJIHkfq1VAVCDl/bUhNKlGq0zGr05+YAceXVPCttVk0oqjVwMPt+BBefx4yPtGVkUsqY3CHDPiCM5ngupUwCdbkpd8kbPrCWHhkmtIKLEetF2499eS1jZlIPGYnlcPXeM2KD9vLS0bW3ktYNqUllpKLn5ZrsxlIzxvDu5eHxzGLctkZLEY4PgSOg2IUVVcUONzUDBEpRaMoXNmUc0tFZrTZquiLyKxrSm3DvIW9Fil+AkhXu5PhEPx9mUNwqypDvZWdKlhIJQY7vn2OsnmBeOWnYZ0m1iwbbw1U60by5om47iHRV6fOgzjMf/DAZrlP40Z7syxpLK0lJ0gqaAK1c2KQKu7tabTXkLFz0sCftuwX++MyNeNn68k5Buq23YQhUh0SNTJa1ioQ0p4nUG2y0XilF1JqODqdImloPS4Bp111DEWT0jJjVv95uX9BBV7eB3bUWcu0acSVM23YZdd8R8UbQUxJ9wdu3oMuhdt929ME+mh6JXJ8di2RxbTi6TbrDquqV4aUKR2iwT6aZbyOwEXN3DUsWr8Hn4EhwNyHuXHh7/pdaUjtR7vnDh/d8c9xD/s5f501eQ1+CuDiCvGhk1AN/4Tf74RfxPwD3toLarR0zNtsnPzmS64KIRk861dMWCU8ArasG9T9H0ZBpsDGnjtAOM2+/LuIb2iIUGXNgl5ZmKD/Tw8TlaAuihaFP5yrw18v4x1898zIdP+DDAX1bM3GAMvPgRP/cJn3zCW013nrhHkrITyvYuwOUkcHuKlRSW5C6rzIdY4ppnF7J8aAJbQepgbJYBjCY9usGXDKQxq7RZfh9eg5d1UHMVATRaD/4BHK93/1iAgYZ/+jqPn8Dn4UExmWrpa3+ZOK6MvM3bjwfzxNWA2dhs8+51XHSPJiaAhGSpWevEs5xHLXcEGFXYiCONySH3fPWq93JIsBiSWvWyc3CAN+EcXoT7rCSANloPPoa31rt/5PUA/gp8Q/jDD3hyrjzlR8VkanfOvB1XPubt17vzxAfdSVbD1pzAnfgyF3ycadOTOTXhpEUoLC1HZyNGW3dtmjeXgr2r56JNmRwdNNWaQVBddd6rh4MhviEB9EFRD/7RGvePvCbwAL4Mx/D6M541hHO4D3e7g6PafdcZVw689z7NGTwo5om7A8sPhccT6qKcl9NJl9aM/9kX+e59Hh1yPqGuCCZxuITcsmNaJ5F7d0q6J3H48TO1/+M57085q2icdu2U+W36Ldllz9Agiv4YGljoEN908EzvDOrBF98/vtJwCC/BF2AG75xxEmjmMIcjxbjoaxqOK3/4hPOZzhMPBpYPG44CM0dTVm1LjLtUWWVz1Bcf8tEx0zs8O2A2YVHRxKYOiy/aOVoAaMu0i7ubu43njjmd4ibMHU1sIDHaQNKrZND/FZYdk54oCXetjq7E7IVl9eAL7t+oHnwXXtLx44czzoRFHBztYVwtH1d+NOMkupZ5MTM+gUmq90X+Bh9zjRlmaQ+m7YMqUL/veemcecAtOJ0yq1JnVlN27di2E0+Klp1tAJ4KRw1eMI7aJjsO3R8kPSI3fUFXnIOfdQe86sIIVtWDL7h//Ok6vj8vwDk08NEcI8zz7OhBy+WwalzZeZ4+0XniRfst9pAJqQHDGLzVQ2pheZnnv1OWhwO43/AgcvAEXEVVpa4db9sGvNK8wjaENHkfFQ4Ci5i7dqnQlPoLQrHXZDvO3BIXZbJOBrOaEbML6sFL798I4FhKihjHMsPjBUZYCMFr6nvaArxqXPn4lCa+cHfSa2cP27g3Z3ziYTRrcbQNGLQmGF3F3cBdzzzX7AILx0IB9rbwn9kx2G1FW3Inic+ZLIsVvKR8Zwfj0l1fkqo8LWY1M3IX14OX3r9RKTIO+d9XzAI8qRPGPn/4NC2n6o4rN8XJ82TOIvuVA8zLKUHRFgBCetlDZlqR1gLKjS39xoE7Bt8UvA6BxuEDjU3tFsEijgA+615tmZkXKqiEENrh41iLDDZNq4pKTWR3LZfnos81LOuNa15cD956vLMsJd1rqYp51gDUQqMYm2XsxnUhD2jg1DM7SeuJxxgrmpfISSXVIJIS5qJJSvJPEQ49DQTVIbYWJ9QWa/E2+c/oPK1drmC7WSfJRNKBO5Yjvcp7Gc3dmmI/Xh1kDTEuiSnWqQf37h+fTMhGnDf6dsS8SQfQWlqqwXXGlc/PEZ/SC5mtzIV0nAshlQdM/LvUtYutrEZ/Y+EAFtq1k28zQhOwLr1AIeANzhF8t9qzTdZf2qRKO6MWE9ohBYwibbOmrFtNmg3mcS+tB28xv2uKd/agYCvOP+GkSc+0lr7RXzyufL7QbkUpjLjEWFLqOIkAGu2B0tNlO9Eau2W1qcOUvVRgKzypKIQZ5KI3q0MLzqTNRYqiZOqmtqloIRlmkBHVpHmRYV6/HixbO6UC47KOFJnoMrVyr7wYz+SlW6GUaghYbY1I6kkxA2W1fSJokUdSh2LQ1GAimRGm0MT+uu57H5l7QgOWxERpO9moLRPgTtquWCfFlGlIjQaRly9odmzMOWY+IBO5tB4sW/0+VWGUh32qYk79EidWKrjWuiLpiVNGFWFRJVktyeXWmbgBBzVl8anPuXyNJlBJOlKLTgAbi/EYHVHxWiDaVR06GnHQNpJcWcK2jJtiCfG2sEHLzuI66sGrMK47nPIInPnu799935aOK2cvmvubrE38ZzZjrELCmXM2hM7UcpXD2oC3+ECVp7xtIuxptJ0jUr3sBmBS47TVxlvJ1Sqb/E0uLdvLj0lLr29ypdd/eMX3f6lrxGlKwKQxEGvw0qHbkbwrF3uHKwVENbIV2wZ13kNEF6zD+x24aLNMfDTCbDPnEikZFyTNttxWBXDaBuM8KtI2rmaMdUY7cXcUPstqTGvBGSrFWIpNMfbdea990bvAOC1YX0qbc6smDS1mPxSJoW4fwEXvjMmhlijDRq6qale6aJEuFGoppYDoBELQzLBuh/mZNx7jkinv0EtnUp50lO9hbNK57lZaMAWuWR5Yo9/kYwcYI0t4gWM47Umnl3YmpeBPqSyNp3K7s2DSAS/39KRuEN2bS4xvowV3dFRMx/VFcp2Yp8w2nTO9hCXtHG1kF1L4KlrJr2wKfyq77R7MKpFKzWlY9UkhYxyHWW6nBWPaudvEAl3CGcNpSXPZ6R9BbBtIl6cHL3gIBi+42CYXqCx1gfGWe7Ap0h3luyXdt1MKy4YUT9xSF01G16YEdWsouW9mgDHd3veyA97H+Ya47ZmEbqMY72oPztCGvK0onL44AvgC49saZKkWRz4veWljE1FHjbRJaWv6ZKKtl875h4CziFCZhG5rx7tefsl0aRT1bMHZjm8dwL/6u7wCRysaQblQoG5yAQN5zpatMNY/+yf8z+GLcH/Qn0iX2W2oEfXP4GvwQHuIL9AYGnaO3zqAX6946nkgqZNnUhx43DIdQtMFeOPrgy/y3Yd85HlJWwjLFkU3kFwq28xPnuPhMWeS+tDLV9Otllq7pQCf3uXJDN9wFDiUTgefHaiYbdfi3b3u8+iY6TnzhgehI1LTe8lcd7s1wJSzKbahCRxKKztTLXstGAiu3a6rPuQs5pk9TWAan5f0BZmGf7Ylxzzk/A7PAs4QPPPAHeFQ2hbFHszlgZuKZsJcUmbDC40sEU403cEjczstOEypa+YxevL4QBC8oRYqWdK6b7sK25tfE+oDZgtOQ2Jg8T41HGcBE6fTWHn4JtHcu9S7uYgU5KSCkl/mcnq+5/YBXOEr6lCUCwOTOM1taOI8mSxx1NsCXBEmLKbMAg5MkwbLmpBaFOPrNSlO2HnLiEqW3tHEwd8AeiQLmn+2gxjC3k6AxREqvKcJbTEzlpLiw4rNZK6oJdidbMMGX9FULKr0AkW+2qDEPBNNm5QAt2Ik2nftNWHetubosHLo2nG4vQA7GkcVCgVCgaDixHqo9UUn1A6OshapaNR/LPRYFV8siT1cCtJE0k/3WtaNSuUZYKPnsVIW0xXWnMUxq5+En4Kvw/MqQmVXnAXj9Z+9zM98zM/Agy7F/qqj2Nh67b8HjFnPP3iBn/tkpdzwEJX/whIcQUXOaikeliCRGUk7tiwF0rItwMEhjkZ309hikFoRAmLTpEXWuHS6y+am/KB/fM50aLEhGnSMwkpxzOov4H0AvgovwJ1iGzDLtJn/9BU+fAINfwUe6FHSLhu83viV/+/HrOePX+STT2B9uWGbrMHHLldRBlhS/CJQmcRxJFqZica01XixAZsYiH1uolZxLrR/SgxVIJjkpQP4PE9sE59LKLr7kltSBogS5tyszzH8Fvw8/AS8rNOg0xUS9fIaHwb+6et8Q/gyvKRjf5OusOzGx8evA/BP4IP11uN/grca5O0lcsPLJ5YjwI4QkJBOHa0WdMZYGxPbh2W2nR9v3WxEWqgp/G3+6VZbRLSAAZ3BhdhAaUL33VUSw9yjEsvbaQ9u4A/gGXwZXoEHOuU1GSj2chf+Mo+f8IcfcAxfIKVmyunRbYQVnoevwgfw3TXXcw++xNuP4fhyueEUNttEduRVaDttddoP0eSxLe2LENk6itYxlrxBNBYrNNKSQmeaLcm9c8UsaB5WyO6675yyQIAWSDpBVoA/gxmcwEvwoDv0m58UE7gHn+fJOa8/Ywan8EKRfjsopF83eCglX/Sfr7OeaRoQfvt1CGvIDccH5BCvw1sWIzRGC/66t0VTcLZQZtm6PlAasbOJ9iwWtUo7biktTSIPxnR24jxP1ZKaqq+2RcXM9OrBAm/AAs7hDJ5bNmGb+KIfwCs8a3jnjBrOFeMjHSCdbKr+2uOLfnOd9eiA8Hvvwwq54VbP2OqwkB48Ytc4YEOiH2vTXqodabfWEOzso4qxdbqD5L6tbtNPECqbhnA708DZH4QOJUXqScmUlks7Ot6FBuZw3n2mEbaUX7kDzxHOOQk8nKWMzAzu6ZZ8sOFw4RK+6PcuXo9tB4SbMz58ApfKDXf3szjNIIbGpD5TKTRxGkEMLjLl+K3wlWXBsCUxIDU+jbOiysESqAy1MGUJpXgwbTWzNOVEziIXZrJ+VIztl1PUBxTSo0dwn2bOmfDRPD3TRTGlfbCJvO9KvuhL1hMHhB9wPuPRLGHcdOWG2xc0U+5bQtAJT0nRTewXL1pgk2+rZAdeWmz3jxAqfNQQdzTlbF8uJ5ecEIWvTkevAHpwz7w78QujlD/Lr491bD8/1vhM2yrUQRrWXNQY4fGilfctMWYjL72UL/qS9eiA8EmN88nbNdour+PBbbAjOjIa4iBhfFg6rxeKdEGcL6p3EWR1Qq2Qkhs2DrnkRnmN9tG2EAqmgPw6hoL7Oza7B+3SCrR9tRftko+Lsf2F/mkTndN2LmzuMcKTuj/mX2+4Va3ki16+nnJY+S7MefpkidxwnV+4wkXH8TKnX0tsYzYp29DOOoSW1nf7nTh2akYiWmcJOuTidSaqESrTYpwjJJNVGQr+rLI7WsqerHW6Kp/oM2pKuV7T1QY9gjqlZp41/WfKpl56FV/0kvXQFRyeQ83xaTu5E8p5dNP3dUF34ihyI3GSpeCsywSh22ZJdWto9winhqifb7VRvgktxp13vyjrS0EjvrRfZ62uyqddSWaWYlwTPAtJZ2oZ3j/Sgi/mi+6vpzesfAcWNA0n8xVyw90GVFGuZjTXEQy+6GfLGLMLL523f5E0OmxVjDoOuRiH91RKU+vtoCtH7TgmvBLvtFXWLW15H9GTdVw8ow4IlRLeHECN9ym1e9K0I+Cbnhgv4Yu+aD2HaQJ80XDqOzSGAV4+4yCqBxrsJAX6ZTIoX36QnvzhhzzMfFW2dZVLOJfo0zbce5OvwXMFaZ81mOnlTVXpDZsQNuoYWveketKb5+6JOOsgX+NTm7H49fUTlx+WLuWL7qxnOFh4BxpmJx0p2gDzA/BUARuS6phR+pUsY7MMboAHx5xNsSVfVZcYSwqCKrqon7zM+8ecCkeS4nm3rINuaWvVNnMRI1IRpxTqx8PZUZ0Br/UEduo3B3hNvmgZfs9gQPj8vIOxd2kndir3awvJ6BLvoUuOfFWNYB0LR1OQJoUySKb9IlOBx74q1+ADC2G6rOdmFdJcD8BkfualA+BdjOOzP9uUhGUEX/TwhZsUduwRr8wNuXKurCixLBgpQI0mDbJr9dIqUuV+92ngkJZ7xduCk2yZKbfWrH1VBiTg9VdzsgRjW3CVXCvAwDd+c1z9dWw9+B+8MJL/eY15ZQ/HqvTwVdsZn5WQsgRRnMaWaecu3jFvMBEmgg+FJFZsnSl0zjB9OqPYaBD7qmoVyImFvzi41usesV0julaAR9dfR15Xzv9sEruRDyk1nb+QaLU67T885GTls6YgcY+UiMa25M/pwGrbCfzkvR3e0jjtuaFtnwuagHTSb5y7boBH119HXhvwP487jJLsLJ4XnUkHX5sLbS61dpiAXRoZSCrFJ+EjpeU3puVfitngYNo6PJrAigKktmwjyQdZpfq30mmtulaAx9Zfx15Xzv+cyeuiBFUs9zq8Kq+XB9a4PVvph3GV4E3y8HENJrN55H1X2p8VyqSKwVusJDKzXOZzplWdzBUFK9e+B4+uv468xvI/b5xtSAkBHQaPvtqWzllVvEOxPbuiE6+j2pvjcKsbvI7txnRErgfH7LdXqjq0IokKzga14GzQ23SSbCQvO6r+Or7SMIr/efOkkqSdMnj9mBx2DRsiY29Uj6+qK9ZrssCKaptR6HKURdwUYeUWA2kPzVKQO8ku2nU3Anhs/XWkBx3F/7wJtCTTTIKftthue1ty9xvNYLY/zo5KSbIuKbXpbEdSyeRyYdAIwKY2neyoc3+k1XUaufYga3T9daMUx/r8z1s10ITknIO0kuoMt+TB8jK0lpayqqjsJ2qtXAYwBU932zinimgmd6mTRDnQfr88q36NAI+tv24E8Pr8zxtasBqx0+xHH9HhlrwsxxNUfKOHQaZBITNf0uccj8GXiVmXAuPEAKSdN/4GLHhs/XWj92dN/uetNuBMnVR+XWDc25JLjo5Mg5IZIq226tmCsip2zZliL213YrTlL2hcFjpCduyim3M7/eB16q/blQsv5X/esDRbtJeabLIosWy3ycavwLhtxdWzbMmHiBTiVjJo6lCLjXZsi7p9PEPnsq6X6wd4bP11i0rD5fzPm/0A6brrIsllenZs0lCJlU4abakR59enZKrKe3BZihbTxlyZ2zl1+g0wvgmA166/bhwDrcn/7Ddz0eWZuJvfSESug6NzZsox3Z04FIxz0mUjMwVOOVTq1CQ0AhdbBGVdjG/CgsfUX7esJl3K/7ytWHRv683praW/8iDOCqWLLhpljDY1ZpzK75QiaZoOTpLKl60auHS/97oBXrv+umU9+FL+5+NtLFgjqVLCdbmj7pY5zPCPLOHNCwXGOcLquOhi8CmCWvbcuO73XmMUPab+ug3A6/A/78Bwe0bcS2+tgHn4J5pyS2WbOck0F51Vq3LcjhLvZ67p1ABbaL2H67bg78BfjKi/jr3+T/ABV3ilLmNXTI2SpvxWBtt6/Z//D0z/FXaGbSBgylzlsEGp+5//xrd4/ae4d8DUUjlslfIYS3t06HZpvfQtvv0N7AHWqtjP2pW08QD/FLy//da38vo8PNlKHf5y37Dxdfe/oj4kVIgFq3koLReSR76W/bx//n9k8jonZxzWTANVwEniDsg87sOSd/z7//PvMp3jQiptGVWFX2caezzAXwfgtzYUvbr0iozs32c3Uge7varH+CNE6cvEYmzbPZ9hMaYDdjK4V2iecf6EcEbdUDVUARda2KzO/JtCuDbNQB/iTeL0EG1JSO1jbXS+nLxtPMDPw1fh5+EPrgSEKE/8Gry5A73ui87AmxwdatyMEBCPNOCSKUeRZ2P6Myb5MRvgCHmA9ywsMifU+AYXcB6Xa5GibUC5TSyerxyh0j6QgLVpdyhfArRTTLqQjwe4HOD9s92D4Ap54odXAPBWLAwB02igG5Kkc+piN4lvODIFGAZgT+EO4Si1s7fjSR7vcQETUkRm9O+MXyo9OYhfe4xt9STQ2pcZRLayCV90b4D3jR0DYAfyxJ+eywg2IL7NTMXna7S/RpQ63JhWEM8U41ZyQGjwsVS0QBrEKLu8xwZsbi4wLcCT+OGidPIOCe1PiSc9Qt+go+vYqB7cG+B9d8cAD+WJPz0Am2gxXgU9IneOqDpAAXOsOltVuMzpdakJXrdPCzXiNVUpCeOos5cxnpQT39G+XVLhs1osQVvJKPZyNq8HDwd4d7pNDuWJPxVX7MSzqUDU6gfadKiNlUFTzLeFHHDlzO4kpa7aiKhBPGKwOqxsBAmYkOIpipyXcQSPlRTf+Tii0U3EJGaZsDER2qoB3h2hu0qe+NNwUooYU8y5mILbJe6OuX+2FTKy7bieTDAemaQyQ0CPthljSWO+xmFDIYiESjM5xKd6Ik5lvLq5GrQ3aCMLvmCA9wowLuWJb9xF59hVVP6O0CrBi3ZjZSNOvRy+I6klNVRJYRBaEzdN+imiUXQ8iVF8fsp+W4JXw7WISW7fDh7lptWkCwZ4d7QTXyBPfJMYK7SijjFppGnlIVJBJBYj7eUwtiP1IBXGI1XCsjNpbjENVpSAJ2hq2LTywEly3hUYazt31J8w2+aiLx3g3fohXixPfOMYm6zCGs9LVo9MoW3MCJE7R5u/WsOIjrqBoHUO0bJE9vxBpbhsd3+Nb4/vtPCZ4oZYCitNeYuC/8UDvDvy0qvkiW/cgqNqRyzqSZa/s0mqNGjtKOoTm14zZpUauiQgVfqtQiZjq7Q27JNaSK5ExRcrGCXO1FJYh6jR6CFqK7bZdQZ4t8g0rSlPfP1RdBtqaa9diqtzJkQ9duSryi2brQXbxDwbRUpFMBHjRj8+Nt7GDKgvph9okW7LX47gu0SpGnnFQ1S1lYldOsC7hYteR574ZuKs7Ei1lBsfdz7IZoxzzCVmmVqaSySzQbBVAWDek+N4jh9E/4VqZrJjPwiv9BC1XcvOWgO8275CVyBPvAtTVlDJfZkaZGU7NpqBogAj/xEHkeAuJihWYCxGN6e8+9JtSegFXF1TrhhLGP1fak3pebgPz192/8gB4d/6WT7+GdYnpH7hH/DJzzFiYPn/vjW0SgNpTNuPIZoAEZv8tlGw4+RLxy+ZjnKa5NdFoC7UaW0aduoYse6+bXg1DLg6UfRYwmhGEjqPvF75U558SANrElK/+MdpXvmqBpaXOa/MTZaa1DOcSiLaw9j0NNNst3c+63c7EKTpkvKHzu6bPbP0RkuHAVcbRY8ijP46MIbQeeT1mhA+5PV/inyDdQipf8LTvMXbwvoDy7IruDNVZKTfV4CTSRUYdybUCnGU7KUTDxLgCknqUm5aAW6/1p6eMsOYsphLzsHrE0Y/P5bQedx1F/4yPHnMB3/IOoTU9+BL8PhtjuFKBpZXnYNJxTuv+2XqolKR2UQgHhS5novuxVySJhBNRF3SoKK1XZbbXjVwWNyOjlqWJjrWJIy+P5bQedyldNScP+HZ61xKSK3jyrz+NiHG1hcOLL/+P+PDF2gOkekKGiNWKgJ+8Z/x8Iv4DdQHzcpZyF4v19I27w9/yPGDFQvmEpKtqv/TLiWMfn4sofMm9eAH8Ao0zzh7h4sJqYtxZd5/D7hkYPneDzl5idlzNHcIB0jVlQ+8ULzw/nc5/ojzl2juE0apD7LRnJxe04dMz2iOCFNtGFpTuXA5AhcTRo8mdN4kz30nVjEC4YTZQy4gpC7GlTlrePKhGsKKgeXpCYeO0MAd/GH7yKQUlXPLOasOH3FnSphjHuDvEu4gB8g66oNbtr6eMbFIA4fIBJkgayoXriw2XEDQPJrQeROAlY6aeYOcMf+IVYTU3XFlZufMHinGywaW3YLpObVBAsbjF4QJMsVUSayjk4voPsHJOQfPWDhCgDnmDl6XIRerD24HsGtw86RMHOLvVSHrKBdeVE26gKB5NKHzaIwLOmrqBWJYZDLhASG16c0Tn+CdRhWDgWXnqRZUTnPIHuMJTfLVpkoYy5CzylHVTGZMTwkGAo2HBlkQplrJX6U+uF1wZz2uwS1SQ12IqWaPuO4baZaEFBdukksJmkcTOm+YJSvoqPFzxFA/YUhIvWxcmSdPWTWwbAKVp6rxTtPFUZfKIwpzm4IoMfaYQLWgmlG5FME2gdBgm+J7J+rtS/XBbaVLsR7bpPQnpMFlo2doWaVceHk9+MkyguZNCJ1He+kuHTWyQAzNM5YSUg/GlTk9ZunAsg1qELVOhUSAK0LABIJHLKbqaEbHZLL1VA3VgqoiOKXYiS+HRyaEKgsfIqX64HYWbLRXy/qWoylIV9gudL1OWBNgBgTNmxA6b4txDT4gi3Ri7xFSLxtXpmmYnzAcWDZgY8d503LFogz5sbonDgkKcxGsWsE1OI+rcQtlgBBCSOKD1mtqYpIU8cTvBmAT0yZe+zUzeY92fYjTtGipXLhuR0ePoHk0ofNWBX+lo8Z7pAZDk8mEw5L7dVyZZoE/pTewbI6SNbiAL5xeygW4xPRuLCGbhcO4RIeTMFYHEJkYyEO9HmJfXMDEj/LaH781wHHZEtqSQ/69UnGpzH7LKIAZEDSPJnTesJTUa+rwTepI9dLJEawYV+ZkRn9g+QirD8vF8Mq0jFQ29js6kCS3E1+jZIhgPNanHdHFqFvPJLHqFwQqbIA4jhDxcNsOCCQLDomaL/dr5lyJaJU6FxPFjO3JOh3kVMcROo8u+C+jo05GjMF3P3/FuDLn5x2M04xXULPwaS6hBYki+MrMdZJSgPHlcB7nCR5bJ9Kr5ACUn9jk5kivdd8tk95SOGrtqu9lr2IhK65ZtEl7ZKrp7DrqwZfRUSN1el7+7NJxZbywOC8neNKTch5vsTEMNsoCCqHBCqIPRjIPkm0BjvFODGtto99rCl+d3wmHkW0FPdpZtC7MMcVtGFQjJLX5bdQ2+x9ypdc313uj8xlsrfuLgWXz1cRhZvJYX0iNVBRcVcmCXZs6aEf3RQF2WI/TcCbKmGU3IOoDJGDdDub0+hYckt6PlGu2BcxmhbTdj/klhccLGJMcqRjMJP1jW2ETqLSWJ/29MAoORluJ+6LPffBZbi5gqi5h6catQpmOT7/OFf5UorRpLzCqcMltBLhwd1are3kztrSzXO0LUbXRQcdLh/RdSZ+swRm819REDrtqzC4es6Gw4JCKlSnjYVpo0xeq33PrADbFLL3RuCmObVmPN+24kfa+AojDuM4umKe2QwCf6EN906HwjujaitDs5o0s1y+k3lgbT2W2i7FJdnwbLXhJUBq/9liTctSmFC/0OqUinb0QddTWamtjbHRFuWJJ6NpqZ8vO3fZJ37Db+2GkaPYLGHs7XTTdiFQJ68SkVJFVmY6McR5UycflNCsccHFaV9FNbR4NttLxw4pQ7wJd066Z0ohVbzihaxHVExd/ay04oxUKWt+AsdiQ9OUyZ2krzN19IZIwafSTFgIBnMV73ADj7V/K8u1MaY2sJp2HWm0f41tqwajEvdHWOJs510MaAqN4aoSiPCXtN2KSi46dUxHdaMquar82O1x5jqhDGvqmoE9LfxcY3zqA7/x3HA67r9ZG4O6Cuxu12/+TP+eLP+I+HErqDDCDVmBDO4larujNe7x8om2rMug0MX0rL1+IWwdwfR+p1TNTyNmVJ85ljWzbWuGv8/C7HD/izjkHNZNYlhZcUOKVzKFUxsxxN/kax+8zPWPSFKw80rJr9Tizyj3o1gEsdwgWGoxPezDdZ1TSENE1dLdNvuKL+I84nxKesZgxXVA1VA1OcL49dFlpFV5yJMhzyCmNQ+a4BqusPJ2bB+xo8V9u3x48VVIEPS/mc3DvAbXyoYr6VgDfh5do5hhHOCXMqBZUPhWYbWZECwVJljLgMUWOCB4MUuMaxGNUQDVI50TQ+S3kFgIcu2qKkNSHVoM0SHsgoZxP2d5HH8B9woOk4x5bPkKtAHucZsdykjxuIpbUrSILgrT8G7G5oCW+K0990o7E3T6AdW4TilH5kDjds+H64kS0mz24grtwlzDHBJqI8YJQExotPvoC4JBq0lEjjQkyBZ8oH2LnRsQ4Hu1QsgDTJbO8fQDnllitkxuVskoiKbRF9VwzMDvxHAdwB7mD9yCplhHFEyUWHx3WtwCbSMMTCUCcEmSGlg4gTXkHpZXWQ7kpznK3EmCHiXInqndkQjunG5kxTKEeGye7jWz9cyMR2mGiFQ15ENRBTbCp+Gh86vAyASdgmJq2MC6hoADQ3GosP0QHbnMHjyBQvQqfhy/BUbeHd5WY/G/9LK/8Ka8Jd7UFeNWEZvzPb458Dn8DGLOe3/wGL/4xP+HXlRt+M1PE2iLhR8t+lfgxsuh7AfO2AOf+owWhSZRYQbd622hbpKWKuU+XuvNzP0OseRDa+mObgDHJUSc/pKx31QdKffQ5OIJpt8GWjlgTwMc/w5MPCR/yl1XC2a2Yut54SvOtMev55Of45BOat9aWG27p2ZVORRvnEk1hqWMVUmqa7S2YtvlIpspuF1pt0syuZS2NV14mUidCSfzQzg+KqvIYCMljIx2YK2AO34fX4GWdu5xcIAb8MzTw+j/lyWM+Dw/gjs4GD6ehNgA48kX/AI7XXM/XAN4WHr+9ntywqoCakCqmKP0rmQrJJEErG2Upg1JObr01lKQy4jskWalKYfJ/EDLMpjNSHFEUAde2fltaDgmrNaWQ9+AAb8I5vKjz3L1n1LriB/BXkG/wwR9y/oRX4LlioHA4LzP2inzRx/DWmutRweFjeP3tNeSGlaE1Fde0OS11yOpmbIp2u/jF1n2RRZviJM0yBT3IZl2HWImKjQOxIyeU325b/qWyU9Moj1o07tS0G7qJDoGHg5m8yeCxMoEH8GU45tnrNM84D2l297DQ9t1YP7jki/7RmutRweEA77/HWXOh3HCxkRgldDQkAjNTMl2Iloc1qN5JfJeeTlyTRzxURTdn1Ixv2uKjs12AbdEWlBtmVdk2k7FFwj07PCZ9XAwW3dG+8xKzNFr4EnwBZpy9Qzhh3jDXebBpYcpuo4fQ44u+fD1dweEnHzI7v0xuuOALRUV8rXpFyfSTQYkhd7IHm07jpyhlkCmI0ALYqPTpUxXS+z4jgDj1Pflvmz5ecuItpIBxyTHpSTGWd9g1ApfD/bvwUhL4nT1EzqgX7cxfCcNmb3mPL/qi9SwTHJ49oj5ZLjccbTG3pRmlYi6JCG0mQrAt1+i2UXTZ2dv9IlQpN5naMYtviaXlTrFpoMsl3bOAFEa8sqPj2WCMrx3Yjx99qFwO59Aw/wgx+HlqNz8oZvA3exRDvuhL1jMQHPaOJ0+XyA3fp1OfM3qObEVdhxjvynxNMXQV4+GJyvOEFqeQBaIbbO7i63rpxCltdZShPFxkjM2FPVkn3TG+Rp9pO3l2RzFegGfxGDHIAh8SteR0C4HopXzRF61nheDw6TFN05Ebvq8M3VKKpGjjO6r7nhudTEGMtYM92HTDaR1FDMXJ1eThsbKfywyoWwrzRSXkc51flG3vIid62h29bIcFbTGhfV+faaB+ohj7dPN0C2e2lC96+XouFByen9AsunLDJZ9z7NExiUc0OuoYW6UZkIyx2YUR2z6/TiRjyKMx5GbbjLHvHuf7YmtKghf34LJfx63Yg8vrvN2zC7lY0x0tvKezo4HmGYDU+Gab6dFL+KI761lDcNifcjLrrr9LWZJctG1FfU1uwhoQE22ObjdfkSzY63CbU5hzs21WeTddH2BaL11Gi7lVdlxP1nkxqhnKhVY6knS3EPgVGg1JpN5cP/hivujOelhXcPj8HC/LyI6MkteVjlolBdMmF3a3DbsuAYhL44dxzthWSN065xxUd55Lmf0wRbOYOqH09/o9WbO2VtFdaMb4qBgtFJoT1SqoN8wPXMoXLb3p1PUEhxfnnLzGzBI0Ku7FxrKsNJj/8bn/H8fPIVOd3rfrklUB/DOeO+nkghgSPzrlPxluCMtOnDL4Yml6dK1r3vsgMxgtPOrMFUZbEUbTdIzii5beq72G4PD0DKnwjmBULUVFmy8t+k7fZ3pKc0Q4UC6jpVRqS9Umv8bxw35flZVOU1X7qkjnhZlsMbk24qQ6Hz7QcuL6sDC0iHHki96Uh2UdvmgZnjIvExy2TeJdMDZNSbdZyAHe/Yd1xsQhHiKzjh7GxQ4yqMPaywPkjMamvqrYpmO7Knad+ZQC5msCuAPWUoxrxVhrGv7a+KLXFhyONdTMrZ7ke23qiO40ZJUyzgYyX5XyL0mV7NiUzEs9mjtbMN0dERqwyAJpigad0B3/zRV7s4PIfXSu6YV/MK7+OrYe/JvfGMn/PHJe2fyUdtnFrKRNpXV0Y2559aWPt/G4BlvjTMtXlVIWCnNyA3YQBDmYIodFz41PvXPSa6rq9lWZawZ4dP115HXV/M/tnFkkrBOdzg6aP4pID+MZnTJ1SuuB6iZlyiox4HT2y3YBtkUKWooacBQUDTpjwaDt5poBHl1/HXltwP887lKKXxNUEyPqpGTyA699UqY/lt9yGdlUKra0fFWS+36iylVWrAyd7Uw0CZM0z7xKTOduznLIjG2Hx8cDPLb+OvK6Bv7n1DYci4CxUuRxrjBc0bb4vD3rN5Zz36ntLb83eVJIB8LiIzCmn6SMPjlX+yNlTjvIGjs+QzHPf60Aj62/jrzG8j9vYMFtm1VoRWCJdmw7z9N0t+c8cxZpPeK4aTRicS25QhrVtUp7U578chk4q04Wx4YoQSjFryUlpcQ1AbxZ/XVMknIU//OGl7Q6z9Zpxi0+3yFhSkjUDpnCIUhLWVX23KQ+L9vKvFKI0ZWFQgkDLvBoylrHNVmaw10zwCPrr5tlodfnf94EWnQ0lFRWy8pW9LbkLsyUVDc2NSTHGDtnD1uMtchjbCeb1mpxFP0YbcClhzdLu6lfO8Bj6q+bdT2sz/+8SZCV7VIxtt0DUn9L7r4cLYWDSXnseEpOGFuty0qbOVlS7NNzs5FOGJUqQpl2Q64/yBpZf90sxbE+//PGdZ02HSipCbmD6NItmQ4Lk5XUrGpDMkhbMm2ZVheNYV+VbUWTcv99+2NyX1VoafSuC+AN6q9bFIMv5X/eagNWXZxEa9JjlMwNWb00akGUkSoepp1/yRuuqHGbUn3UdBSTxBU6SEVklzWRUkPndVvw2PrrpjvxOvzPmwHc0hpmq82npi7GRro8dXp0KXnUQmhZbRL7NEVp1uuZmO45vuzKsHrktS3GLWXODVjw+vXXLYx4Hf7njRPd0i3aoAGX6W29GnaV5YdyDj9TFkakje7GHYzDoObfddHtOSpoi2SmzJHrB3hM/XUDDEbxP2/oosszcRlehWXUvzHv4TpBVktHqwenFo8uLVmy4DKLa5d3RtLrmrM3aMFr1183E4sewf+85VWeg1c5ag276NZrM9IJVNcmLEvDNaV62aq+14IAOGFsBt973Ra8Xv11YzXwNfmft7Jg2oS+XOyoC8/cwzi66Dhmgk38kUmP1CUiYWOX1bpD2zWXt2FCp7uq8703APAa9dfNdscR/M/bZLIyouVxqJfeWvG9Je+JVckHQ9+CI9NWxz+blX/KYYvO5n2tAP/vrlZ7+8/h9y+9qeB/Hnt967e5mevX10rALDWK//FaAT5MXdBXdP0C/BAes792c40H+AiAp1e1oH8HgH94g/Lttx1gp63op1eyoM/Bvw5/G/7xFbqJPcCXnmBiwDPb/YKO4FX4OjyCb289db2/Noqicw4i7N6TVtoz8tNwDH+8x/i6Ae7lmaQVENzJFb3Di/BFeAwz+Is9SjeQySpPqbLFlNmyz47z5a/AF+AYFvDmHqibSXTEzoT4Gc3OALaqAP4KPFUJ6n+1x+rGAM6Zd78bgJ0a8QN4GU614vxwD9e1Amy6CcskNrczLx1JIp6HE5UZD/DBHrFr2oNlgG4Odv226BodoryjGJ9q2T/AR3vQrsOCS0ctXZi3ruLlhpFDJYl4HmYtjQCP9rhdn4suySLKDt6wLcC52h8xPlcjju1fn+yhuw4LZsAGUuo2b4Fx2UwQu77uqRHXGtg92aN3tQCbFexc0uk93vhTXbct6y7MulLycoUljx8ngDMBg1tvJjAazpEmOtxlzclvj1vQf1Tx7QlPDpGpqgtdSKz/d9/hdy1vTfFHSmC9dGDZbLiezz7Ac801HirGZsWjydfZyPvHXL/Y8Mjzg8BxTZiuwKz4Eb8sBE9zznszmjvFwHKPIWUnwhqfVRcd4Ck0K6ate48m1oOfrX3/yOtvAsJ8zsPAM89sjnddmuLuDPjX9Bu/L7x7xpMzFk6nWtyQfPg278Gn4Aekz2ZgOmU9eJ37R14vwE/BL8G3aibCiWMWWDQ0ZtkPMnlcGeAu/Ag+8ZyecU5BPuy2ILD+sQqyZhAKmn7XZd+jIMTN9eBL7x95xVLSX4On8EcNlXDqmBlqS13jG4LpmGbkF/0CnOi3H8ETOIXzmnmtb0a16Tzxj1sUvQCBiXZGDtmB3KAefPH94xcUa/6vwRn80GOFyjEXFpba4A1e8KQfFF+259tx5XS4egYn8fQsLGrqGrHbztr+uByTahWuL1NUGbDpsnrwBfePPwHHIf9X4RnM4Z2ABWdxUBlqQ2PwhuDxoS0vvqB1JzS0P4h2nA/QgTrsJFn+Y3AOjs9JFC07CGWX1oNX3T/yHOzgDjwPn1PM3g9Jk9lZrMEpxnlPmBbjyo2+KFXRU52TJM/2ALcY57RUzjObbjqxVw++4P6RAOf58pcVsw9Daje3htriYrpDOonre3CudSe6bfkTEgHBHuDiyu5MCsc7BHhYDx7ePxLjqigXZsw+ijMHFhuwBmtoTPtOxOrTvYJDnC75dnUbhfwu/ZW9AgYd+peL68HD+0emKquiXHhWjJg/UrkJYzuiaL3E9aI/ytrCvAd4GcYZMCkSQxfUg3v3j8c4e90j5ZTPdvmJJGHnOCI2nHS8081X013pHuBlV1gB2MX1YNmWLHqqGN/TWmG0y6clJWthxNUl48q38Bi8vtMKyzzpFdSDhxZ5WBA5ZLt8Jv3895DduBlgbPYAj8C4B8hO68FDkoh5lydC4FiWvBOVqjYdqjiLv92t8yPDjrDaiHdUD15qkSURSGmXJwOMSxWAXYwr3zaAufJ66l+94vv3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/wHuD9tQd4f+0B3l97gPfXHuD9tQd4f+0B3l97gG8LwP8G/AL8O/A5OCq0Ys2KIdv/qOIXG/4mvFAMF16gZD+2Xvu/B8as5+8bfllWyg0zaNO5bfXj6vfhhwD86/Aq3NfRS9t9WPnhfnvCIw/CT8GLcFTMnpntdF/z9V+PWc/vWoIH+FL3Znv57PitcdGP4R/C34avw5fgRVUInCwbsn1yyA8C8zm/BH8NXoXnVE6wVPjdeCI38kX/3+Ct9dbz1pTmHFRu+Hm4O9Ch3clr99negxfwj+ER/DR8EV6B5+DuQOnTgUw5rnkY+FbNU3gNXh0o/JYTuWOvyBf9FvzX663HH/HejO8LwAl8Hl5YLTd8q7sqA3wbjuExfAFegQdwfyDoSkWY8swzEf6o4Qyewefg+cHNbqMQruSL/u/WWc+E5g7vnnEXgDmcDeSGb/F4cBcCgT+GGRzDU3hZYburAt9TEtHgbM6JoxJ+6NMzzTcf6c2bycv2+KK/f+l6LBzw5IwfqZJhA3M472pWT/ajKxnjv4AFnMEpnBTPND6s2J7qHbPAqcMK74T2mZ4VGB9uJA465It+/eL1WKhYOD7xHOkr1ajK7d0C4+ke4Hy9qXZwpgLr+Znm/uNFw8xQOSy8H9IzjUrd9+BIfenYaylf9FsXr8fBAadnPIEDna8IBcwlxnuA0/Wv6GAWPd7dDIKjMdSWueAsBj4M7TOd06qBbwDwKr7oleuxMOEcTuEZTHWvDYUO7aHqAe0Bbq+HEFRzOz7WVoTDQkVds7A4sIIxfCQdCefFRoIOF/NFL1mPab/nvOakSL/Q1aFtNpUb/nFOVX6gzyg/1nISyDfUhsokIzaBR9Kxm80s5mK+6P56il1jXic7nhQxsxSm3OwBHl4fFdLqi64nDQZvqE2at7cWAp/IVvrN6/BFL1mPhYrGMBfOi4PyjuSGf6wBBh7p/FZTghCNWGgMzlBbrNJoPJX2mW5mwZfyRffXo7OFi5pZcS4qZUrlViptrXtw+GQoyhDPS+ANjcGBNRiLCQDPZPMHuiZfdFpPSTcQwwKYdRNqpkjm7AFeeT0pJzALgo7g8YYGrMHS0iocy+YTm2vyRUvvpXCIpQ5pe666TJrcygnScUf/p0NDs/iAI/nqDHC8TmQT8x3NF91l76oDdQGwu61Z6E0ABv7uO1dbf/37Zlv+Zw/Pbh8f1s4Avur6657/+YYBvur6657/+YYBvur6657/+YYBvur6657/+aYBvuL6657/+VMA8FXWX/f8zzcN8BXXX/f8zzcNMFdbf93zP38KLPiK6697/uebtuArrr/u+Z9vGmCusP6653/+1FjwVdZf9/zPN7oHX339dc//fNMu+irrr3v+50+Bi+Zq6697/uebA/jz8Pudf9ht/fWv517J/XUzAP8C/BAeX9WCDrUpZ3/dEMBxgPcfbtTVvsYV5Yn32u03B3Ac4P3b8I+vxNBKeeL9dRMAlwO83959qGO78sT769oB7g3w/vGVYFzKE++v6wV4OMD7F7tckFkmT7y/rhHgpQO8b+4Y46XyxPvrugBeNcB7BRiX8sT767oAvmCA9woAHsoT76+rBJjLBnh3txOvkifeX1dswZcO8G6N7sXyxPvr6i340gHe3TnqVfLE++uKAb50gHcXLnrX8sR7gNdPRqwzwLu7Y/FO5Yn3AK9jXCMGeHdgxDuVJ75VAI8ljP7PAb3/RfjcZfePHBB+79dpfpH1CanN30d+mT1h9GqAxxJGM5LQeeQ1+Tb+EQJrElLb38VHQ94TRq900aMIo8cSOo+8Dp8QfsB8zpqE1NO3OI9Zrj1h9EV78PqE0WMJnUdeU6E+Jjyk/hbrEFIfeWbvId8H9oTRFwdZaxJGvziW0Hn0gqYB/wyZ0PwRlxJST+BOw9m77Amj14ii1yGM/txYQudN0qDzGe4EqfA/5GJCagsHcPaEPWH0esekSwmjRxM6b5JEcZ4ww50ilvAOFxBSx4yLW+A/YU8YvfY5+ALC6NGEzhtmyZoFZoarwBLeZxUhtY4rc3bKnjB6TKJjFUHzJoTOozF2YBpsjcyxDgzhQ1YRUse8+J4wenwmaylB82hC5w0zoRXUNXaRBmSMQUqiWSWkLsaVqc/ZE0aPTFUuJWgeTei8SfLZQeMxNaZSIzbII4aE1Nmr13P2hNHjc9E9guYNCZ032YlNwESMLcZiLQHkE4aE1BFg0yAR4z1h9AiAGRA0jyZ03tyIxWMajMPWBIsxYJCnlITU5ShiHYdZ94TR4wCmSxg9jtB5KyPGYzymAYexWEMwAPIsAdYdV6aObmNPGD0aYLoEzaMJnTc0Ygs+YDw0GAtqxBjkuP38bMRWCHn73xNGjz75P73WenCEJnhwyVe3AEe8TtKdJcYhBl97wuhNAObK66lvD/9J9NS75v17wuitAN5fe4D31x7g/bUHeH/tAd5fe4D3AO+vPcD7aw/w/toDvL/2AO+vPcD7aw/w/toDvAd4f/24ABzZ8o+KLsSLS+Pv/TqTb3P4hKlQrTGh+fbIBT0Axqznnb+L/V2mb3HkN5Mb/nEHeK7d4IcDld6lmDW/iH9E+AH1MdOw/Jlu2T1xNmY98sv4wHnD7D3uNHu54WUuOsBTbQuvBsPT/UfzNxGYzwkP8c+Yz3C+r/i6DcyRL/rZ+utRwWH5PmfvcvYEt9jLDS/bg0/B64DWKrQM8AL8FPwS9beQCe6EMKNZYJol37jBMy35otdaz0Bw2H/C2Smc7+WGB0HWDELBmOByA3r5QONo4V+DpzR/hFS4U8wMW1PXNB4TOqYz9urxRV++ntWCw/U59Ty9ebdWbrgfRS9AYKKN63ZokZVygr8GZ/gfIhZXIXPsAlNjPOLBby5c1eOLvmQ9lwkOy5x6QV1j5TYqpS05JtUgUHUp5toHGsVfn4NX4RnMCe+AxTpwmApTYxqMxwfCeJGjpXzRF61nbcHhUBPqWze9svwcHJ+S6NPscKrEjug78Dx8Lj3T8D4YxGIdxmJcwhi34fzZUr7olevZCw5vkOhoClq5zBPZAnygD/Tl9EzDh6kl3VhsHYcDEb+hCtJSvuiV69kLDm+WycrOTArHmB5/VYyP6jOVjwgGawk2zQOaTcc1L+aLXrKeveDwZqlKrw8U9Y1p66uK8dEzdYwBeUQAY7DbyYNezBfdWQ97weEtAKYQg2xJIkuveAT3dYeLGH+ShrWNwZgN0b2YL7qznr3g8JYAo5bQBziPjx7BPZ0d9RCQp4UZbnFdzBddor4XHN4KYMrB2qHFRIzzcLAHQZ5the5ovui94PCWAPefaYnxIdzRwdHCbuR4B+tbiy96Lzi8E4D7z7S0mEPd+eqO3cT53Z0Y8SV80XvB4Z0ADJi/f7X113f+7p7/+UYBvur6657/+YYBvur6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+aYBvuL6657/+VMA8FXWX/f8z58OgK+y/rrnf75RgLna+uue//lTA/CV1V/3/M837aKvvv6653++UQvmauuve/7nTwfAV1N/3fM/fzr24Cuuv+75nz8FFnxl9dc9//MOr/8/glixwRuUfM4AAAAASUVORK5CYII="}},{key:"getSearchTexEncode",value:function(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}}]),i}(),hJ=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._hTexSampler=0,t._bindingLayout=null,t}return p(i,cJ),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:za.PRIMARY}),this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var t=this._pipeline.globalBindings.get(Tf.BLOCK.name);return this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Tf.BLOCK.binding,t.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pass.update(),this._bindingLayout.update(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=e.camera;this._cmdBuff&&(this._renderArea.width=t.width,this._renderArea.height=t.height,this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(this._framebuffer,this._renderArea,ts.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._bindingLayout),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()),this._device.queue.submit([this._cmdBuff])}}]),i}(),dJ=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return p(t,lJ),l(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._material;return t._uuid="smaa-material",t.initialize({effectName:"pipeline/smaa"}),this.createStage(hJ,{name:"SMAAEdgeStage",priority:0,framebuffer:this._pipeline.smaaEdgeFBO}),this.createStage(uJ,{name:"SMAABlendStage",priority:0,framebuffer:this._pipeline.smaaBlendFBO}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}(),fJ=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._hTexSampler=0,t._hBlendTexSampler=0,t._bindingLayout=null,t}return p(i,cJ),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:za.PRIMARY}),this.rebuild(),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){this._pass=this._flow.material.passes[0],this._hTexSampler=this._pass.getBinding("u_texSampler");var e=this._pipeline.globalBindings.get(Tf.BLOCK.name);this._pso=this._pass.createPipelineState(),this._bindingLayout=this._pso.pipelineLayout.layouts[0],this._pass.bindBuffer(Tf.BLOCK.binding,e.buffer),this._pass.bindTextureView(this._hTexSampler,this._pipeline.curShadingTexView),this._pipeline.useSMAA&&(this._hBlendTexSampler=this._pass.getBinding("u_blendTexSampler"),this._pass.bindTextureView(this._hBlendTexSampler,this._pipeline.smaaBlendTexView)),this._pass.update(),this._bindingLayout.update()}},{key:"render",value:function(e){var t=e.camera;if(this._cmdBuff){this._renderArea.width=t.width,this._renderArea.height=t.height;var i=e.window.framebuffer;this._cmdBuff.begin(),this._cmdBuff.beginRenderPass(i,this._renderArea,ts.ALL,[{r:0,g:0,b:0,a:1}],1,0),this._cmdBuff.bindPipelineState(this._pso),this._cmdBuff.bindBindingLayout(this._pso.pipelineLayout.layouts[0]),this._cmdBuff.bindInputAssembler(this._pipeline.quadIA),this._cmdBuff.draw(this._pipeline.quadIA),this._cmdBuff.endRenderPass(),this._cmdBuff.end()}this._device.queue.submit([this._cmdBuff])}}]),i}(),pJ=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return p(t,lJ),l(t,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}});var t=this._pipeline.root.mainWindow.framebuffer;return this.createStage(fJ,{name:"ToneMapStage",priority:0,framebuffer:t}),!0}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this.destroyStages()}},{key:"rebuild",value:function(){this._material&&(this._material.destroy(),this._material.initialize({effectName:"pipeline/tonemap",defines:{CC_USE_SMAA:this._pipeline.useSMAA}}));var e=this._stages,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}}]),t}(),_J=new Float32Array(4),vJ=new Dr,mJ=new Br,yJ=new Ir(0,0,0,0),gJ=function(){function t(e){y(this,t),this._root=void 0,this._device=void 0,this._name="BasePipeline",this._renderObjects=[],this._renderPasses=new Map,this._flows=[],this._isHDRSupported=!1,this._isHDR=!1,this._lightMeterScale=1e4,this._shadingPass=null,this._fboCount=1,this._msaaShadingTex=null,this._msaaShadingTexView=null,this._msaaDepthStencilTex=null,this._msaaDepthStencilTexView=null,this._msaaShadingFBO=null,this._colorFmt=Kt.GFXFormat.UNKNOWN,this._depthStencilFmt=Kt.GFXFormat.UNKNOWN,this._shadingTextures=[],this._shadingTexViews=[],this._depthStencilTex=null,this._depthStencilTexView=null,this._shadingFBOs=[],this._shadingWidth=0,this._shadingHeight=0,this._shadingScale=1,this._curIdx=0,this._prevIdx=1,this._usePostProcess=!1,this._useMSAA=!1,this._useSMAA=!1,this._smaaPass=null,this._smaaEdgeFBO=null,this._smaaEdgeTex=null,this._smaaEdgeTexView=null,this._smaaBlendFBO=null,this._smaaBlendTex=null,this._smaaBlendTexView=null,this._quadVB=null,this._quadIB=null,this._quadIA=null,this._uboGlobal=new Tf,this._globalBindings=new Map,this._defaultTex=null,this._defaultTexView=null,this._fpScale=1/1024,this._fpScaleInv=1024,this._macros={},this._root=e,this._device=e.device}return l(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"name",get:function(){return this._name}},{key:"renderObjects",get:function(){return this._renderObjects}},{key:"flows",get:function(){return this._flows}},{key:"usePostProcess",get:function(){return this._usePostProcess}},{key:"isHDRSupported",get:function(){return this._isHDRSupported}},{key:"isHDR",get:function(){return this._isHDR}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"lightMeterScale",set:function(e){this._lightMeterScale=e},get:function(){return this._lightMeterScale}},{key:"depthStencilTexView",get:function(){return this._depthStencilTexView}},{key:"curShadingTexView",get:function(){return this._shadingTexViews[this._curIdx]}},{key:"prevShadingTexView",get:function(){return this._shadingTexViews[this._prevIdx]}},{key:"curShadingFBO",get:function(){return this._shadingFBOs[this._curIdx]}},{key:"prevShadingFBO",get:function(){return this._shadingFBOs[this._prevIdx]}},{key:"msaaShadingFBO",get:function(){return this._msaaShadingFBO}},{key:"useMSAA",get:function(){return this._useMSAA}},{key:"useSMAA",get:function(){return this._useSMAA}},{key:"smaaEdgeTexView",get:function(){return this._smaaEdgeTexView}},{key:"smaaEdgeFBO",get:function(){return this._smaaEdgeFBO}},{key:"smaaBlendTexView",get:function(){return this._smaaBlendTexView}},{key:"smaaBlendFBO",get:function(){return this._smaaBlendFBO}},{key:"quadIA",get:function(){return this._quadIA}},{key:"globalBindings",get:function(){return this._globalBindings}},{key:"defaultTexture",get:function(){return this._defaultTex}},{key:"fpScale",get:function(){return this._fpScale}},{key:"fpScaleInv",get:function(){return this._fpScaleInv}},{key:"macros",get:function(){return this._macros}},{key:"defaultGlobalUBOData",get:function(){return this._uboGlobal.view}}]),l(t,[{key:"rebuild",value:function(){this.updateMacros()}},{key:"resize",value:function(e,t){var i=Math.floor(e*this._shadingScale),n=Math.floor(t*this._shadingScale);(i>this._shadingWidth||n>this._shadingHeight)&&this.resizeFBOs(i,n);var r=this._flows,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.resize(e,t)}}},{key:"render",value:function(e){e.camera.update(),this.sceneCulling(e),this.updateUBOs(e);var t=e.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}r.render(e)}}},{key:"swapFBOs",value:function(){var e=this._curIdx;this._curIdx=this._prevIdx,this._prevIdx=e}},{key:"addRenderPass",value:function(e,t){t&&this._renderPasses.set(e,t)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);return t||null}},{key:"removeRenderPass",value:function(e){this._renderPasses.delete(e)}},{key:"clearRenderPasses",value:function(){this._renderPasses.clear()}},{key:"createFlow",value:function(e,t){var i=new e(this);return i.initialize(t)?(this._flows.push(i),this._flows.sort(function(e,t){return e.priority-t.priority}),i):null}},{key:"destroyFlows",value:function(){var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._flows=[]}},{key:"getFlow",value:function(e){var t=this._flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.name===e)return a}return null}},{key:"updateMacros",value:function(){Gf.destroyShaderByDefines(this._macros),this._macros.CC_USE_HDR=this._isHDR;var e=this._root.scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}}},{key:"_initialize",value:function(e){void 0!==e.enablePostProcess?this._usePostProcess=e.enablePostProcess:(cc.sys.platform,cc.sys.WECHAT_GAME,this._usePostProcess=!0),this._usePostProcess&&((this._device.hasFeature(ps.FORMAT_R11G11B10F)||this._device.hasFeature(ps.TEXTURE_HALF_FLOAT)||this._device.hasFeature(ps.TEXTURE_FLOAT))&&(this._isHDRSupported=!0),this._fboCount=1,this._shadingTextures=new Array(this._fboCount),this._shadingTexViews=new Array(this._fboCount),this._shadingFBOs=new Array(this._fboCount),this._isHDR=void 0===e.enableHDR||e.enableHDR,this._useSMAA=void 0!==e.enableSMAA&&e.enableSMAA,this._useMSAA=void 0!==e.enableMSAA&&e.enableMSAA,this._useMSAA&&(this._useMSAA=this.device.hasFeature(ps.MSAA))),this._isHDR&&this._isHDRSupported&&(this._device.hasFeature(ps.COLOR_HALF_FLOAT)&&this._device.hasFeature(ps.TEXTURE_HALF_FLOAT_LINEAR)?this._device.hasFeature(ps.FORMAT_R11G11B10F)?(this._colorFmt=Kt.GFXFormat.R11G11B10F,this._isHDR=!0):this._device.hasFeature(ps.TEXTURE_HALF_FLOAT)&&(this._colorFmt=Kt.GFXFormat.RGBA16F,this._isHDR=!0):this._device.hasFeature(ps.COLOR_FLOAT)&&this._device.hasFeature(ps.TEXTURE_FLOAT_LINEAR)&&this._device.hasFeature(ps.TEXTURE_FLOAT)&&(this._colorFmt=Kt.GFXFormat.RGBA32F,this._isHDR=!0),this._isHDR=!1),this._isHDR||(this._colorFmt=Kt.GFXFormat.RGBA8),24===this._device.depthBits?8===this._device.stencilBits?this._depthStencilFmt=Kt.GFXFormat.D24S8:this._depthStencilFmt=Kt.GFXFormat.D24:this._depthStencilFmt=Kt.GFXFormat.D16,this.updateMacros(),this._shadingScale=1,this._shadingWidth=Math.floor(this._device.nativeWidth),this._shadingHeight=Math.floor(this._device.nativeHeight),console.info("USE_POST_PROCESS: "+this._usePostProcess),this._usePostProcess&&(console.info("USE_MSAA: "+this._useMSAA),console.info("USE_SMAA: "+this._useSMAA),console.info("USE_HDR: "+this._isHDR)),console.info("SHADING_SIZE: "+this._shadingWidth+" x "+this._shadingHeight),console.info("SHADING_SCALE: "+this._shadingScale.toFixed(4)),console.info("SHADING_COLOR_FORMAT: "+ls[this._colorFmt].name),console.info("SHADING_DEPTH_FORMAT: "+ls[this._depthStencilFmt].name),this._shadingPass=this._device.createRenderPass({colorAttachments:[{format:this._colorFmt,loadOp:Ga.CLEAR,storeOp:Ha.STORE,sampleCount:1,beginLayout:Xa.COLOR_ATTACHMENT_OPTIMAL,endLayout:Xa.COLOR_ATTACHMENT_OPTIMAL}],depthStencilAttachment:{format:this._depthStencilFmt,depthLoadOp:Ga.CLEAR,depthStoreOp:Ha.STORE,stencilLoadOp:Ga.CLEAR,stencilStoreOp:Ha.STORE,sampleCount:1,beginLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL,endLayout:Xa.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),this._useMSAA&&(this._msaaShadingTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaShadingTexView=this._device.createTextureView({texture:this._msaaShadingTex,type:Ba.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.DEPTH_STENCIL_ATTACHMENT|wa.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._msaaDepthStencilTexView=this._device.createTextureView({texture:this._msaaDepthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._depthStencilTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.DEPTH_STENCIL_ATTACHMENT|wa.SAMPLED,format:this._depthStencilFmt,width:this._shadingWidth,height:this._shadingHeight}),this._depthStencilTexView=this._device.createTextureView({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt});for(var t=0;t<this._fboCount;++t)this._shadingTextures[t]=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:this._colorFmt,width:this._shadingWidth,height:this._shadingHeight}),this._shadingTexViews[t]=this._device.createTextureView({texture:this._shadingTextures[t],type:Ba.TV2D,format:this._colorFmt}),this._shadingFBOs[t]=this._device.createFramebuffer({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[t]],depthStencilView:this._depthStencilTexView});if(this._useSMAA){var i=Kt.GFXFormat.RGBA8;this._smaaPass=this._device.createRenderPass({colorAttachments:[{format:i,loadOp:Ga.CLEAR,storeOp:Ha.STORE,sampleCount:1,beginLayout:Xa.COLOR_ATTACHMENT_OPTIMAL,endLayout:Xa.COLOR_ATTACHMENT_OPTIMAL}]}),this._smaaEdgeTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaEdgeTexView=this._device.createTextureView({texture:this._smaaEdgeTex,type:Ba.TV2D,format:i}),this._smaaEdgeFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex=this._device.createTexture({type:Aa.TEX2D,usage:wa.COLOR_ATTACHMENT|wa.SAMPLED,format:i,width:this._shadingWidth,height:this._shadingHeight}),this._smaaBlendTexView=this._device.createTextureView({texture:this._smaaBlendTex,type:Ba.TV2D,format:i}),this._smaaBlendFBO=this._device.createFramebuffer({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}return!!this.createQuadInputAssembler()&&!!this.createUBOs()}},{key:"_destroy",value:function(){this.destroyFlows(),this.clearRenderPasses(),this.destroyQuadInputAssembler(),this.destroyUBOs(),this._smaaEdgeTexView&&(this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView=null),this._smaaEdgeTex&&(this._smaaEdgeTex.destroy(),this._smaaEdgeTex=null),this._smaaEdgeFBO&&(this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO=null),this._smaaBlendTexView&&(this._smaaBlendTexView.destroy(),this._smaaBlendTexView=null),this._smaaBlendTex&&(this._smaaBlendTex.destroy(),this._smaaBlendTex=null),this._smaaBlendFBO&&(this._smaaBlendFBO.destroy(),this._smaaBlendFBO=null),this._msaaShadingTexView&&(this._msaaShadingTexView.destroy(),this._msaaShadingTexView=null),this._msaaShadingTex&&(this._msaaShadingTex.destroy(),this._msaaShadingTex=null),this._msaaDepthStencilTexView&&(this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView=null),this._msaaDepthStencilTex&&(this._msaaDepthStencilTex.destroy(),this._msaaDepthStencilTex=null),this._msaaShadingFBO&&(this._msaaShadingFBO.destroy(),this._msaaShadingFBO=null);for(var e=0;e<this._shadingTexViews.length;++e)this._shadingTexViews[e]&&this._shadingTexViews[e].destroy(),this._shadingTextures[e]&&this._shadingTextures[e].destroy(),this._shadingFBOs[e]&&this._shadingFBOs[e].destroy();this._shadingTexViews.splice(0),this._shadingTextures.splice(0),this._shadingFBOs.splice(0),this._depthStencilTexView&&(this._depthStencilTexView.destroy(),this._depthStencilTexView=null),this._depthStencilTex&&(this._depthStencilTex.destroy(),this._depthStencilTex=null),this._shadingPass&&(this._shadingPass.destroy(),this._shadingPass=null)}},{key:"resizeFBOs",value:function(e,t){this._shadingWidth=e,this._shadingHeight=t,this._depthStencilTex&&(this._depthStencilTex.resize(e,t),this._depthStencilTexView.destroy(),this._depthStencilTexView.initialize({texture:this._depthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt}));for(var i=0;i<this._fboCount;++i)this._shadingTextures[i].resize(e,t),this._shadingTexViews[i].destroy(),this._shadingTexViews[i].initialize({texture:this._shadingTextures[i],type:Ba.TV2D,format:this._colorFmt}),this._shadingFBOs[i].destroy(),this._shadingFBOs[i].initialize({renderPass:this._shadingPass,colorViews:[this._shadingTexViews[i]],depthStencilView:this._depthStencilTexView});if(this._useMSAA&&(this._msaaShadingTex.resize(e,t),this._msaaShadingTexView.destroy(),this._msaaShadingTexView.initialize({texture:this._msaaShadingTex,type:Ba.TV2D,format:this._colorFmt}),this._msaaDepthStencilTex.resize(e,t),this._msaaDepthStencilTexView.destroy(),this._msaaDepthStencilTexView.initialize({texture:this._msaaDepthStencilTex,type:Ba.TV2D,format:this._depthStencilFmt}),this._msaaShadingFBO.destroy(),this._msaaShadingFBO.initialize({renderPass:this._shadingPass,colorViews:[this._msaaShadingTexView],depthStencilView:this._msaaDepthStencilTexView})),this._useSMAA){var n=this._smaaEdgeTex.format;this._smaaEdgeTex.resize(e,t),this._smaaEdgeTexView.destroy(),this._smaaEdgeTexView.initialize({texture:this._smaaEdgeTex,type:Ba.TV2D,format:n}),this._smaaEdgeFBO.destroy(),this._smaaEdgeFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaEdgeTexView],depthStencilView:null}),this._smaaBlendTex.resize(e,t),this._smaaBlendTexView.destroy(),this._smaaBlendTexView.initialize({texture:this._smaaBlendTex,type:Ba.TV2D,format:n}),this._smaaBlendFBO.destroy(),this._smaaBlendFBO.initialize({renderPass:this._smaaPass,colorViews:[this._smaaBlendTexView],depthStencilView:null})}console.info("Resizing shading fbos: "+this._shadingWidth+"x"+this._shadingHeight)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer({usage:Jr.VERTEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:t,stride:e}),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer({usage:Jr.INDEX|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:a,stride:r}),!this._quadIB)return!1;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,this._quadIB.update(s);var o=[{name:"a_position",format:Kt.GFXFormat.RG32F},{name:"a_texCoord",format:Kt.GFXFormat.RG32F}];return this._quadIA=this._device.createInputAssembler({attributes:o,vertexBuffers:[this._quadVB],indexBuffer:this._quadIB}),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"createUBOs",value:function(){if(!this._globalBindings.get(Tf.BLOCK.name)){var e=this._root.device.createBuffer({usage:Jr.UNIFORM|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:Tf.SIZE});this._globalBindings.set(Tf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:Tf.BLOCK,buffer:e})}if(!this._globalBindings.get(Ef.BLOCK.name)){var t=this._root.device.createBuffer({usage:Jr.UNIFORM|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:Ef.SIZE});this._globalBindings.set(Ef.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:Ef.BLOCK,buffer:t})}return this._globalBindings.get(xf.name)||this._globalBindings.set(xf.name,{type:Da.SAMPLER,samplerInfo:xf}),!0}},{key:"destroyUBOs",value:function(){var e=this._globalBindings.get(Tf.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(Tf.BLOCK.name));var t=this._globalBindings.get(Ef.BLOCK.name);t&&(t.buffer.destroy(),this._globalBindings.delete(Ef.BLOCK.name))}},{key:"updateUBOs",value:function(e){var t=e.camera,i=t.scene,n=this._root.device,r=i.mainLight,a=i.ambient,s=this._uboGlobal.view;s[Tf.TIME_OFFSET]=this._root.cumulativeTime,s[Tf.SCREEN_SIZE_OFFSET]=n.width,s[Tf.SCREEN_SIZE_OFFSET+1]=n.height,s[Tf.SCREEN_SIZE_OFFSET+2]=1/s[Tf.SCREEN_SIZE_OFFSET],s[Tf.SCREEN_SIZE_OFFSET+3]=1/s[Tf.SCREEN_SIZE_OFFSET+1],s[Tf.SCREEN_SCALE_OFFSET]=t.width/this._shadingWidth*this._shadingScale,s[Tf.SCREEN_SCALE_OFFSET+1]=t.height/this._shadingHeight*this._shadingScale,s[Tf.SCREEN_SCALE_OFFSET+2]=1/s[Tf.SCREEN_SCALE_OFFSET],s[Tf.SCREEN_SCALE_OFFSET+3]=1/s[Tf.SCREEN_SCALE_OFFSET+1],s[Tf.NATIVE_SIZE_OFFSET]=this._shadingWidth,s[Tf.NATIVE_SIZE_OFFSET+1]=this._shadingHeight,s[Tf.NATIVE_SIZE_OFFSET+2]=1/s[Tf.NATIVE_SIZE_OFFSET],s[Tf.NATIVE_SIZE_OFFSET+3]=1/s[Tf.NATIVE_SIZE_OFFSET+1],He.array(s,t.matView,Tf.MAT_VIEW_OFFSET),He.invert(vJ,t.matView),He.array(s,vJ,Tf.MAT_VIEW_INV_OFFSET),He.array(s,t.matProj,Tf.MAT_PROJ_OFFSET),He.invert(vJ,t.matProj),He.array(s,vJ,Tf.MAT_PROJ_INV_OFFSET),He.array(s,t.matViewProj,Tf.MAT_VIEW_PROJ_OFFSET),He.array(s,t.matViewProjInv,Tf.MAT_VIEW_PROJ_INV_OFFSET),Oe.array(s,t.position,Tf.CAMERA_POS_OFFSET);var o=t.exposure;if(s[Tf.EXPOSURE_OFFSET]=o,s[Tf.EXPOSURE_OFFSET+1]=1/o,s[Tf.EXPOSURE_OFFSET+2]=this._isHDR?1:0,s[Tf.EXPOSURE_OFFSET+3]=this._fpScale/o,Oe.array(s,r.direction,Tf.MAIN_LIT_DIR_OFFSET),r.enabled){if(Oe.array(s,r.color,Tf.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var l=r.colorTemperatureRGB;s[Tf.MAIN_LIT_COLOR_OFFSET]*=l.x,s[Tf.MAIN_LIT_COLOR_OFFSET+1]*=l.y,s[Tf.MAIN_LIT_COLOR_OFFSET+2]*=l.z}this._isHDR?s[Tf.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*this._fpScale:s[Tf.MAIN_LIT_COLOR_OFFSET+3]=r.illuminance*o}else Be.array(s,yJ,Tf.MAIN_LIT_COLOR_OFFSET);_J.set(a.skyColor),this._isHDR?_J[3]=a.skyIllum*this._fpScale:_J[3]=a.skyIllum*o,this._uboGlobal.view.set(_J,Tf.AMBIENT_SKY_OFFSET),this._uboGlobal.view.set(a.groundAlbedo,Tf.AMBIENT_GROUND_OFFSET),this._globalBindings.get(Tf.BLOCK.name).buffer.update(this._uboGlobal.view.buffer)}},{key:"sceneCulling",value:function(e){var t=e.camera,i=t.scene;this._renderObjects.splice(0);var n=i.mainLight;n&&n.enabled&&n.update();var r=i.planarShadows;r.enabled&&n.node.hasChanged&&r.updateDirLight(n),i.skybox.enabled&&this.addVisibleModel(i.skybox,t);var a=i.models,s=Array.isArray(a),o=0;for(a=s?a:a[Symbol.iterator]();;){var l;if(s){if(o>=a.length)break;l=a[o++]}else{if((o=a.next()).done)break;l=o.value}var c=l;c._resetUBOUpdateFlag(),0<e.visibility&&c.viewID!==e.visibility||!c.enabled||(c.updateTransform(),c.worldBounds&&!E_.aabb_frustum(c.worldBounds,t.frustum)||(c.updateUBOs(),this.addVisibleModel(c,t)))}r.enabled&&r.updateCommandBuffers()}},{key:"addVisibleModel",value:function(e,t){var i=0;e.node&&(e.node.getWorldPosition(mJ),Oe.subtract(mJ,mJ,t.position),i=Oe.dot(mJ,t.forward)),this._renderObjects.push({model:e,depth:i})}}]),t}();function bJ(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:e.depth-t.depth:e.hash-t.hash}function SJ(e,t){return e.hash===t.hash?e.depth===t.depth?e.shaderId-t.shaderId:t.depth-e.depth:e.hash-t.hash}var TJ=function(){function t(e){y(this,t),this.queue=void 0,this.cmdBuffs=void 0,this.cmdBuffCount=0,this._passDesc=void 0,this._passDesc=e,this.cmdBuffs=new RE(64),this.queue=new RE(64,this._passDesc.sortFunc)}return l(t,[{key:"clear",value:function(){this.queue.clear(),this.cmdBuffCount=0}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.getSubModel(t),r=n.passes[i],a=n.psos[i];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var s=0|r.priority<<16|n.priority<<8|i;return this.queue.push({hash:s,depth:e.depth,shaderId:a.shader.id,subModel:n,cmdBuff:n.commandBuffers[i]}),!0}},{key:"sort",value:function(){this.queue.sort(),this.cmdBuffCount=this.queue.length;for(var e=0;e<this.queue.length;++e)this.cmdBuffs.array[e]=this.queue.array[e].cmdBuff}}]),t}(),EJ=[],xJ=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._uiQueue=void 0,t._uiQueue=new TJ({isTransparent:!0,phases:Kv("default"),sortFunc:SJ}),t}return p(i,cJ),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,void 0!==e.framebuffer&&(this._framebuffer=e.framebuffer),this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:za.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._uiQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._uiQueue.insertRenderPass(a,s,o)}this._uiQueue.sort();var l=e.window.framebuffer,c=this._cmdBuff,u=e.camera;this._renderArea.width=this.flow.pipeline.root.device.width,this._renderArea.height=this.flow.pipeline.root.device.height,c.begin(),c.beginRenderPass(l,this._renderArea,ts.DEPTH_STENCIL,[],u.clearDepth,u.clearStencil),c.execute(this._uiQueue.cmdBuffs.array,this._uiQueue.cmdBuffCount),c.endRenderPass(),c.end(),EJ[0]=c,this._device.queue.submit(EJ)}}]),i}(),AJ=function(e){function i(e){return y(this,i),T(this,S(i).call(this,e))}return p(i,lJ),l(i,[{key:"initialize",value:function(e){void 0!==e.name&&(this._name=e.name),this._priority=e.priority;var t=this._pipeline.root.mainWindow;return!(!t||!t.framebuffer)&&(this.createStage(xJ,{name:"UIStage",priority:0,framebuffer:t.framebuffer}),!0)}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){var t=this.pipeline.defaultGlobalUBOData[Tf.EXPOSURE_OFFSET+2];this.pipeline.defaultGlobalUBOData[Tf.EXPOSURE_OFFSET+2]=0,this.pipeline.globalBindings.get(Tf.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer),_(S(i.prototype),"render",this).call(this,e),this.pipeline.defaultGlobalUBOData[Tf.EXPOSURE_OFFSET+2]=t,this.pipeline.globalBindings.get(Tf.BLOCK.name).buffer.update(this.pipeline.defaultGlobalUBOData.buffer)}}]),i}();var CJ,wJ,RJ=[],kJ=[],OJ=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e)))._opaqueQueue=void 0,t._transparentQueue=void 0,t._opaqueQueue=new TJ({isTransparent:!1,phases:Kv("default"),sortFunc:bJ}),t._transparentQueue=new TJ({isTransparent:!0,phases:Kv("default")|Kv("planarShadow"),sortFunc:SJ}),t}return p(i,cJ),l(i,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this._cmdBuff=this._device.createCommandBuffer({allocator:this._device.commandAllocator,type:za.PRIMARY}),!0}},{key:"destroy",value:function(){this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"resize",value:function(e,t){}},{key:"rebuild",value:function(){}},{key:"render",value:function(e){this._opaqueQueue.clear(),this._transparentQueue.clear();var t=this._pipeline.renderObjects,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}for(var a=r,s=0;s<a.model.subModelNum;s++)for(var o=0;o<a.model.getSubModel(s).passes.length;o++)this._opaqueQueue.insertRenderPass(a,s,o),this._transparentQueue.insertRenderPass(a,s,o)}this._opaqueQueue.sort(),this._transparentQueue.sort();var l,c=e.camera,u=this._cmdBuff,h=c.viewport;if(this._renderArea.x=h.x*c.width,this._renderArea.y=h.y*c.height,this._renderArea.width=h.width*c.width*this.pipeline.shadingScale,this._renderArea.height=h.height*c.height*this.pipeline.shadingScale,c.clearFlag&ts.COLOR){if(RJ[0]=c.clearColor,this._pipeline.isHDR){RJ[0]=(l=RJ[0],{r:Math.pow(l.r,2.2),g:Math.pow(l.g,2.2),b:Math.pow(l.b,2.2),a:1});var d=this._pipeline.fpScale/c.exposure;RJ[0].r*=d,RJ[0].g*=d,RJ[0].b*=d}RJ.length=1}this._pipeline.usePostProcess?this._pipeline.useMSAA?this._framebuffer=this._pipeline.msaaShadingFBO:this._framebuffer=this._pipeline.curShadingFBO:this._framebuffer=e.window.framebuffer;var f=c.scene.planarShadows;u.begin(),u.beginRenderPass(this._framebuffer,this._renderArea,c.clearFlag,RJ,c.clearDepth,c.clearStencil),u.execute(this._opaqueQueue.cmdBuffs.array,this._opaqueQueue.cmdBuffCount),u.execute(f.cmdBuffs.array,f.cmdBuffCount),u.execute(this._transparentQueue.cmdBuffs.array,this._transparentQueue.cmdBuffCount),u.endRenderPass(),u.end(),kJ[0]=u,this._device.queue.submit(kJ),this._pipeline.useMSAA&&this._device.blitFramebuffer(this._framebuffer,this._pipeline.curShadingFBO,this._renderArea,this._renderArea,Sa.POINT)}}]),i}();(wJ=CJ||(CJ={}))[wJ.FORWARD=0]="FORWARD";var FJ,LJ,BJ=function(e){function t(e){return y(this,t),T(this,S(t).call(this,e))}return p(t,lJ),l(t,[{key:"initialize",value:function(e){return void 0!==e.name&&(this._name=e.name),this._priority=e.priority,this.createStage(OJ,{name:"ForwardStage",priority:CJ.FORWARD}),!0}},{key:"destroy",value:function(){this.destroyStages()}},{key:"rebuild",value:function(){}}]),t}();(LJ=FJ||(FJ={}))[LJ.FORWARD=0]="FORWARD",LJ[LJ.UI=10]="UI";var MJ,IJ,PJ=new Float32Array(4),DJ=M_.create(0,0,0,1),NJ=[],zJ=[],UJ=Mr(),GJ=function(e){function d(e){var t;return y(this,d),(t=T(this,S(d).call(this,e)))._uboLights=new wf,t._lightsUBO=null,t._validLights=void 0,t._lightIndexOffset=void 0,t._lightIndices=void 0,t._validLights=[],t._lightIndexOffset=[],t._lightIndices=[],t}return p(d,gJ),l(d,[{key:"lightsUBO",get:function(){return this._lightsUBO}}]),l(d,[{key:"initialize",value:function(e){if(!this._initialize(e))return!1;if(this._name="ForwardPipeline",!this._globalBindings.get(wf.BLOCK.name)){var t=this._root.device.createBuffer({usage:Jr.UNIFORM|Jr.TRANSFER_DST,memUsage:ea.HOST|ea.DEVICE,size:wf.SIZE});if(!t)return!1;this._globalBindings.set(wf.BLOCK.name,{type:Da.UNIFORM_BUFFER,blockInfo:wf.BLOCK,buffer:t})}var i=this._root.mainWindow,n=null;return i&&(n=i.renderPass),n?(this.addRenderPass(vf.DEFAULT,n),this.createFlow(BJ,{name:"ForwardFlow",priority:FJ.FORWARD}),this._usePostProcess&&(this._useSMAA&&this.createFlow(dJ,{name:"SMAAFlow",priority:0}),this.createFlow(pJ,{name:"ToneMapFlow",priority:0})),this.createFlow(AJ,{name:"UIFlow",priority:FJ.UI}),!0):(console.error("RenderPass of main window is null."),!1)}},{key:"destroy",value:function(){var e=this._globalBindings.get(wf.BLOCK.name);e&&(e.buffer.destroy(),this._globalBindings.delete(wf.BLOCK.name)),this._destroy()}},{key:"rebuild",value:function(){_(S(d.prototype),"rebuild",this).call(this);var e=this._flows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.rebuild()}}},{key:"updateUBOs",value:function(e){_(S(d.prototype),"updateUBOs",this).call(this,e);for(var t=e.camera.exposure,i=0;i<this._renderObjects.length;i++){this._uboLights.view.fill(0);var n=i+1<this._renderObjects.length?this._lightIndexOffset[i+1]:this._lightIndices.length;if(this._renderObjects[i].model.localBindings.get(wf.BLOCK.name)){for(var r=0,a=0,s=this._lightIndexOffset[i];s<n;s++){var o=this._validLights[this._lightIndices[s]];if(o&&o.enabled)switch(o.type){case ST.SPHERE:if(wf.MAX_SPHERE_LIGHTS<=r)continue;var l=o;if(Oe.array(PJ,l.position),this._uboLights.view.set(PJ,wf.SPHERE_LIGHT_POS_OFFSET+4*r),PJ[0]=l.size,PJ[1]=l.range,PJ[2]=0,this._uboLights.view.set(PJ,wf.SPHERE_LIGHT_SIZE_RANGE_OFFSET+4*r),Oe.array(PJ,o.color),o.useColorTemperature){var c=o.colorTemperatureRGB;PJ[0]*=c.x,PJ[1]*=c.y,PJ[2]*=c.z}PJ[3]=l.luminance*this._lightMeterScale,this._isHDR?PJ[3]=l.luminance*this._fpScale*this._lightMeterScale:PJ[3]=l.luminance*t*this._lightMeterScale,this._uboLights.view.set(PJ,wf.SPHERE_LIGHT_COLOR_OFFSET+4*r),r++;break;case ST.SPOT:if(wf.MAX_SPOT_LIGHTS<=a)continue;var u=o;if(Oe.array(PJ,u.position),PJ[3]=u.size,this._uboLights.view.set(PJ,wf.SPOT_LIGHT_POS_OFFSET+4*a),PJ[0]=u.size,PJ[1]=u.range,PJ[2]=u.spotAngle,this._uboLights.view.set(PJ,wf.SPOT_LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*a),Oe.array(PJ,u.direction),this._uboLights.view.set(PJ,wf.SPOT_LIGHT_DIR_OFFSET+4*a),Oe.array(PJ,o.color),o.useColorTemperature){var h=o.colorTemperatureRGB;PJ[0]*=h.x,PJ[1]*=h.y,PJ[2]*=h.z}this._isHDR?PJ[3]=u.luminance*this._fpScale*this._lightMeterScale:PJ[3]=u.luminance*t*this._lightMeterScale,this._uboLights.view.set(PJ,wf.SPOT_LIGHT_COLOR_OFFSET+4*a),a++}}this._renderObjects[i].model.localBindings.get(wf.BLOCK.name).buffer.update(this._uboLights.view)}}}},{key:"sceneCulling",value:function(e){_(S(d.prototype),"sceneCulling",this).call(this,e),this._validLights.splice(0);var t=e.camera.scene.sphereLights,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.enabled&&(a.update(),M_.set(DJ,a.position.x,a.position.y,a.position.z,a.range),E_.sphere_frustum(DJ,e.camera.frustum)&&this._validLights.push(a))}var s=e.camera.scene.spotLights,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;u.enabled&&(u.update(),M_.set(DJ,u.position.x,u.position.y,u.position.z,u.range),E_.sphere_frustum(DJ,e.camera.frustum)&&this._validLights.push(u))}this._lightIndexOffset.splice(0),this._lightIndices.splice(0);for(var h=0;h<this._renderObjects.length;h++)this._lightIndexOffset[h]=this._lightIndices.length,this._renderObjects[h].model.localBindings.get(wf.BLOCK.name)&&this.cullLightPerModel(this._renderObjects[h].model)}},{key:"cullLightPerModel",value:function(e){var t,i,n,r,a;NJ.splice(0);for(var s=0;s<this._validLights.length;s++){var o=!1;switch(this._validLights[s].type){case ST.DIRECTIONAL:this._validLights[s],o=!1;break;case ST.SPHERE:r=this._validLights[s],a=e,o=!E_.aabb_aabb(a.worldBounds,r.aabb);break;case ST.SPOT:i=this._validLights[s],n=e,o=!E_.aabb_aabb(n.worldBounds,i.aabb)||!E_.aabb_frustum(n.worldBounds,i.frustum)}o||(NJ.push(s),this._validLights[s].type===ST.DIRECTIONAL?zJ[s]=0:zJ[s]=Oe.distance(this._validLights[s].position,e.node.getWorldPosition(UJ)))}NJ.sort(this.sortLight),(t=this._lightIndices).push.apply(t,NJ)}},{key:"sortLight",value:function(e,t){return zJ[e]-zJ[t]}}]),d}();(IJ=MJ||(MJ={}))[IJ.GENERAL=100]="GENERAL";var VJ=function(){function i(e,t){y(this,i),this._root=void 0,this._name="",this._window=null,this._priority=0,this._visibility=0,this._camera=void 0,this._isEnable=!0,this._isUI=!1,this._flows=[],this._root=e,this._camera=t}return l(i,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this.isUI&&(this._priority|=1<<30)}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"isUI",get:function(){return this._isUI}},{key:"flows",get:function(){return this._flows}}],[{key:"registerCreateFunc",value:function(e){e._createViewFun=function(e,t){return new i(e,t)}}}]),l(i,[{key:"initialize",value:function(e){this._name=e.name,this._isUI=e.isUI,this.priority=e.priority,e.flows||(e.flows=["ForwardFlow","ToneMapFlow","SMAAFlow"]);var t=cc.director.root.pipeline.flows,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;-1!==e.flows.indexOf(a.name)&&this.flows.push(a)}return!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}}]),i}(),HJ=new Br(0,0,-1),WJ=new Br,XJ=new Pr,jJ=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._dir=new Br(1,-1,-1),n._illum=65e3,n._type=ST.DIRECTIONAL,n}return p(r,uE),l(r,[{key:"direction",set:function(e){this._dir=e,Oe.normalize(this._dir,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){this._illum=e},get:function(){return this._illum}}]),l(r,[{key:"update",value:function(){this._node&&(this._dir=Oe.transformQuat(WJ,HJ,this._node.getWorldRotation(XJ)),Oe.normalize(this._dir,this._dir))}}]),r}(),qJ=new Br(0,0,-1),YJ=new Br,KJ=new Pr,QJ=function(){function t(e){y(this,t),this._scene=void 0,this._enabled=!1,this._normal=new Br(0,1,0),this._distance=0,this._matLight=new Dr,this._data=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),this._globalBindings=void 0,this._cmdBuffs=void 0,this._cmdBuffCount=0,this._material=new _m,this._psoRecord=new Map,this._cbRecord=new Map,this._scene=e,this._globalBindings=e.root.pipeline.globalBindings.get(Ef.BLOCK.name),this._cmdBuffs=new RE(64),this._material.initialize({effectName:"pipeline/planar-shadow"})}return l(t,[{key:"enabled",set:function(e){this._enabled=e,this.updateDirLight(),this._cmdBuffs.clear()},get:function(){return this._enabled}},{key:"normal",set:function(e){Oe.copy(this._normal,e),this.updateDirLight()},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this.updateDirLight()},get:function(){return this._distance}},{key:"shadowColor",set:function(e){je.array(this._data,e,Ef.SHADOW_COLOR_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"matLight",get:function(){return this._matLight}},{key:"data",get:function(){return this._data}},{key:"cmdBuffs",get:function(){return this._cmdBuffs}},{key:"cmdBuffCount",get:function(){return this._cmdBuffs.length}}]),l(t,[{key:"updateSphereLight",value:function(e){e.node.getWorldPosition(YJ);var t=this._normal,i=this._distance,n=Oe.dot(t,YJ),r=YJ.x,a=YJ.y,s=YJ.z,o=t.x,l=t.y,c=t.z,u=this._matLight;u.m00=n-i-r*o,u.m01=-a*o,u.m02=-s*o,u.m03=-o,u.m04=-r*l,u.m05=n-i-a*l,u.m06=-s*l,u.m07=-l,u.m08=-r*c,u.m09=-a*c,u.m10=n-i-s*c,u.m11=-c,u.m12=r*i,u.m13=a*i,u.m14=s*i,u.m15=n,He.array(this.data,this._matLight),this._globalBindings.buffer.update(this.data)}},{key:"updateDirLight",value:function(){(0<arguments.length&&void 0!==arguments[0]?arguments[0]:this._scene.mainLight).node.getWorldRotation(KJ),Oe.transformQuat(YJ,qJ,KJ);var e=this._normal,t=this._distance,i=1/Oe.dot(e,YJ),n=YJ.x*i,r=YJ.y*i,a=YJ.z*i,s=e.x,o=e.y,l=e.z,c=this._matLight;c.m00=1-s*n,c.m01=-s*r,c.m02=-s*a,c.m03=0,c.m04=-o*n,c.m05=1-o*r,c.m06=-o*a,c.m07=0,c.m08=-l*n,c.m09=-l*r,c.m10=1-l*a,c.m11=0,c.m12=n*t,c.m13=r*t,c.m14=a*t,c.m15=1,He.array(this.data,this._matLight,Ef.MAT_LIGHT_PLANE_PROJ_OFFSET),this._globalBindings.buffer.update(this.data)}},{key:"updateCommandBuffers",value:function(){this._cmdBuffs.clear();var e=this._scene.models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;if(r.node&&r.castShadow){var a=this._psoRecord.get(r);a||(a=this._createPSO(r),this._psoRecord.set(r,a)),r.UBOUpdated||r.updateUBOs();for(var s=0;s<r.subModelNum;s++){var o=r.getSubModel(s).inputAssembler;if(o){var l=this._cbRecord.get(o);l||((l=this._createCommandBuffer()).begin(),l.bindPipelineState(a),l.bindBindingLayout(a.pipelineLayout.layouts[0]),l.bindInputAssembler(o),l.draw(o),l.end(),this._cbRecord.set(o,l)),this.cmdBuffs.push(l)}}}}}},{key:"onPipelineChange",value:function(){for(var e=this._cbRecord.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._cbRecord.clear();for(var i=this._material.passes[0],n=this._psoRecord.values(),r=n.next();!r.done;)i.destroyPipelineState(r.value),r=n.next();this._psoRecord.clear()}},{key:"destroy",value:function(){this.onPipelineChange(),this._material.destroy()}},{key:"_createPSO",value:function(e){var t=e._doCreatePSO(this._material.passes[0]);return t.pipelineLayout.layouts[0].update(),t}},{key:"_createCommandBuffer",value:function(){var e=this._scene.root.device;return e.createCommandBuffer({allocator:e.commandAllocator,type:za.SECONDARY})}}]),t}(),ZJ=function(e){function n(e){var t;y(this,n),(t=T(this,S(n).call(this,e,null)))._default=Vv.get("default-cube-texture"),t._envmap=t._default,t._isRGBE=!1,t._useIBL=!1,t._material=new _m,t._globalBinding=void 0,t._scene=e,t._material.initialize({effectName:"builtin-skybox",defines:{USE_RGBE_CUBEMAP:t._isRGBE}}),t._globalBinding=t._scene.root.pipeline.globalBindings.get(xf.name);var i=Xg(yN({width:2,height:2,length:2})).renderingMesh.getSubmesh(0);return t.initSubModel(0,i,t._material),t._updateGlobalBinding(),t}return p(n,Bv),l(n,[{key:"useIBL",set:function(e){this._useIBL=e,this._scene.root.pipeline.macros.CC_USE_IBL=e,this._scene.onPipelineChange(),this._updateGlobalBinding()},get:function(){return this._useIBL}},{key:"envmap",set:function(e){var t=e||this._default;this._envmap=t,this._updateGlobalBinding()},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){e!==this._isRGBE&&(this._isRGBE=e,this._material.recompileShaders({USE_RGBE_CUBEMAP:this._isRGBE}),this.setSubModelMaterial(0,this._material),this._updateGlobalBinding())},get:function(){return this._isRGBE}}]),l(n,[{key:"_updateGlobalBinding",value:function(){var e=this._envmap.getGFXTextureView(),t=Is.getSampler(this._device,this._envmap.getGFXSamplerInfo());this._globalBinding.sampler=t,this._globalBinding.textureView=e;var i=this._material;i.passes[0].bindSampler(xf.binding,t),i.passes[0].bindTextureView(xf.binding,e);var n=this._matPSORecord.get(i),r=Array.isArray(n),a=0;for(n=r?n:n[Symbol.iterator]();;){var s;if(r){if(a>=n.length)break;s=n[a++]}else{if((a=n.next()).done)break;s=a.value}s.pipelineLayout.layouts[0].update()}}}]),n}(),JJ=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._size=.15,n._range=1,n._luminance=1700/cE(n._size),n._pos=void 0,n._aabb=void 0,n._type=ST.SPHERE,n._aabb=G_.create(),n._pos=new Br,n}return p(r,uE),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"aabb",get:function(){return this._aabb}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),G_.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range))}}]),r}(),$J=new Br(0,0,-1),e$=new Br,t$=new Pr,i$=new Dr,n$=new Dr,r$=new Dr,a$=new Dr,s$=function(e){function r(e,t,i){var n;return y(this,r),(n=T(this,S(r).call(this,e,t,i)))._dir=new Br(1,-1,-1),n._size=.15,n._range=5,n._luminance=1700/cE(n._size),n._spotAngle=Math.cos(Math.PI/6),n._pos=void 0,n._aabb=void 0,n._frustum=void 0,n._angle=0,n._type=ST.SPOT,n._aabb=G_.create(),n._frustum=Y_.create(),n._pos=Mr(),n}return p(r,uE),l(r,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e},get:function(){return this._range}},{key:"luminance",set:function(e){this._luminance=e},get:function(){return this._luminance}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=.5*e,this._spotAngle=Math.cos(.5*e)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),l(r,[{key:"update",value:function(){this._node&&(this._node.getWorldPosition(this._pos),this._dir=Oe.transformQuat(e$,$J,this._node.getWorldRotation(t$)),Oe.normalize(this._dir,this._dir),G_.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(i$),He.invert(i$,i$),He.perspective(n$,this._angle,1,.001,this._range),He.multiply(r$,n$,i$),He.invert(a$,r$),this._frustum.update(r$,a$))}}]),r}(),o$=function(){function t(e){y(this,t),this._root=void 0,this._name="",this._cameras=[],this._ambient=void 0,this._skybox=void 0,this._planarShadows=void 0,this._mainLight=void 0,this._defaultMainLightNode=void 0,this._sphereLights=[],this._spotLights=[],this._models=[],this._modelId=0,this._root=e,this._ambient=new ig(this),this._defaultMainLightNode=new bd("Main Light"),this._mainLight=new jJ(this,"Main Light",this._defaultMainLightNode),this._mainLight.illuminance=ig.SUN_ILLUM,this._mainLight.enabled=!1,this._ambient=new ig(this),this._skybox=new ZJ(this),this._planarShadows=new QJ(this)}return l(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"ambient",get:function(){return this._ambient}},{key:"skybox",get:function(){return this._skybox}},{key:"planarShadows",get:function(){return this._planarShadows}},{key:"defaultMainLightNode",get:function(){return this._defaultMainLightNode}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}}],[{key:"registerCreateFunc",value:function(e){e._createSceneFun=function(e){return new t(e)}}}]),l(t,[{key:"initialize",value:function(e){return this._name=e.name,!0}},{key:"destroy",value:function(){this.destroyCameras(),this.destroyPointLights(),this.destroySpotLights(),this.destroyModels(),this.planarShadows.destroy()}},{key:"createCamera",value:function(e){var t=new NA(this,e);return this._cameras.push(t),t}},{key:"destroyCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return e.destroy(),void this._cameras.splice(t,1)}},{key:"destroyCameras",value:function(){var e=this._cameras,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._cameras.splice(0)}},{key:"createSphereLight",value:function(e,t){var i=new JJ(this,e,t);return this._sphereLights.push(i),i}},{key:"destroySphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return void this._sphereLights.splice(t,1)}},{key:"createSpotLight",value:function(e,t){var i=new s$(this,e,t);return this._spotLights.push(i),i}},{key:"destroySpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return void this._spotLights.splice(t,1)}},{key:"destroyPointLights",value:function(){this._sphereLights=[]}},{key:"destroySpotLights",value:function(){this._spotLights=[]}},{key:"createModel",value:function(e,t){var i=new e(this,t);return this._models.push(i),i}},{key:"destroyModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return void this._models.splice(t,1)[0].destroy()}},{key:"destroyModels",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._models=[]}},{key:"onPipelineChange",value:function(){var e=this._models,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.onPipelineChange()}this._skybox.onPipelineChange(),this._planarShadows.onPipelineChange()}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycast",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:fd.RaycastMask;f$.reset();var i=this._models,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}var s=a,o=s.transform;if(o&&s.enabled&&cc.Layers.check(s.node.layer,t)&&s.modelBounds&&(He.invert(u$,o.getWorldMatrix(u$)),Oe.transformMat4(l$.o,e.o,u$),Oe.normalize(l$.d,Oe.transformMat4Normal(l$.d,e.d,u$)),!((h$=E_.ray_aabb(l$,s.modelBounds))<=0)))for(var l=0;l<s.subModelNum;++l){var c=s.getSubModel(l).subMeshData;if(c&&c.geometricInfo){var u=c.geometricInfo,h=u.positions,d=u.indices,f=u.doubleSided;y$(h,d,c.primitiveMode,f)}if(h$<1/0){var p=f$.add();p.node=s.node,p.distance=h$*Oe.magnitude(Oe.multiply(c$,l$.d,o.worldScale)),p$[f$.length-1]=p}}}return p$.length=f$.length,p$}},{key:"raycastUI",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:fd.UI;v$.reset();var i=cc.director.getScene().getComponentsInChildren(cc.CanvasComponent);if(null!=i&&0<i.length){var n=i[0].node;null!=n&&n.active&&this._raycastUINodeRecursiveChildren(e,t,n)}return m$.length=v$.length,m$}},{key:"raycastUINode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:fd.UI,i=2<arguments.length?arguments[2]:void 0,n=i.uiTransfromComp;if(null!=n&&cc.Layers.check(i.layer,t)&&(n.getComputeAABB(_$),!((h$=E_.ray_aabb(e,_$))<=0))){var r=v$.add();return r.node=i,r.distance=h$,r}}},{key:"_raycastUINodeRecursiveChildren",value:function(e,t,i){var n=this.raycastUINode(e,t,i);null!=n&&(m$[v$.length-1]=n);var r=i.children,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}var l=o;null!=l&&l.active&&this._raycastUINodeRecursiveChildren(e,t,l)}}}]),t}(),l$=O_.create(),c$=new Br,u$=new Dr,h$=1/0,d$=F_.create(),f$=new lv(function(){return{node:null,distance:1/0}},8),p$=[],_$=new G_,v$=new lv(function(){return{node:null,distance:1/0}},8),m$=[],y$=function(e,t,i,n){if(h$=1/0,i===Kt.GFXPrimitiveMode.TRIANGLE_LIST)for(var r=t.length,a=0;a<r;a+=3){var s=3*t[a],o=3*t[a+1],l=3*t[a+2];Oe.set(d$.a,e[s],e[s+1],e[s+2]),Oe.set(d$.b,e[o],e[o+1],e[o+2]),Oe.set(d$.c,e[l],e[l+1],e[l+2]);var c=E_.ray_triangle(l$,d$,n);c<=0||h$<c||(h$=c)}else if(i===Kt.GFXPrimitiveMode.TRIANGLE_STRIP)for(var u=t.length-2,h=0,d=0;d<u;d+=1){var f=3*t[d-h],p=3*t[d+h+1],_=3*t[d+2];Oe.set(d$.a,e[f],e[f+1],e[f+2]),Oe.set(d$.b,e[p],e[p+1],e[p+2]),Oe.set(d$.c,e[_],e[_+1],e[_+2]),h=~h;var v=E_.ray_triangle(l$,d$,n);v<=0||h$<v||(h$=v)}else if(i===Kt.GFXPrimitiveMode.TRIANGLE_FAN){var m=t.length-1,y=3*t[0];Oe.set(d$.a,e[y],e[y+1],e[y+2]);for(var g=1;g<m;g+=1){var b=3*t[g],S=3*t[g+1];Oe.set(d$.b,e[b],e[b+1],e[b+2]),Oe.set(d$.c,e[S],e[S+1],e[S+2]);var T=E_.ray_triangle(l$,d$,n);T<=0||h$<T||(h$=T)}}},g$=function(e){function i(e){var t;return y(this,i),(t=T(this,S(i).call(this,e,null)))._subModel=void 0,t._subModel=new b$,t}return p(i,Bv),l(i,[{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(){return!1}},{key:"initialize",value:function(e,t){this._subModel.directInitialize(e,t.material,t.pipelineState),this._subModels[0]=this._subModel}},{key:"destroy",value:function(){this._subModel.destroy()}}]),i}(),b$=function(e){function t(){var e;return y(this,t),(e=T(this,S(t).call(this))).psos=[],e}return p(t,Tv),l(t,[{key:"directInitialize",value:function(e,t,i){this._inputAssembler=e,this.psos[0]=i,this.material=t}},{key:"destroy",value:function(){0<this.commandBuffers.length&&this.commandBuffers[0].destroy()}}]),t}(),S$=function(){function e(){y(this,e),this._material=null,this._pass=null,this._psos=void 0,this._psos=null}return l(e,[{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}}]),l(e,[{key:"initialize",value:function(e){var t=this;return!!e.material&&(this._material=e.material,this._pass=this._material.passes[0],this._psos=new kn(function(){return t._pass.createPipelineState()},1),!0)}},{key:"getPipelineState",value:function(){return this._psos.alloc()}},{key:"revertPipelineState",value:function(e){this._psos.free(e)}},{key:"destroy",value:function(){var t=this;this._material=null,this._psos&&this._psos.clear(function(e){t._pass.destroyPipelineState(e)})}}]),e}(),T$=function(){function e(){y(this,e),this.camera=null,this.bufferBatch=null,this.model=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.pipelineState=null,this.bindingLayout=null,this.useLocalData=null}return l(e,[{key:"destroy",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.bindingLayout&&(this.bindingLayout=null)}},{key:"clear",value:function(e){this.pipelineState&&(e._getUIMaterial(this.material).revertPipelineState(this.pipelineState),this.pipelineState=null),this.camera=null,this.bufferBatch=null,this.material=null,this.texView=null,this.firstIdx=0,this.idxCount=0,this.model=null}}]),e}(),E$=function(){function i(e){var t=this;y(this,i),this._root=e,this.device=void 0,this._screens=[],this._debugScreen=null,this._bufferBatchPool=new lv(function(){return new aJ(t)},128),this._drawBatchPool=new kn(function(){return new T$},128),this._cmdBuff=null,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._batches=void 0,this._sortChildList=new kn(function(){return[]},128),this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=_m.getInstantiatedMaterial(new _m,new cc.RenderableComponent,!1),this._currMeshBuffer=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=-1,this.device=e.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new kn(function(){return t._scene.createModel(g$,null)},2),this._modelInUse=new RE(10),this._batches=new RE(64),cc.director.on(cc.Director.EVENT_BEFORE_DRAW,this.update,this)}return l(i,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer}},{key:"debugScreen",get:function(){return this._debugScreen},set:function(e){this._debugScreen=e,this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1)}}]),l(i,[{key:"initialize",value:function(){return this._attributes=AY,this._requireBufferBatch(),this._cmdBuff=this.device.createCommandBuffer({allocator:this.device.commandAllocator,type:za.PRIMARY}),!0}},{key:"destroy",value:function(){this._destroyUIMaterials();var e=this._batches.array,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy(this)}var r=this._meshBuffers,a=Array.isArray(r),s=0;for(r=a?r:r[Symbol.iterator]();;){var o;if(a){if(s>=r.length)break;o=r[s++]}else{if((s=r.next()).done)break;o=s.value}o.destroy()}this._meshBuffers.splice(0);for(var l=this._uiMaterials.values(),c=l.next();!c.done;){c.value.destroy(),c=l.next()}this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new S$;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){this._screens.push(e),e.camera&&(e.camera.view.visibility=this._screens.length),this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1)}},{key:"getScreen",value:function(e){var t=this._screens,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;if(a.camera&&a.camera.view.visibility===e)return a}return this._debugScreen&&this._debugScreen.camera&&this._debugScreen.camera.view.visibility===e?this._debugScreen:null}},{key:"removeScreen",value:function(e){var t=this._screens.indexOf(e);if(-1!==t){var i;this._screens.splice(t,1),this._debugScreen&&this._debugScreen.camera&&(this._debugScreen.camera.view.visibility=this._screens.length+1);for(var n=t;n<this._screens.length;n++)(i=this._screens[n].camera)&&(i.view.visibility=n)}}},{key:"update",value:function(e){if(this._renderScreens(),0<this._batches.length){var t=this._meshBuffers,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.uploadData(),a.reset()}}this.render(),this._reset()}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._modelInUse.get(t).enabled=!1,this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){n.camera&&(n.model.viewID=n.camera.view.visibility);for(var r=0;r<n.model.subModelNum;r++)n.model.getSubModel(r).priority=e++}else{var a=n.bindingLayout;a.bindTextureView(bf.CUSTOM_SAMPLER_BINDING_START_POINT,n.texView),a.update();var s=n.bufferBatch.ia;s.firstIndex=n.firstIdx,s.indexCount=n.idxCount;var o=this._uiModelPool.alloc();o.initialize(s,n),o.enabled=!0,o.getSubModel(0).priority=e++,n.camera&&(o.viewID=n.camera.view.visibility),this._modelInUse.push(o)}}}},{key:"commitComp",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,i=2<arguments.length?arguments[2]:void 0,n=e,r=t;this._currMaterial.hash===n.material.hash&&this._currTexView===r&&this._currCanvas===n.visibility||(this.autoMergeBatches(),this._currMaterial=n.material,this._currTexView=r,this._currCanvas=n.visibility),i&&i.fillBuffers(n,this)}},{key:"commitModel",value:function(e,t,i){if((this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i)&&(wZ.sharedManager.handleMaterial(i)&&t))for(var n=0;n<t.subModelNum;n++)t.setSubModelMaterial(n,i);var r=this.getScreen(e.visibility),a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.model=t,a.bufferBatch=null,a.material=i,a.texView=null,a.firstIdx=0,a.idxCount=0,a.pipelineState=null,a.bindingLayout=null,this._currMaterial=this._emptyMaterial,this._currTexView=null,this._currCanvas=e.visibility,this._batches.push(a)}},{key:"autoMergeBatches",value:function(){var e=this._currMaterial,t=this._currMeshBuffer,i=t.indiceStart,n=t.indiceOffset-i;if(n&&e){var r=this.getScreen(this._currCanvas);wZ.sharedManager.handleMaterial(e);var a=this._drawBatchPool.alloc();a.camera=r&&r.camera,a.bufferBatch=this._currMeshBuffer,a.material=e,a.texView=this._currTexView,a.firstIdx=i,a.idxCount=n,a.pipelineState=this._getUIMaterial(e).getPipelineState(),a.bindingLayout=a.pipelineState.pipelineLayout.layouts[0],this._batches.push(a),t.vertexStart=t.vertexOffset,t.indiceStart=t.indiceOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexView=t,this.autoMergeBatches()}},{key:"_deleteUIMaterial",value:function(e){this._uiMaterials.has(e.hash)&&(this._uiMaterials.get(e.hash).destroy(),this._uiMaterials.delete(e.hash))}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){console.log("111111111"),t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e,t,i){var n,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,a=e.childrenCount;if(t(e),0<a){var s=n=this._defineNodeOrder(e),o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;this._walk(u,t,i,r)}this._sortChildList.free(n)}i(e),r+=1}},{key:"_defineNodeOrder",value:function(e){var t=this._sortChildList.alloc();return(t=e.children.slice()).sort(function(e,t){var i=e.getComponent(Hz),n=t.getComponent(Hz);return(i?i.priority:0)-(n?n.priority:0)}),t}},{key:"_renderScreens",value:function(){var e=this._screens,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}var r=n;r.enabledInHierarchy&&this._recursiveScreenNode(r.node)}this._debugScreen&&this._debugScreen.enabledInHierarchy&&this._recursiveScreenNode(this._debugScreen.node)}},{key:"_recursiveScreenNode",value:function(e){var i=this;this._walk(e,function(e){var t=e.getComponent(Hz);t&&t.enabledInHierarchy&&t.updateAssembler(i)},function(e){var t=e.getComponent(Hz);t&&t.enabledInHierarchy&&t.postUpdateAssembler(i)}),this.autoMergeBatches()}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.clear(this),this._drawBatchPool.free(t)}this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=-1,this._currTexView=null,this._meshBufferUseCount=0,this._requireBufferBatch(),wZ.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}}]),i}(),x$=function(){function t(e){y(this,t),this._createSceneFun=void 0,this._createViewFun=void 0,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._pipeline=null,this._ui=null,this._scenes=[],this._views=[],this._time=0,this._frameTime=0,this._fpsTime=0,this._frameCount=0,this._fps=0,this._device=e,o$.registerCreateFunc(this),VJ.registerCreateFunc(this)}return l(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"views",get:function(){return this._views}},{key:"cumulativeTime",get:function(){return this._time}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}}]),l(t,[{key:"initialize",value:function(e){var i=this;return!!this._device.mainWindow&&(this._mainWindow=this._device.mainWindow,this._curWindow=this._mainWindow,Vv.initBuiltinRes(this._device),this._pipeline=new GJ(this),this._pipeline.initialize(e)?(this._ui=new E$(this),this._ui.initialize()?(cc.view.on("design-resolution-changed",function(){var e=cc.game.canvas.width,t=cc.game.canvas.height;i.resize(e,t)},this),!0):(this.destroy(),!1)):(this.destroy(),!1))}},{key:"destroy",value:function(){this.destroyViews(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);var i=this._windows,n=Array.isArray(i),r=0;for(i=n?i:i[Symbol.iterator]();;){var a;if(n){if(r>=i.length)break;a=i[r++]}else{if((r=i.next()).done)break;a=r.value}a.resize(e,t)}this._pipeline&&this._pipeline.resize(e,t);var s=this._views,o=Array.isArray(s),l=0;for(s=o?s:s[Symbol.iterator]();;){var c;if(o){if(l>=s.length)break;c=s[l++]}else{if((l=s.next()).done)break;c=l.value}var u=c;u.camera.isWindowSize&&u.camera.resize(e,t)}}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){this._time=0}},{key:"frameMove",value:function(e){this._frameTime=e,++this._frameCount,this._time+=this._frameTime,this._fpsTime+=this._frameTime,1<this._fpsTime&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);var t=this._views,i=Array.isArray(t),n=0;for(t=i?t:t[Symbol.iterator]();;){var r;if(i){if(n>=t.length)break;r=t[n++]}else{if((n=t.next()).done)break;r=n.value}var a=r;a.isEnable&&a.window===this._curWindow&&this._pipeline.render(a)}}},{key:"createWindow",value:function(e){if(this._device){var t=this._device.createWindow(e);if(t)return this._windows.push(t),t}return null}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){var e=this._windows,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){var e=this._scenes,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=this._createViewFun(this,e.camera);return t.initialize(e),this._views.push(t),this._views.sort(function(e,t){return e.priority-t.priority}),t}},{key:"destroyView",value:function(e){for(var t=0;t<this._views.length;++t)if(this._views[t]===e)return this._views.splice(t,1),void e.destroy()}},{key:"destroyViews",value:function(){var e=this._views,t=Array.isArray(e),i=0;for(e=t?e:e[Symbol.iterator]();;){var n;if(t){if(i>=e.length)break;n=e[i++]}else{if((i=e.next()).done)break;n=i.value}n.destroy()}this._views=[]}}]),t}(),A$=function(e){function i(){var e;y(this,i),(e=T(this,S(i).call(this))).invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._scheduler=void 0,e._compScheduler=void 0,e._nodeActivator=void 0,e._physicsSystem=void 0,e._systems=void 0,e._animationManager=void 0,e.invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._scheduler=new _f,e._compScheduler=new kg,e._nodeActivator=new Vg,e._physicsSystem=null,e._systems=[];var t=d(d(e));return cc.game.on($d.EVENT_SHOW,function(){t._lastUpdate=performance.now()}),cc.game.once($d.EVENT_ENGINE_INITED,e.init,d(d(e))),e}return p(i,Xn),l(i,[{key:"init",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._paused=!1,this._purgeDirectorInNextLoop=!1,this.sharedInit(),this._root=new x$(cc.game._gfxDevice);return!!this._root.initialize({})}},{key:"sharedInit",value:function(){sh&&sh.setEnabled(!0),cc.AnimationManager?(this._animationManager=new cc.AnimationManager,this._scheduler.scheduleUpdate(this._animationManager,_f.PRIORITY_SYSTEM,!1)):this._animationManager=null,xY&&xY.init(this),this._physicsSystem=new vN,cc.loader.init(this)}},{key:"calculateDeltaTime",value:function(){var e=performance.now();this._deltaTime=(e-this._lastUpdate)/1e3,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=i._devicePixelRatio*(e.x-r),o=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?cc.v2(i._viewportRect.width-o,s):cc.v2(s,o)}},{key:"convertToUI",value:function(e){var t=cc.game.container,i=cc.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,s=cc.v2(0,0);return i._isRotated?(s.x=r+e.y/i._devicePixelRatio,s.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(s.x=r+e.x*i._devicePixelRatio,s.y=a+n.height-e.y*i._devicePixelRatio),s}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return cc.size(cc.winSize)}},{key:"getWinSizeInPixels",value:function(){return cc.size(cc.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){cc.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),sh&&sh.setEnabled(!1),cc.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),null!=this._root&&this._root.destroy(),this._root=null,cc.loader.releaseAll()}},{key:"reset",value:function(){var t=this;this.purgeDirector(),sh&&sh.setEnabled(!0),this._animationManager&&this._scheduler.scheduleUpdate(this._animationManager,cc.Scheduler.PRIORITY_SYSTEM,!1),this._systems.forEach(function(e){t._scheduler.scheduleUpdate(e,e._priority,!1)}),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){cc.assertID(e instanceof cc.Scene,1216);var n=cc.loader._getReferenceKey(e.uuid);cc.loader.removeItem(n),e._load();for(var r=Object.keys(cc.game._persistRootNodes).map(function(e){return cc.game._persistRootNodes[e]}),a=0;a<r.length;a++){var s=r[a];s.emit(cc.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var o=e.getChildByUuid(s.uuid);if(o){var l=o.getSiblingIndex();o._destroyImmediate(),e.insertChild(s,l)}else s.parent=e}var c=this._scene;!function(e,t,i){var n=cc.loader._autoReleaseSetting,r=dt();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var s=0;s<i.length;s++)vc(i[s],r);if(e)for(var o=0;o<e.length;o++){var l=e[o];!1===n[l]||r[l]||cc.loader.release(l)}for(var c=Object.keys(n),u=0;u<c.length;u++){var h=c[u];!0!==n[h]||r[h]||cc.loader.release(h)}}(c&&c.autoReleaseAssets&&c.dependAssets,e.dependAssets,r),cc.isValid(c)&&c.destroy(),this._scene=null,Cn._deferredDestroy(),t&&t(),this.emit(cc.Director.EVENT_BEFORE_SCENE_LAUNCH,e),(this._scene=e)._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(cc.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;cc.assertID(e,1205),cc.assertID(e instanceof cc.Scene,1216),e._load(),this.once(cc.Director.EVENT_AFTER_UPDATE,function(){n.runSceneImmediate(e,t,i)})}},{key:"_getSceneUuid",value:function(e){var t=cc.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];cc.errorID(1206,e)}else cc.errorID(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return cc.errorID(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return cc.errorID(1209,e),!1}},{key:"preloadScene",value:function(i,e,n){void 0===n&&(n=e,e=null);var t=this._getSceneUuid(i);if(t)this.emit(cc.Director.EVENT_BEFORE_SCENE_LOADING,i),cc.loader.load({uuid:t.uuid,type:"uuid"},e,function(e,t){e&&cc.errorID(1210,i,e.message),n&&n(e,t)});else{var r='Can not preload the scene "'+i+'" because it is not in the build settings.';n(new Error(r)),cc.error("preloadScene: "+r)}}},{key:"_loadSceneByUuid",value:function(r){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;3<arguments.length&&arguments[3];console.time("LoadScene "+r),cc.AssetLibrary.loadAsset(r,function(e,t){console.timeEnd("LoadScene "+r);var i=cc.director;if(i._loadingScene="",e)e="Failed to load scene: "+e,cc.error(e);else{if(t instanceof cc.SceneAsset){var n=t.scene;return n._id=t._uuid,n._name=t._name,void i.runSceneImmediate(n,s,a)}e="The asset "+r+" is not a scene",cc.error(e)}a&&a(e)})}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||cc.logID(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){cc.Camera.main&&(cc.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){cc.Camera.main&&(cc.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/cc.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){cc.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this._scheduler=e)}},{key:"registerSystem",value:function(e,t,i,n){var r=new t;return r._id=e,r._priority=n,i.forEach(function(e){Mt(e).system=r}),this._scheduler.scheduleUpdate(r,n,!1),r.init(),this._systems.push(r),r}},{key:"getSystem",value:function(t){return this._systems.find(function(e){return e._id===t})}},{key:"getAnimationManager",value:function(){return this._animationManager}},{key:"startAnimation",value:function(){this.invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this.invalid=!0}},{key:"mainLoop",value:function(){this._purgeDirectorInNextLoop?(this._purgeDirectorInNextLoop=!1,this.purgeDirector()):this.invalid||(this.calculateDeltaTime(),this._paused||(this.emit(i.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(this._deltaTime),this._scheduler.update(this._deltaTime),this._compScheduler.lateUpdatePhase(this._deltaTime),this.emit(i.EVENT_AFTER_UPDATE),Cn._deferredDestroy()),this.emit(i.EVENT_BEFORE_PHYSICS),this._physicsSystem.update(this._deltaTime),this.emit(i.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this._root.device.present(),this.emit(i.EVENT_AFTER_DRAW),sh.frameUpdateListeners(),this._scene&&this._scene.resetHasChanged(),this._totalFrames++)}},{key:"__fastOn",value:function(e,t,i){this.add(e,t,i)}},{key:"__fastOff",value:function(e,t,i){this.remove(e,t,i)}},{key:"root",get:function(){return this._root}}]),i}();A$.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",A$.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",A$.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",A$.EVENT_BEFORE_UPDATE="director_before_update",A$.EVENT_AFTER_UPDATE="director_after_update",A$.EVENT_BEFORE_DRAW="director_before_draw",A$.EVENT_AFTER_DRAW="director_after_draw",A$.EVENT_BEFORE_PHYSICS="director_before_physics";cc.director=new A$;cc.Director=A$,cc.vmath=qe;var C$=new Br;cc.pipelineUtils={WorldNode3DToLocalNodeUI:function(e,t,i,n){n||(n=new Br),e.worldToScreen(t,C$),C$.x=C$.x/cc.view.getScaleX(),C$.y=C$.y/cc.view.getScaleY();var r=i.getComponent(mz);if(!r)return n;r.convertToNodeSpaceAR(C$,n);var a=i.getPosition();return n.addSelf(a),n},WorldNode3DToWorldNodeUI:function(e,t,i){return i||(i=new Br),e.worldToScreen(t,i),i.x=i.x/cc.view.getScaleX(),i.y=i.y/cc.view.getScaleY(),i}},cc.RenderPassStage=vf;var w$=function(){function t(e){y(this,t),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}return l(t,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent(!1);var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){var e=this._pool.length-1;if(e<0)return null;var t=this._pool[e];this._pool.length=e;var i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;if(i&&i.reuse){for(var n,r=arguments.length,a=new Array(r),s=0;s<r;s++)a[s]=arguments[s];(n=i.reuse).apply.apply(n,[i].concat(a))}return t}}]),t}();cc.NodePool=w$,cc.renderer=cC;var R$=cc;return Kt.renderer=cC,Kt.cclegacy=R$,Kt.vmath=qe,Kt.js=Nt,Kt.path=re,Kt.profiler=zd,Kt.BUILTIN_CLASSID_RE=zt,Kt.BASE64_VALUES=Ht,Kt.propertyDefine=Wt,Kt.nextPOT=Xt,Kt.pushToMap=jt,Kt.clampf=qt,Kt.clamp01=Yt,Kt.lerp=Qt,Kt.degreesToRadians=Zt,Kt.radiansToDegrees=Jt,Kt.contains=$t,Kt.isDomNode=ei,Kt.callInNextTick=ti,Kt.tryCatchFunctor_EDITOR=ii,Kt.isPlainEmptyObj_DEV=ni,Kt.cloneable_DEV=ri,Kt.isUnicodeCJK=Vl,Kt.isUnicodeSpace=Hl,Kt.safeMeasureText=Wl,Kt.fragmentText=Xl,Kt.HtmlTextParser=Kd,Kt.PrefabInfo=Zd,Kt._decorator=En,Kt.CCClass=Yi,Kt.CCObject=Cn,Kt.deserialize=il,Kt.instantiate=ol,Kt.CCInteger=_i,Kt.CCFloat=vi,Kt.CCBoolean=mi,Kt.CCString=yi,Kt.Event=ju,Kt.EventTarget=Xn,Kt.screen=cf,Kt.macro=oh,Kt.eventManager=sh,Kt.SystemEvent=Sh,Kt.systemEvent=Ih,Kt.EventMouse=qu,Kt.EventTouch=Yu,Kt.EventAcceleration=Ku,Kt.EventKeyboard=Qu,Kt.Enum=ai,Kt.ValueType=Fr,Kt.Vec2=Lr,Kt.Vec3=Br,Kt.Vec4=Ir,Kt.Quat=Pr,Kt.Mat4=Dr,Kt.AffineTransform=Nr,Kt.Size=zr,Kt.Rect=Ur,Kt.Color=Hr,Kt.BaseNode=td,Kt.Node=bd,Kt.Scene=_g,Kt.Layers=fd,Kt.find=vg,Kt.PrivateNode=yg,Kt.NodeActivator=Vg,Kt.textureUtil=jc,Kt.RawAsset=Rn,Kt.Asset=qn,Kt.Prefab=Tr,Kt.SceneAsset=Or,Kt.SpriteAtlas=su,Kt.TextAsset=uu,Kt.JsonAsset=hu,Kt.AssetLibrary=Cu,Kt.ImageAsset=Ls,Kt.Texture2D=Zc,Kt.TTFFont=Gu,Kt.LabelAtlas=Wu,Kt.BitmapFont=Hu,Kt.Font=Lu,Kt.Script=Er,Kt.JavaScript=xr,Kt.TypeScript=kr,Kt.SpriteFrame=iu,Kt.easing=GC,Kt.bezier=VC,Kt.bezierByTime=KC,Kt.Curve=yw,Kt.Bezier=gw,Kt.sampleMotionPaths=function(e,t,i,n){var r=function(e){return e instanceof Lr?{in:e,pos:e,out:e}:Array.isArray(e)&&6===e.length?{in:new Lr(e[2],e[3]),pos:new Lr(e[0],e[1]),out:new Lr(e[4],e[5])}:{in:Lr.ZERO,pos:Lr.ZERO,out:Lr.ZERO}},a=t.values=t.values.map(function(e){return Array.isArray(e)&&(e=2===e.length?cc.v2(e[0],e[1]):cc.v3(e[0],e[1],e[2])),e});if(0!==e.length&&0!==a.length){for(var s=!1,o=0;o<e.length;o++){var l=e[o];if(l&&!bw(l)&&(j(3904,"","position",o),l=void 0),l&&0<l.length){s=!0;break}}if(s&&1!==a.length){for(var c=t.types,u=t.ratioSampler?t.ratioSampler.ratios:[],h=t.values=[],d=t.types=[],f=t.ratios=[],p=0,_=fw.Linear,v=0,m=e.length;v<m-1;v++){var y=e[v],g=u[v],b=u[v+1]-g,S=a[v],T=a[v+1],E=c[v],x=[],A=p/b,C=1/(b*i*n),w=void 0;if(y&&0<y.length){var R=[];R.push(r(S));for(var k=0,O=y.length;k<O;k++){var F=r(y[k]);R.push(F)}R.push(r(T));var L=new yw(R);L.computeBeziers();for(var B=L.progresses;1e-6<1-A;){var M=void 0;if((w=_w(w=A,E))<0){var I=L.beziers[0],P=(0-w)*I.getLength(),D=I.start.sub(I.endCtrlPoint).normalize();M=I.start.add(D.mul(P))}else if(1<w){var N=L.beziers[L.beziers.length-1],z=(w-1)*N.getLength(),U=N.end.sub(N.startCtrlPoint).normalize();M=N.end.add(U.mul(z))}else{var G=tw(B,w);G<0&&(G=~G),w-=0<G?B[G-1]:0,w/=L.ratios[G],M=L.beziers[G].getPointAt(w)}x.push(M),A+=C}}else for(;1e-6<1-A;)w=_w(w=A,E),x.push(S.lerp(T,w)),A+=C;_="constant"===E?E:fw.Linear;for(var V=0,H=x.length;V<H;V++){var W=g+p+C*V*b;X(x[V],_,W)}p=1e-6<Math.abs(A-1)?(A-1)*b:0}u[u.length-1]!==f[f.length-1]&&X(a[a.length-1],_,u[u.length-1])}}function X(e,t,i){h.push(e),d.push(t),f.push(i)}},Kt.RatioSampler=dw,Kt.AnimCurve=fw,Kt.EventInfo=pw,Kt.computeRatioByType=_w,Kt.AnimationClip=Iw,Kt.AnimationManager=Nw,Kt.AnimationState=Xw,Kt.CubicSplineVec2Value=Yw,Kt.CubicSplineVec3Value=Kw,Kt.CubicSplineVec4Value=Qw,Kt.CubicSplineQuatValue=Zw,Kt.CubicSplineNumberValue=Jw,Kt.url=Ps,Kt.Downloader=Ll,Kt.Loader=sc,Kt.LoadingItems=Xs,Kt.Pipeline=Ks,Kt.loader=Ac,Kt.Component=Nh,Kt.EventHandler=uC,Kt.MissingScript=dC,Kt.AnimationComponent=AR,Kt.utils=cb,Kt.primitives=ez,Kt.geometry=Sv,Kt.AudioClip=Sl,Kt.EffectAsset=Hf,Kt.Material=_m,Kt.Mesh=Em,Kt.Skeleton=zm,Kt.PhysicsMaterial=Qm,Kt.effects=Uv,Kt.builtinResMgr=Vv,Kt.AudioSourceComponent=Zm,Kt.CameraComponent=WT,Kt.LightComponent=dE,Kt.ModelComponent=wT,Kt.SkinningModelComponent=RT,Kt.AvatarModelComponent=BT,Kt.AvatarUnit=OT,Kt.BatchedSkinningModelComponent=UT,Kt.SkinningModelUnit=DT,Kt.ParticleSystemComponent=pP,Kt.BillboardComponent=fO,Kt.LineComponent=RO,Kt.RenderableComponent=AT,Kt.ColliderComponent=aD,Kt.BoxColliderComponent=lN,Kt.SphereColliderComponent=cN,Kt.RigidBodyComponent=fN,Kt.PhysicsSystem=vN,Kt.CircularPool=K_,Kt.FixedArray=sv,Kt.LinkedArray=ov,Kt.Pool=kn,Kt.RecyclePool=lv,Kt.TypedArrayPool=fv,Kt.MeshBuffer=aJ,Kt.UIVertexFormat=CY,Kt.StencilManager=wZ,Kt.CanvasPool=KG,Kt.barFilled=IZ,Kt.radialFilled=YZ,Kt.simple=JZ,Kt.sliced=tJ,Kt.ttf=EZ,Kt.bmfont=aQ,Kt.letter=qQ,Kt.mask=kZ,Kt.maskEnd=OZ,Kt.spriteAssembler=rJ,Kt.graphics=AK,Kt.labelAssembler=CZ,Kt.graphicsAssembler=CK,Kt.CanvasComponent=bz,Kt.DebugCanvasComponent=Az,Kt.UIComponent=Hz,Kt.ButtonComponent=aG,Kt.EditBoxComponent=gH,Kt.LayoutComponent=tW,Kt.MaskComponent=zW,Kt.ProgressBarComponent=WW,Kt.RichTextComponent=kX,Kt.ScrollBarComponent=NX,Kt.ScrollViewComponent=Bj,Kt.SliderComponent=Xj,Kt.SpriteComponent=rG,Kt.ToggleComponent=sq,Kt.ToggleContainerComponent=rq,Kt.UIModelComponent=uq,Kt.UIRenderComponent=EU,Kt.UITransformComponent=mz,Kt.ViewGroupComponent=cj,Kt.WebviewComponent=oY,Kt.WidgetComponent=uY,Kt.LabelOutlineComponent=uX,Kt.GraphicsComponent=_W,Kt.widgetManager=xY,Kt.LabelComponent=nV,Kt.NodePool=w$,Kt}({});